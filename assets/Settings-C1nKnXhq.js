const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./LocationPickerMap-Czyd1Neu.js","./tanstack-D8i8yNxB.js","./vendor-Dl0Wzy4_.js","./LocationPickerMap-Dgihpmma.css"])))=>i.map(i=>d[i]);
import{_ as O}from"./supabase-A1WgB1xz.js";import{j as e,b as Z,u as H,c as G}from"./tanstack-D8i8yNxB.js";import{o as J,s as p,l as P,b as W,p as z,c as F,u as X,t as Y}from"./types-BCrSgEF3.js";import{s as M}from"./client-BmrnLCXS.js";import{B as T}from"./button-B2cFmNG7.js";import{C as ee,b as re,c as ae,a as se}from"./card-nTC0jXOr.js";import{I as m,L as oe}from"./label-Cupg-uBe.js";import{T as te}from"./textarea-BVvs_Kl_.js";import{S as ne}from"./switch-CqRt5HGK.js";import{u as t,L as le}from"./index-DB8-wY2S.js";import{F as ie,b as n,c as l,a as i,d,e as u}from"./form-CfDAiOyT.js";import{S as $}from"./skeleton-DS-sMlaY.js";import{r as h}from"./vendor-Dl0Wzy4_.js";import{Z as k,S as de,g as ce}from"./location-8DKJngIY.js";import"./index-PuW-_iwo.js";const ue=h.lazy(()=>O(()=>import("./LocationPickerMap-Czyd1Neu.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(c=>({default:c.LocationPickerMap}))),me=J({name:p().min(1,"O nome do restaurante é obrigatório."),description:p().optional(),logo_url:p().url("URL do logo inválida.").optional().or(P("")),street:p().optional(),number:p().optional(),neighborhood:p().optional(),city:p().optional(),zip_code:p().optional(),phone:p().optional(),email:p().email("Email inválido.").optional().or(P("")),is_active:W().default(!0),latitude:z(c=>String(c).replace(",","."),F.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:z(c=>String(c).replace(",","."),F.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),he=async()=>{const{data:c,error:j}=await M.from("restaurants").select("*").limit(1).single();if(j)throw new Error(`Erro ao buscar dados do restaurante: ${j.message}`);if(!c)throw new Error("Nenhum restaurante encontrado.");return c},R=h.memo(({center:c,markerPosition:j,onLocationChange:N})=>e.jsx(h.Suspense,{fallback:e.jsx($,{className:"h-96 w-full"}),children:e.jsx(ue,{center:c,markerPosition:j,onLocationChange:N})}));R.displayName="MemoizedLocationPickerMap";const Le=()=>{const c=Z(),[j,N]=h.useState(""),[g,A]=h.useState(""),[E,_]=h.useState(!1),[D,V]=h.useState(!1),{data:s,isLoading:B,isError:I,error:q}=H({queryKey:["restaurantSettings"],queryFn:he,staleTime:1e3*60*5}),a=X({resolver:Y(me),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});h.useEffect(()=>{s&&(a.reset({name:s.name||"",description:s.description||"",logo_url:s.logo_url||"",street:s.street||"",number:s.number||"",neighborhood:s.neighborhood||"",city:s.city||"",zip_code:s.zip_code||"",phone:s.phone||"",email:s.email||"",is_active:s.is_active??!0,latitude:s.latitude??null,longitude:s.longitude??null}),s.latitude&&s.longitude&&V(!0))},[s,a.reset]);const v=a.watch("latitude"),y=a.watch("longitude"),U=[-23.55052,-46.633308],S=h.useMemo(()=>typeof v=="number"&&typeof y=="number"&&!isNaN(v)&&!isNaN(y)?[v,y]:U,[v,y]),L=h.useCallback(r=>{a.setValue("street",r.road||r.logradouro||"",{shouldValidate:!0}),a.setValue("number",r.house_number||g||"",{shouldValidate:!0}),a.setValue("neighborhood",r.suburb||r.bairro||"",{shouldValidate:!0}),a.setValue("city",r.city||r.localidade||"",{shouldValidate:!0}),a.setValue("zip_code",r.postcode||r.cep||"",{shouldValidate:!0})},[a,g]),Q=async()=>{const r=j.replace(/\D/g,"");if(r.length!==8||!g){t.warning("Por favor, digite um CEP válido e o número da casa.");return}_(!0);const f=t.loading("Buscando endereço e coordenadas...");try{const x=await fetch(`https://viacep.com.br/ws/${r}/json/`);if(!x.ok)throw new Error("Falha na busca do CEP.");const o=await x.json();if(o.erro){t.error("CEP não encontrado.");return}a.setValue("street",o.logradouro,{shouldValidate:!0}),a.setValue("number",g,{shouldValidate:!0}),a.setValue("neighborhood",o.bairro,{shouldValidate:!0}),a.setValue("city",o.localidade,{shouldValidate:!0}),a.setValue("zip_code",o.cep,{shouldValidate:!0});const C=`${o.logradouro}, ${g}, ${o.localidade}, ${o.uf}`,b=await ce(C);b?(a.setValue("latitude",b[0],{shouldValidate:!0}),a.setValue("longitude",b[1],{shouldValidate:!0}),V(!0),t.success("Endereço e mapa atualizados com sucesso!")):t.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(x){t.error(`Erro na busca: ${x.message}`)}finally{_(!1),t.dismiss(f)}},K=h.useCallback(async(r,f)=>{a.setValue("latitude",r,{shouldValidate:!0}),a.setValue("longitude",f,{shouldValidate:!0});const x=t.loading("Buscando endereço para a nova localização...");try{const o=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${f}&addressdetails=1`,C=await fetch(o);if(!C.ok)throw new Error("Falha ao obter detalhes do endereço.");const b=await C.json();b.address?(L(b.address),t.success("Endereço atualizado a partir do mapa.")):t.warning("Não foi possível encontrar um endereço para esta localização.")}catch(o){t.error(`Erro ao buscar endereço: ${o.message}`)}finally{t.dismiss(x)}},[a,L]),w=G({mutationFn:async r=>{if(!(s!=null&&s.id))throw new Error("ID do restaurante não disponível.");const{id:f,...x}={...r,id:s.id},{error:o}=await M.from("restaurants").update(x).eq("id",f);if(o)throw o},onSuccess:()=>{t.success("Configurações salvas com sucesso!"),c.invalidateQueries({queryKey:["restaurantSettings"]})},onError:r=>t.error(`Erro ao salvar configurações: ${r.message}`)});return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(ee,{children:[e.jsx(re,{children:e.jsx(ae,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(se,{children:B?e.jsx($,{className:"h-96 w-full"}):I?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",q.message]}):e.jsx(ie,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(r=>w.mutate(r)),className:"space-y-6",children:[e.jsx(n,{control:a.control,name:"name",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Nome do Restaurante *"}),e.jsx(d,{children:e.jsx(m,{...r})}),e.jsx(u,{})]})}),e.jsx(n,{control:a.control,name:"description",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Descrição"}),e.jsx(d,{children:e.jsx(te,{...r,rows:3})}),e.jsx(u,{})]})}),e.jsx(n,{control:a.control,name:"logo_url",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"URL do Logo"}),e.jsx(d,{children:e.jsx(m,{...r})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(oe,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{placeholder:"Digite o CEP",value:j,onChange:r=>N(r.target.value)}),e.jsx(m,{placeholder:"Número",value:g,onChange:r=>A(r.target.value)}),e.jsx(T,{type:"button",onClick:Q,disabled:E,children:E?e.jsx(le,{className:"h-4 w-4 animate-spin"}):e.jsx(de,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(n,{control:a.control,name:"street",render:({field:r})=>e.jsxs(l,{className:"md:col-span-2",children:[e.jsx(i,{children:"Rua"}),e.jsx(d,{children:e.jsx(m,{...r,disabled:!0})}),e.jsx(u,{})]})}),e.jsx(n,{control:a.control,name:"number",render:({field:r})=>e.jsxs(l,{className:"md:col-span-1",children:[e.jsx(i,{children:"Número"}),e.jsx(d,{children:e.jsx(m,{...r,disabled:!0})}),e.jsx(u,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:a.control,name:"neighborhood",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Bairro"}),e.jsx(d,{children:e.jsx(m,{...r,disabled:!0})}),e.jsx(u,{})]})}),e.jsx(n,{control:a.control,name:"city",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Cidade"}),e.jsx(d,{children:e.jsx(m,{...r,disabled:!0})}),e.jsx(u,{})]})})]}),e.jsx(n,{control:a.control,name:"zip_code",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"CEP"}),e.jsx(d,{children:e.jsx(k,{...r,disabled:!0})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:D&&e.jsx(R,{center:S,markerPosition:S,onLocationChange:K})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:a.control,name:"latitude",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Latitude"}),e.jsx(d,{children:e.jsx(m,{...r,placeholder:"-22.7627908",value:r.value??""})}),e.jsx(u,{})]})}),e.jsx(n,{control:a.control,name:"longitude",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Longitude"}),e.jsx(d,{children:e.jsx(m,{...r,placeholder:"-47.408315",value:r.value??""})}),e.jsx(u,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:a.control,name:"phone",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Telefone"}),e.jsx(d,{children:e.jsx(m,{...r})}),e.jsx(u,{})]})}),e.jsx(n,{control:a.control,name:"email",render:({field:r})=>e.jsxs(l,{children:[e.jsx(i,{children:"Email"}),e.jsx(d,{children:e.jsx(m,{...r})}),e.jsx(u,{})]})})]}),e.jsx(n,{control:a.control,name:"is_active",render:({field:r})=>e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(i,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(d,{children:e.jsx(ne,{checked:r.value,onCheckedChange:r.onChange})})]})}),e.jsx(T,{type:"submit",className:"w-full h-12 text-lg",disabled:w.isPending,children:w.isPending?"Salvando...":"Salvar Configurações"})]})})})]})})})};export{Le as default};
