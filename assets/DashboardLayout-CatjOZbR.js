import{j as e,u as Y,a as Z,b as me}from"./tanstack-E1juXnZE.js";import{a as ee,L as he,r as l,u as fe,O as pe}from"./vendor-nYMJN4lg.js";import{s as g}from"./client-DHSUo4L7.js";import{L as xe}from"./Logo-BTARGXb3.js";import{c as w,a as ge,u as c,L as re,d as M,T as I,s as L,t as q}from"./index-CWSCJ_da.js";import{P as je}from"./package-3s3Cbzpu.js";import{S as ae}from"./shopping-cart-CybenjYU.js";import{C as be}from"./clock-M4zGDVIo.js";import{C as ye}from"./credit-card-DpGHwSR8.js";import{T as ve}from"./truck-BTWWbfkn.js";import{S as Se}from"./settings-BBLtvT5P.js";import{B as N}from"./button-D2HW7Hzx.js";import{A as Ne,a as we,b as Ce,c as ke,d as Ee,e as Pe,g as Ae}from"./alert-dialog-CX9oAj1x.js";import{V as oe}from"./volume-2-B_22DvCV.js";import{S as De,a as Te,b as _e,u as Me}from"./use-mobile-CN_CBBNK.js";import{S as Ie}from"./use-sound-BCUTcw37.js";import{o as Le,s as U,u as qe,t as Re}from"./types-DkmadQTj.js";import{d as Oe,e as Fe,f as ze,g as Ve,h as Ue,i as He}from"./dialog-ChcSdo82.js";import{F as Ge,a as H,b as G,e as K,c as Q,d as $}from"./form-DIbg75BN.js";import{I as B}from"./input-BWasyjD7.js";import{P as Ke}from"./PhoneInput-49vuMdrY.js";import{S as P}from"./skeleton-ajBG09OH.js";import{L as Qe}from"./label-BeCzpOGG.js";import{U as se}from"./user-DzL883vT.js";import{A as W,a as X,b as J}from"./alert-DZ3Pn6vp.js";import{C as R}from"./circle-alert-3wtfTGxe.js";import"./supabase-CBMN163Q.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=w("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=w("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=w("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=w("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=w("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=w("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),Ze=[{href:"/dashboard",label:"Dashboard",icon:$e},{href:"/products",label:"Produtos",icon:je},{href:"/orders",label:"Pedidos",icon:ae},{href:"/cashier",label:"Caixa",icon:Ye},{href:"/hours",label:"Hor√°rios",icon:be},{href:"/payments",label:"Pagamentos",icon:ye},{href:"/delivery",label:"Taxa de Entrega",icon:ve},{href:"/settings",label:"Configura√ß√µes",icon:Se}],te=()=>{const r=ee();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(xe,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:Ze.map(a=>e.jsx("li",{children:e.jsxs(he,{to:a.href,className:ge("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",r.pathname===a.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(a.icon,{className:"h-4 w-4"}),a.label]})},a.href))})})]})},er=({isOpen:r,onEnable:a})=>e.jsx(Ne,{open:r,children:e.jsxs(we,{children:[e.jsxs(Ce,{children:[e.jsxs(ke,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-6 w-6 text-primary"}),"Ativar Notifica√ß√µes Sonoras?"]}),e.jsxs(Ee,{children:["Para garantir que voc√™ n√£o perca nenhum novo pedido, precisamos da sua permiss√£o para tocar um som de notifica√ß√£o.",e.jsx("br",{}),e.jsx("br",{}),'Ao clicar em "Ativar", um som de teste ser√° reproduzido.']})]}),e.jsx(Pe,{children:e.jsx(Ae,{onClick:a,className:"w-full",children:"Sim, ativar som"})})]})}),rr=()=>e.jsxs(De,{children:[e.jsx(Te,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"icon",children:e.jsx(We,{className:"h-4 w-4"})})}),e.jsx(_e,{side:"left",className:"p-0 w-64",children:e.jsx(te,{})})]}),ar=r=>r.replace(/\D/g,""),or=Le({full_name:U().min(1,"Nome √© obrigat√≥rio."),phone:U().min(1,"Telefone √© obrigat√≥rio.").transform(ar).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."})}),sr=async r=>{const{data:a,error:n}=await g.from("profiles").select("*").eq("id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${n.message}`);return a||{id:r,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null}},tr=({isOpen:r,onClose:a,userId:n})=>{var i;const v=Y(),{data:j,isLoading:p}=Z({queryKey:["adminProfile",n],queryFn:()=>sr(n),enabled:!!n&&r,staleTime:0}),C=(i=g.auth.currentUser)==null?void 0:i.email,d=qe({resolver:Re(or),defaultValues:{full_name:"",phone:""}});l.useEffect(()=>{j&&d.reset({full_name:j.full_name||"",phone:j.phone||""})},[j,d]);const b=me({mutationFn:async u=>{if(!n)throw new Error("ID do usu√°rio n√£o encontrado.");const D={full_name:u.full_name,phone:u.phone},{error:k}=await g.from("profiles").upsert({...D,id:n},{onConflict:"id"});if(k)throw new Error(k.message)},onSuccess:()=>{c.success("Perfil atualizado com sucesso!"),v.invalidateQueries({queryKey:["adminProfile"]}),a()},onError:u=>{c.error(`Erro ao atualizar perfil: ${u.message}`)}}),t=u=>{b.mutate(u)};return e.jsx(Oe,{open:r,onOpenChange:a,children:e.jsxs(Fe,{className:"sm:max-w-[425px]",children:[e.jsxs(ze,{children:[e.jsxs(Ve,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(Ue,{children:"Atualize seus dados de contato."})]}),p?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(P,{className:"h-4 w-1/3"}),e.jsx(P,{className:"h-10 w-full"}),e.jsx(P,{className:"h-4 w-1/3"}),e.jsx(P,{className:"h-10 w-full"}),e.jsx(P,{className:"h-10 w-full mt-6"})]}):e.jsx(Ge,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(t),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Qe,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Be,{className:"h-4 w-4"})," Email"]}),e.jsx(B,{value:C||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx(H,{control:d.control,name:"full_name",render:({field:u})=>e.jsxs(G,{children:[e.jsx(K,{children:"Nome Completo *"}),e.jsx(Q,{children:e.jsx(B,{placeholder:"Seu nome",...u})}),e.jsx($,{})]})}),e.jsx(H,{control:d.control,name:"phone",render:({field:u})=>e.jsxs(G,{children:[e.jsx(K,{children:"Telefone *"}),e.jsx(Q,{children:e.jsx(Ke,{...u})}),e.jsx($,{})]})}),e.jsx(He,{className:"pt-4",children:e.jsxs(N,{type:"submit",disabled:b.isPending,children:[b.isPending?e.jsx(re,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},nr=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes"}],ir=r=>{const a=nr.find(n=>n.href===r);return a?a.label:"Dashboard"},lr=async r=>{const{data:a,error:n}=await g.from("user_roles").select("role, restaurant_id").eq("user_id",r).in("role",["admin","moderator"]).limit(1).single();return n&&n.code!=="PGRST116"?(console.error("Error checking role and restaurant:",n),{role:null,restaurantId:null}):a?{role:a.role,restaurantId:a.restaurant_id}:{role:null,restaurantId:null}},dr=()=>{const r=fe(),a=ee(),n=Y(),[v,j]=l.useState(null),[p,C]=l.useState(void 0),[d,b]=l.useState(null),t=l.useRef(null),[i,u]=l.useState("loading"),[D,k]=l.useState(!1),[E,T]=l.useState(null);Me();const[ne,O]=l.useState(!1),[m,x]=l.useState(()=>localStorage.getItem("soundNotificationStatus")||"disabled");l.useEffect(()=>{localStorage.setItem("soundNotificationStatus",m)},[m]);const{data:h,isLoading:ie,isError:le,error:F}=Z({queryKey:["dashboardRestaurant",d],queryFn:async()=>{if(!d)throw new Error("Restaurant ID not found for user.");const{data:o,error:f}=await g.from("restaurants").select("*").eq("id",d).single();if(f)throw new Error(f.message);return o},enabled:!!v&&(p==="admin"||p==="moderator")&&!!d,staleTime:1/0});l.useEffect(()=>{const o=async s=>{if(!(s!=null&&s.user)){j(null),C(null),b(null),r("/admin-auth",{replace:!0});return}const{role:y,restaurantId:V}=await lr(s.user.id);j(s.user),C(y),b(V),y!=="admin"&&y!=="moderator"&&(c.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),r("/admin-auth",{replace:!0})),(y==="admin"||y==="moderator")&&!V&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:f}}=g.auth.onAuthStateChange((s,y)=>{s==="SIGNED_OUT"?(j(null),C(null),b(null),r("/admin-auth",{replace:!0})):o(y)});return g.auth.getSession().then(({data:{session:s}})=>{o(s)}),()=>f.unsubscribe()},[r]),l.useEffect(()=>{var o;h!=null&&h.notification_sound_url?((o=t.current)==null?void 0:o.src)!==h.notification_sound_url&&u("loading"):u("error")},[h==null?void 0:h.notification_sound_url]),l.useEffect(()=>{!localStorage.getItem("hasSeenSoundPermissionModal")&&m!=="enabled"&&i==="ready"&&k(!0)},[m,i]);const S=l.useCallback(()=>{t.current&&(t.current.pause(),t.current.loop=!1,T(null))},[]),z=l.useCallback(o=>{if(m==="enabled"&&t.current&&i==="ready"){if(E)return;T(o),t.current.loop=!0,t.current.play().catch(f=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",f),T(null),c.warning("N√£o foi poss√≠vel tocar o som automaticamente.",{description:"Interaja com a p√°gina para permitir a reprodu√ß√£o de som."})})}},[m,i,E]);l.useEffect(()=>{if(p!=="admin"&&p!=="moderator"||!d)return;const o=g.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},f=>{n.invalidateQueries({queryKey:["orders"]});const s=f.new;s.status==="pending"&&s.id&&s.restaurant_id===d&&(c.info("üîî Novo pedido recebido!",{description:`Pedido #${s.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),z(s.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},f=>{n.invalidateQueries({queryKey:["orders"]});const s=f.new;s.id===E&&S(),s.status==="pending"&&s.id&&f.old.status==="pending_payment"&&s.restaurant_id===d&&c.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${s.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3})}).subscribe();return()=>{g.removeChannel(o)}},[n,z,S,E,p,d]);const _=l.useCallback(()=>{if(m==="enabled"&&t.current&&i==="ready"){S(),t.current.loop=!1,t.current.currentTime=0;const o=t.current.play();o!==void 0&&o.then(()=>{console.log("Som de teste tocado com sucesso")}).catch(f=>{console.error("Erro ao tocar som de teste:",f),x("error"),c.error("N√£o foi poss√≠vel tocar o som de teste.",{description:"Seu navegador pode ter bloqueado a reprodu√ß√£o. Interaja com a p√°gina e tente novamente."})})}else i==="ready"?(x("enabled"),setTimeout(()=>_(),100)):(c.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado.",{description:"Verifique se a URL do som est√° correta nas Configura√ß√µes."}),x("error"))},[m,i,S]),de=async()=>{if(i!=="ready"||!t.current){c.error("O arquivo de som ainda n√£o est√° pronto. Tente novamente em um momento.");return}try{t.current.currentTime=0,await t.current.play(),x("enabled"),c.success("Notifica√ß√µes sonoras ativadas!"),localStorage.setItem("hasSeenSoundPermissionModal","true")}catch(o){console.error("Audio activation failed from modal:",o),c.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado a reprodu√ß√£o. Por favor, tente ativar manualmente no √≠cone do cabe√ßalho."}),x("error")}finally{k(!1)}},ce=async()=>{if(m==="enabled"){S(),x("disabled"),c.info("Notifica√ß√µes sonoras desativadas.");return}if(i!=="ready"||!t.current){c.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado."),x("error");return}try{t.current.currentTime=0,await t.current.play(),x("enabled"),c.success("Notifica√ß√µes sonoras ativadas!",{description:"Voc√™ ouviu o som de teste."})}catch(o){console.error("Audio activation failed:",o),c.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado. Clique na p√°gina e tente novamente."}),x("error")}},ue=async()=>{await g.auth.signOut()};if(p===void 0||ie)return e.jsx(M,{});if(p!=="admin"&&p!=="moderator")return e.jsx(M,{});if(!d)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(W,{variant:"destructive",className:"max-w-md",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro de Configura√ß√£o"}),e.jsx(J,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})});if(le)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(W,{variant:"destructive",className:"max-w-md",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro ao Carregar Restaurante"}),e.jsx(J,{children:F instanceof Error?F.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})});if(!h)return e.jsx(M,{});const A=i!=="ready";return e.jsxs(Ie.Provider,{value:{playSound:_,stopSoundLoop:S,soundStatus:m,loopingOrderId:E},children:[e.jsx(er,{isOpen:D,onEnable:de}),e.jsx(tr,{isOpen:ne,onClose:()=>O(!1),userId:(v==null?void 0:v.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(te,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(rr,{})}),e.jsx(ae,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:ir(a.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(I,{children:[e.jsx(L,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"icon",onClick:()=>O(!0),"aria-label":"Meu Perfil",children:e.jsx(se,{className:"h-4 w-4"})})}),e.jsx(q,{children:"Meu Perfil"})]}),e.jsxs(I,{children:[e.jsx(L,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"sm",onClick:_,disabled:A,children:"Testar Som"})}),A&&e.jsx(q,{children:i==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsxs(I,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"icon",onClick:ce,disabled:A,"aria-label":m==="enabled"?"Desativar som":"Ativar som",children:[i==="loading"&&e.jsx(re,{className:"h-4 w-4 animate-spin"}),i==="ready"&&m==="enabled"&&e.jsx(oe,{className:"h-4 w-4 text-green-500"}),i==="ready"&&m==="disabled"&&e.jsx(Je,{className:"h-4 w-4"}),i==="error"&&e.jsx(R,{className:"h-4 w-4 text-destructive"})]})}),A&&e.jsx(q,{children:i==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsx(N,{variant:"outline",onClick:ue,children:"Sair"})]})]})}),e.jsx(pe,{context:{restaurant:h,userRestaurantId:d}})]}),(h==null?void 0:h.notification_sound_url)&&e.jsx("audio",{ref:t,src:h.notification_sound_url,onCanPlayThrough:()=>{u("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:o=>{console.error("Erro ao carregar o √°udio:",o),c.error("Erro ao carregar o som de notifica√ß√£o.",{description:"Verifique o arquivo em Configura√ß√µes."}),u("error"),x("error")},className:"hidden"})]})]})},Rr=l.memo(dr);export{Rr as default};
