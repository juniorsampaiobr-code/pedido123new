import{j as e,b as Os,u as ue,c as Ms}from"./tanstack-D8i8yNxB.js";import{r as l,R as Ue,u as Ds,h as qs,L as De}from"./vendor-Dl0Wzy4_.js";import{o as Bs,s as F,l as Gs,e as zs,p as Ce,c as qe,n as Ks,Z as q,u as Us,t as Zs}from"./types-BCrSgEF3.js";import{s as O}from"./client-BmrnLCXS.js";import{c as Re,f as Ee,g as he,P as z,i as pe,h as Ze,l as Hs,m as He,b as oe,n as Js,k as Qs,a as Je,u as B,v as Ws,L as Be}from"./index-BclES6pf.js";import{B as J}from"./button-ByQJwVtI.js";import{C as ee,b as se,c as te,a as re}from"./card-CJ7Zusz2.js";import{I as $}from"./label-Cg6qNJgA.js";import{c as Qe,R as Xs,I as Ys,a as et,C as st}from"./index-fAfji7YC.js";import{u as tt}from"./index-BB_oiUC3.js";import{u as rt}from"./index-PuW-_iwo.js";import{S as ae}from"./separator-CjMDAfgw.js";import{T as at}from"./textarea-C-tr5sab.js";import{A as Q,a as W,b as X}from"./alert-C_84Droa.js";import{F as ot,b as I,c as C,a as E,e as k,d as Y}from"./form-Di1PeHTR.js";import{Z as nt,M as it}from"./MapLocationSection-pPMP_PHP.js";import{S as lt}from"./shopping-cart-B3Zejh2w.js";import{T as Ge}from"./terminal-CbgyFiw3.js";import{A as ct}from"./arrow-left-BMLVc-W5.js";import{T as ze}from"./truck-CmBIlGBR.js";import{S as We,a as dt}from"./store-3-BYDwRr.js";import{M as Ke}from"./map-pin-C2MI2GY0.js";import{P as ut}from"./package-CArlpwsL.js";import{C as mt}from"./credit-card-Be9FVlzQ.js";import{D as pt}from"./dollar-sign-BZeuv6H5.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=Re("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=Re("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xt=Re("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var Pe="Radio",[gt,Xe]=Ee(Pe),[yt,jt]=gt(Pe),Ye=l.forwardRef((r,s)=>{const{__scopeRadio:a,name:u,checked:o=!1,required:c,disabled:i,value:p="on",onCheck:h,form:f,...w}=r,[j,v]=l.useState(null),g=he(s,b=>v(b)),y=l.useRef(!1),V=j?f||!!j.closest("form"):!0;return e.jsxs(yt,{scope:a,checked:o,disabled:i,children:[e.jsx(z.button,{type:"button",role:"radio","aria-checked":o,"data-state":rs(o),"data-disabled":i?"":void 0,disabled:i,value:p,...w,ref:g,onClick:pe(r.onClick,b=>{o||h==null||h(),V&&(y.current=b.isPropagationStopped(),y.current||b.stopPropagation())})}),V&&e.jsx(ts,{control:j,bubbles:!y.current,name:u,value:p,checked:o,required:c,disabled:i,form:f,style:{transform:"translateX(-100%)"}})]})});Ye.displayName=Pe;var es="RadioIndicator",ss=l.forwardRef((r,s)=>{const{__scopeRadio:a,forceMount:u,...o}=r,c=jt(es,a);return e.jsx(Ze,{present:u||c.checked,children:e.jsx(z.span,{"data-state":rs(c.checked),"data-disabled":c.disabled?"":void 0,...o,ref:s})})});ss.displayName=es;var vt="RadioBubbleInput",ts=l.forwardRef(({__scopeRadio:r,control:s,checked:a,bubbles:u=!0,...o},c)=>{const i=l.useRef(null),p=he(i,c),h=rt(a),f=Hs(s);return l.useEffect(()=>{const w=i.current;if(!w)return;const j=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(j,"checked").set;if(h!==a&&g){const y=new Event("click",{bubbles:u});g.call(w,a),w.dispatchEvent(y)}},[h,a,u]),e.jsx(z.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...o,tabIndex:-1,ref:p,style:{...o.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ts.displayName=vt;function rs(r){return r?"checked":"unchecked"}var bt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],fe="RadioGroup",[Nt,jr]=Ee(fe,[Qe,Xe]),as=Qe(),os=Xe(),[Ct,_t]=Nt(fe),ns=l.forwardRef((r,s)=>{const{__scopeRadioGroup:a,name:u,defaultValue:o,value:c,required:i=!1,disabled:p=!1,orientation:h,dir:f,loop:w=!0,onValueChange:j,...v}=r,g=as(a),y=tt(f),[V,b]=He({prop:c,defaultProp:o??null,onChange:j,caller:fe});return e.jsx(Ct,{scope:a,name:u,required:i,disabled:p,value:V,onValueChange:b,children:e.jsx(Xs,{asChild:!0,...g,orientation:h,dir:y,loop:w,children:e.jsx(z.div,{role:"radiogroup","aria-required":i,"aria-orientation":h,"data-disabled":p?"":void 0,dir:y,...v,ref:s})})})});ns.displayName=fe;var is="RadioGroupItem",ls=l.forwardRef((r,s)=>{const{__scopeRadioGroup:a,disabled:u,...o}=r,c=_t(is,a),i=c.disabled||u,p=as(a),h=os(a),f=l.useRef(null),w=he(s,f),j=c.value===o.value,v=l.useRef(!1);return l.useEffect(()=>{const g=V=>{bt.includes(V.key)&&(v.current=!0)},y=()=>v.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",y)}},[]),e.jsx(Ys,{asChild:!0,...p,focusable:!i,active:j,children:e.jsx(Ye,{disabled:i,required:c.required,checked:j,...h,...o,name:c.name,ref:w,onCheck:()=>c.onValueChange(o.value),onKeyDown:pe(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:pe(o.onFocus,()=>{var g;v.current&&((g=f.current)==null||g.click())})})})});ls.displayName=is;var wt="RadioGroupIndicator",cs=l.forwardRef((r,s)=>{const{__scopeRadioGroup:a,...u}=r,o=os(a);return e.jsx(ss,{...o,...u,ref:s})});cs.displayName=wt;var ds=ns,us=ls,Rt=cs;const _e=l.forwardRef(({className:r,...s},a)=>e.jsx(ds,{className:oe("grid gap-2",r),...s,ref:a}));_e.displayName=ds.displayName;const me=l.forwardRef(({className:r,...s},a)=>e.jsx(us,{ref:a,className:oe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...s,children:e.jsx(Rt,{className:"flex items-center justify-center",children:e.jsx(ht,{className:"h-2.5 w-2.5 fill-current text-current"})})}));me.displayName=us.displayName;const Et=r=>{let s=r.replace(/\D/g,"");return s.length>11&&(s=s.slice(0,11)),s.length>0&&(s=`(${s}`),s.length>3&&(s=`${s.slice(0,3)}) ${s.slice(3)}`),s.length>10&&(s=`${s.slice(0,10)}-${s.slice(10)}`),s},ms=Ue.forwardRef(({className:r,value:s,onChange:a,...u},o)=>{const c=i=>{const p=i.target.value,h=Et(p),f={...i,target:{...i.target,value:h}};a(f)};return e.jsx($,{ref:o,type:"tel",className:oe("w-full",r),placeholder:"(99) 99999-9999",value:s,onChange:c,...u})});ms.displayName="PhoneInput";const Pt=r=>{let s=r.replace(/\D/g,"");return s.length>14&&(s=s.slice(0,14)),s.length<=11?(s.length>9&&(s=`${s.slice(0,9)}-${s.slice(9)}`),s.length>6&&(s=`${s.slice(0,6)}.${s.slice(6)}`),s.length>3&&(s=`${s.slice(0,3)}.${s.slice(3)}`),s):(s.length>12&&(s=`${s.slice(0,12)}-${s.slice(12)}`),s.length>8&&(s=`${s.slice(0,8)}/${s.slice(8)}`),s.length>5&&(s=`${s.slice(0,5)}.${s.slice(5)}`),s.length>2&&(s=`${s.slice(0,2)}.${s.slice(2)}`),s)},ps=Ue.forwardRef(({className:r,value:s,onChange:a,...u},o)=>{const c=i=>{const p=i.target.value,h=Pt(p),f={...i,target:{...i.target,value:h}};a(f)};return e.jsx($,{ref:o,type:"tel",className:oe("w-full",r),placeholder:"CPF ou CNPJ",value:s,onChange:c,maxLength:18,...u})});ps.displayName="CpfCnpjInput";const St=(r,s,a,u)=>{const c=(a-r)*(Math.PI/180),i=(u-s)*(Math.PI/180),p=Math.sin(c/2)*Math.sin(c/2)+Math.cos(r*(Math.PI/180))*Math.cos(a*(Math.PI/180))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))},It=async r=>{const s=r.replace(/\s+/g," ").trim(),a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(s)}&limit=1`,u=new AbortController,o=setTimeout(()=>u.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",a);const c=await fetch(a,{signal:u.signal});if(!c.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",c.status),null;const i=await c.json();if(i&&Array.isArray(i)&&i.length>0){const p=i[0],h=parseFloat(p.lat),f=parseFloat(p.lon);if(Number.isFinite(h)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[h,f]),{lat:h,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",s),null}catch(c){return c instanceof Error&&c.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",s):console.error("LOG: geocodeAddress - Erro durante a requisição:",c),null}finally{clearTimeout(o)}},kt=(r,s,a)=>{const u=St(s[0],s[1],r[0],r[1]),o=a.find(c=>u<=c.max_distance_km);if(o){const c=o.delivery_fee||0,i=o.min_delivery_time_minutes||0,p=i+15;return{fee:parseFloat(c.toFixed(2)),minTime:i,maxTime:p}}return null};var xe="Collapsible",[Ft,vr]=Ee(xe),[Vt,Se]=Ft(xe),hs=l.forwardRef((r,s)=>{const{__scopeCollapsible:a,open:u,defaultOpen:o,disabled:c,onOpenChange:i,...p}=r,[h,f]=He({prop:u,defaultProp:o??!1,onChange:i,caller:xe});return e.jsx(Vt,{scope:a,disabled:c,contentId:Js(),open:h,onOpenToggle:l.useCallback(()=>f(w=>!w),[f]),children:e.jsx(z.div,{"data-state":ke(h),"data-disabled":c?"":void 0,...p,ref:s})})});hs.displayName=xe;var fs="CollapsibleTrigger",xs=l.forwardRef((r,s)=>{const{__scopeCollapsible:a,...u}=r,o=Se(fs,a);return e.jsx(z.button,{type:"button","aria-controls":o.contentId,"aria-expanded":o.open||!1,"data-state":ke(o.open),"data-disabled":o.disabled?"":void 0,disabled:o.disabled,...u,ref:s,onClick:pe(r.onClick,o.onOpenToggle)})});xs.displayName=fs;var Ie="CollapsibleContent",gs=l.forwardRef((r,s)=>{const{forceMount:a,...u}=r,o=Se(Ie,r.__scopeCollapsible);return e.jsx(Ze,{present:a||o.open,children:({present:c})=>e.jsx(Lt,{...u,ref:s,present:c})})});gs.displayName=Ie;var Lt=l.forwardRef((r,s)=>{const{__scopeCollapsible:a,present:u,children:o,...c}=r,i=Se(Ie,a),[p,h]=l.useState(u),f=l.useRef(null),w=he(s,f),j=l.useRef(0),v=j.current,g=l.useRef(0),y=g.current,V=i.open||p,b=l.useRef(V),L=l.useRef(void 0);return l.useEffect(()=>{const R=requestAnimationFrame(()=>b.current=!1);return()=>cancelAnimationFrame(R)},[]),Qs(()=>{const R=f.current;if(R){L.current=L.current||{transitionDuration:R.style.transitionDuration,animationName:R.style.animationName},R.style.transitionDuration="0s",R.style.animationName="none";const H=R.getBoundingClientRect();j.current=H.height,g.current=H.width,b.current||(R.style.transitionDuration=L.current.transitionDuration,R.style.animationName=L.current.animationName),h(u)}},[i.open,u]),e.jsx(z.div,{"data-state":ke(i.open),"data-disabled":i.disabled?"":void 0,id:i.contentId,hidden:!V,...c,ref:w,style:{"--radix-collapsible-content-height":v?`${v}px`:void 0,"--radix-collapsible-content-width":y?`${y}px`:void 0,...r.style},children:V&&o})});function ke(r){return r?"open":"closed"}var $t=hs;const At=$t,Tt=xs,Ot=gs,Mt=()=>{const{items:r,subtotal:s,deliveryFee:a,total:u,totalItems:o}=Je(),[c,i]=l.useState(!1);return o===0?null:e.jsxs(At,{open:c,onOpenChange:i,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Tt,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",o," ",o===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u)}),c?e.jsx(et,{className:"h-5 w-5"}):e.jsx(st,{className:"h-5 w-5"})]})]})}),e.jsxs(Ot,{className:"p-4 pt-0",children:[e.jsx(ae,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:r.map(p=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[p.quantity,"x ",p.name,p.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",p.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(p.price*p.quantity)})]},p.id))}),e.jsx(ae,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(ae,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u)})]})]})]})]})},ys=r=>r.replace(/\D/g,""),js=r=>r.replace(/\D/g,""),we=r=>r.replace(/\D/g,""),Dt=Bs({name:F().min(1,"Nome é obrigatório."),phone:F().min(1,"Telefone é obrigatório.").transform(ys).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:F().email("Email inválido.").optional().or(Gs("")),delivery_option:zs(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:F().optional().default(""),number:F().optional().default(""),complement:F().optional().default(""),neighborhood:F().optional().default(""),city:F().optional().default(""),zip_code:F().optional().default("").transform(js).refine(r=>r.length===8||r.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ce(r=>typeof r=="string"?parseFloat(r):r,qe.number().optional().nullable()),longitude:Ce(r=>typeof r=="string"?parseFloat(r):r,qe.number().optional().nullable()),payment_method_id:F().min(1,"Selecione uma forma de pagamento."),notes:F().optional(),cpf_cnpj:F().optional().default("").transform(we).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ce(r=>{if(r==null||r==="")return null;const s=String(r).replace(",","."),a=parseFloat(s);return isNaN(a)?s:a},Ks({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((r,s)=>{if(r.delivery_option==="delivery"&&(r.street.trim()===""&&s.addIssue({code:q.custom,message:"Rua é obrigatória.",path:["street"]}),r.number.trim()===""&&s.addIssue({code:q.custom,message:"Número é obrigatório.",path:["number"]}),r.neighborhood.trim()===""&&s.addIssue({code:q.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),r.city.trim()===""&&s.addIssue({code:q.custom,message:"Cidade é obrigatória.",path:["city"]}),r.zip_code.length!==8&&s.addIssue({code:q.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(r.latitude===null||r.longitude===null)&&s.addIssue({code:q.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),r.payment_method_id==="Dinheiro"&&r.change_for!==null&&r.change_for!==void 0&&r.change_for<=0&&s.addIssue({code:q.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),r.payment_method_id==="Pagamento online: Pix/Cartão"){const o=we(r.cpf_cnpj||"");o.length!==11&&o.length!==14&&s.addIssue({code:q.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),qt=async()=>{const{data:r,error:s}=await O.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(s)throw new Error(`Erro ao buscar restaurante: ${s.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},Bt=async r=>{const{data:s,error:a}=await O.from("restaurants").select("delivery_enabled").eq("id",r).single();if(a)throw new Error(`Erro ao buscar status de entrega: ${a.message}`);return s.delivery_enabled??!0},Gt=async r=>{const{data:s,error:a}=await O.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(a)throw new Error(`Erro ao buscar métodos de pagamento: ${a.message}`);return s},zt=async r=>{const{data:s,error:a}=await O.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return s},Kt=r=>{switch(r){case"DollarSign":return pt;case"Smartphone":return dt;case"CreditCard":return mt;case"Package":return ut;default:return We}},Ut=({subtotal:r,deliveryFee:s,total:a,items:u})=>e.jsxs(ee,{className:"sticky top-4",children:[e.jsx(se,{children:e.jsx(te,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(re,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:u.map(o=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[o.quantity,"x ",o.name,o.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",o.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price*o.quantity)})]},o.id))}),e.jsx(ae,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:s>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s):"Grátis"})]})]}),e.jsx(ae,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]})]})]}),br=()=>{const r=Ds();Os();const s=Je(),{items:a,subtotal:u,deliveryFee:o,total:c,setDeliveryFee:i,clearCart:p}=s,[h]=qs(),[f,w]=l.useState(!1),[j,v]=l.useState(!1),[g,y]=l.useState(null),[V,b]=l.useState(null),L=h.get("status"),R=h.get("external_reference"),H=h.has("collection_id")||h.has("external_reference"),[ne,Fe]=l.useState(!!R);l.useEffect(()=>{if(R)if(L==="approved"||L==="failure"||L==="pending"){r(`/order-success/${R}?status=${L}`,{replace:!0});return}else H&&(B.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Fe(!1));else Fe(!1)},[R,L,H,r]);const{data:d,isLoading:vs,isError:bs,error:Ns}=ue({queryKey:["checkoutRestaurantData"],queryFn:qt}),{data:M,isLoading:ge}=ue({queryKey:["deliveryStatus",d==null?void 0:d.id],queryFn:()=>Bt(d.id),enabled:!!(d!=null&&d.id)}),{data:K=[],isLoading:Cs}=ue({queryKey:["checkoutPaymentMethods",d==null?void 0:d.id],queryFn:()=>Gt(d.id),enabled:!!(d!=null&&d.id)}),{data:Ve=[],isLoading:_s}=ue({queryKey:["checkoutDeliveryZones",d==null?void 0:d.id],queryFn:()=>zt(d.id),enabled:!!(d!=null&&d.id)}),ws=vs||ge||Cs||_s,Rs=bs,Le=Ns,n=Us({resolver:Zs(Dt),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),A=n.watch("delivery_option"),ye=n.watch("payment_method_id"),U=K.find(t=>t.id===ye),ie=(U==null?void 0:U.name)==="Pagamento online: Pix/Cartão",le=(U==null?void 0:U.name)==="Dinheiro",P=n.watch("latitude"),S=n.watch("longitude");n.watch(["street","number","neighborhood","city","zip_code"]);const D=A==="delivery",Es=l.useMemo(()=>JSON.stringify({deliveryOption:A,deliveryEnabled:M,lat:P,lng:S}),[A,M,P,S]),Ps=l.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:d!=null&&d.latitude&&(d!=null&&d.longitude)?[d.latitude,d.longitude]:[-23.55052,-46.633308],[P,S,d]),Ss=l.useMemo(()=>P===null||S===null?`map-${A}-null`:`map-${A}-${P.toFixed(6)}-${S.toFixed(6)}`,[D,A,P,S]),je=l.useCallback(t=>{const m=t.road||t.logradouro||"",x=t.house_number||"",N=t.suburb||t.bairro||"",_=t.city||t.localidade||"",T=t.postcode||t.cep||"";n.setValue("street",m,{shouldValidate:!0}),n.setValue("number",x||"",{shouldValidate:!0}),n.setValue("complement",t.suburb||"",{shouldValidate:!0}),n.setValue("neighborhood",N,{shouldValidate:!0}),n.setValue("city",_,{shouldValidate:!0}),n.setValue("zip_code",T,{shouldValidate:!0})},[n]),Is=l.useCallback(async(t,m)=>{n.setValue("latitude",t,{shouldValidate:!0}),n.setValue("longitude",m,{shouldValidate:!0});const x=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${m}&addressdetails=1`,N=await fetch(x);if(N.ok){const _=await N.json();_.address&&(je(_.address),B.info("Endereço preenchido a partir do mapa."))}},[n,je]),ks=l.useCallback(()=>{n.setValue("street","",{shouldValidate:!0}),n.setValue("number","",{shouldValidate:!0}),n.setValue("complement","",{shouldValidate:!0}),n.setValue("neighborhood","",{shouldValidate:!0}),n.setValue("city","",{shouldValidate:!0}),n.setValue("zip_code","",{shouldValidate:!0}),n.setValue("latitude",null,{shouldValidate:!0}),n.setValue("longitude",null,{shouldValidate:!0}),i(0),y(null),b(null),B.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[n,i]),ve=l.useCallback(t=>{try{const m={name:t.name,phone:t.phone,email:t.email,delivery_option:t.delivery_option,street:t.street,number:t.number,complement:t.complement,neighborhood:t.neighborhood,city:t.city,zip_code:t.zip_code,latitude:t.latitude,longitude:t.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(m))}catch(m){console.error("Failed to save form data to local storage",m)}},[]),$e=l.useCallback(()=>{try{const t=localStorage.getItem("checkoutFormData");if(t){const m=JSON.parse(t);n.reset({...n.getValues(),...m,delivery_option:m.delivery_option||"delivery"})}}catch(t){console.error("Failed to load form data from local storage",t)}},[n]);l.useEffect(()=>{$e()},[$e]),l.useEffect(()=>{const t=n.watch(m=>{ve(m)});return()=>t.unsubscribe()},[n,ve]);const Fs=async()=>{try{const t=n.getValues(),[m,x,N,_,T]=[t.street,t.number,t.neighborhood,t.city,t.zip_code],ce=js(T);if(!(m&&x&&N&&_&&ce.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),B.error("Preencha o endereço completo (Rua, Número, Bairro, Cidade, CEP) antes de salvar.");return}console.log("LOG: Iniciando geocodificação para:",`${m}, ${x}, ${N}, ${_}, ${T}`),v(!0);const de=`${m}, ${x}, ${N}, ${_}, ${T}`,G=await It(de);G?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",G),n.setValue("latitude",G.lat,{shouldValidate:!0}),n.setValue("longitude",G.lng,{shouldValidate:!0}),await n.trigger("latitude"),ve(n.getValues()),B.success("Endereço e localização salvos com sucesso!")):console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas.")}catch(t){console.error("LOG: Erro capturado durante a geocodificação:",t)}finally{v(!1)}};l.useEffect(()=>{le||n.setValue("change_for",null,{shouldValidate:!0})},[le,n]),l.useEffect(()=>{A==="pickup"&&(i(0),y(null),b(null),n.setValue("latitude",null),n.setValue("longitude",null))},[A,D,n,i,P,S]),l.useEffect(()=>{K.length>0&&!ye&&n.setValue("payment_method_id",K[0].id)},[K,ye,n]),l.useEffect(()=>{ie?n.trigger("cpf_cnpj"):n.clearErrors("cpf_cnpj")},[ie,n]),l.useEffect(()=>{const t=async()=>{if(A==="pickup"||!(d!=null&&d.latitude)||!(d!=null&&d.longitude)){i(0),y(null),b(null);return}if(ge)return;if(M===!1){i(0),y(null),b(null),v(!1);return}v(!0),y(null);let x=null;if(P&&S)x=[P,S];else{i(0),b(null),v(!1);return}if(x){const N=[d.latitude,d.longitude],_=kt(x,N,Ve);_?(i(_.fee),y(null),b({minTime:_.minTime,maxTime:_.maxTime})):(i(0),y("Seu endereço está fora da nossa área de entrega."),b(null))}v(!1)},m=setTimeout(()=>{t()},500);return()=>clearTimeout(m)},[Es,d,Ve,n,i,D,P,S,M,ge]),l.useEffect(()=>{if(a.length===0&&!f&&!ne){const t=setTimeout(()=>{B.info("Seu carrinho está vazio. Adicione itens para continuar."),r("/menu")},0);return()=>clearTimeout(t)}},[a.length,r,f,ne]);const Ae=Ms({mutationFn:async t=>{if(!d)throw new Error("Dados do restaurante indisponíveis.");if(t.delivery_option==="delivery"&&g)throw new Error(g);const m=[t.street,t.number,t.complement?`(${t.complement})`:null,t.neighborhood,t.city,t.zip_code].filter(Boolean).join(", "),x=t.delivery_option==="delivery"?m:"Retirada no Local";let N;const _=ys(t.phone),T=we(t.cpf_cnpj||""),{data:ce}=await O.from("customers").select("id").eq("phone",_).limit(1).single();if(ce)N=ce.id,T&&await O.from("customers").update({cpf_cnpj:T}).eq("id",N);else{const{data:Z,error:Me}=await O.from("customers").insert({name:t.name,phone:_,email:t.email||null,address:x,latitude:t.latitude,longitude:t.longitude,cpf_cnpj:T||null}).select("id").single();if(Me)throw new Error(`Erro ao criar cliente: ${Me.message}`);N=Z.id}const Ne=ie?"pending_payment":"pending",{data:de,error:G}=await O.from("orders").insert({restaurant_id:d.id,customer_id:N,status:Ne,total_amount:c,delivery_fee:o,notes:t.notes,delivery_address:x,payment_method_id:t.payment_method_id,change_for:le?t.change_for:null}).select("id").single();if(G)throw new Error(`Erro ao criar pedido: ${G.message}`);const Ts=a.map(Z=>({order_id:de.id,product_id:Z.id,quantity:Z.quantity,unit_price:Z.price,notes:Z.notes||null})),{error:Oe}=await O.from("order_items").insert(Ts);if(Oe)throw new Error(`Erro ao adicionar itens do pedido: ${Oe.message}`);return{orderId:de.id,orderStatus:Ne}},onSuccess:t=>{p(),t.orderStatus==="pending_payment"?(w(!0),r(`/payment/${t.orderId}`)):r(`/order-success/${t.orderId}`)},onError:t=>{B.error("Erro ao processar pedido",{description:t instanceof Error?t.message:"Tente novamente."})}}),Vs=async t=>{Ae.mutate(t)},Ls=t=>{var x;console.error("Validation errors:",t);const m=Object.keys(t)[0];m&&B.error("Erro de validação",{description:((x=t[m])==null?void 0:x.message)||"Preencha todos os campos obrigatórios."})},Te=Ae.isPending||f||j,$s=!D||!g&&o>=0,be=!D||P!==null&&S!==null,As=!Te&&$s&&be;return a.length===0&&!f&&!ne?e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."}):ws||ne?e.jsx(Ws,{}):Rs?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(Q,{variant:"destructive",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro de Conexão"}),e.jsx(X,{children:Le instanceof Error?Le.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(De,{to:"/menu",children:e.jsx(J,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(ct,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("div",{children:e.jsx(Mt,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ot,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(Vs,Ls),className:"space-y-6",children:[e.jsxs(ee,{children:[e.jsx(se,{children:e.jsx(te,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(re,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"name",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Nome Completo *"}),e.jsx($,{placeholder:"Seu nome",...t}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:n.control,name:"phone",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Telefone *"}),e.jsx(ms,{...t}),e.jsx(k,{})]})}),e.jsx(I,{control:n.control,name:"email",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Email (Opcional)"}),e.jsx($,{placeholder:"seu@email.com",...t}),e.jsx(k,{})]})})]})]})]}),e.jsxs(ee,{children:[e.jsx(se,{children:e.jsx(te,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(re,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"delivery_option",render:({field:t})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(Y,{children:e.jsxs(_e,{onValueChange:t.onChange,defaultValue:t.value,className:"flex flex-col space-y-1",children:[e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(Y,{children:e.jsx(me,{value:"delivery"})}),e.jsx(ze,{className:"h-5 w-5 text-primary"}),e.jsxs(E,{className:oe("font-normal flex-1 cursor-pointer"),children:["Delivery",M===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(Y,{children:e.jsx(me,{value:"pickup"})}),e.jsx(We,{className:"h-5 w-5 text-primary"}),e.jsx(E,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(k,{})]})}),D&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ke,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(J,{type:"button",variant:"outline",size:"sm",onClick:t=>{t.preventDefault(),Fs()},disabled:j,children:[e.jsx(xt,{className:"h-4 w-4 mr-2"})," Salvar Endereço"]}),e.jsxs(J,{type:"button",variant:"outline",size:"sm",onClick:ks,children:[e.jsx(ft,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:n.control,name:"street",render:({field:t})=>e.jsxs(C,{className:"col-span-2",children:[e.jsx(E,{children:"Rua *"}),e.jsx($,{...t}),e.jsx(k,{})]})}),e.jsx(I,{control:n.control,name:"number",render:({field:t})=>e.jsxs(C,{className:"col-span-1",children:[e.jsx(E,{children:"Número *"}),e.jsx($,{...t}),e.jsx(k,{})]})})]}),e.jsx(I,{control:n.control,name:"complement",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Complemento (Opcional)"}),e.jsx($,{placeholder:"Apto, Bloco, Casa, etc.",...t,disabled:!1}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:n.control,name:"neighborhood",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Bairro *"}),e.jsx($,{...t}),e.jsx(k,{})]})}),e.jsx(I,{control:n.control,name:"city",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Cidade *"}),e.jsx($,{...t}),e.jsx(k,{})]})})]}),e.jsx(I,{control:n.control,name:"zip_code",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"CEP *"}),e.jsx(nt,{...t}),e.jsx(k,{})]})}),D&&be&&e.jsx("div",{children:e.jsx(it,{mapKey:Ss,markerPosition:Ps,onLocationChange:Is,updateAddressFields:je,restaurant:d})}),j&&M!==!1&&e.jsxs(Q,{children:[e.jsx(Be,{className:"h-4 w-4 animate-spin"}),e.jsx(W,{children:"Calculando Taxa..."}),e.jsx(X,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),g&&M!==!1&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro de Entrega"}),e.jsx(X,{children:g})]}),o>0&&!j&&M!==!1&&e.jsxs(Q,{className:"mt-4",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx(W,{children:"Taxa de Entrega Aplicada"}),e.jsxs(X,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)]})]}),D&&!be&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx(W,{children:"Localização Obrigatória"}),e.jsx(X,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ee,{children:[e.jsx(se,{children:e.jsx(te,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(re,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"payment_method_id",render:({field:t})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(Y,{children:e.jsx(_e,{onValueChange:m=>{t.onChange(m);const x=K.find(N=>N.id===m);(x==null?void 0:x.name)!=="Dinheiro"&&n.setValue("change_for",null,{shouldValidate:!0}),(x==null?void 0:x.name)==="Pagamento online: Pix/Cartão"?n.trigger("cpf_cnpj"):n.clearErrors("cpf_cnpj")},defaultValue:t.value,className:"flex flex-col space-y-2",children:K.map(m=>{const x=Kt(m.icon||"Store");return e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(Y,{children:e.jsx(me,{value:m.id})}),e.jsx(x,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(E,{className:"font-normal cursor-pointer",children:m.name}),m.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:m.description})]})]},m.id)})})}),e.jsx(k,{})]})}),le&&e.jsx(I,{control:n.control,name:"change_for",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Troco para (Opcional)"}),e.jsx($,{type:"number",placeholder:"Ex: 50.00",...t,value:t.value||"",onChange:m=>t.onChange(m.target.value?parseFloat(m.target.value):null)}),e.jsx(k,{})]})}),ie&&e.jsx(I,{control:n.control,name:"cpf_cnpj",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"CPF/CNPJ *"}),e.jsx(ps,{...t}),e.jsx(k,{})]})})]})]}),e.jsxs(ee,{children:[e.jsx(se,{children:e.jsx(te,{className:"text-xl",children:"4. Observações"})}),e.jsx(re,{children:e.jsx(I,{control:n.control,name:"notes",render:({field:t})=>e.jsxs(C,{children:[e.jsx(E,{children:"Observações do Pedido (Opcional)"}),e.jsx(at,{placeholder:"Ex: Sem cebola, sem alface...",...t}),e.jsx(k,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(De,{to:"/menu",className:"flex-1",children:e.jsx(J,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(J,{type:"submit",className:"flex-1",disabled:!As,size:"lg",children:Te?e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(Ut,{subtotal:u,deliveryFee:o,total:c,items:a})})]})]})]})};export{br as default};
