import{u as v,j as e}from"./tanstack-C7aOFagJ.js";import{h as I,u as C,k as $,r as f}from"./vendor-DjsPZZVP.js";import{j as n,C as b,e as N,f as R,L as S,Y as k,b as L,s as y}from"./index-B-46Ikd-.js";import{C as q}from"./circle-alert-CUdBE3XT.js";import"./supabase-BAEEEeUB.js";const O=async r=>{const{data:d,error:a}=await y.from("orders").select("*").eq("id",r).limit(1).single();if(a)throw new Error(`Erro ao buscar pedido: ${a.message}`);if(!d)throw new Error("Pedido não encontrado.");return d},Q=()=>{const r=I(),{orderId:d}=C(),[a]=$(),[j,t]=f.useState("Verificando status do pagamento..."),[g,i]=f.useState(!0),[p,u]=f.useState(!1);a.get("status");const w=a.get("external_reference"),E=a.get("restaurantId"),s=d||w,{data:c,isLoading:x}=v({queryKey:["paymentRedirectOrder",s],queryFn:()=>O(s),enabled:!!s,staleTime:0}),o=(c==null?void 0:c.restaurant_id)||E;return f.useEffect(()=>{if(!s){t("ID do pedido não encontrado na URL."),u(!0),i(!1),n.error("Erro de redirecionamento: ID do pedido ausente."),r("/menu",{replace:!0});return}if(x)return;if(!c){t("Pedido não encontrado no banco de dados."),u(!0),i(!1),n.error("Erro: Pedido não existe."),r("/menu",{replace:!0});return}(async()=>{i(!0),t("Confirmando pagamento com Mercado Pago...");try{const{data:m,error:h}=await y.functions.invoke("confirm-payment",{body:{orderId:s}});if(h)throw new Error(h.message);const l=m,P=`/order-success/${s}?status=${l.status}${o?`&restaurantId=${o}`:""}`;l.status==="approved"?(t("Pagamento Aprovado! Redirecionando..."),n.success("Pagamento aprovado!"),r(P,{replace:!0})):l.status==="pending"?(t("Pagamento Pendente. Aguardando confirmação..."),n.warning("Pagamento pendente. Você será notificado quando for confirmado."),r(P,{replace:!0})):(t(`Pagamento Recusado. Status: ${l.status}`),n.error("Pagamento recusado. Tente novamente."),u(!0),r(`/checkout${o?`?restaurantId=${o}`:""}`,{replace:!0}))}catch(m){console.error("Erro na confirmação de pagamento:",m),t(`Erro ao processar pagamento: ${m.message}`),u(!0),i(!1),n.error("Erro ao processar pagamento. Tente novamente."),r(`/checkout${o?`?restaurantId=${o}`:""}`,{replace:!0})}})()},[s,x,c,r,a,o]),e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-muted",children:e.jsxs(b,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(N,{children:e.jsxs(R,{className:"text-2xl font-bold flex items-center justify-center gap-2",children:[g?e.jsx(S,{className:"h-6 w-6 animate-spin text-primary"}):p?e.jsx(q,{className:"h-6 w-6 text-destructive"}):e.jsx(k,{className:"h-6 w-6 text-green-500"}),g?"Processando Pagamento":p?"Erro de Pagamento":"Redirecionando..."]})}),e.jsxs(L,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:j}),p&&e.jsx("div",{className:"mt-4",children:e.jsx("p",{className:"text-sm text-destructive",children:"Você será redirecionado em breve."})})]})]})})};export{Q as default};
