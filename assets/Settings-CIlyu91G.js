import{j as e,u as k,b as U,c as V}from"./tanstack-d4AvmB45.js";import{o as K,s as x,l as Q,b as G,p as F,c as T,u as Z,t as H}from"./types-DKlirIXB.js";import{s as v}from"./client-D5i5GwB9.js";import{B as R}from"./button-yCXBISoV.js";import{C as D,b as P,c as A,a as I}from"./card-ByeNXrRP.js";import{I as j,L as J}from"./label-DTW1f4gm.js";import{T as W}from"./textarea-BXm_PSDk.js";import{S as X}from"./switch-BPtn4IdT.js";import{u as g,L as Y}from"./index-DGr-FHe_.js";import{F as ee,a as l,b as d,c,d as m,e as p}from"./form-i_kzg4Wx.js";import{S as re}from"./skeleton-Drr-9Pql.js";import{r as u,i as se}from"./vendor-CnEXr6gt.js";import{L as ae,Z as oe}from"./LazyMap-ZMNxUrJU.js";import{M as te,P as ne}from"./PhoneInput-Du77Q7O5.js";import{M as ie,R as le}from"./refresh-cw-u3P25bav.js";import{P as de}from"./phone-2_i1hZSN.js";import"./supabase-BZV_3FV3.js";import"./index-KNP7Yozt.js";const ce=({markerPosition:s,onLocationChange:n,restaurant:i})=>{const[N,y]=u.useState(!1),E=u.useCallback(async()=>{y(!0);const b=g.loading("Buscando endereço a partir do mapa..."),[w,C]=s;try{const a=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${w}&lon=${C}&zoom=18&addressdetails=1`,h=await fetch(a);if(!h.ok)throw new Error("Falha na geocodificação reversa.");const t=await h.json();if(t.address){const S={street:t.address.road||t.address.pedestrian||"",number:t.address.house_number||"",neighborhood:t.address.neighbourhood||t.address.suburb||"",city:t.address.city||t.address.town||t.address.village||"",zip_code:t.address.postcode||""};g.success("Endereço atualizado com base na localização do mapa!")}else g.warning("Não foi possível encontrar um endereço detalhado para esta localização.")}catch(a){g.error(`Erro na busca reversa: ${a.message}`)}finally{y(!1),g.dismiss(b)}},[s]),o=u.useMemo(()=>[i.street,i.number,i.neighborhood,i.city,i.zip_code].filter(Boolean).join(", "),[i]);return e.jsxs(D,{className:"mt-6",children:[e.jsx(P,{children:e.jsxs(A,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ie,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(I,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(ae,{center:s,markerPosition:s,onMarkerDragEnd:n,zoom:15})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[70%] truncate",children:["Endereço atual: ",o||"N/A"]}),e.jsxs(R,{type:"button",variant:"outline",onClick:E,disabled:N,children:[N?e.jsx(Y,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(le,{className:"h-4 w-4 mr-2"}),"Atualizar Endereço"]})]})]})]})},me=u.memo(ce),ue=s=>s.replace(/\D/g,""),he=K({name:x().min(1,"O nome do restaurante é obrigatório."),description:x().optional(),street:x().min(1,"A rua é obrigatória."),number:x().min(1,"O número é obrigatório."),neighborhood:x().min(1,"O bairro é obrigatório."),city:x().min(1,"A cidade é obrigatória."),zip_code:x().min(1,"O CEP é obrigatório.").transform(s=>s.replace(/\D/g,"")).refine(s=>s.length===8,{message:"O CEP deve ter 8 dígitos."}),phone:x().min(1,"Telefone é obrigatório.").transform(ue).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:x().email("Email inválido.").optional().or(Q("")),is_active:G().default(!0),latitude:F(s=>String(s).replace(",","."),T.number({invalid_type_error:"Latitude deve ser um número."}).refine(s=>s!==null,{message:"A localização no mapa é obrigatória. Mova o pino no mapa para definir a localização."})),longitude:F(s=>String(s).replace(",","."),T.number({invalid_type_error:"Longitude deve ser um número."}).refine(s=>s!==null,{message:"A localização no mapa é obrigatória. Mova o pino no mapa para definir a localização."}))}),pe=async s=>{const{data:n,error:i}=await v.from("restaurants").select("*").eq("id",s).single();if(i)throw new Error(`Erro ao buscar dados do restaurante: ${i.message}`);if(!n)throw new Error("Nenhum restaurante encontrado.");return n},Re=()=>{const s=k(),{userRestaurantId:n}=se(),[i,N]=u.useState(!1),[y,E]=u.useState(null),{data:o,isLoading:b,isError:w,error:C}=U({queryKey:["restaurantSettings",n],queryFn:()=>pe(n),enabled:!!n,staleTime:1e3*60*5});u.useEffect(()=>{v.auth.getSession().then(({data:{session:r}})=>{var f;E(((f=r==null?void 0:r.user)==null?void 0:f.email)||null)})},[]);const a=Z({resolver:H(he),defaultValues:{name:"",description:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});u.useEffect(()=>{o&&(a.reset({name:o.name||"",description:o.description||"",street:o.street||"",number:o.number||"",neighborhood:o.neighborhood||"",city:o.city||"",zip_code:o.zip_code||"",phone:o.phone||"",email:o.email||"",is_active:o.is_active??!0,latitude:o.latitude??null,longitude:o.longitude??null}),o.latitude&&o.longitude&&N(!0))},[o,a.reset]);const h=a.watch("latitude"),t=a.watch("longitude"),S=[-23.55052,-46.633308],q=u.useMemo(()=>typeof h=="number"&&typeof t=="number"&&!isNaN(h)&&!isNaN(t)?[h,t]:S,[h,t]),B=u.useCallback((r,f)=>{a.setValue("latitude",r,{shouldValidate:!0}),a.setValue("longitude",f,{shouldValidate:!0})},[a]),z=V({mutationFn:async r=>{if(!n)throw new Error("ID do restaurante não disponível.");const f={name:r.name,description:r.description,logo_url:null,street:r.street,number:r.number,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code.replace(/\D/g,""),phone:r.phone,email:r.email,is_active:r.is_active,latitude:r.latitude,longitude:r.longitude},{error:_}=await v.from("restaurants").update(f).eq("id",n);if(_)throw _;const{data:{user:M}}=await v.auth.getUser();if(M){const $={phone:r.phone},{error:L}=await v.from("profiles").update($).eq("id",M.id);L&&console.warn("Falha ao sincronizar telefone com o perfil:",L.message)}},onSuccess:()=>{g.success("Configurações salvas com sucesso!"),s.invalidateQueries({queryKey:["restaurantSettings",n]}),s.invalidateQueries({queryKey:["adminProfile"]})},onError:r=>g.error(`Erro ao salvar configurações: ${r.message}`)}),O=u.useMemo(()=>h===null||t===null?"map-settings-null":`map-settings-${h.toFixed(6)}-${t.toFixed(6)}`,[h,t]);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(D,{children:[e.jsx(P,{children:e.jsx(A,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(I,{children:[b&&e.jsx(re,{className:"h-96 w-full"}),w&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",C.message]}),!n&&!b&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),o&&!w&&!b&&e.jsx(ee,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(r=>z.mutate(r)),className:"space-y-6",children:[e.jsx(l,{control:a.control,name:"name",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Nome do Restaurante *"}),e.jsx(m,{children:e.jsx(j,{...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"description",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Descrição"}),e.jsx(m,{children:e.jsx(W,{...r,rows:3})}),e.jsx(p,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Contato e Status"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(J,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(te,{className:"h-4 w-4"}),"Email do Administrador"]}),e.jsx(j,{value:y||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este é o email de login do administrador."})]}),e.jsx(l,{control:a.control,name:"phone",render:({field:r})=>e.jsxs(d,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),"Telefone do Restaurante *"]}),e.jsx(m,{children:e.jsx(ne,{...r})}),e.jsx(p,{})]})})]}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{control:a.control,name:"street",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Rua *"}),e.jsx(m,{children:e.jsx(j,{placeholder:"Nome da rua",...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"number",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Número *"}),e.jsx(m,{children:e.jsx(j,{placeholder:"Número",...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"neighborhood",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Bairro *"}),e.jsx(m,{children:e.jsx(j,{placeholder:"Bairro",...r})}),e.jsx(p,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"city",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Cidade *"}),e.jsx(m,{children:e.jsx(j,{placeholder:"Cidade",...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"zip_code",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"CEP *"}),e.jsx(m,{children:e.jsx(oe,{placeholder:"00000-000",...r})}),e.jsx(p,{})]})})]}),e.jsx("div",{className:"pt-4 border-t",children:i&&e.jsx(me,{mapKey:O,markerPosition:q,onLocationChange:B,restaurant:o})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"latitude",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Latitude *"}),e.jsx(m,{children:e.jsx(j,{...r,placeholder:"-22.7627908",value:r.value??""})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"longitude",render:({field:r})=>e.jsxs(d,{children:[e.jsx(c,{children:"Longitude *"}),e.jsx(m,{children:e.jsx(j,{...r,placeholder:"-47.408315",value:r.value??""})}),e.jsx(p,{})]})})]}),e.jsx(l,{control:a.control,name:"is_active",render:({field:r})=>e.jsxs(d,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(c,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(m,{children:e.jsx(X,{checked:r.value,onCheckedChange:r.onChange})})]})}),e.jsx(R,{type:"submit",className:"w-full h-12 text-lg",disabled:z.isPending||!n,children:z.isPending?"Salvando...":"Salvar Configurações"})]})})]})]})})})};export{Re as default};
