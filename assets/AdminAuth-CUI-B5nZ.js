import{j as e}from"./tanstack-QxCZ3Wpf.js";import{u as U,r as l,L as q}from"./vendor-CIxFcw7z.js";import{L as D}from"./Logo-DFxck_QJ.js";import{B as v}from"./button-BsbzLqLk.js";import{L as f,I as j}from"./label-DQR_2XPj.js";import{C as R,b as _,c as O,d as T,a as z}from"./card-B9AZpRz2.js";import{c as b,a as G,L as B,u as t}from"./index-CdfIIGcT.js";import{s as m}from"./client-BskZ_u5h.js";import{P as H}from"./PhoneInput-mISmOCLO.js";import{S as M}from"./separator-Cwvfr4oo.js";import"./package-PMjeHWic.js";import"./supabase-DGFirUEE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=b("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=b("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),S=o=>o.replace(/\D/g,""),C=async o=>{const{data:n,error:i}=await m.from("user_roles").select("role").eq("user_id",o).in("role",["admin","moderator"]).limit(1).single();return i&&i.code!=="PGRST116"?(console.error("Error checking role:",i),null):(n==null?void 0:n.role)||null},J=async o=>{let n=await C(o.id);if(n!=="admin"&&n!=="moderator"){const i=o.user_metadata.full_name||"Novo Restaurante",{error:u}=await m.functions.invoke("setup-initial-admin-store",{body:{userId:o.id,fullName:i}});if(u)return console.error("Error setting up initial store:",u),null;n=await C(o.id)}return n},ie=()=>{const o=U(),[n,i]=l.useState(!0),[u,x]=l.useState(!1),[c,k]=l.useState(!1),[h,E]=l.useState(""),[p,L]=l.useState(""),[g,P]=l.useState(""),[N,A]=l.useState(""),[W,y]=l.useState(null),w=async s=>{i(!0);try{const a=await J(s);if(a==="admin"||a==="moderator")t.success("Acesso ao painel concedido."),o("/dashboard",{replace:!0});else{t.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await m.auth.signOut();const r=`${window.location.origin}${window.location.pathname}#/menu`;window.location.href=r}}catch(a){console.error("Error during admin setup/redirect:",a),t.error("Erro crítico de autenticação. Tente novamente."),await m.auth.signOut(),i(!1)}};l.useEffect(()=>{(async()=>{const{data:{session:r}}=await m.auth.getSession();y(r),r!=null&&r.user?w(r.user):i(!1)})();const{data:{subscription:a}}=m.auth.onAuthStateChange((r,d)=>{y(d),r==="SIGNED_IN"&&(d!=null&&d.user)?w(d.user):r==="SIGNED_OUT"&&i(!1)});return()=>a.unsubscribe()},[o]);const I=()=>{if(c){if(!g.trim())return t.error("O Nome Completo é obrigatório."),!1;if(S(N).length!==11)return t.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1}return h.trim()?p.length<6?(t.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(t.error("O Email é obrigatório."),!1)},F=async s=>{if(s.preventDefault(),!!I()){x(!0);try{if(c){const a=S(N),{data:r,error:d}=await m.auth.signUp({email:h,password:p,options:{data:{full_name:g,phone:a}}});if(d)throw d;r.session?t.success("Conta de administrador criada e login efetuado!"):(t.success("Conta criada! Verifique seu email para confirmar."),x(!1))}else{const{error:a}=await m.auth.signInWithPassword({email:h,password:p});if(a)throw a;t.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?t.error("Por favor, verifique seu e-mail para confirmar sua conta."):t.error(a.message||"Erro ao processar autenticação"),x(!1)}}};return n?e.jsx(G,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(D,{className:"justify-center mb-4"})}),e.jsxs(R,{className:"shadow-xl border-2",children:[e.jsxs(_,{className:"space-y-1",children:[e.jsxs(O,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[c?e.jsx($,{className:"h-6 w-6 text-primary"}):e.jsx(V,{className:"h-6 w-6 text-destructive"}),c?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(T,{className:"text-center",children:c?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs(z,{className:"space-y-4",children:[e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(j,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:g,onChange:s=>P(s.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"phone",children:"Telefone *"}),e.jsx(H,{id:"phone",value:N,onChange:s=>A(s.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"email",children:"Email *"}),e.jsx(j,{id:"email",type:"email",placeholder:"seu@email.com",value:h,onChange:s=>E(s.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"password",children:"Senha *"}),e.jsx(j,{id:"password",type:"password",placeholder:"••••••••",value:p,onChange:s=>L(s.target.value),required:!0,className:"h-12"})]}),e.jsx(v,{type:"submit",className:"w-full",size:"lg",disabled:u,children:u?e.jsx(B,{className:"h-4 w-4 animate-spin mr-2"}):c?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(v,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>k(!c),children:c?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(M,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(q,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{ie as default};
