const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./MapComponent-Bjw49SM-.js","./tanstack-E1juXnZE.js","./vendor-nYMJN4lg.js","./index-Cf_TXpBF.js","./supabase-CBMN163Q.js","./index-BPWbAkX-.css"])))=>i.map(i=>d[i]);
import{j as e,u as de,a as ue,b as Q}from"./tanstack-E1juXnZE.js";import{o as me,s as b,l as G,e as he,p as Z,c as H,u as pe,t as xe}from"./types-DkmadQTj.js";import{s as k}from"./client-DHSUo4L7.js";import{B as $}from"./button-DZf5fjUF.js";import{C as P,a as q,b as T,d as I}from"./card-CkBgMLGH.js";import{I as x}from"./input-CwnxbN_z.js";import{L as X}from"./label-akLErNRj.js";import{T as ge}from"./textarea-CTqQwRfA.js";import{S as je}from"./switch-BX1vAzAN.js";import{c as J,a as fe,d as be,u as n,L as W}from"./index-Cf_TXpBF.js";import{F as ve,a as d,b as u,e as m,c as h,d as p}from"./form-BcJ-rGFv.js";import{S as ye}from"./skeleton-y5dhUFmF.js";import{R as we,r as i,b as Ne}from"./vendor-nYMJN4lg.js";import{u as Ce}from"./use-sound-BCUTcw37.js";import{_ as Ee}from"./supabase-CBMN163Q.js";import{M as Se}from"./map-pin-CJBeS-JT.js";import{R as _e}from"./refresh-cw-Df9wjuQL.js";import{C as Ve}from"./circle-check-big-CXHfle4r.js";import{V as Le}from"./volume-2-DYtGp0QA.js";import{C as Me}from"./circle-x-6q2_FIhd.js";import{U as Re}from"./upload-DILmYOjM.js";import"./index-DpcYSu1F.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=J("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=J("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),ze=l=>{let t=l.replace(/\D/g,"");return t.length>8&&(t=t.slice(0,8)),t.length>5&&(t=`${t.slice(0,5)}-${t.slice(5)}`),t},A=we.forwardRef(({className:l,value:t,onChange:r,...g},j)=>{const w=v=>{const y=v.target.value,_=ze(y),V={...v,target:{...v.target,value:_}};r(V)};return e.jsx(x,{ref:j,type:"tel",className:fe("w-full",l),placeholder:"00000-000",value:t,onChange:w,maxLength:9,...g})});A.displayName="ZipCodeInput";const Fe=i.lazy(()=>Ee(()=>import("./MapComponent-Bjw49SM-.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),Ue=l=>e.jsx(i.Suspense,{fallback:e.jsx(be,{}),children:e.jsx(Fe,{...l})}),De=({mapKey:l,markerPosition:t,onLocationChange:r,updateAddressFields:g,restaurant:j})=>{const[w,v]=i.useState(!1),y=i.useCallback(async()=>{v(!0);const V=n.loading("Buscando endereço a partir do mapa..."),[z,F]=t;try{const L=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${z}&lon=${F}&zoom=18&addressdetails=1`,a=await fetch(L);if(!a.ok)throw new Error("Falha na geocodificação reversa.");const N=await a.json();N.address?(g(N.address),n.success("Endereço atualizado com base na localização do mapa!")):n.warning("Não foi possível encontrar um endereço detalhado para esta localização.")}catch(L){n.error(`Erro na busca reversa: ${L.message}`)}finally{v(!1),n.dismiss(V)}},[t,g]),_=i.useMemo(()=>[j.street,j.number,j.neighborhood,j.city,j.zip_code].filter(Boolean).join(", "),[j]);return e.jsxs(P,{className:"mt-6",children:[e.jsx(q,{children:e.jsxs(T,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Se,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(I,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(Ue,{center:t,markerPosition:t,onMarkerDragEnd:r,zoom:15},l)}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[70%] truncate",children:["Endereço atual: ",_||"N/A"]}),e.jsxs($,{type:"button",variant:"outline",onClick:y,disabled:w,children:[w?e.jsx(W,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Atualizar Endereço"]})]})]})]})},Pe=i.memo(De),qe=me({name:b().min(1,"O nome do restaurante é obrigatório."),description:b().optional(),logo_url:b().url("URL do logo inválida.").optional().or(G("")),street:b().optional(),number:b().optional(),neighborhood:b().optional(),city:b().optional(),zip_code:b().optional(),phone:b().optional(),email:b().email("Email inválido.").optional().or(G("")),is_active:he().default(!0),latitude:Z(l=>String(l).replace(",","."),H.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:Z(l=>String(l).replace(",","."),H.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),Te=async l=>{const{data:t,error:r}=await k.from("restaurants").select("*").eq("id",l).single();if(r)throw new Error(`Erro ao buscar dados do restaurante: ${r.message}`);if(!t)throw new Error("Nenhum restaurante encontrado.");return t},ds=()=>{const l=de(),{playSound:t}=Ce(),{userRestaurantId:r}=Ne(),[g,j]=i.useState(null),[w,v]=i.useState(""),[y,_]=i.useState(""),[V,z]=i.useState(!1),[F,L]=i.useState(!1),{data:a,isLoading:N,isError:B,error:Y}=ue({queryKey:["restaurantSettings",r],queryFn:()=>Te(r),enabled:!!r,staleTime:1e3*60*5}),o=pe({resolver:xe(qe),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});i.useEffect(()=>{a&&(o.reset({name:a.name||"",description:a.description||"",logo_url:a.logo_url||"",street:a.street||"",number:a.number||"",neighborhood:a.neighborhood||"",city:a.city||"",zip_code:a.zip_code||"",phone:a.phone||"",email:a.email||"",is_active:a.is_active??!0,latitude:a.latitude??null,longitude:a.longitude??null}),a.latitude&&a.longitude&&L(!0))},[a,o.reset]);const C=o.watch("latitude"),E=o.watch("longitude"),ee=[-23.55052,-46.633308],se=i.useMemo(()=>typeof C=="number"&&typeof E=="number"&&!isNaN(C)&&!isNaN(E)?[C,E]:ee,[C,E]),oe=i.useCallback(s=>{o.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),o.setValue("number",s.house_number||"",{shouldValidate:!0}),o.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),o.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0}),v((s.postcode||s.cep||"").replace(/\D/g,"")),_(s.house_number||"")},[o]),ae=async()=>{const s=o.getValues();s.street,s.number,s.neighborhood,s.city,s.zip_code;const c=w.replace(/\D/g,"");if(c.length!==8||!y){n.warning("Por favor, digite um CEP válido e o número da casa.");return}z(!0);const M=n.loading("Buscando endereço e coordenadas...");try{const S=await fetch(`https://viacep.com.br/ws/${c}/json/`);if(!S.ok)throw new Error("Falha na busca do CEP.");const f=await S.json();if(f.erro){n.error("CEP não encontrado.");return}o.setValue("street",f.logradouro,{shouldValidate:!0}),o.setValue("number",y,{shouldValidate:!0}),o.setValue("neighborhood",f.bairro,{shouldValidate:!0}),o.setValue("city",f.localidade,{shouldValidate:!0}),o.setValue("zip_code",f.cep,{shouldValidate:!0});const R=`${f.logradouro}, ${y}, ${f.localidade}, ${f.uf}`,le=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(R)}`,O=await(await fetch(le)).json();if(O.length>0){const{lat:ie,lon:ce}=O[0];o.setValue("latitude",parseFloat(ie),{shouldValidate:!0}),o.setValue("longitude",parseFloat(ce),{shouldValidate:!0}),L(!0),n.success("Endereço e mapa atualizados com sucesso!")}else n.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(S){n.dismiss(M),n.error(`Erro na busca: ${S.message}`)}finally{z(!1),n.dismiss(M)}},re=i.useCallback((s,c)=>{o.setValue("latitude",s,{shouldValidate:!0}),o.setValue("longitude",c,{shouldValidate:!0})},[o]),U=Q({mutationFn:async s=>{if(!r)throw new Error("ID do restaurante não disponível.");const{error:c}=await k.from("restaurants").update(s).eq("id",r);if(c)throw c},onSuccess:()=>{n.success("Configurações salvas com sucesso!"),l.invalidateQueries({queryKey:["restaurantSettings",r]})},onError:s=>n.error(`Erro ao salvar configurações: ${s.message}`)}),D=Q({mutationFn:async s=>{if(!r)throw new Error("ID do restaurante não disponível.");if(s.type!=="audio/mpeg"&&s.type!=="audio/mp3")throw new Error("O arquivo deve ser do tipo MP3.");const c=`${r}/notification.mp3`;console.log(`[Sound Upload] Attempting upload to settings/${c}`);const{error:M}=await k.storage.from("settings").upload(c,s,{upsert:!0,contentType:"audio/mpeg"});if(M)throw M;const{data:S}=k.storage.from("settings").getPublicUrl(c);if(!S.publicUrl)throw new Error("Falha ao obter a URL pública do arquivo.");const f=`${S.publicUrl}?t=${new Date().getTime()}`;console.log(`[DB Update] Updating restaurant ID: ${r} with URL: ${f}`);const{error:R}=await k.from("restaurants").update({notification_sound_url:f}).eq("id",r);if(R)throw console.error("[DB Update Error] Supabase Error:",R),new Error(`Falha ao salvar URL no banco de dados: ${R.message}`)},onSuccess:()=>{n.success("Som de notificação atualizado com sucesso!"),l.invalidateQueries({queryKey:["restaurantSettings",r]}),j(null)},onError:s=>{console.error("Erro detalhado no upload do som:",s),n.error(`Erro ao salvar som: ${s.message}`)}}),te=()=>{g&&D.mutate(g)},K=!!(a!=null&&a.notification_sound_url),ne=i.useMemo(()=>C===null||E===null?"map-settings-null":`map-settings-${C.toFixed(6)}-${E.toFixed(6)}`,[C,E]);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(P,{children:[e.jsx(q,{children:e.jsx(T,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(I,{children:[N&&e.jsx(ye,{className:"h-96 w-full"}),B&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",Y.message]}),!r&&!N&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),a&&!B&&!N&&e.jsx(ve,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(s=>U.mutate(s)),className:"space-y-6",children:[e.jsx(d,{control:o.control,name:"name",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Nome do Restaurante *"}),e.jsx(h,{children:e.jsx(x,{...s})}),e.jsx(p,{})]})}),e.jsx(d,{control:o.control,name:"description",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Descrição"}),e.jsx(h,{children:e.jsx(ge,{...s,rows:3})}),e.jsx(p,{})]})}),e.jsx(d,{control:o.control,name:"logo_url",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"URL do Logo"}),e.jsx(h,{children:e.jsx(x,{...s})}),e.jsx(p,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{placeholder:"Digite o CEP",value:w,onChange:s=>v(s.target.value)}),e.jsx(x,{placeholder:"Número",value:y,onChange:s=>_(s.target.value)}),e.jsx($,{type:"button",onClick:ae,disabled:V,children:V?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx($e,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(d,{control:o.control,name:"street",render:({field:s})=>e.jsxs(u,{className:"md:col-span-2",children:[e.jsx(m,{children:"Rua"}),e.jsx(h,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(p,{})]})}),e.jsx(d,{control:o.control,name:"number",render:({field:s})=>e.jsxs(u,{className:"md:col-span-1",children:[e.jsx(m,{children:"Número"}),e.jsx(h,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(p,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:o.control,name:"neighborhood",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Bairro"}),e.jsx(h,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(p,{})]})}),e.jsx(d,{control:o.control,name:"city",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Cidade"}),e.jsx(h,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(p,{})]})})]}),e.jsx(d,{control:o.control,name:"zip_code",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"CEP"}),e.jsx(h,{children:e.jsx(A,{...s,disabled:!0})}),e.jsx(p,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:F&&e.jsx(Pe,{mapKey:ne,markerPosition:se,onLocationChange:re,updateAddressFields:oe,restaurant:a})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:o.control,name:"latitude",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Latitude"}),e.jsx(h,{children:e.jsx(x,{...s,placeholder:"-22.7627908",value:s.value??""})}),e.jsx(p,{})]})}),e.jsx(d,{control:o.control,name:"longitude",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Longitude"}),e.jsx(h,{children:e.jsx(x,{...s,placeholder:"-47.408315",value:s.value??""})}),e.jsx(p,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Telefone"}),e.jsx(h,{children:e.jsx(x,{...s})}),e.jsx(p,{})]})}),e.jsx(d,{control:o.control,name:"email",render:({field:s})=>e.jsxs(u,{children:[e.jsx(m,{children:"Email"}),e.jsx(h,{children:e.jsx(x,{...s})}),e.jsx(p,{})]})})]}),e.jsx(d,{control:o.control,name:"is_active",render:({field:s})=>e.jsxs(u,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(m,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(h,{children:e.jsx(je,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx($,{type:"submit",className:"w-full h-12 text-lg",disabled:U.isPending||!r,children:U.isPending?"Salvando...":"Salvar Configurações"})]})})]})]}),e.jsxs(P,{children:[e.jsxs(q,{children:[e.jsxs(T,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ke,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(I,{className:"space-y-4",children:[K&&e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-green-50/50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ve,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Som Salvo: notification.mp3"})]}),e.jsxs($,{variant:"outline",size:"sm",onClick:t,children:[e.jsx(Le,{className:"h-4 w-4 mr-2"})," Testar"]})]}),!K&&!N&&e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-yellow-50/50 dark:bg-yellow-900/20",children:[e.jsx(Me,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Nenhum som de notificação configurado."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(Re,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(g==null?void 0:g.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:s=>{var c;return j(((c=s.target.files)==null?void 0:c[0])||null)}})]})]}),e.jsx($,{onClick:te,className:"w-full h-12 text-lg",disabled:!g||D.isPending||!r,children:D.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{ds as default};
