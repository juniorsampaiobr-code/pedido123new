import{b as ie,u as ce,c as P,j as e}from"./tanstack-D8i8yNxB.js";import{o as de,s as x,l as D,b as ue,p as A,c as B,u as me,t as he}from"./types-BCrSgEF3.js";import{s as E}from"./client-BmrnLCXS.js";import{B as V}from"./button-D6v_JVNl.js";import{C as I,b as Q,c as G,a as K}from"./card-AxKuBj5D.js";import{I as h,L as O}from"./label-CaADPPrM.js";import{T as pe}from"./textarea-pevFmROC.js";import{S as xe}from"./switch-BwgTEPRP.js";import{c as H,L as X,u as r}from"./index-rSjbHx8D.js";import{F as je,b as l,c as i,a as c,d,e as m}from"./form-DZ-WtIL3.js";import{S as ge}from"./skeleton-Dl0mWQUb.js";import{r as p}from"./vendor-Dl0Wzy4_.js";import{Z,L as fe}from"./ZipCodeInput-CAUoSimt.js";import{u as be}from"./use-sound-BBGoA6Ap.js";import{A as ve,a as ye,b as we}from"./alert-CGetQM82.js";import{C as Ne,a as Ce}from"./circle-x-D_qodMa1.js";import{V as Se}from"./volume-2-BUPp4Wbj.js";import{U as Ee}from"./upload-CvMhFbI8.js";import{M as Ve}from"./map-pin-BWJ4IsXA.js";import"./supabase-A1WgB1xz.js";import"./index-PuW-_iwo.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=H("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=H("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),Le=de({name:x().min(1,"O nome do restaurante é obrigatório."),description:x().optional(),logo_url:x().url("URL do logo inválida.").optional().or(D("")),street:x().optional(),number:x().optional(),neighborhood:x().optional(),city:x().optional(),zip_code:x().optional(),phone:x().optional(),email:x().email("Email inválido.").optional().or(D("")),is_active:ue().default(!0),latitude:A(t=>String(t).replace(",","."),B.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:A(t=>String(t).replace(",","."),B.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),Fe=async()=>{const{data:t,error:v}=await E.from("restaurants").select("*").limit(1).single();if(v)throw new Error(`Erro ao buscar dados do restaurante: ${v.message}`);if(!t)throw new Error("Nenhum restaurante encontrado.");return t},Me=({markerPosition:t,onLocationChange:v,updateAddressFields:j})=>{const[w,N]=p.useState(!1),b=t[0],g=t[1],_=p.useCallback(async(L,F)=>{N(!0);const $=r.loading("Buscando endereço para a nova localização...");try{const y=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${L}&lon=${F}&addressdetails=1`,o=await fetch(y);if(!o.ok)throw new Error("Falha ao obter detalhes do endereço.");const C=await o.json();C.address?(j(C.address),r.success("Endereço atualizado a partir do mapa.")):r.warning("Não foi possível encontrar um endereço para esta localização.")}catch(y){r.error(`Erro ao buscar endereço: ${y.message}`)}finally{N(!1),r.dismiss($)}},[j]);return e.jsxs("div",{className:"space-y-2 relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx(fe,{center:t,markerPosition:t,onLocationChange:v,isInteractive:!0}),e.jsx("div",{className:"absolute top-4 left-4 z-[401]",children:e.jsxs(V,{type:"button",onClick:()=>_(b,g),disabled:w,className:"shadow-lg bg-card text-foreground hover:bg-muted",children:[w?e.jsx(X,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(J,{className:"h-4 w-4 mr-2"}),"Buscar Endereço no Mapa"]})})]}),e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",b==null?void 0:b.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",g==null?void 0:g.toFixed(6)]})]}),e.jsxs(ve,{variant:"default",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx(ye,{children:"Ajuste a Localização"}),e.jsx(we,{children:'Arraste o pino vermelho para o local exato do seu restaurante e clique em "Buscar Endereço no Mapa" para atualizar os campos de endereço.'})]})]})},es=()=>{const t=ie(),{playSound:v}=be(),[j,w]=p.useState(null),[N,b]=p.useState(""),[g,_]=p.useState(""),[L,F]=p.useState(!1),[$,y]=p.useState(!1),{data:o,isLoading:C,isError:W,error:Y}=ce({queryKey:["restaurantSettings"],queryFn:Fe,staleTime:1e3*60*5}),a=me({resolver:he(Le),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});p.useEffect(()=>{o&&(a.reset({name:o.name||"",description:o.description||"",logo_url:o.logo_url||"",street:o.street||"",number:o.number||"",neighborhood:o.neighborhood||"",city:o.city||"",zip_code:o.zip_code||"",phone:o.phone||"",email:o.email||"",is_active:o.is_active??!0,latitude:o.latitude??null,longitude:o.longitude??null}),o.latitude&&o.longitude&&y(!0))},[o,a.reset]);const M=a.watch("latitude"),k=a.watch("longitude"),ee=[-23.55052,-46.633308],se=p.useMemo(()=>typeof M=="number"&&typeof k=="number"&&!isNaN(M)&&!isNaN(k)?[M,k]:ee,[M,k]),ae=p.useCallback(s=>{a.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),a.setValue("number",s.house_number||"",{shouldValidate:!0}),a.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),a.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),a.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0}),b((s.postcode||s.cep||"").replace(/\D/g,"")),_(s.house_number||"")},[a]),oe=async()=>{const s=N.replace(/\D/g,"");if(s.length!==8||!g){r.warning("Por favor, digite um CEP válido e o número da casa.");return}F(!0);const u=r.loading("Buscando endereço e coordenadas...");try{const f=await fetch(`https://viacep.com.br/ws/${s}/json/`);if(!f.ok)throw new Error("Falha na busca do CEP.");const n=await f.json();if(n.erro){r.error("CEP não encontrado.");return}a.setValue("street",n.logradouro,{shouldValidate:!0}),a.setValue("number",g,{shouldValidate:!0}),a.setValue("neighborhood",n.bairro,{shouldValidate:!0}),a.setValue("city",n.localidade,{shouldValidate:!0}),a.setValue("zip_code",n.cep,{shouldValidate:!0});const U=`${n.logradouro}, ${g}, ${n.localidade}, ${n.uf}`,S=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(U)}`,T=await(await fetch(S)).json();if(T.length>0){const{lat:ne,lon:le}=T[0];a.setValue("latitude",parseFloat(ne),{shouldValidate:!0}),a.setValue("longitude",parseFloat(le),{shouldValidate:!0}),y(!0),r.success("Endereço e mapa atualizados com sucesso!")}else r.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(f){r.error(`Erro na busca: ${f.message}`)}finally{F(!1),r.dismiss(u)}},re=p.useCallback((s,u)=>{a.setValue("latitude",s,{shouldValidate:!0}),a.setValue("longitude",u,{shouldValidate:!0})},[a]),q=P({mutationFn:async s=>{if(!(o!=null&&o.id))throw new Error("ID do restaurante não disponível.");const{id:u,...f}={...s,id:o.id},{error:n}=await E.from("restaurants").update(f).eq("id",u);if(n)throw n},onSuccess:()=>{r.success("Configurações salvas com sucesso!"),t.invalidateQueries({queryKey:["restaurantSettings"]})},onError:s=>r.error(`Erro ao salvar configurações: ${s.message}`)}),z=P({mutationFn:async s=>{if(!(o!=null&&o.id))throw new Error("ID do restaurante não disponível.");if(s.type!=="audio/mpeg"&&s.type!=="audio/mp3")throw new Error("O arquivo deve ser do tipo MP3.");const u=`${o.id}/notification.mp3`;console.log(`[Sound Upload] Attempting upload to settings/${u}`);const{error:f}=await E.storage.from("settings").upload(u,s,{upsert:!0,contentType:"audio/mpeg"});if(f)throw f;const{data:n}=E.storage.from("settings").getPublicUrl(u);if(!n.publicUrl)throw new Error("Falha ao obter a URL pública do arquivo.");const U=`${n.publicUrl}?t=${new Date().getTime()}`;console.log(`[DB Update] Updating restaurant ID: ${o.id} with URL: ${U}`);const{error:S}=await E.from("restaurants").update({notification_sound_url:U}).eq("id",o.id);if(S)throw console.error("[DB Update Error] Supabase Error:",S),new Error(`Falha ao salvar URL no banco de dados: ${S.message}`)},onSuccess:()=>{r.success("Som de notificação atualizado com sucesso!"),t.invalidateQueries({queryKey:["restaurantSettings"]}),w(null)},onError:s=>{console.error("Erro detalhado no upload do som:",s),r.error(`Erro ao salvar som: ${s.message}`)}}),te=()=>{j&&z.mutate(j)},R=!!(o!=null&&o.notification_sound_url);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(I,{children:[e.jsx(Q,{children:e.jsx(G,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(K,{children:C?e.jsx(ge,{className:"h-96 w-full"}):W?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",Y.message]}):e.jsx(je,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(s=>q.mutate(s)),className:"space-y-6",children:[e.jsx(l,{control:a.control,name:"name",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Nome do Restaurante *"}),e.jsx(d,{children:e.jsx(h,{...s})}),e.jsx(m,{})]})}),e.jsx(l,{control:a.control,name:"description",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Descrição"}),e.jsx(d,{children:e.jsx(pe,{...s,rows:3})}),e.jsx(m,{})]})}),e.jsx(l,{control:a.control,name:"logo_url",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"URL do Logo"}),e.jsx(d,{children:e.jsx(h,{...s})}),e.jsx(m,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{placeholder:"Digite o CEP",value:N,onChange:s=>b(s.target.value)}),e.jsx(h,{placeholder:"Número",value:g,onChange:s=>_(s.target.value)}),e.jsx(V,{type:"button",onClick:oe,disabled:L,children:L?e.jsx(X,{className:"h-4 w-4 animate-spin"}):e.jsx(J,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{control:a.control,name:"street",render:({field:s})=>e.jsxs(i,{className:"md:col-span-2",children:[e.jsx(c,{children:"Rua"}),e.jsx(d,{children:e.jsx(h,{...s,disabled:!0})}),e.jsx(m,{})]})}),e.jsx(l,{control:a.control,name:"number",render:({field:s})=>e.jsxs(i,{className:"md:col-span-1",children:[e.jsx(c,{children:"Número"}),e.jsx(d,{children:e.jsx(h,{...s,disabled:!0})}),e.jsx(m,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"neighborhood",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Bairro"}),e.jsx(d,{children:e.jsx(h,{...s,disabled:!0})}),e.jsx(m,{})]})}),e.jsx(l,{control:a.control,name:"city",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Cidade"}),e.jsx(d,{children:e.jsx(h,{...s,disabled:!0})}),e.jsx(m,{})]})})]}),e.jsx(l,{control:a.control,name:"zip_code",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"CEP"}),e.jsx(d,{children:e.jsx(Z,{...s,disabled:!0})}),e.jsx(m,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:$&&e.jsx(Me,{markerPosition:se,onLocationChange:re,updateAddressFields:ae})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"latitude",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Latitude"}),e.jsx(d,{children:e.jsx(h,{...s,placeholder:"-22.7627908",value:s.value??""})}),e.jsx(m,{})]})}),e.jsx(l,{control:a.control,name:"longitude",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Longitude"}),e.jsx(d,{children:e.jsx(h,{...s,placeholder:"-47.408315",value:s.value??""})}),e.jsx(m,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"phone",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Telefone"}),e.jsx(d,{children:e.jsx(h,{...s})}),e.jsx(m,{})]})}),e.jsx(l,{control:a.control,name:"email",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Email"}),e.jsx(d,{children:e.jsx(h,{...s})}),e.jsx(m,{})]})})]}),e.jsx(l,{control:a.control,name:"is_active",render:({field:s})=>e.jsxs(i,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(c,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(d,{children:e.jsx(xe,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx(V,{type:"submit",className:"w-full h-12 text-lg",disabled:q.isPending,children:q.isPending?"Salvando...":"Salvar Configurações"})]})})})]}),e.jsxs(I,{children:[e.jsxs(Q,{children:[e.jsxs(G,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(_e,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(K,{className:"space-y-4",children:[R&&e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-green-50/50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ne,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Som Salvo: notification.mp3"})]}),e.jsxs(V,{variant:"outline",size:"sm",onClick:v,children:[e.jsx(Se,{className:"h-4 w-4 mr-2"})," Testar"]})]}),!R&&!C&&e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-yellow-50/50 dark:bg-yellow-900/20",children:[e.jsx(Ce,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Nenhum som de notificação configurado."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(Ee,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(j==null?void 0:j.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:s=>{var u;return w(((u=s.target.files)==null?void 0:u[0])||null)}})]})]}),e.jsx(V,{onClick:te,className:"w-full h-12 text-lg",disabled:!j||z.isPending,children:z.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{es as default};
