import{j as e,u as Y,a as ee,b as re}from"./tanstack-b27kfv6r.js";import{o as se,s as x,l as oe,e as ae,p as q,c as k,u as te,t as ne}from"./types-Z9mbP6pS.js";import{s as w}from"./client-CNbeM-CQ.js";import{B as ie}from"./button-DyiApUNa.js";import{C as B,a as O,b as G,d as Z}from"./card-DW0FxMx9.js";import{I as g,L as le}from"./label-DewyFIm5.js";import{T as ce}from"./textarea-CfN7ksCI.js";import{S as de}from"./switch-JL8BZL1w.js";import{c as me,u as y,a as ue}from"./index-Br5M4KeF.js";import{F as he,a as l,b as c,e as d,c as m,d as p}from"./form-lOr0BRe5.js";import{S as pe}from"./skeleton-CwDwFmoR.js";import{R as xe,r as n,b as ge}from"./vendor-CrUvlFU9.js";import{M as je,P as fe}from"./PhoneInput-3ILgWYGM.js";import{L as be,g as ye}from"./location-BeVT-LYg.js";import{M as Ne}from"./map-pin-D74bFWm9.js";import{P as ve}from"./phone-DMEw4fjn.js";import"./supabase-hDq9CU0q.js";import"./index-DQCYbIBI.js";const we=o=>{let s=o.replace(/\D/g,"");return s.length>8&&(s=s.slice(0,8)),s.length>5&&(s=`${s.slice(0,5)}-${s.slice(5)}`),s},Q=xe.forwardRef(({className:o,value:s,onChange:i,...v},S)=>{const _=u=>{const C=u.target.value,N=we(C),E={...u,target:{...u.target,value:N}};i(E)};return e.jsx(g,{ref:S,type:"tel",className:me("w-full",o),placeholder:"00000-000",value:s,onChange:_,maxLength:9,...v})});Q.displayName="ZipCodeInput";const Ce=({markerPosition:o,onLocationChange:s,restaurant:i})=>{const v=n.useMemo(()=>[i.street,i.number,i.neighborhood,i.city,i.zip_code].filter(Boolean).join(", "),[i]);return e.jsxs(B,{className:"mt-6",children:[e.jsx(O,{children:e.jsxs(G,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(Z,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(be,{center:o,markerPosition:o,onMarkerDragEnd:s,zoom:15})}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[100%] truncate",children:["Endereço atual: ",v||"N/A"]})})]})]})},Ee=n.memo(Ce),$e=o=>o.replace(/\D/g,""),Se=o=>{if(!o)return"";let s=o.replace(/\D/g,"");return s.length>11&&(s=s.slice(0,11)),s.length>0&&(s=`(${s}`),s.length>3&&(s=`${s.slice(0,3)}) ${s.slice(3)}`),s.length>10&&(s=`${s.slice(0,10)}-${s.slice(10)}`),s},_e=se({name:x().min(1,"O nome do restaurante é obrigatório."),description:x().optional(),street:x().min(1,"A rua é obrigatória."),number:x().min(1,"O número é obrigatório."),neighborhood:x().min(1,"O bairro é obrigatório."),city:x().min(1,"A cidade é obrigatória."),zip_code:x().min(1,"O CEP é obrigatório.").transform(o=>o.replace(/\D/g,"")).refine(o=>o.length===8,{message:"O CEP deve ter 8 dígitos."}),phone:x().min(1,"Telefone é obrigatório.").transform($e).refine(o=>o.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:x().email("Email inválido.").optional().or(oe("")),is_active:ae().default(!0),latitude:q(o=>String(o).replace(",","."),k.number({invalid_type_error:"Latitude deve ser um número."}).refine(o=>o!==null,{message:"A localização no mapa é obrigatória. Mova o pino no mapa para definir a localização."})),longitude:q(o=>String(o).replace(",","."),k.number({invalid_type_error:"Longitude deve ser um número."}).refine(o=>o!==null,{message:"A localização no mapa é obrigatória. Mova o pino no pino para definir a localização."}))}),Me=async o=>{const{data:s,error:i}=await w.from("restaurants").select("*").eq("id",o).single();if(i)throw new Error(`Erro ao buscar dados do restaurante: ${i.message}`);if(!s)throw new Error("Nenhum restaurante encontrado.");return s},Ke=()=>{const o=Y(),{userRestaurantId:s}=ge(),[i,v]=n.useState(!1),[S,_]=n.useState(null),[u,C]=n.useState(!1),[N,E]=n.useState(null),{data:t,isLoading:M,isError:D,error:U}=ee({queryKey:["restaurantSettings",s],queryFn:()=>Me(s),enabled:!!s,staleTime:1e3*60*10});n.useEffect(()=>{w.auth.getSession().then(({data:{session:r}})=>{var h;_(((h=r==null?void 0:r.user)==null?void 0:h.email)||null)})},[]);const a=te({resolver:ne(_e),defaultValues:{name:"",description:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});n.useEffect(()=>{if(t){const r=t.zip_code||"",h=`${t.street||""}, ${t.number||""}, ${t.neighborhood||""}, ${t.city||""}, ${r}`;a.reset({name:t.name||"",description:t.description||"",street:t.street||"",number:t.number||"",neighborhood:t.neighborhood||"",city:t.city||"",zip_code:r,phone:Se(t.phone||""),email:t.email||"",is_active:t.is_active??!0,latitude:t.latitude??null,longitude:t.longitude??null}),E(h),t.latitude&&t.longitude&&v(!0)}},[t,a.reset]);const f=a.watch("latitude"),b=a.watch("longitude"),K=a.watch(["street","number","neighborhood","city","zip_code"]),[z,L,F,A,P]=K,$=n.useMemo(()=>{const r=P.replace(/\D/g,"");return!z||!L||!F||!A||r.length!==8?null:`${z}, ${L}, ${F}, ${A}, ${r}`},[z,L,F,A,P]),H=[-23.55052,-46.633308],J=n.useMemo(()=>typeof f=="number"&&typeof b=="number"&&!isNaN(f)&&!isNaN(b)?[f,b]:H,[f,b]),W=n.useCallback((r,h)=>{a.setValue("latitude",r,{shouldValidate:!0}),a.setValue("longitude",h,{shouldValidate:!0})},[a]),R=n.useCallback(async r=>{if(u||r===N)return;C(!0);const h=y.loading("Buscando coordenadas do endereço...");try{const j=await ye(r);j?(a.setValue("latitude",j.lat,{shouldValidate:!0}),a.setValue("longitude",j.lng,{shouldValidate:!0}),E(r),y.success("Localização do mapa atualizada!")):y.warning("Não foi possível encontrar o endereço no mapa. Verifique os campos.")}catch(j){console.error("Geocoding error:",j),y.error("Erro ao buscar coordenadas.")}finally{C(!1),y.dismiss(h)}},[u,N,a]);n.useEffect(()=>{if($&&$!==N){const r=setTimeout(()=>{R($)},500);return()=>{clearTimeout(r)}}},[$,N,R]);const T=re({mutationFn:async r=>{if(!s)throw new Error("ID do restaurante não disponível.");const h={name:r.name,description:r.description,logo_url:null,street:r.street,number:r.number,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code.replace(/\D/g,""),phone:r.phone,email:r.email,is_active:r.is_active,latitude:r.latitude,longitude:r.longitude,address:`${r.street}, ${r.number}, ${r.neighborhood}, ${r.city}, ${r.zip_code}`},{error:j}=await w.from("restaurants").update(h).eq("id",s);if(j)throw j;const{data:{user:V}}=await w.auth.getUser();if(V){const X={phone:r.phone},{error:I}=await w.from("profiles").update(X).eq("id",V.id);I&&console.warn("Falha ao sincronizar telefone com o perfil:",I.message)}},onSuccess:()=>{y.success("Configurações salvas com sucesso!"),o.invalidateQueries({queryKey:["restaurantSettings",s]}),o.invalidateQueries({queryKey:["adminProfile"]})},onError:r=>y.error(`Erro ao salvar configurações: ${r.message}`)});return n.useMemo(()=>f===null||b===null?"map-settings-null":`map-settings-${f.toFixed(6)}-${b.toFixed(6)}`,[f,b]),e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(B,{children:[e.jsx(O,{children:e.jsx(G,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(Z,{children:[M&&e.jsx(pe,{className:"h-96 w-full"}),D&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",U.message]}),!s&&!M&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),t&&!D&&!M&&e.jsx(he,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(r=>T.mutate(r)),className:"space-y-6",children:[e.jsx(l,{control:a.control,name:"name",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Nome do Restaurante *"}),e.jsx(m,{children:e.jsx(g,{...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"description",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Descrição"}),e.jsx(m,{children:e.jsx(ce,{...r,rows:3})}),e.jsx(p,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Contato e Status"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(le,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(je,{className:"h-4 w-4"}),"Email do Administrador"]}),e.jsx(g,{value:S||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este é o email de login do administrador."})]}),e.jsx(l,{control:a.control,name:"phone",render:({field:r})=>e.jsxs(c,{children:[e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4"}),"Telefone do Restaurante *"]}),e.jsx(m,{children:e.jsx(fe,{...r})}),e.jsx(p,{})]})})]}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{control:a.control,name:"street",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Rua *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Nome da rua",...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"number",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Número *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Número",...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"neighborhood",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Bairro *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Bairro",...r})}),e.jsx(p,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"city",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Cidade *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Cidade",...r})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"zip_code",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"CEP *"}),e.jsx(m,{children:e.jsx(Q,{placeholder:"00000-000",...r})}),e.jsx(p,{})]})})]}),e.jsx("div",{className:"pt-4 border-t",children:i&&e.jsx(Ee,{markerPosition:J,onLocationChange:W,restaurant:t})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"latitude",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Latitude *"}),e.jsx(m,{children:e.jsx(g,{...r,placeholder:"-22.7627908",value:r.value??"",disabled:u})}),e.jsx(p,{})]})}),e.jsx(l,{control:a.control,name:"longitude",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Longitude *"}),e.jsx(m,{children:e.jsx(g,{...r,placeholder:"-47.408315",value:r.value??"",disabled:u})}),e.jsx(p,{})]})})]}),e.jsx(l,{control:a.control,name:"is_active",render:({field:r})=>e.jsxs(c,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(d,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(m,{children:e.jsx(de,{checked:r.value,onCheckedChange:r.onChange})})]})}),e.jsx(ie,{type:"submit",className:"w-full h-12 text-lg",disabled:T.isPending||!s||u,children:T.isPending||u?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):"Salvar Configurações"})]})})]})]})})})};export{Ke as default};
