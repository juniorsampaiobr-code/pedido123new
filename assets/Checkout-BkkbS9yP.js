import{j as e,b as Sr,u as ie,c as Fr}from"./tanstack-DXzASLyu.js";import{r as u,R as Ue,u as Ir,L as kr}from"./vendor-YgypLURK.js";import{o as $r,s as I,l as Lr,e as Tr,c as Be,p as Ar,n as Mr,Z as J,u as Dr,t as qr}from"./types-CUwlEUMq.js";import{s as A}from"./client-lAKPhnc8.js";import{c as Br,g as Ze,h as Re,P as xe,j as Ce,i as zr,t as Or,m as Gr,b as ge,u as b,a as Kr,L as le}from"./index-C5EBezG9.js";import{B as ce}from"./button-CXaOdGmo.js";import{C as ue,b as me,c as pe,a as he}from"./card-d7GFr-Eb.js";import{I as $,L as Ne}from"./label-4WvQlS_r.js";import{c as Je,R as Ur,I as Zr}from"./index-J9gwA9dJ.js";import{u as Jr}from"./index-DvUVZ62n.js";import{u as Hr}from"./index-CUvv1sQ9.js";import{S as ze}from"./separator-D2lAj0aH.js";import{T as Qr}from"./textarea-BinMCxEp.js";import{A as ee,a as re,b as se}from"./alert-Cz3re39z.js";import{S as de}from"./skeleton-Y9LJbHce.js";import{F as Wr,b as E,c as j,a as w,e as M,d as z}from"./form-B_y1oQUT.js";import{Z as Oe,S as Xr,L as Yr}from"./ZipCodeInput-DSwsOYLm.js";import{T as Ge}from"./terminal-vOjtsRO-.js";import{A as es}from"./arrow-left-Cek84DQU.js";import{T as we}from"./truck-DWRxwDXN.js";import{S as He,a as rs}from"./store-DCF9zpxd.js";import{M as ss}from"./map-pin-CtwF8hzc.js";import{C as Qe}from"./credit-card-B-XqfADU.js";import{P as as}from"./package-BbVK1zbw.js";import{D as os}from"./dollar-sign-BRbfdvxy.js";import"./supabase-Bm28tI2t.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=Br("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);var _e="Radio",[ns,We]=Ze(_e),[is,ls]=ns(_e),Xe=u.forwardRef((a,r)=>{const{__scopeRadio:t,name:d,checked:i=!1,required:c,disabled:l,value:h="on",onCheck:y,form:v,..._}=a,[C,k]=u.useState(null),x=Re(r,R=>k(R)),g=u.useRef(!1),D=C?v||!!C.closest("form"):!0;return e.jsxs(is,{scope:t,checked:i,disabled:l,children:[e.jsx(xe.button,{type:"button",role:"radio","aria-checked":i,"data-state":sr(i),"data-disabled":l?"":void 0,disabled:l,value:h,..._,ref:x,onClick:Ce(a.onClick,R=>{i||y==null||y(),D&&(g.current=R.isPropagationStopped(),g.current||R.stopPropagation())})}),D&&e.jsx(rr,{control:C,bubbles:!g.current,name:d,value:h,checked:i,required:c,disabled:l,form:v,style:{transform:"translateX(-100%)"}})]})});Xe.displayName=_e;var Ye="RadioIndicator",er=u.forwardRef((a,r)=>{const{__scopeRadio:t,forceMount:d,...i}=a,c=ls(Ye,t);return e.jsx(zr,{present:d||c.checked,children:e.jsx(xe.span,{"data-state":sr(c.checked),"data-disabled":c.disabled?"":void 0,...i,ref:r})})});er.displayName=Ye;var cs="RadioBubbleInput",rr=u.forwardRef(({__scopeRadio:a,control:r,checked:t,bubbles:d=!0,...i},c)=>{const l=u.useRef(null),h=Re(l,c),y=Hr(t),v=Or(r);return u.useEffect(()=>{const _=l.current;if(!_)return;const C=window.HTMLInputElement.prototype,x=Object.getOwnPropertyDescriptor(C,"checked").set;if(y!==t&&x){const g=new Event("click",{bubbles:d});x.call(_,t),_.dispatchEvent(g)}},[y,t,d]),e.jsx(xe.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...i,tabIndex:-1,ref:h,style:{...i.style,...v,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});rr.displayName=cs;function sr(a){return a?"checked":"unchecked"}var ds=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],je="RadioGroup",[us,ea]=Ze(je,[Je,We]),ar=Je(),or=We(),[ms,ps]=us(je),tr=u.forwardRef((a,r)=>{const{__scopeRadioGroup:t,name:d,defaultValue:i,value:c,required:l=!1,disabled:h=!1,orientation:y,dir:v,loop:_=!0,onValueChange:C,...k}=a,x=ar(t),g=Jr(v),[D,R]=Gr({prop:c,defaultProp:i??null,onChange:C,caller:je});return e.jsx(ms,{scope:t,name:d,required:l,disabled:h,value:D,onValueChange:R,children:e.jsx(Ur,{asChild:!0,...x,orientation:y,dir:g,loop:_,children:e.jsx(xe.div,{role:"radiogroup","aria-required":l,"aria-orientation":y,"data-disabled":h?"":void 0,dir:g,...k,ref:r})})})});tr.displayName=je;var nr="RadioGroupItem",ir=u.forwardRef((a,r)=>{const{__scopeRadioGroup:t,disabled:d,...i}=a,c=ps(nr,t),l=c.disabled||d,h=ar(t),y=or(t),v=u.useRef(null),_=Re(r,v),C=c.value===i.value,k=u.useRef(!1);return u.useEffect(()=>{const x=D=>{ds.includes(D.key)&&(k.current=!0)},g=()=>k.current=!1;return document.addEventListener("keydown",x),document.addEventListener("keyup",g),()=>{document.removeEventListener("keydown",x),document.removeEventListener("keyup",g)}},[]),e.jsx(Zr,{asChild:!0,...h,focusable:!l,active:C,children:e.jsx(Xe,{disabled:l,required:c.required,checked:C,...y,...i,name:c.name,ref:_,onCheck:()=>c.onValueChange(i.value),onKeyDown:Ce(x=>{x.key==="Enter"&&x.preventDefault()}),onFocus:Ce(i.onFocus,()=>{var x;k.current&&((x=v.current)==null||x.click())})})})});ir.displayName=nr;var hs="RadioGroupIndicator",lr=u.forwardRef((a,r)=>{const{__scopeRadioGroup:t,...d}=a,i=or(t);return e.jsx(er,{...i,...d,ref:r})});lr.displayName=hs;var cr=tr,dr=ir,fs=lr;const fe=u.forwardRef(({className:a,...r},t)=>e.jsx(cr,{className:ge("grid gap-2",a),...r,ref:t}));fe.displayName=cr.displayName;const H=u.forwardRef(({className:a,...r},t)=>e.jsx(dr,{ref:t,className:ge("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),...r,children:e.jsx(fs,{className:"flex items-center justify-center",children:e.jsx(ts,{className:"h-2.5 w-2.5 fill-current text-current"})})}));H.displayName=dr.displayName;const xs=a=>{let r=a.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},ur=Ue.forwardRef(({className:a,value:r,onChange:t,...d},i)=>{const c=l=>{const h=l.target.value,y=xs(h),v={...l,target:{...l.target,value:y}};t(v)};return e.jsx($,{ref:i,type:"tel",className:ge("w-full",a),placeholder:"(99) 99999-9999",value:r,onChange:c,...d})});ur.displayName="PhoneInput";const gs=a=>{let r=a.replace(/\D/g,"");return r.length>14&&(r=r.slice(0,14)),r.length<=11?(r.length>9&&(r=`${r.slice(0,9)}-${r.slice(9)}`),r.length>6&&(r=`${r.slice(0,6)}.${r.slice(6)}`),r.length>3&&(r=`${r.slice(0,3)}.${r.slice(3)}`),r):(r.length>12&&(r=`${r.slice(0,12)}-${r.slice(12)}`),r.length>8&&(r=`${r.slice(0,8)}/${r.slice(8)}`),r.length>5&&(r=`${r.slice(0,5)}.${r.slice(5)}`),r.length>2&&(r=`${r.slice(0,2)}.${r.slice(2)}`),r)},mr=Ue.forwardRef(({className:a,value:r,onChange:t,...d},i)=>{const c=l=>{const h=l.target.value,y=gs(h),v={...l,target:{...l.target,value:y}};t(v)};return e.jsx($,{ref:i,type:"tel",className:ge("w-full",a),placeholder:"CPF ou CNPJ",value:r,onChange:c,maxLength:18,...d})});mr.displayName="CpfCnpjInput";const js=(a,r,t,d)=>{const c=(t-a)*(Math.PI/180),l=(d-r)*(Math.PI/180),h=Math.sin(c/2)*Math.sin(c/2)+Math.cos(a*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))},Ke=async a=>{const r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`;try{const t=await fetch(r);if(!t.ok)throw new Error("Falha na API de geocodificação.");const d=await t.json();if(d&&d.length>0){const i=parseFloat(d[0].lat),c=parseFloat(d[0].lon);if(!isNaN(i)&&!isNaN(c))return[i,c]}return console.warn("Geocodificação falhou para o endereço:",a,"Usando coordenadas padrão."),null}catch(t){return console.error("Erro durante a geocodificação:",t),b.error("Erro ao buscar coordenadas do endereço. Verifique o endereço."),null}},ys=(a,r,t)=>{const d=js(r[0],r[1],a[0],a[1]),i=t.find(c=>d<=c.max_distance_km);if(i){const c=i.delivery_fee||0,l=i.min_delivery_time_minutes||0,h=l+15;return{fee:parseFloat(c.toFixed(2)),minTime:l,maxTime:h}}return null},pr=a=>a.replace(/\D/g,""),Ee=a=>a.replace(/\D/g,""),vs=a=>a.replace(/\D/g,""),bs=$r({name:I().min(1,"Nome é obrigatório."),phone:I().min(1,"Telefone é obrigatório.").transform(pr).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:I().email("Email inválido.").optional().or(Lr("")),delivery_option:Tr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:I().optional().default(""),number:I().optional().default(""),complement:I().optional().default(""),neighborhood:I().optional().default(""),city:I().optional().default(""),zip_code:I().optional().default("").transform(Ee).refine(a=>a.length===8||a.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Be.number().optional().nullable(),longitude:Be.number().optional().nullable(),payment_method_id:I().min(1,"Selecione uma forma de pagamento."),notes:I().optional(),cpf_cnpj:I().optional().default("").transform(vs).refine(a=>a.length===0||a.length===11||a.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ar(a=>a==null||a===""?null:String(a).replace(",","."),Mr({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((a,r)=>{a.delivery_option==="delivery"&&(a.street.trim()===""&&r.addIssue({code:J.custom,message:"Rua é obrigatória.",path:["street"]}),a.number.trim()===""&&r.addIssue({code:J.custom,message:"Número é obrigatório.",path:["number"]}),a.neighborhood.trim()===""&&r.addIssue({code:J.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),a.city.trim()===""&&r.addIssue({code:J.custom,message:"Cidade é obrigatória.",path:["city"]}),a.zip_code.length!==8&&r.addIssue({code:J.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]})),a.payment_method_id==="Dinheiro"&&a.change_for!==null&&a.change_for!==void 0&&a.change_for<=0&&r.addIssue({code:J.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]})}),Ns=async()=>{const{data:a,error:r}=await A.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!a)throw new Error("Nenhum restaurante ativo encontrado.");return a},ws=async a=>{const{data:r,error:t}=await A.from("restaurants").select("delivery_enabled").eq("id",a).single();if(t)throw new Error(`Erro ao buscar status de entrega: ${t.message}`);return r.delivery_enabled??!0},Cs=async a=>{const{data:r,error:t}=await A.from("payment_methods").select("*").eq("restaurant_id",a).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return r},Es=async a=>{const{data:r,error:t}=await A.from("delivery_zones").select("*").eq("restaurant_id",a).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return r},Rs=a=>{switch(a){case"DollarSign":return os;case"Smartphone":return rs;case"CreditCard":return Qe;case"Package":return as;default:return He}},_s=({subtotal:a,deliveryFee:r,total:t,items:d})=>e.jsxs(ue,{className:"sticky top-4",children:[e.jsx(me,{children:e.jsx(pe,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(he,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:d.map(i=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[i.quantity,"x ",i.name,i.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",i.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i.price*i.quantity)})]},i.id))}),e.jsx(ze,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:r>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r):"Grátis"})]})]}),e.jsx(ze,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]})]})]}),ra=()=>{const a=Ir(),r=Sr(),t=Kr(),{items:d,subtotal:i,deliveryFee:c,total:l,setDeliveryFee:h,clearCart:y}=t,[v,_]=u.useState(!1),[C,k]=u.useState(!1),[x,g]=u.useState(null),[D,R]=u.useState(null),[Pe,Ve]=u.useState(""),[Q,Se]=u.useState(""),[Fe,Ie]=u.useState(!1),[hr,W]=u.useState(!1),[P,fr]=u.useState("search"),{data:n,isLoading:xr,isError:gr,error:jr}=ie({queryKey:["checkoutRestaurantData"],queryFn:Ns}),{data:ye=!0,isLoading:yr}=ie({queryKey:["deliveryStatus",n==null?void 0:n.id],queryFn:()=>ws(n.id),enabled:!!(n!=null&&n.id),initialData:!0}),{data:O=[],isLoading:vr}=ie({queryKey:["checkoutPaymentMethods",n==null?void 0:n.id],queryFn:()=>Cs(n.id),enabled:!!(n!=null&&n.id)}),{data:ke=[],isLoading:br}=ie({queryKey:["checkoutDeliveryZones",n==null?void 0:n.id],queryFn:()=>Es(n.id),enabled:!!(n!=null&&n.id)}),Nr=xr||yr||vr||br,wr=gr,$e=jr,o=Dr({resolver:qr(bs),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),X=o.watch("delivery_option"),ve=o.watch("payment_method_id"),G=O.find(s=>s.id===ve),ae=(G==null?void 0:G.name)==="Pagamento online: Pix/Cartão",oe=(G==null?void 0:G.name)==="Dinheiro",V=o.watch("latitude"),S=o.watch("longitude"),te=o.watch(["street","number","complement","neighborhood","city","zip_code"]),K=X==="delivery",Cr=JSON.stringify({mode:P,fields:te,lat:V,lng:S,deliveryOption:X}),Le=u.useMemo(()=>typeof V=="number"&&typeof S=="number"&&!isNaN(V)&&!isNaN(S)?[V,S]:n!=null&&n.latitude&&(n!=null&&n.longitude)?[n.latitude,n.longitude]:[-23.55052,-46.633308],[V,S,n]),Te=u.useCallback(s=>{o.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),o.setValue("number",s.house_number||Q||"",{shouldValidate:!0}),o.setValue("complement",s.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),o.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[o,Q]),Er=async()=>{const s=Pe.replace(/\D/g,"");if(s.length!==8){b.warning("Por favor, digite um CEP válido.");return}Ie(!0);const m=b.loading("Buscando endereço...");try{const p=await fetch(`https://viacep.com.br/ws/${s}/json/`);if(!p.ok)throw new Error("Falha na busca do CEP.");const f=await p.json();if(f.erro){b.error("CEP não encontrado.");return}o.setValue("street",f.logradouro,{shouldValidate:!0}),o.setValue("number",Q,{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood",f.bairro,{shouldValidate:!0}),o.setValue("city",f.localidade,{shouldValidate:!0}),o.setValue("zip_code",f.cep,{shouldValidate:!0});const N=`${f.logradouro}, ${Q||"1"}, ${f.localidade}, ${f.uf}`,F=await Ke(N);F?(o.setValue("latitude",F[0],{shouldValidate:!0}),o.setValue("longitude",F[1],{shouldValidate:!0}),W(!0),b.success("Endereço encontrado e mapa atualizado!")):(o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),b.warning("Endereço encontrado, mas não foi possível obter as coordenadas. Ajuste o pino no mapa manualmente."))}catch(p){b.error(`Erro na busca: ${p.message}`)}finally{Ie(!1),b.dismiss(m)}},Rr=u.useCallback(async(s,m)=>{o.setValue("latitude",s,{shouldValidate:!0}),o.setValue("longitude",m,{shouldValidate:!0});const p=b.loading("Atualizando endereço...");try{const f=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${m}&addressdetails=1`,N=await fetch(f);if(!N.ok)throw new Error("Falha ao obter detalhes do endereço.");const F=await N.json();F.address&&(Te(F.address),b.success("Endereço atualizado a partir do mapa."))}catch(f){b.error(`Erro ao buscar endereço: ${f.message}`)}finally{b.dismiss(p)}},[o,Te]);u.useEffect(()=>{oe||o.setValue("change_for",null,{shouldValidate:!0})},[oe,o]),u.useEffect(()=>{X==="pickup"&&(h(0),g(null),R(null),o.setValue("latitude",null),o.setValue("longitude",null),W(!1)),K&&(o.setValue("latitude",null),o.setValue("longitude",null),W(!1),P==="manual"&&(Ve(""),Se("")),P==="search"&&(o.setValue("street",""),o.setValue("number",""),o.setValue("complement",""),o.setValue("neighborhood",""),o.setValue("city",""),o.setValue("zip_code","")))},[X,P,K,o,h]),u.useEffect(()=>{O.length>0&&!ve&&o.setValue("payment_method_id",O[0].id)},[O,ve,o]),u.useEffect(()=>{const s=async()=>{if(!ye){h(0),g(null),R(null);return}if(X==="pickup"||!(n!=null&&n.latitude)||!(n!=null&&n.longitude)){h(0),g(null),R(null);return}k(!0),g(null);let p=null;if(V&&S)p=[V,S];else{const[f,N,F,U,Z,q]=te,B=Ee(q);if(f&&N&&U&&Z&&B.length===8){const ne=`${f}, ${N} ${F}, ${U}, ${Z}, ${q}`;p=await Ke(ne),p&&(o.setValue("latitude",p[0]),o.setValue("longitude",p[1]),W(!0))}}if(p){const f=[n.latitude,n.longitude],N=ys(p,f,ke);N?(h(N.fee),g(null),R({minTime:N.minTime,maxTime:N.maxTime})):(h(0),g("Seu endereço está fora da nossa área de entrega."),R(null))}else{h(0),R(null);const[f,N,F,U,Z,q]=te,B=f&&N&&U&&Z&&Ee(q).length===8;K&&B?(g("Não foi possível localizar seu endereço para calcular a taxa. Por favor, verifique o endereço ou ajuste o pino no mapa."),n!=null&&n.latitude&&(n!=null&&n.longitude)&&(o.setValue("latitude",n.latitude),o.setValue("longitude",n.longitude),W(!0))):g(null)}k(!1)},m=setTimeout(()=>{s()},500);return()=>clearTimeout(m)},[Cr,n,ke,o,h,K,V,S,P,te,ye]),u.useEffect(()=>{if(d.length===0&&!v){const s=setTimeout(()=>{b.info("Seu carrinho está vazio. Adicione itens para continuar."),a("/menu")},0);return()=>clearTimeout(s)}},[d.length,a,v]);const Ae=Fr({mutationFn:async s=>{if(!n)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&x)throw new Error(x);const m=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),p=s.delivery_option==="delivery"?m:"Retirada no Local";let f;const N=pr(s.phone),{data:F}=await A.from("customers").select("id").eq("phone",N).limit(1).single();if(F)f=F.id;else{const{data:L,error:Y}=await A.from("customers").insert({name:s.name,phone:N,email:s.email||null,address:p,latitude:s.latitude,longitude:s.longitude}).select("id").single();if(Y)throw new Error(`Erro ao criar cliente: ${Y.message}`);f=L.id}const U=ae?"pending_payment":"pending",{data:Z,error:q}=await A.from("orders").insert({restaurant_id:n.id,customer_id:f,status:U,total_amount:l,delivery_fee:c,notes:s.notes,delivery_address:p}).select("id").single();if(q)throw new Error(`Erro ao criar pedido: ${q.message}`);const B=Z.id,De=d.map(L=>({order_id:B,product_id:L.product_id,quantity:L.quantity,unit_price:L.price,subtotal:L.price*L.quantity,notes:L.notes})),{error:ne}=await A.from("order_items").insert(De);if(ne)throw new Error(`Erro ao adicionar itens do pedido: ${ne.message}`);if(ae){_(!0),b.info("Redirecionando para o pagamento online...");const L=window.location.origin,Y={orderId:B,items:d,totalAmount:parseFloat(l.toFixed(2)),restaurantName:n.name,clientUrl:L};console.log("Payload enviado para create-payment-preference:",Y);try{const{data:T,error:qe}=await A.functions.invoke("create-payment-preference",{body:Y});if(qe)throw new Error(qe.message);if(T&&T.error)throw new Error(`Mercado Pago Error: ${T.error}`);if(T&&T.init_point){window.location.href=T.init_point;return}else throw new Error("Resposta de pagamento inválida: init_point não encontrado.")}catch(T){throw console.error("Erro ao criar preferência de pagamento:",T),new Error(`Falha ao processar pagamento online: ${T.message}`)}}return B},onSuccess:s=>{ae||(b.success(`Pedido #${s.slice(-4)} realizado com sucesso!`),r.invalidateQueries({queryKey:["orders"]}),y(),a(`/order-success/${s}`))},onError:s=>{let m="Ocorreu um erro ao finalizar seu pedido. Por favor, tente novamente.";const p=s.message||"";p.toLowerCase().includes("access token")||p.toLowerCase().includes("credentials")?m="Ocorreu um problema com a configuração de pagamento do restaurante. Por favor, entre em contato com o estabelecimento.":p.toLowerCase().includes("mercado pago error")?m=`O Mercado Pago retornou um erro: ${p.split("Mercado Pago Error:")[1]||"Tente novamente."}`:p.toLowerCase().includes("fora da nossa área de entrega")?m="Seu endereço está fora da nossa área de entrega.":p.toLowerCase().includes("falha ao processar pagamento online")&&(m=p.split("Falha ao processar pagamento online:")[1]||"Erro ao processar pagamento online. Por favor, tente novamente."),b.error("Falha ao processar o pagamento",{description:m,duration:1e4}),_(!1)}}),_r=s=>{if(oe){const m=s.change_for;if(m!=null&&m<l){b.error(`O valor do troco (R$ ${m.toFixed(2).replace(".",",")}) deve ser maior ou igual ao total do pedido (R$ ${l.toFixed(2).replace(".",",")}).`);return}}Ae.mutate(s)},Pr=s=>{Object.keys(s).length>0&&b.error("Por favor, preencha todos os campos obrigatórios e corrija os erros.")};if(d.length===0&&!v)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."});if(Nr)return e.jsxs("div",{className:"container mx-auto p-4 max-w-6xl",children:[e.jsx(de,{className:"h-10 w-48 mb-6"}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(de,{className:"h-64 w-full"}),e.jsx(de,{className:"h-64 w-full"})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(de,{className:"h-96 w-full sticky top-4"})})]})]});if(wr)return e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(ee,{variant:"destructive",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro de Conexão"}),e.jsx(se,{children:$e instanceof Error?$e.message:"Não foi possível carregar os dados."})]})});const be=Ae.isPending||v||C,Vr=!K||!x&&c>=0,Me=!be&&Vr;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(kr,{to:"/menu",children:e.jsx(ce,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(es,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8 max-w-6xl",children:e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(Wr,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(_r,Pr),className:"space-y-6",children:[e.jsxs(ue,{children:[e.jsx(me,{children:e.jsx(pe,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(he,{className:"space-y-4",children:[e.jsx(E,{control:o.control,name:"name",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Nome Completo *"}),e.jsx($,{placeholder:"Seu nome",...s}),e.jsx(M,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(E,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Telefone *"}),e.jsx(ur,{...s}),e.jsx(M,{})]})}),e.jsx(E,{control:o.control,name:"email",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Email (Opcional)"}),e.jsx($,{placeholder:"seu@email.com",...s}),e.jsx(M,{})]})})]})]})]}),e.jsxs(ue,{children:[e.jsx(me,{children:e.jsx(pe,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(he,{className:"space-y-4",children:[e.jsx(E,{control:o.control,name:"delivery_option",render:({field:s})=>e.jsxs(j,{className:"space-y-3",children:[e.jsx(z,{children:e.jsxs(fe,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(z,{children:e.jsx(H,{value:"delivery"})}),e.jsx(we,{className:"h-5 w-5 text-primary"}),e.jsx(w,{className:"font-normal flex-1 cursor-pointer",children:"Delivery"})]}),e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(z,{children:e.jsx(H,{value:"pickup"})}),e.jsx(He,{className:"h-5 w-5 text-primary"}),e.jsx(w,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(M,{})]})}),K&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(ss,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs(fe,{value:P,onValueChange:s=>fr(s),className:"flex gap-4",children:[e.jsxs(j,{className:"flex items-center space-x-2",children:[e.jsx(z,{children:e.jsx(H,{value:"search",id:"r-search"})}),e.jsx(Ne,{htmlFor:"r-search",className:"cursor-pointer",children:"Buscar por CEP"})]}),e.jsxs(j,{className:"flex items-center space-x-2",children:[e.jsx(z,{children:e.jsx(H,{value:"manual",id:"r-manual"})}),e.jsx(Ne,{htmlFor:"r-manual",className:"cursor-pointer",children:"Digitar Manualmente"})]})]}),P==="search"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ne,{children:"Buscar Endereço por CEP e Número"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Oe,{placeholder:"Digite o CEP",value:Pe,onChange:s=>Ve(s.target.value)}),e.jsx($,{placeholder:"Número",value:Q,onChange:s=>Se(s.target.value)}),e.jsx(ce,{type:"button",onClick:Er,disabled:Fe,children:Fe?e.jsx(le,{className:"h-4 w-4 animate-spin"}):e.jsx(Xr,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(E,{control:o.control,name:"street",render:({field:s})=>e.jsxs(j,{className:"col-span-2",children:[e.jsx(w,{children:"Rua *"}),e.jsx($,{...s,disabled:P==="search"})]})}),e.jsx(E,{control:o.control,name:"number",render:({field:s})=>e.jsxs(j,{className:"col-span-1",children:[e.jsx(w,{children:"Número *"}),e.jsx($,{...s,disabled:P==="search"})]})})]}),e.jsx(E,{control:o.control,name:"complement",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Complemento (Opcional)"}),e.jsx($,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(E,{control:o.control,name:"neighborhood",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Bairro *"}),e.jsx($,{...s,disabled:P==="search"})]})}),e.jsx(E,{control:o.control,name:"city",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Cidade *"}),e.jsx($,{...s,disabled:P==="search"})]})})]}),e.jsx(E,{control:o.control,name:"zip_code",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"CEP *"}),e.jsx(Oe,{...s,disabled:P==="search"})]})}),hr&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Yr,{center:Le,markerPosition:Le,onLocationChange:Rr,isInteractive:!1}),V!==null&&S!==null&&e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",V==null?void 0:V.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",S==null?void 0:S.toFixed(6)]})]})]}),C&&e.jsxs(ee,{children:[e.jsx(le,{className:"h-4 w-4 animate-spin"}),e.jsx(re,{children:"Calculando Taxa..."}),e.jsx(se,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),x&&e.jsxs(ee,{variant:"destructive",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro de Entrega"}),e.jsx(se,{children:x})]}),c>0&&!C&&e.jsxs(ee,{className:"mt-4",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(re,{children:"Taxa de Entrega Aplicada"}),e.jsxs(se,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)]})]}),!ye&&e.jsxs(ee,{className:"mt-4",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(re,{children:"Taxas de Entrega Desativadas"}),e.jsx(se,{children:"No momento, as taxas de entrega estão desativadas. A entrega será gratuita."})]})]})]})]}),e.jsxs(ue,{children:[e.jsx(me,{children:e.jsx(pe,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(he,{className:"space-y-4",children:[e.jsx(E,{control:o.control,name:"payment_method_id",render:({field:s})=>e.jsxs(j,{className:"space-y-3",children:[e.jsx(z,{children:e.jsx(fe,{onValueChange:m=>{s.onChange(m);const p=O.find(f=>f.id===m);(p==null?void 0:p.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0})},defaultValue:s.value,className:"flex flex-col space-y-2",children:O.map(m=>{const p=Rs(m.icon||"Store");return e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(z,{children:e.jsx(H,{value:m.id})}),e.jsx(p,{className:"h-5 w-5 text-primary"}),e.jsxs(w,{className:"font-normal flex-1 cursor-pointer",children:[m.name,e.jsx("span",{className:"block text-xs text-muted-foreground",children:m.description})]})]},m.id)})})}),e.jsx(M,{})]})}),ae&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4"})," Detalhes Adicionais"]}),e.jsx(E,{control:o.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"CPF/CNPJ (para o pagamento online)"}),e.jsx(mr,{...s}),e.jsx(M,{})]})})]}),oe&&e.jsx(E,{control:o.control,name:"change_for",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Precisa de troco para quanto? (R$)"}),e.jsx($,{type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2}).format(l),...s,value:s.value===null||s.value===void 0?"":String(s.value),onChange:m=>s.onChange(m.target.value===""?null:m.target.value)}),e.jsx(M,{})]})}),e.jsx(E,{control:o.control,name:"notes",render:({field:s})=>e.jsxs(j,{children:[e.jsx(w,{children:"Observações do Pedido (Opcional)"}),e.jsx(Qr,{placeholder:"Ex: Tocar a campainha duas vezes...",...s,rows:2}),e.jsx(M,{})]})})]})]}),e.jsx("div",{className:"lg:hidden sticky bottom-0 bg-card p-4 border-t shadow-2xl",children:e.jsx(ce,{type:"submit",className:"w-full h-12 text-lg",disabled:!Me,children:be?e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)}`})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(ce,{type:"submit",className:"w-full h-12 text-lg",disabled:!Me,children:be?e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)}`})})]})})}),e.jsx("div",{className:"lg:col-span-1 hidden lg:block",children:e.jsx(_s,{...t})})]})})]})};export{ra as default};
