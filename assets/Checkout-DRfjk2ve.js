import{j as e,b as Us,u as xe,c as Zs}from"./tanstack-D8i8yNxB.js";import{r as l,R as ye,u as Hs,h as Js,L as Je}from"./vendor-Dl0Wzy4_.js";import{o as Qs,s as L,l as Ws,e as Xs,p as Ie,c as Qe,n as Ys,Z as z,u as er,t as sr}from"./types-BCrSgEF3.js";import{s as $}from"./client-BmrnLCXS.js";import{c as Ve,f as Oe,g as ve,P as U,i as je,h as es,l as rr,m as ss,b as ue,n as tr,k as or,a as rs,v as ar,L as We}from"./index-DnryiRtA.js";import{B as oe}from"./button-DZCNZlxO.js";import{C as ne,b as ie,c as le,a as ce}from"./card-DXDgdRWY.js";import{I as O}from"./label-CV9TpW37.js";import{c as ts,R as nr,I as ir,a as lr,C as cr}from"./index-Cr980oAL.js";import{u as dr}from"./index-BB_oiUC3.js";import{u as ur}from"./index-PuW-_iwo.js";import{S as de}from"./separator-U9rlLTqw.js";import{T as mr}from"./textarea-DF3LDBup.js";import{A as J,a as Q,b as W}from"./alert-XQY6ToWF.js";import{F as pr,b as I,c as N,a as R,e as k,d as ae}from"./form-BDovggOK.js";import{Z as hr,M as fr}from"./MapLocationSection-Bo9Pr91u.js";import{S as xr}from"./shopping-cart-BqsU4JES.js";import{T as ke}from"./terminal-DtU8lnLY.js";import{A as gr}from"./arrow-left-dDOBFXVp.js";import{T as Xe}from"./truck-DGOz9VUA.js";import{S as os,a as yr}from"./store-BtKjxH9W.js";import{M as Ye}from"./map-pin-Bnpwb15Q.js";import{P as jr}from"./package-fwKBIDkM.js";import{C as vr}from"./credit-card-5uWJKZEi.js";import{D as br}from"./dollar-sign-BBEl-nMx.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nr=Ve("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cr=Ve("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _r=Ve("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var $e="Radio",[wr,as]=Oe($e),[Rr,Er]=wr($e),ns=l.forwardRef((t,r)=>{const{__scopeRadio:o,name:m,checked:a=!1,required:c,disabled:i,value:p="on",onCheck:h,form:f,...w}=t,[j,C]=l.useState(null),g=ve(r,v=>C(v)),y=l.useRef(!1),V=j?f||!!j.closest("form"):!0;return e.jsxs(Rr,{scope:o,checked:a,disabled:i,children:[e.jsx(U.button,{type:"button",role:"radio","aria-checked":a,"data-state":ds(a),"data-disabled":i?"":void 0,disabled:i,value:p,...w,ref:g,onClick:je(t.onClick,v=>{a||h==null||h(),V&&(y.current=v.isPropagationStopped(),y.current||v.stopPropagation())})}),V&&e.jsx(cs,{control:j,bubbles:!y.current,name:m,value:p,checked:a,required:c,disabled:i,form:f,style:{transform:"translateX(-100%)"}})]})});ns.displayName=$e;var is="RadioIndicator",ls=l.forwardRef((t,r)=>{const{__scopeRadio:o,forceMount:m,...a}=t,c=Er(is,o);return e.jsx(es,{present:m||c.checked,children:e.jsx(U.span,{"data-state":ds(c.checked),"data-disabled":c.disabled?"":void 0,...a,ref:r})})});ls.displayName=is;var Pr="RadioBubbleInput",cs=l.forwardRef(({__scopeRadio:t,control:r,checked:o,bubbles:m=!0,...a},c)=>{const i=l.useRef(null),p=ve(i,c),h=ur(o),f=rr(r);return l.useEffect(()=>{const w=i.current;if(!w)return;const j=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(j,"checked").set;if(h!==o&&g){const y=new Event("click",{bubbles:m});g.call(w,o),w.dispatchEvent(y)}},[h,o,m]),e.jsx(U.input,{type:"radio","aria-hidden":!0,defaultChecked:o,...a,tabIndex:-1,ref:p,style:{...a.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});cs.displayName=Pr;function ds(t){return t?"checked":"unchecked"}var Sr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],be="RadioGroup",[Ir,Pt]=Oe(be,[ts,as]),us=ts(),ms=as(),[kr,Fr]=Ir(be),ps=l.forwardRef((t,r)=>{const{__scopeRadioGroup:o,name:m,defaultValue:a,value:c,required:i=!1,disabled:p=!1,orientation:h,dir:f,loop:w=!0,onValueChange:j,...C}=t,g=us(o),y=dr(f),[V,v]=ss({prop:c,defaultProp:a??null,onChange:j,caller:be});return e.jsx(kr,{scope:o,name:m,required:i,disabled:p,value:V,onValueChange:v,children:e.jsx(nr,{asChild:!0,...g,orientation:h,dir:y,loop:w,children:e.jsx(U.div,{role:"radiogroup","aria-required":i,"aria-orientation":h,"data-disabled":p?"":void 0,dir:y,...C,ref:r})})})});ps.displayName=be;var hs="RadioGroupItem",fs=l.forwardRef((t,r)=>{const{__scopeRadioGroup:o,disabled:m,...a}=t,c=Fr(hs,o),i=c.disabled||m,p=us(o),h=ms(o),f=l.useRef(null),w=ve(r,f),j=c.value===a.value,C=l.useRef(!1);return l.useEffect(()=>{const g=V=>{Sr.includes(V.key)&&(C.current=!0)},y=()=>C.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",y)}},[]),e.jsx(ir,{asChild:!0,...p,focusable:!i,active:j,children:e.jsx(ns,{disabled:i,required:c.required,checked:j,...h,...a,name:c.name,ref:w,onCheck:()=>c.onValueChange(a.value),onKeyDown:je(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:je(a.onFocus,()=>{var g;C.current&&((g=f.current)==null||g.click())})})})});fs.displayName=hs;var Lr="RadioGroupIndicator",xs=l.forwardRef((t,r)=>{const{__scopeRadioGroup:o,...m}=t,a=ms(o);return e.jsx(ls,{...a,...m,ref:r})});xs.displayName=Lr;var gs=ps,ys=fs,Vr=xs;const Fe=l.forwardRef(({className:t,...r},o)=>e.jsx(gs,{className:ue("grid gap-2",t),...r,ref:o}));Fe.displayName=gs.displayName;const ge=l.forwardRef(({className:t,...r},o)=>e.jsx(ys,{ref:o,className:ue("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...r,children:e.jsx(Vr,{className:"flex items-center justify-center",children:e.jsx(Nr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ge.displayName=ys.displayName;const Or=t=>{let r=t.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},js=ye.forwardRef(({className:t,value:r,onChange:o,...m},a)=>{const c=i=>{const p=i.target.value,h=Or(p),f={...i,target:{...i.target,value:h}};o(f)};return e.jsx(O,{ref:a,type:"tel",className:ue("w-full",t),placeholder:"(99) 99999-9999",value:r,onChange:c,...m})});js.displayName="PhoneInput";const $r=t=>{let r=t.replace(/\D/g,"");return r.length>14&&(r=r.slice(0,14)),r.length<=11?(r.length>9&&(r=`${r.slice(0,9)}-${r.slice(9)}`),r.length>6&&(r=`${r.slice(0,6)}.${r.slice(6)}`),r.length>3&&(r=`${r.slice(0,3)}.${r.slice(3)}`),r):(r.length>12&&(r=`${r.slice(0,12)}-${r.slice(12)}`),r.length>8&&(r=`${r.slice(0,8)}/${r.slice(8)}`),r.length>5&&(r=`${r.slice(0,5)}.${r.slice(5)}`),r.length>2&&(r=`${r.slice(0,2)}.${r.slice(2)}`),r)},vs=ye.forwardRef(({className:t,value:r,onChange:o,...m},a)=>{const c=i=>{const p=i.target.value,h=$r(p),f={...i,target:{...i.target,value:h}};o(f)};return e.jsx(O,{ref:a,type:"tel",className:ue("w-full",t),placeholder:"CPF ou CNPJ",value:r,onChange:c,maxLength:18,...m})});vs.displayName="CpfCnpjInput";const Tr=(t,r,o,m)=>{const c=(o-t)*(Math.PI/180),i=(m-r)*(Math.PI/180),p=Math.sin(c/2)*Math.sin(c/2)+Math.cos(t*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))},Ar=async t=>{const r=t.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(r)}&limit=1`,m=new AbortController,a=setTimeout(()=>m.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const c=await fetch(o,{signal:m.signal});if(!c.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",c.status),null;const i=await c.json();if(i&&Array.isArray(i)&&i.length>0){const p=i[0],h=parseFloat(p.lat),f=parseFloat(p.lon);if(Number.isFinite(h)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[h,f]),{lat:h,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",r),null}catch(c){return c instanceof Error&&c.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",r):console.error("LOG: geocodeAddress - Erro durante a requisição:",c),null}finally{clearTimeout(a)}},Mr=(t,r,o)=>{const m=Tr(r[0],r[1],t[0],t[1]),a=o.find(c=>m<=c.max_distance_km);if(a){const c=a.delivery_fee||0,i=a.min_delivery_time_minutes||0,p=i+15;return{fee:parseFloat(c.toFixed(2)),minTime:i,maxTime:p}}return null};var Ne="Collapsible",[Gr,St]=Oe(Ne),[qr,Te]=Gr(Ne),bs=l.forwardRef((t,r)=>{const{__scopeCollapsible:o,open:m,defaultOpen:a,disabled:c,onOpenChange:i,...p}=t,[h,f]=ss({prop:m,defaultProp:a??!1,onChange:i,caller:Ne});return e.jsx(qr,{scope:o,disabled:c,contentId:tr(),open:h,onOpenToggle:l.useCallback(()=>f(w=>!w),[f]),children:e.jsx(U.div,{"data-state":Me(h),"data-disabled":c?"":void 0,...p,ref:r})})});bs.displayName=Ne;var Ns="CollapsibleTrigger",Cs=l.forwardRef((t,r)=>{const{__scopeCollapsible:o,...m}=t,a=Te(Ns,o);return e.jsx(U.button,{type:"button","aria-controls":a.contentId,"aria-expanded":a.open||!1,"data-state":Me(a.open),"data-disabled":a.disabled?"":void 0,disabled:a.disabled,...m,ref:r,onClick:je(t.onClick,a.onOpenToggle)})});Cs.displayName=Ns;var Ae="CollapsibleContent",_s=l.forwardRef((t,r)=>{const{forceMount:o,...m}=t,a=Te(Ae,t.__scopeCollapsible);return e.jsx(es,{present:o||a.open,children:({present:c})=>e.jsx(Dr,{...m,ref:r,present:c})})});_s.displayName=Ae;var Dr=l.forwardRef((t,r)=>{const{__scopeCollapsible:o,present:m,children:a,...c}=t,i=Te(Ae,o),[p,h]=l.useState(m),f=l.useRef(null),w=ve(r,f),j=l.useRef(0),C=j.current,g=l.useRef(0),y=g.current,V=i.open||p,v=l.useRef(V),M=l.useRef(void 0);return l.useEffect(()=>{const E=requestAnimationFrame(()=>v.current=!1);return()=>cancelAnimationFrame(E)},[]),or(()=>{const E=f.current;if(E){M.current=M.current||{transitionDuration:E.style.transitionDuration,animationName:E.style.animationName},E.style.transitionDuration="0s",E.style.animationName="none";const X=E.getBoundingClientRect();j.current=X.height,g.current=X.width,v.current||(E.style.transitionDuration=M.current.transitionDuration,E.style.animationName=M.current.animationName),h(m)}},[i.open,m]),e.jsx(U.div,{"data-state":Me(i.open),"data-disabled":i.disabled?"":void 0,id:i.contentId,hidden:!V,...c,ref:w,style:{"--radix-collapsible-content-height":C?`${C}px`:void 0,"--radix-collapsible-content-width":y?`${y}px`:void 0,...t.style},children:V&&a})});function Me(t){return t?"open":"closed"}var Br=bs;const zr=Br,Kr=Cs,Ur=_s,Zr=()=>{const{items:t,subtotal:r,deliveryFee:o,total:m,totalItems:a}=rs(),[c,i]=l.useState(!1);return a===0?null:e.jsxs(zr,{open:c,onOpenChange:i,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Kr,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xr,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",a," ",a===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m)}),c?e.jsx(lr,{className:"h-5 w-5"}):e.jsx(cr,{className:"h-5 w-5"})]})]})}),e.jsxs(Ur,{className:"p-4 pt-0",children:[e.jsx(de,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:t.map(p=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[p.quantity,"x ",p.name,p.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",p.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(p.price*p.quantity)})]},p.id))}),e.jsx(de,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(de,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m)})]})]})]})]})},ws=t=>t.replace(/\D/g,""),Rs=t=>t.replace(/\D/g,""),Le=t=>t.replace(/\D/g,""),Hr=Qs({name:L().min(1,"Nome é obrigatório."),phone:L().min(1,"Telefone é obrigatório.").transform(ws).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:L().email("Email inválido.").optional().or(Ws("")),delivery_option:Xs(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:L().optional().default(""),number:L().optional().default(""),complement:L().optional().default(""),neighborhood:L().optional().default(""),city:L().optional().default(""),zip_code:L().optional().default("").transform(Rs).refine(t=>t.length===8||t.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ie(t=>typeof t=="string"?parseFloat(t):t,Qe.number().optional().nullable()),longitude:Ie(t=>typeof t=="string"?parseFloat(t):t,Qe.number().optional().nullable()),payment_method_id:L().min(1,"Selecione uma forma de pagamento."),notes:L().optional(),cpf_cnpj:L().optional().default("").transform(Le).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ie(t=>{if(t==null||t==="")return null;const r=String(t).replace(",","."),o=parseFloat(r);return isNaN(o)?r:o},Ys({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((t,r)=>{if(t.delivery_option==="delivery"&&(t.street.trim()===""&&r.addIssue({code:z.custom,message:"Rua é obrigatória.",path:["street"]}),t.number.trim()===""&&r.addIssue({code:z.custom,message:"Número é obrigatório.",path:["number"]}),t.neighborhood.trim()===""&&r.addIssue({code:z.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),t.city.trim()===""&&r.addIssue({code:z.custom,message:"Cidade é obrigatória.",path:["city"]}),t.zip_code.length!==8&&r.addIssue({code:z.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(t.latitude===null||t.longitude===null)&&r.addIssue({code:z.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),t.payment_method_id==="Dinheiro"&&t.change_for!==null&&t.change_for!==void 0&&t.change_for<=0&&r.addIssue({code:z.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),t.payment_method_id==="Pagamento online: Pix/Cartão"){const a=Le(t.cpf_cnpj||"");a.length!==11&&a.length!==14&&r.addIssue({code:z.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Jr=()=>{const t=window.location.origin,o=window.location.pathname.split("/")[1];return o?`${t}/${o}`:t},Qr=async()=>{const{data:t,error:r}=await $.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!t)throw new Error("Nenhum restaurante ativo encontrado.");return t},Wr=async t=>{const{data:r,error:o}=await $.from("restaurants").select("delivery_enabled").eq("id",t).single();if(o)throw new Error(`Erro ao buscar status de entrega: ${o.message}`);return r.delivery_enabled??!0},Xr=async t=>{const{data:r,error:o}=await $.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(o)throw new Error(`Erro ao buscar métodos de pagamento: ${o.message}`);return r},Yr=async t=>{const{data:r,error:o}=await $.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(o)throw new Error(`Erro ao buscar zonas de entrega: ${o.message}`);return r},et=t=>{switch(t){case"DollarSign":return br;case"Smartphone":return yr;case"CreditCard":return vr;case"Package":return jr;default:return os}},st=({subtotal:t,deliveryFee:r,total:o,items:m})=>e.jsxs(ne,{className:"sticky top-4",children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(ce,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(a=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a.quantity,"x ",a.name,a.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",a.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a.price*a.quantity)})]},a.id))}),e.jsx(de,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:r>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r):"Grátis"})]})]}),e.jsx(de,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]})]})]}),It=()=>{Jr();const t=Hs();Us();const r=rs(),{items:o,subtotal:m,deliveryFee:a,total:c,setDeliveryFee:i,clearCart:p}=r,[h]=Js(),[f,w]=l.useState(!1),[j,C]=l.useState(!1),[g,y]=l.useState(null),[V,v]=l.useState(null),[M,E]=l.useState(null),[X,Es]=l.useState(!1),Y=ye.useRef(!1),ee=ye.useRef(!1),se=h.get("status"),Ce=h.get("external_reference"),Ge=h.has("collection_id")||h.has("external_reference"),[me,qe]=l.useState(!1);l.useEffect(()=>{if(Ce)if(se==="approved"||se==="failure"||se==="pending"){t(`/order-success/${Ce}?status=${se}`,{replace:!0});return}else Ge&&(toast.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),qe(!1));else qe(!1)},[Ce,se,Ge,t]);const{data:d,isLoading:Ps,isError:Ss,error:Is}=xe({queryKey:["checkoutRestaurantData"],queryFn:Qr}),{data:G,isLoading:_e}=xe({queryKey:["deliveryStatus",d==null?void 0:d.id],queryFn:()=>Wr(d.id),enabled:!!(d!=null&&d.id)}),{data:Z=[],isLoading:ks}=xe({queryKey:["checkoutPaymentMethods",d==null?void 0:d.id],queryFn:()=>Xr(d.id),enabled:!!(d!=null&&d.id)}),{data:De=[],isLoading:Fs}=xe({queryKey:["checkoutDeliveryZones",d==null?void 0:d.id],queryFn:()=>Yr(d.id),enabled:!!(d!=null&&d.id)}),Ls=Ps||_e||ks||Fs,Vs=Ss,Be=Is,n=er({resolver:sr(Hr),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),T=n.watch("delivery_option"),we=n.watch("payment_method_id"),H=Z.find(s=>s.id===we),pe=(H==null?void 0:H.name)==="Pagamento online: Pix/Cartão",he=(H==null?void 0:H.name)==="Dinheiro",P=n.watch("latitude"),S=n.watch("longitude");n.watch(["street","number","neighborhood","city","zip_code"]);const q=T==="delivery",Os=l.useMemo(()=>JSON.stringify({deliveryOption:T,deliveryEnabled:G,lat:P,lng:S}),[T,G,P,S]),$s=l.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:d!=null&&d.latitude&&(d!=null&&d.longitude)?[d.latitude,d.longitude]:[-23.55052,-46.633308],[P,S,d]),Ts=l.useMemo(()=>P===null||S===null?`map-${T}-null`:`map-${T}-${P.toFixed(6)}-${S.toFixed(6)}`,[q,T,P,S]),Re=l.useCallback(s=>{const u=s.road||s.logradouro||"",x=s.house_number||"",b=s.suburb||s.bairro||"",_=s.city||s.localidade||"",A=s.postcode||s.cep||"";n.setValue("street",u,{shouldValidate:!0}),n.setValue("number",x||"",{shouldValidate:!0}),n.setValue("complement",s.suburb||"",{shouldValidate:!0}),n.setValue("neighborhood",b,{shouldValidate:!0}),n.setValue("city",_,{shouldValidate:!0}),n.setValue("zip_code",A,{shouldValidate:!0})},[n]),As=l.useCallback(async(s,u)=>{n.setValue("latitude",s,{shouldValidate:!0}),n.setValue("longitude",u,{shouldValidate:!0});const x=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${u}&addressdetails=1`,b=await fetch(x);if(b.ok){const _=await b.json();_.address&&(Re(_.address),toast.info("Endereço preenchido a partir do mapa."))}},[n,Re]),Ms=l.useCallback(()=>{n.setValue("street","",{shouldValidate:!0}),n.setValue("number","",{shouldValidate:!0}),n.setValue("complement","",{shouldValidate:!0}),n.setValue("neighborhood","",{shouldValidate:!0}),n.setValue("city","",{shouldValidate:!0}),n.setValue("zip_code","",{shouldValidate:!0}),n.setValue("latitude",null,{shouldValidate:!0}),n.setValue("longitude",null,{shouldValidate:!0}),i(0),y(null),v(null),toast.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[n,i]),Ee=l.useCallback(s=>{try{const u={name:s.name,phone:s.phone,email:s.email,delivery_option:s.delivery_option,street:s.street,number:s.number,complement:s.complement,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code,latitude:s.latitude,longitude:s.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(u))}catch(u){console.error("Failed to save form data to local storage",u)}},[]),ze=l.useCallback(()=>{try{const s=localStorage.getItem("checkoutFormData");if(s){const u=JSON.parse(s);n.reset({...n.getValues(),...u,delivery_option:u.delivery_option||"delivery"})}}catch(s){console.error("Failed to load form data from local storage",s)}},[n]);l.useEffect(()=>{ze()},[ze]),l.useEffect(()=>{const s=n.watch(u=>{Ee(u)});return()=>s.unsubscribe()},[n,Ee]);const Gs=()=>{Y.current||(E(null),Y.current=!0,Promise.resolve().then(async()=>{try{const s=n.getValues(),[u,x,b,_,A]=[s.street,s.number,s.neighborhood,s.city,s.zip_code],fe=Rs(A);if(!(u&&x&&b&&_&&fe.length===8)){console.log("LOG: Validau00e7u00e3o de endereu00e7o incompleto falhou."),Y.current=!1;return}console.log("LOG: Iniciando geocodificau00e7u00e3o para:",`${u}, ${x}, ${b}, ${_}, ${A}`);const re=`${u}, ${x}, ${b}, ${_}, ${A}`,K=await Ar(re);K?(console.log("LOG: Geocodificau00e7u00e3o bem-sucedida. Coordenadas:",K),n.setValue("latitude",K.lat,{shouldValidate:!1}),n.setValue("longitude",K.lng,{shouldValidate:!1}),Ee(n.getValues())):(console.log("LOG: Geocodificau00e7u00e3o falhou ou retornou coordenadas invu00e1lidas."),setTimeout(()=>{E("Endereu00e7o nu00e3o encontrado. Por favor, verifique se estu00e1 correto e tente novamente.")},100))}catch(s){console.error("LOG: Erro capturado durante a geocodificau00e7u00e3o:",s),setTimeout(()=>{E("Erro ao buscar coordenadas. Verifique sua conexu00e3o ou tente novamente.")},100)}finally{Y.current=!1}}).catch(s=>{console.error("LOG: Erro nao capturado:",s),Y.current=!1}))};l.useEffect(()=>{he||n.setValue("change_for",null,{shouldValidate:!0})},[he,n]),l.useEffect(()=>{T==="pickup"&&(i(0),y(null),v(null),n.setValue("latitude",null),n.setValue("longitude",null))},[T,q,n,i,P,S]),l.useEffect(()=>{Z.length>0&&!we&&n.setValue("payment_method_id",Z[0].id)},[Z,we,n]),l.useEffect(()=>{pe?n.trigger("cpf_cnpj"):n.clearErrors("cpf_cnpj")},[pe,n]),l.useEffect(()=>{const s=async()=>{if(T==="pickup"||!(d!=null&&d.latitude)||!(d!=null&&d.longitude)){i(0),y(null),v(null);return}if(_e)return;if(G===!1){i(0),y(null),v(null),C(!1);return}C(!0),y(null);let x=null;if(P&&S)x=[P,S];else{i(0),v(null),C(!1);return}if(x){const b=[d.latitude,d.longitude],_=Mr(x,b,De);_?(i(_.fee),y(null),v({minTime:_.minTime,maxTime:_.maxTime})):(i(0),y("Seu endereço está fora da nossa área de entrega."),v(null))}C(!1)},u=setTimeout(()=>{s()},500);return()=>clearTimeout(u)},[Os,d,De,n,i,q,P,S,G,_e]),l.useEffect(()=>{if(o.length===0&&!f&&!me&&!X){const s=setTimeout(()=>{console.log("LOG: Carrinho vazio. Redirecionando para o menu."),t("/menu")},0);return()=>clearTimeout(s)}},[o.length,t,f,me,X]);const Ke=Zs({mutationFn:async s=>{if(!d)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&g)throw new Error(g);const u=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),x=s.delivery_option==="delivery"?u:"Retirada no Local";let b;const _=ws(s.phone),A=Le(s.cpf_cnpj||""),{data:fe}=await $.from("customers").select("id").eq("phone",_).limit(1).single();if(fe){b=fe.id;const F={name:s.name};A&&(F.cpf_cnpj=A),await $.from("customers").update(F).eq("id",b)}else{const{data:F,error:D}=await $.from("customers").insert({name:s.name,phone:_,email:s.email||null,address:x,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:A||null}).select("id").single();if(D)throw new Error(`Erro ao criar cliente: ${D.message}`);b=F.id}const Se=pe?"pending_payment":"pending",{data:re,error:K}=await $.from("orders").insert({restaurant_id:d.id,customer_id:b,status:Se,total_amount:c,delivery_fee:a,notes:s.notes,delivery_address:x,payment_method_id:s.payment_method_id,change_for:he?s.change_for:null}).select("id").single();if(K)throw new Error(`Erro ao criar pedido: ${K.message}`);const Ks=o.map(F=>{const D=Number(F.quantity),B=Number(F.price),te={order_id:re.id,product_id:F.product_id,quantity:D,unit_price:B,subtotal:D*B};return F.notes&&F.notes.trim()&&(te.notes=F.notes.trim()),te}),{error:Ze}=await $.from("order_items").insert(Ks);if(Ze){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Ze);const F=o.map(B=>{const te=Number(B.quantity),He=Number(B.price);return{order_id:re.id,quantity:te,unit_price:He,subtotal:te*He,notes:B.notes&&B.notes.trim()?B.notes.trim():null}}),{error:D}=await $.from("order_items").insert(F);if(D)throw new Error(`Erro ao adicionar itens do pedido: ${D.message}`)}return{orderId:re.id,orderStatus:Se}},onSuccess:s=>{ee.current=!1,Es(!0);const u=s.orderStatus==="pending_payment"?`/payment/${s.orderId}`:`/order-success/${s.orderId}`;console.log("LOG: Redirecionando para:",u),s.orderStatus==="pending_payment"&&w(!0),t(u,{replace:!0}),setTimeout(()=>{p()},500)},onError:s=>{ee.current=!1,console.error("LOG: Erro ao processar pedido:",s)}}),qs=async s=>{if(ee.current){console.log("LOG: Pagamento ja em processamento, ignorando nova chamada.");return}ee.current=!0,Promise.resolve().then(()=>{Ke.mutate(s)}).catch(u=>{console.error("LOG: Erro nao capturado em onSubmit:",u),ee.current=!1})},Ds=s=>{var x;console.error("Validation errors:",s);const u=Object.keys(s)[0];u&&console.error("LOG: Erro de validação:",((x=s[u])==null?void 0:x.message)||"Preencha todos os campos obrigatórios.")},Ue=Ke.isPending||f||j,Bs=!q||!g&&a>=0,Pe=!q||P!==null&&S!==null,zs=!Ue&&Bs&&Pe;return o.length===0&&!f&&!me?e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."}):Ls||me?e.jsx(ar,{}):Vs?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(J,{variant:"destructive",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(Q,{children:"Erro de Conexão"}),e.jsx(W,{children:Be instanceof Error?Be.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Je,{to:"/menu",children:e.jsx(oe,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(gr,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("div",{children:e.jsx(Zr,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(pr,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(qs,Ds),className:"space-y-6",children:[e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"name",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Nome Completo *"}),e.jsx(O,{placeholder:"Seu nome",...s}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:n.control,name:"phone",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Telefone *"}),e.jsx(js,{...s}),e.jsx(k,{})]})}),e.jsx(I,{control:n.control,name:"email",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Email (Opcional)"}),e.jsx(O,{placeholder:"seu@email.com",...s}),e.jsx(k,{})]})})]})]})]}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"delivery_option",render:({field:s})=>e.jsxs(N,{className:"space-y-3",children:[e.jsx(ae,{children:e.jsxs(Fe,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(N,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(ge,{value:"delivery"})}),e.jsx(Xe,{className:"h-5 w-5 text-primary"}),e.jsxs(R,{className:ue("font-normal flex-1 cursor-pointer"),children:["Delivery",G===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(N,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(ge,{value:"pickup"})}),e.jsx(os,{className:"h-5 w-5 text-primary"}),e.jsx(R,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(k,{})]})}),q&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ye,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(oe,{type:"button",variant:"outline",size:"sm",onClick:s=>{s.preventDefault(),Gs()},disabled:j,children:[e.jsx(_r,{className:"h-4 w-4 mr-2"})," ",j?"Buscando...":"Salvar Endereço"]}),e.jsxs(oe,{type:"button",variant:"outline",size:"sm",onClick:Ms,children:[e.jsx(Cr,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:n.control,name:"street",render:({field:s})=>e.jsxs(N,{className:"col-span-2",children:[e.jsx(R,{children:"Rua *"}),e.jsx(O,{...s}),e.jsx(k,{})]})}),e.jsx(I,{control:n.control,name:"number",render:({field:s})=>e.jsxs(N,{className:"col-span-1",children:[e.jsx(R,{children:"Número *"}),e.jsx(O,{...s}),e.jsx(k,{})]})})]}),e.jsx(I,{control:n.control,name:"complement",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Complemento (Opcional)"}),e.jsx(O,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:n.control,name:"neighborhood",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Bairro *"}),e.jsx(O,{...s}),e.jsx(k,{})]})}),e.jsx(I,{control:n.control,name:"city",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Cidade *"}),e.jsx(O,{...s}),e.jsx(k,{})]})})]}),e.jsx(I,{control:n.control,name:"zip_code",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"CEP *"}),e.jsx(hr,{...s}),e.jsx(k,{})]})}),q&&Pe&&e.jsx("div",{children:e.jsx(fr,{mapKey:Ts,markerPosition:$s,onLocationChange:As,updateAddressFields:Re,restaurant:d})}),j&&G!==!1&&e.jsxs(J,{children:[e.jsx(We,{className:"h-4 w-4 animate-spin"}),e.jsx(Q,{children:"Calculando Taxa..."}),e.jsx(W,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),g&&G!==!1&&e.jsxs(J,{variant:"destructive",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(Q,{children:"Erro de Entrega"}),e.jsx(W,{children:g})]}),a>0&&!j&&G!==!1&&e.jsxs(J,{className:"mt-4",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(Q,{children:"Taxa de Entrega Aplicada"}),e.jsxs(W,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)]})]}),M&&e.jsxs(J,{variant:"destructive",className:"mt-4",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(Q,{children:"Erro ao Buscar Endereu00e7o"}),e.jsx(W,{children:M})]}),q&&!Pe&&!M&&e.jsxs(J,{variant:"destructive",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx(Q,{children:"Localização Obrigatória"}),e.jsx(W,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"payment_method_id",render:({field:s})=>e.jsxs(N,{className:"space-y-3",children:[e.jsx(ae,{children:e.jsx(Fe,{onValueChange:u=>{s.onChange(u);const x=Z.find(b=>b.id===u);(x==null?void 0:x.name)!=="Dinheiro"&&n.setValue("change_for",null,{shouldValidate:!0}),(x==null?void 0:x.name)==="Pagamento online: Pix/Cartão"?n.trigger("cpf_cnpj"):n.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:Z.map(u=>{const x=et(u.icon||"Store");return e.jsxs(N,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(ge,{value:u.id})}),e.jsx(x,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(R,{className:"font-normal cursor-pointer",children:u.name}),u.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:u.description})]})]},u.id)})})}),e.jsx(k,{})]})}),he&&e.jsx(I,{control:n.control,name:"change_for",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Troco para (Opcional)"}),e.jsx(O,{type:"number",placeholder:"Ex: 50.00",...s,value:s.value||"",onChange:u=>s.onChange(u.target.value?parseFloat(u.target.value):null)}),e.jsx(k,{})]})}),pe&&e.jsx(I,{control:n.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"CPF/CNPJ *"}),e.jsx(vs,{...s}),e.jsx(k,{})]})})]})]}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"4. Observações"})}),e.jsx(ce,{children:e.jsx(I,{control:n.control,name:"notes",render:({field:s})=>e.jsxs(N,{children:[e.jsx(R,{children:"Observações do Pedido (Opcional)"}),e.jsx(mr,{placeholder:"Ex: Sem cebola, sem alface...",...s}),e.jsx(k,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Je,{to:"/menu",className:"flex-1",children:e.jsx(oe,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(oe,{type:"submit",className:"flex-1",disabled:!zs,size:"lg",children:Ue?e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(st,{subtotal:m,deliveryFee:a,total:c,items:o})})]})]})]})};export{It as default};
