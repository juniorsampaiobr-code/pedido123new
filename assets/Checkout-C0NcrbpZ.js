import{b as fe,j as e,u as Wr,c as Ae}from"./tanstack-d4AvmB45.js";import{r as d,u as Jr,h as Yr,j as et,L as Fe}from"./vendor-CnEXr6gt.js";import{s as P}from"./client-D5i5GwB9.js";import{c as rt,d as mr,e as Oe,P as _e,f as ke,g as tt,h as nt,i as st,a as he,u as _,L as pe,p as at,b as rr}from"./index-BoUWAHIn.js";import{L as ot,g as tr,c as Me,Z as it}from"./location-EC-RT0ge.js";import{u as ct}from"./use-auth-status-b07NBuTX.js";import{o as fr,s as L,e as dt,u as nr,C as me,t as sr}from"./types-DKlirIXB.js";import{B as Q}from"./button-CV9cGDmD.js";import{C as X,b as H,c as W,a as J}from"./card-Ct5Vfy6E.js";import{L as O,I as oe}from"./label-p1Ugbrxb.js";import{T as lt}from"./textarea-CCROyjYW.js";import{c as pr,R as ut,I as mt}from"./index-D3o554wn.js";import{u as ft}from"./index-DrlxvCXN.js";import{u as pt}from"./index-KNP7Yozt.js";import{S as ar}from"./separator-__LoesMn.js";import{A as te,a as ie,b as ce}from"./alert-BKdnTZOT.js";import{P as ht,M as xt}from"./PhoneInput-C_peRA5b.js";import{C as gt,L as yt}from"./CustomerProfileModal-QToWpOOk.js";import{D as or,a as ir,b as jt,c as vt,d as wt}from"./dialog-BT1UWBTf.js";import{C as hr}from"./credit-card-Des2PAI7.js";import{C as bt}from"./CpfCnpjInput-CCftqH3t.js";import{M as $e}from"./map-pin-ki7HAhyH.js";import{A as _t,a as Nt,b as Ct,c as Et,d as St,e as Rt,g as Pt}from"./alert-dialog-CJ_e5RHk.js";import{C as we}from"./circle-alert-DG0Q_8lv.js";import{F as cr,b as It,d as At}from"./form-BjcZ72Gd.js";import{T as dr}from"./terminal-CknI9HH_.js";import{R as Ft}from"./pt-BR-DS9FFcEM.js";import{A as Mt}from"./arrow-left-CNldf34W.js";import{U as lr}from"./user-CIYzOO2v.js";import{T as je}from"./truck-4q-JNgoh.js";import{C as kt}from"./circle-check-big-BIdOfXkj.js";import{S as $t}from"./save-Cd0J1Lok.js";import{D as Dt}from"./dollar-sign-C8s3_HGt.js";import"./supabase-BZV_3FV3.js";import"./skeleton-LC_1j8La.js";import"./package-Dq2rvpt4.js";import"./check-C18XL7Uz.js";import"./circle-x-DJo4UtAR.js";import"./euro-C_4Pdf-w.js";import"./format-BeKxgCCE.js";import"./index-C8iywJ_z.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=rt("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),Tt=async r=>{const{data:s,error:n}=await P.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${n.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},xr=r=>fe({queryKey:["mercadoPagoPublicKey",r],queryFn:()=>Tt(r),enabled:!!r,staleTime:1/0});var Te="Radio",[Lt,gr]=mr(Te),[Vt,qt]=Lt(Te),yr=d.forwardRef((r,s)=>{const{__scopeRadio:n,name:u,checked:f=!1,required:g,disabled:w,value:c="on",onCheck:I,form:A,...N}=r,[y,D]=d.useState(null),S=Oe(s,z=>D(z)),M=d.useRef(!1),T=y?A||!!y.closest("form"):!0;return e.jsxs(Vt,{scope:n,checked:f,disabled:w,children:[e.jsx(_e.button,{type:"button",role:"radio","aria-checked":f,"data-state":br(f),"data-disabled":w?"":void 0,disabled:w,value:c,...N,ref:S,onClick:ke(r.onClick,z=>{f||I==null||I(),T&&(M.current=z.isPropagationStopped(),M.current||z.stopPropagation())})}),T&&e.jsx(wr,{control:y,bubbles:!M.current,name:u,value:c,checked:f,required:g,disabled:w,form:A,style:{transform:"translateX(-100%)"}})]})});yr.displayName=Te;var jr="RadioIndicator",vr=d.forwardRef((r,s)=>{const{__scopeRadio:n,forceMount:u,...f}=r,g=qt(jr,n);return e.jsx(tt,{present:u||g.checked,children:e.jsx(_e.span,{"data-state":br(g.checked),"data-disabled":g.disabled?"":void 0,...f,ref:s})})});vr.displayName=jr;var zt="RadioBubbleInput",wr=d.forwardRef(({__scopeRadio:r,control:s,checked:n,bubbles:u=!0,...f},g)=>{const w=d.useRef(null),c=Oe(w,g),I=pt(n),A=nt(s);return d.useEffect(()=>{const N=w.current;if(!N)return;const y=window.HTMLInputElement.prototype,S=Object.getOwnPropertyDescriptor(y,"checked").set;if(I!==n&&S){const M=new Event("click",{bubbles:u});S.call(N,n),N.dispatchEvent(M)}},[I,n,u]),e.jsx(_e.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...f,tabIndex:-1,ref:c,style:{...f.style,...A,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});wr.displayName=zt;function br(r){return r?"checked":"unchecked"}var Gt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Ne="RadioGroup",[Bt,ns]=mr(Ne,[pr,gr]),_r=pr(),Nr=gr(),[Kt,Ut]=Bt(Ne),Cr=d.forwardRef((r,s)=>{const{__scopeRadioGroup:n,name:u,defaultValue:f,value:g,required:w=!1,disabled:c=!1,orientation:I,dir:A,loop:N=!0,onValueChange:y,...D}=r,S=_r(n),M=ft(A),[T,z]=st({prop:g,defaultProp:f??null,onChange:y,caller:Ne});return e.jsx(Kt,{scope:n,name:u,required:w,disabled:c,value:T,onValueChange:z,children:e.jsx(ut,{asChild:!0,...S,orientation:I,dir:M,loop:N,children:e.jsx(_e.div,{role:"radiogroup","aria-required":w,"aria-orientation":I,"data-disabled":c?"":void 0,dir:M,...D,ref:s})})})});Cr.displayName=Ne;var Er="RadioGroupItem",Sr=d.forwardRef((r,s)=>{const{__scopeRadioGroup:n,disabled:u,...f}=r,g=Ut(Er,n),w=g.disabled||u,c=_r(n),I=Nr(n),A=d.useRef(null),N=Oe(s,A),y=g.value===f.value,D=d.useRef(!1);return d.useEffect(()=>{const S=T=>{Gt.includes(T.key)&&(D.current=!0)},M=()=>D.current=!1;return document.addEventListener("keydown",S),document.addEventListener("keyup",M),()=>{document.removeEventListener("keydown",S),document.removeEventListener("keyup",M)}},[]),e.jsx(mt,{asChild:!0,...c,focusable:!w,active:y,children:e.jsx(yr,{disabled:w,required:g.required,checked:y,...I,...f,name:g.name,ref:N,onCheck:()=>g.onValueChange(f.value),onKeyDown:ke(S=>{S.key==="Enter"&&S.preventDefault()}),onFocus:ke(f.onFocus,()=>{var S;D.current&&((S=A.current)==null||S.click())})})})});Sr.displayName=Er;var Zt="RadioGroupIndicator",Rr=d.forwardRef((r,s)=>{const{__scopeRadioGroup:n,...u}=r,f=Nr(n);return e.jsx(vr,{...f,...u,ref:s})});Rr.displayName=Zt;var Pr=Cr,Ir=Sr,Qt=Rr;const De=d.forwardRef(({className:r,...s},n)=>e.jsx(Pr,{className:he("grid gap-2",r),...s,ref:n}));De.displayName=Pr.displayName;const be=d.forwardRef(({className:r,...s},n)=>e.jsx(Ir,{ref:n,className:he("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...s,children:e.jsx(Qt,{className:"flex items-center justify-center",children:e.jsx(Ot,{className:"h-2.5 w-2.5 fill-current text-current"})})}));be.displayName=Ir.displayName;var Le={};Object.defineProperty(Le,"__esModule",{value:!0});var Ar=Le.loadMercadoPago=void 0;const Fr="https://sdk.mercadopago.com/js/v2",Xt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,ur="MercadoPago has already been initialized in your window, please remove the duplicate import",Ht="MercadoPago.js not available",Wt="Failed to load MercadoPago.js",Jt=()=>{for(var r=document.querySelectorAll(`script[src^="${Fr}"`),s=0;s<r.length;s++){var n=r[s];if(Xt.test(n.src))return n}return null},Yt=()=>{const r=document.createElement("script");r.src=Fr;const s=document.head||document.body;if(!s)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return s.appendChild(r),r};let ve=null;const en=()=>(ve!==null||(ve=new Promise((r,s)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(ur),r(window.MercadoPago);return}try{let n=Jt();n?console.warn(ur):n||(n=Yt()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):s(new Error(Ht))}),n.addEventListener("error",()=>{s(new Error(Wt))})}catch(n){s(n);return}})),ve);Ar=Le.loadMercadoPago=en;var rn=function(r,s,n,u){function f(g){return g instanceof n?g:new n(function(w){w(g)})}return new(n||(n=Promise))(function(g,w){function c(N){try{A(u.next(N))}catch(y){w(y)}}function I(N){try{A(u.throw(N))}catch(y){w(y)}}function A(N){N.done?g(N.value):f(N.value).then(c,I)}A((u=u.apply(r,s||[])).next())})};class B{static getInstance(){return rn(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield Ar(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}B.publicKey=null;B.options={};B.instanceMercadoPago=void 0;B.loadedInstanceMercadoPago=!1;function tn(r,s){return Object.keys(r).length===Object.keys(s).length&&Object.keys(r).every(u=>Object.prototype.hasOwnProperty.call(s,u)&&r[u]===s[u])}const nn=(r,s)=>{const n=Object.assign(Object.assign({},s),{frontEndStack:"react"}),u=!tn(B.options,n);(r!==B.publicKey||u)&&(B.publicKey=r,B.options=n,B.instanceMercadoPago=void 0)},sn=({preferenceId:r,initPoint:s,onClose:n})=>{const{data:u,isLoading:f}=xr();return d.useEffect(()=>{if(u)try{nn(u,{locale:"pt-BR"})}catch(g){console.error("Erro ao inicializar Mercado Pago:",g),_.error("Erro ao carregar o SDK do Mercado Pago."),n();return}s&&(console.log("Redirecionando para o Mercado Pago:",s),window.location.href=s)},[u,n,s]),f||!u?e.jsx(or,{open:!0,onOpenChange:n,children:e.jsx(ir,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(pe,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(or,{open:!0,onOpenChange:n,children:e.jsxs(ir,{className:"sm:max-w-[425px]",children:[e.jsxs(jt,{children:[e.jsxs(vt,{className:"flex items-center gap-2",children:[e.jsx(hr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(wt,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(pe,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Q,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},an=({latitude:r,longitude:s,address:n,className:u})=>{const f=d.useMemo(()=>[r,s],[r,s]),g=d.useMemo(()=>[r,s],[r,s]);return e.jsxs(X,{className:he("w-full",u),children:[e.jsxs(H,{children:[e.jsxs(W,{className:"text-lg flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(J,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(ot,{center:g,markerPosition:f,onMarkerDragEnd:()=>{},zoom:16})})})]})},on=({isOpen:r,onConfirm:s})=>e.jsx(_t,{open:r,children:e.jsxs(Nt,{children:[e.jsxs(Ct,{children:[e.jsxs(Et,{className:"flex items-center gap-2 text-primary",children:[e.jsx(we,{className:"h-6 w-6"}),"Atenção ao Pagamento Online!"]}),e.jsxs(St,{children:["Você escolheu o pagamento online (Pix ou Cartão).",e.jsx("br",{}),e.jsx("br",{}),"Ao prosseguir, você será redirecionado para o checkout do Mercado Pago.",e.jsx("br",{}),e.jsx("br",{}),'**IMPORTANTE:** Se você escolher **PIX**, após o pagamento, você pode precisar clicar no botão **"Voltar ao site"** na tela do Mercado Pago para que seu pedido seja finalizado e rastreado corretamente.']})]}),e.jsx(Rt,{children:e.jsx(Pt,{onClick:s,className:"w-full",children:"Entendi e Continuar"})})]})}),cn=fr({zip_code:L().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:L().min(1,"Rua é obrigatória."),number:L().min(1,"Número é obrigatório."),neighborhood:L().min(1,"Bairro é obrigatório."),city:L().min(1,"Cidade é obrigatória.")}),dn=fr({name:L().min(1,"Nome é obrigatório."),phone:L().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:L().min(1,"CPF/CNPJ é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:dt(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:L().optional(),payment_method_id:L().min(1,"Selecione um método de pagamento."),change_for:L().optional()}),ln=async r=>{const{data:s,error:n}=await P.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!s)throw new Error("Restaurante não encontrado ou inativo.");return s},un=async r=>{const{data:s,error:n}=await P.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return s},mn=async r=>{const{data:s,error:n}=await P.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return s},fn=async r=>{const{data:s,error:n}=await P.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return s||null},ss=()=>{var He,We,Je,Ye,er;const r=Jr(),s=Yr(),[n]=et(),u=Wr(),{items:f,totalAmount:g,clearCart:w}=at(),{data:c,isLoading:I}=ct(),[A]=d.useState((He=s.state)==null?void 0:He.restaurantId),N=n.get("restaurantId"),y=A||N,{data:D}=xr(y),[S,M]=d.useState(!1),[T,z]=d.useState(!1),[xe,ne]=d.useState(0),[de,se]=d.useState(null),[Ce,Y]=d.useState(!0),[ee,le]=d.useState(null),[Mr,Ee]=d.useState(!1),[kr,$r]=d.useState(null),[Ve,Dr]=d.useState(null),[K,U]=d.useState(!1),[Or,qe]=d.useState(!1),[ze,Se]=d.useState(null),{data:h,isLoading:Tr,isError:Lr,error:Ge,refetch:Vr}=fe({queryKey:["checkoutRestaurantData",y],queryFn:()=>ln(y),enabled:!!y,staleTime:1/0}),{data:V,isLoading:qr}=fe({queryKey:["checkoutDeliveryZones",y],queryFn:()=>un(h.id),enabled:!!h,staleTime:1/0}),{data:G,isLoading:zr}=fe({queryKey:["checkoutPaymentMethods",y],queryFn:()=>mn(h.id),enabled:!!h,staleTime:1/0}),{data:p,isLoading:Be,refetch:pn}=fe({queryKey:["checkoutCustomerData",c==null?void 0:c.id],queryFn:()=>fn(c.id),enabled:!!c,staleTime:0}),Z=d.useMemo(()=>h!=null&&h.latitude&&(h!=null&&h.longitude)?[h.latitude,h.longitude]:null,[h]),Gr=d.useCallback(async(t,a,o,l,m,x,b)=>{const R=[30,45];if(h&&h.delivery_enabled===!1){const F=`${a}, ${o}, ${m}, ${l}, ${t}`;let E=null;if(x&&b?E={lat:x,lng:b}:E=await tr(F),!E)return{coords:null,fee:0,time:null,isValid:!1};if(V&&V.length>0&&Z){const re=Me([E.lat,E.lng],Z,V);if(re)return{coords:E,fee:0,time:[re.minTime,re.maxTime],isValid:!0}}return{coords:E,fee:0,time:R,isValid:!0}}if(!h||!Z)return{coords:null,fee:0,time:R,isValid:!0};const C=`${a}, ${o}, ${m}, ${l}, ${t}`;let j=null;if(x&&b?j={lat:x,lng:b}:j=await tr(C),!j)return{coords:null,fee:0,time:null,isValid:!1};if(V&&V.length>0){const F=Me([j.lat,j.lng],Z,V);return F?{coords:j,fee:F.fee,time:[F.minTime,F.maxTime],isValid:!0}:{coords:j,fee:0,time:null,isValid:!1}}else return{coords:j,fee:0,time:R,isValid:!0}},[h,Z,V]),i=nr({resolver:sr(dn),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),v=nr({resolver:sr(cn),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),k=i.watch("delivery_option"),Br=i.watch("payment_method_id"),ae=G==null?void 0:G.find(t=>t.id===Br),Re=(We=ae==null?void 0:ae.name)==null?void 0:We.includes("online"),ue=(Je=ae==null?void 0:ae.name)==null?void 0:Je.includes("Dinheiro"),q=g+xe,$=v.watch(["zip_code","street","number","city","neighborhood"]),Ke=d.useMemo(()=>{const[t,a,o,l,m]=$;return`${a}|${o}|${m}|${l}|${t}`},[$]),[Pe,Ie]=d.useState(null);d.useEffect(()=>{var t,a;if(U(!1),le(null),ne(0),se(null),Y(!0),Ie(null),v.reset({zip_code:"",street:"",number:"",neighborhood:"",city:""}),p){if(i.reset({...i.getValues(),name:p.name||"",phone:p.phone||"",cpf_cnpj:p.cpf_cnpj||"",change_for:""}),p.address&&p.latitude&&p.longitude){const o=p.zip_code||((a=(t=p.address.match(/\d{5}-?\d{3}$/))==null?void 0:t[0])==null?void 0:a.replace(/\D/g,""))||"",l=p.street||"",m=p.number||"",x=p.neighborhood||"",b=p.city||"";v.reset({zip_code:o,street:l,number:m,neighborhood:x,city:b});const R=`${l}|${m}|${x}|${b}|${o}`;if(Ie(R),Z&&V){const C=Me([p.latitude,p.longitude],Z,V);C?(ne(C.fee),se([C.minTime,C.maxTime]),Y(!0),U(!0),le([p.latitude,p.longitude])):(ne(0),Y(!1),U(!0),le([p.latitude,p.longitude]))}}}else if(c&&!Be){const o=c.user_metadata;i.reset({...i.getValues(),name:o.full_name||"",phone:o.phone||"",cpf_cnpj:o.cpf_cnpj||"",change_for:""})}},[p,i,c,Be,v,Z,V]),d.useEffect(()=>{k==="delivery"&&Pe!==null&&Ke!==Pe&&(U(!1),ne(0),se(null),Y(!0),le(null))},[Ke,Pe,k]),d.useEffect(()=>{const t=[15,30];k==="pickup"?(ne(0),Y(!0),U(!0),se(t)):(U(!1),se(null))},[k]);const ge=i.watch("change_for");d.useEffect(()=>{if(ue&&ge&&ge.trim()!==""){const t=ge.replace(",","."),a=parseFloat(t);isNaN(a)?i.setError("change_for",{message:"O troco deve ser um número válido."}):a<q?i.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q)}).`}):i.clearErrors("change_for")}else i.clearErrors("change_for")},[ue,ge,q,i]);const ye=Ae({mutationFn:async t=>{var C;z(!0);const a=`${t.street}, ${t.number}, ${t.neighborhood}, ${t.city}, ${t.zip_code}`,o=await Gr(t.zip_code,t.street,t.number,t.city,t.neighborhood);if(z(!1),!o.isValid)throw new Error((h==null?void 0:h.delivery_enabled)===!1?"O endereço está errado ou incompleto, revise todos os campos.":"Endereço fora da área de entrega.");if(!o.coords)throw new Error("Não foi possível obter as coordenadas para salvar o endereço.");const m=(C=(await P.auth.getUser()).data.user)==null?void 0:C.id;if(!(p!=null&&p.id)&&!m)return{customer:{id:"anonymous",user_id:null,name:i.getValues("name"),phone:i.getValues("phone"),email:(c==null?void 0:c.email)||null,address:a,created_at:"",updated_at:"",latitude:o.coords.lat,longitude:o.coords.lng,cpf_cnpj:i.getValues("cpf_cnpj")},feeResult:o};const x={name:i.getValues("name"),phone:i.getValues("phone"),cpf_cnpj:i.getValues("cpf_cnpj")||null},b={user_id:(c==null?void 0:c.id)||null,...x,email:(c==null?void 0:c.email)||null,address:a,latitude:o.coords.lat,longitude:o.coords.lng,street:t.street,number:t.number,neighborhood:t.neighborhood,city:t.city,zip_code:t.zip_code};let R;if(p!=null&&p.id){const{data:j,error:F}=await P.from("customers").update(b).eq("id",p.id).select().single();if(F)throw F;R=j}else if(m){const{data:j,error:F}=await P.from("customers").insert(b).select().single();if(F)throw F;R=j}else throw new Error("Não foi possível identificar o cliente para salvar.");return{customer:R,feeResult:o}},onSuccess:(t,a)=>{const{customer:o,feeResult:l}=t;(o==null?void 0:o.id)!=="anonymous"&&u.invalidateQueries({queryKey:["checkoutCustomerData"]}),ne(l.fee),se(l.time),Y(l.isValid),U(!0),le([l.coords.lat,l.coords.lng]);const m=`${a.street}|${a.number}|${a.neighborhood}|${a.city}|${a.zip_code}`;Ie(m),_.success("Endereço salvo e taxa de entrega calculada!")},onError:t=>{_.error(`Erro ao salvar endereço: ${t.message}`),Y(!1),U(!1)}}),Kr=async()=>{if(k==="pickup")return;if(!await v.trigger()){_.error("Preencha todos os campos obrigatórios do endereço.");return}const a=v.getValues(),o=_.loading("Salvando endereço e calculando taxa...");try{await ye.mutateAsync(a),_.dismiss(o)}catch{_.dismiss(o)}},Ue=Ae({mutationFn:async t=>{var b,R;(b=(await P.auth.getUser()).data.user)==null||b.id;const o=t.phone.replace(/\D/g,""),l=((R=t.cpf_cnpj)==null?void 0:R.replace(/\D/g,""))||null,m=k==="delivery"?`${$[1]}, ${$[2]}, ${$[4]}, ${$[3]}, ${$[0]}`:null,x={user_id:(c==null?void 0:c.id)||null,name:t.name,phone:o,email:(c==null?void 0:c.email)||null,cpf_cnpj:l,address:m,latitude:ee?ee[0]:null,longitude:ee?ee[1]:null};if(c)if(p){const{data:C,error:j}=await P.from("customers").update(x).eq("id",p.id).select().single();if(j)throw j;return C}else{const{data:C,error:j}=await P.from("customers").insert(x).select().single();if(j)throw j;return C}else{const{data:C,error:j}=await P.from("customers").insert(x).select().single();if(j)throw j;return C}},onSuccess:()=>{u.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:t=>{_.error(`Erro ao salvar dados do cliente: ${t.message}`)}}),Ze=Ae({mutationFn:async({customerId:t,data:a})=>{if(!h)throw new Error("Dados do restaurante não disponíveis.");let o=null;if(ue&&a.change_for&&a.change_for.trim()!==""){const E=a.change_for.replace(",","."),re=parseFloat(E);!isNaN(re)&&re>q&&(o=re)}let[l,m]=de||[null,null];if((k==="delivery"||k==="pickup")&&(!l||!m)){const E=k==="pickup"?[15,30]:[30,45];l=E[0],m=E[1]}const x=k==="delivery"?`${$[1]}, ${$[2]}, ${$[4]}, ${$[3]}, ${$[0]}`:null,b={restaurant_id:h.id,customer_id:t,status:Re?"pending_payment":"pending",total_amount:q,delivery_fee:xe,delivery_address:x,notes:a.notes,payment_method_id:a.payment_method_id,change_for:o,min_delivery_time_minutes:l,max_delivery_time_minutes:m},{data:R,error:C}=await P.from("orders").insert(b).select("id").single();if(C)throw C;const j=f.map(E=>({order_id:R.id,product_id:E.product.id,quantity:parseFloat(E.quantity.toFixed(3)),unit_price:parseFloat(E.product.price.toFixed(2)),subtotal:parseFloat(E.subtotal.toFixed(2)),notes:E.notes})),{error:F}=await P.from("order_items").insert(j);if(F)throw F;return R.id},onSuccess:t=>{u.invalidateQueries({queryKey:["orders"]})},onError:t=>{_.error(`Erro ao criar pedido: ${t.message}`)}}),Ur=async t=>{if(ue&&t.change_for&&t.change_for.trim()!==""){const l=t.change_for.replace(",","."),m=parseFloat(l);if(isNaN(m)){_.error("O troco deve ser um número válido.");return}if(m<q){i.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q)}).`});return}}if(f.length===0){_.error("Seu carrinho está vazio."),r(`/menu/${y}`);return}if(k==="delivery"){if(!K){_.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!Ce){_.error("O endereço de entrega está fora da área de cobertura.");return}}let a;try{a=(await Ue.mutateAsync(t)).id}catch(l){_.error(`Falha ao salvar cliente: ${l.message}`);return}let o;try{o=await Ze.mutateAsync({customerId:a,data:t})}catch(l){_.error(`Falha ao criar pedido: ${l.message}`);return}Re?await Zr(o,t):(w(),r(`/order-success/${o}`,{replace:!0}))},Zr=async(t,a)=>{if(!h)return;const o=window.location.origin+window.location.pathname,l=f.map(x=>({name:x.product.name,price:x.product.price,quantity:x.quantity})),m=_.loading("Preparando pagamento online...");try{const{data:x,error:b}=await P.functions.invoke("create-payment-preference",{body:{orderId:t,items:l,totalAmount:q,restaurantName:h.name,clientUrl:o,customerEmail:(c==null?void 0:c.email)||"cliente@anonimo.com",customerCpfCnpj:a.cpf_cnpj}});if(b)throw b;const{init_point:R}=x;$r(t),Dr(R),Ee(!0),_.dismiss(m)}catch(x){_.dismiss(m),_.error(`Erro no pagamento online: ${x.message}`),Ee(!1)}},Qr=async()=>{await P.auth.signOut(),_.success("Você saiu da sua conta."),r("/auth",{replace:!0})},Xr=(t,a,o)=>{a&&o?(Se(t),qe(!0)):(i.setValue("payment_method_id",t,{shouldValidate:!0}),Se(null))},Hr=()=>{ze&&i.setValue("payment_method_id",ze,{shouldValidate:!0}),qe(!1),Se(null)},Qe=d.useMemo(()=>{const[t,a,o,l,m]=$;return a&&o&&m&&l&&t?`${a}, ${o} - ${m}, ${l}, ${t}`:""},[$]);if(!y)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(dr,{className:"h-4 w-4"}),e.jsx(ie,{children:"Erro de Rastreamento"}),e.jsx(ce,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Fe,{to:"/",children:e.jsx(Q,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(f.length===0)return d.useEffect(()=>{r(`/menu/${y}`)},[r,y]),e.jsx(rr,{});if(Tr||qr||zr||I)return e.jsx(rr,{});if(Lr||!h)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(dr,{className:"h-4 w-4"}),e.jsx(ie,{children:"Erro Crítico"}),e.jsx(ce,{children:Ge instanceof Error?Ge.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Q,{onClick:()=>Vr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Ft,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Xe=Ue.isPending||Ze.isPending||ye.isPending||T||k==="delivery"&&!K;return e.jsxs("div",{className:"min-h-screen bg-background py-4 sm:py-8 px-4 sm:px-8",children:[e.jsx(gt,{isOpen:S,onClose:()=>M(!1),customer:p}),e.jsx(on,{isOpen:Or,onConfirm:Hr}),Mr&&Ve&&e.jsx(sn,{preferenceId:kr,initPoint:Ve,onClose:()=>Ee(!1)}),e.jsxs("div",{className:"w-full lg:max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Fe,{to:`/menu/${y}`,children:e.jsx(Q,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(Mt,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:h.name})]})]}),c&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Q,{variant:"outline",size:"sm",onClick:()=>M(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(lr,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(Q,{variant:"outline",size:"sm",onClick:Qr,children:[e.jsx(yt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(lr,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(J,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:c?`Logado como ${c.email}. ${p?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx(cr,{...i,children:e.jsx("form",{onSubmit:i.handleSubmit(Ur),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(oe,{id:"name",...i.register("name")}),i.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"phone",children:"Telefone *"}),e.jsx(me,{name:"phone",control:i.control,render:({field:t})=>e.jsx(ht,{id:"phone",...t})}),i.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(me,{name:"cpf_cnpj",control:i.control,render:({field:t})=>e.jsx(bt,{id:"cpf_cnpj",...t})}),i.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.cpf_cnpj.message})]})]})})})]})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(J,{children:e.jsx(me,{name:"delivery_option",control:i.control,render:({field:t})=>e.jsxs(De,{onValueChange:t.onChange,value:t.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(O,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(be,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(je,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(O,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(be,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx($e,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),k==="delivery"&&e.jsxs(X,{className:he(!K&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(H,{children:[e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",K&&e.jsx(kt,{className:"h-5 w-5 text-green-500 ml-2"}),!K&&e.jsx(we,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(J,{className:"space-y-4",children:[h.delivery_enabled===!1&&e.jsxs(te,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(ie,{children:"Frete Grátis Ativo"}),e.jsx(ce,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsx(cr,{...v,children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),Kr()},id:"address-form-inner",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(O,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(me,{name:"zip_code",control:v.control,render:({field:t})=>e.jsx(It,{className:"flex-1 space-y-0",children:e.jsx(At,{children:e.jsx(it,{placeholder:"Digite o CEP",...t})})})}),v.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:v.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(O,{htmlFor:"street",children:"Rua *"}),e.jsx(oe,{id:"street",...v.register("street")}),v.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:v.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"number",children:"Número *"}),e.jsx(oe,{id:"number",...v.register("number")}),v.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:v.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(O,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(oe,{id:"neighborhood",...v.register("neighborhood")}),v.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:v.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"city",children:"Cidade *"}),e.jsx(oe,{id:"city",...v.register("city")}),v.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:v.formState.errors.city.message})]}),e.jsxs(Q,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ye.isPending||T,children:[ye.isPending||T?e.jsx(pe,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx($t,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]})}),T&&e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 animate-spin"}),e.jsx(ie,{children:"Calculando Taxa de Entrega..."})]}),K&&!T&&e.jsxs(e.Fragment,{children:[h.delivery_enabled!==!1&&!Ce&&e.jsxs(te,{variant:"destructive",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(ie,{children:"Fora da Área de Entrega"}),e.jsx(ce,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(h.delivery_enabled===!1||Ce&&de)&&e.jsxs(te,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(ie,{children:"Entrega Disponível"}),e.jsxs(ce,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(xe),". Tempo estimado: ",de?`${de[0]} - ${de[1]}`:"30 - 45"," minutos."]})]})]}),K&&ee&&Qe&&e.jsx("div",{className:"mt-6",children:e.jsx(an,{latitude:ee[0],longitude:ee[1],address:Qe})})]})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(hr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(J,{children:[e.jsx(me,{name:"payment_method_id",control:i.control,render:({field:t})=>e.jsx(De,{onValueChange:a=>{var x;const o=G==null?void 0:G.find(b=>b.id===a),l=(x=o==null?void 0:o.name)==null?void 0:x.includes("online"),m=!!D&&D.trim()!=="";Xr(a,!!l,m)},value:t.value,className:"space-y-3",children:G==null?void 0:G.map(a=>{var x;const o=(x=a.name)==null?void 0:x.includes("online"),l=!!D&&D.trim()!=="",m=o&&!l;return e.jsx(O,{htmlFor:a.id,className:he("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",m&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(be,{value:a.id,id:a.id,disabled:m}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:a.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a.description}),m&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},a.id)})})}),i.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:i.formState.errors.payment_method_id.message})]})]}),ue&&e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(Dt,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(oe,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q),...i.register("change_for")}),((Ye=i.formState.errors.change_for)==null?void 0:Ye.message)&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message}),((er=i.formState.errors.change_for)==null?void 0:er.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message})]})})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(xt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(lt,{id:"notes",...i.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(X,{className:"shadow-lg",children:[e.jsx(H,{children:e.jsx(W,{className:"text-2xl",children:"Resumo"})}),e.jsxs(J,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:f.map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[t.quantity,"x ",t.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.subtotal)})]},t.product.id))}),e.jsx(ar,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(g)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(xe)})]})]}),e.jsx(ar,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q)})]}),e.jsx(Q,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Xe,children:Xe?e.jsx(pe,{className:"h-5 w-5 animate-spin mr-2"}):Re?"Pagar e Finalizar":"Confirmar Pedido"}),k==="delivery"&&!K&&e.jsxs(te,{variant:"destructive",className:"mt-3",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(ce,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Fe,{to:`/menu/${h.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{ss as default};
