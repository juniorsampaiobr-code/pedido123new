import{c as H,j as e,r as g,e as re,a as l,x as oe}from"./index-zkuE9Bm6.js";import{u as te}from"./useQuery-Bop5DQT3.js";import{u as T}from"./useMutation-DTwKCpeC.js";import{o as ne,s as j,l as $,b as le,p as q,c as R,u as ie,t as ce}from"./types-BjVHfDxe.js";import{s as y}from"./client-g0uDe16g.js";import{B as M}from"./button-3xZnEy7f.js";import{C as U,b as D,c as A,a as I}from"./card-B1F0wEox.js";import{I as x,L as B}from"./label-CD9lqJez.js";import{T as de}from"./textarea-DhevHx2f.js";import{S as ue}from"./switch-D1y-lj2Q.js";import{F as me,b as i,c,a as d,d as u,e as h}from"./form-gGgYvqwv.js";import{S as he}from"./skeleton-CBZEqJVS.js";import{L as K,i as pe,a as xe,M as je,T as ge,b as fe,u as be,c as ve}from"./marker-shadow-ClPBKzxz.js";import{Z as Q}from"./ZipCodeInput-DApDzusw.js";import{U as ye}from"./upload-C_wj4sHZ.js";import"./index-CSKTzlwz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=H("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=H("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),Ce=K.icon({iconUrl:pe,shadowUrl:xe,iconAnchor:[12,41]});K.Marker.prototype.options.icon=Ce;const Ee=({lat:n,lng:o})=>{const f=be();return g.useEffect(()=>{f.setView([n,o])},[n,o,f]),null},Se=({onLocationChange:n})=>(ve({click(o){n(o.latlng.lat,o.latlng.lng)}}),null),Ve=({center:n,markerPosition:o,onLocationChange:f})=>e.jsxs(je,{center:n,zoom:15,scrollWheelZoom:!1,className:"h-96 w-full rounded-lg z-0",children:[e.jsx(ge,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(fe,{position:o,draggable:!0,eventHandlers:{dragend:w=>{const{lat:S,lng:v}=w.target.getLatLng();f(S,v)}}}),e.jsx(Ee,{lat:o[0],lng:o[1]}),e.jsx(Se,{onLocationChange:f})]}),_e=ne({name:j().min(1,"O nome do restaurante é obrigatório."),description:j().optional(),logo_url:j().url("URL do logo inválida.").optional().or($("")),street:j().optional(),number:j().optional(),neighborhood:j().optional(),city:j().optional(),zip_code:j().optional(),phone:j().optional(),email:j().email("Email inválido.").optional().or($("")),is_active:le().default(!0),latitude:q(n=>String(n).replace(",","."),R.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:q(n=>String(n).replace(",","."),R.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),Me=async()=>{const{data:n,error:o}=await y.from("restaurants").select("*").limit(1).single();if(o)throw new Error(`Erro ao buscar dados do restaurante: ${o.message}`);if(!n)throw new Error("Nenhum restaurante encontrado.");return n},Ze=()=>{const n=re(),[o,f]=g.useState(null),[w,S]=g.useState(""),[v,Z]=g.useState(""),[F,L]=g.useState(!1),{data:r,isLoading:O,isError:W,error:G}=te({queryKey:["restaurantSettings"],queryFn:Me}),a=ie({resolver:ce(_e),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});g.useEffect(()=>{r&&a.reset({name:r.name||"",description:r.description||"",logo_url:r.logo_url||"",street:r.street||"",number:r.number||"",neighborhood:r.neighborhood||"",city:r.city||"",zip_code:r.zip_code||"",phone:r.phone||"",email:r.email||"",is_active:r.is_active??!0,latitude:r.latitude??null,longitude:r.longitude??null})},[r,a.reset]);const N=a.watch("latitude"),C=a.watch("longitude"),J=[-23.55052,-46.633308],k=g.useMemo(()=>typeof N=="number"&&typeof C=="number"&&!isNaN(N)&&!isNaN(C)?[N,C]:J,[N,C]),P=g.useCallback(s=>{a.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),a.setValue("number",s.house_number||"",{shouldValidate:!0}),a.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),a.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),a.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[a]),X=async()=>{const s=w.replace(/\D/g,"");if(s.length!==8||!v){l.warning("Por favor, digite um CEP válido e o número da casa.");return}L(!0);const m=l.loading("Buscando endereço e coordenadas...");try{const p=await fetch(`https://viacep.com.br/ws/${s}/json/`);if(!p.ok)throw new Error("Falha na busca do CEP.");const t=await p.json();if(t.erro){l.error("CEP não encontrado.");return}a.setValue("street",t.logradouro,{shouldValidate:!0}),a.setValue("number",v,{shouldValidate:!0}),a.setValue("neighborhood",t.bairro,{shouldValidate:!0}),a.setValue("city",t.localidade,{shouldValidate:!0}),a.setValue("zip_code",t.cep,{shouldValidate:!0});const b=`${t.logradouro}, ${v}, ${t.localidade}, ${t.uf}`,E=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(b)}`,z=await(await fetch(E)).json();if(z.length>0){const{lat:se,lon:ae}=z[0];a.setValue("latitude",parseFloat(se),{shouldValidate:!0}),a.setValue("longitude",parseFloat(ae),{shouldValidate:!0}),l.success("Endereço e mapa atualizados com sucesso!")}else l.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(p){l.error(`Erro na busca: ${p.message}`)}finally{L(!1),l.dismiss(m)}},Y=g.useCallback(async(s,m)=>{a.setValue("latitude",s,{shouldValidate:!0}),a.setValue("longitude",m,{shouldValidate:!0});const p=l.loading("Buscando endereço para a nova localização...");try{const t=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${m}&addressdetails=1`,b=await fetch(t);if(!b.ok)throw new Error("Falha ao obter detalhes do endereço.");const E=await b.json();E.address?(P(E.address),l.success("Endereço atualizado a partir do mapa.")):l.warning("Não foi possível encontrar um endereço para esta localização.")}catch(t){l.error(`Erro ao buscar endereço: ${t.message}`)}finally{l.dismiss(p)}},[a,P]),V=T({mutationFn:async s=>{if(!(r!=null&&r.id))throw new Error("ID do restaurante não disponível.");const{id:m,...p}={...s,id:r.id},{error:t}=await y.from("restaurants").update(p).eq("id",m);if(t)throw t},onSuccess:()=>{l.success("Configurações salvas com sucesso!"),n.invalidateQueries({queryKey:["restaurantSettings"]})},onError:s=>l.error(`Erro ao salvar configurações: ${s.message}`)}),_=T({mutationFn:async s=>{if(!(r!=null&&r.id))throw new Error("ID do restaurante não disponível.");const m=`${r.id}/notification.mp3`,{error:p}=await y.storage.from("settings").upload(m,s,{upsert:!0});if(p)throw p;const{data:t}=y.storage.from("settings").getPublicUrl(m),{error:b}=await y.from("restaurants").update({notification_sound_url:`${t.publicUrl}?t=${new Date().getTime()}`}).eq("id",r.id);if(b)throw b},onSuccess:()=>{l.success("Som de notificação atualizado com sucesso!"),n.invalidateQueries({queryKey:["restaurantSettings"]}),f(null)},onError:s=>l.error(`Erro ao salvar som: ${s.message}`)}),ee=()=>{o&&_.mutate(o)};return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(U,{children:[e.jsx(D,{children:e.jsx(A,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(I,{children:O?e.jsx(he,{className:"h-96 w-full"}):W?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",G.message]}):e.jsx(me,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(s=>V.mutate(s)),className:"space-y-6",children:[e.jsx(i,{control:a.control,name:"name",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Nome do Restaurante *"}),e.jsx(u,{children:e.jsx(x,{...s})}),e.jsx(h,{})]})}),e.jsx(i,{control:a.control,name:"description",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Descrição"}),e.jsx(u,{children:e.jsx(de,{...s,rows:3})}),e.jsx(h,{})]})}),e.jsx(i,{control:a.control,name:"logo_url",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"URL do Logo"}),e.jsx(u,{children:e.jsx(x,{...s})}),e.jsx(h,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{placeholder:"Digite o CEP",value:w,onChange:s=>S(s.target.value)}),e.jsx(x,{placeholder:"Número",value:v,onChange:s=>Z(s.target.value)}),e.jsx(M,{type:"button",onClick:X,disabled:F,children:F?e.jsx(oe,{className:"h-4 w-4 animate-spin"}):e.jsx(Ne,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(i,{control:a.control,name:"street",render:({field:s})=>e.jsxs(c,{className:"md:col-span-2",children:[e.jsx(d,{children:"Rua"}),e.jsx(u,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(h,{})]})}),e.jsx(i,{control:a.control,name:"number",render:({field:s})=>e.jsxs(c,{className:"md:col-span-1",children:[e.jsx(d,{children:"Número"}),e.jsx(u,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(h,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:a.control,name:"neighborhood",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Bairro"}),e.jsx(u,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(h,{})]})}),e.jsx(i,{control:a.control,name:"city",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Cidade"}),e.jsx(u,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(h,{})]})})]}),e.jsx(i,{control:a.control,name:"zip_code",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"CEP"}),e.jsx(u,{children:e.jsx(Q,{...s,disabled:!0})}),e.jsx(h,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(Ve,{center:k,markerPosition:k,onLocationChange:Y})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:a.control,name:"latitude",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Latitude"}),e.jsx(u,{children:e.jsx(x,{...s,placeholder:"-22.7627908",value:s.value??""})}),e.jsx(h,{})]})}),e.jsx(i,{control:a.control,name:"longitude",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Longitude"}),e.jsx(u,{children:e.jsx(x,{...s,placeholder:"-47.408315",value:s.value??""})}),e.jsx(h,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:a.control,name:"phone",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Telefone"}),e.jsx(u,{children:e.jsx(x,{...s})}),e.jsx(h,{})]})}),e.jsx(i,{control:a.control,name:"email",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Email"}),e.jsx(u,{children:e.jsx(x,{...s})}),e.jsx(h,{})]})})]}),e.jsx(i,{control:a.control,name:"is_active",render:({field:s})=>e.jsxs(c,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(d,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(u,{children:e.jsx(ue,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx(M,{type:"submit",className:"w-full h-12 text-lg",disabled:V.isPending,children:V.isPending?"Salvando...":"Salvar Configurações"})]})})})]}),e.jsxs(U,{children:[e.jsxs(D,{children:[e.jsxs(A,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(we,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(ye,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(o==null?void 0:o.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:s=>{var m;return f(((m=s.target.files)==null?void 0:m[0])||null)}})]})]}),e.jsx(M,{onClick:ee,className:"w-full h-12 text-lg",disabled:!o||_.isPending,children:_.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{Ze as default};
