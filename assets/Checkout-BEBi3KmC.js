import{u as ne,j as e,a as Ot,b as we}from"./tanstack-C7aOFagJ.js";import{r as m,R as kt,h as Lt,i as Ft,L as Ge}from"./vendor-DjsPZZVP.js";import{c as At,s as P,$ as He,a0 as Ee,a1 as pe,a2 as be,a3 as Dt,a4 as Tt,a9 as Gt,a5 as qt,a as fe,j as E,D as qe,q as Ve,L as ue,r as Vt,v as $t,w as Bt,B as H,o as We,l as k,K as zt,av as Kt,aw as Ut,u as Zt,p as $e,O as z,Q as Be,R as J,V as ee,d as ze,a6 as Qt,ax as Xt,U as Ke,ay as Ht,C as K,e as U,f as Z,b as Q,h as M,I as X,az as re,P as Wt,i as Yt,W as Ue,Y as Jt,aA as er,a7 as tr,T as rr,t as Ze}from"./index-MZOqwpmH.js";import{c as Ye,R as nr,I as ar}from"./index-9-om82NL.js";import{u as or}from"./index-C3WaO5Hu.js";import{S as Qe}from"./separator-BapV0qSk.js";import{Z as sr}from"./ZipCodeInput-DqUeM4Dd.js";import{C as Je}from"./credit-card-BgCvk2mn.js";import{T as _e}from"./truck-zjyjqd3l.js";import{C as de}from"./circle-alert-px4wp3gP.js";import{M as ir}from"./mail-BqmSiU1C.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cr=At("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),dr=async()=>{const{data:t,error:a}=await P.from("restaurants").select("id").limit(1).single();if(a||!t)return console.error("Failed to fetch restaurant ID for payment settings."),null;const r=t.id,{data:s,error:c}=await P.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${c.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},et=()=>ne({queryKey:["mercadoPagoPublicKey"],queryFn:dr,staleTime:1/0}),lr=(t,a,r,s)=>{const i=(r-t)*(Math.PI/180),o=(s-a)*(Math.PI/180),y=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t*(Math.PI/180))*Math.cos(r*(Math.PI/180))*Math.sin(o/2)*Math.sin(o/2);return 6371*(2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y)))},ur=async t=>{const a=t.replace(/\s+/g," ").trim(),r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,s=new AbortController,c=setTimeout(()=>s.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",r);const i=await fetch(r,{signal:s.signal});if(!i.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",i.status),null;const o=await i.json();if(o&&Array.isArray(o)&&o.length>0){const y=o[0],v=parseFloat(y.lat),h=parseFloat(y.lon);if(Number.isFinite(v)&&Number.isFinite(h))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[v,h]),{lat:v,lng:h}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(i){return i instanceof Error&&i.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",i),null}finally{clearTimeout(c)}},mr=(t,a,r)=>{const s=lr(a[0],a[1],t[0],t[1]),c=r.find(i=>s<=i.max_distance_km);if(c){const i=c.delivery_fee||0,o=c.min_delivery_time_minutes||0,y=o+15;return{fee:parseFloat(i.toFixed(2)),minTime:o,maxTime:y}}return null};var Ce="Radio",[fr,tt]=He(Ce),[pr,hr]=fr(Ce),rt=m.forwardRef((t,a)=>{const{__scopeRadio:r,name:s,checked:c=!1,required:i,disabled:o,value:y="on",onCheck:v,form:h,...u}=t,[x,L]=m.useState(null),C=Ee(a,O=>L(O)),S=m.useRef(!1),F=x?h||!!x.closest("form"):!0;return e.jsxs(pr,{scope:r,checked:c,disabled:o,children:[e.jsx(pe.button,{type:"button",role:"radio","aria-checked":c,"data-state":st(c),"data-disabled":o?"":void 0,disabled:o,value:y,...u,ref:C,onClick:be(t.onClick,O=>{c||v==null||v(),F&&(S.current=O.isPropagationStopped(),S.current||O.stopPropagation())})}),F&&e.jsx(ot,{control:x,bubbles:!S.current,name:s,value:y,checked:c,required:i,disabled:o,form:h,style:{transform:"translateX(-100%)"}})]})});rt.displayName=Ce;var nt="RadioIndicator",at=m.forwardRef((t,a)=>{const{__scopeRadio:r,forceMount:s,...c}=t,i=hr(nt,r);return e.jsx(Dt,{present:s||i.checked,children:e.jsx(pe.span,{"data-state":st(i.checked),"data-disabled":i.disabled?"":void 0,...c,ref:a})})});at.displayName=nt;var xr="RadioBubbleInput",ot=m.forwardRef(({__scopeRadio:t,control:a,checked:r,bubbles:s=!0,...c},i)=>{const o=m.useRef(null),y=Ee(o,i),v=or(r),h=Tt(a);return m.useEffect(()=>{const u=o.current;if(!u)return;const x=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(x,"checked").set;if(v!==r&&C){const S=new Event("click",{bubbles:s});C.call(u,r),u.dispatchEvent(S)}},[v,r,s]),e.jsx(pe.input,{type:"radio","aria-hidden":!0,defaultChecked:r,...c,tabIndex:-1,ref:y,style:{...c.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ot.displayName=xr;function st(t){return t?"checked":"unchecked"}var gr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],he="RadioGroup",[yr,cn]=He(he,[Ye,tt]),it=Ye(),ct=tt(),[jr,vr]=yr(he),dt=m.forwardRef((t,a)=>{const{__scopeRadioGroup:r,name:s,defaultValue:c,value:i,required:o=!1,disabled:y=!1,orientation:v,dir:h,loop:u=!0,onValueChange:x,...L}=t,C=it(r),S=Gt(h),[F,O]=qt({prop:i,defaultProp:c??null,onChange:x,caller:he});return e.jsx(jr,{scope:r,name:s,required:o,disabled:y,value:F,onValueChange:O,children:e.jsx(nr,{asChild:!0,...C,orientation:v,dir:S,loop:u,children:e.jsx(pe.div,{role:"radiogroup","aria-required":o,"aria-orientation":v,"data-disabled":y?"":void 0,dir:S,...L,ref:a})})})});dt.displayName=he;var lt="RadioGroupItem",ut=m.forwardRef((t,a)=>{const{__scopeRadioGroup:r,disabled:s,...c}=t,i=vr(lt,r),o=i.disabled||s,y=it(r),v=ct(r),h=m.useRef(null),u=Ee(a,h),x=i.value===c.value,L=m.useRef(!1);return m.useEffect(()=>{const C=F=>{gr.includes(F.key)&&(L.current=!0)},S=()=>L.current=!1;return document.addEventListener("keydown",C),document.addEventListener("keyup",S),()=>{document.removeEventListener("keydown",C),document.removeEventListener("keyup",S)}},[]),e.jsx(ar,{asChild:!0,...y,focusable:!o,active:x,children:e.jsx(rt,{disabled:o,required:i.required,checked:x,...v,...c,name:i.name,ref:u,onCheck:()=>i.onValueChange(c.value),onKeyDown:be(C=>{C.key==="Enter"&&C.preventDefault()}),onFocus:be(c.onFocus,()=>{var C;L.current&&((C=h.current)==null||C.click())})})})});ut.displayName=lt;var wr="RadioGroupIndicator",mt=m.forwardRef((t,a)=>{const{__scopeRadioGroup:r,...s}=t,c=ct(r);return e.jsx(at,{...c,...s,ref:a})});mt.displayName=wr;var ft=dt,pt=ut,_r=mt;const Ne=m.forwardRef(({className:t,...a},r)=>e.jsx(ft,{className:fe("grid gap-2",t),...a,ref:r}));Ne.displayName=ft.displayName;const me=m.forwardRef(({className:t,...a},r)=>e.jsx(pt,{ref:r,className:fe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...a,children:e.jsx(_r,{className:"flex items-center justify-center",children:e.jsx(cr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));me.displayName=pt.displayName;var Re={};Object.defineProperty(Re,"__esModule",{value:!0});var ht=Re.loadMercadoPago=void 0;const xt="https://sdk.mercadopago.com/js/v2",br=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Xe="MercadoPago has already been initialized in your window, please remove the duplicate import",Nr="MercadoPago.js not available",Er="Failed to load MercadoPago.js",Cr=()=>{for(var t=document.querySelectorAll(`script[src^="${xt}"`),a=0;a<t.length;a++){var r=t[a];if(br.test(r.src))return r}return null},Rr=()=>{const t=document.createElement("script");t.src=xt;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(t),t};let le=null;const Sr=()=>(le!==null||(le=new Promise((t,a)=>{if(typeof window>"u"){t(null);return}if(window.MercadoPago){console.warn(Xe),t(window.MercadoPago);return}try{let r=Cr();r?console.warn(Xe):r||(r=Rr()),r.addEventListener("load",()=>{window.MercadoPago?t(window.MercadoPago):a(new Error(Nr))}),r.addEventListener("error",()=>{a(new Error(Er))})}catch(r){a(r);return}})),le);ht=Re.loadMercadoPago=Sr;var Pr=function(t,a,r,s){function c(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function y(u){try{h(s.next(u))}catch(x){o(x)}}function v(u){try{h(s.throw(u))}catch(x){o(x)}}function h(u){u.done?i(u.value):c(u.value).then(y,v)}h((s=s.apply(t,a||[])).next())})};class G{static getInstance(){return Pr(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield ht(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}G.publicKey=null;G.options={};G.instanceMercadoPago=void 0;G.loadedInstanceMercadoPago=!1;function Ir(t,a){return Object.keys(t).length===Object.keys(a).length&&Object.keys(t).every(s=>Object.prototype.hasOwnProperty.call(a,s)&&t[s]===a[s])}const Mr=(t,a)=>{const r=Object.assign(Object.assign({},a),{frontEndStack:"react"}),s=!Ir(G.options,r);(t!==G.publicKey||s)&&(G.publicKey=t,G.options=r,G.instanceMercadoPago=void 0)};var Or=function(t,a,r,s){function c(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function y(u){try{h(s.next(u))}catch(x){o(x)}}function v(u){try{h(s.throw(u))}catch(x){o(x)}}function h(u){u.done?i(u.value):c(u.value).then(y,v)}h((s=s.apply(t,a||[])).next())})};const kr=()=>Or(void 0,void 0,void 0,function*(){}),Lr=()=>{},Fr=t=>{console.error(t)};var Ar=function(t,a,r,s){function c(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function y(u){try{h(s.next(u))}catch(x){o(x)}}function v(u){try{h(s.throw(u))}catch(x){o(x)}}function h(u){u.done?i(u.value):c(u.value).then(y,v)}h((s=s.apply(t,a||[])).next())})};const Dr=({settings:t,name:a,containerId:r,controller:s})=>Ar(void 0,void 0,void 0,function*(){const c=yield G.getInstance(),i=c==null?void 0:c.bricks();window[s]=yield i==null?void 0:i.create(a,r,t)}),Tr=200,Gr=({onReady:t=Lr,onError:a=Fr,onSubmit:r=kr,customization:s,initialization:c,locale:i,id:o="walletBrick_container"})=>(m.useEffect(()=>{const y={settings:{initialization:c,customization:s,locale:i,callbacks:{onReady:t,onSubmit:r,onError:a}},name:"wallet",containerId:o,controller:"walletBrickController"},v=setTimeout(()=>{Dr(y)},Tr);return()=>{var h;clearTimeout(v),(h=window.walletBrickController)===null||h===void 0||h.unmount()}},[s,c,t,a,r]),kt.createElement("div",{id:o})),qr=({preferenceId:t,initPoint:a,onClose:r})=>{const{data:s,isLoading:c}=et();return m.useEffect(()=>{if(s)try{Mr(s,{locale:"pt-BR"})}catch(i){console.error("Erro ao inicializar Mercado Pago:",i),E.error("Erro ao carregar o SDK do Mercado Pago."),r()}},[s,r]),c||!s?e.jsx(qe,{open:!0,onOpenChange:r,children:e.jsx(Ve,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(qe,{open:!0,onOpenChange:r,children:e.jsxs(Ve,{className:"sm:max-w-[425px]",children:[e.jsxs(Vt,{children:[e.jsxs($t,{className:"flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5 text-primary"}),"Pagamento Online"]}),e.jsx(Bt,{children:"Você será redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsx("div",{className:"py-4",children:e.jsx(Gr,{initialization:{preferenceId:t},customization:{texts:{valueProp:"smart_option"}}})}),e.jsx(H,{variant:"outline",onClick:r,children:"Cancelar Pagamento"})]})})},Vr=We({zip_code:k().min(1,"CEP é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===8,{message:"CEP deve ter 8 dígitos."}),street:k().min(1,"Rua é obrigatória."),number:k().min(1,"Número é obrigatório."),neighborhood:k().min(1,"Bairro é obrigatório."),city:k().min(1,"Cidade é obrigatória.")}),$r=We({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:k().email("Email inválido.").optional().or(zt("")),cpf_cnpj:k().optional().default("").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Kt(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:k().optional(),payment_method_id:k().min(1,"Selecione um método de pagamento."),change_for:k().optional()}),Br=async t=>{const{data:a,error:r}=await P.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",t).eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},zr=async t=>{const{data:a,error:r}=await P.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return a},Kr=async t=>{const{data:a,error:r}=await P.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(r)throw new Error(`Erro ao buscar métodos de pagamento: ${r.message}`);return a},Ur=async t=>{const{data:a,error:r}=await P.from("customers").select("*").eq("user_id",t).limit(1).single();if(r&&r.code!=="PGRST116")throw new Error(r.message);return a||null},dn=()=>{var Le,Fe,Ae,De,Te;const t=Lt(),a=Ft(),r=Ot(),{items:s,totalAmount:c,clearCart:i}=Ut(),{data:o,isLoading:y}=Zt(),{data:v}=et(),[h,u]=m.useState(!1),[x,L]=m.useState(!1),[C,S]=m.useState(0),[F,O]=m.useState(null),[xe,$]=m.useState(!0),[ae,gt]=m.useState(null),[yt,ge]=m.useState(!1),[jt,vt]=m.useState(null),[Se,wt]=m.useState(null),[q,B]=m.useState(!1),V=(Le=a.state)==null?void 0:Le.restaurantId;m.useEffect(()=>{console.log("LOG: Checkout - User Status:",o?`Logged in as ${o.email}`:"Anonymous")},[o]);const{data:_,isLoading:_t,isError:bt,error:Pe,refetch:Nt}=ne({queryKey:["checkoutRestaurantData",V],queryFn:()=>Br(V),enabled:!!V,staleTime:1/0}),{data:oe,isLoading:Et}=ne({queryKey:["checkoutDeliveryZones",V],queryFn:()=>zr(_.id),enabled:!!_,staleTime:1/0}),{data:W,isLoading:Ct}=ne({queryKey:["checkoutPaymentMethods",V],queryFn:()=>Kr(_.id),enabled:!!_,staleTime:1/0}),{data:N,isLoading:Ie,refetch:Zr}=ne({queryKey:["checkoutCustomerData",o==null?void 0:o.id],queryFn:()=>Ur(o.id),enabled:!!o,staleTime:0}),ye=m.useMemo(()=>_!=null&&_.latitude&&(_!=null&&_.longitude)?[_.latitude,_.longitude]:null,[_]),je=m.useCallback(async(n,d,f,b,j,p)=>{if(!_||!ye||!_.delivery_enabled)return S(0),$(!0),O(null),{coords:null,fee:0,time:null,isValid:!0};const I=`${d}, ${f}, ${b}, ${n}`;let g=null;if(j&&p)g={lat:j,lng:p};else{L(!0);const w=E.loading("Calculando taxa de entrega...");g=await ur(I),L(!1),E.dismiss(w)}if(!g)return S(0),O(null),$(!1),E.error("Não foi possível encontrar o endereço. Verifique o CEP e o número."),{coords:null,fee:0,time:null,isValid:!1};if(gt([g.lat,g.lng]),oe&&oe.length>0){const w=mr([g.lat,g.lng],ye,oe);return w?(S(w.fee),O([w.minTime,w.maxTime]),$(!0),{coords:g,fee:w.fee,time:[w.minTime,w.maxTime],isValid:!0}):(S(0),O(null),$(!1),E.error("Endereço fora da área de entrega."),{coords:g,fee:0,time:null,isValid:!1})}else return S(0),O(null),$(!0),{coords:g,fee:0,time:null,isValid:!0}},[_,ye,oe]),l=$e({resolver:Ze($r),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),R=$e({resolver:Ze(Vr),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),A=l.watch("delivery_option"),Rt=l.watch("payment_method_id"),Y=W==null?void 0:W.find(n=>n.id===Rt),se=(Fe=Y==null?void 0:Y.name)==null?void 0:Fe.includes("online"),te=(Ae=Y==null?void 0:Y.name)==null?void 0:Ae.includes("Dinheiro"),D=c+C,T=R.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{A==="pickup"?(S(0),$(!0),B(!0)):B(!1)},[A]),m.useEffect(()=>{if(N){let n="",d="",f="",b="",j="";if(N.address){const p=N.address.split(", ").map(I=>I.trim());p.length>=5?(n=p[0],d=p[1],f=p[2],b=p[3],j=p[4]):p.length>=4&&(n=p[0],f=p[1],b=p[2],j=p[3])}l.reset({...l.getValues(),name:N.name||"",phone:N.phone||"",email:N.email||"",cpf_cnpj:N.cpf_cnpj||"",change_for:""}),R.reset({zip_code:j,street:n,number:d,neighborhood:f,city:b}),N.address&&N.latitude&&N.longitude&&(B(!0),je(j,n,d,b,N.latitude,N.longitude))}else if(o&&!Ie){const n=o.user_metadata;l.reset({...l.getValues(),name:n.full_name||"",phone:n.phone||"",email:o.email||"",cpf_cnpj:n.cpf_cnpj||"",change_for:""})}},[N,l,o,Ie,R,je]);const ie=l.watch("change_for");m.useEffect(()=>{if(te&&ie&&ie.trim()!==""){const n=ie.replace(",","."),d=parseFloat(n);isNaN(d)?l.setError("change_for",{message:"O troco deve ser um número válido."}):d<D?l.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)}).`}):l.clearErrors("change_for")}else l.clearErrors("change_for")},[te,ie,D,l]);const ce=we({mutationFn:async n=>{var p;const f=(p=(await P.auth.getUser()).data.user)==null?void 0:p.id;if(!(N!=null&&N.id)&&!f)throw new Error("ID do cliente ou usuário não encontrado.");const b=`${n.street}, ${n.number}, ${n.neighborhood}, ${n.city}, ${n.zip_code}`,j={user_id:f||null,name:l.getValues("name"),phone:l.getValues("phone"),email:l.getValues("email")||null,cpf_cnpj:l.getValues("cpf_cnpj")||null,address:b,latitude:n.lat,longitude:n.lng};if(N!=null&&N.id){const{data:I,error:g}=await P.from("customers").update(j).eq("id",N.id).select().single();if(g)throw g;return I}else if(f){const{data:I,error:g}=await P.from("customers").insert(j).select().single();if(g)throw g;return I}else return{id:"anonymous",user_id:null,name:j.name,phone:j.phone,email:j.email,address:b,created_at:"",updated_at:"",latitude:n.lat,longitude:n.lng,cpf_cnpj:j.cpf_cnpj}},onSuccess:(n,d)=>{n.id!=="anonymous"&&r.invalidateQueries({queryKey:["checkoutCustomerData"]}),S(d.fee),O(d.time),$(d.isValid),B(!0),E.success("Endereço salvo e taxa de entrega calculada!")},onError:n=>{E.error(`Erro ao salvar endereço: ${n.message}`),B(!1)}}),St=async()=>{if(A==="pickup")return;if(!await R.trigger()){E.error("Preencha todos os campos obrigatórios do endereço.");return}const d=R.getValues(),f=await je(d.zip_code,d.street,d.number,d.city);if(!f.isValid){B(!1);return}if(!f.coords){E.error("Não foi possível obter as coordenadas para salvar o endereço."),B(!1);return}ce.mutate({...d,lat:f.coords.lat,lng:f.coords.lng,fee:f.fee,time:f.time,isValid:f.isValid})},Me=we({mutationFn:async n=>{var p,I;(p=(await P.auth.getUser()).data.user)==null||p.id;const f=n.phone.replace(/\D/g,""),b=((I=n.cpf_cnpj)==null?void 0:I.replace(/\D/g,""))||null,j={user_id:(o==null?void 0:o.id)||null,name:n.name,phone:f,email:n.email||null,cpf_cnpj:b,address:A==="delivery"?`${T[1]}, ${T[2]}, ${T[3]}, ${T[4]}, ${T[0]}`:null,latitude:ae?ae[0]:null,longitude:ae?ae[1]:null};if(o)if(N){const{data:g,error:w}=await P.from("customers").update(j).eq("id",N.id).select().single();if(w)throw w;return g}else{const{data:g,error:w}=await P.from("customers").insert(j).select().single();if(w)throw w;return g}else{const{data:g,error:w}=await P.from("customers").insert(j).select().single();if(w)throw w;return g}},onSuccess:()=>{r.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:n=>{E.error(`Erro ao salvar dados do cliente: ${n.message}`)}}),Oe=we({mutationFn:async({customerId:n,data:d})=>{if(!_)throw new Error("Dados do restaurante não disponíveis.");let f=null;if(te&&d.change_for&&d.change_for.trim()!==""){const w=d.change_for.replace(",","."),ve=parseFloat(w);!isNaN(ve)&&ve>D&&(f=ve)}const b={restaurant_id:_.id,customer_id:n,status:se?"pending_payment":"pending",total_amount:D,delivery_fee:C,delivery_address:A==="delivery"?`${T[1]}, ${T[2]}, ${T[3]}, ${T[4]}, ${T[0]}`:null,notes:d.notes,payment_method_id:d.payment_method_id,change_for:f},{data:j,error:p}=await P.from("orders").insert(b).select("id").single();if(p)throw p;const I=s.map(w=>({order_id:j.id,product_id:w.product.id,quantity:w.quantity,unit_price:w.product.price,subtotal:w.subtotal,notes:w.notes})),{error:g}=await P.from("order_items").insert(I);if(g)throw g;return j.id},onSuccess:n=>{r.invalidateQueries({queryKey:["orders"]})},onError:n=>{E.error(`Erro ao criar pedido: ${n.message}`)}}),Pt=async n=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",se),console.log("LOG: deliveryOption:",A),console.log("LOG: isAddressSaved:",q),console.log("LOG: change_for data:",n.change_for),te&&n.change_for&&n.change_for.trim()!==""){const b=n.change_for.replace(",","."),j=parseFloat(b);if(isNaN(j)){E.error("O troco deve ser um número válido.");return}if(j<D){E.error(`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)}).`);return}}if(s.length===0){E.error("Seu carrinho está vazio."),t("/menu");return}if(A==="delivery"){if(!q){E.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!xe){E.error("O endereço de entrega está fora da área de cobertura.");return}}let d;try{console.log("LOG: Criando/Atualizando cliente..."),d=(await Me.mutateAsync(n)).id,console.log("LOG: Cliente ID:",d)}catch(b){E.error(`Falha ao salvar cliente: ${b.message}`);return}let f;try{console.log("LOG: Criando pedido..."),f=await Oe.mutateAsync({customerId:d,data:n}),console.log("LOG: Pedido ID:",f)}catch(b){E.error(`Falha ao criar pedido: ${b.message}`);return}se?(console.log("LOG: Iniciando checkout Mercado Pago..."),await It(f,n)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),i(),t(`/order-success/${f}`,{replace:!0}))},It=async(n,d)=>{if(!_)return;const f=window.location.origin+window.location.pathname,b=s.map(p=>({name:p.product.name,price:p.product.price,quantity:p.quantity})),j=E.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:p,error:I}=await P.functions.invoke("create-payment-preference",{body:{orderId:n,items:b,totalAmount:D,restaurantName:_.name,clientUrl:f,customerEmail:d.email||(o==null?void 0:o.email)||"cliente@anonimo.com",customerCpfCnpj:d.cpf_cnpj}});if(I)throw I;const{init_point:g}=p;console.log("LOG: Preferência MP criada. init_point:",g),vt(n),wt(g),ge(!0),E.dismiss(j)}catch(p){console.error("Erro ao criar preferência MP:",p),E.dismiss(j),E.error(`Erro no pagamento online: ${p.message}`),ge(!1)}},Mt=async()=>{await P.auth.signOut(),E.success("Você saiu da sua conta."),t("/auth",{replace:!0})};if(!V)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro de Rastreamento"}),e.jsx(ee,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Ge,{to:"/",children:e.jsx(H,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(s.length===0)return m.useEffect(()=>{t(`/menu/${V}`)},[t,V]),e.jsx(ze,{});if(_t||Et||Ct||y)return e.jsx(ze,{});if(bt||!_)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro Crítico"}),e.jsx(ee,{children:Pe instanceof Error?Pe.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(H,{onClick:()=>Nt(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Qt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const ke=Me.isPending||Oe.isPending||ce.isPending||x||A==="delivery"&&!q;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Xt,{isOpen:h,onClose:()=>u(!1),customer:N}),yt&&Se&&e.jsx(qr,{preferenceId:jt,initPoint:Se,onClose:()=>ge(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:_.name})]}),o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{variant:"outline",size:"icon",onClick:()=>u(!0),"aria-label":"Meu Perfil",children:e.jsx(Ke,{className:"h-4 w-4"})}),e.jsxs(H,{variant:"outline",size:"sm",onClick:Mt,children:[e.jsx(Ht,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(Q,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:o?`Logado como ${o.email}. ${N?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:l.handleSubmit(Pt),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(X,{id:"name",...l.register("name")}),l.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"phone",children:"Telefone *"}),e.jsx(re,{name:"phone",control:l.control,render:({field:n})=>e.jsx(Wt,{id:"phone",...n})}),l.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(X,{id:"email",type:"email",...l.register("email")}),l.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(re,{name:"cpf_cnpj",control:l.control,render:({field:n})=>e.jsx(Yt,{id:"cpf_cnpj",...n})}),l.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(_e,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(Q,{children:e.jsx(re,{name:"delivery_option",control:l.control,render:({field:n})=>e.jsxs(Ne,{onValueChange:n.onChange,value:n.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(M,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(me,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(_e,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(M,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(me,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ue,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),A==="delivery"&&e.jsxs(K,{className:fe(!q&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(U,{children:[e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ue,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",q&&e.jsx(Jt,{className:"h-5 w-5 text-green-500 ml-2"}),!q&&e.jsx(de,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(Q,{className:"space-y-4",children:[!_.delivery_enabled&&e.jsxs(z,{variant:"destructive",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(J,{children:"Entrega Desativada"}),e.jsx(ee,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),St()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(M,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(re,{name:"zip_code",control:R.control,render:({field:n})=>e.jsx(sr,{id:"zip_code",...n})}),R.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"street",children:"Rua *"}),e.jsx(X,{id:"street",...R.register("street")}),R.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"number",children:"Número *"}),e.jsx(X,{id:"number",...R.register("number")}),R.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(X,{id:"neighborhood",...R.register("neighborhood")}),R.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"city",children:"Cidade *"}),e.jsx(X,{id:"city",...R.register("city")}),R.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.city.message})]}),e.jsxs(H,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ce.isPending||x||!_.delivery_enabled,children:[ce.isPending||x?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(er,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),x&&e.jsxs(z,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(J,{children:"Calculando Taxa de Entrega..."})]}),!xe&&q&&!x&&e.jsxs(z,{variant:"destructive",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(J,{children:"Fora da Área de Entrega"}),e.jsx(ee,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),F&&xe&&q&&!x&&e.jsxs(z,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(J,{children:"Entrega Disponível"}),e.jsxs(ee,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C),". Tempo estimado: ",F[0]," - ",F[1]," minutos."]})]})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(Q,{children:[e.jsx(re,{name:"payment_method_id",control:l.control,render:({field:n})=>e.jsx(Ne,{onValueChange:n.onChange,value:n.value,className:"space-y-3",children:W==null?void 0:W.map(d=>{var b;const f=((b=d.name)==null?void 0:b.includes("online"))&&!v;return e.jsx(M,{htmlFor:d.id,className:fe("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",f&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(me,{value:d.id,id:d.id,disabled:f}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:d.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:d.description}),f&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},d.id)})})}),l.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:l.formState.errors.payment_method_id.message})]})]}),te&&e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(tr,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(X,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D),...l.register("change_for")}),((De=l.formState.errors.change_for)==null?void 0:De.message)&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.change_for.message}),((Te=l.formState.errors.change_for)==null?void 0:Te.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.change_for.message})]})})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(ir,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(rr,{id:"notes",...l.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(K,{className:"shadow-lg",children:[e.jsx(U,{children:e.jsx(Z,{className:"text-2xl",children:"Resumo"})}),e.jsxs(Q,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:s.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[n.quantity,"x ",n.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.subtotal)})]},n.product.id))}),e.jsx(Qe,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C)})]})]}),e.jsx(Qe,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)})]}),e.jsx(H,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:ke,children:ke?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):se?"Pagar e Finalizar":"Confirmar Pedido"}),A==="delivery"&&!q&&e.jsxs(z,{variant:"destructive",className:"mt-3",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(ee,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Ge,{to:`/menu/${_.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{dn as default};
