import{a as W,u as T,c as _,j as e}from"./tanstack-LlX0VwFj.js";import{o as S,s as C,a as Y,b as Z,u as I,t as D}from"./types-tCkPXq4V.js";import{c as G,C as v,d as w,e as N,b as P,A as ee,t as se,v as ae,p as re,q as te,I as K,B as L,J as U,s as u,u as p}from"./index-C0r1h4jq.js";import{S as oe}from"./switch-CkjVLZiQ.js";import{F as O,a as E,b as A,c as R,d as M,e as B}from"./form-C7WqEopR.js";import{S as c}from"./skeleton-8DSanO53.js";import{j as ne,r as k}from"./vendor-DjsPZZVP.js";import{S as V}from"./store-DAaxxofJ.js";import{P as $}from"./package-C4ofPxVE.js";import{C as H}from"./credit-card-CU32--2G.js";import"./supabase-BAEEEeUB.js";import"./index-C3WaO5Hu.js";import"./label-CNAijYL-.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=G("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=G("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),de=S({mercado_pago_public_key:C().min(1,"A Public Key é obrigatória."),mercado_pago_access_token:C().min(1,"O Access Token é obrigatório.")}),le=S({methods:Y(S({id:C(),is_active:Z()}))}),me=async n=>{const{data:a,error:r}=await u.from("payment_settings").select("*").eq("restaurant_id",n).limit(1).single();if(r&&r.code!=="PGRST116")throw new Error(r.message);return a},Q=async n=>{const{data:a,error:r}=await u.from("payment_methods").select("*").eq("restaurant_id",n).order("name",{ascending:!0});if(r)throw new Error(r.message);return a},xe=[{name:"Dinheiro",description:"Pagamento em dinheiro na entrega",icon:U},{name:"Pagamento online: Pix/Cartão",description:"Pagamento online via Mercado Pago (Pix, Cartão de Crédito, etc.)",icon:H},{name:"Pagamento com cartão na entrega",description:"Aceita pagamento com cartão de débito ou crédito na entrega",icon:$}],ue=n=>{switch(n){case"DollarSign":return U;case"Smartphone":return ce;case"CreditCard":return H;case"Package":return $;default:return V}},he=({method:n,index:a,control:r,icon:g})=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(g,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:n.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n.description})]})]}),e.jsx(E,{control:r,name:`methods.${a}.is_active`,render:({field:o})=>e.jsx(A,{children:e.jsx(M,{children:e.jsx(oe,{checked:o.value,onCheckedChange:o.onChange})})})})]}),Ce=()=>{const n=W(),{userRestaurantId:a}=ne(),{data:r,isLoading:g}=T({queryKey:["paymentSettings",a],queryFn:()=>me(a),enabled:!!a}),{data:o,isLoading:f,refetch:J}=T({queryKey:["paymentMethods",a],queryFn:()=>Q(a),enabled:!!a}),m=I({resolver:D(de),defaultValues:{mercado_pago_public_key:"",mercado_pago_access_token:""},mode:"onBlur"});k.useEffect(()=>{r&&m.reset({mercado_pago_public_key:r.mercado_pago_public_key||"",mercado_pago_access_token:r.mercado_pago_access_token||""})},[r,m]);const y=_({mutationFn:async s=>{if(!a)throw new Error("ID do restaurante não disponível.");const i=await u.functions.invoke("save-mp-credentials",{body:JSON.stringify({restaurant_id:a,public_key:s.mercado_pago_public_key,access_token:s.mercado_pago_access_token})});if(i.error)throw new Error(i.error.message);return i.data},onSuccess:s=>{p.success(s.message),n.invalidateQueries({queryKey:["paymentSettings",a]}),n.invalidateQueries({queryKey:["mercadoPagoPublicKey"]})},onError:s=>{p.error(`Erro ao salvar credenciais: ${s.message}`)}}),X=s=>{y.mutate(s)},j=_({mutationFn:async s=>{const i=await Q(s),d=new Set(i.map(t=>t.name)),l=xe.filter(t=>!d.has(t.name)).map(t=>({restaurant_id:s,name:t.name,description:t.description,icon:t.icon.displayName,is_active:!0}));if(l.length>0){const{error:t}=await u.from("payment_methods").insert(l);if(t)throw new Error(t.message);await J()}},onError:s=>{console.error("Erro ao garantir métodos padrão:",s)}});k.useEffect(()=>{a&&o&&o.length===0&&!f&&j.mutate(a)},[a,o,f,j]);const x=I({resolver:D(le),defaultValues:{methods:[]},mode:"onBlur"});k.useEffect(()=>{o&&o.length>0&&x.reset({methods:o.map(s=>({id:s.id,is_active:s.is_active??!0}))})},[o,x]);const b=_({mutationFn:async s=>{const i=s.methods.map(t=>u.from("payment_methods").update({is_active:t.is_active}).eq("id",t.id)),l=(await Promise.all(i)).filter(t=>t.error).map(t=>{var q;return(q=t.error)==null?void 0:q.message}).join(", ");if(l)throw new Error(l)},onSuccess:()=>{p.success("Configurações de métodos de pagamento salvas!"),n.invalidateQueries({queryKey:["paymentMethods",a]})},onError:s=>{p.error(`Erro ao salvar métodos: ${s.message}`)}}),z=s=>{b.mutate(s)};if(!a)return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8",children:e.jsxs(v,{className:"max-w-md text-center mx-auto",children:[e.jsx(w,{children:e.jsx(N,{children:"Erro de Configuração"})}),e.jsx(P,{children:e.jsx("p",{className:"text-muted-foreground",children:"ID do restaurante não encontrado. Por favor, recarregue a página."})})]})});const F=g||f,h=!!(r!=null&&r.mercado_pago_public_key)&&!!(r!=null&&r.mercado_pago_access_token);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-8",children:[e.jsxs(v,{children:[e.jsxs(w,{children:[e.jsx(N,{className:"text-2xl font-bold flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-6 w-6 text-primary"}),"Credenciais Mercado Pago"]})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure suas chaves de API do Mercado Pago para aceitar pagamentos online."})]}),e.jsx(P,{children:F?e.jsxs("div",{className:"space-y-4",children:[e.jsx(c,{className:"h-4 w-1/4"}),e.jsx(c,{className:"h-10 w-full"}),e.jsx(c,{className:"h-4 w-1/4"}),e.jsx(c,{className:"h-10 w-full"}),e.jsx(c,{className:"h-12 w-full mt-4"})]}):e.jsx(O,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(X),className:"space-y-6",children:[e.jsxs(ee,{variant:h?"default":"destructive",children:[h?e.jsx(se,{className:"h-4 w-4 text-green-500"}):e.jsx(ae,{className:"h-4 w-4"}),e.jsx(re,{children:h?"Pagamento Online Configurado!":"Ação Necessária: Credenciais Incompletas!"}),e.jsxs(te,{children:[h?"As chaves pública e de acesso foram salvas. O pagamento online está ativo.":"Por favor, insira suas chaves de Public Key e Access Token de Produção do Mercado Pago para ativar o pagamento online.",e.jsx("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:e.jsxs("li",{children:[e.jsx("a",{href:"https://www.mercadopago.com.br/developers/panel/credentials",target:"_blank",rel:"noopener noreferrer",className:"font-bold underline",children:"Obtenha suas credenciais de Produção"})," no painel do Mercado Pago."]})})]})]}),e.jsx(E,{control:m.control,name:"mercado_pago_public_key",render:({field:s})=>e.jsxs(A,{children:[e.jsx(R,{children:"Public Key *"}),e.jsx(M,{children:e.jsx(K,{...s,placeholder:"APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta chave é pública e usada no checkout do cliente."}),e.jsx(B,{})]})}),e.jsx(E,{control:m.control,name:"mercado_pago_access_token",render:({field:s})=>e.jsxs(A,{children:[e.jsx(R,{children:"Access Token *"}),e.jsx(M,{children:e.jsx(K,{...s,type:"password",placeholder:"Cole seu Access Token aqui",className:"h-12"})}),e.jsx("p",{className:"text-xs text-destructive font-semibold",children:"AVISO DE SEGURANÇA: Este token é secreto e será salvo no banco de dados. Garanta que seu RLS esteja ativo."}),e.jsx(B,{})]})}),e.jsx(L,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:y.isPending||!a,children:y.isPending?"Salvando...":"Salvar Credenciais"})]})})})]}),e.jsxs(v,{children:[e.jsxs(w,{children:[e.jsx(N,{className:"text-2xl font-bold",children:"Métodos de Pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ative ou desative os métodos de pagamento aceitos pelo seu estabelecimento."})]}),e.jsx(P,{children:F||j.isPending?e.jsxs("div",{className:"space-y-4",children:[[...Array(4)].map((s,i)=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(c,{className:"h-10 w-10 rounded-md"}),e.jsxs("div",{children:[e.jsx(c,{className:"h-4 w-32 mb-1"}),e.jsx(c,{className:"h-3 w-48"})]})]}),e.jsx(c,{className:"h-6 w-10 rounded-full"})]},i)),e.jsx(c,{className:"h-12 w-full mt-4"})]}):e.jsx(O,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(z),className:"space-y-4",children:[x.watch("methods").map((s,i)=>{const d=o==null?void 0:o.find(t=>t.id===s.id),l=d!=null&&d.icon?ue(d.icon):V;return e.jsx(he,{method:d,index:i,control:x.control,icon:l},s.id)}),e.jsx(L,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:b.isPending||!a,children:b.isPending?"Salvando...":"Salvar Configurações"})]})})})]})]})})};export{Ce as default};
