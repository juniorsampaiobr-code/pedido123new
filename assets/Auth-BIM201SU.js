import{u as W,j as e}from"./tanstack-d4AvmB45.js";import{u as G,h as X,r as o}from"./vendor-CnEXr6gt.js";import{L as Y}from"./Logo-D3s2yFWH.js";import{B as g}from"./button-C3LCGBt_.js";import{L as d,I as N}from"./label-B0XVMVo7.js";import{C as Z,b as ee,c as ae,d as re,a as te}from"./card-CbzoTecv.js";import{b as se,L as R,u as s}from"./index-BjIwDNSh.js";import{s as m}from"./client-D5i5GwB9.js";import{M as oe,P as ne}from"./PhoneInput-CTk5FLgV.js";import{u as ie}from"./use-active-restaurant-id-BTmejl03.js";import{C as ce}from"./CpfCnpjInput-xxlL6JHr.js";import{A as le}from"./arrow-left-qCgNz1ns.js";import"./shopping-cart-CqBOgfsj.js";import"./supabase-BZV_3FV3.js";const _=i=>i.replace(/\D/g,""),A=i=>i.replace(/\D/g,""),Pe=()=>{var q;const i=G(),x=X(),E=W(),[j,c]=o.useState(!1),[l,z]=o.useState(!1),[C,y]=o.useState(!1),[u,w]=o.useState(""),[v,J]=o.useState(""),[b,O]=o.useState(""),[S,T]=o.useState(""),[P,Q]=o.useState(""),[ue,F]=o.useState(null),[de,k]=o.useState(null),{data:I,isLoading:p}=ie(),h=(q=x.state)==null?void 0:q.restaurantId,L=(t,r)=>{var f;const a=(f=x.state)==null?void 0:f.from,n=r||I;a==="/checkout"?(console.log("User logged in, redirecting to checkout."),i("/checkout",{replace:!0,state:{restaurantId:h}})):n?(console.log("User logged in, redirecting to specific menu:",n),i(`/menu/${n}`,{replace:!0})):(console.log("User logged in, no active restaurant found, redirecting to index."),i("/",{replace:!0}))};o.useEffect(()=>{if(p)return;const{data:{subscription:t}}=m.auth.onAuthStateChange((r,a)=>{k(a),F((a==null?void 0:a.user)??null),a!=null&&a.user&&L(a.user,h)});return m.auth.getSession().then(({data:{session:r}})=>{k(r),F((r==null?void 0:r.user)??null),r!=null&&r.user&&L(r.user,h)}),()=>t.unsubscribe()},[i,x.state,p,I,h]);const V=()=>{if(!b.trim())return s.error("O Nome Completo é obrigatório."),!1;if(_(S).length!==11)return s.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1;const r=A(P);return r.length!==11&&r.length!==14?(s.error("O CPF deve ter 11 dígitos ou CNPJ 14 dígitos."),!1):u.trim()?v.length<6?(s.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(s.error("O Email é obrigatório."),!1)},B=async t=>{var r;if(t.preventDefault(),c(!0),((r=x.state)==null?void 0:r.from)==="/checkout"&&!h){s.error("Erro: ID do restaurante de origem não encontrado."),c(!1);return}try{if(l){if(!V()){c(!1);return}const a=_(S),n=A(P),{data:f,error:U}=await m.rpc("check_registration_data",{phone_in:a,cpf_cnpj_in:n});if(U)console.error("Erro ao verificar dados:",U);else if(f){const{phone_exists:$,cpf_exists:H}=f;if($){s.error("Este telefone já está cadastrado em outra conta."),c(!1);return}if(H){s.error("Este CPF/CNPJ já está cadastrado em outra conta."),c(!1);return}}const{data:M,error:D}=await m.auth.signUp({email:u,password:v,options:{data:{full_name:b,phone:a,cpf_cnpj:n}}});if(D)throw D;M.session?(s.success("Conta criada e login efetuado com sucesso!"),E.invalidateQueries({queryKey:["authStatus"]})):s.success("Conta criada! Verifique seu email para confirmar.")}else{const{error:a}=await m.auth.signInWithPassword({email:u,password:v});if(a)throw a;s.success("Login realizado com sucesso!"),E.invalidateQueries({queryKey:["authStatus"]})}}catch(a){a.message.includes("Email not confirmed")?s.error("Por favor, verifique seu e-mail para confirmar sua conta antes de fazer login."):s.error(a.message||"Erro ao processar autenticação")}finally{c(!1)}},K=async t=>{if(t.preventDefault(),!u.trim()){s.error("O Email é obrigatório para recuperação de senha.");return}c(!0);try{const a=`${window.location.origin+window.location.pathname}#/password-recovery`,{error:n}=await m.auth.resetPasswordForEmail(u,{redirectTo:a});if(n)throw n;s.success("Email de recuperação enviado!",{description:"Verifique sua caixa de entrada (e spam) para o link de redefinição de senha.",duration:8e3}),y(!1)}catch(r){s.error(r.message||"Erro ao enviar email de recuperação.")}finally{c(!1)}};return p?e.jsx(se,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(Y,{className:"justify-center mb-4"})}),e.jsxs(Z,{className:"shadow-xl border-2",children:[e.jsxs(ee,{className:"space-y-1",children:[e.jsx(ae,{className:"text-2xl font-bold text-center",children:C?"Recuperar Senha":l?"Crie sua conta":"Acesse sua conta"}),e.jsx(re,{className:"text-center",children:C?"Digite seu email para receber o link de redefinição.":l?"Preencha os campos para começar":"Utilize seu email e senha para fazer login"})]}),e.jsx(te,{className:"space-y-4",children:C?e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"email",children:"Email *"}),e.jsx(N,{id:"email",type:"email",placeholder:"seu@email.com",value:u,onChange:t=>w(t.target.value),required:!0,className:"h-12"})]}),e.jsxs(g,{type:"submit",className:"w-full",size:"lg",disabled:j,children:[j?e.jsx(R,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Enviar Link de Recuperação"]}),e.jsx("div",{className:"text-center",children:e.jsxs(g,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{y(!1),w("")},children:[e.jsx(le,{className:"h-4 w-4 mr-1"})," Voltar para o Login"]})})]}):e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[l&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(N,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:b,onChange:t=>O(t.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"phone",children:"Telefone *"}),e.jsx(ne,{id:"phone",value:S,onChange:t=>T(t.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"cpfCnpj",children:"CPF/CNPJ *"}),e.jsx(ce,{id:"cpfCnpj",value:P,onChange:t=>Q(t.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"CPF (11 dígitos) ou CNPJ (14 dígitos)."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"email",children:"Email *"}),e.jsx(N,{id:"email",type:"email",placeholder:"seu@email.com",value:u,onChange:t=>w(t.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"password",children:"Senha *"}),e.jsx(N,{id:"password",type:"password",placeholder:"••••••••",value:v,onChange:t=>J(t.target.value),required:!0,className:"h-12"})]}),!l&&e.jsx("div",{className:"text-right",children:e.jsx(g,{variant:"link",type:"button",className:"p-0 h-auto text-sm text-muted-foreground hover:text-primary",onClick:()=>y(!0),children:"Esqueci minha senha"})}),e.jsx(g,{type:"submit",className:"w-full",size:"lg",disabled:j||p,children:j||p?e.jsx(R,{className:"h-4 w-4 animate-spin mr-2"}):l?"Criar conta":"Entrar"}),e.jsx("div",{className:"text-center",children:e.jsx(g,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>z(!l),children:l?"Já tem uma conta? Faça login":"Não tem uma conta? Crie uma agora"})})]})})]})]})})};export{Pe as default};
