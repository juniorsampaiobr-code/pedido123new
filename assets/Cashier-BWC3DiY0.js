import{a as B,u as N,b as S,j as e}from"./tanstack-C7aOFagJ.js";import{c as $,o as T,H as O,l as q,k,n as C,N as P,O as Q,Q as U,R as K,a6 as H,C as A,e as R,f as D,b as I,h as f,I as j,B as E,t as F,s as i,j as x}from"./index-BorbfsTh.js";import{S as o}from"./skeleton-OIYoRHYQ.js";import{j as M}from"./vendor-DjsPZZVP.js";import{C as V}from"./calendar-D_oPXe0Q.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=$("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),z=T({opening_balance:O(a=>String(a).replace(",","."),q.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo inicial não pode ser negativo."))}),J=T({closing_balance:O(a=>String(a).replace(",","."),q.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo final não pode ser negativo.")),notes:k().optional()}),W=async a=>{const{data:{session:n}}=await i.auth.getSession();if(!n)throw new Error("Usuário não autenticado");const{data:s,error:l}=await i.from("cash_register").select("*").eq("restaurant_id",a).is("closed_at",null).order("opened_at",{ascending:!1}).limit(1).single();if(l&&l.code!=="PGRST116")throw new Error(`Erro ao buscar caixa: ${l.message}`);return s||null},X=async()=>0,y=({title:a,value:n,icon:s})=>e.jsxs(A,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:a}),e.jsx(s,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsx("div",{className:"text-2xl font-bold",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n)})})]}),ne=()=>{const{userRestaurantId:a}=M(),n=B(),{data:s,isLoading:l,isError:L,error:_}=N({queryKey:["currentCashier",a],queryFn:()=>W(a),enabled:!!a}),{data:w=0}=N({queryKey:["salesToday",s==null?void 0:s.opened_at],queryFn:X,enabled:!!s}),p=((s==null?void 0:s.opening_balance)||0)+w,u=!!s,c=C({resolver:F(z),defaultValues:{opening_balance:0}}),t=C({resolver:F(J),defaultValues:{closing_balance:p,notes:""},values:{closing_balance:p,notes:""}}),h=S({mutationFn:async r=>{const{data:{user:d}}=await i.auth.getUser();if(!a||!d)throw new Error("Dados de usuário ou restaurante indisponíveis.");const b={restaurant_id:a,opening_balance:r.opening_balance,opened_by:d.id},{error:m}=await i.from("cash_register").insert(b);if(m)throw new Error(m.message)},onSuccess:()=>{x.success("Caixa aberto com sucesso!"),n.invalidateQueries({queryKey:["currentCashier",a]}),c.reset({opening_balance:0})},onError:r=>{x.error(`Erro ao abrir caixa: ${r.message}`)}}),g=S({mutationFn:async r=>{const{data:{user:d}}=await i.auth.getUser();if(!(s!=null&&s.id)||!d)throw new Error("Nenhum caixa aberto para fechar.");const b={closed_at:new Date().toISOString(),closed_by:d.id,closing_balance:r.closing_balance,notes:r.notes},{error:m}=await i.from("cash_register").update(b).eq("id",s.id);if(m)throw new Error(m.message)},onSuccess:()=>{x.success("Caixa fechado com sucesso!"),n.invalidateQueries({queryKey:["currentCashier",a]}),t.reset()},onError:r=>{x.error(`Erro ao fechar caixa: ${r.message}`)}}),v=l||!a;return e.jsxs("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:[L&&e.jsxs(P,{variant:"destructive",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(U,{children:"Erro ao carregar caixa"}),e.jsx(K,{children:_ instanceof Error?_.message:"Ocorreu um erro desconhecido."})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:v?e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"h-28 w-full"}),e.jsx(o,{className:"h-28 w-full"}),e.jsx(o,{className:"h-28 w-full"})]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{title:"Saldo Inicial",value:(s==null?void 0:s.opening_balance)||0,icon:H}),e.jsx(y,{title:"Vendas Hoje",value:w,icon:G}),e.jsx(y,{title:"Saldo Atual",value:p,icon:V})]})}),e.jsxs(A,{className:"max-w-3xl mx-auto",children:[e.jsxs(R,{children:[e.jsx(D,{className:"text-2xl font-bold",children:"Controle de Caixa"}),e.jsxs("p",{className:`text-sm font-medium ${u?"text-green-600":"text-destructive"}`,children:["Caixa está ",u?"aberto":"fechado"]}),u&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Aberto em: ",new Date(s.opened_at).toLocaleString("pt-BR")]})]}),e.jsx(I,{children:v?e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{className:"h-10 w-1/3"}),e.jsx(o,{className:"h-12 w-full"}),e.jsx(o,{className:"h-12 w-full mt-4"})]}):u?e.jsxs("form",{onSubmit:t.handleSubmit(r=>g.mutate(r)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"closing_balance",children:"Saldo Final (R$)"}),e.jsx(j,{id:"closing_balance",type:"number",step:"0.01",...t.register("closing_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),t.formState.errors.closing_balance&&e.jsx("p",{className:"text-destructive text-sm",children:t.formState.errors.closing_balance.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"notes",children:"Observações (Opcional)"}),e.jsx(j,{id:"notes",...t.register("notes"),className:"h-12"})]}),e.jsx(E,{type:"submit",className:"w-full bg-destructive hover:bg-destructive/90 text-destructive-foreground h-12 text-lg",disabled:g.isPending||!a,children:g.isPending?"Fechando...":"Fechar Caixa"})]}):e.jsxs("form",{onSubmit:c.handleSubmit(r=>h.mutate(r)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"opening_balance",children:"Saldo Inicial (R$)"}),e.jsx(j,{id:"opening_balance",type:"number",step:"0.01",...c.register("opening_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),c.formState.errors.opening_balance&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.opening_balance.message})]}),e.jsx(E,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg",disabled:h.isPending||!a,children:h.isPending?"Abrindo...":"Abrir Caixa"})]})})]})]})};export{ne as default};
