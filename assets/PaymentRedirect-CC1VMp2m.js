import{u as $,j as e}from"./tanstack-C7aOFagJ.js";import{h as b,u as N,k as R,r as f}from"./vendor-DjsPZZVP.js";import{j as n,C as S,e as k,f as q,L,Y as M,b as T,s as E}from"./index-BoHGiz4G.js";import{C as O}from"./circle-alert-D7Z9t9kX.js";import"./supabase-BAEEEeUB.js";const V=async r=>{const{data:d,error:t}=await E.from("orders").select("*").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar pedido: ${t.message}`);if(!d)throw new Error("Pedido não encontrado.");return d},_=()=>{const r=b(),{orderId:d}=N(),[t]=R(),[v,s]=f.useState("Verificando status do pagamento..."),[h,i]=f.useState(!0),[p,u]=f.useState(!1);t.get("status");const I=t.get("external_reference"),C=t.get("restaurantId"),o=d||I,{data:c,isLoading:P}=$({queryKey:["paymentRedirectOrder",o],queryFn:()=>V(o),enabled:!!o,staleTime:0}),a=(c==null?void 0:c.restaurant_id)||C,y=g=>{g?r(`/menu/${g}`,{replace:!0}):r("/",{replace:!0})};return f.useEffect(()=>{if(!o){s("ID do pedido não encontrado na URL."),u(!0),i(!1),n.error("Erro de redirecionamento: ID do pedido ausente."),y(a);return}if(P)return;if(!c){s("Pedido não encontrado no banco de dados."),u(!0),i(!1),n.error("Erro: Pedido não existe."),y(a);return}(async()=>{i(!0),s("Confirmando pagamento com Mercado Pago...");try{const{data:m,error:j}=await E.functions.invoke("confirm-payment",{body:{orderId:o}});if(j){let x=j.message;throw x.includes("non-2xx status code")&&(x="Falha de comunicação com o servidor. Verifique se a função 'confirm-payment' está implantada."),new Error(x)}const l=m,w=`/order-success/${o}?status=${l.status}${a?`&restaurantId=${a}`:""}`;l.status==="approved"?(s("Pagamento Aprovado! Redirecionando..."),n.success("Pagamento aprovado!"),r(w,{replace:!0})):l.status==="pending"?(s("Pagamento Pendente. Aguardando confirmação..."),n.warning("Pagamento pendente. Você será notificado quando for confirmado."),r(w,{replace:!0})):(s(`Pagamento Recusado. Status: ${l.status}`),n.error("Pagamento recusado. Tente novamente."),u(!0),r(`/checkout${a?`?restaurantId=${a}`:""}`,{replace:!0}))}catch(m){console.error("Erro na confirmação de pagamento:",m),s(`Erro ao processar pagamento: ${m.message}`),u(!0),i(!1),n.error("Erro ao processar pagamento. Tente novamente."),r(`/checkout${a?`?restaurantId=${a}`:""}`,{replace:!0})}})()},[o,P,c,r,t,a]),e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-muted",children:e.jsxs(S,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(k,{children:e.jsxs(q,{className:"text-2xl font-bold flex items-center justify-center gap-2",children:[h?e.jsx(L,{className:"h-6 w-6 animate-spin text-primary"}):p?e.jsx(O,{className:"h-6 w-6 text-destructive"}):e.jsx(M,{className:"h-6 w-6 text-green-500"}),h?"Processando Pagamento":p?"Erro de Pagamento":"Redirecionando..."]})}),e.jsxs(T,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:v}),p&&e.jsx("div",{className:"mt-4",children:e.jsx("p",{className:"text-sm text-destructive",children:"Você será redirecionado em breve."})})]})]})})};export{_ as default};
