import{c as W,e as Y,r as w,j as e,L as Z,a as h}from"./index-zkuE9Bm6.js";import{u as v}from"./useQuery-Bop5DQT3.js";import{u as N}from"./useMutation-DTwKCpeC.js";import{o as E,s as F,a as ee,b as se,u as D,t as K}from"./types-BjVHfDxe.js";import{s as u}from"./client-g0uDe16g.js";import{B as f}from"./button-3xZnEy7f.js";import{C as S,b as k,c as C,a as P}from"./card-B1F0wEox.js";import{I as A}from"./label-CD9lqJez.js";import{S as ae}from"./switch-D1y-lj2Q.js";import{F as R,b as I,c as q,a as B,d as M,e as Q}from"./form-gGgYvqwv.js";import{S as d}from"./skeleton-CBZEqJVS.js";import{E as re}from"./external-link-elpQlLqU.js";import{S as V,a as X}from"./store-BJpMroAj.js";import{P as $}from"./package-BjiMSLe_.js";import{C as H}from"./credit-card-CwfrA48D.js";import{D as z}from"./dollar-sign-MxpQT_7w.js";import"./index-CSKTzlwz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=W("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]),oe=E({mercado_pago_public_key:F().optional(),mercado_pago_access_token:F().optional()}),ne=E({methods:ee(E({id:F(),is_active:se()}))}),ie=async()=>{const{data:t,error:a}=await u.from("restaurants").select("id").limit(1).single();if(a)throw new Error(a.message);return t.id},ce=async t=>{const{data:a,error:i}=await u.from("payment_settings").select("*").eq("restaurant_id",t).limit(1).single();if(i&&i.code!=="PGRST116")throw new Error(i.message);return a},O=async t=>{const{data:a,error:i}=await u.from("payment_methods").select("*").eq("restaurant_id",t).order("name",{ascending:!0});if(i)throw new Error(i.message);return a},de=[{name:"Dinheiro",description:"Pagamento em dinheiro na entrega",icon:z},{name:"PIX",description:"Pagamento via PIX",icon:X},{name:"Pagamento Online",description:"Pagamento online via cartão de crédito ou PIX",icon:H},{name:"Pagamento com cartão na entrega",description:"Aceita pagamento com cartão de débito ou crédito na entrega",icon:$}],me=t=>{switch(t){case"DollarSign":return z;case"Smartphone":return X;case"CreditCard":return H;case"Package":return $;default:return V}},le=({method:t,index:a,control:i,icon:p})=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(p,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description})]})]}),e.jsx(I,{control:i,name:`methods.${a}.is_active`,render:({field:g})=>e.jsx(q,{children:e.jsx(M,{children:e.jsx(ae,{checked:g.value,onCheckedChange:g.onChange})})})})]}),Ee=()=>{const t=Y(),{data:a,isLoading:i}=v({queryKey:["restaurantId"],queryFn:ie}),{data:p,isLoading:g}=v({queryKey:["paymentSettings",a],queryFn:()=>ce(a),enabled:!!a}),{data:c,isLoading:j,refetch:G}=v({queryKey:["paymentMethods",a],queryFn:()=>O(a),enabled:!!a}),m=D({resolver:K(oe),defaultValues:{mercado_pago_public_key:"",mercado_pago_access_token:""},mode:"onBlur"});w.useEffect(()=>{p&&m.reset({mercado_pago_public_key:p.mercado_pago_public_key||"",mercado_pago_access_token:""})},[p,m]);const y=N({mutationFn:async s=>{if(!a)throw new Error("ID do restaurante não disponível.");const o=await u.functions.invoke("save-mp-credentials",{body:JSON.stringify({restaurant_id:a,public_key:s.mercado_pago_public_key,access_token:s.mercado_pago_access_token})});if(o.error)throw new Error(o.error.message);const n=o.data;return n.token_verified||h.warning("Chave pública salva, mas o Access Token fornecido não corresponde ao segredo configurado. Verifique o token."),n},onSuccess:()=>{h.success("Credenciais do Mercado Pago salvas com sucesso!"),t.invalidateQueries({queryKey:["paymentSettings"]}),m.reset({mercado_pago_access_token:""})},onError:s=>{h.error(`Erro ao salvar credenciais: ${s.message}`)}}),J=s=>{y.mutate(s)},_=N({mutationFn:async s=>{const o=await O(s),n=new Set(o.map(r=>r.name)),l=de.filter(r=>!n.has(r.name)).map(r=>({restaurant_id:s,name:r.name,description:r.description,icon:r.icon.displayName,is_active:!0}));if(l.length>0){const{error:r}=await u.from("payment_methods").insert(l);if(r)throw new Error(r.message);await G()}},onError:s=>{console.error("Erro ao garantir métodos padrão:",s)}});w.useEffect(()=>{a&&c&&c.length===0&&!j&&_.mutate(a)},[a,c,j,_]);const x=D({resolver:K(ne),defaultValues:{methods:[]},mode:"onBlur"});w.useEffect(()=>{c&&c.length>0&&x.reset({methods:c.map(s=>({id:s.id,is_active:s.is_active??!0}))})},[c,x]);const b=N({mutationFn:async s=>{const o=s.methods.map(r=>u.from("payment_methods").update({is_active:r.is_active}).eq("id",r.id)),l=(await Promise.all(o)).filter(r=>r.error).map(r=>{var L;return(L=r.error)==null?void 0:L.message}).join(", ");if(l)throw new Error(l)},onSuccess:()=>{h.success("Configurações de métodos de pagamento salvas!"),t.invalidateQueries({queryKey:["paymentMethods"]})},onError:s=>{h.error(`Erro ao salvar métodos: ${s.message}`)}}),U=s=>{b.mutate(s)};if(i)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Carregando..."});if(!a)return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8",children:e.jsxs(S,{className:"max-w-md text-center mx-auto",children:[e.jsx(k,{children:e.jsx(C,{children:"Restaurante Não Encontrado"})}),e.jsxs(P,{children:[e.jsx("p",{className:"text-muted-foreground",children:"Não foi possível carregar o ID do restaurante. Por favor, verifique se o seu restaurante está configurado corretamente na página de Configurações."}),e.jsx(Z,{to:"/settings",children:e.jsx(f,{className:"mt-4",children:"Ir para Configurações"})})]})]})});const T=g||j;return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-8",children:[e.jsxs(S,{children:[e.jsxs(k,{children:[e.jsxs(C,{className:"text-2xl font-bold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-6 w-6 text-primary"}),"Credenciais Mercado Pago"]}),e.jsx("a",{href:"https://www.mercadopago.com.br/developers/panel/credentials",target:"_blank",rel:"noopener noreferrer",children:e.jsxs(f,{variant:"outline",size:"sm",children:["Pegue sua credencial do mercado pago aqui! ",e.jsx(re,{className:"h-4 w-4 ml-2"})]})})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure suas chaves de API do Mercado Pago"})]}),e.jsx(P,{children:T?e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-4 w-1/4"}),e.jsx(d,{className:"h-10 w-full"}),e.jsx(d,{className:"h-4 w-1/4"}),e.jsx(d,{className:"h-10 w-full"}),e.jsx(d,{className:"h-12 w-full mt-4"})]}):e.jsx(R,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(J),className:"space-y-4",children:[e.jsx(I,{control:m.control,name:"mercado_pago_public_key",render:({field:s})=>e.jsxs(q,{children:[e.jsx(B,{children:"Public Key"}),e.jsx(M,{children:e.jsx(A,{...s,placeholder:"TEST-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Chave pública para identificação da aplicação"}),e.jsx(Q,{})]})}),e.jsx(I,{control:m.control,name:"mercado_pago_access_token",render:({field:s})=>e.jsxs(q,{children:[e.jsx(B,{children:"Access Token"}),e.jsx(M,{children:e.jsx(A,{...s,type:"password",placeholder:"TEST-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Token de acesso para processar pagamentos (mantido em segredo)"}),e.jsx(Q,{})]})}),e.jsx(f,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:y.isPending,children:y.isPending?"Salvando...":"Salvar Credenciais"})]})})})]}),e.jsxs(S,{children:[e.jsxs(k,{children:[e.jsx(C,{className:"text-2xl font-bold",children:"Métodos de Pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure os métodos de pagamento aceitos pelo seu estabelecimento"})]}),e.jsx(P,{children:T||_.isPending?e.jsxs("div",{className:"space-y-4",children:[[...Array(4)].map((s,o)=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(d,{className:"h-10 w-10 rounded-md"}),e.jsxs("div",{children:[e.jsx(d,{className:"h-4 w-32 mb-1"}),e.jsx(d,{className:"h-3 w-48"})]})]}),e.jsx(d,{className:"h-6 w-10 rounded-full"})]},o)),e.jsx(d,{className:"h-12 w-full mt-4"})]}):e.jsx(R,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(U),className:"space-y-4",children:[x.watch("methods").map((s,o)=>{const n=c==null?void 0:c.find(r=>r.id===s.id),l=n!=null&&n.icon?me(n.icon):V;return e.jsx(le,{method:n,index:o,control:x.control,icon:l},s.id)}),e.jsx(f,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:b.isPending,children:b.isPending?"Salvando...":"Salvar Configurações"})]})})})]})]})})};export{Ee as default};
