import{u as oe,j as e,a as Ar,b as be}from"./tanstack-C7aOFagJ.js";import{r as m,h as kr,i as Dr,k as Tr,L as Ve}from"./vendor-DjsPZZVP.js";import{c as Gr,s as S,j as v,$ as Je,a0 as Se,a1 as xe,a2 as Ee,a3 as $r,a4 as qr,a9 as Vr,a5 as zr,a as ce,D as ze,q as Be,L as ie,r as Br,v as Kr,w as Ur,B as J,C as z,e as B,f as K,W as Ce,b as U,o as We,l as k,K as Qr,av as Zr,aw as Xr,u as Hr,p as Ke,O as H,Q as Ue,R as te,V as ne,d as Qe,a6 as Yr,ax as Jr,U as Ze,ay as Wr,h as F,I as Y,az as se,P as et,i as rt,Y as tt,aA as nt,a7 as at,T as st,t as Xe}from"./index-DZmFWvxX.js";import{c as er,R as ot,I as it}from"./index-q1IFKC1Q.js";import{u as ct}from"./index-C3WaO5Hu.js";import{S as He}from"./separator-CCC1mAuL.js";import{L as dt,Z as lt}from"./LazyMap-C6fQBgeb.js";import{C as rr}from"./credit-card-B-lhMCOu.js";import{T as Ne}from"./truck-CcneWaMW.js";import{C as fe}from"./circle-alert-Cm1lJpQ_.js";import{M as ut}from"./mail-BBYkkht7.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=Gr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),ft=async()=>{const{data:r,error:a}=await S.from("restaurants").select("id").limit(1).single();if(a||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const t=r.id,{data:o,error:c}=await S.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",t).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${c.message}`);return(o==null?void 0:o.mercado_pago_public_key)||null},tr=()=>oe({queryKey:["mercadoPagoPublicKey"],queryFn:ft,staleTime:1/0}),pt=(r,a,t,o)=>{const l=(t-r)*(Math.PI/180),u=(o-a)*(Math.PI/180),s=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(u/2)*Math.sin(u/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))},ht=async(r,a)=>{const t=r.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1&addressdetails=1`,c=new AbortController,l=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const u=await fetch(o,{signal:c.signal,headers:{"User-Agent":"Pedido123-App/1.0 (https://juniorsampaiobr-code.github.io/pedido123new/)"}});if(!u.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",u.status),null;const s=await u.json();if(s&&Array.isArray(s)&&s.length>0){const b=s[0],N=parseFloat(b.lat),w=parseFloat(b.lon);if(Number.isFinite(N)&&Number.isFinite(w))return console.log("LOG: geocodeAddress - Geocodificação bem-sucedida. Coordenadas:",[N,w]),{lat:N,lng:w}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",t),v.error("Não foi possível encontrar o endereço. Verifique todos os campos e tente novamente."),null}catch(u){return u instanceof Error&&u.name==="AbortError"?(console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",t),v.error("A requisição para encontrar o endereço demorou muito. Tente novamente.")):(console.error("LOG: geocodeAddress - Erro durante a requisição:",u),v.error("Ocorreu um erro ao buscar o endereço. Tente novamente.")),null}finally{clearTimeout(l)}},xt=(r,a,t)=>{const o=pt(a[0],a[1],r[0],r[1]),c=t.find(l=>o<=l.max_distance_km);if(c){const l=c.delivery_fee||0,u=c.min_delivery_time_minutes||0,s=u+15;return{fee:parseFloat(l.toFixed(2)),minTime:u,maxTime:s}}return null};var Pe="Radio",[gt,nr]=Je(Pe),[yt,jt]=gt(Pe),ar=m.forwardRef((r,a)=>{const{__scopeRadio:t,name:o,checked:c=!1,required:l,disabled:u,value:s="on",onCheck:b,form:N,...w}=r,[R,M]=m.useState(null),C=Se(a,D=>M(D)),P=m.useRef(!1),L=R?N||!!R.closest("form"):!0;return e.jsxs(yt,{scope:t,checked:c,disabled:u,children:[e.jsx(xe.button,{type:"button",role:"radio","aria-checked":c,"data-state":cr(c),"data-disabled":u?"":void 0,disabled:u,value:s,...w,ref:C,onClick:Ee(r.onClick,D=>{c||b==null||b(),L&&(P.current=D.isPropagationStopped(),P.current||D.stopPropagation())})}),L&&e.jsx(ir,{control:R,bubbles:!P.current,name:o,value:s,checked:c,required:l,disabled:u,form:N,style:{transform:"translateX(-100%)"}})]})});ar.displayName=Pe;var sr="RadioIndicator",or=m.forwardRef((r,a)=>{const{__scopeRadio:t,forceMount:o,...c}=r,l=jt(sr,t);return e.jsx($r,{present:o||l.checked,children:e.jsx(xe.span,{"data-state":cr(l.checked),"data-disabled":l.disabled?"":void 0,...c,ref:a})})});or.displayName=sr;var vt="RadioBubbleInput",ir=m.forwardRef(({__scopeRadio:r,control:a,checked:t,bubbles:o=!0,...c},l)=>{const u=m.useRef(null),s=Se(u,l),b=ct(t),N=qr(a);return m.useEffect(()=>{const w=u.current;if(!w)return;const R=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(R,"checked").set;if(b!==t&&C){const P=new Event("click",{bubbles:o});C.call(w,t),w.dispatchEvent(P)}},[b,t,o]),e.jsx(xe.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...c,tabIndex:-1,ref:s,style:{...c.style,...N,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ir.displayName=vt;function cr(r){return r?"checked":"unchecked"}var wt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ge="RadioGroup",[_t,an]=Je(ge,[er,nr]),dr=er(),lr=nr(),[bt,Nt]=_t(ge),ur=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,name:o,defaultValue:c,value:l,required:u=!1,disabled:s=!1,orientation:b,dir:N,loop:w=!0,onValueChange:R,...M}=r,C=dr(t),P=Vr(N),[L,D]=zr({prop:l,defaultProp:c??null,onChange:R,caller:ge});return e.jsx(bt,{scope:t,name:o,required:u,disabled:s,value:L,onValueChange:D,children:e.jsx(ot,{asChild:!0,...C,orientation:b,dir:P,loop:w,children:e.jsx(xe.div,{role:"radiogroup","aria-required":u,"aria-orientation":b,"data-disabled":s?"":void 0,dir:P,...M,ref:a})})})});ur.displayName=ge;var mr="RadioGroupItem",fr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,disabled:o,...c}=r,l=Nt(mr,t),u=l.disabled||o,s=dr(t),b=lr(t),N=m.useRef(null),w=Se(a,N),R=l.value===c.value,M=m.useRef(!1);return m.useEffect(()=>{const C=L=>{wt.includes(L.key)&&(M.current=!0)},P=()=>M.current=!1;return document.addEventListener("keydown",C),document.addEventListener("keyup",P),()=>{document.removeEventListener("keydown",C),document.removeEventListener("keyup",P)}},[]),e.jsx(it,{asChild:!0,...s,focusable:!u,active:R,children:e.jsx(ar,{disabled:u,required:l.required,checked:R,...b,...c,name:l.name,ref:w,onCheck:()=>l.onValueChange(c.value),onKeyDown:Ee(C=>{C.key==="Enter"&&C.preventDefault()}),onFocus:Ee(c.onFocus,()=>{var C;M.current&&((C=N.current)==null||C.click())})})})});fr.displayName=mr;var Et="RadioGroupIndicator",pr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,...o}=r,c=lr(t);return e.jsx(or,{...c,...o,ref:a})});pr.displayName=Et;var hr=ur,xr=fr,Ct=pr;const Re=m.forwardRef(({className:r,...a},t)=>e.jsx(hr,{className:ce("grid gap-2",r),...a,ref:t}));Re.displayName=hr.displayName;const he=m.forwardRef(({className:r,...a},t)=>e.jsx(xr,{ref:t,className:ce("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(Ct,{className:"flex items-center justify-center",children:e.jsx(mt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));he.displayName=xr.displayName;var Ie={};Object.defineProperty(Ie,"__esModule",{value:!0});var gr=Ie.loadMercadoPago=void 0;const yr="https://sdk.mercadopago.com/js/v2",Rt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Ye="MercadoPago has already been initialized in your window, please remove the duplicate import",St="MercadoPago.js not available",Pt="Failed to load MercadoPago.js",It=()=>{for(var r=document.querySelectorAll(`script[src^="${yr}"`),a=0;a<r.length;a++){var t=r[a];if(Rt.test(t.src))return t}return null},Mt=()=>{const r=document.createElement("script");r.src=yr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let pe=null;const Ot=()=>(pe!==null||(pe=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(Ye),r(window.MercadoPago);return}try{let t=It();t?console.warn(Ye):t||(t=Mt()),t.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(St))}),t.addEventListener("error",()=>{a(new Error(Pt))})}catch(t){a(t);return}})),pe);gr=Ie.loadMercadoPago=Ot;var Lt=function(r,a,t,o){function c(l){return l instanceof t?l:new t(function(u){u(l)})}return new(t||(t=Promise))(function(l,u){function s(w){try{N(o.next(w))}catch(R){u(R)}}function b(w){try{N(o.throw(w))}catch(R){u(R)}}function N(w){w.done?l(w.value):c(w.value).then(s,b)}N((o=o.apply(r,a||[])).next())})};class q{static getInstance(){return Lt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield gr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}q.publicKey=null;q.options={};q.instanceMercadoPago=void 0;q.loadedInstanceMercadoPago=!1;function Ft(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(o=>Object.prototype.hasOwnProperty.call(a,o)&&r[o]===a[o])}const At=(r,a)=>{const t=Object.assign(Object.assign({},a),{frontEndStack:"react"}),o=!Ft(q.options,t);(r!==q.publicKey||o)&&(q.publicKey=r,q.options=t,q.instanceMercadoPago=void 0)},kt=({preferenceId:r,initPoint:a,onClose:t})=>{const{data:o,isLoading:c}=tr();return m.useEffect(()=>{if(o)try{At(o,{locale:"pt-BR"})}catch(l){console.error("Erro ao inicializar Mercado Pago:",l),v.error("Erro ao carregar o SDK do Mercado Pago."),t();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[o,t,a]),c||!o?e.jsx(ze,{open:!0,onOpenChange:t,children:e.jsx(Be,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ie,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(ze,{open:!0,onOpenChange:t,children:e.jsxs(Be,{className:"sm:max-w-[425px]",children:[e.jsxs(Br,{children:[e.jsxs(Kr,{className:"flex items-center gap-2",children:[e.jsx(rr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Ur,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ie,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(J,{variant:"outline",onClick:t,children:"Cancelar e Voltar"})]})})},Dt=({latitude:r,longitude:a,address:t,className:o})=>{const c=m.useMemo(()=>[r,a],[r,a]),l=m.useMemo(()=>[r,a],[r,a]),u=m.useMemo(()=>`client-location-${r.toFixed(6)}-${a.toFixed(6)}`,[r,a]);return e.jsxs(z,{className:ce("w-full",o),children:[e.jsxs(B,{children:[e.jsxs(K,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t})]}),e.jsx(U,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(dt,{center:l,markerPosition:c,onMarkerDragEnd:()=>{},zoom:16},u)})})]})},Tt=We({zip_code:k().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:k().min(1,"Rua é obrigatória."),number:k().min(1,"Número é obrigatório."),neighborhood:k().min(1,"Bairro é obrigatório."),city:k().min(1,"Cidade é obrigatória.")}),Gt=We({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:k().email("Email inválido.").optional().or(Qr("")),cpf_cnpj:k().optional().default("").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Zr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:k().optional(),payment_method_id:k().min(1,"Selecione um método de pagamento."),change_for:k().optional()}),$t=async r=>{const{data:a,error:t}=await S.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},qt=async r=>{const{data:a,error:t}=await S.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return a},Vt=async r=>{const{data:a,error:t}=await S.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return a},zt=async r=>{const{data:a,error:t}=await S.from("customers").select("*").eq("user_id",r).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(t.message);return a||null},sn=()=>{var De,Te,Ge,$e,qe;const r=kr(),a=Dr(),[t]=Tr(),o=Ar(),{items:c,totalAmount:l,clearCart:u}=Xr(),{data:s,isLoading:b}=Hr(),{data:N}=tr(),[w,R]=m.useState(!1),[M,C]=m.useState(!1),[P,L]=m.useState(0),[D,W]=m.useState(null),[ye,Q]=m.useState(!0),[Z,je]=m.useState(null),[jr,ve]=m.useState(!1),[vr,wr]=m.useState(null),[Me,_r]=m.useState(null),[T,X]=m.useState(!1),br=(De=a.state)==null?void 0:De.restaurantId,Nr=t.get("restaurantId"),V=br||Nr;m.useEffect(()=>{console.log("LOG: Checkout - User Status:",s?`Logged in as ${s.email}`:"Anonymous")},[s]);const{data:y,isLoading:Er,isError:Cr,error:Oe,refetch:Rr}=oe({queryKey:["checkoutRestaurantData",V],queryFn:()=>$t(V),enabled:!!V,staleTime:1/0}),{data:de,isLoading:Sr}=oe({queryKey:["checkoutDeliveryZones",V],queryFn:()=>qt(y.id),enabled:!!y,staleTime:1/0}),{data:ee,isLoading:Pr}=oe({queryKey:["checkoutPaymentMethods",V],queryFn:()=>Vt(y.id),enabled:!!y,staleTime:1/0}),{data:x,isLoading:Le,refetch:Bt}=oe({queryKey:["checkoutCustomerData",s==null?void 0:s.id],queryFn:()=>zt(s.id),enabled:!!s,staleTime:0}),we=m.useMemo(()=>y!=null&&y.latitude&&(y!=null&&y.longitude)?[y.latitude,y.longitude]:null,[y]),_e=m.useCallback(async(n,i,f,j,g,p,I)=>{if(!y||!we||!y.delivery_enabled)return L(0),Q(!0),W(null),{coords:null,fee:0,time:null,isValid:!0};const E=`${i}, ${f}, ${g}, ${j}, ${n}`;let h=null;if(p&&I)h={lat:p,lng:I};else{C(!0);const A=v.loading("Calculando taxa de entrega...");h=await ht(E),C(!1),v.dismiss(A)}if(!h)return L(0),W(null),Q(!1),v.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(je([h.lat,h.lng]),de&&de.length>0){const A=xt([h.lat,h.lng],we,de);return A?(L(A.fee),W([A.minTime,A.maxTime]),Q(!0),{coords:h,fee:A.fee,time:[A.minTime,A.maxTime],isValid:!0}):(L(0),W(null),Q(!1),v.error("Endereço fora da área de entrega."),{coords:h,fee:0,time:null,isValid:!1})}else return L(0),W(null),Q(!0),{coords:h,fee:0,time:null,isValid:!0}},[y,we,de]),d=Ke({resolver:Xe(Gt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),_=Ke({resolver:Xe(Tt),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),G=d.watch("delivery_option"),Ir=d.watch("payment_method_id"),re=ee==null?void 0:ee.find(n=>n.id===Ir),le=(Te=re==null?void 0:re.name)==null?void 0:Te.includes("online"),ae=(Ge=re==null?void 0:re.name)==null?void 0:Ge.includes("Dinheiro"),$=l+P,O=_.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{G==="pickup"?(L(0),Q(!0),X(!0)):X(!1)},[G]),m.useEffect(()=>{if(x){let n="",i="",f="",j="",g="";if(x.address){const p=x.address.split(", ").map(I=>I.trim());p.length>=5?(n=p[0],i=p[1],f=p[2],j=p[3],g=p[4]):p.length>=4&&(n=p[0],f=p[1],j=p[2],g=p[3])}d.reset({...d.getValues(),name:x.name||"",phone:x.phone||"",email:x.email||"",cpf_cnpj:x.cpf_cnpj||"",change_for:""}),_.reset({zip_code:g,street:n,number:i,neighborhood:f,city:j}),x.address&&x.latitude&&x.longitude&&(je([x.latitude,x.longitude]),X(!0),_e(g,n,i,j,f,x.latitude,x.longitude))}else if(s&&!Le){const n=s.user_metadata;d.reset({...d.getValues(),name:n.full_name||"",phone:n.phone||"",email:s.email||"",cpf_cnpj:n.cpf_cnpj||"",change_for:""})}},[x,d,s,Le,_,_e]);const ue=d.watch("change_for");m.useEffect(()=>{if(ae&&ue&&ue.trim()!==""){const n=ue.replace(",","."),i=parseFloat(n);isNaN(i)?d.setError("change_for",{message:"O troco deve ser um número válido."}):i<$?d.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($)}).`}):d.clearErrors("change_for")}else d.clearErrors("change_for")},[ae,ue,$,d]);const me=be({mutationFn:async n=>{var p;const f=(p=(await S.auth.getUser()).data.user)==null?void 0:p.id;if(!(x!=null&&x.id)&&!f)throw new Error("ID do cliente ou usuário não encontrado.");const j=`${n.street}, ${n.number}, ${n.neighborhood}, ${n.city}, ${n.zip_code}`,g={user_id:(s==null?void 0:s.id)||null,name:d.getValues("name"),phone:d.getValues("phone"),email:d.getValues("email")||null,cpf_cnpj:d.getValues("cpf_cnpj")||null,address:j,latitude:n.lat,longitude:n.lng};if(x!=null&&x.id){const{data:I,error:E}=await S.from("customers").update(g).eq("id",x.id).select().single();if(E)throw E;return I}else if(f){const{data:I,error:E}=await S.from("customers").insert(g).select().single();if(E)throw E;return I}else return{id:"anonymous",user_id:null,name:g.name,phone:g.phone,email:g.email,address:j,created_at:"",updated_at:"",latitude:n.lat,longitude:n.lng,cpf_cnpj:g.cpf_cnpj}},onSuccess:(n,i)=>{n.id!=="anonymous"&&o.invalidateQueries({queryKey:["checkoutCustomerData"]}),L(i.fee),W(i.time),Q(i.isValid),X(!0),je([i.lat,i.lng]),v.success("Endereço salvo e taxa de entrega calculada!")},onError:n=>{v.error(`Erro ao salvar endereço: ${n.message}`),X(!1)}}),Mr=async()=>{if(G==="pickup")return;if(!await _.trigger()){v.error("Preencha todos os campos obrigatórios do endereço.");return}const i=_.getValues(),f=await _e(i.zip_code,i.street,i.number,i.city,i.neighborhood);if(!f.isValid){X(!1);return}if(!f.coords){v.error("Não foi possível obter as coordenadas para salvar o endereço."),X(!1);return}me.mutate({...i,lat:f.coords.lat,lng:f.coords.lng,fee:f.fee,time:f.time,isValid:f.isValid})},Fe=be({mutationFn:async n=>{var p,I;(p=(await S.auth.getUser()).data.user)==null||p.id;const f=n.phone.replace(/\D/g,""),j=((I=n.cpf_cnpj)==null?void 0:I.replace(/\D/g,""))||null,g={user_id:(s==null?void 0:s.id)||null,name:n.name,phone:f,email:n.email||null,cpf_cnpj:j,address:G==="delivery"?`${O[1]}, ${O[2]}, ${O[4]}, ${O[3]}, ${O[0]}`:null,latitude:Z?Z[0]:null,longitude:Z?Z[1]:null};if(s)if(x){const{data:E,error:h}=await S.from("customers").update(g).eq("id",x.id).select().single();if(h)throw h;return E}else{const{data:E,error:h}=await S.from("customers").insert(g).select().single();if(h)throw h;return E}else{const{data:E,error:h}=await S.from("customers").insert(g).select().single();if(h)throw h;return E}},onSuccess:()=>{o.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:n=>{v.error(`Erro ao salvar dados do cliente: ${n.message}`)}}),Ae=be({mutationFn:async({customerId:n,data:i})=>{if(!y)throw new Error("Dados do restaurante não disponíveis.");let f=null;if(ae&&i.change_for&&i.change_for.trim()!==""){const h=i.change_for.replace(",","."),A=parseFloat(h);!isNaN(A)&&A>$&&(f=A)}const j={restaurant_id:y.id,customer_id:n,status:le?"pending_payment":"pending",total_amount:$,delivery_fee:P,delivery_address:G==="delivery"?`${O[1]}, ${O[2]}, ${O[4]}, ${O[3]}, ${O[0]}`:null,notes:i.notes,payment_method_id:i.payment_method_id,change_for:f},{data:g,error:p}=await S.from("orders").insert(j).select("id").single();if(p)throw p;const I=c.map(h=>({order_id:g.id,product_id:h.product.id,quantity:h.quantity,unit_price:h.product.price,subtotal:h.subtotal,notes:h.notes})),{error:E}=await S.from("order_items").insert(I);if(E)throw E;return g.id},onSuccess:n=>{o.invalidateQueries({queryKey:["orders"]})},onError:n=>{v.error(`Erro ao criar pedido: ${n.message}`)}}),Or=async n=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",le),console.log("LOG: deliveryOption:",G),console.log("LOG: isAddressSaved:",T),console.log("LOG: change_for data:",n.change_for),ae&&n.change_for&&n.change_for.trim()!==""){const j=n.change_for.replace(",","."),g=parseFloat(j);if(isNaN(g)){v.error("O troco deve ser um número válido.");return}if(g<$){d.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($)}).`});return}}if(c.length===0){v.error("Seu carrinho está vazio."),r("/menu");return}if(G==="delivery"){if(!T){v.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!ye){v.error("O endereço de entrega está fora da área de cobertura.");return}}let i;try{console.log("LOG: Criando/Atualizando cliente..."),i=(await Fe.mutateAsync(n)).id,console.log("LOG: Cliente ID:",i)}catch(j){v.error(`Falha ao salvar cliente: ${j.message}`);return}let f;try{console.log("LOG: Criando pedido..."),f=await Ae.mutateAsync({customerId:i,data:n}),console.log("LOG: Pedido ID:",f)}catch(j){v.error(`Falha ao criar pedido: ${j.message}`);return}le?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Lr(f,n)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),u(),r(`/order-success/${f}`,{replace:!0}))},Lr=async(n,i)=>{if(!y)return;const f=window.location.origin+window.location.pathname,j=c.map(p=>({name:p.product.name,price:p.product.price,quantity:p.quantity})),g=v.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:p,error:I}=await S.functions.invoke("create-payment-preference",{body:{orderId:n,items:j,totalAmount:$,restaurantName:y.name,clientUrl:f,customerEmail:i.email||(s==null?void 0:s.email)||"cliente@anonimo.com",customerCpfCnpj:i.cpf_cnpj}});if(I)throw I;const{init_point:E}=p;console.log("LOG: Preferência MP criada. init_point:",E),wr(n),_r(E),ve(!0),v.dismiss(g)}catch(p){console.error("Erro ao criar preferência MP:",p),v.dismiss(g),v.error(`Erro no pagamento online: ${p.message}`),ve(!1)}},Fr=async()=>{await S.auth.signOut(),v.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!V)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(H,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx(te,{children:"Erro de Rastreamento"}),e.jsx(ne,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Ve,{to:"/",children:e.jsx(J,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(c.length===0)return m.useEffect(()=>{r(`/menu/${V}`)},[r,V]),e.jsx(Qe,{});if(Er||Sr||Pr||b)return e.jsx(Qe,{});if(Cr||!y)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(H,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx(te,{children:"Erro Crítico"}),e.jsx(ne,{children:Oe instanceof Error?Oe.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(J,{onClick:()=>Rr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Yr,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const ke=Fe.isPending||Ae.isPending||me.isPending||M||G==="delivery"&&!T;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Jr,{isOpen:w,onClose:()=>R(!1),customer:x}),jr&&Me&&e.jsx(kt,{preferenceId:vr,initPoint:Me,onClose:()=>ve(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:y.name})]}),s&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{variant:"outline",size:"icon",onClick:()=>R(!0),"aria-label":"Meu Perfil",children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsxs(J,{variant:"outline",size:"sm",onClick:Fr,children:[e.jsx(Wr,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(z,{children:[e.jsx(B,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ze,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(U,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:s?`Logado como ${s.email}. ${x?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:d.handleSubmit(Or),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(Y,{id:"name",...d.register("name")}),d.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"phone",children:"Telefone *"}),e.jsx(se,{name:"phone",control:d.control,render:({field:n})=>e.jsx(et,{id:"phone",...n})}),d.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(Y,{id:"email",type:"email",...d.register("email")}),d.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(se,{name:"cpf_cnpj",control:d.control,render:({field:n})=>e.jsx(rt,{id:"cpf_cnpj",...n})}),d.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(z,{children:[e.jsx(B,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(U,{children:e.jsx(se,{name:"delivery_option",control:d.control,render:({field:n})=>e.jsxs(Re,{onValueChange:n.onChange,value:n.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(F,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(he,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(Ne,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(F,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(he,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ce,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),G==="delivery"&&e.jsxs(z,{className:ce(!T&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(B,{children:[e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",T&&e.jsx(tt,{className:"h-5 w-5 text-green-500 ml-2"}),!T&&e.jsx(fe,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(U,{className:"space-y-4",children:[!y.delivery_enabled&&e.jsxs(H,{variant:"destructive",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx(te,{children:"Entrega Desativada"}),e.jsx(ne,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),Mr()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(F,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(se,{name:"zip_code",control:_.control,render:({field:n})=>e.jsx(lt,{id:"zip_code",...n})}),_.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(F,{htmlFor:"street",children:"Rua *"}),e.jsx(Y,{id:"street",..._.register("street")}),_.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"number",children:"Número *"}),e.jsx(Y,{id:"number",..._.register("number")}),_.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(F,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(Y,{id:"neighborhood",..._.register("neighborhood")}),_.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"city",children:"Cidade *"}),e.jsx(Y,{id:"city",..._.register("city")}),_.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.city.message})]}),e.jsxs(J,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:me.isPending||M||!y.delivery_enabled,children:[me.isPending||M?e.jsx(ie,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(nt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),M&&e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),e.jsx(te,{children:"Calculando Taxa de Entrega..."})]}),!ye&&T&&!M&&e.jsxs(H,{variant:"destructive",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx(te,{children:"Fora da Área de Entrega"}),e.jsx(ne,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),D&&ye&&T&&!M&&e.jsxs(H,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(te,{children:"Entrega Disponível"}),e.jsxs(ne,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P),". Tempo estimado: ",D[0]," - ",D[1]," minutos."]})]}),T&&Z&&e.jsx("div",{className:"mt-6",children:e.jsx(Dt,{latitude:Z[0],longitude:Z[1],address:`${O[1]}, ${O[2]} - ${O[4]}, ${O[3]}, ${O[0]}`})})]})]}),e.jsxs(z,{children:[e.jsx(B,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(rr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(U,{children:[e.jsx(se,{name:"payment_method_id",control:d.control,render:({field:n})=>e.jsx(Re,{onValueChange:n.onChange,value:n.value,className:"space-y-3",children:ee==null?void 0:ee.map(i=>{var j;const f=((j=i.name)==null?void 0:j.includes("online"))&&!N;return e.jsx(F,{htmlFor:i.id,className:ce("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",f&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(he,{value:i.id,id:i.id,disabled:f}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.description}),f&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},i.id)})})}),d.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:d.formState.errors.payment_method_id.message})]})]}),ae&&e.jsxs(z,{children:[e.jsx(B,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(at,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(U,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(Y,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($),...d.register("change_for")}),(($e=d.formState.errors.change_for)==null?void 0:$e.message)&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message}),((qe=d.formState.errors.change_for)==null?void 0:qe.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message})]})})]}),e.jsxs(z,{children:[e.jsx(B,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(ut,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(U,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(st,{id:"notes",...d.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(z,{className:"shadow-lg",children:[e.jsx(B,{children:e.jsx(K,{className:"text-2xl",children:"Resumo"})}),e.jsxs(U,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[n.quantity,"x ",n.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.subtotal)})]},n.product.id))}),e.jsx(He,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P)})]})]}),e.jsx(He,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($)})]}),e.jsx(J,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:ke,children:ke?e.jsx(ie,{className:"h-5 w-5 animate-spin mr-2"}):le?"Pagar e Finalizar":"Confirmar Pedido"}),G==="delivery"&&!T&&e.jsxs(H,{variant:"destructive",className:"mt-3",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx(ne,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Ve,{to:`/menu/${y.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{sn as default};
