import{u as ae,j as e,a as Ar,b as _e}from"./tanstack-C7aOFagJ.js";import{r as u,h as kr,i as Dr,k as Tr,L as qe}from"./vendor-DjsPZZVP.js";import{c as Gr,s as S,$ as Je,a0 as Ce,a1 as he,a2 as Ne,a3 as qr,a4 as Vr,a9 as $r,a5 as Br,a as pe,j as w,D as Ve,q as $e,L as se,r as Kr,v as zr,w as Ur,B as X,o as Ye,l as L,K as Qr,aG as Zr,aH as Hr,u as Xr,p as Be,O as K,Q as Ke,R as ee,V as re,d as ze,a6 as Jr,aI as Yr,U as Ue,aJ as Wr,C as z,e as U,f as Q,b as Z,h as F,I as H,aK as ne,P as et,i as rt,W as Qe,Y as tt,aL as nt,a7 as at,T as st,t as Ze}from"./index-DMtKpBik.js";import{c as We,R as ot,I as it}from"./index-DE-tzuYU.js";import{u as ct}from"./index-C3WaO5Hu.js";import{S as He}from"./separator-C3uz5WHk.js";import{Z as dt}from"./ZipCodeInput-Bs8A3acZ.js";import{C as er}from"./credit-card-DfJj1ITY.js";import{T as be}from"./truck-CBUeKB8d.js";import{C as ue}from"./circle-alert-BTzT9-8S.js";import{M as lt}from"./mail-BAlVyBLP.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=Gr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),mt=async()=>{const{data:r,error:a}=await S.from("restaurants").select("id").limit(1).single();if(a||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const t=r.id,{data:o,error:d}=await S.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",t).limit(1).single();if(d&&d.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${d.message}`);return(o==null?void 0:o.mercado_pago_public_key)||null},rr=()=>ae({queryKey:["mercadoPagoPublicKey"],queryFn:mt,staleTime:1/0}),ft=(r,a,t,o)=>{const i=(t-r)*(Math.PI/180),p=(o-a)*(Math.PI/180),s=Math.sin(i/2)*Math.sin(i/2)+Math.cos(r*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(p/2)*Math.sin(p/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))},pt=async r=>{const a=r.replace(/\s+/g," ").trim(),t=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,o=new AbortController,d=setTimeout(()=>o.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",t);const i=await fetch(t,{signal:o.signal});if(!i.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",i.status),null;const p=await i.json();if(p&&Array.isArray(p)&&p.length>0){const s=p[0],_=parseFloat(s.lat),N=parseFloat(s.lon);if(Number.isFinite(_)&&Number.isFinite(N))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[_,N]),{lat:_,lng:N}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(i){return i instanceof Error&&i.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",i),null}finally{clearTimeout(d)}},ht=(r,a,t)=>{const o=ft(a[0],a[1],r[0],r[1]),d=t.find(i=>o<=i.max_distance_km);if(d){const i=d.delivery_fee||0,p=d.min_delivery_time_minutes||0,s=p+15;return{fee:parseFloat(i.toFixed(2)),minTime:p,maxTime:s}}return null};var Re="Radio",[xt,tr]=Je(Re),[gt,yt]=xt(Re),nr=u.forwardRef((r,a)=>{const{__scopeRadio:t,name:o,checked:d=!1,required:i,disabled:p,value:s="on",onCheck:_,form:N,...E}=r,[R,I]=u.useState(null),C=Ce(a,A=>I(A)),P=u.useRef(!1),O=R?N||!!R.closest("form"):!0;return e.jsxs(gt,{scope:t,checked:d,disabled:p,children:[e.jsx(he.button,{type:"button",role:"radio","aria-checked":d,"data-state":ir(d),"data-disabled":p?"":void 0,disabled:p,value:s,...E,ref:C,onClick:Ne(r.onClick,A=>{d||_==null||_(),O&&(P.current=A.isPropagationStopped(),P.current||A.stopPropagation())})}),O&&e.jsx(or,{control:R,bubbles:!P.current,name:o,value:s,checked:d,required:i,disabled:p,form:N,style:{transform:"translateX(-100%)"}})]})});nr.displayName=Re;var ar="RadioIndicator",sr=u.forwardRef((r,a)=>{const{__scopeRadio:t,forceMount:o,...d}=r,i=yt(ar,t);return e.jsx(qr,{present:o||i.checked,children:e.jsx(he.span,{"data-state":ir(i.checked),"data-disabled":i.disabled?"":void 0,...d,ref:a})})});sr.displayName=ar;var jt="RadioBubbleInput",or=u.forwardRef(({__scopeRadio:r,control:a,checked:t,bubbles:o=!0,...d},i)=>{const p=u.useRef(null),s=Ce(p,i),_=ct(t),N=Vr(a);return u.useEffect(()=>{const E=p.current;if(!E)return;const R=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(R,"checked").set;if(_!==t&&C){const P=new Event("click",{bubbles:o});C.call(E,t),E.dispatchEvent(P)}},[_,t,o]),e.jsx(he.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...d,tabIndex:-1,ref:s,style:{...d.style,...N,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});or.displayName=jt;function ir(r){return r?"checked":"unchecked"}var vt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],xe="RadioGroup",[wt,tn]=Je(xe,[We,tr]),cr=We(),dr=tr(),[_t,bt]=wt(xe),lr=u.forwardRef((r,a)=>{const{__scopeRadioGroup:t,name:o,defaultValue:d,value:i,required:p=!1,disabled:s=!1,orientation:_,dir:N,loop:E=!0,onValueChange:R,...I}=r,C=cr(t),P=$r(N),[O,A]=Br({prop:i,defaultProp:d??null,onChange:R,caller:xe});return e.jsx(_t,{scope:t,name:o,required:p,disabled:s,value:O,onValueChange:A,children:e.jsx(ot,{asChild:!0,...C,orientation:_,dir:P,loop:E,children:e.jsx(he.div,{role:"radiogroup","aria-required":p,"aria-orientation":_,"data-disabled":s?"":void 0,dir:P,...I,ref:a})})})});lr.displayName=xe;var ur="RadioGroupItem",mr=u.forwardRef((r,a)=>{const{__scopeRadioGroup:t,disabled:o,...d}=r,i=bt(ur,t),p=i.disabled||o,s=cr(t),_=dr(t),N=u.useRef(null),E=Ce(a,N),R=i.value===d.value,I=u.useRef(!1);return u.useEffect(()=>{const C=O=>{vt.includes(O.key)&&(I.current=!0)},P=()=>I.current=!1;return document.addEventListener("keydown",C),document.addEventListener("keyup",P),()=>{document.removeEventListener("keydown",C),document.removeEventListener("keyup",P)}},[]),e.jsx(it,{asChild:!0,...s,focusable:!p,active:R,children:e.jsx(nr,{disabled:p,required:i.required,checked:R,..._,...d,name:i.name,ref:E,onCheck:()=>i.onValueChange(d.value),onKeyDown:Ne(C=>{C.key==="Enter"&&C.preventDefault()}),onFocus:Ne(d.onFocus,()=>{var C;I.current&&((C=N.current)==null||C.click())})})})});mr.displayName=ur;var Nt="RadioGroupIndicator",fr=u.forwardRef((r,a)=>{const{__scopeRadioGroup:t,...o}=r,d=dr(t);return e.jsx(sr,{...d,...o,ref:a})});fr.displayName=Nt;var pr=lr,hr=mr,Et=fr;const Ee=u.forwardRef(({className:r,...a},t)=>e.jsx(pr,{className:pe("grid gap-2",r),...a,ref:t}));Ee.displayName=pr.displayName;const fe=u.forwardRef(({className:r,...a},t)=>e.jsx(hr,{ref:t,className:pe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(Et,{className:"flex items-center justify-center",children:e.jsx(ut,{className:"h-2.5 w-2.5 fill-current text-current"})})}));fe.displayName=hr.displayName;var Se={};Object.defineProperty(Se,"__esModule",{value:!0});var xr=Se.loadMercadoPago=void 0;const gr="https://sdk.mercadopago.com/js/v2",Ct=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Xe="MercadoPago has already been initialized in your window, please remove the duplicate import",Rt="MercadoPago.js not available",St="Failed to load MercadoPago.js",Pt=()=>{for(var r=document.querySelectorAll(`script[src^="${gr}"`),a=0;a<r.length;a++){var t=r[a];if(Ct.test(t.src))return t}return null},It=()=>{const r=document.createElement("script");r.src=gr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let me=null;const Mt=()=>(me!==null||(me=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(Xe),r(window.MercadoPago);return}try{let t=Pt();t?console.warn(Xe):t||(t=It()),t.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(Rt))}),t.addEventListener("error",()=>{a(new Error(St))})}catch(t){a(t);return}})),me);xr=Se.loadMercadoPago=Mt;var Ot=function(r,a,t,o){function d(i){return i instanceof t?i:new t(function(p){p(i)})}return new(t||(t=Promise))(function(i,p){function s(E){try{N(o.next(E))}catch(R){p(R)}}function _(E){try{N(o.throw(E))}catch(R){p(R)}}function N(E){E.done?i(E.value):d(E.value).then(s,_)}N((o=o.apply(r,a||[])).next())})};class q{static getInstance(){return Ot(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield xr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}q.publicKey=null;q.options={};q.instanceMercadoPago=void 0;q.loadedInstanceMercadoPago=!1;function Ft(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(o=>Object.prototype.hasOwnProperty.call(a,o)&&r[o]===a[o])}const Lt=(r,a)=>{const t=Object.assign(Object.assign({},a),{frontEndStack:"react"}),o=!Ft(q.options,t);(r!==q.publicKey||o)&&(q.publicKey=r,q.options=t,q.instanceMercadoPago=void 0)},At=({preferenceId:r,initPoint:a,onClose:t})=>{const{data:o,isLoading:d}=rr();return u.useEffect(()=>{if(o)try{Lt(o,{locale:"pt-BR"})}catch(i){console.error("Erro ao inicializar Mercado Pago:",i),w.error("Erro ao carregar o SDK do Mercado Pago."),t();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[o,t,a]),d||!o?e.jsx(Ve,{open:!0,onOpenChange:t,children:e.jsx($e,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(se,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(Ve,{open:!0,onOpenChange:t,children:e.jsxs($e,{className:"sm:max-w-[425px]",children:[e.jsxs(Kr,{children:[e.jsxs(zr,{className:"flex items-center gap-2",children:[e.jsx(er,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Ur,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(se,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(X,{variant:"outline",onClick:t,children:"Cancelar e Voltar"})]})})},kt=Ye({zip_code:L().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:L().min(1,"Rua é obrigatória."),number:L().min(1,"Número é obrigatório."),neighborhood:L().min(1,"Bairro é obrigatório."),city:L().min(1,"Cidade é obrigatória.")}),Dt=Ye({name:L().min(1,"Nome é obrigatório."),phone:L().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:L().email("Email inválido.").optional().or(Qr("")),cpf_cnpj:L().optional().default("").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Zr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:L().optional(),payment_method_id:L().min(1,"Selecione um método de pagamento."),change_for:L().optional()}),Tt=async r=>{const{data:a,error:t}=await S.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},Gt=async r=>{const{data:a,error:t}=await S.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return a},qt=async r=>{const{data:a,error:t}=await S.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return a},Vt=async r=>{const{data:a,error:t}=await S.from("customers").select("*").eq("user_id",r).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(t.message);return a||null},nn=()=>{var Ae,ke,De,Te,Ge;const r=kr(),a=Dr(),[t]=Tr(),o=Ar(),{items:d,totalAmount:i,clearCart:p}=Hr(),{data:s,isLoading:_}=Xr(),{data:N}=rr(),[E,R]=u.useState(!1),[I,C]=u.useState(!1),[P,O]=u.useState(0),[A,J]=u.useState(null),[ge,$]=u.useState(!0),[oe,yr]=u.useState(null),[jr,ye]=u.useState(!1),[vr,wr]=u.useState(null),[Pe,_r]=u.useState(null),[G,B]=u.useState(!1),br=(Ae=a.state)==null?void 0:Ae.restaurantId,Nr=t.get("restaurantId"),V=br||Nr;u.useEffect(()=>{console.log("LOG: Checkout - User Status:",s?`Logged in as ${s.email}`:"Anonymous")},[s]);const{data:y,isLoading:Er,isError:Cr,error:Ie,refetch:Rr}=ae({queryKey:["checkoutRestaurantData",V],queryFn:()=>Tt(V),enabled:!!V,staleTime:1/0}),{data:ie,isLoading:Sr}=ae({queryKey:["checkoutDeliveryZones",V],queryFn:()=>Gt(y.id),enabled:!!y,staleTime:1/0}),{data:Y,isLoading:Pr}=ae({queryKey:["checkoutPaymentMethods",V],queryFn:()=>qt(y.id),enabled:!!y,staleTime:1/0}),{data:v,isLoading:Me,refetch:$t}=ae({queryKey:["checkoutCustomerData",s==null?void 0:s.id],queryFn:()=>Vt(s.id),enabled:!!s,staleTime:0}),je=u.useMemo(()=>y!=null&&y.latitude&&(y!=null&&y.longitude)?[y.latitude,y.longitude]:null,[y]),ve=u.useCallback(async(n,c,m,j,x,f)=>{if(!y||!je||!y.delivery_enabled)return O(0),$(!0),J(null),{coords:null,fee:0,time:null,isValid:!0};const M=`${c}, ${m}, ${j}, ${n}`;let h=null;if(x&&f)h={lat:x,lng:f};else{C(!0);const g=w.loading("Calculando taxa de entrega...");h=await pt(M),C(!1),w.dismiss(g)}if(!h)return O(0),J(null),$(!1),w.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(yr([h.lat,h.lng]),ie&&ie.length>0){const g=ht([h.lat,h.lng],je,ie);return g?(O(g.fee),J([g.minTime,g.maxTime]),$(!0),{coords:h,fee:g.fee,time:[g.minTime,g.maxTime],isValid:!0}):(O(0),J(null),$(!1),w.error("Endereço fora da área de entrega."),{coords:h,fee:0,time:null,isValid:!1})}else return O(0),J(null),$(!0),{coords:h,fee:0,time:null,isValid:!0}},[y,je,ie]),l=Be({resolver:Ze(Dt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),b=Be({resolver:Ze(kt),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),k=l.watch("delivery_option"),Ir=l.watch("payment_method_id"),W=Y==null?void 0:Y.find(n=>n.id===Ir),ce=(ke=W==null?void 0:W.name)==null?void 0:ke.includes("online"),te=(De=W==null?void 0:W.name)==null?void 0:De.includes("Dinheiro"),D=i+P,T=b.watch(["zip_code","street","number","city","neighborhood"]);u.useEffect(()=>{k==="pickup"?(O(0),$(!0),B(!0)):B(!1)},[k]),u.useEffect(()=>{if(v){let n="",c="",m="",j="",x="";if(v.address){const f=v.address.split(", ").map(M=>M.trim());f.length>=5?(n=f[0],c=f[1],m=f[2],j=f[3],x=f[4]):f.length>=4&&(n=f[0],m=f[1],j=f[2],x=f[3])}l.reset({...l.getValues(),name:v.name||"",phone:v.phone||"",email:v.email||"",cpf_cnpj:v.cpf_cnpj||"",change_for:""}),b.reset({zip_code:x,street:n,number:c,neighborhood:m,city:j}),v.address&&v.latitude&&v.longitude&&(B(!0),ve(x,n,c,j,v.latitude,v.longitude))}else if(s&&!Me){const n=s.user_metadata;l.reset({...l.getValues(),name:n.full_name||"",phone:n.phone||"",email:s.email||"",cpf_cnpj:n.cpf_cnpj||"",change_for:""})}},[v,l,s,Me,b,ve]);const de=l.watch("change_for");u.useEffect(()=>{if(te&&de&&de.trim()!==""){const n=de.replace(",","."),c=parseFloat(n);isNaN(c)?l.setError("change_for",{message:"O troco deve ser um número válido."}):c<D?l.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)}).`}):l.clearErrors("change_for")}else l.clearErrors("change_for")},[te,de,D,l]);const le=_e({mutationFn:async n=>{var f;const m=(f=(await S.auth.getUser()).data.user)==null?void 0:f.id;if(!(v!=null&&v.id)&&!m)throw new Error("ID do cliente ou usuário não encontrado.");const j=`${n.street}, ${n.number}, ${n.neighborhood}, ${n.city}, ${n.zip_code}`,x={user_id:(s==null?void 0:s.id)||null,name:l.getValues("name"),phone:l.getValues("phone"),email:l.getValues("email")||null,cpf_cnpj:l.getValues("cpf_cnpj")||null,address:j,latitude:n.lat,longitude:n.lng};if(v!=null&&v.id){const{data:M,error:h}=await S.from("customers").update(x).eq("id",v.id).select().single();if(h)throw h;return M}else if(m){const{data:M,error:h}=await S.from("customers").insert(x).select().single();if(h)throw h;return M}else return{id:"anonymous",user_id:null,name:x.name,phone:x.phone,email:x.email,address:j,created_at:"",updated_at:"",latitude:n.lat,longitude:n.lng,cpf_cnpj:x.cpf_cnpj}},onSuccess:(n,c)=>{n.id!=="anonymous"&&o.invalidateQueries({queryKey:["checkoutCustomerData"]}),O(c.fee),J(c.time),$(c.isValid),B(!0),w.success("Endereço salvo e taxa de entrega calculada!")},onError:n=>{w.error(`Erro ao salvar endereço: ${n.message}`),B(!1)}}),Mr=async()=>{if(k==="pickup")return;if(!await b.trigger()){w.error("Preencha todos os campos obrigatórios do endereço.");return}const c=b.getValues(),m=await ve(c.zip_code,c.street,c.number,c.city);if(!m.isValid){B(!1);return}if(!m.coords){w.error("Não foi possível obter as coordenadas para salvar o endereço."),B(!1);return}le.mutate({...c,lat:m.coords.lat,lng:m.coords.lng,fee:m.fee,time:m.time,isValid:m.isValid})},Oe=_e({mutationFn:async n=>{var f,M;(f=(await S.auth.getUser()).data.user)==null||f.id;const m=n.phone.replace(/\D/g,""),j=((M=n.cpf_cnpj)==null?void 0:M.replace(/\D/g,""))||null,x={user_id:(s==null?void 0:s.id)||null,name:n.name,phone:m,email:n.email||null,cpf_cnpj:j,address:k==="delivery"?`${T[1]}, ${T[2]}, ${T[3]}, ${T[4]}, ${T[0]}`:null,latitude:oe?oe[0]:null,longitude:oe?oe[1]:null};if(s)if(v){const{data:h,error:g}=await S.from("customers").update(x).eq("id",v.id).select().single();if(g)throw g;return h}else{const{data:h,error:g}=await S.from("customers").insert(x).select().single();if(g)throw g;return h}else{const{data:h,error:g}=await S.from("customers").insert(x).select().single();if(g)throw g;return h}},onSuccess:()=>{o.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:n=>{w.error(`Erro ao salvar dados do cliente: ${n.message}`)}}),Fe=_e({mutationFn:async({customerId:n,data:c})=>{if(!y)throw new Error("Dados do restaurante não disponíveis.");let m=null;if(te&&c.change_for&&c.change_for.trim()!==""){const g=c.change_for.replace(",","."),we=parseFloat(g);!isNaN(we)&&we>D&&(m=we)}const j={restaurant_id:y.id,customer_id:n,status:ce?"pending_payment":"pending",total_amount:D,delivery_fee:P,delivery_address:k==="delivery"?`${T[1]}, ${T[2]}, ${T[3]}, ${T[4]}, ${T[0]}`:null,notes:c.notes,payment_method_id:c.payment_method_id,change_for:m},{data:x,error:f}=await S.from("orders").insert(j).select("id").single();if(f)throw f;const M=d.map(g=>({order_id:x.id,product_id:g.product.id,quantity:g.quantity,unit_price:g.product.price,subtotal:g.subtotal,notes:g.notes})),{error:h}=await S.from("order_items").insert(M);if(h)throw h;return x.id},onSuccess:n=>{o.invalidateQueries({queryKey:["orders"]})},onError:n=>{w.error(`Erro ao criar pedido: ${n.message}`)}}),Or=async n=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",ce),console.log("LOG: deliveryOption:",k),console.log("LOG: isAddressSaved:",G),console.log("LOG: change_for data:",n.change_for),te&&n.change_for&&n.change_for.trim()!==""){const j=n.change_for.replace(",","."),x=parseFloat(j);if(isNaN(x)){w.error("O troco deve ser um número válido.");return}if(x<D){w.error(`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)}).`);return}}if(d.length===0){w.error("Seu carrinho está vazio."),r("/menu");return}if(k==="delivery"){if(!G){w.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!ge){w.error("O endereço de entrega está fora da área de cobertura.");return}}let c;try{console.log("LOG: Criando/Atualizando cliente..."),c=(await Oe.mutateAsync(n)).id,console.log("LOG: Cliente ID:",c)}catch(j){w.error(`Falha ao salvar cliente: ${j.message}`);return}let m;try{console.log("LOG: Criando pedido..."),m=await Fe.mutateAsync({customerId:c,data:n}),console.log("LOG: Pedido ID:",m)}catch(j){w.error(`Falha ao criar pedido: ${j.message}`);return}ce?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Fr(m,n)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),p(),r(`/order-success/${m}`,{replace:!0}))},Fr=async(n,c)=>{if(!y)return;const m=window.location.origin+window.location.pathname,j=d.map(f=>({name:f.product.name,price:f.product.price,quantity:f.quantity})),x=w.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:f,error:M}=await S.functions.invoke("create-payment-preference",{body:{orderId:n,items:j,totalAmount:D,restaurantName:y.name,clientUrl:m,customerEmail:c.email||(s==null?void 0:s.email)||"cliente@anonimo.com",customerCpfCnpj:c.cpf_cnpj}});if(M)throw M;const{init_point:h}=f;console.log("LOG: Preferência MP criada. init_point:",h),wr(n),_r(h),ye(!0),w.dismiss(x)}catch(f){console.error("Erro ao criar preferência MP:",f),w.dismiss(x),w.error(`Erro no pagamento online: ${f.message}`),ye(!1)}},Lr=async()=>{await S.auth.signOut(),w.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!V)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(K,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx(ee,{children:"Erro de Rastreamento"}),e.jsx(re,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(qe,{to:"/",children:e.jsx(X,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(d.length===0)return u.useEffect(()=>{r(`/menu/${V}`)},[r,V]),e.jsx(ze,{});if(Er||Sr||Pr||_)return e.jsx(ze,{});if(Cr||!y)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(K,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx(ee,{children:"Erro Crítico"}),e.jsx(re,{children:Ie instanceof Error?Ie.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(X,{onClick:()=>Rr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Jr,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Le=Oe.isPending||Fe.isPending||le.isPending||I||k==="delivery"&&!G;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Yr,{isOpen:E,onClose:()=>R(!1),customer:v}),jr&&Pe&&e.jsx(At,{preferenceId:vr,initPoint:Pe,onClose:()=>ye(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:y.name})]}),s&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{variant:"outline",size:"icon",onClick:()=>R(!0),"aria-label":"Meu Perfil",children:e.jsx(Ue,{className:"h-4 w-4"})}),e.jsxs(X,{variant:"outline",size:"sm",onClick:Lr,children:[e.jsx(Wr,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ue,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(Z,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:s?`Logado como ${s.email}. ${v?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:l.handleSubmit(Or),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(H,{id:"name",...l.register("name")}),l.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"phone",children:"Telefone *"}),e.jsx(ne,{name:"phone",control:l.control,render:({field:n})=>e.jsx(et,{id:"phone",...n})}),l.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(H,{id:"email",type:"email",...l.register("email")}),l.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(ne,{name:"cpf_cnpj",control:l.control,render:({field:n})=>e.jsx(rt,{id:"cpf_cnpj",...n})}),l.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(Z,{children:e.jsx(ne,{name:"delivery_option",control:l.control,render:({field:n})=>e.jsxs(Ee,{onValueChange:n.onChange,value:n.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(F,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(fe,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(be,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(F,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(fe,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Qe,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),k==="delivery"&&e.jsxs(z,{className:pe(!G&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(U,{children:[e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Qe,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",G&&e.jsx(tt,{className:"h-5 w-5 text-green-500 ml-2"}),!G&&e.jsx(ue,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(Z,{className:"space-y-4",children:[!y.delivery_enabled&&e.jsxs(K,{variant:"destructive",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(ee,{children:"Entrega Desativada"}),e.jsx(re,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),Mr()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(F,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(ne,{name:"zip_code",control:b.control,render:({field:n})=>e.jsx(dt,{id:"zip_code",...n})}),b.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(F,{htmlFor:"street",children:"Rua *"}),e.jsx(H,{id:"street",...b.register("street")}),b.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"number",children:"Número *"}),e.jsx(H,{id:"number",...b.register("number")}),b.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(F,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(H,{id:"neighborhood",...b.register("neighborhood")}),b.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"city",children:"Cidade *"}),e.jsx(H,{id:"city",...b.register("city")}),b.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.city.message})]}),e.jsxs(X,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:le.isPending||I||!y.delivery_enabled,children:[le.isPending||I?e.jsx(se,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(nt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),I&&e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 animate-spin"}),e.jsx(ee,{children:"Calculando Taxa de Entrega..."})]}),!ge&&G&&!I&&e.jsxs(K,{variant:"destructive",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(ee,{children:"Fora da Área de Entrega"}),e.jsx(re,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),A&&ge&&G&&!I&&e.jsxs(K,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(be,{className:"h-4 w-4"}),e.jsx(ee,{children:"Entrega Disponível"}),e.jsxs(re,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P),". Tempo estimado: ",A[0]," - ",A[1]," minutos."]})]})]})]}),e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(er,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(Z,{children:[e.jsx(ne,{name:"payment_method_id",control:l.control,render:({field:n})=>e.jsx(Ee,{onValueChange:n.onChange,value:n.value,className:"space-y-3",children:Y==null?void 0:Y.map(c=>{var j;const m=((j=c.name)==null?void 0:j.includes("online"))&&!N;return e.jsx(F,{htmlFor:c.id,className:pe("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",m&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(fe,{value:c.id,id:c.id,disabled:m}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:c.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c.description}),m&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},c.id)})})}),l.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:l.formState.errors.payment_method_id.message})]})]}),te&&e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(at,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(H,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D),...l.register("change_for")}),((Te=l.formState.errors.change_for)==null?void 0:Te.message)&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.change_for.message}),((Ge=l.formState.errors.change_for)==null?void 0:Ge.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.change_for.message})]})})]}),e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(lt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(st,{id:"notes",...l.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(z,{className:"shadow-lg",children:[e.jsx(U,{children:e.jsx(Q,{className:"text-2xl",children:"Resumo"})}),e.jsxs(Z,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:d.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[n.quantity,"x ",n.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.subtotal)})]},n.product.id))}),e.jsx(He,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P)})]})]}),e.jsx(He,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)})]}),e.jsx(X,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Le,children:Le?e.jsx(se,{className:"h-5 w-5 animate-spin mr-2"}):ce?"Pagar e Finalizar":"Confirmar Pedido"}),k==="delivery"&&!G&&e.jsxs(K,{variant:"destructive",className:"mt-3",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(re,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(qe,{to:`/menu/${y.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{nn as default};
