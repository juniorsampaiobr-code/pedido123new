import{j as e,b as Bs,u as he,c as Us}from"./tanstack-D8i8yNxB.js";import{r as i,R as es,u as Ks,h as Zs,L as He}from"./vendor-Dl0Wzy4_.js";import{o as Hs,s as $,l as Js,e as Qs,p as Pe,c as Je,n as Ws,Z as K,u as Xs,t as Ys}from"./types-BCrSgEF3.js";import{s as A}from"./client-BmrnLCXS.js";import{c as Fe,f as ke,g as ge,P as J,i as xe,h as ss,l as er,m as rs,b as ye,n as sr,k as rr,a as ts,v as Qe,L as We}from"./index-D7fwDE_N.js";import{B as ae}from"./button-BbicL1io.js";import{C as ie,b as le,c as ce,a as de}from"./card-C0NzzEOj.js";import{I as D}from"./label-BCT50JDw.js";import{c as os,R as tr,I as or,a as ar,C as nr}from"./index-BM1RdMJ_.js";import{u as ir}from"./index-BB_oiUC3.js";import{u as lr}from"./index-PuW-_iwo.js";import{S as ue}from"./separator-CtY2dXN4.js";import{T as cr}from"./textarea-5T2DX0iC.js";import{A as X,a as Y,b as ee}from"./alert-BpHfMCKi.js";import{F as dr,b as F,c as w,a as P,e as k,d as ne}from"./form-DuxMnLzb.js";import{P as ur}from"./PhoneInput-C_5GR8Uo.js";import{Z as mr,M as pr}from"./MapLocationSection-Da_zzbQe.js";import{S as hr}from"./shopping-cart-B7MvfU3I.js";import{T as Ie}from"./terminal-CEhV0t8e.js";import{A as fr}from"./arrow-left-BwdxXUiK.js";import{T as Xe}from"./truck-xqk8pd5-.js";import{S as as,a as xr}from"./store-By-O0Inc.js";import{M as Ye}from"./map-pin-CYnonYZF.js";import{P as gr}from"./package-CNCkO69K.js";import{C as yr}from"./credit-card-B6Ip7tcC.js";import{D as jr}from"./dollar-sign-DyW_opOo.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vr=Fe("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const br=Fe("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nr=Fe("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var Le="Radio",[Cr,ns]=ke(Le),[wr,_r]=Cr(Le),is=i.forwardRef((r,t)=>{const{__scopeRadio:a,name:c,checked:n=!1,required:l,disabled:m,value:d="on",onCheck:g,form:f,...y}=r,[v,j]=i.useState(null),x=ge(t,L=>j(L)),R=i.useRef(!1),b=v?f||!!v.closest("form"):!0;return e.jsxs(wr,{scope:a,checked:n,disabled:m,children:[e.jsx(J.button,{type:"button",role:"radio","aria-checked":n,"data-state":us(n),"data-disabled":m?"":void 0,disabled:m,value:d,...y,ref:x,onClick:xe(r.onClick,L=>{n||g==null||g(),b&&(R.current=L.isPropagationStopped(),R.current||L.stopPropagation())})}),b&&e.jsx(ds,{control:v,bubbles:!R.current,name:c,value:d,checked:n,required:l,disabled:m,form:f,style:{transform:"translateX(-100%)"}})]})});is.displayName=Le;var ls="RadioIndicator",cs=i.forwardRef((r,t)=>{const{__scopeRadio:a,forceMount:c,...n}=r,l=_r(ls,a);return e.jsx(ss,{present:c||l.checked,children:e.jsx(J.span,{"data-state":us(l.checked),"data-disabled":l.disabled?"":void 0,...n,ref:t})})});cs.displayName=ls;var Rr="RadioBubbleInput",ds=i.forwardRef(({__scopeRadio:r,control:t,checked:a,bubbles:c=!0,...n},l)=>{const m=i.useRef(null),d=ge(m,l),g=lr(a),f=er(t);return i.useEffect(()=>{const y=m.current;if(!y)return;const v=window.HTMLInputElement.prototype,x=Object.getOwnPropertyDescriptor(v,"checked").set;if(g!==a&&x){const R=new Event("click",{bubbles:c});x.call(y,a),y.dispatchEvent(R)}},[g,a,c]),e.jsx(J.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...n,tabIndex:-1,ref:d,style:{...n.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ds.displayName=Rr;function us(r){return r?"checked":"unchecked"}var Er=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],je="RadioGroup",[Pr,Rt]=ke(je,[os,ns]),ms=os(),ps=ns(),[Ir,Sr]=Pr(je),hs=i.forwardRef((r,t)=>{const{__scopeRadioGroup:a,name:c,defaultValue:n,value:l,required:m=!1,disabled:d=!1,orientation:g,dir:f,loop:y=!0,onValueChange:v,...j}=r,x=ms(a),R=ir(f),[b,L]=rs({prop:l,defaultProp:n??null,onChange:v,caller:je});return e.jsx(Ir,{scope:a,name:c,required:m,disabled:d,value:b,onValueChange:L,children:e.jsx(tr,{asChild:!0,...x,orientation:g,dir:R,loop:y,children:e.jsx(J.div,{role:"radiogroup","aria-required":m,"aria-orientation":g,"data-disabled":d?"":void 0,dir:R,...j,ref:t})})})});hs.displayName=je;var fs="RadioGroupItem",xs=i.forwardRef((r,t)=>{const{__scopeRadioGroup:a,disabled:c,...n}=r,l=Sr(fs,a),m=l.disabled||c,d=ms(a),g=ps(a),f=i.useRef(null),y=ge(t,f),v=l.value===n.value,j=i.useRef(!1);return i.useEffect(()=>{const x=b=>{Er.includes(b.key)&&(j.current=!0)},R=()=>j.current=!1;return document.addEventListener("keydown",x),document.addEventListener("keyup",R),()=>{document.removeEventListener("keydown",x),document.removeEventListener("keyup",R)}},[]),e.jsx(or,{asChild:!0,...d,focusable:!m,active:v,children:e.jsx(is,{disabled:m,required:l.required,checked:v,...g,...n,name:l.name,ref:y,onCheck:()=>l.onValueChange(n.value),onKeyDown:xe(x=>{x.key==="Enter"&&x.preventDefault()}),onFocus:xe(n.onFocus,()=>{var x;j.current&&((x=f.current)==null||x.click())})})})});xs.displayName=fs;var Vr="RadioGroupIndicator",gs=i.forwardRef((r,t)=>{const{__scopeRadioGroup:a,...c}=r,n=ps(a);return e.jsx(cs,{...n,...c,ref:t})});gs.displayName=Vr;var ys=hs,js=xs,Fr=gs;const Se=i.forwardRef(({className:r,...t},a)=>e.jsx(ys,{className:ye("grid gap-2",r),...t,ref:a}));Se.displayName=ys.displayName;const fe=i.forwardRef(({className:r,...t},a)=>e.jsx(js,{ref:a,className:ye("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...t,children:e.jsx(Fr,{className:"flex items-center justify-center",children:e.jsx(vr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));fe.displayName=js.displayName;const kr=r=>{let t=r.replace(/\D/g,"");return t.length>14&&(t=t.slice(0,14)),t.length<=11?(t.length>9&&(t=`${t.slice(0,9)}-${t.slice(9)}`),t.length>6&&(t=`${t.slice(0,6)}.${t.slice(6)}`),t.length>3&&(t=`${t.slice(0,3)}.${t.slice(3)}`),t):(t.length>12&&(t=`${t.slice(0,12)}-${t.slice(12)}`),t.length>8&&(t=`${t.slice(0,8)}/${t.slice(8)}`),t.length>5&&(t=`${t.slice(0,5)}.${t.slice(5)}`),t.length>2&&(t=`${t.slice(0,2)}.${t.slice(2)}`),t)},vs=es.forwardRef(({className:r,value:t,onChange:a,...c},n)=>{const l=m=>{const d=m.target.value,g=kr(d),f={...m,target:{...m.target,value:g}};a(f)};return e.jsx(D,{ref:n,type:"tel",className:ye("w-full",r),placeholder:"CPF ou CNPJ",value:t,onChange:l,maxLength:18,...c})});vs.displayName="CpfCnpjInput";const Lr=(r,t,a,c)=>{const l=(a-r)*(Math.PI/180),m=(c-t)*(Math.PI/180),d=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r*(Math.PI/180))*Math.cos(a*(Math.PI/180))*Math.sin(m/2)*Math.sin(m/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))},Or=async r=>{const t=r.replace(/\s+/g," ").trim(),a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1`,c=new AbortController,n=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",a);const l=await fetch(a,{signal:c.signal});if(!l.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",l.status),null;const m=await l.json();if(m&&Array.isArray(m)&&m.length>0){const d=m[0],g=parseFloat(d.lat),f=parseFloat(d.lon);if(Number.isFinite(g)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[g,f]),{lat:g,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",t),null}catch(l){return l instanceof Error&&l.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",t):console.error("LOG: geocodeAddress - Erro durante a requisição:",l),null}finally{clearTimeout(n)}},$r=(r,t,a)=>{const c=Lr(t[0],t[1],r[0],r[1]),n=a.find(l=>c<=l.max_distance_km);if(n){const l=n.delivery_fee||0,m=n.min_delivery_time_minutes||0,d=m+15;return{fee:parseFloat(l.toFixed(2)),minTime:m,maxTime:d}}return null};var ve="Collapsible",[Ar,Et]=ke(ve),[Tr,Oe]=Ar(ve),bs=i.forwardRef((r,t)=>{const{__scopeCollapsible:a,open:c,defaultOpen:n,disabled:l,onOpenChange:m,...d}=r,[g,f]=rs({prop:c,defaultProp:n??!1,onChange:m,caller:ve});return e.jsx(Tr,{scope:a,disabled:l,contentId:sr(),open:g,onOpenToggle:i.useCallback(()=>f(y=>!y),[f]),children:e.jsx(J.div,{"data-state":Ae(g),"data-disabled":l?"":void 0,...d,ref:t})})});bs.displayName=ve;var Ns="CollapsibleTrigger",Cs=i.forwardRef((r,t)=>{const{__scopeCollapsible:a,...c}=r,n=Oe(Ns,a);return e.jsx(J.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":Ae(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...c,ref:t,onClick:xe(r.onClick,n.onOpenToggle)})});Cs.displayName=Ns;var $e="CollapsibleContent",ws=i.forwardRef((r,t)=>{const{forceMount:a,...c}=r,n=Oe($e,r.__scopeCollapsible);return e.jsx(ss,{present:a||n.open,children:({present:l})=>e.jsx(Mr,{...c,ref:t,present:l})})});ws.displayName=$e;var Mr=i.forwardRef((r,t)=>{const{__scopeCollapsible:a,present:c,children:n,...l}=r,m=Oe($e,a),[d,g]=i.useState(c),f=i.useRef(null),y=ge(t,f),v=i.useRef(0),j=v.current,x=i.useRef(0),R=x.current,b=m.open||d,L=i.useRef(b),z=i.useRef(void 0);return i.useEffect(()=>{const N=requestAnimationFrame(()=>L.current=!1);return()=>cancelAnimationFrame(N)},[]),rr(()=>{const N=f.current;if(N){z.current=z.current||{transitionDuration:N.style.transitionDuration,animationName:N.style.animationName},N.style.transitionDuration="0s",N.style.animationName="none";const Z=N.getBoundingClientRect();v.current=Z.height,x.current=Z.width,L.current||(N.style.transitionDuration=z.current.transitionDuration,N.style.animationName=z.current.animationName),g(c)}},[m.open,c]),e.jsx(J.div,{"data-state":Ae(m.open),"data-disabled":m.disabled?"":void 0,id:m.contentId,hidden:!b,...l,ref:y,style:{"--radix-collapsible-content-height":j?`${j}px`:void 0,"--radix-collapsible-content-width":R?`${R}px`:void 0,...r.style},children:b&&n})});function Ae(r){return r?"open":"closed"}var Gr=bs;const qr=Gr,Dr=Cs,zr=ws,Br=()=>{const{items:r,subtotal:t,deliveryFee:a,total:c,totalItems:n}=ts(),[l,m]=i.useState(!1);return n===0?null:e.jsxs(qr,{open:l,onOpenChange:m,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Dr,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(hr,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)}),l?e.jsx(ar,{className:"h-5 w-5"}):e.jsx(nr,{className:"h-5 w-5"})]})]})}),e.jsxs(zr,{className:"p-4 pt-0",children:[e.jsx(ue,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:r.map(d=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[d.quantity,"x ",d.name,d.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",d.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d.price*d.quantity)})]},d.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)})]})]})]})]})},_s=r=>r.replace(/\D/g,""),Rs=r=>r.replace(/\D/g,""),Ve=r=>r.replace(/\D/g,""),Ur=Hs({name:$().min(1,"Nome é obrigatório."),phone:$().min(1,"Telefone é obrigatório.").transform(_s).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:$().email("Email inválido.").optional().or(Js("")),delivery_option:Qs(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:$().optional().default(""),number:$().optional().default(""),complement:$().optional().default(""),neighborhood:$().optional().default(""),city:$().optional().default(""),zip_code:$().optional().default("").transform(Rs).refine(r=>r.length===8||r.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Pe(r=>typeof r=="string"?parseFloat(r):r,Je.number().optional().nullable()),longitude:Pe(r=>typeof r=="string"?parseFloat(r):r,Je.number().optional().nullable()),payment_method_id:$().min(1,"Selecione uma forma de pagamento."),notes:$().optional(),cpf_cnpj:$().optional().default("").transform(Ve).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Pe(r=>{if(r==null||r==="")return null;const t=String(r).replace(",","."),a=parseFloat(t);return isNaN(a)?t:a},Ws({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((r,t)=>{if(r.delivery_option==="delivery"?(r.street.trim()===""&&t.addIssue({code:K.custom,message:"Rua é obrigatória.",path:["street"]}),r.number.trim()===""&&t.addIssue({code:K.custom,message:"Número é obrigatório.",path:["number"]}),r.neighborhood.trim()===""&&t.addIssue({code:K.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),r.city.trim()===""&&t.addIssue({code:K.custom,message:"Cidade é obrigatória.",path:["city"]}),r.zip_code.length!==8&&t.addIssue({code:K.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(r.latitude===null||r.longitude===null)&&t.addIssue({code:K.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})):r.latitude!==null||r.longitude,r.payment_method_id==="Dinheiro"&&r.change_for!==null&&r.change_for!==void 0&&r.change_for<=0&&t.addIssue({code:K.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),r.payment_method_id==="Pagamento online: Pix/Cartão"){const n=Ve(r.cpf_cnpj||"");n.length!==11&&n.length!==14&&t.addIssue({code:K.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Kr=()=>{const r=window.location.origin,a=window.location.pathname.split("/")[1];return a?`${r}/${a}`:r},Zr=async()=>{const{data:r,error:t}=await A.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},Hr=async r=>{const{data:t,error:a}=await A.from("restaurants").select("delivery_enabled").eq("id",r).single();if(a)throw new Error(`Erro ao buscar status de entrega: ${a.message}`);return t.delivery_enabled??!0},Jr=async r=>{const{data:t,error:a}=await A.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(a)throw new Error(`Erro ao buscar métodos de pagamento: ${a.message}`);return t},Qr=async r=>{const{data:t,error:a}=await A.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return t},Wr=r=>{switch(r){case"DollarSign":return jr;case"Smartphone":return xr;case"CreditCard":return yr;case"Package":return gr;default:return as}},Xr=({subtotal:r,deliveryFee:t,total:a,items:c})=>e.jsxs(ie,{className:"sticky top-4",children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(de,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:t>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]})]})]}),Pt=()=>{const r=Kr(),t=Ks();Bs();const a=ts(),{items:c,subtotal:n,deliveryFee:l,total:m,setDeliveryFee:d,clearCart:g}=a,[f]=Zs(),[y,v]=i.useState(!1),[j,x]=i.useState(null),[R,b]=i.useState(null),[L,z]=i.useState(null),N=es.useRef(!1),[Z,Te]=i.useState(!1),se=f.get("status"),be=f.get("external_reference"),Me=f.has("collection_id")||f.has("external_reference");i.useEffect(()=>{if(be)if(se==="approved"||se==="failure"||se==="pending"){t(`/order-success/${be}?status=${se}`,{replace:!0});return}else Me&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Te(!1));else Te(!1)},[be,se,Me,t]);const{data:u,isLoading:Es,isError:Ps,error:Is}=he({queryKey:["checkoutRestaurantData"],queryFn:Zr}),{data:B,isLoading:Ne}=he({queryKey:["deliveryStatus",u==null?void 0:u.id],queryFn:()=>Hr(u.id),enabled:!!(u!=null&&u.id)}),{data:Q=[],isLoading:Ss}=he({queryKey:["checkoutPaymentMethods",u==null?void 0:u.id],queryFn:()=>Jr(u.id),enabled:!!(u!=null&&u.id)}),{data:Ge=[],isLoading:Vs}=he({queryKey:["checkoutDeliveryZones",u==null?void 0:u.id],queryFn:()=>Qr(u.id),enabled:!!(u!=null&&u.id)}),Fs=Es||Ne||Ss||Vs,ks=Ps,qe=Is,o=Xs({resolver:Ys(Ur),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),M=o.watch("delivery_option"),Ce=o.watch("payment_method_id"),W=Q.find(s=>s.id===Ce),me=(W==null?void 0:W.name)==="Pagamento online: Pix/Cartão",pe=(W==null?void 0:W.name)==="Dinheiro",I=o.watch("latitude"),S=o.watch("longitude");o.watch(["street","number","neighborhood","city","zip_code"]);const U=M==="delivery",Ls=i.useMemo(()=>JSON.stringify({deliveryOption:M,deliveryEnabled:B,lat:I,lng:S}),[M,B,I,S]),Os=i.useMemo(()=>typeof I=="number"&&typeof S=="number"&&!isNaN(I)&&!isNaN(S)?[I,S]:u!=null&&u.latitude&&(u!=null&&u.longitude)?[u.latitude,u.longitude]:[-23.55052,-46.633308],[I,S,u]),$s=i.useMemo(()=>I===null||S===null?`map-${M}-null`:`map-${M}-${I.toFixed(6)}-${S.toFixed(6)}`,[U,M,I,S]),we=i.useCallback(s=>{const p=s.road||s.logradouro||"",h=s.house_number||"",C=s.suburb||s.bairro||"",_=s.city||s.localidade||"",T=s.postcode||s.cep||"";o.setValue("street",p,{shouldValidate:!0}),o.setValue("number",h||"",{shouldValidate:!0}),o.setValue("complement",s.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",C,{shouldValidate:!0}),o.setValue("city",_,{shouldValidate:!0}),o.setValue("zip_code",T,{shouldValidate:!0})},[o]),As=i.useCallback(async(s,p)=>{o.setValue("latitude",s,{shouldValidate:!0}),o.setValue("longitude",p,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${p}&addressdetails=1`,C=await fetch(h);if(C.ok){const _=await C.json();_.address&&we(_.address)}},[o,we]),Ts=i.useCallback(()=>{o.setValue("street","",{shouldValidate:!0}),o.setValue("number","",{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood","",{shouldValidate:!0}),o.setValue("city","",{shouldValidate:!0}),o.setValue("zip_code","",{shouldValidate:!0}),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),d(0),x(null),b(null),localStorage.removeItem("checkoutFormData")},[o,d]),_e=i.useCallback(s=>{try{const p={name:s.name,phone:s.phone,email:s.email,delivery_option:s.delivery_option,street:s.street,number:s.number,complement:s.complement,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code,latitude:s.latitude,longitude:s.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(p))}catch(p){console.error("Failed to save form data to local storage",p)}},[]),De=i.useCallback(()=>{try{const s=localStorage.getItem("checkoutFormData");if(s){const p=JSON.parse(s);o.reset({...o.getValues(),...p,delivery_option:p.delivery_option||"delivery"})}}catch(s){console.error("Failed to load form data from local storage",s)}},[o]);i.useEffect(()=>{De()},[De]),i.useEffect(()=>{const s=o.watch(p=>{_e(p)});return()=>s.unsubscribe()},[o,_e]);const Ms=()=>{N.current||(z(null),N.current=!0,Promise.resolve().then(async()=>{try{const s=o.getValues(),[p,h,C,_,T]=[s.street,s.number,s.neighborhood,s.city,s.zip_code],te=Rs(T);if(!(p&&h&&C&&_&&te.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),o.trigger(["street","number","neighborhood","city","zip_code"]),N.current=!1;return}console.log("LOG: Iniciando geocodificação para:",`${p}, ${h}, ${C}, ${_}, ${T}`);const G=`${p}, ${h}, ${C}, ${_}, ${T}`,H=await Or(G);H?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",H),o.setValue("latitude",H.lat,{shouldValidate:!0}),o.setValue("longitude",H.lng,{shouldValidate:!0}),_e(o.getValues())):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),setTimeout(()=>{z("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0})},100))}catch(s){console.error("LOG: Erro capturado durante a geocodificação:",s),setTimeout(()=>{z("Erro ao buscar coordenadas. Verifique sua conexão ou tente novamente."),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0})},100)}finally{N.current=!1}}).catch(s=>{console.error("LOG: Erro nao capturado:",s),N.current=!1}))};i.useEffect(()=>{pe||o.setValue("change_for",null,{shouldValidate:!0})},[pe,o]),i.useEffect(()=>{M==="pickup"&&(d(0),x(null),b(null),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}))},[M,U,o,d,I,S]),i.useEffect(()=>{Q.length>0&&!Ce&&o.setValue("payment_method_id",Q[0].id)},[Q,Ce,o]),i.useEffect(()=>{me?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},[me,o]),i.useEffect(()=>{const s=async()=>{if(M==="pickup"||!(u!=null&&u.latitude)||!(u!=null&&u.longitude)){d(0),x(null),b(null);return}if(Ne)return;if(B===!1){d(0),x(null),b(null),v(!1);return}v(!0),x(null);let h=null;if(I&&S)h=[I,S];else{d(0),b(null),v(!1);return}if(h){const C=[u.latitude,u.longitude],_=$r(h,C,Ge);_?(d(_.fee),x(null),b({minTime:_.minTime,maxTime:_.maxTime})):(d(0),x("Seu endereço está fora da nossa área de entrega."),b(null))}v(!1)},p=setTimeout(()=>{s()},500);return()=>clearTimeout(p)},[Ls,u,Ge,o,d,U,I,S,B,Ne]);const re=Us({mutationFn:async s=>{if(!u)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&j)throw new Error(j);const p=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),h=s.delivery_option==="delivery"?p:"Retirada no Local";let C;const _=_s(s.phone),T=Ve(s.cpf_cnpj||""),{data:{user:te}}=await A.auth.getUser(),oe=(te==null?void 0:te.id)||null;if(!oe)throw new Error("Autenticação necessária. Por favor, faça login para finalizar o pedido.");const{data:G}=await A.from("customers").select("id, user_id, name, cpf_cnpj").eq("phone",_).limit(1).single();if(G){C=G.id;const V={name:s.name};let O=!1;T&&T!==G.cpf_cnpj&&(V.cpf_cnpj=T,O=!0),s.name!==G.name&&(O=!0),G.user_id===null&&(V.user_id=oe,O=!0);const E=G.user_id===null||G.user_id===oe;if(O&&E){const{error:q}=await A.from("customers").update(V).eq("id",C);if(q)throw q.message.includes("violates row-level security policy")?new Error(`Erro de segurança ao atualizar cliente existente. O telefone ${s.phone} pode estar vinculado a outra conta.`):new Error(`Erro ao atualizar cliente existente: ${q.message}`)}else O&&!E&&console.warn(`LOG: Cliente existente (ID: ${C}) vinculado a outro usuário. Usando dados existentes sem atualização.`)}else{const V={name:s.name,phone:_,email:s.email||null,address:h,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:T||null,user_id:oe},{data:O,error:E}=await A.from("customers").insert(V).select("id").single();if(E)throw E.message.includes("violates row-level security policy")?new Error("Erro de segurança ao criar cliente. Verifique se o telefone já está em uso ou se há um problema de permissão."):new Error(`Erro ao criar cliente: ${E.message}`);C=O.id}const H=me?"pending_payment":"pending",{data:Ee,error:Ue}=await A.from("orders").insert({restaurant_id:u.id,customer_id:C,status:H,total_amount:m,delivery_fee:l,notes:s.notes,delivery_address:h,payment_method_id:s.payment_method_id,change_for:pe?s.change_for:null}).select("id").single();if(Ue)throw new Error(`Erro ao criar pedido: ${Ue.message}`);const zs=c.map(V=>{const O=Number(V.quantity),E=Number(V.price),q={order_id:Ee.id,product_id:V.product_id,quantity:O,unit_price:E,subtotal:O*E};return V.notes&&V.notes.trim()&&(q.notes=V.notes.trim()),q}),{error:Ke}=await A.from("order_items").insert(zs);if(Ke){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Ke);const V=c.map(E=>{const q=Number(E.quantity),Ze=Number(E.price);return{order_id:Ee.id,quantity:q,unit_price:Ze,subtotal:q*Ze,notes:E.notes&&E.notes.trim()?E.notes.trim():null}}),{error:O}=await A.from("order_items").insert(V);if(O)throw new Error(`Erro ao adicionar itens do pedido: ${O.message}`)}return{orderId:Ee.id,orderStatus:H}},onSuccess:s=>{g();const p=s.orderStatus==="pending_payment"?`/payment/${s.orderId}`:`/order-success/${s.orderId}`,h=`${r}/#${p}`;console.log("LOG: Redirecionamento FORÇADO para:",h),window.location.href=h},onError:s=>{console.error("LOG: Erro ao processar pedido:",s),alert(`Falha ao finalizar pedido: ${s.message}. Verifique o console para mais detalhes.`)}}),Gs=async s=>{if(!await o.trigger()){ze(o.formState.errors);return}if(s.delivery_option==="delivery"&&j){alert(`Não é possível finalizar o pedido: ${j}`);return}re.mutate(s)},ze=s=>{var h;console.error("Validation errors:",s);const p=Object.keys(s)[0];p&&console.error("LOG: Erro de validação:",((h=s[p])==null?void 0:h.message)||"Preencha todos os campos obrigatórios.")},Be=re.isPending||y,qs=!U||!j&&l>=0,Re=!U||I!==null&&S!==null,Ds=!Be&&qs&&Re;return i.useEffect(()=>{if(c.length===0&&!re.isPending&&!Z){const s=setTimeout(()=>{t("/menu",{replace:!0})},100);return()=>clearTimeout(s)}},[c.length,re.isPending,Z,t]),c.length===0&&!re.isPending&&!Z?e.jsx(Qe,{}):Fs||Z?e.jsx(Qe,{}):ks?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(X,{variant:"destructive",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Conexão"}),e.jsx(ee,{children:qe instanceof Error?qe.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(He,{to:"/menu",children:e.jsx(ae,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(fr,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("div",{children:e.jsx(Br,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(dr,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(Gs,ze),className:"space-y-6",children:[e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(F,{control:o.control,name:"name",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Nome Completo *"}),e.jsx(D,{placeholder:"Seu nome",...s}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(F,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Telefone *"}),e.jsx(ur,{...s}),e.jsx(k,{})]})}),e.jsx(F,{control:o.control,name:"email",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Email (Opcional)"}),e.jsx(D,{placeholder:"seu@email.com",...s}),e.jsx(k,{})]})})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(F,{control:o.control,name:"delivery_option",render:({field:s})=>e.jsxs(w,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsxs(Se,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(w,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(fe,{value:"delivery"})}),e.jsx(Xe,{className:"h-5 w-5 text-primary"}),e.jsxs(P,{className:ye("font-normal flex-1 cursor-pointer"),children:["Delivery",B===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(w,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(fe,{value:"pickup"})}),e.jsx(as,{className:"h-5 w-5 text-primary"}),e.jsx(P,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(k,{})]})}),U&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ye,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:s=>{s.preventDefault(),Ms()},disabled:y||N.current,children:[e.jsx(Nr,{className:"h-4 w-4 mr-2"})," ",y||N.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:Ts,children:[e.jsx(br,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(F,{control:o.control,name:"street",render:({field:s})=>e.jsxs(w,{className:"col-span-2",children:[e.jsx(P,{children:"Rua *"}),e.jsx(D,{...s}),e.jsx(k,{})]})}),e.jsx(F,{control:o.control,name:"number",render:({field:s})=>e.jsxs(w,{className:"col-span-1",children:[e.jsx(P,{children:"Número *"}),e.jsx(D,{...s}),e.jsx(k,{})]})})]}),e.jsx(F,{control:o.control,name:"complement",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Complemento (Opcional)"}),e.jsx(D,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(F,{control:o.control,name:"neighborhood",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Bairro *"}),e.jsx(D,{...s}),e.jsx(k,{})]})}),e.jsx(F,{control:o.control,name:"city",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Cidade *"}),e.jsx(D,{...s}),e.jsx(k,{})]})})]}),e.jsx(F,{control:o.control,name:"zip_code",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"CEP *"}),e.jsx(mr,{...s}),e.jsx(k,{})]})}),U&&Re&&e.jsx("div",{children:e.jsx(pr,{mapKey:$s,markerPosition:Os,onLocationChange:As,updateAddressFields:we,restaurant:u})}),y&&B!==!1&&e.jsxs(X,{children:[e.jsx(We,{className:"h-4 w-4 animate-spin"}),e.jsx(Y,{children:"Calculando Taxa..."}),e.jsx(ee,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),j&&B!==!1&&e.jsxs(X,{variant:"destructive",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Entrega"}),e.jsx(ee,{children:j})]}),l>0&&!y&&B!==!1&&e.jsxs(X,{className:"mt-4",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(Y,{children:"Taxa de Entrega Aplicada"}),e.jsxs(ee,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)]})]}),L&&e.jsxs(X,{variant:"destructive",className:"mt-4",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro ao Buscar Endereço"}),e.jsx(ee,{children:L})]}),U&&!Re&&!L&&e.jsxs(X,{variant:"destructive",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx(Y,{children:"Localização Obrigatória"}),e.jsx(ee,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(F,{control:o.control,name:"payment_method_id",render:({field:s})=>e.jsxs(w,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsx(Se,{onValueChange:p=>{s.onChange(p);const h=Q.find(C=>C.id===p);(h==null?void 0:h.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:Q.map(p=>{const h=Wr(p.icon||"Store");return e.jsxs(w,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(fe,{value:p.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(P,{className:"font-normal cursor-pointer",children:p.name}),p.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:p.description})]})]},p.id)})})}),e.jsx(k,{})]})}),pe&&e.jsx(F,{control:o.control,name:"change_for",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Troco para (Opcional)"}),e.jsx(D,{type:"number",placeholder:"Ex: 50.00",...s,value:s.value||"",onChange:p=>s.onChange(p.target.value?parseFloat(p.target.value):null)}),e.jsx(k,{})]})}),me&&e.jsx(F,{control:o.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"CPF/CNPJ *"}),e.jsx(vs,{...s}),e.jsx(k,{})]})})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"4. Observações"})}),e.jsx(de,{children:e.jsx(F,{control:o.control,name:"notes",render:({field:s})=>e.jsxs(w,{children:[e.jsx(P,{children:"Observações do Pedido (Opcional)"}),e.jsx(cr,{placeholder:"Ex: Sem cebola, sem alface...",...s}),e.jsx(k,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(He,{to:"/menu",className:"flex-1",children:e.jsx(ae,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(ae,{type:"submit",className:"flex-1",disabled:!Ds,size:"lg",children:Be?e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(Xr,{subtotal:n,deliveryFee:l,total:m,items:c})})]})]})]})};export{Pt as default};
