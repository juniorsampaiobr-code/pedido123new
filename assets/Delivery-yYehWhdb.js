import{b as H,u as N,c as $,j as e}from"./tanstack-DXzASLyu.js";import{o as A,s as U,p as u,c as p,a as W,u as G,d as J,t as X}from"./types-CUwlEUMq.js";import{s as c}from"./client-lAKPhnc8.js";import{B as x}from"./button-Cm-qj2b4.js";import{C as Y,b as ee,c as ae,a as re}from"./card-C49AbxiW.js";import{I as v}from"./label-FR4vqAf3.js";import{S as se}from"./skeleton-DaPgEs8W.js";import{b as ne,u as y}from"./index-CZFH1qVZ.js";import{A as z,a as T,b as Z}from"./alert-C2WOyTNF.js";import{F as te,b as g,c as w,d as E,e as S}from"./form-D4DmLEkP.js";import{u as ie,r as f,L as oe}from"./vendor-YgypLURK.js";import{S as de}from"./switch-BqwfHovP.js";import{T as le}from"./terminal-Dh6CATmG.js";import{S as ce}from"./settings-CSgNPwbB.js";import{T as me,P as ue}from"./trash-2-DkgELdVM.js";import"./supabase-Bm28tI2t.js";import"./index-CUvv1sQ9.js";const pe=A({id:U().optional(),max_distance_km:u(s=>String(s).replace(",","."),p.number({invalid_type_error:"Distância deve ser um número."}).positive("A distância máxima deve ser maior que zero.")),delivery_fee:u(s=>String(s).replace(",","."),p.number({invalid_type_error:"Taxa deve ser um número."}).min(0,"A taxa não pode ser negativa.")),min_delivery_time_minutes:u(s=>String(s).replace(",","."),p.number({invalid_type_error:"Tempo deve ser um número."}).min(0,"O tempo mínimo não pode ser negativo.")),center_latitude:u(s=>String(s).replace(",","."),p.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),center_longitude:u(s=>String(s).replace(",","."),p.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),xe=A({zones:W(pe)}),ve=async()=>{const{data:s,error:i}=await c.from("restaurants").select("*").limit(1).single();if(i)throw new Error(`Erro ao buscar dados do restaurante: ${i.message}`);if(!s)throw new Error("Nenhum restaurante encontrado.");return s},ge=async s=>{const{data:i,error:a}=await c.from("delivery_zones").select("*").eq("restaurant_id",s).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return i},he=async s=>{const{data:i,error:a}=await c.from("restaurants").select("delivery_enabled").eq("id",s).single();return a?(console.warn("Erro ao buscar status de entrega:",a),!0):i.delivery_enabled??!0},ye=async(s,i)=>{const a={delivery_enabled:i},{error:h}=await c.from("restaurants").update(a).eq("id",s);if(h)throw new Error(`Erro ao atualizar status de entrega: ${h.message}`)},Le=()=>{const s=ie(),i=H(),{data:a,isLoading:h}=N({queryKey:["restaurantDataForDelivery"],queryFn:ve}),{data:_,isLoading:L,isError:F,error:C}=N({queryKey:["deliveryZones",a==null?void 0:a.id],queryFn:()=>ge(a.id),enabled:!!(a!=null&&a.id)}),{data:j,isLoading:P}=N({queryKey:["deliveryStatus",a==null?void 0:a.id],queryFn:()=>he(a.id),enabled:!!(a!=null&&a.id),initialData:!0}),o=G({resolver:X(xe),defaultValues:{zones:[]},mode:"onChange"}),{fields:R,append:k,remove:K,replace:D}=J({control:o.control,name:"zones"}),b=f.useMemo(()=>typeof(a==null?void 0:a.latitude)=="number"&&typeof(a==null?void 0:a.longitude)=="number"?[a.latitude,a.longitude]:[-23.55052,-46.633308],[a==null?void 0:a.latitude,a==null?void 0:a.longitude]),q=f.useCallback(n=>{const t=n.map(r=>({id:r.id,delivery_fee:r.delivery_fee,max_distance_km:r.max_distance_km&&typeof r.max_distance_km=="number"?r.max_distance_km:1,min_delivery_time_minutes:r.min_delivery_time_minutes??0,center_latitude:r.center_latitude,center_longitude:r.center_longitude}));D(t)},[D]);f.useEffect(()=>{_&&q(_)},[_,q]);const I=$({mutationFn:({restaurantId:n,enabled:t})=>ye(n,t),onSuccess:(n,t)=>{i.invalidateQueries({queryKey:["deliveryStatus"]}),i.invalidateQueries({queryKey:["checkoutDeliveryStatus"]}),y.success(`Taxas de entrega ${t.enabled?"ativadas":"desativadas"} com sucesso!`)},onError:n=>{y.error(`Erro ao atualizar status: ${n.message}`)}}),m=$({mutationFn:async n=>{if(!(a!=null&&a.id))throw new Error("ID do restaurante não disponível.");const t=n.zones.map(l=>({restaurant_id:a.id,delivery_fee:l.delivery_fee,max_distance_km:l.max_distance_km,min_delivery_time_minutes:l.min_delivery_time_minutes,center_latitude:l.center_latitude,center_longitude:l.center_longitude,is_active:!0})),{error:r}=await c.from("delivery_zones").delete().eq("restaurant_id",a.id);if(r)throw new Error(`Erro ao limpar zonas antigas: ${r.message}`);const{error:d}=await c.from("delivery_zones").insert(t);if(d)throw new Error(`Erro ao inserir novas zonas: ${d.message}`)},onSuccess:()=>{y.success("Faixas de entrega salvas com sucesso!"),i.invalidateQueries({queryKey:["deliveryZones"]}),i.invalidateQueries({queryKey:["checkoutDeliveryZones"]})},onError:n=>{y.error(`Erro ao salvar faixas de entrega: ${n.message}`)}}),Q=n=>{m.mutate(n)},M=f.useCallback(()=>{k({delivery_fee:5,max_distance_km:10,min_delivery_time_minutes:30,center_latitude:b[0],center_longitude:b[1]})},[k,b]),V=(a==null?void 0:a.latitude)&&(a==null?void 0:a.longitude),B=()=>{a!=null&&a.id&&I.mutate({restaurantId:a.id,enabled:!j})};return L||h||P?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsx(se,{className:"h-96 w-full"})})}):F?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(z,{variant:"destructive",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(T,{children:"Erro ao carregar zonas de entrega"}),e.jsx(Z,{children:C instanceof Error?C.message:"Ocorreu um erro desconhecido."})]})})}):V?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(ae,{className:"text-2xl font-bold",children:"Taxa de Entrega Dinâmica"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina a taxa de entrega com base na distância máxima em quilômetros (km) a partir do centro do seu restaurante."})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-muted p-3 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Taxas de Entrega"}),e.jsx(de,{checked:j,onCheckedChange:B}),e.jsx("span",{className:"text-sm font-medium",children:j?"Ativadas":"Desativadas"})]})]})}),e.jsx(re,{children:e.jsx(te,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(Q),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-3 rounded-lg bg-muted/50 font-semibold text-sm text-muted-foreground",children:[e.jsx("div",{className:"col-span-1",children:"Distância (km)"}),e.jsx("div",{className:"col-span-1",children:"Valor da taxa (R$)"}),e.jsx("div",{className:"col-span-1",children:"Tempo mínimo (min)"}),e.jsx("div",{className:"col-span-1 text-center",children:"Ações"})]}),R.map((n,t)=>e.jsxs("div",{className:"grid grid-cols-4 gap-4 items-center p-4 border rounded-lg relative",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(g,{control:o.control,name:`zones.${t}.max_distance_km`,render:({field:r})=>e.jsxs(w,{children:[e.jsx(E,{children:e.jsx(v,{type:"number",step:"0.1",placeholder:"km",className:"text-center",...r,value:r.value===void 0||r.value===null?"":String(r.value),onChange:d=>{const l=d.target.value,O=l===""?"":parseFloat(l.replace(",","."));r.onChange(O)}})}),e.jsx(S,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(g,{control:o.control,name:`zones.${t}.delivery_fee`,render:({field:r})=>e.jsxs(w,{children:[e.jsx(E,{children:e.jsx(v,{type:"number",step:"0.01",placeholder:"R$",className:"text-center",...r,value:r.value===void 0||r.value===null?"":String(r.value),onChange:d=>r.onChange(d.target.value)})}),e.jsx(S,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(g,{control:o.control,name:`zones.${t}.min_delivery_time_minutes`,render:({field:r})=>e.jsxs(w,{children:[e.jsx(E,{children:e.jsx(v,{type:"number",placeholder:"min",className:"text-center",...r,value:r.value===void 0||r.value===null?"":String(r.value),onChange:d=>r.onChange(d.target.value)})}),e.jsx(S,{})]})})}),e.jsx("div",{className:"col-span-1 flex justify-center gap-2",children:e.jsx(x,{type:"button",variant:"destructive",size:"icon",onClick:()=>K(t),children:e.jsx(me,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"hidden",children:[e.jsx(g,{control:o.control,name:`zones.${t}.center_latitude`,render:({field:r})=>e.jsx(v,{type:"hidden",...r})}),e.jsx(g,{control:o.control,name:`zones.${t}.center_longitude`,render:({field:r})=>e.jsx(v,{type:"hidden",...r})})]})]},n.id)),e.jsxs("div",{className:"mt-8 text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:"Atenção!"}),e.jsx("p",{className:"text-muted-foreground",children:"Com a taxa dinâmica habilitada, você pode adicionar cobrar a taxa de entrega de acordo com a distância do local de entrega. Exemplo: até 2km cobrar R$4,00."})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>s("/settings"),children:"Redefinir local da loja"}),e.jsxs(x,{type:"button",className:ne("bg-pink-500 hover:bg-pink-600 text-white",m.isPending&&"opacity-70 cursor-not-allowed"),onClick:M,disabled:m.isPending,children:[e.jsx(ue,{className:"mr-2 h-4 w-4"})," Adicionar taxa dinâmica"]}),e.jsx(x,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:m.isPending,children:m.isPending?"Salvando...":"Salvar Configurações"})]})]})})})]})})}):e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(z,{children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx(T,{children:"Endereço Não Configurado"}),e.jsxs(Z,{children:["Para configurar zonas de entrega baseadas em distância, primeiro configure o endereço e as coordenadas do seu restaurante na página de Configurações.",e.jsx(oe,{to:"/settings",children:e.jsx(x,{variant:"link",className:"p-0 h-auto mt-2",children:"Ir para Configurações"})})]})]})})})};export{Le as default};
