import{b as U,u as b,c as $,j as e}from"./tanstack-BMR5QDBT.js";import{o as A,s as W,p as x,c as p,a as G,u as J,d as X,t as Y}from"./types-tCkPXq4V.js";import{A as z,o as ee,p as Z,q as T,B as v,C as ae,d as re,e as se,b as te,I as g,a as ne,P as ie,u as y,s as m}from"./index-Bej8qJBN.js";import{S as oe}from"./skeleton-C0zqKVkb.js";import{F as le,a as h,b as N,d as w,e as E}from"./form-CaeWqovP.js";import{h as de,j as ce,r as _,L as me}from"./vendor-DjsPZZVP.js";import{S as ue}from"./switch-YWe5rpGx.js";import{S as xe}from"./settings-BtXGh9jZ.js";import{T as pe}from"./trash-2-Qra0e5gj.js";import"./supabase-BAEEEeUB.js";import"./label-DzLJaA3P.js";import"./index-C3WaO5Hu.js";const ve=A({id:W().optional(),max_distance_km:x(t=>String(t).replace(",","."),p.number({invalid_type_error:"Distância deve ser um número."}).positive("A distância máxima deve ser maior que zero.")),delivery_fee:x(t=>String(t).replace(",","."),p.number({invalid_type_error:"Taxa deve ser um número."}).min(0,"A taxa não pode ser negativa.")),min_delivery_time_minutes:x(t=>String(t).replace(",","."),p.number({invalid_type_error:"Tempo deve ser um número."}).min(0,"O tempo mínimo não pode ser negativo.")),center_latitude:x(t=>String(t).replace(",","."),p.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),center_longitude:x(t=>String(t).replace(",","."),p.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),ge=A({zones:G(ve)}),he=async t=>{const{data:o,error:r}=await m.from("restaurants").select("*").eq("id",t).single();if(r)throw new Error(`Erro ao buscar dados do restaurante: ${r.message}`);if(!o)throw new Error("Nenhum restaurante encontrado.");return o},ye=async t=>{const{data:o,error:r}=await m.from("delivery_zones").select("*").eq("restaurant_id",t).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return o},_e=async t=>{const{data:o,error:r}=await m.from("restaurants").select("delivery_enabled").eq("id",t).single();return r?(console.warn("Erro ao buscar status de entrega:",r),!0):o.delivery_enabled??!0},fe=async(t,o)=>{const r={delivery_enabled:o},{error:s}=await m.from("restaurants").update(r).eq("id",t);if(s)throw new Error(`Erro ao atualizar status de entrega: ${s.message}`)},Ze=()=>{const t=de(),o=U(),{userRestaurantId:r}=ce(),{data:s,isLoading:L}=b({queryKey:["restaurantDataForDelivery",r],queryFn:()=>he(r),enabled:!!r}),{data:f,isLoading:F,isError:R,error:C}=b({queryKey:["deliveryZones",r],queryFn:()=>ye(r),enabled:!!r}),{data:S,isLoading:I}=b({queryKey:["deliveryStatus",r],queryFn:()=>_e(r),enabled:!!r}),l=J({resolver:Y(ge),defaultValues:{zones:[]},mode:"onChange"}),{fields:P,append:k,remove:K,replace:q}=X({control:l.control,name:"zones"}),j=_.useMemo(()=>typeof(s==null?void 0:s.latitude)=="number"&&typeof(s==null?void 0:s.longitude)=="number"?[s.latitude,s.longitude]:[-23.55052,-46.633308],[s==null?void 0:s.latitude,s==null?void 0:s.longitude]),D=_.useCallback(n=>{const i=n.map(a=>({id:a.id,delivery_fee:a.delivery_fee,max_distance_km:a.max_distance_km&&typeof a.max_distance_km=="number"?a.max_distance_km:1,min_delivery_time_minutes:a.min_delivery_time_minutes??0,center_latitude:a.center_latitude,center_longitude:a.center_longitude}));q(i)},[q]);_.useEffect(()=>{f&&D(f)},[f,D]);const Q=$({mutationFn:({restaurantId:n,enabled:i})=>fe(n,i),onSuccess:(n,i)=>{o.invalidateQueries({queryKey:["deliveryStatus",i.restaurantId]}),o.invalidateQueries({queryKey:["checkoutRestaurantData"]}),y.success(`Taxas de entrega ${i.enabled?"ativadas":"desativadas"} com sucesso!`)},onError:n=>{y.error(`Erro ao atualizar status: ${n.message}`)}}),u=$({mutationFn:async n=>{if(!r)throw new Error("ID do restaurante não disponível.");const i=n.zones.map(c=>({restaurant_id:r,delivery_fee:c.delivery_fee,max_distance_km:c.max_distance_km,min_delivery_time_minutes:c.min_delivery_time_minutes,center_latitude:c.center_latitude,center_longitude:c.center_longitude,is_active:!0})),{error:a}=await m.from("delivery_zones").delete().eq("restaurant_id",r);if(a)throw new Error(`Erro ao limpar zonas antigas: ${a.message}`);const{error:d}=await m.from("delivery_zones").insert(i);if(d)throw new Error(`Erro ao inserir novas zonas: ${d.message}`)},onSuccess:()=>{y.success("Faixas de entrega salvas com sucesso!"),o.invalidateQueries({queryKey:["deliveryZones",r]}),o.invalidateQueries({queryKey:["checkoutDeliveryZones"]})},onError:n=>{y.error(`Erro ao salvar faixas de entrega: ${n.message}`)}}),M=n=>{u.mutate(n)},O=_.useCallback(()=>{k({delivery_fee:5,max_distance_km:10,min_delivery_time_minutes:30,center_latitude:j[0],center_longitude:j[1]})},[k,j]),V=(s==null?void 0:s.latitude)&&(s==null?void 0:s.longitude),B=n=>{r&&Q.mutate({restaurantId:r,enabled:n})};return F||L||I?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsx(oe,{className:"h-96 w-full"})})}):R?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(z,{variant:"destructive",children:[e.jsx(ee,{className:"h-4 w-4"}),e.jsx(Z,{children:"Erro ao carregar zonas de entrega"}),e.jsx(T,{children:C instanceof Error?C.message:"Ocorreu um erro desconhecido."})]})})}):V?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(ae,{children:[e.jsx(re,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(se,{className:"text-2xl font-bold",children:"Taxa de Entrega Dinâmica"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina a taxa de entrega com base na distância máxima em quilômetros (km) a partir do centro do seu restaurante."})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-muted p-3 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Taxas de Entrega"}),e.jsx(ue,{checked:S??!0,onCheckedChange:B}),e.jsx("span",{className:"text-sm font-medium",children:S?"Ativadas":"Desativadas"})]})]})}),e.jsx(te,{children:e.jsx(le,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(M),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-3 rounded-lg bg-muted/50 font-semibold text-sm text-muted-foreground",children:[e.jsx("div",{className:"col-span-1",children:"Distância (km)"}),e.jsx("div",{className:"col-span-1",children:"Valor da taxa (R$)"}),e.jsx("div",{className:"col-span-1",children:"Tempo mínimo (min)"}),e.jsx("div",{className:"col-span-1 text-center",children:"Ações"})]}),P.map((n,i)=>e.jsxs("div",{className:"grid grid-cols-4 gap-4 items-center p-4 border rounded-lg relative",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${i}.max_distance_km`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",step:"0.1",placeholder:"km",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>{const c=d.target.value,H=c===""?"":parseFloat(c.replace(",","."));a.onChange(H)}})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${i}.delivery_fee`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",step:"0.01",placeholder:"R$",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${i}.min_delivery_time_minutes`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",placeholder:"min",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1 flex justify-center gap-2",children:e.jsx(v,{type:"button",variant:"destructive",size:"icon",onClick:()=>K(i),children:e.jsx(pe,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"hidden",children:[e.jsx(h,{control:l.control,name:`zones.${i}.center_latitude`,render:({field:a})=>e.jsx(g,{type:"hidden",...a})}),e.jsx(h,{control:l.control,name:`zones.${i}.center_longitude`,render:({field:a})=>e.jsx(g,{type:"hidden",...a})})]})]},n.id)),e.jsxs("div",{className:"mt-8 text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:"Atenção!"}),e.jsx("p",{className:"text-muted-foreground",children:"Com a taxa dinâmica habilitada, você pode adicionar cobrar a taxa de entrega de acordo com a distância do local de entrega. Exemplo: até 2km cobrar R$4,00."})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>t("/settings"),children:"Redefinir local da loja"}),e.jsxs(v,{type:"button",className:ne("bg-pink-500 hover:bg-pink-600 text-white",u.isPending&&"opacity-70 cursor-not-allowed"),onClick:O,disabled:u.isPending||!r,children:[e.jsx(ie,{className:"mr-2 h-4 w-4"})," Adicionar taxa dinâmica"]}),e.jsx(v,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:u.isPending||!r,children:u.isPending?"Salvando...":"Salvar Configurações"})]})]})})})]})})}):e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(z,{children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx(Z,{children:"Endereço Não Configurado"}),e.jsxs(T,{children:["Para configurar zonas de entrega baseadas em distância, primeiro configure o endereço e as coordenadas do seu restaurante na página de Configurações.",e.jsx(me,{to:"/settings",children:e.jsx(v,{variant:"link",className:"p-0 h-auto mt-2",children:"Ir para Configurações"})})]})]})})})};export{Ze as default};
