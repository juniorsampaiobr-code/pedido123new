import{c as T,e as $,r as S,j as e,a as x}from"./index-zkuE9Bm6.js";import{u as h}from"./useQuery-Bop5DQT3.js";import{u as C}from"./useMutation-DTwKCpeC.js";import{o as A,p as I,c as k,s as P,u as F,t as E}from"./types-BjVHfDxe.js";import{s as u}from"./client-g0uDe16g.js";import{B as q}from"./button-3xZnEy7f.js";import{C as D,b as O,c as L,a as R}from"./card-B1F0wEox.js";import{L as f,I as j}from"./label-CD9lqJez.js";import{S as l}from"./skeleton-CBZEqJVS.js";import{A as Q,T as U,a as V,b as H}from"./alert-B4s-E96m.js";import{D as G}from"./dollar-sign-MxpQT_7w.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=T("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=T("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),W=A({opening_balance:I(r=>String(r).replace(",","."),k.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo inicial não pode ser negativo."))}),X=A({closing_balance:I(r=>String(r).replace(",","."),k.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo final não pode ser negativo.")),notes:P().optional()}),Y=async r=>{const{data:t,error:n}=await u.from("cash_register").select("*").eq("restaurant_id",r).is("closed_at",null).order("opened_at",{ascending:!1}).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Erro ao buscar caixa: ${n.message}`);return t||null},Z=async()=>0,v=({title:r,value:t,icon:n})=>e.jsxs(D,{children:[e.jsxs(O,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:r}),e.jsx(n,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(R,{children:e.jsx("div",{className:"text-2xl font-bold",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})})]}),me=()=>{const r=$(),[t,n]=S.useState(null),[o,B]=S.useState(null);h({queryKey:["userSession"],queryFn:async()=>{const{data:{session:s}}=await u.auth.getSession();return s!=null&&s.user&&n(s.user),s}}),h({queryKey:["restaurantId"],queryFn:async()=>{const{data:s,error:c}=await u.from("restaurants").select("id").limit(1).single();if(c)throw new Error(c.message);return B(s.id),s.id},enabled:!!t});const{data:a,isLoading:K,isError:M,error:_}=h({queryKey:["currentCashier",o],queryFn:()=>Y(o),enabled:!!o}),{data:w=0}=h({queryKey:["salesToday",a==null?void 0:a.opened_at],queryFn:Z,enabled:!!a}),g=((a==null?void 0:a.opening_balance)||0)+w,p=!!a,d=F({resolver:E(W),defaultValues:{opening_balance:0}}),i=F({resolver:E(X),defaultValues:{closing_balance:g,notes:""},values:{closing_balance:g,notes:""}}),y=C({mutationFn:async s=>{if(!o||!t)throw new Error("Dados de usuário ou restaurante indisponíveis.");const c={restaurant_id:o,opening_balance:s.opening_balance,opened_by:t.id},{error:m}=await u.from("cash_register").insert(c);if(m)throw new Error(m.message)},onSuccess:()=>{x.success("Caixa aberto com sucesso!"),r.invalidateQueries({queryKey:["currentCashier"]}),d.reset({opening_balance:0})},onError:s=>{x.error(`Erro ao abrir caixa: ${s.message}`)}}),b=C({mutationFn:async s=>{if(!(a!=null&&a.id)||!t)throw new Error("Nenhum caixa aberto para fechar.");const c={closed_at:new Date().toISOString(),closed_by:t.id,closing_balance:s.closing_balance,notes:s.notes},{error:m}=await u.from("cash_register").update(c).eq("id",a.id);if(m)throw new Error(m.message)},onSuccess:()=>{x.success("Caixa fechado com sucesso!"),r.invalidateQueries({queryKey:["currentCashier"]}),i.reset()},onError:s=>{x.error(`Erro ao fechar caixa: ${s.message}`)}}),N=K||!o;return e.jsxs("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:[M&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(U,{className:"h-4 w-4"}),e.jsx(V,{children:"Erro ao carregar caixa"}),e.jsx(H,{children:_ instanceof Error?_.message:"Ocorreu um erro desconhecido."})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:N?e.jsxs(e.Fragment,{children:[e.jsx(l,{className:"h-28 w-full"}),e.jsx(l,{className:"h-28 w-full"}),e.jsx(l,{className:"h-28 w-full"})]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{title:"Saldo Inicial",value:(a==null?void 0:a.opening_balance)||0,icon:G}),e.jsx(v,{title:"Vendas Hoje",value:w,icon:J}),e.jsx(v,{title:"Saldo Atual",value:g,icon:z})]})}),e.jsxs(D,{className:"max-w-3xl mx-auto",children:[e.jsxs(O,{children:[e.jsx(L,{className:"text-2xl font-bold",children:"Controle de Caixa"}),e.jsxs("p",{className:`text-sm font-medium ${p?"text-green-600":"text-destructive"}`,children:["Caixa está ",p?"aberto":"fechado"]}),p&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Aberto em: ",new Date(a.opened_at).toLocaleString("pt-BR")]})]}),e.jsx(R,{children:N?e.jsxs("div",{className:"space-y-4",children:[e.jsx(l,{className:"h-10 w-1/3"}),e.jsx(l,{className:"h-12 w-full"}),e.jsx(l,{className:"h-12 w-full mt-4"})]}):p?e.jsxs("form",{onSubmit:i.handleSubmit(s=>b.mutate(s)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"closing_balance",children:"Saldo Final (R$)"}),e.jsx(j,{id:"closing_balance",type:"number",step:"0.01",...i.register("closing_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),i.formState.errors.closing_balance&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.closing_balance.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"notes",children:"Observações (Opcional)"}),e.jsx(j,{id:"notes",...i.register("notes"),className:"h-12"})]}),e.jsx(q,{type:"submit",className:"w-full bg-destructive hover:bg-destructive/90 text-destructive-foreground h-12 text-lg",disabled:b.isPending,children:b.isPending?"Fechando...":"Fechar Caixa"})]}):e.jsxs("form",{onSubmit:d.handleSubmit(s=>y.mutate(s)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"opening_balance",children:"Saldo Inicial (R$)"}),e.jsx(j,{id:"opening_balance",type:"number",step:"0.01",...d.register("opening_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),d.formState.errors.opening_balance&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.opening_balance.message})]}),e.jsx(q,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg",disabled:y.isPending,children:y.isPending?"Abrindo...":"Abrir Caixa"})]})})]})]})};export{me as default};
