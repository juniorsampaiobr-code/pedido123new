import{u as le,j as e,a as Vr,b as Ee}from"./tanstack-C7aOFagJ.js";import{r as d,h as qr,i as Br,k as Kr,L as Re}from"./vendor-DjsPZZVP.js";import{c as zr,s as S,a9 as ar,aa as Me,ab as we,ac as Pe,ad as Ur,ae as Zr,aj as Qr,af as Xr,a as me,j as y,D as Ue,v as Ze,L as ue,w as Hr,x as Jr,a1 as sr,y as Yr,B as Z,C as Q,e as X,f as H,a0 as Ie,b as J,o as or,n as V,aH as Wr,aI as et,u as rt,r as Qe,W as te,X as Xe,Y as se,Z as oe,d as He,ag as tt,aJ as nt,U as Je,aK as at,F as Ye,h as D,I as ie,aC as de,P as st,i as ot,a4 as ye,a3 as it,A as ct,G as dt,V as lt,ah as ut,M as mt,T as ft,t as We}from"./index-B_8iKdHW.js";import{L as pt,g as er,c as rr,Z as ht}from"./location-C6Q0nKtF.js";import{c as ir,R as xt,I as gt}from"./index-BWQ-X_f6.js";import{u as yt}from"./index-C3WaO5Hu.js";import{S as tr}from"./separator-DkmJi7jC.js";import{A as jt}from"./arrow-left-Cozcy9dF.js";import{C as Se}from"./circle-alert-BS07irRz.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=zr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),wt=async()=>{const{data:r,error:a}=await S.from("restaurants").select("id").limit(1).single();if(a||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const n=r.id,{data:i,error:l}=await S.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",n).limit(1).single();if(l&&l.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${l.message}`);return(i==null?void 0:i.mercado_pago_public_key)||null},cr=()=>le({queryKey:["mercadoPagoPublicKey"],queryFn:wt,staleTime:1/0});var Le="Radio",[_t,dr]=ar(Le),[bt,Nt]=_t(Le),lr=d.forwardRef((r,a)=>{const{__scopeRadio:n,name:i,checked:l=!1,required:h,disabled:v,value:o="on",onCheck:I,form:F,...N}=r,[E,L]=d.useState(null),b=Me(a,T=>L(T)),P=d.useRef(!1),R=E?F||!!E.closest("form"):!0;return e.jsxs(bt,{scope:n,checked:l,disabled:v,children:[e.jsx(we.button,{type:"button",role:"radio","aria-checked":l,"data-state":pr(l),"data-disabled":v?"":void 0,disabled:v,value:o,...N,ref:b,onClick:Pe(r.onClick,T=>{l||I==null||I(),R&&(P.current=T.isPropagationStopped(),P.current||T.stopPropagation())})}),R&&e.jsx(fr,{control:E,bubbles:!P.current,name:i,value:o,checked:l,required:h,disabled:v,form:F,style:{transform:"translateX(-100%)"}})]})});lr.displayName=Le;var ur="RadioIndicator",mr=d.forwardRef((r,a)=>{const{__scopeRadio:n,forceMount:i,...l}=r,h=Nt(ur,n);return e.jsx(Ur,{present:i||h.checked,children:e.jsx(we.span,{"data-state":pr(h.checked),"data-disabled":h.disabled?"":void 0,...l,ref:a})})});mr.displayName=ur;var Ct="RadioBubbleInput",fr=d.forwardRef(({__scopeRadio:r,control:a,checked:n,bubbles:i=!0,...l},h)=>{const v=d.useRef(null),o=Me(v,h),I=yt(n),F=Zr(a);return d.useEffect(()=>{const N=v.current;if(!N)return;const E=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(E,"checked").set;if(I!==n&&b){const P=new Event("click",{bubbles:i});b.call(N,n),N.dispatchEvent(P)}},[I,n,i]),e.jsx(we.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...l,tabIndex:-1,ref:o,style:{...l.style,...F,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});fr.displayName=Ct;function pr(r){return r?"checked":"unchecked"}var Et=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],_e="RadioGroup",[Rt,cn]=ar(_e,[ir,dr]),hr=ir(),xr=dr(),[St,Pt]=Rt(_e),gr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,name:i,defaultValue:l,value:h,required:v=!1,disabled:o=!1,orientation:I,dir:F,loop:N=!0,onValueChange:E,...L}=r,b=hr(n),P=Qr(F),[R,T]=Xr({prop:h,defaultProp:l??null,onChange:E,caller:_e});return e.jsx(St,{scope:n,name:i,required:v,disabled:o,value:R,onValueChange:T,children:e.jsx(xt,{asChild:!0,...b,orientation:I,dir:P,loop:N,children:e.jsx(we.div,{role:"radiogroup","aria-required":v,"aria-orientation":I,"data-disabled":o?"":void 0,dir:P,...L,ref:a})})})});gr.displayName=_e;var yr="RadioGroupItem",jr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,disabled:i,...l}=r,h=Pt(yr,n),v=h.disabled||i,o=hr(n),I=xr(n),F=d.useRef(null),N=Me(a,F),E=h.value===l.value,L=d.useRef(!1);return d.useEffect(()=>{const b=R=>{Et.includes(R.key)&&(L.current=!0)},P=()=>L.current=!1;return document.addEventListener("keydown",b),document.addEventListener("keyup",P),()=>{document.removeEventListener("keydown",b),document.removeEventListener("keyup",P)}},[]),e.jsx(gt,{asChild:!0,...o,focusable:!v,active:E,children:e.jsx(lr,{disabled:v,required:h.required,checked:E,...I,...l,name:h.name,ref:N,onCheck:()=>h.onValueChange(l.value),onKeyDown:Pe(b=>{b.key==="Enter"&&b.preventDefault()}),onFocus:Pe(l.onFocus,()=>{var b;L.current&&((b=F.current)==null||b.click())})})})});jr.displayName=yr;var It="RadioGroupIndicator",vr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,...i}=r,l=xr(n);return e.jsx(mr,{...l,...i,ref:a})});vr.displayName=It;var wr=gr,_r=jr,Ft=vr;const Fe=d.forwardRef(({className:r,...a},n)=>e.jsx(wr,{className:me("grid gap-2",r),...a,ref:n}));Fe.displayName=wr.displayName;const ve=d.forwardRef(({className:r,...a},n)=>e.jsx(_r,{ref:n,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(Ft,{className:"flex items-center justify-center",children:e.jsx(vt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ve.displayName=_r.displayName;var ke={};Object.defineProperty(ke,"__esModule",{value:!0});var br=ke.loadMercadoPago=void 0;const Nr="https://sdk.mercadopago.com/js/v2",Mt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,nr="MercadoPago has already been initialized in your window, please remove the duplicate import",Lt="MercadoPago.js not available",kt="Failed to load MercadoPago.js",Ot=()=>{for(var r=document.querySelectorAll(`script[src^="${Nr}"`),a=0;a<r.length;a++){var n=r[a];if(Mt.test(n.src))return n}return null},At=()=>{const r=document.createElement("script");r.src=Nr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let je=null;const Dt=()=>(je!==null||(je=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(nr),r(window.MercadoPago);return}try{let n=Ot();n?console.warn(nr):n||(n=At()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(Lt))}),n.addEventListener("error",()=>{a(new Error(kt))})}catch(n){a(n);return}})),je);br=ke.loadMercadoPago=Dt;var Tt=function(r,a,n,i){function l(h){return h instanceof n?h:new n(function(v){v(h)})}return new(n||(n=Promise))(function(h,v){function o(N){try{F(i.next(N))}catch(E){v(E)}}function I(N){try{F(i.throw(N))}catch(E){v(E)}}function F(N){N.done?h(N.value):l(N.value).then(o,I)}F((i=i.apply(r,a||[])).next())})};class U{static getInstance(){return Tt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield br(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}U.publicKey=null;U.options={};U.instanceMercadoPago=void 0;U.loadedInstanceMercadoPago=!1;function $t(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(i=>Object.prototype.hasOwnProperty.call(a,i)&&r[i]===a[i])}const Gt=(r,a)=>{const n=Object.assign(Object.assign({},a),{frontEndStack:"react"}),i=!$t(U.options,n);(r!==U.publicKey||i)&&(U.publicKey=r,U.options=n,U.instanceMercadoPago=void 0)},Vt=({preferenceId:r,initPoint:a,onClose:n})=>{const{data:i,isLoading:l}=cr();return d.useEffect(()=>{if(i)try{Gt(i,{locale:"pt-BR"})}catch(h){console.error("Erro ao inicializar Mercado Pago:",h),y.error("Erro ao carregar o SDK do Mercado Pago."),n();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[i,n,a]),l||!i?e.jsx(Ue,{open:!0,onOpenChange:n,children:e.jsx(Ze,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(Ue,{open:!0,onOpenChange:n,children:e.jsxs(Ze,{className:"sm:max-w-[425px]",children:[e.jsxs(Hr,{children:[e.jsxs(Jr,{className:"flex items-center gap-2",children:[e.jsx(sr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Yr,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Z,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},qt=({latitude:r,longitude:a,address:n,className:i})=>{const l=d.useMemo(()=>[r,a],[r,a]),h=d.useMemo(()=>[r,a],[r,a]),v=d.useMemo(()=>`client-location-${r.toFixed(6)}-${a.toFixed(6)}`,[r,a]);return e.jsxs(Q,{className:me("w-full",i),children:[e.jsxs(X,{children:[e.jsxs(H,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(J,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(pt,{center:h,markerPosition:l,onMarkerDragEnd:()=>{},zoom:16},v)})})]})},Bt=or({zip_code:V().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:V().min(1,"Rua é obrigatória."),number:V().min(1,"Número é obrigatório."),neighborhood:V().min(1,"Bairro é obrigatório."),city:V().min(1,"Cidade é obrigatória.")}),Kt=or({name:V().min(1,"Nome é obrigatório."),phone:V().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:V().min(1,"CPF/CNPJ é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Wr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:V().optional(),payment_method_id:V().min(1,"Selecione um método de pagamento."),change_for:V().optional()}),zt=async r=>{const{data:a,error:n}=await S.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},Ut=async r=>{const{data:a,error:n}=await S.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return a},Zt=async r=>{const{data:a,error:n}=await S.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return a},Qt=async r=>{const{data:a,error:n}=await S.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return a||null},dn=()=>{var Ve,qe,Be,Ke,ze;const r=qr(),a=Br(),[n]=Kr(),i=Vr(),{items:l,totalAmount:h,clearCart:v}=et(),{data:o,isLoading:I}=rt(),{data:F}=cr(),[N,E]=d.useState(!1),[L,b]=d.useState(!1),[P,R]=d.useState(0),[T,G]=d.useState(null),[be,q]=d.useState(!0),[Y,fe]=d.useState(null),[Cr,Ne]=d.useState(!1),[Er,Rr]=d.useState(null),[Oe,Sr]=d.useState(null),[z,W]=d.useState(!1),Pr=(Ve=a.state)==null?void 0:Ve.restaurantId,Ir=n.get("restaurantId"),B=Pr||Ir;d.useEffect(()=>{console.log("LOG: Checkout - User Status:",o?`Logged in as ${o.email}`:"Anonymous")},[o]);const{data:x,isLoading:Fr,isError:Mr,error:Ae,refetch:Lr}=le({queryKey:["checkoutRestaurantData",B],queryFn:()=>zt(B),enabled:!!B,staleTime:1/0}),{data:ee,isLoading:kr}=le({queryKey:["checkoutDeliveryZones",B],queryFn:()=>Ut(x.id),enabled:!!x,staleTime:1/0}),{data:ne,isLoading:Or}=le({queryKey:["checkoutPaymentMethods",B],queryFn:()=>Zt(x.id),enabled:!!x,staleTime:1/0}),{data:g,isLoading:De,refetch:Xt}=le({queryKey:["checkoutCustomerData",o==null?void 0:o.id],queryFn:()=>Qt(o.id),enabled:!!o,staleTime:0}),pe=d.useMemo(()=>x!=null&&x.latitude&&(x!=null&&x.longitude)?[x.latitude,x.longitude]:null,[x]),Ce=d.useCallback(async(t,s,u,f,p,m,C)=>{const j=[30,45];if(x&&x.delivery_enabled===!1){const w=`${s}, ${u}, ${p}, ${f}, ${t}`;let A=null;if(m&&C)A={lat:m,lng:C};else{b(!0);const re=y.loading("Validando endereço para frete grátis...");A=await er(w),b(!1),y.dismiss(re)}if(!A)return R(0),G(null),q(!1),y.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(fe([A.lat,A.lng]),ee&&ee.length>0){const re=rr([A.lat,A.lng],pe,ee);if(re)return R(0),G([re.minTime,re.maxTime]),q(!0),{coords:A,fee:0,time:[re.minTime,re.maxTime],isValid:!0}}return R(0),G(j),q(!0),{coords:A,fee:0,time:j,isValid:!0}}if(!x||!pe)return R(0),q(!0),G(j),{coords:null,fee:0,time:j,isValid:!0};const $=`${s}, ${u}, ${p}, ${f}, ${t}`;let O=null;if(m&&C)O={lat:m,lng:C};else{b(!0);const w=y.loading("Calculando taxa de entrega...");O=await er($),b(!1),y.dismiss(w)}if(!O)return R(0),G(null),q(!1),y.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(fe([O.lat,O.lng]),ee&&ee.length>0){const w=rr([O.lat,O.lng],pe,ee);return w?(R(w.fee),G([w.minTime,w.maxTime]),q(!0),{coords:O,fee:w.fee,time:[w.minTime,w.maxTime],isValid:!0}):(R(0),G(null),q(!1),y.error("Endereço fora da área de entrega."),{coords:O,fee:0,time:null,isValid:!1})}else return R(0),G(j),q(!0),{coords:O,fee:0,time:j,isValid:!0}},[x,pe,ee]),c=Qe({resolver:We(Kt),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),_=Qe({resolver:We(Bt),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),k=c.watch("delivery_option"),Ar=c.watch("payment_method_id"),ae=ne==null?void 0:ne.find(t=>t.id===Ar),he=(qe=ae==null?void 0:ae.name)==null?void 0:qe.includes("online"),ce=(Be=ae==null?void 0:ae.name)==null?void 0:Be.includes("Dinheiro"),K=h+P,M=_.watch(["zip_code","street","number","city","neighborhood"]);d.useEffect(()=>{const t=[15,30];k==="pickup"?(R(0),q(!0),W(!0),G(t)):(W(!1),G(null))},[k]),d.useEffect(()=>{if(g){let t="",s="",u="",f="",p="";if(g.address){const m=g.address.split(", ").map(C=>C.trim());m.length>=5?(t=m[0],s=m[1],u=m[2],f=m[3],p=m[4]):m.length>=4&&(t=m[0],u=m[1],f=m[2],p=m[3])}c.reset({...c.getValues(),name:g.name||"",phone:g.phone||"",cpf_cnpj:g.cpf_cnpj||"",change_for:""}),_.reset({zip_code:p,street:t,number:s,neighborhood:u,city:f}),g.address&&g.latitude&&g.longitude&&(fe([g.latitude,g.longitude]),W(!0),Ce(p,t,s,f,u,g.latitude,g.longitude))}else if(o&&!De){const t=o.user_metadata;c.reset({...c.getValues(),name:t.full_name||"",phone:t.phone||"",cpf_cnpj:t.cpf_cnpj||"",change_for:""})}},[g,c,o,De,_,Ce]);const xe=c.watch("change_for");d.useEffect(()=>{if(ce&&xe&&xe.trim()!==""){const t=xe.replace(",","."),s=parseFloat(t);isNaN(s)?c.setError("change_for",{message:"O troco deve ser um número válido."}):s<K?c.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(K)}).`}):c.clearErrors("change_for")}else c.clearErrors("change_for")},[ce,xe,K,c]);const ge=Ee({mutationFn:async t=>{var m;const u=(m=(await S.auth.getUser()).data.user)==null?void 0:m.id;if(!(g!=null&&g.id)&&!u)throw new Error("ID do cliente ou usuário não encontrado.");const f=`${t.street}, ${t.number}, ${t.neighborhood}, ${t.city}, ${t.zip_code}`,p={user_id:(o==null?void 0:o.id)||null,name:c.getValues("name"),phone:c.getValues("phone"),email:(o==null?void 0:o.email)||null,cpf_cnpj:c.getValues("cpf_cnpj")||null,address:f,latitude:t.lat,longitude:t.lng};if(g!=null&&g.id){const{data:C,error:j}=await S.from("customers").update(p).eq("id",g.id).select().single();if(j)throw j;return C}else if(u){const{data:C,error:j}=await S.from("customers").insert(p).select().single();if(j)throw j;return C}else return{id:"anonymous",user_id:null,name:p.name,phone:p.phone,email:p.email,address:f,created_at:"",updated_at:"",latitude:t.lat,longitude:t.lng,cpf_cnpj:p.cpf_cnpj}},onSuccess:(t,s)=>{t.id!=="anonymous"&&i.invalidateQueries({queryKey:["checkoutCustomerData"]}),R(s.fee),G(s.time),q(s.isValid),W(!0),fe([s.lat,s.lng]),y.success("Endereço salvo e taxa de entrega calculada!")},onError:t=>{y.error(`Erro ao salvar endereço: ${t.message}`),W(!1)}}),Dr=async()=>{if(k==="pickup")return;if(!await _.trigger()){y.error("Preencha todos os campos obrigatórios do endereço.");return}const s=_.getValues(),u=await Ce(s.zip_code,s.street,s.number,s.city,s.neighborhood);if(!u.isValid){W(!1);return}if(!u.coords){y.error("Não foi possível obter as coordenadas para salvar o endereço."),W(!1);return}ge.mutate({...s,lat:u.coords.lat,lng:u.coords.lng,fee:u.fee,time:u.time,isValid:u.isValid})},Te=Ee({mutationFn:async t=>{var m,C;(m=(await S.auth.getUser()).data.user)==null||m.id;const u=t.phone.replace(/\D/g,""),f=((C=t.cpf_cnpj)==null?void 0:C.replace(/\D/g,""))||null,p={user_id:(o==null?void 0:o.id)||null,name:t.name,phone:u,email:(o==null?void 0:o.email)||null,cpf_cnpj:f,address:k==="delivery"?`${M[1]}, ${M[2]}, ${M[4]}, ${M[3]}, ${M[0]}`:null,latitude:Y?Y[0]:null,longitude:Y?Y[1]:null};if(o)if(g){const{data:j,error:$}=await S.from("customers").update(p).eq("id",g.id).select().single();if($)throw $;return j}else{const{data:j,error:$}=await S.from("customers").insert(p).select().single();if($)throw $;return j}else{const{data:j,error:$}=await S.from("customers").insert(p).select().single();if($)throw $;return j}},onSuccess:()=>{i.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:t=>{y.error(`Erro ao salvar dados do cliente: ${t.message}`)}}),$e=Ee({mutationFn:async({customerId:t,data:s})=>{if(!x)throw new Error("Dados do restaurante não disponíveis.");let u=null;if(ce&&s.change_for&&s.change_for.trim()!==""){const w=s.change_for.replace(",","."),A=parseFloat(w);!isNaN(A)&&A>K&&(u=A)}let[f,p]=T||[null,null];if((k==="delivery"||k==="pickup")&&(!f||!p)){const w=k==="pickup"?[15,30]:[30,45];f=w[0],p=w[1]}console.log("LOG: Tempo de entrega salvo no pedido:",f,p);const m={restaurant_id:x.id,customer_id:t,status:he?"pending_payment":"pending",total_amount:K,delivery_fee:P,delivery_address:k==="delivery"?`${M[1]}, ${M[2]}, ${M[4]}, ${M[3]}, ${M[0]}`:null,notes:s.notes,payment_method_id:s.payment_method_id,change_for:u,min_delivery_time_minutes:f,max_delivery_time_minutes:p},{data:C,error:j}=await S.from("orders").insert(m).select("id").single();if(j)throw j;const $=l.map(w=>({order_id:C.id,product_id:w.product.id,quantity:parseFloat(w.quantity.toFixed(3)),unit_price:parseFloat(w.product.price.toFixed(2)),subtotal:parseFloat(w.subtotal.toFixed(2)),notes:w.notes})),{error:O}=await S.from("order_items").insert($);if(O)throw O;return C.id},onSuccess:t=>{i.invalidateQueries({queryKey:["orders"]})},onError:t=>{y.error(`Erro ao criar pedido: ${t.message}`)}}),Tr=async t=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",he),console.log("LOG: deliveryOption:",k),console.log("LOG: isAddressSaved: ",z),console.log("LOG: change_for data:",t.change_for),ce&&t.change_for&&t.change_for.trim()!==""){const f=t.change_for.replace(",","."),p=parseFloat(f);if(isNaN(p)){y.error("O troco deve ser um número válido.");return}if(p<K){c.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(K)}).`});return}}if(l.length===0){y.error("Seu carrinho está vazio."),r(`/menu/${B}`);return}if(k==="delivery"){if(!z){y.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!be){y.error("O endereço de entrega está fora da área de cobertura.");return}}let s;try{console.log("LOG: Criando/Atualizando cliente..."),s=(await Te.mutateAsync(t)).id,console.log("LOG: Cliente ID:",s)}catch(f){y.error(`Falha ao salvar cliente: ${f.message}`);return}let u;try{console.log("LOG: Criando pedido..."),u=await $e.mutateAsync({customerId:s,data:t}),console.log("LOG: Pedido ID:",u)}catch(f){y.error(`Falha ao criar pedido: ${f.message}`);return}he?(console.log("LOG: Iniciando checkout Mercado Pago..."),await $r(u,t)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),v(),r(`/order-success/${u}`,{replace:!0}))},$r=async(t,s)=>{if(!x)return;const u=window.location.origin+window.location.pathname,f=l.map(m=>({name:m.product.name,price:m.product.price,quantity:m.quantity})),p=y.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:m,error:C}=await S.functions.invoke("create-payment-preference",{body:{orderId:t,items:f,totalAmount:K,restaurantName:x.name,clientUrl:u,customerEmail:(o==null?void 0:o.email)||"cliente@anonimo.com",customerCpfCnpj:s.cpf_cnpj}});if(C)throw C;const{init_point:j}=m;console.log("LOG: Preferência MP criada. init_point:",j),Rr(t),Sr(j),Ne(!0),y.dismiss(p)}catch(m){console.error("Erro ao criar preferência MP:",m),y.dismiss(p),y.error(`Erro no pagamento online: ${m.message}`),Ne(!1)}},Gr=async()=>{await S.auth.signOut(),y.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!B)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(se,{children:"Erro de Rastreamento"}),e.jsx(oe,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Re,{to:"/",children:e.jsx(Z,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(l.length===0)return d.useEffect(()=>{r(`/menu/${B}`)},[r,B]),e.jsx(He,{});if(Fr||kr||Or||I)return e.jsx(He,{});if(Mr||!x)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(se,{children:"Erro Crítico"}),e.jsx(oe,{children:Ae instanceof Error?Ae.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Z,{onClick:()=>Lr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(tt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ge=Te.isPending||$e.isPending||ge.isPending||L||k==="delivery"&&!z;return e.jsxs("div",{className:"min-h-screen bg-background py-4 sm:py-8 px-4 sm:px-8",children:[e.jsx(nt,{isOpen:N,onClose:()=>E(!1),customer:g}),Cr&&Oe&&e.jsx(Vt,{preferenceId:Er,initPoint:Oe,onClose:()=>Ne(!1)}),e.jsxs("div",{className:"w-full lg:max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Re,{to:`/menu/${B}`,children:e.jsx(Z,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(jt,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:x.name})]})]}),o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Z,{variant:"outline",size:"sm",onClick:()=>E(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(Je,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:Gr,children:[e.jsx(at,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(J,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:o?`Logado como ${o.email}. ${g?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsxs(Ye,{...c,children:[" ",e.jsx("form",{onSubmit:c.handleSubmit(Tr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(ie,{id:"name",...c.register("name")}),c.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"phone",children:"Telefone *"}),e.jsx(de,{name:"phone",control:c.control,render:({field:t})=>e.jsx(st,{id:"phone",...t})}),c.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(de,{name:"cpf_cnpj",control:c.control,render:({field:t})=>e.jsx(ot,{id:"cpf_cnpj",...t})}),c.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.cpf_cnpj.message})]})]})})]})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(J,{children:e.jsx(de,{name:"delivery_option",control:c.control,render:({field:t})=>e.jsxs(Fe,{onValueChange:t.onChange,value:t.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(D,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(ye,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(D,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ie,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),k==="delivery"&&e.jsxs(Q,{className:me(!z&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(X,{children:[e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",z&&e.jsx(it,{className:"h-5 w-5 text-green-500 ml-2"}),!z&&e.jsx(Se,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(J,{className:"space-y-4",children:[x.delivery_enabled===!1&&e.jsxs(te,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(se,{children:"Frete Grátis Ativo"}),e.jsx(oe,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsxs(Ye,{..._,children:[" ",e.jsxs("form",{onSubmit:t=>{t.preventDefault(),Dr()},id:"address-form-inner",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(D,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(de,{name:"zip_code",control:_.control,render:({field:t})=>e.jsx(ct,{className:"flex-1 space-y-0",children:e.jsx(dt,{children:e.jsx(ht,{placeholder:"Digite o CEP",...t})})})}),_.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"street",children:"Rua *"}),e.jsx(ie,{id:"street",..._.register("street")}),_.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"number",children:"Número *"}),e.jsx(ie,{id:"number",..._.register("number")}),_.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(ie,{id:"neighborhood",..._.register("neighborhood")}),_.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"city",children:"Cidade *"}),e.jsx(ie,{id:"city",..._.register("city")}),_.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:_.formState.errors.city.message})]}),e.jsxs(Z,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ge.isPending||L,children:[ge.isPending||L?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(lt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]})]}),L&&e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(se,{children:"Calculando Taxa de Entrega..."})]}),z&&!L&&e.jsxs(e.Fragment,{children:[x.delivery_enabled!==!1&&!be&&e.jsxs(te,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(se,{children:"Fora da Área de Entrega"}),e.jsx(oe,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(x.delivery_enabled===!1||be&&T)&&e.jsxs(te,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(se,{children:"Entrega Disponível"}),e.jsxs(oe,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P),". Tempo estimado: ",T?`${T[0]} - ${T[1]}`:"30 - 45"," minutos."]})]})]}),z&&Y&&e.jsx("div",{className:"mt-6",children:e.jsx(qt,{latitude:Y[0],longitude:Y[1],address:`${M[1]}, ${M[2]} - ${M[4]}, ${M[3]}, ${M[0]}`})})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(sr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(J,{children:[e.jsx(de,{name:"payment_method_id",control:c.control,render:({field:t})=>e.jsx(Fe,{onValueChange:t.onChange,value:t.value,className:"space-y-3",children:ne==null?void 0:ne.map(s=>{var f;const u=((f=s.name)==null?void 0:f.includes("online"))&&!F;return e.jsx(D,{htmlFor:s.id,className:me("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",u&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{value:s.id,id:s.id,disabled:u}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description}),u&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},s.id)})})}),c.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:c.formState.errors.payment_method_id.message})]})]}),ce&&e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ut,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(ie,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(K),...c.register("change_for")}),((Ke=c.formState.errors.change_for)==null?void 0:Ke.message)&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.change_for.message}),((ze=c.formState.errors.change_for)==null?void 0:ze.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.change_for.message})]})})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(mt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(ft,{id:"notes",...c.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(Q,{className:"shadow-lg",children:[e.jsx(X,{children:e.jsx(H,{className:"text-2xl",children:"Resumo"})}),e.jsxs(J,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:l.map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[t.quantity,"x ",t.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.subtotal)})]},t.product.id))}),e.jsx(tr,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(h)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P)})]})]}),e.jsx(tr,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(K)})]}),e.jsx(Z,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ge,children:Ge?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):he?"Pagar e Finalizar":"Confirmar Pedido"}),k==="delivery"&&!z&&e.jsxs(te,{variant:"destructive",className:"mt-3",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(oe,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Re,{to:`/menu/${x.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{dn as default};
