import{j as e}from"./tanstack-C7aOFagJ.js";import{h as $,r as d,L as G}from"./vendor-DjsPZZVP.js";import{L as B}from"./Logo-DxmIvF6-.js";import{c as H,s as m,d as W,C as K,e as Q,f as X,M as F,g as Y,b as Z,h as x,I as v,B as y,L as A,P as ee,i as ae,j as s}from"./index-B0PY5gCf.js";import{S as re}from"./separator-bJ1mRx8b.js";import{L as se}from"./lock-CPoumBn4.js";import{A as te}from"./arrow-left-Cw_WpUFC.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=H("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),_=t=>t.replace(/\D/g,""),q=t=>t.replace(/\D/g,""),D=async t=>{const{data:c,error:o}=await m.from("user_roles").select("role, restaurant_id").eq("user_id",t).limit(1).single();return o&&o.code!=="PGRST116"?(console.error("Error checking role and restaurant:",o),{role:null,restaurantId:null}):c?{role:c.role,restaurantId:c.restaurant_id}:{role:null,restaurantId:null}},ne=async t=>{let{role:c,restaurantId:o}=await D(t.id);if((c==="admin"||c==="moderator")&&o)return{role:c,restaurantId:o};console.log(`[AdminAuth] Running setup for user ${t.id}. Current role: ${c}, Restaurant ID: ${o}`);const p=t.user_metadata.full_name||"Novo Usuário",f=t.user_metadata.store_name||p,l=t.user_metadata.cpf_cnpj||null,{error:g,data:h}=await m.functions.invoke("ensure-admin-access",{body:{userId:t.id,fullName:p,storeName:f,cpfCnpj:l}});if(g){console.error("Error setting up admin access:",g);let i="Falha ao configurar acesso de administrador.";throw h&&typeof h=="object"&&"error"in h?i=h.error:g.message.includes("non-2xx status code")?i="Erro interno do servidor (500). Verifique os logs do Supabase.":i=g.message,new Error(i)}const j=await D(t.id);return c=j.role,o=j.restaurantId,{role:c,restaurantId:o}},xe=()=>{const t=$(),[c,o]=d.useState(!0),[p,f]=d.useState(!1),[l,g]=d.useState(!1),[h,j]=d.useState(!1),[i,w]=d.useState(""),[N,U]=d.useState(""),[C,R]=d.useState(""),[b,O]=d.useState(""),[S,T]=d.useState(""),[E,z]=d.useState(""),[ie,I]=d.useState(null),L=async r=>{o(!0);try{const{role:a,restaurantId:n}=await ne(r);if(a==="admin"||a==="moderator")if(n)s.success("Acesso ao painel concedido."),t("/dashboard",{replace:!0});else throw new Error("Sua conta de administrador não está vinculada a um restaurante. Tente novamente ou contate o suporte.");else s.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await m.auth.signOut(),t("/",{replace:!0})}catch(a){console.error("Error during admin setup/redirect:",a),s.error("Erro crítico de autenticação.",{description:a instanceof Error?a.message:"Ocorreu um erro desconhecido. Tente novamente.",duration:8e3}),await m.auth.signOut(),o(!1)}};d.useEffect(()=>{(async()=>{const{data:{session:n}}=await m.auth.getSession();I(n),n!=null&&n.user?L(n.user):o(!1)})();const{data:{subscription:a}}=m.auth.onAuthStateChange((n,u)=>{I(u),n==="SIGNED_IN"&&(u!=null&&u.user)?L(u.user):n==="SIGNED_OUT"&&o(!1)});return()=>a.unsubscribe()},[t]);const J=()=>{if(l){if(!C.trim())return s.error("O Nome Completo é obrigatório."),!1;if(!S.trim())return s.error("O Nome da Loja é obrigatório."),!1;if(_(b).length!==11)return s.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1;const a=q(E);if(a.length!==11&&a.length!==14)return s.error("O CPF deve ter 11 dígitos ou CNPJ 14 dígitos."),!1}return i.trim()?N.length<6?(s.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(s.error("O Email é obrigatório."),!1)},M=async r=>{if(r.preventDefault(),!!J()){f(!0);try{if(l){const a=_(b),n=q(E),{data:u,error:P}=await m.auth.signUp({email:i,password:N,options:{data:{full_name:C,phone:a,store_name:S,cpf_cnpj:n}}});if(P){if(P.message.includes("User already registered")){s.warning("Usuário já cadastrado. Tentando fazer login...");const{error:k}=await m.auth.signInWithPassword({email:i,password:N});if(k)throw k;s.success("Login realizado com sucesso!");return}throw P}u.session?s.success("Conta de administrador criada e login efetuado!"):(s.success("Conta criada! Verifique seu email para confirmar."),f(!1))}else{const{error:a}=await m.auth.signInWithPassword({email:i,password:N});if(a)throw a;s.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?s.error("Por favor, verifique seu e-mail para confirmar sua conta."):s.error(a.message||"Erro ao processar autenticação"),f(!1)}}},V=async r=>{if(r.preventDefault(),!i.trim()){s.error("O Email é obrigatório para recuperação de senha.");return}f(!0);try{const n=`${window.location.origin+window.location.pathname}#/password-recovery`,{error:u}=await m.auth.resetPasswordForEmail(i,{redirectTo:n});if(u)throw u;s.success("Email de recuperação enviado!",{description:"Verifique sua caixa de entrada (e spam) para o link de redefinição de senha.",duration:8e3}),j(!1)}catch(a){s.error(a.message||"Erro ao enviar email de recuperação.")}finally{f(!1)}};return c?e.jsx(W,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(B,{className:"justify-center mb-4"})}),e.jsxs(K,{className:"shadow-xl border-2",children:[e.jsxs(Q,{className:"space-y-1",children:[e.jsxs(X,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[h?e.jsx(F,{className:"h-6 w-6 text-primary"}):l?e.jsx(oe,{className:"h-6 w-6 text-primary"}):e.jsx(se,{className:"h-6 w-6 text-destructive"}),h?"Recuperar Senha":l?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(Y,{className:"text-center",children:h?"Digite seu email para receber o link de redefinição.":l?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs(Z,{className:"space-y-4",children:[h?e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",children:"Email *"}),e.jsx(v,{id:"email",type:"email",placeholder:"seu@email.com",value:i,onChange:r=>w(r.target.value),required:!0,className:"h-12"})]}),e.jsxs(y,{type:"submit",className:"w-full",size:"lg",disabled:p,children:[p?e.jsx(A,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(F,{className:"h-4 w-4 mr-2"}),"Enviar Link de Recuperação"]}),e.jsx("div",{className:"text-center",children:e.jsxs(y,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{j(!1),w("")},children:[e.jsx(te,{className:"h-4 w-4 mr-1"})," Voltar para o Login"]})})]}):e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[l&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(v,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:C,onChange:r=>R(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"storeName",children:"Nome da Loja *"}),e.jsx(v,{id:"storeName",type:"text",placeholder:"Nome do seu restaurante",value:S,onChange:r=>T(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"phone",children:"Telefone *"}),e.jsx(ee,{id:"phone",value:b,onChange:r=>O(r.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"cpfCnpj",children:"CPF/CNPJ *"}),e.jsx(ae,{id:"cpfCnpj",value:E,onChange:r=>z(r.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"CPF (11 dígitos) ou CNPJ (14 dígitos)."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",children:"Email *"}),e.jsx(v,{id:"email",type:"email",placeholder:"seu@email.com",value:i,onChange:r=>w(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"password",children:"Senha *"}),e.jsx(v,{id:"password",type:"password",placeholder:"••••••••",value:N,onChange:r=>U(r.target.value),required:!0,className:"h-12"})]}),!l&&e.jsx("div",{className:"text-right",children:e.jsx(y,{variant:"link",type:"button",className:"p-0 h-auto text-sm text-muted-foreground hover:text-primary",onClick:()=>j(!0),children:"Esqueci minha senha"})}),e.jsx(y,{type:"submit",className:"w-full",size:"lg",disabled:p,children:p?e.jsx(A,{className:"h-4 w-4 animate-spin mr-2"}):l?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(y,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>g(!l),children:l?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(re,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(G,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{xe as default};
