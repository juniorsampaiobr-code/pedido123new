import{b as d,u as E,a as B,c as H}from"./index-Br5M4KeF.js";import{u as R,a as U,b as O,j as e}from"./tanstack-b27kfv6r.js";import{o as Q,s as g,u as $,t as J}from"./types-Z9mbP6pS.js";import{s as c}from"./client-CNbeM-CQ.js";import{B as y}from"./button-DyiApUNa.js";import{D as K,a as V,b as X,c as G,d as W,S as Y,e as Z}from"./dialog-z-dwmrxU.js";import{F as ee,e as u,a as b,b as N,c as C,d as w}from"./form-lOr0BRe5.js";import{I as S}from"./label-DewyFIm5.js";import{M as se,P as ae}from"./PhoneInput-3ILgWYGM.js";import{C as re}from"./CpfCnpjInput-CcWKhMAx.js";import{r as M,L as te}from"./vendor-CrUvlFU9.js";import{S as oe}from"./skeleton-CwDwFmoR.js";import{U as ne}from"./user-DWqOWFhy.js";import{p as ie}from"./pt-BR-1y0Vp0kB.js";import{S as le}from"./store-zSZEKQj5.js";import{C as F,T as ce}from"./truck-CtXQ2m7y.js";import{C as de}from"./credit-card-C0OBmbbH.js";import{P as me}from"./package-BOAdSTNL.js";import{C as pe}from"./circle-check-big-CxBerd1y.js";import{C as he}from"./check-DOf5RoSF.js";import{C as xe}from"./circle-x-DPYuWQUW.js";import{f as ue}from"./format-BeKxgCCE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=d("Euro",[["path",{d:"M4 10h12",key:"1y6xl8"}],["path",{d:"M4 14h9",key:"1loblj"}],["path",{d:"M19 6a7.7 7.7 0 0 0-5.2-2A7.9 7.9 0 0 0 6 12c0 4.4 3.5 8 7.8 8 2 0 3.8-.8 5.2-2",key:"1j6lzo"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=d("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=d("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=d("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=d("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),ye={pending:{label:"Pendente",icon:F,color:"bg-yellow-500"},preparing:{label:"Em Preparação",icon:me,color:"bg-orange-500"},ready:{label:"Pronto",icon:pe,color:"bg-green-500"},delivering:{label:"Em Entrega",icon:ce,color:"bg-blue-500"},delivered:{label:"Entregue",icon:he,color:"bg-primary"},cancelled:{label:"Cancelado",icon:xe,color:"bg-destructive"},pending_payment:{label:"Aguardando Pag.",icon:fe,color:"bg-gray-500"}},be=r=>r.replace(/\D/g,""),Ne=r=>r.replace(/\D/g,""),Ce=Q({name:g().min(1,"Nome é obrigatório."),phone:g().min(1,"Telefone é obrigatório.").transform(be).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),cpf_cnpj:g().min(1,"CPF/CNPJ é obrigatório.").transform(Ne).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."})}),we=async r=>{const{data:i,error:a}=await c.from("orders").select(`
      *,
      order_items(*, products(name)),
      payment_methods(name),
      restaurants(name)
    `).eq("customer_id",r).order("created_at",{ascending:!1}).limit(5);if(a)throw console.error("Erro ao buscar pedidos do cliente:",a),new Error(`Erro ao buscar histórico de pedidos: ${a.message}`);return i},Ve=({isOpen:r,onClose:i,customer:a})=>{const v=R(),[L,_]=M.useState(null),o=$({resolver:J(Ce),defaultValues:{name:"",phone:"",cpf_cnpj:""}}),{data:f,isLoading:q}=U({queryKey:["customerOrders",a==null?void 0:a.id],queryFn:()=>we(a.id),enabled:!!(a!=null&&a.id)&&r,staleTime:0});M.useEffect(()=>{r&&(async()=>{const{data:{user:t}}=await c.auth.getUser();if(t){if(_(t.email||null),a)o.reset({name:a.name||"",phone:a.phone||"",cpf_cnpj:a.cpf_cnpj||""});else if(r){const n=t.user_metadata;o.reset({name:n.full_name||"",phone:n.phone||"",cpf_cnpj:n.cpf_cnpj||""})}}else o.reset({name:"",phone:"",cpf_cnpj:""}),_(null)})()},[a,o,r]);const j=O({mutationFn:async s=>{var p,h;const t=await c.auth.getUser(),n=(p=t.data.user)==null?void 0:p.id;if(!(a!=null&&a.id)&&!n)throw new Error("ID do cliente ou usuário não encontrado.");const m={name:s.name,phone:s.phone,cpf_cnpj:s.cpf_cnpj||null};if(a!=null&&a.id){const{error:l}=await c.from("customers").update(m).eq("id",a.id);if(l)throw new Error(l.message)}else if(n){const l={...m,user_id:n,name:s.name,phone:s.phone,email:((h=t.data.user)==null?void 0:h.email)||null},{error:x}=await c.from("customers").insert(l);if(x)throw new Error(x.message)}else throw new Error("Não foi possível identificar o cliente para salvar.")},onSuccess:()=>{E.success("Perfil atualizado com sucesso!"),v.invalidateQueries({queryKey:["menuCustomerData"]}),v.invalidateQueries({queryKey:["checkoutCustomerData"]}),i()},onError:s=>{E.error(`Erro ao atualizar perfil: ${s.message}`)}}),I=s=>{j.mutate(s)},A=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s);return e.jsx(K,{open:r,onOpenChange:i,children:e.jsxs(V,{className:"sm:max-w-xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(X,{children:[e.jsxs(G,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-primary"}),"Seu Perfil de Cliente"]}),e.jsx(W,{children:"Atualize seus dados de contato e identificação."})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 pt-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold border-b pb-2",children:"Dados Pessoais"}),e.jsx(ee,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(I),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"})," Email"]}),e.jsx(S,{value:L||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email é usado para login e não pode ser alterado aqui."})]}),e.jsx(b,{control:o.control,name:"name",render:({field:s})=>e.jsxs(N,{children:[e.jsx(u,{children:"Nome Completo *"}),e.jsx(C,{children:e.jsx(S,{placeholder:"Seu nome",...s})}),e.jsx(w,{})]})}),e.jsx(b,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(N,{children:[e.jsx(u,{children:"Telefone *"}),e.jsx(C,{children:e.jsx(ae,{...s})}),e.jsx(w,{})]})}),e.jsx(b,{control:o.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(N,{children:[e.jsx(u,{children:"CPF/CNPJ *"}),e.jsx(C,{children:e.jsx(re,{...s})}),e.jsx(w,{})]})}),e.jsx("div",{className:"pt-4",children:e.jsxs(y,{type:"submit",disabled:j.isPending,className:"w-full",children:[j.isPending?e.jsx(B,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Salvar Alterações"]})})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold border-b pb-2 flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),"Últimos Pedidos"]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Apenas os 5 pedidos mais recentes são exibidos aqui."}),q?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((s,t)=>e.jsx(oe,{className:"h-20 w-full"},t))}):e.jsx("div",{className:"space-y-3",children:f&&f.length>0?f.map(s=>{var D,P;const t=ye[s.status||"pending"],n=s.id?s.id.slice(-4):"N/A",m=new Date(s.created_at),p=ue(m,"dd/MM/yy 'às' HH:mm",{locale:ie}),h=((D=s.payment_methods)==null?void 0:D.name)||"Não especificado",l=((P=s.restaurants)==null?void 0:P.name)||"Loja Desconhecida",x=s.order_items.slice(0,2).map(z=>{var k;return((k=z.products)==null?void 0:k.name)||"Item"}).join(", "),T=s.order_items.length>2?` +${s.order_items.length-2} itens`:"";return e.jsxs("div",{className:"border p-3 rounded-lg hover:bg-muted/50 transition-colors space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-bold text-sm",children:["Pedido #",n]}),e.jsxs("span",{className:"text-xs font-semibold text-primary flex items-center gap-1 mt-0.5",children:[e.jsx(le,{className:"h-3 w-3"})," ",l]})]}),e.jsx("span",{className:H("text-xs font-semibold px-2 py-0.5 rounded-full text-white flex-shrink-0",t.color),children:t.label})]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[x,T]}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-muted-foreground pt-1 border-t border-dashed border-muted-foreground/30",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{className:"h-3 w-3"}),e.jsx("span",{children:p})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),e.jsx("span",{children:h})]}),e.jsx("span",{className:"font-bold text-foreground",children:A(s.total_amount)})]}),e.jsx(te,{to:`/order-success/${s.id}`,onClick:i,children:e.jsxs(y,{variant:"secondary",size:"sm",className:"w-full mt-2 h-7 text-xs",children:[e.jsx(je,{className:"h-3 w-3 mr-2"})," Ver Detalhes"]})})]},s.id)}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Nenhum pedido encontrado."})})]})]}),e.jsx(Z,{className:"pt-4",children:e.jsx(y,{type:"button",variant:"outline",onClick:i,children:"Fechar"})})]})})};export{Ve as C,Je as L,Ke as S};
