import{j as e,b as Zs,u as xe,c as Hs}from"./tanstack-D8i8yNxB.js";import{r as i,R as ye,u as Js,h as Qs,L as Qe}from"./vendor-Dl0Wzy4_.js";import{o as Ws,s as F,l as Xs,e as Ys,p as Ie,c as We,n as et,Z as z,u as st,t as tt}from"./types-BCrSgEF3.js";import{s as T}from"./client-BmrnLCXS.js";import{c as Fe,f as Oe,g as ve,P as Z,i as je,h as ss,l as rt,m as ts,b as ue,n as ot,k as at,a as rs,v as nt,L as Xe}from"./index-CPtlsehN.js";import{B as oe}from"./button-BoSFPc6a.js";import{C as ne,b as ie,c as le,a as ce}from"./card-_fhdoebP.js";import{I as $}from"./label-vmEOzfpA.js";import{c as os,R as it,I as lt,a as ct,C as dt}from"./index-B0AyUKCu.js";import{u as ut}from"./index-BB_oiUC3.js";import{u as mt}from"./index-PuW-_iwo.js";import{S as de}from"./separator-dxgrrk2t.js";import{T as pt}from"./textarea-BYrFatpI.js";import{A as X,a as Y,b as ee}from"./alert-BsLYNu-F.js";import{F as ht,b as I,c as C,a as R,e as V,d as ae}from"./form-BcdwuO6T.js";import{Z as ft,M as xt}from"./MapLocationSection-DQXM94q-.js";import{S as gt}from"./shopping-cart-CJlfRD-b.js";import{T as Ve}from"./terminal-A4LgBqaN.js";import{A as yt}from"./arrow-left-9Zzuq-hS.js";import{T as Ye}from"./truck-CnOej46D.js";import{S as as,a as jt}from"./store-DfiTjKEU.js";import{M as es}from"./map-pin-EDAfFmCE.js";import{P as vt}from"./package-CO2bzgcV.js";import{C as bt}from"./credit-card-DCpskVGN.js";import{D as Nt}from"./dollar-sign-BTXfdMC0.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=Fe("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=Fe("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=Fe("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var $e="Radio",[Rt,ns]=Oe($e),[Et,Pt]=Rt($e),is=i.forwardRef((r,s)=>{const{__scopeRadio:a,name:c,checked:n=!1,required:l,disabled:d,value:u="on",onCheck:x,form:f,...j}=r,[w,b]=i.useState(null),g=ve(s,O=>b(O)),y=i.useRef(!1),v=w?f||!!w.closest("form"):!0;return e.jsxs(Et,{scope:a,checked:n,disabled:d,children:[e.jsx(Z.button,{type:"button",role:"radio","aria-checked":n,"data-state":us(n),"data-disabled":d?"":void 0,disabled:d,value:u,...j,ref:g,onClick:je(r.onClick,O=>{n||x==null||x(),v&&(y.current=O.isPropagationStopped(),y.current||O.stopPropagation())})}),v&&e.jsx(ds,{control:w,bubbles:!y.current,name:c,value:u,checked:n,required:l,disabled:d,form:f,style:{transform:"translateX(-100%)"}})]})});is.displayName=$e;var ls="RadioIndicator",cs=i.forwardRef((r,s)=>{const{__scopeRadio:a,forceMount:c,...n}=r,l=Pt(ls,a);return e.jsx(ss,{present:c||l.checked,children:e.jsx(Z.span,{"data-state":us(l.checked),"data-disabled":l.disabled?"":void 0,...n,ref:s})})});cs.displayName=ls;var St="RadioBubbleInput",ds=i.forwardRef(({__scopeRadio:r,control:s,checked:a,bubbles:c=!0,...n},l)=>{const d=i.useRef(null),u=ve(d,l),x=mt(a),f=rt(s);return i.useEffect(()=>{const j=d.current;if(!j)return;const w=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(w,"checked").set;if(x!==a&&g){const y=new Event("click",{bubbles:c});g.call(j,a),j.dispatchEvent(y)}},[x,a,c]),e.jsx(Z.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...n,tabIndex:-1,ref:u,style:{...n.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ds.displayName=St;function us(r){return r?"checked":"unchecked"}var It=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],be="RadioGroup",[Vt,Sr]=Oe(be,[os,ns]),ms=os(),ps=ns(),[Lt,kt]=Vt(be),hs=i.forwardRef((r,s)=>{const{__scopeRadioGroup:a,name:c,defaultValue:n,value:l,required:d=!1,disabled:u=!1,orientation:x,dir:f,loop:j=!0,onValueChange:w,...b}=r,g=ms(a),y=ut(f),[v,O]=ts({prop:l,defaultProp:n??null,onChange:w,caller:be});return e.jsx(Lt,{scope:a,name:c,required:d,disabled:u,value:v,onValueChange:O,children:e.jsx(it,{asChild:!0,...g,orientation:x,dir:y,loop:j,children:e.jsx(Z.div,{role:"radiogroup","aria-required":d,"aria-orientation":x,"data-disabled":u?"":void 0,dir:y,...b,ref:s})})})});hs.displayName=be;var fs="RadioGroupItem",xs=i.forwardRef((r,s)=>{const{__scopeRadioGroup:a,disabled:c,...n}=r,l=kt(fs,a),d=l.disabled||c,u=ms(a),x=ps(a),f=i.useRef(null),j=ve(s,f),w=l.value===n.value,b=i.useRef(!1);return i.useEffect(()=>{const g=v=>{It.includes(v.key)&&(b.current=!0)},y=()=>b.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",y)}},[]),e.jsx(lt,{asChild:!0,...u,focusable:!d,active:w,children:e.jsx(is,{disabled:d,required:l.required,checked:w,...x,...n,name:l.name,ref:j,onCheck:()=>l.onValueChange(n.value),onKeyDown:je(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:je(n.onFocus,()=>{var g;b.current&&((g=f.current)==null||g.click())})})})});xs.displayName=fs;var Ft="RadioGroupIndicator",gs=i.forwardRef((r,s)=>{const{__scopeRadioGroup:a,...c}=r,n=ps(a);return e.jsx(cs,{...n,...c,ref:s})});gs.displayName=Ft;var ys=hs,js=xs,Ot=gs;const Le=i.forwardRef(({className:r,...s},a)=>e.jsx(ys,{className:ue("grid gap-2",r),...s,ref:a}));Le.displayName=ys.displayName;const ge=i.forwardRef(({className:r,...s},a)=>e.jsx(js,{ref:a,className:ue("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...s,children:e.jsx(Ot,{className:"flex items-center justify-center",children:e.jsx(Ct,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ge.displayName=js.displayName;const $t=r=>{let s=r.replace(/\D/g,"");return s.length>11&&(s=s.slice(0,11)),s.length>0&&(s=`(${s}`),s.length>3&&(s=`${s.slice(0,3)}) ${s.slice(3)}`),s.length>10&&(s=`${s.slice(0,10)}-${s.slice(10)}`),s},vs=ye.forwardRef(({className:r,value:s,onChange:a,...c},n)=>{const l=d=>{const u=d.target.value,x=$t(u),f={...d,target:{...d.target,value:x}};a(f)};return e.jsx($,{ref:n,type:"tel",className:ue("w-full",r),placeholder:"(99) 99999-9999",value:s,onChange:l,...c})});vs.displayName="PhoneInput";const Tt=r=>{let s=r.replace(/\D/g,"");return s.length>14&&(s=s.slice(0,14)),s.length<=11?(s.length>9&&(s=`${s.slice(0,9)}-${s.slice(9)}`),s.length>6&&(s=`${s.slice(0,6)}.${s.slice(6)}`),s.length>3&&(s=`${s.slice(0,3)}.${s.slice(3)}`),s):(s.length>12&&(s=`${s.slice(0,12)}-${s.slice(12)}`),s.length>8&&(s=`${s.slice(0,8)}/${s.slice(8)}`),s.length>5&&(s=`${s.slice(0,5)}.${s.slice(5)}`),s.length>2&&(s=`${s.slice(0,2)}.${s.slice(2)}`),s)},bs=ye.forwardRef(({className:r,value:s,onChange:a,...c},n)=>{const l=d=>{const u=d.target.value,x=Tt(u),f={...d,target:{...d.target,value:x}};a(f)};return e.jsx($,{ref:n,type:"tel",className:ue("w-full",r),placeholder:"CPF ou CNPJ",value:s,onChange:l,maxLength:18,...c})});bs.displayName="CpfCnpjInput";const At=(r,s,a,c)=>{const l=(a-r)*(Math.PI/180),d=(c-s)*(Math.PI/180),u=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r*(Math.PI/180))*Math.cos(a*(Math.PI/180))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},Mt=async r=>{const s=r.replace(/\s+/g," ").trim(),a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(s)}&limit=1`,c=new AbortController,n=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",a);const l=await fetch(a,{signal:c.signal});if(!l.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",l.status),null;const d=await l.json();if(d&&Array.isArray(d)&&d.length>0){const u=d[0],x=parseFloat(u.lat),f=parseFloat(u.lon);if(Number.isFinite(x)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[x,f]),{lat:x,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",s),null}catch(l){return l instanceof Error&&l.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",s):console.error("LOG: geocodeAddress - Erro durante a requisição:",l),null}finally{clearTimeout(n)}},Gt=(r,s,a)=>{const c=At(s[0],s[1],r[0],r[1]),n=a.find(l=>c<=l.max_distance_km);if(n){const l=n.delivery_fee||0,d=n.min_delivery_time_minutes||0,u=d+15;return{fee:parseFloat(l.toFixed(2)),minTime:d,maxTime:u}}return null};var Ne="Collapsible",[qt,Ir]=Oe(Ne),[Dt,Te]=qt(Ne),Ns=i.forwardRef((r,s)=>{const{__scopeCollapsible:a,open:c,defaultOpen:n,disabled:l,onOpenChange:d,...u}=r,[x,f]=ts({prop:c,defaultProp:n??!1,onChange:d,caller:Ne});return e.jsx(Dt,{scope:a,disabled:l,contentId:ot(),open:x,onOpenToggle:i.useCallback(()=>f(j=>!j),[f]),children:e.jsx(Z.div,{"data-state":Me(x),"data-disabled":l?"":void 0,...u,ref:s})})});Ns.displayName=Ne;var Cs="CollapsibleTrigger",_s=i.forwardRef((r,s)=>{const{__scopeCollapsible:a,...c}=r,n=Te(Cs,a);return e.jsx(Z.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":Me(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...c,ref:s,onClick:je(r.onClick,n.onOpenToggle)})});_s.displayName=Cs;var Ae="CollapsibleContent",ws=i.forwardRef((r,s)=>{const{forceMount:a,...c}=r,n=Te(Ae,r.__scopeCollapsible);return e.jsx(ss,{present:a||n.open,children:({present:l})=>e.jsx(Bt,{...c,ref:s,present:l})})});ws.displayName=Ae;var Bt=i.forwardRef((r,s)=>{const{__scopeCollapsible:a,present:c,children:n,...l}=r,d=Te(Ae,a),[u,x]=i.useState(c),f=i.useRef(null),j=ve(s,f),w=i.useRef(0),b=w.current,g=i.useRef(0),y=g.current,v=d.open||u,O=i.useRef(v),k=i.useRef(void 0);return i.useEffect(()=>{const E=requestAnimationFrame(()=>O.current=!1);return()=>cancelAnimationFrame(E)},[]),at(()=>{const E=f.current;if(E){k.current=k.current||{transitionDuration:E.style.transitionDuration,animationName:E.style.animationName},E.style.transitionDuration="0s",E.style.animationName="none";const H=E.getBoundingClientRect();w.current=H.height,g.current=H.width,O.current||(E.style.transitionDuration=k.current.transitionDuration,E.style.animationName=k.current.animationName),x(c)}},[d.open,c]),e.jsx(Z.div,{"data-state":Me(d.open),"data-disabled":d.disabled?"":void 0,id:d.contentId,hidden:!v,...l,ref:j,style:{"--radix-collapsible-content-height":b?`${b}px`:void 0,"--radix-collapsible-content-width":y?`${y}px`:void 0,...r.style},children:v&&n})});function Me(r){return r?"open":"closed"}var zt=Ns;const Ut=zt,Kt=_s,Zt=ws,Ht=()=>{const{items:r,subtotal:s,deliveryFee:a,total:c,totalItems:n}=rs(),[l,d]=i.useState(!1);return n===0?null:e.jsxs(Ut,{open:l,onOpenChange:d,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Kt,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(gt,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)}),l?e.jsx(ct,{className:"h-5 w-5"}):e.jsx(dt,{className:"h-5 w-5"})]})]})}),e.jsxs(Zt,{className:"p-4 pt-0",children:[e.jsx(de,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:r.map(u=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[u.quantity,"x ",u.name,u.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",u.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u.price*u.quantity)})]},u.id))}),e.jsx(de,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(de,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)})]})]})]})]})},Rs=r=>r.replace(/\D/g,""),Es=r=>r.replace(/\D/g,""),ke=r=>r.replace(/\D/g,""),Jt=Ws({name:F().min(1,"Nome é obrigatório."),phone:F().min(1,"Telefone é obrigatório.").transform(Rs).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:F().email("Email inválido.").optional().or(Xs("")),delivery_option:Ys(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:F().optional().default(""),number:F().optional().default(""),complement:F().optional().default(""),neighborhood:F().optional().default(""),city:F().optional().default(""),zip_code:F().optional().default("").transform(Es).refine(r=>r.length===8||r.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ie(r=>typeof r=="string"?parseFloat(r):r,We.number().optional().nullable()),longitude:Ie(r=>typeof r=="string"?parseFloat(r):r,We.number().optional().nullable()),payment_method_id:F().min(1,"Selecione uma forma de pagamento."),notes:F().optional(),cpf_cnpj:F().optional().default("").transform(ke).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ie(r=>{if(r==null||r==="")return null;const s=String(r).replace(",","."),a=parseFloat(s);return isNaN(a)?s:a},et({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((r,s)=>{if(r.delivery_option==="delivery"&&(r.street.trim()===""&&s.addIssue({code:z.custom,message:"Rua é obrigatória.",path:["street"]}),r.number.trim()===""&&s.addIssue({code:z.custom,message:"Número é obrigatório.",path:["number"]}),r.neighborhood.trim()===""&&s.addIssue({code:z.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),r.city.trim()===""&&s.addIssue({code:z.custom,message:"Cidade é obrigatória.",path:["city"]}),r.zip_code.length!==8&&s.addIssue({code:z.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(r.latitude===null||r.longitude===null)&&s.addIssue({code:z.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),r.payment_method_id==="Dinheiro"&&r.change_for!==null&&r.change_for!==void 0&&r.change_for<=0&&s.addIssue({code:z.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),r.payment_method_id==="Pagamento online: Pix/Cartão"){const n=ke(r.cpf_cnpj||"");n.length!==11&&n.length!==14&&s.addIssue({code:z.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Qt=()=>{const r=window.location.origin,a=window.location.pathname.split("/")[1];return a?`${r}/${a}`:r},Wt=async()=>{const{data:r,error:s}=await T.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(s)throw new Error(`Erro ao buscar restaurante: ${s.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},Xt=async r=>{const{data:s,error:a}=await T.from("restaurants").select("delivery_enabled").eq("id",r).single();if(a)throw new Error(`Erro ao buscar status de entrega: ${a.message}`);return s.delivery_enabled??!0},Yt=async r=>{const{data:s,error:a}=await T.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(a)throw new Error(`Erro ao buscar métodos de pagamento: ${a.message}`);return s},er=async r=>{const{data:s,error:a}=await T.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return s},sr=r=>{switch(r){case"DollarSign":return Nt;case"Smartphone":return jt;case"CreditCard":return bt;case"Package":return vt;default:return as}},tr=({subtotal:r,deliveryFee:s,total:a,items:c})=>e.jsxs(ne,{className:"sticky top-4",children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(ce,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(de,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:s>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s):"Grátis"})]})]}),e.jsx(de,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]})]})]}),Vr=()=>{const r=Qt(),s=Js();Zs();const a=rs(),{items:c,subtotal:n,deliveryFee:l,total:d,setDeliveryFee:u,clearCart:x}=a,[f]=Qs(),[j,w]=i.useState(!1),[b,g]=i.useState(!1),[y,v]=i.useState(null),[O,k]=i.useState(null),[E,H]=i.useState(null),[Ge,Ps]=i.useState(!1),U=ye.useRef(!1),J=ye.useRef(!1),se=f.get("status"),Ce=f.get("external_reference"),qe=f.has("collection_id")||f.has("external_reference"),[me,De]=i.useState(!1);i.useEffect(()=>{if(Ce)if(se==="approved"||se==="failure"||se==="pending"){s(`/order-success/${Ce}?status=${se}`,{replace:!0});return}else qe&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),De(!1));else De(!1)},[Ce,se,qe,s]);const{data:m,isLoading:Ss,isError:Is,error:Vs}=xe({queryKey:["checkoutRestaurantData"],queryFn:Wt}),{data:G,isLoading:_e}=xe({queryKey:["deliveryStatus",m==null?void 0:m.id],queryFn:()=>Xt(m.id),enabled:!!(m!=null&&m.id)}),{data:Q=[],isLoading:Ls}=xe({queryKey:["checkoutPaymentMethods",m==null?void 0:m.id],queryFn:()=>Yt(m.id),enabled:!!(m!=null&&m.id)}),{data:Be=[],isLoading:ks}=xe({queryKey:["checkoutDeliveryZones",m==null?void 0:m.id],queryFn:()=>er(m.id),enabled:!!(m!=null&&m.id)}),Fs=Ss||_e||Ls||ks,Os=Is,ze=Vs,o=st({resolver:tt(Jt),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),A=o.watch("delivery_option"),we=o.watch("payment_method_id"),W=Q.find(t=>t.id===we),pe=(W==null?void 0:W.name)==="Pagamento online: Pix/Cartão",he=(W==null?void 0:W.name)==="Dinheiro",P=o.watch("latitude"),S=o.watch("longitude");o.watch(["street","number","neighborhood","city","zip_code"]);const q=A==="delivery",$s=i.useMemo(()=>JSON.stringify({deliveryOption:A,deliveryEnabled:G,lat:P,lng:S}),[A,G,P,S]),Ts=i.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:m!=null&&m.latitude&&(m!=null&&m.longitude)?[m.latitude,m.longitude]:[-23.55052,-46.633308],[P,S,m]),As=i.useMemo(()=>P===null||S===null?`map-${A}-null`:`map-${A}-${P.toFixed(6)}-${S.toFixed(6)}`,[q,A,P,S]),Re=i.useCallback(t=>{const p=t.road||t.logradouro||"",h=t.house_number||"",N=t.suburb||t.bairro||"",_=t.city||t.localidade||"",M=t.postcode||t.cep||"";o.setValue("street",p,{shouldValidate:!0}),o.setValue("number",h||"",{shouldValidate:!0}),o.setValue("complement",t.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",N,{shouldValidate:!0}),o.setValue("city",_,{shouldValidate:!0}),o.setValue("zip_code",M,{shouldValidate:!0})},[o]),Ms=i.useCallback(async(t,p)=>{o.setValue("latitude",t,{shouldValidate:!0}),o.setValue("longitude",p,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${p}&addressdetails=1`,N=await fetch(h);if(N.ok){const _=await N.json();_.address&&Re(_.address)}},[o,Re]),Gs=i.useCallback(()=>{o.setValue("street","",{shouldValidate:!0}),o.setValue("number","",{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood","",{shouldValidate:!0}),o.setValue("city","",{shouldValidate:!0}),o.setValue("zip_code","",{shouldValidate:!0}),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),u(0),v(null),k(null),localStorage.removeItem("checkoutFormData")},[o,u]),Ee=i.useCallback(t=>{try{const p={name:t.name,phone:t.phone,email:t.email,delivery_option:t.delivery_option,street:t.street,number:t.number,complement:t.complement,neighborhood:t.neighborhood,city:t.city,zip_code:t.zip_code,latitude:t.latitude,longitude:t.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(p))}catch(p){console.error("Failed to save form data to local storage",p)}},[]),Ue=i.useCallback(()=>{try{const t=localStorage.getItem("checkoutFormData");if(t){const p=JSON.parse(t);o.reset({...o.getValues(),...p,delivery_option:p.delivery_option||"delivery"})}}catch(t){console.error("Failed to load form data from local storage",t)}},[o]);i.useEffect(()=>{Ue()},[Ue]),i.useEffect(()=>{const t=o.watch(p=>{Ee(p)});return()=>t.unsubscribe()},[o,Ee]);const qs=()=>{U.current||(H(null),U.current=!0,Promise.resolve().then(async()=>{try{const t=o.getValues(),[p,h,N,_,M]=[t.street,t.number,t.neighborhood,t.city,t.zip_code],fe=Es(M);if(!(p&&h&&N&&_&&fe.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),o.trigger(["street","number","neighborhood","city","zip_code"]),U.current=!1;return}console.log("LOG: Iniciando geocodificação para:",`${p}, ${h}, ${N}, ${_}, ${M}`);const te=`${p}, ${h}, ${N}, ${_}, ${M}`,K=await Mt(te);K?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",K),o.setValue("latitude",K.lat,{shouldValidate:!0}),o.setValue("longitude",K.lng,{shouldValidate:!0}),Ee(o.getValues())):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),setTimeout(()=>{H("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0})},100))}catch(t){console.error("LOG: Erro capturado durante a geocodificação:",t),setTimeout(()=>{H("Erro ao buscar coordenadas. Verifique sua conexão ou tente novamente."),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0})},100)}finally{U.current=!1}}).catch(t=>{console.error("LOG: Erro nao capturado:",t),U.current=!1}))};i.useEffect(()=>{he||o.setValue("change_for",null,{shouldValidate:!0})},[he,o]),i.useEffect(()=>{A==="pickup"&&(u(0),v(null),k(null),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}))},[A,q,o,u,P,S]),i.useEffect(()=>{Q.length>0&&!we&&o.setValue("payment_method_id",Q[0].id)},[Q,we,o]),i.useEffect(()=>{pe?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},[pe,o]),i.useEffect(()=>{const t=async()=>{if(A==="pickup"||!(m!=null&&m.latitude)||!(m!=null&&m.longitude)){u(0),v(null),k(null);return}if(_e)return;if(G===!1){u(0),v(null),k(null),g(!1);return}g(!0),v(null);let h=null;if(P&&S)h=[P,S];else{u(0),k(null),g(!1);return}if(h){const N=[m.latitude,m.longitude],_=Gt(h,N,Be);_?(u(_.fee),v(null),k({minTime:_.minTime,maxTime:_.maxTime})):(u(0),v("Seu endereço está fora da nossa área de entrega."),k(null))}g(!1)},p=setTimeout(()=>{t()},500);return()=>clearTimeout(p)},[$s,m,Be,o,u,q,P,S,G,_e]),i.useEffect(()=>{if(c.length===0&&!j&&!me&&!Ge){const t=setTimeout(()=>{console.log("LOG: Carrinho vazio. Redirecionando para o menu."),s("/menu")},0);return()=>clearTimeout(t)}},[c.length,s,j,me,Ge]);const Ke=Hs({mutationFn:async t=>{if(!m)throw new Error("Dados do restaurante indisponíveis.");if(t.delivery_option==="delivery"&&y)throw new Error(y);const p=[t.street,t.number,t.complement?`(${t.complement})`:null,t.neighborhood,t.city,t.zip_code].filter(Boolean).join(", "),h=t.delivery_option==="delivery"?p:"Retirada no Local";let N;const _=Rs(t.phone),M=ke(t.cpf_cnpj||""),{data:fe}=await T.from("customers").select("id").eq("phone",_).limit(1).single();if(fe){N=fe.id;const L={name:t.name};M&&(L.cpf_cnpj=M),await T.from("customers").update(L).eq("id",N)}else{const{data:L,error:D}=await T.from("customers").insert({name:t.name,phone:_,email:t.email||null,address:h,latitude:t.latitude,longitude:t.longitude,cpf_cnpj:M||null}).select("id").single();if(D)throw new Error(`Erro ao criar cliente: ${D.message}`);N=L.id}const Se=pe?"pending_payment":"pending",{data:te,error:K}=await T.from("orders").insert({restaurant_id:m.id,customer_id:N,status:Se,total_amount:d,delivery_fee:l,notes:t.notes,delivery_address:h,payment_method_id:t.payment_method_id,change_for:he?t.change_for:null}).select("id").single();if(K)throw new Error(`Erro ao criar pedido: ${K.message}`);const Ks=c.map(L=>{const D=Number(L.quantity),B=Number(L.price),re={order_id:te.id,product_id:L.product_id,quantity:D,unit_price:B,subtotal:D*B};return L.notes&&L.notes.trim()&&(re.notes=L.notes.trim()),re}),{error:He}=await T.from("order_items").insert(Ks);if(He){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",He);const L=c.map(B=>{const re=Number(B.quantity),Je=Number(B.price);return{order_id:te.id,quantity:re,unit_price:Je,subtotal:re*Je,notes:B.notes&&B.notes.trim()?B.notes.trim():null}}),{error:D}=await T.from("order_items").insert(L);if(D)throw new Error(`Erro ao adicionar itens do pedido: ${D.message}`)}return{orderId:te.id,orderStatus:Se}},onSuccess:t=>{J.current=!1,Ps(!0);const p=t.orderStatus==="pending_payment"?`/payment/${t.orderId}`:`/order-success/${t.orderId}`;console.log("LOG: Redirecionando para:",p),t.orderStatus==="pending_payment"&&w(!0),J.current=!1;const h=`${r}/#${p}`;console.log("LOG: Redirecionando com URL absoluta:",h),window.location.href=h,x()},onError:t=>{J.current=!1,console.error("LOG: Erro ao processar pedido:",t)}}),Ds=async t=>{if(J.current){console.log("LOG: Pagamento ja em processamento, ignorando nova chamada.");return}J.current=!0,Ke.mutate(t)},Bs=t=>{var h;console.error("Validation errors:",t);const p=Object.keys(t)[0];p&&console.error("LOG: Erro de validação:",((h=t[p])==null?void 0:h.message)||"Preencha todos os campos obrigatórios."),J.current=!1},Ze=Ke.isPending||j||b,zs=!q||!y&&l>=0,Pe=!q||P!==null&&S!==null,Us=!Ze&&zs&&Pe;return c.length===0&&!j&&!me?e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."}):Fs||me?e.jsx(nt,{}):Os?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(X,{variant:"destructive",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Conexão"}),e.jsx(ee,{children:ze instanceof Error?ze.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Qe,{to:"/menu",children:e.jsx(oe,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(yt,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("div",{children:e.jsx(Ht,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ht,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(Ds,Bs),className:"space-y-6",children:[e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx(I,{control:o.control,name:"name",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Nome Completo *"}),e.jsx($,{placeholder:"Seu nome",...t}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:o.control,name:"phone",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Telefone *"}),e.jsx(vs,{...t}),e.jsx(V,{})]})}),e.jsx(I,{control:o.control,name:"email",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Email (Opcional)"}),e.jsx($,{placeholder:"seu@email.com",...t}),e.jsx(V,{})]})})]})]})]}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx(I,{control:o.control,name:"delivery_option",render:({field:t})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(ae,{children:e.jsxs(Le,{onValueChange:t.onChange,defaultValue:t.value,className:"flex flex-col space-y-1",children:[e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(ge,{value:"delivery"})}),e.jsx(Ye,{className:"h-5 w-5 text-primary"}),e.jsxs(R,{className:ue("font-normal flex-1 cursor-pointer"),children:["Delivery",G===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(ge,{value:"pickup"})}),e.jsx(as,{className:"h-5 w-5 text-primary"}),e.jsx(R,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(V,{})]})}),q&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(oe,{type:"button",variant:"outline",size:"sm",onClick:t=>{t.preventDefault(),qs()},disabled:b||U.current,children:[e.jsx(wt,{className:"h-4 w-4 mr-2"})," ",b||U.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(oe,{type:"button",variant:"outline",size:"sm",onClick:Gs,children:[e.jsx(_t,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:o.control,name:"street",render:({field:t})=>e.jsxs(C,{className:"col-span-2",children:[e.jsx(R,{children:"Rua *"}),e.jsx($,{...t}),e.jsx(V,{})]})}),e.jsx(I,{control:o.control,name:"number",render:({field:t})=>e.jsxs(C,{className:"col-span-1",children:[e.jsx(R,{children:"Número *"}),e.jsx($,{...t}),e.jsx(V,{})]})})]}),e.jsx(I,{control:o.control,name:"complement",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Complemento (Opcional)"}),e.jsx($,{placeholder:"Apto, Bloco, Casa, etc.",...t,disabled:!1}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:o.control,name:"neighborhood",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Bairro *"}),e.jsx($,{...t}),e.jsx(V,{})]})}),e.jsx(I,{control:o.control,name:"city",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Cidade *"}),e.jsx($,{...t}),e.jsx(V,{})]})})]}),e.jsx(I,{control:o.control,name:"zip_code",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"CEP *"}),e.jsx(ft,{...t}),e.jsx(V,{})]})}),q&&Pe&&e.jsx("div",{children:e.jsx(xt,{mapKey:As,markerPosition:Ts,onLocationChange:Ms,updateAddressFields:Re,restaurant:m})}),b&&G!==!1&&e.jsxs(X,{children:[e.jsx(Xe,{className:"h-4 w-4 animate-spin"}),e.jsx(Y,{children:"Calculando Taxa..."}),e.jsx(ee,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),y&&G!==!1&&e.jsxs(X,{variant:"destructive",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Entrega"}),e.jsx(ee,{children:y})]}),l>0&&!b&&G!==!1&&e.jsxs(X,{className:"mt-4",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx(Y,{children:"Taxa de Entrega Aplicada"}),e.jsxs(ee,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)]})]}),E&&e.jsxs(X,{variant:"destructive",className:"mt-4",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro ao Buscar Endereço"}),e.jsx(ee,{children:E})]}),q&&!Pe&&!E&&e.jsxs(X,{variant:"destructive",children:[e.jsx(es,{className:"h-4 w-4"}),e.jsx(Y,{children:"Localização Obrigatória"}),e.jsx(ee,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx(I,{control:o.control,name:"payment_method_id",render:({field:t})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(ae,{children:e.jsx(Le,{onValueChange:p=>{t.onChange(p);const h=Q.find(N=>N.id===p);(h==null?void 0:h.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},defaultValue:t.value,className:"flex flex-col space-y-2",children:Q.map(p=>{const h=sr(p.icon||"Store");return e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(ge,{value:p.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(R,{className:"font-normal cursor-pointer",children:p.name}),p.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:p.description})]})]},p.id)})})}),e.jsx(V,{})]})}),he&&e.jsx(I,{control:o.control,name:"change_for",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Troco para (Opcional)"}),e.jsx($,{type:"number",placeholder:"Ex: 50.00",...t,value:t.value||"",onChange:p=>t.onChange(p.target.value?parseFloat(p.target.value):null)}),e.jsx(V,{})]})}),pe&&e.jsx(I,{control:o.control,name:"cpf_cnpj",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"CPF/CNPJ *"}),e.jsx(bs,{...t}),e.jsx(V,{})]})})]})]}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsx(le,{className:"text-xl",children:"4. Observações"})}),e.jsx(ce,{children:e.jsx(I,{control:o.control,name:"notes",render:({field:t})=>e.jsxs(C,{children:[e.jsx(R,{children:"Observações do Pedido (Opcional)"}),e.jsx(pt,{placeholder:"Ex: Sem cebola, sem alface...",...t}),e.jsx(V,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Qe,{to:"/menu",className:"flex-1",children:e.jsx(oe,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(oe,{type:"submit",className:"flex-1",disabled:!Us,size:"lg",children:Ze?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(tr,{subtotal:n,deliveryFee:l,total:d,items:c})})]})]})]})};export{Vr as default};
