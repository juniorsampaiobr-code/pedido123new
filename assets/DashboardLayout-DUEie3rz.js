import{j as e,a as H,u as V,b as ae}from"./tanstack-C7aOFagJ.js";import{i as W,L as re,r as n,h as se,O as oe}from"./vendor-DjsPZZVP.js";import{c as O,a as te,l as ne,S as B,a1 as ie,a0 as le,a3 as ce,aU as de,aV as ue,B as C,aW as me,o as he,n as D,s as m,r as fe,t as xe,j as N,D as pe,v as ge,w as je,x as be,U as $,y as ye,m as w,F as we,h as Ne,M as ve,I as T,z as R,A as L,E as A,G as q,H as M,P as Se,J as Ee,L as _e,V as Pe,d as I,W as z,Y as G,Z as K,aX as Ce,aY as ke,aZ as De}from"./index-DtrMpWDr.js";import{L as Te}from"./Logo--nnIxUiN.js";import{S as Re}from"./settings-CghnwJPF.js";import{S as Le}from"./store-BbZ2HBUC.js";import{P as Ae}from"./phone-BYfWuu8J.js";import{C as Q}from"./circle-alert-OqUZbZCt.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=O("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=O("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=O("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),Oe=[{href:"/dashboard",label:"Dashboard",icon:qe},{href:"/products",label:"Produtos",icon:ne},{href:"/orders",label:"Pedidos",icon:B},{href:"/cashier",label:"Caixa",icon:Ie},{href:"/hours",label:"Hor√°rios",icon:ie},{href:"/payments",label:"Pagamentos",icon:le},{href:"/delivery",label:"Taxa de Entrega",icon:ce},{href:"/settings",label:"Configura√ß√µes",icon:Re}],Y=()=>{const s=W();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(Te,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:Oe.map(o=>e.jsx("li",{children:e.jsxs(re,{to:o.href,className:te("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",s.pathname===o.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(o.icon,{className:"h-4 w-4"}),o.label]})},o.href))})})]})},$e=()=>e.jsxs(de,{children:[e.jsx(ue,{asChild:!0,children:e.jsx(C,{variant:"outline",size:"icon",children:e.jsx(Me,{className:"h-4 w-4"})})}),e.jsx(me,{side:"left",className:"p-0 w-64",children:e.jsx(Y,{})})]}),Fe=s=>s.replace(/\D/g,""),Ue=he({full_name:D().min(1,"Nome √© obrigat√≥rio."),phone:D().min(1,"Telefone √© obrigat√≥rio.").transform(Fe).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."}),store_name:D().min(1,"O nome da loja √© obrigat√≥rio.")}),ze=async s=>{const{data:o,error:t}=await m.from("profiles").select("*").eq("id",s).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${t.message}`);const p=o||{id:s,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null},{data:b,error:l}=await m.from("restaurants").select("*").eq("owner_user_id",s).limit(1).single();return l&&l.code!=="PGRST116"&&console.warn("Erro ao buscar restaurante vinculado ao usu√°rio:",l.message),{profile:p,restaurant:b||null}},Ge=({isOpen:s,onClose:o,userId:t})=>{const p=H(),[b,l]=n.useState(null),{data:c,isLoading:h}=V({queryKey:["adminProfile",t],queryFn:()=>ze(t),enabled:!!t&&s,staleTime:0});n.useEffect(()=>{s&&m.auth.getSession().then(({data:{session:a}})=>{var d;l(((d=a==null?void 0:a.user)==null?void 0:d.email)||null)})},[s]);const x=fe({resolver:xe(Ue),defaultValues:{full_name:"",phone:"",store_name:""}});n.useEffect(()=>{var a;c&&x.reset({full_name:c.profile.full_name||"",phone:c.profile.phone||"",store_name:((a=c.restaurant)==null?void 0:a.name)||""})},[c,x]);const f=ae({mutationFn:async a=>{var E;if(!t)throw new Error("ID do usu√°rio n√£o encontrado.");const d={full_name:a.full_name,phone:a.phone},{error:v}=await m.from("profiles").update(d).eq("id",t);if(v)throw new Error(`Erro ao atualizar perfil: ${v.message}`);if((E=c==null?void 0:c.restaurant)!=null&&E.id){const _={name:a.store_name,phone:a.phone},{error:u}=await m.from("restaurants").update(_).eq("id",c.restaurant.id);if(u)throw new Error(`Erro ao atualizar nome/telefone da loja: ${u.message}`)}},onSuccess:()=>{N.success("Perfil e nome da loja atualizados com sucesso!"),p.invalidateQueries({queryKey:["adminProfile"]}),p.invalidateQueries({queryKey:["dashboardRestaurant"]}),p.invalidateQueries({queryKey:["restaurantSettings"]}),o()},onError:a=>{N.error(`Erro ao atualizar perfil: ${a.message}`)}}),S=a=>{f.mutate(a)};return e.jsx(pe,{open:s,onOpenChange:o,children:e.jsxs(ge,{className:"sm:max-w-[425px]",children:[e.jsxs(je,{children:[e.jsxs(be,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(ye,{children:"Atualize seus dados de contato e o nome da sua loja."})]}),h?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(w,{className:"h-4 w-1/3"}),e.jsx(w,{className:"h-10 w-full"}),e.jsx(w,{className:"h-4 w-1/3"}),e.jsx(w,{className:"h-10 w-full"}),e.jsx(w,{className:"h-4 w-1/3"}),e.jsx(w,{className:"h-10 w-full"}),e.jsx(w,{className:"h-10 w-full mt-6"})]}):e.jsx(we,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(S),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Ne,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ve,{className:"h-4 w-4"})," Email"]}),e.jsx(T,{value:b||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx(R,{control:x.control,name:"store_name",render:({field:a})=>e.jsxs(L,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4"})," Nome da Loja *"]}),e.jsx(q,{children:e.jsx(T,{placeholder:"Nome do seu restaurante",...a})}),e.jsx(M,{})]})}),e.jsx(R,{control:x.control,name:"full_name",render:({field:a})=>e.jsxs(L,{children:[e.jsx(A,{children:"Nome Completo *"}),e.jsx(q,{children:e.jsx(T,{placeholder:"Seu nome",...a})}),e.jsx(M,{})]})}),e.jsx(R,{control:x.control,name:"phone",render:({field:a})=>e.jsxs(L,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-4 w-4"})," Telefone *"]}),e.jsx(q,{children:e.jsx(Se,{...a})}),e.jsx(M,{})]})}),e.jsx(Ee,{className:"pt-4",children:e.jsxs(C,{type:"submit",disabled:f.isPending,children:[f.isPending?e.jsx(_e,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},Ke=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes",icon:$}],Qe=s=>{const o=Ke.find(t=>t.href===s);return o?o.label:"Dashboard"},He=async s=>{const{data:o,error:t}=await m.from("user_roles").select("role, restaurant_id").eq("user_id",s).limit(1).single();return t&&t.code!=="PGRST116"?(console.error("Error checking role and restaurant:",t),{role:null,restaurantId:null}):o?{role:o.role,restaurantId:o.restaurant_id}:{role:null,restaurantId:null}},Ve=()=>{const s=se(),o=W(),t=H(),[p,b]=n.useState(null),[l,c]=n.useState(void 0),[h,x]=n.useState(null),f=n.useRef(null),[S,a]=n.useState("loading"),[d,v]=n.useState(null),[E,_]=n.useState(!1),{data:u,isLoading:Z,isError:J,error:F}=V({queryKey:["dashboardRestaurant",h],queryFn:async()=>{if(!h)throw new Error("Restaurant ID not found for user.");const{data:i,error:g}=await m.from("restaurants").select("*").eq("id",h).single();if(g)throw new Error(g.message);return i},enabled:!!p&&(l==="admin"||l==="moderator")&&!!h,staleTime:1/0}),y=n.useMemo(()=>!(u!=null&&u.notification_sound_url)||u.notification_sound_url.trim()===""?"./default-notification.mp3":u.notification_sound_url,[u==null?void 0:u.notification_sound_url]);n.useEffect(()=>{const i=async r=>{if(!(r!=null&&r.user)){b(null),c(null),x(null),s("/admin-auth",{replace:!0});return}const{role:j,restaurantId:U}=await He(r.user.id);if(b(r.user),c(j),x(U),j==="user"){N.error("Acesso restrito.",{description:"Esta conta √© de cliente e n√£o tem permiss√£o para acessar o painel.",duration:5e3}),await m.auth.signOut();const ee=`${window.location.origin}${window.location.pathname}#/`;window.location.href=ee;return}j!=="admin"&&j!=="moderator"&&(N.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),s("/admin-auth",{replace:!0})),(j==="admin"||j==="moderator")&&!U&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:g}}=m.auth.onAuthStateChange((r,j)=>{r==="SIGNED_OUT"?(b(null),c(null),x(null),s("/admin-auth",{replace:!0})):i(j)});return m.auth.getSession().then(({data:{session:r}})=>{i(r)}),()=>g.unsubscribe()},[s]),n.useEffect(()=>{var i;y?((i=f.current)==null?void 0:i.src)!==`${window.location.origin}${window.location.pathname}${y}`&&a("loading"):a("error")},[y]);const P=n.useCallback(()=>{f.current&&(f.current.pause(),f.current.loop=!1,v(null))},[]),k=n.useCallback(i=>{f.current&&S==="ready"&&(d&&d!==i&&P(),(!d||d===i)&&(v(i),f.current.loop=!0,f.current.play().catch(g=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",g),v(null)})))},[S,d,P]);n.useEffect(()=>{if(l!=="admin"&&l!=="moderator"||!h)return;const i=m.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},g=>{t.invalidateQueries({queryKey:["orders"]});const r=g.new;r.status==="pending"&&r.id&&r.restaurant_id===h&&(N.info("üîî Novo pedido recebido!",{description:`Pedido #${r.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),k(r.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},g=>{t.invalidateQueries({queryKey:["orders"]});const r=g.new;r.restaurant_id===h&&(r.status==="pending"&&r.id&&r.id!==d&&(N.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${r.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3}),k(r.id)),r.id===d&&r.status!=="pending"&&r.status!=="pending_payment"&&P())}).subscribe();return()=>{m.removeChannel(i)}},[t,k,P,d,l,h]);const X=async()=>{await m.auth.signOut()};return l===void 0||Z?e.jsx(I,{}):l!=="admin"&&l!=="moderator"?e.jsx(I,{}):h?J?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(z,{variant:"destructive",className:"max-w-md",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(G,{children:"Erro ao Carregar Restaurante"}),e.jsx(K,{children:F instanceof Error?F.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})}):u?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{isOpen:E,onClose:()=>_(!1),userId:(p==null?void 0:p.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(Y,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx($e,{})}),e.jsx(B,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:Qe(o.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ce,{children:[e.jsx(ke,{asChild:!0,children:e.jsx(C,{variant:"outline",size:"icon",onClick:()=>_(!0),"aria-label":"Meu Perfil",children:e.jsx($,{className:"h-4 w-4"})})}),e.jsx(De,{children:"Meu Perfil"})]}),e.jsx(C,{variant:"outline",onClick:X,children:"Sair"})]})]})}),e.jsx(oe,{context:{restaurant:u,userRestaurantId:h}})]}),y&&e.jsx("audio",{ref:f,src:y.startsWith("http")?y:`${window.location.origin}${window.location.pathname}${y}`,onCanPlayThrough:()=>{a("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:i=>{console.error("Erro ao carregar o √°udio:",i),N.error("Erro ao carregar o som de notifica√ß√£o.",{description:"O som de notifica√ß√£o autom√°tica pode n√£o funcionar."}),a("error")},className:"hidden"})]})]}):e.jsx(I,{}):e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(z,{variant:"destructive",className:"max-w-md",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(G,{children:"Erro de Configura√ß√£o"}),e.jsx(K,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})})},sa=n.memo(Ve);export{sa as default};
