import{j as e}from"./tanstack-C7aOFagJ.js";import{h as O,r as d,L as T}from"./vendor-DjsPZZVP.js";import{L as z}from"./Logo-CCr9P2Hc.js";import{c as P,s as m,d as M,C as V,e as $,f as B,M as k,g as G,b as H,h as x,I as N,B as g,L as I,P as J,j as t}from"./index-Xm2VCMS5.js";import{S as W}from"./separator-DwGlAuzP.js";import{A as K}from"./arrow-left-DJmiCiXf.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=P("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=P("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),A=o=>o.replace(/\D/g,""),L=async o=>{const{data:i,error:n}=await m.from("user_roles").select("role, restaurant_id").eq("user_id",o).limit(1).single();return n&&n.code!=="PGRST116"?(console.error("Error checking role and restaurant:",n),{role:null,restaurantId:null}):i?{role:i.role,restaurantId:i.restaurant_id}:{role:null,restaurantId:null}},Y=async o=>{let{role:i,restaurantId:n}=await L(o.id);if((i==="admin"||i==="moderator")&&n)return{role:i,restaurantId:n};if(i==="user")return console.log(`[AdminAuth] User ${o.id} is a customer ('user' role). Blocking admin setup.`),{role:"user",restaurantId:null};console.log(`[AdminAuth] Running setup for user ${o.id}. Current role: ${i}, Restaurant ID: ${n}`);const f=o.user_metadata.full_name||"Novo Usuário",{error:c,data:s}=await m.functions.invoke("ensure-admin-access",{body:{userId:o.id,fullName:f}});if(c){console.error("Error setting up admin access:",c);let u="Falha ao configurar acesso de administrador.";throw s&&typeof s=="object"&&"error"in s?u=s.error:c.message.includes("non-2xx status code")?u="Erro interno do servidor (500). Verifique os logs do Supabase.":u=c.message,new Error(u)}const j=await L(o.id);return i=j.role,n=j.restaurantId,{role:i,restaurantId:n}},ie=()=>{const o=O(),[i,n]=d.useState(!0),[f,c]=d.useState(!1),[s,j]=d.useState(!1),[u,v]=d.useState(!1),[p,w]=d.useState(""),[y,F]=d.useState(""),[b,D]=d.useState(""),[S,R]=d.useState(""),[Z,E]=d.useState(null),C=async r=>{n(!0);try{const{role:a,restaurantId:l}=await Y(r);if(a==="admin"||a==="moderator")if(l)t.success("Acesso ao painel concedido."),o("/dashboard",{replace:!0});else throw new Error("Sua conta de administrador não está vinculada a um restaurante. Tente novamente ou contate o suporte.");else t.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await m.auth.signOut(),o("/",{replace:!0})}catch(a){console.error("Error during admin setup/redirect:",a),t.error("Erro crítico de autenticação.",{description:a instanceof Error?a.message:"Ocorreu um erro desconhecido. Tente novamente.",duration:8e3}),await m.auth.signOut(),n(!1)}};d.useEffect(()=>{(async()=>{const{data:{session:l}}=await m.auth.getSession();E(l),l!=null&&l.user?C(l.user):n(!1)})();const{data:{subscription:a}}=m.auth.onAuthStateChange((l,h)=>{E(h),l==="SIGNED_IN"&&(h!=null&&h.user)?C(h.user):l==="SIGNED_OUT"&&n(!1)});return()=>a.unsubscribe()},[o]);const q=()=>{if(s){if(!b.trim())return t.error("O Nome Completo é obrigatório."),!1;if(A(S).length!==11)return t.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1}return p.trim()?y.length<6?(t.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(t.error("O Email é obrigatório."),!1)},U=async r=>{if(r.preventDefault(),!!q()){c(!0);try{if(s){const a=A(S),{data:l,error:h}=await m.auth.signUp({email:p,password:y,options:{data:{full_name:b,phone:a}}});if(h)throw h;l.session?t.success("Conta de administrador criada e login efetuado!"):(t.success("Conta criada! Verifique seu email para confirmar."),c(!1))}else{const{error:a}=await m.auth.signInWithPassword({email:p,password:y});if(a)throw a;t.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?t.error("Por favor, verifique seu e-mail para confirmar sua conta."):t.error(a.message||"Erro ao processar autenticação"),c(!1)}}},_=async r=>{if(r.preventDefault(),!p.trim()){t.error("O Email é obrigatório para recuperação de senha.");return}c(!0);try{const{error:a}=await m.auth.resetPasswordForEmail(p,{redirectTo:window.location.origin+window.location.pathname+"#/admin-auth"});if(a)throw a;t.success("Email de recuperação enviado!",{description:"Verifique sua caixa de entrada (e spam) para o link de redefinição de senha.",duration:8e3}),v(!1)}catch(a){t.error(a.message||"Erro ao enviar email de recuperação.")}finally{c(!1)}};return i?e.jsx(M,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(z,{className:"justify-center mb-4"})}),e.jsxs(V,{className:"shadow-xl border-2",children:[e.jsxs($,{className:"space-y-1",children:[e.jsxs(B,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[u?e.jsx(k,{className:"h-6 w-6 text-primary"}):s?e.jsx(X,{className:"h-6 w-6 text-primary"}):e.jsx(Q,{className:"h-6 w-6 text-destructive"}),u?"Recuperar Senha":s?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(G,{className:"text-center",children:u?"Digite seu email para receber o link de redefinição.":s?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs(H,{className:"space-y-4",children:[u?e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",children:"Email *"}),e.jsx(N,{id:"email",type:"email",placeholder:"seu@email.com",value:p,onChange:r=>w(r.target.value),required:!0,className:"h-12"})]}),e.jsxs(g,{type:"submit",className:"w-full",size:"lg",disabled:f,children:[f?e.jsx(I,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(k,{className:"h-4 w-4 mr-2"}),"Enviar Link de Recuperação"]}),e.jsx("div",{className:"text-center",children:e.jsxs(g,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{v(!1),w("")},children:[e.jsx(K,{className:"h-4 w-4 mr-1"})," Voltar para o Login"]})})]}):e.jsxs("form",{onSubmit:U,className:"space-y-4",children:[s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(N,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:b,onChange:r=>D(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"phone",children:"Telefone *"}),e.jsx(J,{id:"phone",value:S,onChange:r=>R(r.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",children:"Email *"}),e.jsx(N,{id:"email",type:"email",placeholder:"seu@email.com",value:p,onChange:r=>w(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"password",children:"Senha *"}),e.jsx(N,{id:"password",type:"password",placeholder:"••••••••",value:y,onChange:r=>F(r.target.value),required:!0,className:"h-12"})]}),!s&&e.jsx("div",{className:"text-right",children:e.jsx(g,{variant:"link",type:"button",className:"p-0 h-auto text-sm text-muted-foreground hover:text-primary",onClick:()=>v(!0),children:"Esqueci minha senha"})}),e.jsx(g,{type:"submit",className:"w-full",size:"lg",disabled:f,children:f?e.jsx(I,{className:"h-4 w-4 animate-spin mr-2"}):s?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(g,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>j(!s),children:s?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(W,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(T,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{ie as default};
