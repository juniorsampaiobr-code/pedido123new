import{j as e,u as V,b as W,c as ae}from"./tanstack-d4AvmB45.js";import{h as B,L as se,r as n,u as oe,O as te}from"./vendor-CnEXr6gt.js";import{s as d}from"./client-D5i5GwB9.js";import{L as ne}from"./Logo-7kkgWOjK.js";import{c as O,a as ie,u as S,L as le,b as M,T as ce,r as de,s as ue}from"./index-jj5c9c49.js";import{P as me}from"./package-DUSGJXWq.js";import{S as X}from"./shopping-cart-DtPvinB5.js";import{C as fe,T as he}from"./truck-BJUJG2f7.js";import{C as Y}from"./credit-card-Db2PG02l.js";import{S as pe}from"./settings-DSzigcKi.js";import{B as q}from"./button-CnnCym5e.js";import{S as xe,a as ge,b as je}from"./sheet-Pcg1Di2Q.js";import{o as be,s as k,u as ye,t as we}from"./types-DKlirIXB.js";import{D as Ne,a as ve,b as Ce,c as Se,d as Ee,e as _e}from"./dialog-D9SgsJcz.js";import{F as Pe,a as T,b as L,c as R,d as $,e as A}from"./form-7axaUjHL.js";import{L as De,I as U}from"./label-D8_uljYV.js";import{M as ke,P as Te}from"./PhoneInput-Bue6x1MV.js";import{C as Le}from"./CpfCnpjInput-Bx_bubws.js";import{S as C}from"./skeleton-Bq_jCQQ3.js";import{U as z}from"./user-B8AQs0O8.js";import{S as Re}from"./store-3lL3DQ6V.js";import{P as $e}from"./phone-pfGLIujU.js";import{S as Ae}from"./save-D8_BE7IP.js";import{A as Q,a as G,b as H}from"./alert-CEgimnPw.js";import{C as J}from"./circle-alert-BPojF4lC.js";import"./supabase-BZV_3FV3.js";import"./index-C6KKkZDR.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=O("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=O("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=O("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),Me=[{href:"/dashboard",label:"Dashboard",icon:qe},{href:"/products",label:"Produtos",icon:me},{href:"/orders",label:"Pedidos",icon:X},{href:"/cashier",label:"Caixa",icon:Ie},{href:"/hours",label:"Hor√°rios",icon:fe},{href:"/payments",label:"Pagamentos",icon:Y},{href:"/delivery",label:"Taxa de Entrega",icon:he},{href:"/settings",label:"Configura√ß√µes",icon:pe}],Z=()=>{const s=B();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(ne,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:Me.map(r=>e.jsx("li",{children:e.jsxs(se,{to:r.href,className:ie("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",s.pathname===r.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(r.icon,{className:"h-4 w-4"}),r.label]})},r.href))})})]})},Ue=()=>e.jsxs(xe,{children:[e.jsx(ge,{asChild:!0,children:e.jsx(q,{variant:"outline",size:"icon",children:e.jsx(Fe,{className:"h-4 w-4"})})}),e.jsx(je,{side:"left",className:"p-0 w-64",children:e.jsx(Z,{})})]}),Oe=s=>s.replace(/\D/g,""),ze=s=>s.replace(/\D/g,""),Ke=s=>{if(!s)return"";let r=s.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},Qe=be({full_name:k().min(1,"Nome √© obrigat√≥rio."),phone:k().min(1,"Telefone √© obrigat√≥rio.").transform(Oe).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."}),store_name:k().min(1,"O nome da loja √© obrigat√≥rio."),cpf_cnpj:k().min(1,"CPF/CNPJ √© obrigat√≥rio.").transform(ze).refine(s=>s.length===11||s.length===14,{message:"CPF deve ter 11 d√≠gitos ou CNPJ 14 d√≠gitos."})}),Ge=async s=>{const{data:r,error:t}=await d.from("profiles").select("*").eq("id",s).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${t.message}`);const h=r||{id:s,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null},{data:N,error:c}=await d.from("restaurants").select("*").eq("owner_user_id",s).limit(1).single();return c&&c.code!=="PGRST116"&&console.warn("Erro ao buscar restaurante vinculado ao usu√°rio:",c.message),{profile:h,restaurant:N||null}},He=({isOpen:s,onClose:r,userId:t})=>{const h=V(),[N,c]=n.useState(null),[E,u]=n.useState(null),{data:m,isLoading:p}=W({queryKey:["adminProfile",t],queryFn:()=>Ge(t),enabled:!!t&&s,staleTime:0});n.useEffect(()=>{s&&d.auth.getSession().then(({data:{session:a}})=>{var b,y,i;c(((b=a==null?void 0:a.user)==null?void 0:b.email)||null),u(((i=(y=a==null?void 0:a.user)==null?void 0:y.user_metadata)==null?void 0:i.cpf_cnpj)||null)})},[s]);const f=ye({resolver:we(Qe),defaultValues:{full_name:"",phone:"",store_name:"",cpf_cnpj:""}});n.useEffect(()=>{var a;m&&f.reset({full_name:m.profile.full_name||"",phone:Ke(m.profile.phone||""),store_name:((a=m.restaurant)==null?void 0:a.name)||"",cpf_cnpj:E||""})},[m,f,E]);const j=ae({mutationFn:async a=>{var P;if(!t)throw new Error("ID do usu√°rio n√£o encontrado.");const b={full_name:a.full_name,phone:a.phone},{error:y}=await d.from("profiles").update(b).eq("id",t);if(y)throw new Error(`Erro ao atualizar perfil: ${y.message}`);if((P=m==null?void 0:m.restaurant)!=null&&P.id){const F={name:a.store_name,phone:a.phone},{error:_}=await d.from("restaurants").update(F).eq("id",m.restaurant.id);if(_)throw new Error(`Erro ao atualizar nome/telefone da loja: ${_.message}`)}const{error:i}=await d.auth.updateUser({data:{cpf_cnpj:a.cpf_cnpj}});if(i)throw new Error(`Erro ao atualizar CPF/CNPJ: ${i.message}`)},onSuccess:(a,b)=>{S.success("Perfil e nome da loja atualizados com sucesso!"),u(b.cpf_cnpj),h.invalidateQueries({queryKey:["adminProfile"]}),h.invalidateQueries({queryKey:["dashboardRestaurant"]}),h.invalidateQueries({queryKey:["restaurantSettings"]}),r()},onError:a=>{S.error(`Erro ao atualizar perfil: ${a.message}`)}}),x=a=>{j.mutate(a)};return e.jsx(Ne,{open:s,onOpenChange:r,children:e.jsxs(ve,{className:"sm:max-w-[425px]",children:[e.jsxs(Ce,{children:[e.jsxs(Se,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(Ee,{children:"Atualize seus dados de contato e o nome da sua loja."})]}),p?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(C,{className:"h-4 w-1/3"}),e.jsx(C,{className:"h-10 w-full"}),e.jsx(C,{className:"h-4 w-1/3"}),e.jsx(C,{className:"h-10 w-full"}),e.jsx(C,{className:"h-4 w-1/3"}),e.jsx(C,{className:"h-10 w-full"}),e.jsx(C,{className:"h-10 w-full mt-6"})]}):e.jsx(Pe,{...f,children:e.jsxs("form",{onSubmit:f.handleSubmit(x),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(De,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ke,{className:"h-4 w-4"})," Email"]}),e.jsx(U,{value:N||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx(T,{control:f.control,name:"store_name",render:({field:a})=>e.jsxs(L,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4"})," Nome da Loja *"]}),e.jsx($,{children:e.jsx(U,{placeholder:"Nome do seu restaurante",...a})}),e.jsx(A,{})]})}),e.jsx(T,{control:f.control,name:"full_name",render:({field:a})=>e.jsxs(L,{children:[e.jsx(R,{children:"Nome Completo *"}),e.jsx($,{children:e.jsx(U,{placeholder:"Seu nome",...a})}),e.jsx(A,{})]})}),e.jsx(T,{control:f.control,name:"phone",render:({field:a})=>e.jsxs(L,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"})," Telefone *"]}),e.jsx($,{children:e.jsx(Te,{...a})}),e.jsx(A,{})]})}),e.jsx(T,{control:f.control,name:"cpf_cnpj",render:({field:a})=>e.jsxs(L,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"})," CPF/CNPJ *"]}),e.jsx($,{children:e.jsx(Le,{...a})}),e.jsx(A,{})]})}),e.jsx(_e,{className:"pt-4",children:e.jsxs(q,{type:"submit",disabled:j.isPending,children:[j.isPending?e.jsx(le,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ae,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},Je=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes",icon:z}],Ve=s=>{const r=Je.find(t=>t.href===s);return r?r.label:"Dashboard"},We=async s=>{const{data:r,error:t}=await d.from("user_roles").select("role, restaurant_id").eq("user_id",s).limit(1).single();return t&&t.code!=="PGRST116"?(console.error("Error checking role and restaurant:",t),{role:null,restaurantId:null}):r?{role:r.role,restaurantId:r.restaurant_id}:{role:null,restaurantId:null}},Be=()=>{const s=oe(),r=B(),t=V(),[h,N]=n.useState(null),[c,E]=n.useState(void 0),[u,m]=n.useState(null),p=n.useRef(null),[f,j]=n.useState("loading"),[x,a]=n.useState(null),[b,y]=n.useState(!1),{data:i,isLoading:P,isError:F,error:_}=W({queryKey:["dashboardRestaurant",u],queryFn:async()=>{if(!u)throw new Error("Restaurant ID not found for user.");const{data:l,error:g}=await d.from("restaurants").select("*").eq("id",u).single();if(g)throw new Error(g.message);return l},enabled:!!h&&(c==="admin"||c==="moderator")&&!!u,staleTime:1/0}),v=n.useMemo(()=>!(i!=null&&i.notification_sound_url)||i.notification_sound_url.trim()===""?"./default-notification.mp3":i.notification_sound_url,[i==null?void 0:i.notification_sound_url]);n.useEffect(()=>{const l=async o=>{if(!(o!=null&&o.user)){N(null),E(null),m(null),s("/admin-auth",{replace:!0});return}const{role:w,restaurantId:K}=await We(o.user.id);if(N(o.user),E(w),m(K),w==="user"){S.error("Acesso restrito.",{description:"Esta conta √© de cliente e n√£o tem permiss√£o para acessar o painel.",duration:5e3}),await d.auth.signOut();const re=`${window.location.origin}${window.location.pathname}#/`;window.location.href=re;return}w!=="admin"&&w!=="moderator"&&(S.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),s("/admin-auth",{replace:!0})),(w==="admin"||w==="moderator")&&!K&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:g}}=d.auth.onAuthStateChange((o,w)=>{o==="SIGNED_OUT"?(N(null),E(null),m(null),s("/admin-auth",{replace:!0})):l(w)});return d.auth.getSession().then(({data:{session:o}})=>{l(o)}),()=>g.unsubscribe()},[s]),n.useEffect(()=>{var l;v?((l=p.current)==null?void 0:l.src)!==`${window.location.origin}${window.location.pathname}${v}`&&j("loading"):j("error")},[v]);const D=n.useCallback(()=>{p.current&&(p.current.pause(),p.current.loop=!1,a(null))},[]),I=n.useCallback(l=>{p.current&&f==="ready"&&(x&&x!==l&&D(),(!x||x===l)&&(a(l),p.current.loop=!0,p.current.play().catch(g=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",g),a(null)})))},[f,x,D]);n.useEffect(()=>{if(c!=="admin"&&c!=="moderator"||!u)return;const l=d.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},g=>{t.invalidateQueries({queryKey:["orders"]});const o=g.new;o.status==="pending"&&o.id&&o.restaurant_id===u&&(S.info("üîî Novo pedido recebido!",{description:`Pedido #${o.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),I(o.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},g=>{t.invalidateQueries({queryKey:["orders"]});const o=g.new;o.restaurant_id===u&&(o.status==="pending"&&o.id&&o.id!==x&&(S.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${o.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3}),I(o.id)),o.id===x&&o.status!=="pending"&&o.status!=="pending_payment"&&D())}).subscribe();return()=>{d.removeChannel(l)}},[t,I,D,x,c,u]);const ee=async()=>{await d.auth.signOut()};return c===void 0||P?e.jsx(M,{}):c!=="admin"&&c!=="moderator"?e.jsx(M,{}):u?F?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(Q,{variant:"destructive",className:"max-w-md",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(G,{children:"Erro ao Carregar Restaurante"}),e.jsx(H,{children:_ instanceof Error?_.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})}):i?e.jsxs(e.Fragment,{children:[e.jsx(He,{isOpen:b,onClose:()=>y(!1),userId:(h==null?void 0:h.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(Z,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(Ue,{})}),e.jsx(X,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:Ve(r.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ce,{children:[e.jsx(de,{asChild:!0,children:e.jsx(q,{variant:"outline",size:"icon",onClick:()=>y(!0),"aria-label":"Meu Perfil",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx(ue,{children:"Meu Perfil"})]}),e.jsx(q,{variant:"outline",onClick:ee,children:"Sair"})]})]})}),e.jsx(te,{context:{restaurant:i,userRestaurantId:u}})]}),v&&e.jsx("audio",{ref:p,src:v.startsWith("http")?v:`${window.location.origin}${window.location.pathname}${v}`,onCanPlayThrough:()=>{j("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:l=>{console.error("Erro ao carregar o √°udio:",l),S.error("Erro ao carregar o som de notifica√ß√£o.",{description:"O som de notifica√ß√£o autom√°tica pode n√£o funcionar."}),j("error")},className:"hidden"})]})]}):e.jsx(M,{}):e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(Q,{variant:"destructive",className:"max-w-md",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(G,{children:"Erro de Configura√ß√£o"}),e.jsx(H,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})})},Cr=n.memo(Be);export{Cr as default};
