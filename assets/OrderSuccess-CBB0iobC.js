import{u as P,j as e,b as O,c as S}from"./tanstack-D8i8yNxB.js";import{i as D,h as L,r as v,L as u}from"./vendor-Dl0Wzy4_.js";import{B as n}from"./button-uoUUVmK6.js";import{C as c,b as h,c as f,a as l}from"./card-B-edsjJO.js";import{s as g}from"./client-BmrnLCXS.js";import{S as E}from"./skeleton-fy2MvbC9.js";import{A as T,a as k,b as q}from"./alert-BX_9XMLd.js";import{c as F,L as b,b as I,a as M}from"./index-C28RKmd8.js";import{T as K}from"./terminal-nzsVTFeN.js";import{C as _}from"./clock-DIi0y_XB.js";import{P as Q}from"./package-CcyxlXH8.js";import{T as B}from"./truck-BT7vTeHa.js";import{C as G,a as R}from"./circle-x-BkMM3t2Y.js";import{D as V}from"./dollar-sign-DzmXqnK5.js";import{A as $,a as z,b as U,c as H,d as X,e as Z,f as J,g as W,h as Y}from"./alert-dialog-DUoB4t0K.js";import{A as ee}from"./arrow-left-2-Zx5SvV.js";import"./supabase-A1WgB1xz.js";import"./index-D1PEOXLs.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=F("Utensils",[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]]),se={pending:{label:"Pendente",icon:_,color:"bg-yellow-500",description:"Aguardando a confirmação do restaurante."},preparing:{label:"Em Preparação",icon:re,color:"bg-orange-500",description:"O restaurante está preparando seus itens."},ready:{label:"Pronto",icon:Q,color:"bg-green-500",description:"Seu pedido está pronto para retirada ou entrega."},delivering:{label:"Em Entrega",icon:B,color:"bg-indigo-500",description:"Seu pedido saiu para entrega e está a caminho."},delivered:{label:"Entregue",icon:G,color:"bg-primary",description:"Seu pedido foi entregue com sucesso!"},cancelled:{label:"Cancelado",icon:R,color:"bg-destructive",description:"Seu pedido foi cancelado. Entre em contato com o restaurante se houver dúvidas."},pending_payment:{label:"Aguardando Pagamento",icon:V,color:"bg-gray-500",description:"Aguardando a confirmação do pagamento online."}},ae=async r=>{const{data:a,error:t}=await g.from("orders").select("*, customer:customers(name, phone)").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar detalhes do pedido: ${t.message}`);if(!a)throw new Error("Pedido não encontrado.");return a},te=({orderId:r})=>{var d;const{data:a,isLoading:t,isError:j,error:m}=P({queryKey:["orderStatus",r],queryFn:()=>ae(r),refetchInterval:1e4,staleTime:0,refetchOnMount:!0});if(t&&!a)return e.jsx(c,{className:"w-full max-w-md text-center shadow-xl",children:e.jsxs("div",{className:"p-6",children:[" ",e.jsxs(h,{className:"space-y-4",children:[e.jsx(b,{className:"h-16 w-16 text-primary mx-auto animate-spin"}),e.jsx(f,{className:"text-2xl font-bold",children:"Carregando Status..."})]}),e.jsxs(l,{children:[e.jsx(E,{className:"h-4 w-3/4 mx-auto mb-2"}),e.jsx(E,{className:"h-4 w-1/2 mx-auto"})]})]})});if(j)return e.jsxs(T,{variant:"destructive",className:"w-full max-w-md mx-auto",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(k,{children:"Erro ao rastrear pedido"}),e.jsx(q,{children:m instanceof Error?m.message:"Não foi possível carregar o status do pedido."})]});if(!a)return null;const i=a.status||"pending",o=se[i],N=a.created_at?new Date(a.created_at).getTime().toString().slice(-4):r.slice(-4),w=o.icon;return e.jsx(c,{className:"w-full max-w-md text-center shadow-xl",children:e.jsxs("div",{className:"p-6",children:[" ",e.jsxs(h,{className:"space-y-4",children:[e.jsx("div",{className:I("h-16 w-16 rounded-full mx-auto flex items-center justify-center text-white",o.color),children:e.jsx(w,{className:"h-8 w-8"})}),e.jsxs(f,{className:"text-3xl font-bold",children:["Pedido #",N]}),e.jsxs("p",{className:"text-lg font-semibold text-foreground",children:["Status: ",o.label]})]}),e.jsxs(l,{className:"space-y-6",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:o.description}),e.jsxs("div",{className:"text-left border-t pt-4 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Detalhes:"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Cliente: ",((d=a.customer)==null?void 0:d.name)||"N/A"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Total: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a.total_amount)]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Endereço: ",a.delivery_address||"Retirada no Local"]})]})]})]})})},oe=async r=>{const{data:a,error:t}=await g.from("orders").select("*").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar detalhes do pedido: ${t.message}`);if(!a)throw new Error("Pedido não encontrado.");return a},Ce=()=>{const{orderId:r}=D(),[a]=L(),t=O();M();const[j,m]=v.useState(!1),i=a.get("status"),{data:o,isLoading:N,isError:w}=P({queryKey:["customerOrderStatus",r],queryFn:()=>oe(r),enabled:!!r,refetchInterval:1e4}),d=v.useMemo(()=>{if(!o)return!1;const s=o.status;return s==="pending"||s==="preparing"||s==="ready"||s==="pending_payment"},[o]),y=S({mutationFn:async s=>{const{data:p,error:C}=await g.functions.invoke("confirm-payment",{body:{orderId:s}});if(C)throw new Error(C.message);return p},onSuccess:s=>{(s==null?void 0:s.status)==="approved"?console.log("LOG: Pagamento confirmado com sucesso!"):(s==null?void 0:s.status)==="pending"?console.log("LOG: Pagamento ainda pendente de confirmação. Aguardando a compensação do Pix/Boleto."):console.log("LOG: Status de pagamento não aprovado. Se você já pagou, aguarde alguns minutos ou entre em contato com o restaurante."),t.invalidateQueries({queryKey:["orderStatus",r]}),t.invalidateQueries({queryKey:["customerOrderStatus",r]})},onError:s=>{console.error(`LOG: Falha na confirmação do pagamento: ${s.message}`)}}),x=S({mutationFn:async s=>{const{error:p}=await g.from("orders").update({status:"cancelled"}).eq("id",s);if(p)throw new Error(p.message)},onSuccess:()=>{console.log("LOG: Pedido cancelado com sucesso."),t.invalidateQueries({queryKey:["customerOrderStatus",r]}),t.invalidateQueries({queryKey:["orderStatus",r]}),t.invalidateQueries({queryKey:["orders"]})},onError:s=>{console.error(`LOG: Erro ao cancelar pedido: ${s.message}`)}}),A=()=>{r&&(x.mutate(r),m(!1))};return v.useEffect(()=>{r&&(i==="approved"||i==="pending")&&setTimeout(()=>{y.mutate(r)},0)},[r,i,y]),r?N?e.jsx("div",{className:"min-h-screen bg-background flex flex-col items-center justify-center p-4",children:e.jsx(c,{className:"w-full max-w-md text-center shadow-xl",children:e.jsxs(l,{className:"p-6 flex flex-col items-center justify-center",children:[e.jsx(b,{className:"h-8 w-8 mb-4 text-primary animate-spin"}),e.jsx("p",{className:"font-semibold",children:"Carregando informações do pedido..."})]})})}):w||!o?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs(c,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(h,{children:e.jsx(f,{className:"text-2xl font-bold text-destructive",children:"Erro"})}),e.jsxs(l,{children:[e.jsx("p",{className:"text-muted-foreground",children:"Pedido não encontrado ou erro de carregamento. Tente recarregar a página."}),e.jsx(u,{to:"/menu",children:e.jsx(n,{className:"mt-4",children:"Voltar ao Cardápio"})})]})]})}):e.jsxs("div",{className:"min-h-screen bg-background flex flex-col items-center justify-center p-4",children:[e.jsx("div",{className:"w-full max-w-md mb-6",children:e.jsx(u,{to:"/menu",children:e.jsxs(n,{variant:"ghost",className:"mb-4",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"})," Voltar ao Cardápio"]})})}),y.isPending&&(i==="approved"||i==="pending")&&e.jsx(c,{className:"w-full max-w-md text-center shadow-xl mb-6",children:e.jsxs(l,{className:"p-6 flex items-center justify-center",children:[e.jsx(b,{className:"h-5 w-5 mr-3 animate-spin"}),e.jsx("p",{className:"font-semibold",children:"Confirmando pagamento, por favor aguarde..."})]})}),e.jsx("div",{children:e.jsx(te,{orderId:r})}),e.jsx("div",{className:"w-full max-w-md mt-6",children:e.jsx(c,{className:"shadow-xl",children:e.jsxs(l,{className:"p-6 space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Você pode acompanhar o status do seu pedido nesta página."}),e.jsxs($,{open:j,onOpenChange:m,children:[e.jsx(z,{asChild:!0,children:e.jsx(n,{variant:"destructive",className:"w-full",disabled:!d||x.isPending,children:x.isPending?"Cancelando...":"Cancelar Pedido"})}),e.jsxs(U,{children:[e.jsxs(H,{children:[e.jsx(X,{children:"Tem certeza que deseja cancelar o pedido?"}),e.jsx(Z,{children:"O cancelamento só é possível antes do pedido sair para entrega. Se o restaurante já estiver preparando, o cancelamento pode não ser aceito."})]}),e.jsxs(J,{children:[e.jsx(W,{asChild:!0,children:e.jsx(n,{variant:"outline",children:"Não, manter pedido"})}),e.jsx(Y,{asChild:!0,children:e.jsx(n,{onClick:A,variant:"destructive",disabled:x.isPending,children:"Sim, cancelar"})})]})]})]}),!d&&e.jsx(u,{to:"/menu",children:e.jsx(n,{className:"w-full",variant:"default",children:"Fazer Novo Pedido"})}),d&&e.jsx(u,{to:"/menu",children:e.jsx(n,{className:"w-full",variant:"outline",children:"Fazer Novo Pedido"})})]})})})]}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs(c,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(h,{children:e.jsx(f,{className:"text-2xl font-bold text-destructive",children:"Erro"})}),e.jsxs(l,{children:[e.jsx("p",{className:"text-muted-foreground",children:"ID do pedido não encontrado."}),e.jsx(u,{to:"/menu",children:e.jsx(n,{className:"mt-4",children:"Voltar ao Cardápio"})})]})]})})};export{Ce as default};
