import{u as Y,a as _,b as w,j as e}from"./tanstack-E1juXnZE.js";import{o as E,s as A,a as Z,e as ee,u as D,t as I}from"./types-DkmadQTj.js";import{s as x}from"./client-DHSUo4L7.js";import{B as K}from"./button-DZf5fjUF.js";import{C as N,a as k,b as C,d as S}from"./card-CkBgMLGH.js";import{I as O}from"./input-CwnxbN_z.js";import{S as se}from"./switch-BX1vAzAN.js";import{c as U,L as ae,u as h}from"./index-Cf_TXpBF.js";import{F as R,a as q,b as M,e as B,c as T,d as Q}from"./form-BcJ-rGFv.js";import{S as d}from"./skeleton-y5dhUFmF.js";import{b as re,r as P}from"./vendor-nYMJN4lg.js";import{A as oe,a as te,b as ne}from"./alert-DdwIKPi0.js";import{C as ie}from"./circle-check-big-CXHfle4r.js";import{C as ce}from"./circle-x-6q2_FIhd.js";import{S as $}from"./store-oacrwShJ.js";import{P as G}from"./package-CR8XLPeS.js";import{C as H}from"./credit-card-C3QYdGp8.js";import{D as z}from"./dollar-sign-Bb4hzpr7.js";import"./supabase-CBMN163Q.js";import"./index-DpcYSu1F.js";import"./label-akLErNRj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=U("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=U("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),le=E({mercado_pago_public_key:A().optional(),mercado_pago_access_token:A().optional()}),ue=E({methods:Z(E({id:A(),is_active:ee()}))}),pe=async o=>{const{data:a,error:n}=await x.from("payment_settings").select("*").eq("restaurant_id",o).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return a},V=async o=>{const{data:a,error:n}=await x.from("payment_methods").select("*").eq("restaurant_id",o).order("name",{ascending:!0});if(n)throw new Error(n.message);return a},xe=async()=>{const{data:o,error:a}=await x.functions.invoke("check-mp-credentials");if(a)throw new Error(a.message);return o},he=[{name:"Dinheiro",description:"Pagamento em dinheiro na entrega",icon:z},{name:"Pagamento online: Pix/Cartão",description:"Pagamento online via Mercado Pago (Pix, Cartão de Crédito, etc.)",icon:H},{name:"Pagamento com cartão na entrega",description:"Aceita pagamento com cartão de débito ou crédito na entrega",icon:G}],fe=o=>{switch(o){case"DollarSign":return z;case"Smartphone":return me;case"CreditCard":return H;case"Package":return G;default:return $}},ge=({method:o,index:a,control:n,icon:f})=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(f,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:o.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o.description})]})]}),e.jsx(q,{control:n,name:`methods.${a}.is_active`,render:({field:t})=>e.jsx(M,{children:e.jsx(T,{children:e.jsx(se,{checked:t.value,onCheckedChange:t.onChange})})})})]}),Oe=()=>{const o=Y(),{userRestaurantId:a}=re(),{data:n,isLoading:f}=_({queryKey:["paymentSettings",a],queryFn:()=>pe(a),enabled:!!a}),{data:t,isLoading:g,refetch:J}=_({queryKey:["paymentMethods",a],queryFn:()=>V(a),enabled:!!a}),{data:i,isLoading:j}=_({queryKey:["credentialsStatus"],queryFn:xe}),u=D({resolver:I(le),defaultValues:{mercado_pago_public_key:"",mercado_pago_access_token:"APP_USR-2065423906870531-102020-7f478dfd0d5a75ff13deb0e5548dc1f3-228392372"},mode:"onBlur"});P.useEffect(()=>{n&&u.reset({mercado_pago_public_key:n.mercado_pago_public_key||"",mercado_pago_access_token:"APP_USR-2065423906870531-102020-7f478dfd0d5a75ff13deb0e5548dc1f3-228392372"})},[n,u]);const y=w({mutationFn:async s=>{if(!a)throw new Error("ID do restaurante não disponível.");const c=await x.functions.invoke("save-mp-credentials",{body:JSON.stringify({restaurant_id:a,public_key:s.mercado_pago_public_key,access_token:s.mercado_pago_access_token})});if(c.error)throw new Error(c.error.message);return c.data},onSuccess:s=>{s.token_verified?h.success("Credenciais do Mercado Pago salvas com sucesso!"):h.warning("Atenção!",{description:s.message,duration:15e3}),o.invalidateQueries({queryKey:["paymentSettings",a]}),o.invalidateQueries({queryKey:["credentialsStatus"]})},onError:s=>{h.error(`Erro ao salvar credenciais: ${s.message}`)}}),X=s=>{y.mutate(s)},b=w({mutationFn:async s=>{const c=await V(s),m=new Set(c.map(r=>r.name)),l=he.filter(r=>!m.has(r.name)).map(r=>({restaurant_id:s,name:r.name,description:r.description,icon:r.icon.displayName,is_active:!0}));if(l.length>0){const{error:r}=await x.from("payment_methods").insert(l);if(r)throw new Error(r.message);await J()}},onError:s=>{console.error("Erro ao garantir métodos padrão:",s)}});P.useEffect(()=>{a&&t&&t.length===0&&!g&&b.mutate(a)},[a,t,g,b]);const p=D({resolver:I(ue),defaultValues:{methods:[]},mode:"onBlur"});P.useEffect(()=>{t&&t.length>0&&p.reset({methods:t.map(s=>({id:s.id,is_active:s.is_active??!0}))})},[t,p]);const v=w({mutationFn:async s=>{const c=s.methods.map(r=>x.from("payment_methods").update({is_active:r.is_active}).eq("id",r.id)),l=(await Promise.all(c)).filter(r=>r.error).map(r=>{var L;return(L=r.error)==null?void 0:L.message}).join(", ");if(l)throw new Error(l)},onSuccess:()=>{h.success("Configurações de métodos de pagamento salvas!"),o.invalidateQueries({queryKey:["paymentMethods",a]})},onError:s=>{h.error(`Erro ao salvar métodos: ${s.message}`)}}),W=s=>{v.mutate(s)};if(!a)return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8",children:e.jsxs(N,{className:"max-w-md text-center mx-auto",children:[e.jsx(k,{children:e.jsx(C,{children:"Erro de Configuração"})}),e.jsx(S,{children:e.jsx("p",{className:"text-muted-foreground",children:"ID do restaurante não encontrado. Por favor, recarregue a página."})})]})});const F=f||g;return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-8",children:[e.jsxs(N,{children:[e.jsxs(k,{children:[e.jsx(C,{className:"text-2xl font-bold flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-6 w-6 text-primary"}),"Credenciais Mercado Pago"]})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure suas chaves de API do Mercado Pago para aceitar pagamentos online."})]}),e.jsx(S,{children:F?e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-4 w-1/4"}),e.jsx(d,{className:"h-10 w-full"}),e.jsx(d,{className:"h-4 w-1/4"}),e.jsx(d,{className:"h-10 w-full"}),e.jsx(d,{className:"h-12 w-full mt-4"})]}):e.jsx(R,{...u,children:e.jsxs("form",{onSubmit:u.handleSubmit(X),className:"space-y-6",children:[e.jsxs(oe,{variant:i!=null&&i.configured?"default":"destructive",children:[j?e.jsx(ae,{className:"h-4 w-4 animate-spin"}):i!=null&&i.configured?e.jsx(ie,{className:"h-4 w-4 text-green-500"}):e.jsx(ce,{className:"h-4 w-4"}),e.jsx(te,{children:j?"Verificando Status do Access Token...":i!=null&&i.configured?"Access Token Configurado Corretamente!":"Ação Necessária: Access Token Não Encontrado!"}),e.jsxs(ne,{children:[j?"Aguarde um momento...":i!=null&&i.configured?"O Access Token foi encontrado nos segredos do seu projeto Supabase. O pagamento online deve funcionar.":"O Access Token não foi encontrado ou está vazio nos segredos do seu projeto Supabase. O pagamento online não funcionará até que você o configure.",e.jsxs("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:[e.jsxs("li",{children:[e.jsx("a",{href:"https://www.mercadopago.com.br/developers/panel/credentials",target:"_blank",rel:"noopener noreferrer",className:"font-bold underline",children:"Copie seu Access Token de Produção"})," no painel do Mercado Pago."]}),e.jsxs("li",{children:[e.jsx("a",{href:"https://supabase.com/dashboard/project/vtskautbkbhqwinuassp/settings/functions",target:"_blank",rel:"noopener noreferrer",className:"font-bold underline",children:"Clique aqui para ir aos Segredos do Supabase"})," e salve-o com o nome `MERCADO_PAGO_ACCESS_TOKEN`."]})]})]})]}),e.jsx(q,{control:u.control,name:"mercado_pago_public_key",render:({field:s})=>e.jsxs(M,{children:[e.jsx(B,{children:"Public Key"}),e.jsx(T,{children:e.jsx(O,{...s,placeholder:"APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta chave é pública e pode ser salva aqui."}),e.jsx(Q,{})]})}),e.jsx(q,{control:u.control,name:"mercado_pago_access_token",render:({field:s})=>e.jsxs(M,{children:[e.jsx(B,{children:"Verificar Access Token"}),e.jsx(T,{children:e.jsx(O,{...s,type:"password",placeholder:"Cole seu Access Token aqui para verificar",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este campo serve apenas para **verificar** se o token que você salvou no Supabase está correto. Ele **não** salva o token aqui."}),e.jsx(Q,{})]})}),e.jsx(K,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:y.isPending||!a,children:y.isPending?"Salvando...":"Salvar Chave Pública e Verificar Token"})]})})})]}),e.jsxs(N,{children:[e.jsxs(k,{children:[e.jsx(C,{className:"text-2xl font-bold",children:"Métodos de Pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ative ou desative os métodos de pagamento aceitos pelo seu estabelecimento."})]}),e.jsx(S,{children:F||b.isPending?e.jsxs("div",{className:"space-y-4",children:[[...Array(4)].map((s,c)=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(d,{className:"h-10 w-10 rounded-md"}),e.jsxs("div",{children:[e.jsx(d,{className:"h-4 w-32 mb-1"}),e.jsx(d,{className:"h-3 w-48"})]})]}),e.jsx(d,{className:"h-6 w-10 rounded-full"})]},c)),e.jsx(d,{className:"h-12 w-full mt-4"})]}):e.jsx(R,{...p,children:e.jsxs("form",{onSubmit:p.handleSubmit(W),className:"space-y-4",children:[p.watch("methods").map((s,c)=>{const m=t==null?void 0:t.find(r=>r.id===s.id),l=m!=null&&m.icon?fe(m.icon):$;return e.jsx(ge,{method:m,index:c,control:p.control,icon:l},s.id)}),e.jsx(K,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:v.isPending||!a,children:v.isPending?"Salvando...":"Salvar Configurações"})]})})})]})]})})};export{Oe as default};
