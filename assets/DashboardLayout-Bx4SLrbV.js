import{j as e,a as ee,u as ae,b as fe}from"./tanstack-C7aOFagJ.js";import{i as re,L as pe,r as n,h as xe,O as ge}from"./vendor-DjsPZZVP.js";import{c as P,a as je,S as oe,X as be,aB as ye,aC as ve,B as N,aD as Se,o as we,l as H,s as f,p as Ne,t as Ce,j as d,D as Ee,q as ke,r as Ae,v as Pe,U as F,w as De,F as Te,h as Me,I as G,x as K,y as Q,z as B,A as W,E as X,P as _e,G as qe,L as se,aA as Ie,aE as Le,d as q,O as J,R as Y,V as Z,aF as I,aG as L,aH as R}from"./index-ClKtkaE0.js";import{L as Re}from"./Logo-BXSh51d1.js";import{P as Oe}from"./package-DZ8RdHUk.js";import{C as Fe}from"./credit-card-Dwl5HqJ6.js";import{T as ze}from"./truck-BN0pa_l0.js";import{S as $e}from"./settings-B76RwDMx.js";import{A as Ue,a as Ve,b as He,c as Ge,d as Ke,e as Qe,g as Be}from"./alert-dialog-Be2B2aCy.js";import{S as We}from"./use-sound-BhkF2W4n.js";import{S as A}from"./skeleton-1OpLu_Mt.js";import{M as Xe}from"./mail-o7f5jbCC.js";import{C as O}from"./circle-alert-CXu59xKG.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=P("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=P("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=P("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=P("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ea=P("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),aa=[{href:"/dashboard",label:"Dashboard",icon:Je},{href:"/products",label:"Produtos",icon:Oe},{href:"/orders",label:"Pedidos",icon:oe},{href:"/cashier",label:"Caixa",icon:ea},{href:"/hours",label:"Hor√°rios",icon:be},{href:"/payments",label:"Pagamentos",icon:Fe},{href:"/delivery",label:"Taxa de Entrega",icon:ze},{href:"/settings",label:"Configura√ß√µes",icon:$e}],ne=()=>{const a=re();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(Re,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:aa.map(r=>e.jsx("li",{children:e.jsxs(pe,{to:r.href,className:je("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",a.pathname===r.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(r.icon,{className:"h-4 w-4"}),r.label]})},r.href))})})]})},ra=({isOpen:a,onEnable:r})=>e.jsx(Ue,{open:a,children:e.jsxs(Ve,{children:[e.jsxs(He,{children:[e.jsxs(Ge,{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-6 w-6 text-primary"}),"Ativar Notifica√ß√µes Sonoras?"]}),e.jsxs(Ke,{children:["Para garantir que voc√™ n√£o perca nenhum novo pedido, precisamos da sua permiss√£o para tocar um som de notifica√ß√£o.",e.jsx("br",{}),e.jsx("br",{}),'Ao clicar em "Ativar", um som de teste ser√° reproduzido.']})]}),e.jsx(Qe,{children:e.jsx(Be,{onClick:r,className:"w-full",children:"Sim, ativar som"})})]})}),oa=()=>e.jsxs(ye,{children:[e.jsx(ve,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"icon",children:e.jsx(Ye,{className:"h-4 w-4"})})}),e.jsx(Se,{side:"left",className:"p-0 w-64",children:e.jsx(ne,{})})]}),sa=a=>a.replace(/\D/g,""),ta=we({full_name:H().min(1,"Nome √© obrigat√≥rio."),phone:H().min(1,"Telefone √© obrigat√≥rio.").transform(sa).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."})}),na=async a=>{const{data:r,error:i}=await f.from("profiles").select("*").eq("id",a).limit(1).single();if(i&&i.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${i.message}`);return r||{id:a,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null}},ia=({isOpen:a,onClose:r,userId:i})=>{var l;const S=ee(),{data:j,isLoading:p}=ae({queryKey:["adminProfile",i],queryFn:()=>na(i),enabled:!!i&&a,staleTime:0}),C=(l=f.auth.currentUser)==null?void 0:l.email,c=Ne({resolver:Ce(ta),defaultValues:{full_name:"",phone:""}});n.useEffect(()=>{j&&c.reset({full_name:j.full_name||"",phone:j.phone||""})},[j,c]);const y=fe({mutationFn:async u=>{if(!i)throw new Error("ID do usu√°rio n√£o encontrado.");const T={full_name:u.full_name,phone:u.phone},{error:E}=await f.from("profiles").upsert({...T,id:i},{onConflict:"id"});if(E)throw new Error(E.message)},onSuccess:()=>{d.success("Perfil atualizado com sucesso!"),S.invalidateQueries({queryKey:["adminProfile"]}),r()},onError:u=>{d.error(`Erro ao atualizar perfil: ${u.message}`)}}),t=u=>{y.mutate(u)};return e.jsx(Ee,{open:a,onOpenChange:r,children:e.jsxs(ke,{className:"sm:max-w-[425px]",children:[e.jsxs(Ae,{children:[e.jsxs(Pe,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(De,{children:"Atualize seus dados de contato."})]}),p?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(A,{className:"h-4 w-1/3"}),e.jsx(A,{className:"h-10 w-full"}),e.jsx(A,{className:"h-4 w-1/3"}),e.jsx(A,{className:"h-10 w-full"}),e.jsx(A,{className:"h-10 w-full mt-6"})]}):e.jsx(Te,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(t),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Me,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Xe,{className:"h-4 w-4"})," Email"]}),e.jsx(G,{value:C||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx(K,{control:c.control,name:"full_name",render:({field:u})=>e.jsxs(Q,{children:[e.jsx(B,{children:"Nome Completo *"}),e.jsx(W,{children:e.jsx(G,{placeholder:"Seu nome",...u})}),e.jsx(X,{})]})}),e.jsx(K,{control:c.control,name:"phone",render:({field:u})=>e.jsxs(Q,{children:[e.jsx(B,{children:"Telefone *"}),e.jsx(W,{children:e.jsx(_e,{...u})}),e.jsx(X,{})]})}),e.jsx(qe,{className:"pt-4",children:e.jsxs(N,{type:"submit",disabled:y.isPending,children:[y.isPending?e.jsx(se,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},la=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes",icon:F}],ca=a=>{const r=la.find(i=>i.href===a);return r?r.label:"Dashboard"},da=async a=>{const{data:r,error:i}=await f.from("user_roles").select("role, restaurant_id").eq("user_id",a).limit(1).single();return i&&i.code!=="PGRST116"?(console.error("Error checking role and restaurant:",i),{role:null,restaurantId:null}):r?{role:r.role,restaurantId:r.restaurant_id}:{role:null,restaurantId:null}},ua=()=>{const a=xe(),r=re(),i=ee(),[S,j]=n.useState(null),[p,C]=n.useState(void 0),[c,y]=n.useState(null),t=n.useRef(null),[l,u]=n.useState("loading"),[T,E]=n.useState(!1),[k,M]=n.useState(null);Le();const[ie,z]=n.useState(!1),[m,x]=n.useState(()=>localStorage.getItem("soundNotificationStatus")||"disabled");n.useEffect(()=>{localStorage.setItem("soundNotificationStatus",m)},[m]);const{data:g,isLoading:le,isError:ce,error:$}=ae({queryKey:["dashboardRestaurant",c],queryFn:async()=>{if(!c)throw new Error("Restaurant ID not found for user.");const{data:o,error:h}=await f.from("restaurants").select("*").eq("id",c).single();if(h)throw new Error(h.message);return o},enabled:!!S&&(p==="admin"||p==="moderator")&&!!c,staleTime:1/0}),v=n.useMemo(()=>!(g!=null&&g.notification_sound_url)||g.notification_sound_url.trim()===""?"./default-notification.mp3":g.notification_sound_url,[g==null?void 0:g.notification_sound_url]);n.useEffect(()=>{const o=async s=>{if(!(s!=null&&s.user)){j(null),C(null),y(null),a("/admin-auth",{replace:!0});return}const{role:b,restaurantId:V}=await da(s.user.id);if(j(s.user),C(b),y(V),b==="user"){d.error("Acesso restrito.",{description:"Esta conta √© de cliente e n√£o tem permiss√£o para acessar o painel.",duration:5e3}),await f.auth.signOut();const he=`${window.location.origin}${window.location.pathname}#/`;window.location.href=he;return}b!=="admin"&&b!=="moderator"&&(d.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),a("/admin-auth",{replace:!0})),(b==="admin"||b==="moderator")&&!V&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:h}}=f.auth.onAuthStateChange((s,b)=>{s==="SIGNED_OUT"?(j(null),C(null),y(null),a("/admin-auth",{replace:!0})):o(b)});return f.auth.getSession().then(({data:{session:s}})=>{o(s)}),()=>h.unsubscribe()},[a]),n.useEffect(()=>{var o;v?((o=t.current)==null?void 0:o.src)!==`${window.location.origin}${window.location.pathname}${v}`&&u("loading"):u("error")},[v]),n.useEffect(()=>{!localStorage.getItem("hasSeenSoundPermissionModal")&&m!=="enabled"&&l==="ready"&&E(!0)},[m,l]);const w=n.useCallback(()=>{t.current&&(t.current.pause(),t.current.loop=!1,M(null))},[]),U=n.useCallback(o=>{if(m==="enabled"&&t.current&&l==="ready"){if(k)return;M(o),t.current.loop=!0,t.current.play().catch(h=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",h),M(null),d.warning("N√£o foi poss√≠vel tocar o som automaticamente.",{description:"Interaja com a p√°gina para permitir a reprodu√ß√£o de som."})})}},[m,l,k]);n.useEffect(()=>{if(p!=="admin"&&p!=="moderator"||!c)return;const o=f.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},h=>{i.invalidateQueries({queryKey:["orders"]});const s=h.new;s.status==="pending"&&s.id&&s.restaurant_id===c&&(d.info("üîî Novo pedido recebido!",{description:`Pedido #${s.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),U(s.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},h=>{i.invalidateQueries({queryKey:["orders"]});const s=h.new;s.id===k&&w(),s.status==="pending"&&s.id&&h.old.status==="pending_payment"&&s.restaurant_id===c&&d.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${s.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3})}).subscribe();return()=>{f.removeChannel(o)}},[i,U,w,k,p,c]);const _=n.useCallback(()=>{if(m==="enabled"&&t.current&&l==="ready"){w(),t.current.loop=!1,t.current.currentTime=0;const o=t.current.play();o!==void 0&&o.then(()=>{console.log("Som de teste tocado com sucesso")}).catch(h=>{console.error("Erro ao tocar som de teste:",h),x("error"),d.error("N√£o foi poss√≠vel tocar o som de teste.",{description:"Interaja com a p√°gina para permitir a reprodu√ß√£o de som."})})}else l==="ready"?(x("enabled"),setTimeout(()=>_(),100)):(d.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado.",{description:"Verifique se a URL do som est√° correta nas Configura√ß√µes."}),x("error"))},[m,l,w]),de=async()=>{if(l!=="ready"||!t.current){d.error("O arquivo de som ainda n√£o est√° pronto. Tente novamente em um momento.");return}try{t.current.currentTime=0,await t.current.play(),x("enabled"),d.success("Notifica√ß√µes sonoras ativadas!"),localStorage.setItem("hasSeenSoundPermissionModal","true")}catch(o){console.error("Audio activation failed from modal:",o),d.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado a reprodu√ß√£o. Por favor, tente ativar manualmente no √≠cone do cabe√ßalho."}),x("error")}finally{E(!1)}},ue=async()=>{if(m==="enabled"){w(),x("disabled"),d.info("Notifica√ß√µes sonoras desativadas.");return}if(l!=="ready"||!t.current){d.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado."),x("error");return}try{t.current.currentTime=0,await t.current.play(),x("enabled"),d.success("Notifica√ß√µes sonoras ativadas!",{description:"Voc√™ ouviu o som de teste."})}catch(o){console.error("Audio activation failed:",o),d.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado. Clique na p√°gina e tente novamente."}),x("error")}},me=async()=>{await f.auth.signOut()};if(p===void 0||le)return e.jsx(q,{});if(p!=="admin"&&p!=="moderator")return e.jsx(q,{});if(!c)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(J,{variant:"destructive",className:"max-w-md",children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Configura√ß√£o"}),e.jsx(Z,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})});if(ce)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(J,{variant:"destructive",className:"max-w-md",children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro ao Carregar Restaurante"}),e.jsx(Z,{children:$ instanceof Error?$.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})});if(!g)return e.jsx(q,{});const D=l!=="ready";return e.jsxs(We.Provider,{value:{playSound:_,stopSoundLoop:w,soundStatus:m,loopingOrderId:k},children:[e.jsx(ra,{isOpen:T,onEnable:de}),e.jsx(ia,{isOpen:ie,onClose:()=>z(!1),userId:(S==null?void 0:S.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(ne,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(oa,{})}),e.jsx(oe,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:ca(r.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(I,{children:[e.jsx(L,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"icon",onClick:()=>z(!0),"aria-label":"Meu Perfil",children:e.jsx(F,{className:"h-4 w-4"})})}),e.jsx(R,{children:"Meu Perfil"})]}),e.jsxs(I,{children:[e.jsx(L,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"sm",onClick:_,disabled:D,children:"Testar Som"})}),D&&e.jsx(R,{children:l==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsxs(I,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"icon",onClick:ue,disabled:D,"aria-label":m==="enabled"?"Desativar som":"Ativar som",children:[l==="loading"&&e.jsx(se,{className:"h-4 w-4 animate-spin"}),l==="ready"&&m==="enabled"&&e.jsx(te,{className:"h-4 w-4 text-green-500"}),l==="ready"&&m==="disabled"&&e.jsx(Ze,{className:"h-4 w-4"}),l==="error"&&e.jsx(O,{className:"h-4 w-4 text-destructive"})]})}),D&&e.jsx(R,{children:l==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsx(N,{variant:"outline",onClick:me,children:"Sair"})]})]})}),e.jsx(ge,{context:{restaurant:g,userRestaurantId:c}})]}),v&&e.jsx("audio",{ref:t,src:v.startsWith("http")?v:`${window.location.origin}${window.location.pathname}${v}`,onCanPlayThrough:()=>{u("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:o=>{console.error("Erro ao carregar o √°udio:",o),d.error("Erro ao carregar o som de notifica√ß√£o.",{description:"Verifique o arquivo em Configura√ß√µes."}),u("error"),x("error")},className:"hidden"})]})]})},Ea=n.memo(ua);export{Ea as default};
