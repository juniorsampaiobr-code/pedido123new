import{j as e,b as Ks,u as ae,c as Zs}from"./tanstack-D8i8yNxB.js";import{r as i,u as Js,h as Hs,R as Qs,L as Qe}from"./vendor-Dl0Wzy4_.js";import{o as Ws,s as O,l as Xs,e as Ys,p as Pe,c as We,n as er,Z as z,u as sr,t as rr}from"./types-BCrSgEF3.js";import{s as k}from"./client-BmrnLCXS.js";import{c as rs,f as ke,g as ye,P as J,i as ge,h as ts,l as tr,m as os,b as Le,n as or,k as ar,a as as,v as Xe,L as Ye}from"./index-kDOyPY_s.js";import{B as W}from"./button-CbXNCyer.js";import{C as ie,b as le,c as ce,a as de}from"./card-CyhgOrbK.js";import{I as U}from"./label-ONUJAvEu.js";import{c as ns,R as nr,I as ir,a as lr,C as cr}from"./index-BgutmGd9.js";import{u as dr}from"./index-NAL-Klci.js";import{u as ur}from"./index-PuW-_iwo.js";import{S as ue}from"./separator-qtg-RHWo.js";import{T as mr}from"./textarea-Cu9y9Nzt.js";import{A as X,a as Y,b as ee}from"./alert-C6c_ctP1.js";import{F as pr,b as I,c as _,a as E,e as V,d as ne}from"./form-Bzd16A-m.js";import{P as hr}from"./PhoneInput-BRz6FyC9.js";import{Z as fr,M as xr}from"./MapLocationSection-Cb9iDQnT.js";import{C as gr,U as yr,S as jr,a as br}from"./CustomerProfileModal-C-0Q8RgU.js";import{S as vr}from"./shopping-cart-cdG7Gyjm.js";import{T as Se}from"./terminal-Cx6fF5ok.js";import{A as Nr}from"./arrow-left-BflEg-TC.js";import{T as es}from"./truck-BGi-iuKS.js";import{S as is,a as Cr}from"./store-CbajvsSR.js";import{M as ss}from"./map-pin-DIa4GkMM.js";import{P as _r}from"./package-DdImqB_1.js";import{C as wr}from"./credit-card-2-kkMA70.js";import{D as Rr}from"./dollar-sign-aSzNpln0.js";import"./supabase-A1WgB1xz.js";import"./index-K-uyLffD.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Er=rs("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pr=rs("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var Oe="Radio",[Sr,ls]=ke(Oe),[Ir,Vr]=Sr(Oe),cs=i.forwardRef((r,o)=>{const{__scopeRadio:a,name:c,checked:n=!1,required:l,disabled:p,value:m="on",onCheck:g,form:x,...y}=r,[v,j]=i.useState(null),f=ye(o,F=>j(F)),R=i.useRef(!1),N=v?x||!!v.closest("form"):!0;return e.jsxs(Ir,{scope:a,checked:n,disabled:p,children:[e.jsx(J.button,{type:"button",role:"radio","aria-checked":n,"data-state":ps(n),"data-disabled":p?"":void 0,disabled:p,value:m,...y,ref:f,onClick:ge(r.onClick,F=>{n||g==null||g(),N&&(R.current=F.isPropagationStopped(),R.current||F.stopPropagation())})}),N&&e.jsx(ms,{control:v,bubbles:!R.current,name:c,value:m,checked:n,required:l,disabled:p,form:x,style:{transform:"translateX(-100%)"}})]})});cs.displayName=Oe;var ds="RadioIndicator",us=i.forwardRef((r,o)=>{const{__scopeRadio:a,forceMount:c,...n}=r,l=Vr(ds,a);return e.jsx(ts,{present:c||l.checked,children:e.jsx(J.span,{"data-state":ps(l.checked),"data-disabled":l.disabled?"":void 0,...n,ref:o})})});us.displayName=ds;var Fr="RadioBubbleInput",ms=i.forwardRef(({__scopeRadio:r,control:o,checked:a,bubbles:c=!0,...n},l)=>{const p=i.useRef(null),m=ye(p,l),g=ur(a),x=tr(o);return i.useEffect(()=>{const y=p.current;if(!y)return;const v=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(v,"checked").set;if(g!==a&&f){const R=new Event("click",{bubbles:c});f.call(y,a),y.dispatchEvent(R)}},[g,a,c]),e.jsx(J.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...n,tabIndex:-1,ref:m,style:{...n.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ms.displayName=Fr;function ps(r){return r?"checked":"unchecked"}var kr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],je="RadioGroup",[Lr,Lt]=ke(je,[ns,ls]),hs=ns(),fs=ls(),[Or,Tr]=Lr(je),xs=i.forwardRef((r,o)=>{const{__scopeRadioGroup:a,name:c,defaultValue:n,value:l,required:p=!1,disabled:m=!1,orientation:g,dir:x,loop:y=!0,onValueChange:v,...j}=r,f=hs(a),R=dr(x),[N,F]=os({prop:l,defaultProp:n??null,onChange:v,caller:je});return e.jsx(Or,{scope:a,name:c,required:p,disabled:m,value:N,onValueChange:F,children:e.jsx(nr,{asChild:!0,...f,orientation:g,dir:R,loop:y,children:e.jsx(J.div,{role:"radiogroup","aria-required":p,"aria-orientation":g,"data-disabled":m?"":void 0,dir:R,...j,ref:o})})})});xs.displayName=je;var gs="RadioGroupItem",ys=i.forwardRef((r,o)=>{const{__scopeRadioGroup:a,disabled:c,...n}=r,l=Tr(gs,a),p=l.disabled||c,m=hs(a),g=fs(a),x=i.useRef(null),y=ye(o,x),v=l.value===n.value,j=i.useRef(!1);return i.useEffect(()=>{const f=N=>{kr.includes(N.key)&&(j.current=!0)},R=()=>j.current=!1;return document.addEventListener("keydown",f),document.addEventListener("keyup",R),()=>{document.removeEventListener("keydown",f),document.removeEventListener("keyup",R)}},[]),e.jsx(ir,{asChild:!0,...m,focusable:!p,active:v,children:e.jsx(cs,{disabled:p,required:l.required,checked:v,...g,...n,name:l.name,ref:y,onCheck:()=>l.onValueChange(n.value),onKeyDown:ge(f=>{f.key==="Enter"&&f.preventDefault()}),onFocus:ge(n.onFocus,()=>{var f;j.current&&((f=x.current)==null||f.click())})})})});ys.displayName=gs;var Ar="RadioGroupIndicator",js=i.forwardRef((r,o)=>{const{__scopeRadioGroup:a,...c}=r,n=fs(a);return e.jsx(us,{...n,...c,ref:o})});js.displayName=Ar;var bs=xs,vs=ys,Dr=js;const Ie=i.forwardRef(({className:r,...o},a)=>e.jsx(bs,{className:Le("grid gap-2",r),...o,ref:a}));Ie.displayName=bs.displayName;const xe=i.forwardRef(({className:r,...o},a)=>e.jsx(vs,{ref:a,className:Le("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...o,children:e.jsx(Dr,{className:"flex items-center justify-center",children:e.jsx(Er,{className:"h-2.5 w-2.5 fill-current text-current"})})}));xe.displayName=vs.displayName;const Mr=(r,o,a,c)=>{const l=(a-r)*(Math.PI/180),p=(c-o)*(Math.PI/180),m=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r*(Math.PI/180))*Math.cos(a*(Math.PI/180))*Math.sin(p/2)*Math.sin(p/2);return 6371*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))},qr=async r=>{const o=r.replace(/\s+/g," ").trim(),a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&limit=1`,c=new AbortController,n=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",a);const l=await fetch(a,{signal:c.signal});if(!l.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",l.status),null;const p=await l.json();if(p&&Array.isArray(p)&&p.length>0){const m=p[0],g=parseFloat(m.lat),x=parseFloat(m.lon);if(Number.isFinite(g)&&Number.isFinite(x))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[g,x]),{lat:g,lng:x}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",o),null}catch(l){return l instanceof Error&&l.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",o):console.error("LOG: geocodeAddress - Erro durante a requisição:",l),null}finally{clearTimeout(n)}},$r=(r,o,a)=>{const c=Mr(o[0],o[1],r[0],r[1]),n=a.find(l=>c<=l.max_distance_km);if(n){const l=n.delivery_fee||0,p=n.min_delivery_time_minutes||0,m=p+15;return{fee:parseFloat(l.toFixed(2)),minTime:p,maxTime:m}}return null};var be="Collapsible",[Gr,Ot]=ke(be),[Br,Te]=Gr(be),Ns=i.forwardRef((r,o)=>{const{__scopeCollapsible:a,open:c,defaultOpen:n,disabled:l,onOpenChange:p,...m}=r,[g,x]=os({prop:c,defaultProp:n??!1,onChange:p,caller:be});return e.jsx(Br,{scope:a,disabled:l,contentId:or(),open:g,onOpenToggle:i.useCallback(()=>x(y=>!y),[x]),children:e.jsx(J.div,{"data-state":De(g),"data-disabled":l?"":void 0,...m,ref:o})})});Ns.displayName=be;var Cs="CollapsibleTrigger",_s=i.forwardRef((r,o)=>{const{__scopeCollapsible:a,...c}=r,n=Te(Cs,a);return e.jsx(J.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":De(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...c,ref:o,onClick:ge(r.onClick,n.onOpenToggle)})});_s.displayName=Cs;var Ae="CollapsibleContent",ws=i.forwardRef((r,o)=>{const{forceMount:a,...c}=r,n=Te(Ae,r.__scopeCollapsible);return e.jsx(ts,{present:a||n.open,children:({present:l})=>e.jsx(zr,{...c,ref:o,present:l})})});ws.displayName=Ae;var zr=i.forwardRef((r,o)=>{const{__scopeCollapsible:a,present:c,children:n,...l}=r,p=Te(Ae,a),[m,g]=i.useState(c),x=i.useRef(null),y=ye(o,x),v=i.useRef(0),j=v.current,f=i.useRef(0),R=f.current,N=p.open||m,F=i.useRef(N),M=i.useRef(void 0);return i.useEffect(()=>{const C=requestAnimationFrame(()=>F.current=!1);return()=>cancelAnimationFrame(C)},[]),ar(()=>{const C=x.current;if(C){M.current=M.current||{transitionDuration:C.style.transitionDuration,animationName:C.style.animationName},C.style.transitionDuration="0s",C.style.animationName="none";const K=C.getBoundingClientRect();v.current=K.height,f.current=K.width,F.current||(C.style.transitionDuration=M.current.transitionDuration,C.style.animationName=M.current.animationName),g(c)}},[p.open,c]),e.jsx(J.div,{"data-state":De(p.open),"data-disabled":p.disabled?"":void 0,id:p.contentId,hidden:!N,...l,ref:y,style:{"--radix-collapsible-content-height":j?`${j}px`:void 0,"--radix-collapsible-content-width":R?`${R}px`:void 0,...r.style},children:N&&n})});function De(r){return r?"open":"closed"}var Ur=Ns;const Kr=Ur,Zr=_s,Jr=ws,Hr=()=>{const{items:r,subtotal:o,deliveryFee:a,total:c,totalItems:n}=as(),[l,p]=i.useState(!1);return n===0?null:e.jsxs(Kr,{open:l,onOpenChange:p,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Zr,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vr,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)}),l?e.jsx(lr,{className:"h-5 w-5"}):e.jsx(cr,{className:"h-5 w-5"})]})]})}),e.jsxs(Jr,{className:"p-4 pt-0",children:[e.jsx(ue,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:r.map(m=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[m.quantity,"x ",m.name,m.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",m.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m.price*m.quantity)})]},m.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)})]})]})]})]})},Ve=r=>r.replace(/\D/g,""),Rs=r=>r.replace(/\D/g,""),Fe=r=>r.replace(/\D/g,""),Qr=Ws({name:O().min(1,"Nome é obrigatório."),phone:O().min(1,"Telefone é obrigatório.").transform(Ve).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:O().email("Email inválido.").optional().or(Xs("")),delivery_option:Ys(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:O().optional().default(""),number:O().optional().default(""),complement:O().optional().default(""),neighborhood:O().optional().default(""),city:O().optional().default(""),zip_code:O().optional().default("").transform(Rs).refine(r=>r.length===8||r.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Pe(r=>typeof r=="string"?parseFloat(r):r,We.number().optional().nullable()),longitude:Pe(r=>typeof r=="string"?parseFloat(r):r,We.number().optional().nullable()),payment_method_id:O().min(1,"Selecione uma forma de pagamento."),notes:O().optional(),cpf_cnpj:O().optional().default("").transform(Fe).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Pe(r=>{if(r==null||r==="")return null;const o=String(r).replace(",","."),a=parseFloat(o);return isNaN(a)?o:a},er({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((r,o)=>{if(r.delivery_option==="delivery"?(r.street.trim()===""&&o.addIssue({code:z.custom,message:"Rua é obrigatória.",path:["street"]}),r.number.trim()===""&&o.addIssue({code:z.custom,message:"Número é obrigatório.",path:["number"]}),r.neighborhood.trim()===""&&o.addIssue({code:z.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),r.city.trim()===""&&o.addIssue({code:z.custom,message:"Cidade é obrigatória.",path:["city"]}),r.zip_code.length!==8&&o.addIssue({code:z.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(r.latitude===null||r.longitude===null)&&o.addIssue({code:z.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})):r.latitude!==null||r.longitude,r.payment_method_id==="Dinheiro"&&r.change_for!==null&&r.change_for!==void 0&&r.change_for<=0&&o.addIssue({code:z.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),r.payment_method_id==="Pagamento online: Pix/Cartão"){const n=Fe(r.cpf_cnpj||"");n.length!==11&&n.length!==14&&o.addIssue({code:z.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Wr=()=>{const r=window.location.origin,a=window.location.pathname.split("/")[1];return a?`${r}/${a}`:r},Xr=async()=>{const{data:r,error:o}=await k.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(o)throw new Error(`Erro ao buscar restaurante: ${o.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},Yr=async r=>{const{data:o,error:a}=await k.from("restaurants").select("delivery_enabled").eq("id",r).single();if(a)throw new Error(`Erro ao buscar status de entrega: ${a.message}`);return o.delivery_enabled??!0},et=async r=>{const{data:o,error:a}=await k.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(a)throw new Error(`Erro ao buscar métodos de pagamento: ${a.message}`);return o},st=async r=>{const{data:o,error:a}=await k.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return o},rt=async()=>{const{data:{user:r}}=await k.auth.getUser();if(!r)return null;const{data:o,error:a}=await k.from("customers").select("*").eq("user_id",r.id).limit(1).single();if(a&&a.code!=="PGRST116")throw new Error(`Erro ao buscar dados do cliente: ${a.message}`);if(o)return o;const c=r.user_metadata;return{id:r.id,user_id:r.id,name:c.full_name||"",phone:c.phone||"",email:r.email||"",address:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),latitude:null,longitude:null,cpf_cnpj:null}},tt=r=>{switch(r){case"DollarSign":return Rr;case"Smartphone":return Cr;case"CreditCard":return wr;case"Package":return _r;default:return is}},ot=({subtotal:r,deliveryFee:o,total:a,items:c})=>e.jsxs(ie,{className:"sticky top-4",children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(de,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]})]})]}),Tt=()=>{const r=Wr(),o=Js();Ks();const a=as(),{items:c,subtotal:n,deliveryFee:l,total:p,setDeliveryFee:m,clearCart:g}=a,[x]=Hs(),[y,v]=i.useState(!1),[j,f]=i.useState(null),[R,N]=i.useState(null),[F,M]=i.useState(null),C=Qs.useRef(!1),[K,Me]=i.useState(!1),[Es,qe]=i.useState(!1),se=x.get("status"),ve=x.get("external_reference"),$e=x.has("collection_id")||x.has("external_reference");i.useEffect(()=>{if(ve)if(se==="approved"||se==="failure"||se==="pending"){o(`/order-success/${ve}?status=${se}`,{replace:!0});return}else $e&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Me(!1));else Me(!1)},[ve,se,$e,o]);const{data:u,isLoading:Ps,isError:Ss,error:Is}=ae({queryKey:["checkoutRestaurantData"],queryFn:Xr}),{data:q,isLoading:Ne}=ae({queryKey:["deliveryStatus",u==null?void 0:u.id],queryFn:()=>Yr(u.id),enabled:!!(u!=null&&u.id)}),{data:H=[],isLoading:Vs}=ae({queryKey:["checkoutPaymentMethods",u==null?void 0:u.id],queryFn:()=>et(u.id),enabled:!!(u!=null&&u.id)}),{data:Ge=[],isLoading:Fs}=ae({queryKey:["checkoutDeliveryZones",u==null?void 0:u.id],queryFn:()=>st(u.id),enabled:!!(u!=null&&u.id)}),{data:$,isLoading:ks}=ae({queryKey:["checkoutCustomerData"],queryFn:rt,staleTime:0}),Ls=Ps||Ne||Vs||Fs||ks,Os=Ss,Be=Is,t=sr({resolver:rr(Qr),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"});i.useEffect(()=>{if($){const s=Ve($.phone||""),d=localStorage.getItem("checkoutFormData");let h={};if(d)try{h=JSON.parse(d)}catch(b){console.error("Failed to parse local storage data",b)}t.reset({...t.getValues(),...h,name:$.name||"",phone:s,email:$.email||"",cpf_cnpj:$.cpf_cnpj||""})}},[$,t]);const D=t.watch("delivery_option"),Ce=t.watch("payment_method_id"),Q=H.find(s=>s.id===Ce),me=(Q==null?void 0:Q.name)==="Pagamento online: Pix/Cartão",pe=(Q==null?void 0:Q.name)==="Dinheiro",P=t.watch("latitude"),S=t.watch("longitude");t.watch(["street","number","neighborhood","city","zip_code"]);const G=D==="delivery",Ts=i.useMemo(()=>JSON.stringify({deliveryOption:D,deliveryEnabled:q,lat:P,lng:S}),[D,q,P,S]),As=i.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:u!=null&&u.latitude&&(u!=null&&u.longitude)?[u.latitude,u.longitude]:[-23.55052,-46.633308],[P,S,u]),Ds=i.useMemo(()=>P===null||S===null?`map-${D}-null`:`map-${D}-${P.toFixed(6)}-${S.toFixed(6)}`,[G,D,P,S]),_e=i.useCallback(s=>{const d=s.road||s.logradouro||"",h=s.house_number||"",b=s.suburb||s.bairro||"",w=s.city||s.localidade||"",B=s.postcode||s.cep||"";t.setValue("street",d,{shouldValidate:!0}),t.setValue("number",h||"",{shouldValidate:!0}),t.setValue("complement",s.suburb||"",{shouldValidate:!0}),t.setValue("neighborhood",b,{shouldValidate:!0}),t.setValue("city",w,{shouldValidate:!0}),t.setValue("zip_code",B,{shouldValidate:!0})},[t]),Ms=i.useCallback(async(s,d)=>{t.setValue("latitude",s,{shouldValidate:!0}),t.setValue("longitude",d,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${d}&addressdetails=1`,b=await fetch(h);if(b.ok){const w=await b.json();w.address&&_e(w.address)}},[t,_e]),qs=i.useCallback(()=>{t.setValue("street","",{shouldValidate:!0}),t.setValue("number","",{shouldValidate:!0}),t.setValue("complement","",{shouldValidate:!0}),t.setValue("neighborhood","",{shouldValidate:!0}),t.setValue("city","",{shouldValidate:!0}),t.setValue("zip_code","",{shouldValidate:!0}),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),m(0),f(null),N(null),localStorage.removeItem("checkoutFormData")},[t,m]),we=i.useCallback(s=>{try{const d={name:s.name,phone:s.phone,email:s.email,delivery_option:s.delivery_option,street:s.street,number:s.number,complement:s.complement,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code,latitude:s.latitude,longitude:s.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(d))}catch(d){console.error("Failed to save form data to local storage",d)}},[]),ze=i.useCallback(()=>{try{const s=localStorage.getItem("checkoutFormData");if(s){const d=JSON.parse(s);t.reset({...t.getValues(),...d,delivery_option:d.delivery_option||"delivery"})}}catch(s){console.error("Failed to load form data from local storage",s)}},[t]);i.useEffect(()=>{ze()},[ze]),i.useEffect(()=>{const s=t.watch(d=>{we(d)});return()=>s.unsubscribe()},[t,we]);const $s=()=>{C.current||(M(null),C.current=!0,Promise.resolve().then(async()=>{try{const s=t.getValues(),[d,h,b,w,B]=[s.street,s.number,s.neighborhood,s.city,s.zip_code],te=Rs(B);if(!(d&&h&&b&&w&&te.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),t.trigger(["street","number","neighborhood","city","zip_code"]),C.current=!1;return}console.log("LOG: Iniciando geocodificação para:",`${d}, ${h}, ${b}, ${w}, ${B}`);const fe=`${d}, ${h}, ${b}, ${w}, ${B}`,Z=await qr(fe);Z?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",Z),t.setValue("latitude",Z.lat,{shouldValidate:!0}),t.setValue("longitude",Z.lng,{shouldValidate:!0}),we(t.getValues())):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),setTimeout(()=>{M("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0})},100))}catch(s){console.error("LOG: Erro capturado durante a geocodificação:",s),setTimeout(()=>{M("Erro ao buscar coordenadas. Verifique sua conexão ou tente novamente."),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0})},100)}finally{C.current=!1}}).catch(s=>{console.error("LOG: Erro nao capturado:",s),C.current=!1}))};i.useEffect(()=>{pe||t.setValue("change_for",null,{shouldValidate:!0})},[pe,t]),i.useEffect(()=>{D==="pickup"&&(m(0),f(null),N(null),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}))},[D,G,t,m,P,S]),i.useEffect(()=>{H.length>0&&!Ce&&t.setValue("payment_method_id",H[0].id)},[H,Ce,t]),i.useEffect(()=>{me?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},[me,t]),i.useEffect(()=>{const s=async()=>{if(D==="pickup"||!(u!=null&&u.latitude)||!(u!=null&&u.longitude)){m(0),f(null),N(null);return}if(Ne)return;if(q===!1){m(0),f(null),N(null),v(!1);return}v(!0),f(null);let h=null;if(P&&S)h=[P,S];else{m(0),N(null),v(!1);return}if(h){const b=[u.latitude,u.longitude],w=$r(h,b,Ge);w?(m(w.fee),f(null),N({minTime:w.minTime,maxTime:w.maxTime})):(m(0),f("Seu endereço está fora da nossa área de entrega."),N(null))}v(!1)},d=setTimeout(()=>{s()},500);return()=>clearTimeout(d)},[Ts,u,Ge,t,m,G,P,S,q,Ne]);const re=Zs({mutationFn:async s=>{if(!u)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&j)throw new Error(j);const d=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),h=s.delivery_option==="delivery"?d:"Retirada no Local";let b;const w=Ve(s.phone),B=Fe(s.cpf_cnpj||""),{data:{user:te}}=await k.auth.getUser(),he=(te==null?void 0:te.id)||null;if(!he)throw new Error("Autenticação necessária. Por favor, faça login para finalizar o pedido.");const{data:fe}=await k.from("customers").select("id, user_id, name, cpf_cnpj").eq("user_id",he).limit(1).single();if(fe){b=fe.id;const L={name:s.name,phone:w,email:s.email||null,cpf_cnpj:B||null},{error:A}=await k.from("customers").update(L).eq("id",b);if(A)throw new Error(`Erro ao atualizar cliente existente: ${A.message}`)}else{const L={name:s.name,phone:w,email:s.email||null,address:h,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:B||null,user_id:he},{data:A,error:T}=await k.from("customers").insert(L).select("id").single();if(T)throw new Error(`Erro ao criar cliente: ${T.message}`);b=A.id}const Z=me?"pending_payment":"pending",{data:Ee,error:Ze}=await k.from("orders").insert({restaurant_id:u.id,customer_id:b,status:Z,total_amount:p,delivery_fee:l,notes:s.notes,delivery_address:h,payment_method_id:s.payment_method_id,change_for:pe?s.change_for:null}).select("id").single();if(Ze)throw new Error(`Erro ao criar pedido: ${Ze.message}`);const Us=c.map(L=>{const A=Number(L.quantity),T=Number(L.price),oe={order_id:Ee.id,product_id:L.product_id,quantity:A,unit_price:T,subtotal:A*T};return L.notes&&L.notes.trim()&&(oe.notes=L.notes.trim()),oe}),{error:Je}=await k.from("order_items").insert(Us);if(Je){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Je);const L=c.map(T=>{const oe=Number(T.quantity),He=Number(T.price);return{order_id:Ee.id,quantity:oe,unit_price:He,subtotal:oe*He,notes:T.notes&&T.notes.trim()?T.notes.trim():null}}),{error:A}=await k.from("order_items").insert(L);if(A)throw new Error(`Erro ao adicionar itens do pedido: ${A.message}`)}return{orderId:Ee.id,orderStatus:Z}},onSuccess:s=>{g();const d=s.orderStatus==="pending_payment"?`/payment/${s.orderId}`:`/order-success/${s.orderId}`,h=`${r}/#${d}`;console.log("LOG: Redirecionamento FORÇADO para:",h),window.location.href=h},onError:s=>{console.error("LOG: Erro ao processar pedido:",s),alert(`Falha ao finalizar pedido: ${s.message}. Verifique o console para mais detalhes.`)}}),Gs=async s=>{if(!await t.trigger()){Ue(t.formState.errors);return}if(s.delivery_option==="delivery"&&j){alert(`Não é possível finalizar o pedido: ${j}`);return}re.mutate(s)},Ue=s=>{var h;console.error("Validation errors:",s);const d=Object.keys(s)[0];d&&console.error("LOG: Erro de validação:",((h=s[d])==null?void 0:h.message)||"Preencha todos os campos obrigatórios.")},Ke=re.isPending||y,Bs=!G||!j&&l>=0,Re=!G||P!==null&&S!==null,zs=!Ke&&Bs&&Re;return i.useEffect(()=>{if(c.length===0&&!re.isPending&&!K){const s=setTimeout(()=>{o("/menu",{replace:!0})},100);return()=>clearTimeout(s)}},[c.length,re.isPending,K,o]),c.length===0&&!re.isPending&&!K?e.jsx(Xe,{}):Ls||K?e.jsx(Xe,{}):Os?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(X,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Conexão"}),e.jsx(ee,{children:Be instanceof Error?Be.message:"Não foi possível carregar os dados."})]})}):e.jsxs(e.Fragment,{children:[e.jsx(gr,{isOpen:Es,onClose:()=>qe(!1),customer:$}),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Qe,{to:"/menu",children:e.jsx(W,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(Nr,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]}),$&&e.jsx(W,{variant:"outline",size:"icon",onClick:()=>qe(!0),"aria-label":"Editar Perfil",children:e.jsx(yr,{className:"h-5 w-5"})})]})}),e.jsx("div",{children:e.jsx(Hr,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(pr,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(Gs,Ue),className:"space-y-6",children:[e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"name",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Nome Completo *"}),e.jsx(U,{placeholder:"Seu nome",...s}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"phone",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Telefone *"}),e.jsx(hr,{...s}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"email",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Email (Opcional)"}),e.jsx(U,{placeholder:"seu@email.com",...s}),e.jsx(V,{})]})})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"delivery_option",render:({field:s})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsxs(Ie,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:"delivery"})}),e.jsx(es,{className:"h-5 w-5 text-primary"}),e.jsxs(E,{className:Le("font-normal flex-1 cursor-pointer"),children:["Delivery",q===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:"pickup"})}),e.jsx(is,{className:"h-5 w-5 text-primary"}),e.jsx(E,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(V,{})]})}),G&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(ss,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(W,{type:"button",variant:"outline",size:"sm",onClick:s=>{s.preventDefault(),$s()},disabled:y||C.current,children:[e.jsx(jr,{className:"h-4 w-4 mr-2"})," ",y||C.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(W,{type:"button",variant:"outline",size:"sm",onClick:qs,children:[e.jsx(Pr,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:t.control,name:"street",render:({field:s})=>e.jsxs(_,{className:"col-span-2",children:[e.jsx(E,{children:"Rua *"}),e.jsx(U,{...s}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"number",render:({field:s})=>e.jsxs(_,{className:"col-span-1",children:[e.jsx(E,{children:"Número *"}),e.jsx(U,{...s}),e.jsx(V,{})]})})]}),e.jsx(I,{control:t.control,name:"complement",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Complemento (Opcional)"}),e.jsx(U,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"neighborhood",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Bairro *"}),e.jsx(U,{...s}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"city",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Cidade *"}),e.jsx(U,{...s}),e.jsx(V,{})]})})]}),e.jsx(I,{control:t.control,name:"zip_code",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"CEP *"}),e.jsx(fr,{...s}),e.jsx(V,{})]})}),G&&Re&&e.jsx("div",{children:e.jsx(xr,{mapKey:Ds,markerPosition:As,onLocationChange:Ms,updateAddressFields:_e,restaurant:u})}),y&&q!==!1&&e.jsxs(X,{children:[e.jsx(Ye,{className:"h-4 w-4 animate-spin"}),e.jsx(Y,{children:"Calculando Taxa..."}),e.jsx(ee,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),j&&q!==!1&&e.jsxs(X,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Entrega"}),e.jsx(ee,{children:j})]}),l>0&&!y&&q!==!1&&e.jsxs(X,{className:"mt-4",children:[e.jsx(es,{className:"h-4 w-4"}),e.jsx(Y,{children:"Taxa de Entrega Aplicada"}),e.jsxs(ee,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)]})]}),F&&e.jsxs(X,{variant:"destructive",className:"mt-4",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro ao Buscar Endereço"}),e.jsx(ee,{children:F})]}),G&&!Re&&!F&&e.jsxs(X,{variant:"destructive",children:[e.jsx(ss,{className:"h-4 w-4"}),e.jsx(Y,{children:"Localização Obrigatória"}),e.jsx(ee,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"payment_method_id",render:({field:s})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsx(Ie,{onValueChange:d=>{s.onChange(d);const h=H.find(b=>b.id===d);(h==null?void 0:h.name)!=="Dinheiro"&&t.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:H.map(d=>{const h=tt(d.icon||"Store");return e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:d.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(E,{className:"font-normal cursor-pointer",children:d.name}),d.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d.description})]})]},d.id)})})}),e.jsx(V,{})]})}),pe&&e.jsx(I,{control:t.control,name:"change_for",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Troco para (Opcional)"}),e.jsx(U,{type:"number",placeholder:"Ex: 50.00",...s,value:s.value||"",onChange:d=>s.onChange(d.target.value?parseFloat(d.target.value):null)}),e.jsx(V,{})]})}),me&&e.jsx(I,{control:t.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"CPF/CNPJ *"}),e.jsx(br,{...s}),e.jsx(V,{})]})})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"4. Observações"})}),e.jsx(de,{children:e.jsx(I,{control:t.control,name:"notes",render:({field:s})=>e.jsxs(_,{children:[e.jsx(E,{children:"Observações do Pedido (Opcional)"}),e.jsx(mr,{placeholder:"Ex: Sem cebola, sem alface...",...s}),e.jsx(V,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Qe,{to:"/menu",className:"flex-1",children:e.jsx(W,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(W,{type:"submit",className:"flex-1",disabled:!zs,size:"lg",children:Ke?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(ot,{subtotal:n,deliveryFee:l,total:p,items:c})})]})]})]})]})};export{Tt as default};
