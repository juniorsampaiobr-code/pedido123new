import{r as d,j as e,e as te,a as N,L as ie}from"./index-zkuE9Bm6.js";import{u as P}from"./useQuery-Bop5DQT3.js";import{u as le}from"./useMutation-DTwKCpeC.js";import{o as X,s as B,p as z,c as D,a as ce,u as de,d as me,t as ue}from"./types-BjVHfDxe.js";import{s as $}from"./client-g0uDe16g.js";import{B as q}from"./button-3xZnEy7f.js";import{C as K,b as U,c as Q,a as V}from"./card-B1F0wEox.js";import{I as k}from"./label-CD9lqJez.js";import{S as A}from"./skeleton-CBZEqJVS.js";import{A as H,a as W,b as G,T as pe}from"./alert-B4s-E96m.js";import{F as ge,b as E,c as L,a as Z,d as T,e as M}from"./form-gGgYvqwv.js";import{d as fe,l as Y,e as ee,f as he,g as xe,L as O,i as ve,a as je,M as _e,T as ye,b as ae,u as be,c as Ce}from"./marker-shadow-ClPBKzxz.js";import{S as we}from"./settings-CtP3JrMo.js";import{T as Ne}from"./trash-2-D85A2LkQ.js";import{P as ke}from"./plus-Ce2zFMKs.js";function Ee(r,a,i){a.center!==i.center&&r.setLatLng(a.center),a.radius!=null&&a.radius!==i.radius&&r.setRadius(a.radius)}const Le=fe(function({center:a,children:i,...m},h){const u=new Y.Circle(a,m);return ee(u,he(h,{overlayContainer:u}))},Ee),I=xe(function(a,i){const m=new Y.Tooltip(a,i.overlayContainer);return ee(m,i)},function(a,i,{position:m},h){d.useEffect(function(){const g=i.overlayContainer;if(g==null)return;const{instance:l}=a,n=x=>{x.tooltip===l&&(m!=null&&l.setLatLng(m),l.update(),h(!0))},t=x=>{x.tooltip===l&&h(!1)};return g.on({tooltipopen:n,tooltipclose:t}),g.bindTooltip(l),function(){g.off({tooltipopen:n,tooltipclose:t}),g._map!=null&&g.unbindTooltip()}},[a,i,h,m])}),Ze=O.icon({iconUrl:ve,shadowUrl:je,iconAnchor:[12,41]});O.Marker.prototype.options.icon=Ze;const J=["rgba(59, 130, 246, 0.4)","rgba(16, 185, 129, 0.4)","rgba(239, 68, 68, 0.4)","rgba(249, 115, 22, 0.4)","rgba(139, 92, 246, 0.4)"],Te=({index:r,center:a,radiusKm:i,color:m,name:h,fee:u,onRadiusChange:g,onCenterChange:l})=>{const n=be(),t=d.useRef(null),x=d.useRef(!1),y=typeof i=="number"&&!isNaN(i)?i:.1,v=y*1e3;d.useEffect(()=>{t.current&&t.current.setRadius(v)},[v]);const p=d.useCallback(f=>{if(!x.current||!t.current)return;const w=t.current,R=w.getLatLng().distanceTo(f.latlng);w.setRadius(R);const F=Math.max(.1,R/1e3);g(F)},[g]),b=d.useCallback(()=>{x.current=!1,n.dragging.enable(),n.off("mousemove",p),n.off("mouseup",b),n.getContainer().style.cursor=""},[n,p]),C=d.useCallback(f=>{O.DomEvent.stop(f),x.current=!0,n.dragging.disable(),n.on("mousemove",p),n.on("mouseup",b),n.getContainer().style.cursor="crosshair"},[n,p,b]);return d.useEffect(()=>{const f=t.current;return f&&f.on("mousedown",C),()=>{f&&f.off("mousedown",C),n.off("mousemove",p),n.off("mouseup",b)}},[n,C,p,b]),e.jsxs(e.Fragment,{children:[e.jsx(Le,{ref:t,center:a,radius:v,pathOptions:{color:m,fillColor:m,fillOpacity:.5,weight:2,interactive:!0},children:e.jsxs(I,{sticky:!0,children:[h," ",e.jsx("br",{}),"Até ",y.toFixed(2)," km ",e.jsx("br",{}),"Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u||0),e.jsx("br",{}),e.jsx("span",{className:"font-bold",children:"Clique e arraste a borda para redimensionar"})]})}),e.jsx(ae,{position:a,draggable:!0,eventHandlers:{dragend:f=>{const{lat:w,lng:S}=f.target.getLatLng();l(w,S)}},children:e.jsx(I,{permanent:!0,direction:"top",offset:[0,-10],children:h})})]})},Me=({onMapClick:r})=>(Ce({click(a){r(a.latlng.lat,a.latlng.lng)}}),null),Se=({restaurantCenter:r,zones:a,onZoneRadiusChange:i,onZoneCenterChange:m,onMapClick:h})=>{const u=[...a].sort((n,t)=>(n.max_distance_km||0)-(t.max_distance_km||0)),[g,l]=d.useState(r);return d.useEffect(()=>{u.length>0&&u[0].center_latitude&&u[0].center_longitude?l([u[0].center_latitude,u[0].center_longitude]):(r[0]!==0||r[1]!==0)&&l(r)},[r,u]),e.jsxs(_e,{center:g,zoom:14,scrollWheelZoom:!1,className:"h-96 w-full rounded-lg z-0",children:[e.jsx(ye,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(Me,{onMapClick:h}),(r[0]!==0||r[1]!==0)&&e.jsx(ae,{position:r,opacity:.5,children:e.jsx(I,{permanent:!0,children:"Local do Restaurante"})}),u.map((n,t)=>{if(!n.max_distance_km||n.max_distance_km<=0)return null;const x=J[t%J.length],y=[n.center_latitude||r[0],n.center_longitude||r[1]];return e.jsx(Te,{index:t,center:y,radiusKm:n.max_distance_km,color:x,name:n.name,fee:n.delivery_fee,onRadiusChange:v=>i(t,v),onCenterChange:(v,p)=>m(t,v,p)},n.id||t)})]})},Re=d.memo(Se),ze=X({id:B().optional(),name:B().min(1,"O nome da zona é obrigatório."),delivery_fee:z(r=>String(r).replace(",","."),D.number({invalid_type_error:"Taxa deve ser um número."}).min(0,"A taxa não pode ser negativa.")),max_distance_km:z(r=>String(r).replace(",","."),D.number({invalid_type_error:"Distância deve ser um número."}).positive("A distância máxima deve ser maior que zero.")),center_latitude:z(r=>String(r).replace(",","."),D.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),center_longitude:z(r=>String(r).replace(",","."),D.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),De=X({zones:ce(ze)}),qe=async()=>{const{data:r,error:a}=await $.from("restaurants").select("*").limit(1).single();if(a)throw new Error(`Erro ao buscar dados do restaurante: ${a.message}`);if(!r)throw new Error("Nenhum restaurante encontrado.");return r},Ae=async r=>{const{data:a,error:i}=await $.from("delivery_zones").select("*").eq("restaurant_id",r).order("max_distance_km",{ascending:!0});if(i)throw new Error(`Erro ao buscar zonas de entrega: ${i.message}`);return a},Ye=()=>{const r=te(),{data:a,isLoading:i}=P({queryKey:["restaurantDataForDelivery"],queryFn:qe}),{data:m,isLoading:h,isError:u,error:g}=P({queryKey:["deliveryZones",a==null?void 0:a.id],queryFn:()=>Ae(a.id),enabled:!!(a!=null&&a.id)}),l=de({resolver:ue(De),defaultValues:{zones:[]},mode:"onChange"}),{fields:n,append:t,remove:x,replace:y,update:v}=me({control:l.control,name:"zones"}),p=l.watch("zones"),b=d.useMemo(()=>p,[p]),C=d.useMemo(()=>typeof(a==null?void 0:a.latitude)=="number"&&typeof(a==null?void 0:a.longitude)=="number"?[a.latitude,a.longitude]:[-23.55052,-46.633308],[a]);d.useEffect(()=>{if(m){const c=m.map(s=>({id:s.id,name:s.name||"",delivery_fee:s.delivery_fee,max_distance_km:s.max_distance_km&&typeof s.max_distance_km=="number"?s.max_distance_km:1,center_latitude:s.center_latitude,center_longitude:s.center_longitude}));y(c)}},[m,y]);const f=le({mutationFn:async c=>{if(!(a!=null&&a.id))throw new Error("ID do restaurante não disponível.");const s=c.zones.map(_=>({restaurant_id:a.id,name:_.name,delivery_fee:_.delivery_fee,max_distance_km:_.max_distance_km,center_latitude:_.center_latitude,center_longitude:_.center_longitude,is_active:!0})),{error:o}=await $.from("delivery_zones").delete().eq("restaurant_id",a.id);if(o)throw new Error(`Erro ao limpar zonas antigas: ${o.message}`);const{error:j}=await $.from("delivery_zones").insert(s);if(j)throw new Error(`Erro ao inserir novas zonas: ${j.message}`)},onSuccess:()=>{N.success("Faixas de entrega salvas com sucesso!"),r.invalidateQueries({queryKey:["deliveryZones"]})},onError:c=>{N.error(`Erro ao salvar faixas de entrega: ${c.message}`)}}),w=c=>{f.mutate(c)},S=d.useCallback((c,s)=>{v(c,{...p[c],max_distance_km:parseFloat(s.toFixed(2))})},[v,p]),R=d.useCallback((c,s,o)=>{v(c,{...p[c],center_latitude:s,center_longitude:o}),N.info(`Centro da Zona ${c+1} movido.`)},[v,p]),F=()=>{t({name:`Nova Zona ${n.length+1}`,delivery_fee:5,max_distance_km:2,center_latitude:C[0],center_longitude:C[1]})},re=d.useCallback((c,s)=>{if(!(a!=null&&a.latitude)||!(a!=null&&a.longitude)){N.warning("Configure as coordenadas do restaurante em Configurações primeiro.");return}t({name:`Zona ${n.length+1} (Clique)`,delivery_fee:5,max_distance_km:1,center_latitude:c,center_longitude:s}),N.info("Nova zona de entrega adicionada no local do clique.")},[a,n.length,t]),ne=(a==null?void 0:a.latitude)&&(a==null?void 0:a.longitude),oe=C;return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto",children:[e.jsx("div",{className:"lg:sticky top-24 h-fit",children:e.jsxs(K,{children:[e.jsxs(U,{children:[e.jsx(Q,{className:"text-2xl font-bold",children:"Mapa de Cobertura"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Visualize as faixas de entrega em tempo real. Arraste o pino central para mover a zona e a borda do círculo para redimensionar o raio.",e.jsx("br",{}),e.jsx("span",{className:"font-semibold text-primary",children:"Dica: Clique em qualquer lugar do mapa para adicionar uma nova zona."})]})]}),e.jsx(V,{children:i?e.jsx(A,{className:"h-96 w-full"}):ne?e.jsx(Re,{restaurantCenter:oe,zones:b,onZoneRadiusChange:S,onZoneCenterChange:R,onMapClick:re}):e.jsxs(H,{children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(W,{children:"Endereço Não Configurado"}),e.jsxs(G,{children:["Para visualizar o mapa de entrega, primeiro configure o endereço e as coordenadas do seu restaurante na página de Configurações.",e.jsx(ie,{to:"/settings",children:e.jsx(q,{variant:"link",className:"p-0 h-auto mt-2",children:"Ir para Configurações"})})]})]})})]})}),e.jsx("div",{children:e.jsxs(K,{children:[e.jsxs(U,{children:[e.jsx(Q,{className:"text-2xl font-bold",children:"Zonas de Entrega"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina a taxa de entrega com base na distância máxima em quilômetros (km) a partir do centro de cada zona."})]}),e.jsx(V,{children:h?e.jsxs("div",{className:"space-y-4",children:[e.jsx(A,{className:"h-10 w-full"}),e.jsx(A,{className:"h-10 w-full"}),e.jsx(A,{className:"h-12 w-full mt-4"})]}):u?e.jsxs(H,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro ao carregar zonas de entrega"}),e.jsx(G,{children:g instanceof Error?g.message:"Ocorreu um erro desconhecido."})]}):e.jsx(ge,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(w),className:"space-y-6",children:[n.map((c,s)=>e.jsxs("div",{className:"border p-4 rounded-lg space-y-4 relative",children:[e.jsxs("h4",{className:"font-semibold text-lg",children:["Zona ",s+1]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(E,{control:l.control,name:`zones.${s}.name`,render:({field:o})=>e.jsxs(L,{className:"md:col-span-1",children:[e.jsx(Z,{children:"Nome da Zona *"}),e.jsx(T,{children:e.jsx(k,{placeholder:"Ex: Até 2km",...o})}),e.jsx(M,{})]})}),e.jsx(E,{control:l.control,name:`zones.${s}.max_distance_km`,render:({field:o})=>e.jsxs(L,{className:"md:col-span-1",children:[e.jsx(Z,{children:"Distância (km) *"}),e.jsx(T,{children:e.jsx(k,{type:"number",step:"0.1",placeholder:"2",...o,value:o.value===void 0||o.value===null?"":String(o.value),onChange:j=>{const _=j.target.value,se=_===""?"":parseFloat(_.replace(",","."));o.onChange(se)}})}),e.jsx(M,{})]})}),e.jsx(E,{control:l.control,name:`zones.${s}.delivery_fee`,render:({field:o})=>e.jsxs(L,{className:"md:col-span-1",children:[e.jsx(Z,{children:"Taxa (R$) *"}),e.jsx(T,{children:e.jsx(k,{type:"number",step:"0.01",placeholder:"4,00",...o,value:o.value===void 0||o.value===null?"":String(o.value),onChange:j=>o.onChange(j.target.value)})}),e.jsx(M,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(E,{control:l.control,name:`zones.${s}.center_latitude`,render:({field:o})=>e.jsxs(L,{children:[e.jsx(Z,{children:"Latitude Central"}),e.jsx(T,{children:e.jsx(k,{type:"number",step:"any",placeholder:"Latitude",...o,value:o.value===void 0||o.value===null?"":String(o.value),onChange:j=>o.onChange(j.target.value)})}),e.jsx(M,{})]})}),e.jsx(E,{control:l.control,name:`zones.${s}.center_longitude`,render:({field:o})=>e.jsxs(L,{children:[e.jsx(Z,{children:"Longitude Central"}),e.jsx(T,{children:e.jsx(k,{type:"number",step:"any",placeholder:"Longitude",...o,value:o.value===void 0||o.value===null?"":String(o.value),onChange:j=>o.onChange(j.target.value)})}),e.jsx(M,{})]})})]}),e.jsx(q,{type:"button",variant:"destructive",size:"icon",className:"absolute top-4 right-4",onClick:()=>x(s),children:e.jsx(Ne,{className:"h-4 w-4"})})]},c.id)),e.jsxs(q,{type:"button",variant:"outline",className:"w-full",onClick:F,children:[e.jsx(ke,{className:"mr-2 h-4 w-4"})," Adicionar Nova Zona (Centro do Restaurante)"]}),e.jsx(q,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:f.isPending,children:f.isPending?"Salvando...":"Salvar Zonas de Entrega"})]})})})]})})]})})};export{Ye as default};
