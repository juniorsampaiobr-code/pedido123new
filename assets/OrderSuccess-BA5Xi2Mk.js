import{b as P,j as e,u as k,c as S}from"./tanstack-QxCZ3Wpf.js";import{j as q,i as G,r as j,L as w}from"./vendor-CIxFcw7z.js";import{B as d}from"./button-CaK9rN5p.js";import{C as c,b as N,c as y,a as l}from"./card-Cf4OiIKP.js";import{s as b}from"./client-BskZ_u5h.js";import{S as E}from"./skeleton-BkjRQeca.js";import{A as I,a as F,b as M}from"./alert-CI1xVgq5.js";import{c as K,L as p,b as _,a as Q}from"./index-Bw88mmh7.js";import{T as B}from"./terminal-CjNP_fdb.js";import{C as R}from"./clock-DaQmixX9.js";import{P as V}from"./package-BS3c0_3j.js";import{T as $}from"./truck-Cl3RGBQm.js";import{C as U,a as z}from"./circle-x-DPKyZUOy.js";import{D as H}from"./dollar-sign-NNtvPKt6.js";import{A as W,a as X,b as Z,c as J,d as Y,e as ee,f as ae,g as se,h as re}from"./alert-dialog-DaOJbVNx.js";import{A as oe}from"./arrow-left-CJZ5JYnm.js";import"./supabase-DGFirUEE.js";import"./index-BUlZrBRB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=K("Utensils",[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]]),ne={pending:{label:"Pendente",icon:R,color:"bg-yellow-500",description:"Aguardando a confirmação do restaurante."},preparing:{label:"Em Preparação",icon:te,color:"bg-orange-500",description:"O restaurante está preparando seus itens."},ready:{label:"Pronto",icon:V,color:"bg-green-500",description:"Seu pedido está pronto para retirada ou entrega."},delivering:{label:"Em Entrega",icon:$,color:"bg-indigo-500",description:"Seu pedido saiu para entrega e está a caminho."},delivered:{label:"Entregue",icon:U,color:"bg-primary",description:"Seu pedido foi entregue com sucesso!"},cancelled:{label:"Cancelado",icon:z,color:"bg-destructive",description:"Seu pedido foi cancelado. Entre em contato com o restaurante se houver dúvidas."},pending_payment:{label:"Aguardando Pagamento",icon:H,color:"bg-gray-500",description:"Aguardando a confirmação do pagamento online."}},ie=async s=>{const{data:r,error:o}=await b.from("orders").select("*, customer:customers(name, phone)").eq("id",s).limit(1).single();if(o)throw new Error(`Erro ao buscar detalhes do pedido: ${o.message}`);if(!r)throw new Error("Pedido não encontrado.");return r},ce=({orderId:s})=>{var i;const{data:r,isLoading:o,isError:x,error:h}=P({queryKey:["orderStatus",s],queryFn:()=>ie(s),refetchInterval:1e4,staleTime:0,refetchOnMount:!0});if(o&&!r)return e.jsx(c,{className:"w-full max-w-md text-center shadow-xl",children:e.jsxs("div",{className:"p-6",children:[e.jsxs(N,{className:"space-y-4",children:[e.jsx(p,{className:"h-16 w-16 text-primary mx-auto animate-spin"}),e.jsx(y,{className:"text-2xl font-bold",children:"Carregando Status..."})]}),e.jsxs(l,{children:[e.jsx(E,{className:"h-4 w-3/4 mx-auto mb-2"}),e.jsx(E,{className:"h-4 w-1/2 mx-auto"})]})]})});if(x)return e.jsxs(I,{variant:"destructive",className:"w-full max-w-md mx-auto",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx(F,{children:"Erro ao rastrear pedido"}),e.jsx(M,{children:h instanceof Error?h.message:"Não foi possível carregar o status do pedido."})]});if(!r)return null;const g=r.status||"pending",t=ne[g],v=r.created_at?new Date(r.created_at).getTime().toString().slice(-4):s.slice(-4),n=t.icon;return e.jsx(c,{className:"w-full max-w-md text-center shadow-xl",children:e.jsxs("div",{className:"p-6",children:[e.jsxs(N,{className:"space-y-4",children:[e.jsx("div",{className:_("h-16 w-16 rounded-full mx-auto flex items-center justify-center text-white",t.color),children:e.jsx(n,{className:"h-8 w-8"})}),e.jsxs(y,{className:"text-3xl font-bold",children:["Pedido #",v]}),e.jsxs("p",{className:"text-lg font-semibold text-foreground",children:["Status: ",t.label]})]}),e.jsxs(l,{className:"space-y-6",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description}),e.jsxs("div",{className:"text-left border-t pt-4 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Detalhes:"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Cliente: ",((i=r.customer)==null?void 0:i.name)||"N/A"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Total: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r.total_amount)]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Endereço: ",r.delivery_address||"Retirada no Local"]})]})]})]})})},le=async s=>{const{data:r,error:o}=await b.from("orders").select("*").eq("id",s).limit(1).single();if(o)throw new Error(`Erro ao buscar pedido: ${o.message}`);if(!r)throw new Error("Pedido não encontrado.");return r},Pe=()=>{const{orderId:s}=q(),[r]=G(),o=k(),{clearCart:x}=Q(),[h,g]=j.useState(!1),[t,v]=j.useState(!1),n=r.get("status"),{data:i,isLoading:D,isError:L,refetch:A}=P({queryKey:["customerOrderStatus",s],queryFn:()=>le(s),enabled:!!s,staleTime:0,refetchOnMount:!0,refetchOnWindowFocus:!0}),O=j.useMemo(()=>{if(!i)return!1;const a=i.status;return a==="pending"||a==="preparing"||a==="ready"||a==="pending_payment"},[i]),C=S({mutationFn:async a=>{const{data:f,error:u}=await b.functions.invoke("confirm-payment",{body:{orderId:a}});if(u)throw new Error(u.message);return f},onSuccess:a=>{(a==null?void 0:a.status)==="approved"?console.log("LOG: Pagamento confirmado com sucesso!"):(a==null?void 0:a.status)==="pending"?console.log("LOG: Pagamento ainda pendente de confirmação. Aguardando a compensação do Pix/Boleto."):console.log("LOG: Status de pagamento não aprovado. Se você já pagou, aguarde alguns minutos ou entre em contato com o restaurante."),o.invalidateQueries({queryKey:["orderStatus",s]}),o.invalidateQueries({queryKey:["customerOrderStatus",s]})},onError:a=>{console.error(`LOG: Falha na confirmação do pagamento: ${a.message}`)}}),m=S({mutationFn:async a=>{console.log("LOG: Iniciando cancelamento do pedido:",a);const{data:f,error:u}=await b.from("orders").update({status:"cancelled"}).eq("id",a).select().single();if(u)throw new Error(u.message);return console.log("LOG: Pedido cancelado com sucesso. Dados retornados:",f),f},onSuccess:a=>{console.log("LOG: Cancelamento bem-sucedido. Dados:",a),o.invalidateQueries({queryKey:["customerOrderStatus",s]}),o.invalidateQueries({queryKey:["orderStatus",s]}),o.invalidateQueries({queryKey:["orders"]}),g(!1),A()},onError:a=>{console.error(`LOG: Erro ao cancelar pedido: ${a.message}`),alert(`Erro ao cancelar pedido: ${a.message}`)}}),T=()=>{console.log("LOG: Tentativa de cancelamento iniciada para OrderID:",s),s?m.mutate(s):console.error("LOG: OrderID não encontrado para cancelamento.")};return j.useEffect(()=>{s&&!t&&(x(),v(!0),console.log("LOG: Carrinho limpo após sucesso do pedido."),(n==="approved"||n==="pending")&&(console.log("LOG: Chamando confirmPaymentMutation para OrderID:",s),setTimeout(()=>{C.mutate(s)},0)))},[s,n,C,x,t]),s?D?e.jsx("div",{className:"min-h-screen bg-background flex flex-col items-center justify-center p-4",children:e.jsx(c,{className:"w-full max-w-md text-center shadow-xl",children:e.jsxs(l,{className:"p-6 flex flex-col items-center justify-center",children:[e.jsx(p,{className:"h-8 w-8 mb-4 text-primary animate-spin"}),e.jsx("p",{className:"font-semibold",children:"Carregando informações do pedido..."})]})})}):L||!i?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs(c,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(N,{children:e.jsx(y,{className:"text-2xl font-bold text-destructive",children:"Erro"})}),e.jsxs(l,{children:[e.jsx("p",{className:"text-muted-foreground",children:"Pedido não encontrado ou erro de carregamento. Tente recarregar a página."}),e.jsx(w,{to:"/menu",children:e.jsx(d,{className:"mt-4",children:"Voltar ao Cardápio"})})]})]})}):e.jsxs("div",{className:"min-h-screen bg-background flex flex-col items-center justify-center p-4",children:[e.jsx("div",{className:"w-full max-w-md mb-6",children:e.jsx(w,{to:"/menu",children:e.jsxs(d,{variant:"ghost",className:"mb-4",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"})," Voltar ao Cardápio"]})})}),C.isPending&&(n==="approved"||n==="pending")&&e.jsx(c,{className:"w-full max-w-md text-center shadow-xl mb-6",children:e.jsxs(l,{className:"p-6 flex items-center justify-center",children:[e.jsx(p,{className:"h-5 w-5 mr-3 animate-spin"}),e.jsx("p",{className:"font-semibold",children:"Confirmando pagamento, por favor aguarde..."})]})}),e.jsx("div",{children:e.jsx(ce,{orderId:s})}),e.jsx("div",{className:"w-full max-w-md mt-6",children:e.jsx(c,{className:"shadow-xl",children:e.jsxs(l,{className:"p-6 space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Você pode acompanhar o status do seu pedido nesta página."}),O?e.jsxs(W,{open:h,onOpenChange:a=>{console.log("LOG: Estado do diálogo alterado para:",a),g(a)},children:[e.jsx(X,{asChild:!0,children:e.jsx(d,{variant:"destructive",className:"w-full",disabled:m.isPending,children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"mr-2 h-4 w-4 animate-spin"}),"Cancelando..."]}):"Cancelar Pedido"})}),e.jsxs(Z,{children:[e.jsxs(J,{children:[e.jsx(Y,{children:"Tem certeza que deseja cancelar o pedido?"}),e.jsx(ee,{children:"O cancelamento só é possível antes do pedido sair para entrega. Se o restaurante já estiver preparando, o cancelamento pode não ser aceito."})]}),e.jsxs(ae,{children:[e.jsx(se,{onClick:()=>console.log("LOG: Cancelamento do pedido abortado pelo usuário"),children:"Não, manter pedido"}),e.jsx(re,{onClick:a=>{a.preventDefault(),T()},className:"bg-destructive hover:bg-destructive/90",disabled:m.isPending,children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"mr-2 h-4 w-4 animate-spin"}),"Cancelando..."]}):"Sim, cancelar"})]})]})]}):e.jsx(d,{className:"w-full",variant:"default",disabled:!0,children:"Pedido não cancelável"}),e.jsx(w,{to:"/menu",children:e.jsx(d,{className:"w-full",variant:O?"outline":"default",children:"Fazer Novo Pedido"})})]})})})]}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs(c,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(N,{children:e.jsx(y,{className:"text-2xl font-bold text-destructive",children:"Erro"})}),e.jsxs(l,{children:[e.jsx("p",{className:"text-muted-foreground",children:"ID do pedido não encontrado."}),e.jsx(w,{to:"/menu",children:e.jsx(d,{className:"mt-4",children:"Voltar ao Cardápio"})})]})]})})};export{Pe as default};
