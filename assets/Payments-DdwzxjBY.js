import{u as W,a as q,b as _,j as e}from"./tanstack-b27kfv6r.js";import{o as k,s as S,a as Y,e as Z,u as I,t as D}from"./types-Z9mbP6pS.js";import{s as u}from"./client-CNbeM-CQ.js";import{B as K}from"./button-BeHtcrrn.js";import{C as v,a as w,b as N,d as P}from"./card-9EUTfGBi.js";import{I as L}from"./label-BqSFWCjN.js";import{S as ee}from"./switch-BwrnlKkm.js";import{b as G,u as h}from"./index-C9e7Jciz.js";import{F as O,a as E,b as A,e as R,c as M,d as B}from"./form-BpuYfx2y.js";import{S as c}from"./skeleton-CjO9bdBF.js";import{b as se,r as C}from"./vendor-CrUvlFU9.js";import{A as ae,a as re,b as te}from"./alert-CZktw6p2.js";import{C as oe}from"./circle-check-big-BDUcqeYs.js";import{C as ne}from"./circle-x-DpUhusUb.js";import{S as U}from"./store-CbhyHmIX.js";import{P as V}from"./package-DO98mXJe.js";import{C as $}from"./credit-card-CxDmKyqF.js";import{D as H}from"./dollar-sign-B65Zr8E4.js";import"./supabase-hDq9CU0q.js";import"./index-DQCYbIBI.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=G("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=G("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),de=k({mercado_pago_public_key:S().min(1,"A Public Key é obrigatória."),mercado_pago_access_token:S().min(1,"O Access Token é obrigatório.")}),me=k({methods:Y(k({id:S(),is_active:Z()}))}),le=async n=>{const{data:a,error:r}=await u.from("payment_settings").select("*").eq("restaurant_id",n).limit(1).single();if(r&&r.code!=="PGRST116")throw new Error(r.message);return a},Q=async n=>{const{data:a,error:r}=await u.from("payment_methods").select("*").eq("restaurant_id",n).order("name",{ascending:!0});if(r)throw new Error(r.message);return a},xe=[{name:"Dinheiro",description:"Pagamento em dinheiro na entrega",icon:H},{name:"Pagamento online: Pix/Cartão",description:"Pagamento online via Mercado Pago (Pix, Cartão de Crédito, etc.)",icon:$},{name:"Pagamento com cartão na entrega",description:"Aceita pagamento com cartão de débito ou crédito na entrega",icon:V}],ue=n=>{switch(n){case"DollarSign":return H;case"Smartphone":return ce;case"CreditCard":return $;case"Package":return V;default:return U}},pe=({method:n,index:a,control:r,icon:g})=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(g,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:n.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n.description})]})]}),e.jsx(E,{control:r,name:`methods.${a}.is_active`,render:({field:o})=>e.jsx(A,{children:e.jsx(M,{children:e.jsx(ee,{checked:o.value,onCheckedChange:o.onChange})})})})]}),Ie=()=>{const n=W(),{userRestaurantId:a}=se(),{data:r,isLoading:g}=q({queryKey:["paymentSettings",a],queryFn:()=>le(a),enabled:!!a,staleTime:1/0}),{data:o,isLoading:f,refetch:J}=q({queryKey:["paymentMethods",a],queryFn:()=>Q(a),enabled:!!a,staleTime:1e3*60*5}),l=I({resolver:D(de),defaultValues:{mercado_pago_public_key:"",mercado_pago_access_token:""},mode:"onBlur"});C.useEffect(()=>{r&&l.reset({mercado_pago_public_key:r.mercado_pago_public_key||"",mercado_pago_access_token:r.mercado_pago_access_token||""})},[r,l]);const y=_({mutationFn:async s=>{if(!a)throw new Error("ID do restaurante não disponível.");const i=await u.functions.invoke("save-mp-credentials",{body:JSON.stringify({restaurant_id:a,public_key:s.mercado_pago_public_key,access_token:s.mercado_pago_access_token})});if(i.error)throw new Error(i.error.message);return i.data},onSuccess:s=>{h.success(s.message),n.invalidateQueries({queryKey:["paymentSettings",a]}),n.invalidateQueries({queryKey:["mercadoPagoPublicKey"]})},onError:s=>{h.error(`Erro ao salvar credenciais: ${s.message}`)}}),X=s=>{y.mutate(s)},j=_({mutationFn:async s=>{const i=await Q(s),d=new Set(i.map(t=>t.name)),m=xe.filter(t=>!d.has(t.name)).map(t=>({restaurant_id:s,name:t.name,description:t.description,icon:t.icon.displayName,is_active:!0}));if(m.length>0){const{error:t}=await u.from("payment_methods").insert(m);if(t)throw new Error(t.message);await J()}},onError:s=>{console.error("Erro ao garantir métodos padrão:",s)}});C.useEffect(()=>{a&&o&&o.length===0&&!f&&j.mutate(a)},[a,o,f,j]);const x=I({resolver:D(me),defaultValues:{methods:[]},mode:"onBlur"});C.useEffect(()=>{o&&o.length>0&&x.reset({methods:o.map(s=>({id:s.id,is_active:s.is_active??!0}))})},[o,x]);const b=_({mutationFn:async s=>{const i=s.methods.map(t=>u.from("payment_methods").update({is_active:t.is_active}).eq("id",t.id)),m=(await Promise.all(i)).filter(t=>t.error).map(t=>{var T;return(T=t.error)==null?void 0:T.message}).join(", ");if(m)throw new Error(m)},onSuccess:()=>{h.success("Configurações de métodos de pagamento salvas!"),n.invalidateQueries({queryKey:["paymentMethods",a]})},onError:s=>{h.error(`Erro ao salvar métodos: ${s.message}`)}}),z=s=>{b.mutate(s)};if(!a)return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8",children:e.jsxs(v,{className:"max-w-md text-center mx-auto",children:[e.jsx(w,{children:e.jsx(N,{children:"Erro de Configuração"})}),e.jsx(P,{children:e.jsx("p",{className:"text-muted-foreground",children:"ID do restaurante não encontrado. Por favor, recarregue a página."})})]})});const F=g||f,p=!!(r!=null&&r.mercado_pago_public_key)&&!!(r!=null&&r.mercado_pago_access_token);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-8",children:[e.jsxs(v,{children:[e.jsxs(w,{children:[e.jsx(N,{className:"text-2xl font-bold flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-6 w-6 text-primary"}),"Credenciais Mercado Pago"]})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure suas chaves de API do Mercado Pago para aceitar pagamentos online."})]}),e.jsx(P,{children:F?e.jsxs("div",{className:"space-y-4",children:[e.jsx(c,{className:"h-4 w-1/4"}),e.jsx(c,{className:"h-10 w-full"}),e.jsx(c,{className:"h-4 w-1/4"}),e.jsx(c,{className:"h-10 w-full"}),e.jsx(c,{className:"h-12 w-full mt-4"})]}):e.jsx(O,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(X),className:"space-y-6",children:[e.jsxs(ae,{variant:p?"default":"destructive",children:[p?e.jsx(oe,{className:"h-4 w-4 text-green-500"}):e.jsx(ne,{className:"h-4 w-4"}),e.jsx(re,{children:p?"Pagamento Online Configurado!":"Ação Necessária: Credenciais Incompletas!"}),e.jsxs(te,{children:[p?"As chaves pública e de acesso foram salvas. O pagamento online está ativo.":"Por favor, insira suas chaves de Public Key e Access Token de Produção do Mercado Pago para ativar o pagamento online.",e.jsx("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:e.jsxs("li",{children:[e.jsx("a",{href:"https://www.mercadopago.com.br/developers/panel/credentials",target:"_blank",rel:"noopener noreferrer",className:"font-bold underline",children:"Obtenha suas credenciais de Produção"})," no painel do Mercado Pago."]})})]})]}),e.jsx(E,{control:l.control,name:"mercado_pago_public_key",render:({field:s})=>e.jsxs(A,{children:[e.jsx(R,{children:"Public Key *"}),e.jsx(M,{children:e.jsx(L,{...s,placeholder:"APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta chave é pública e usada no checkout do cliente."}),e.jsx(B,{})]})}),e.jsx(E,{control:l.control,name:"mercado_pago_access_token",render:({field:s})=>e.jsxs(A,{children:[e.jsx(R,{children:"Access Token *"}),e.jsx(M,{children:e.jsx(L,{...s,type:"password",placeholder:"Cole seu Access Token aqui",className:"h-12"})}),e.jsx("p",{className:"text-xs text-destructive font-semibold",children:"AVISO DE SEGURANÇA: Este token é secreto e será salvo no banco de dados. Garanta que seu RLS esteja ativo."}),e.jsx(B,{})]})}),e.jsx(K,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:y.isPending||!a,children:y.isPending?"Salvando...":"Salvar Credenciais"})]})})})]}),e.jsxs(v,{children:[e.jsxs(w,{children:[e.jsx(N,{className:"text-2xl font-bold",children:"Métodos de Pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ative ou desative os métodos de pagamento aceitos pelo seu estabelecimento."})]}),e.jsx(P,{children:F||j.isPending?e.jsxs("div",{className:"space-y-4",children:[[...Array(4)].map((s,i)=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(c,{className:"h-10 w-10 rounded-md"}),e.jsxs("div",{children:[e.jsx(c,{className:"h-4 w-32 mb-1"}),e.jsx(c,{className:"h-3 w-48"})]})]}),e.jsx(c,{className:"h-6 w-10 rounded-full"})]},i)),e.jsx(c,{className:"h-12 w-full mt-4"})]}):e.jsx(O,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(z),className:"space-y-4",children:[x.watch("methods").map((s,i)=>{const d=o==null?void 0:o.find(t=>t.id===s.id),m=d!=null&&d.icon?ue(d.icon):U;return e.jsx(pe,{method:d,index:i,control:x.control,icon:m},s.id)}),e.jsx(K,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:b.isPending||!a,children:b.isPending?"Salvando...":"Salvar Configurações"})]})})})]})]})})};export{Ie as default};
