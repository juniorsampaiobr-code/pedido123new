import{j as e,b as ne,u as ie,c as q}from"./tanstack-DS1wz2fm.js";import{o as le,s as x,l as R,b as de,p as D,c as B,u as ce,t as ue}from"./types-dEzyxwQ3.js";import{s as y}from"./client-BP8r4skJ.js";import{B as S}from"./button-BdC5NocG.js";import{C as I,b as A,c as Q,a as K}from"./card-DMFPu8SO.js";import{I as h,L as O}from"./label-Culf3ya1.js";import{T as me}from"./textarea-D5UJzLia.js";import{S as pe}from"./switch-cEJ5BN0Y.js";import{c as he,u as t,L as xe}from"./index-DhSEO7wI.js";import{F as je,b as i,c as l,a as d,d as c,e as u}from"./form-CpFYZxGj.js";import{S as ge}from"./skeleton-BKPhZ790.js";import{r as j}from"./vendor-DPb28zz8.js";import{L as fe,Z,S as be}from"./ZipCodeInput-HzxcG6F-.js";import{u as ve,V as ye}from"./DashboardLayout-BZbpwbVi.js";import{C as we,a as Ne}from"./circle-x-D911bO-q.js";import{U as Ce}from"./upload-vKeDYT6i.js";import"./supabase-BT-vd-uw.js";import"./index-CJmVBZLB.js";import"./Logo-DefL8dCA.js";import"./package-C9BfOQdJ.js";import"./shopping-cart-D8lJIxTE.js";import"./clock-P6Myu5fe.js";import"./credit-card-DE4ZnM1X.js";import"./truck-D77WeLQZ.js";import"./settings-lvcF8u6e.js";import"./alert-dialog-C4X5DBbx.js";import"./index-BwJ2YjRQ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=he("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]),Ee=le({name:x().min(1,"O nome do restaurante é obrigatório."),description:x().optional(),logo_url:x().url("URL do logo inválida.").optional().or(R("")),street:x().optional(),number:x().optional(),neighborhood:x().optional(),city:x().optional(),zip_code:x().optional(),phone:x().optional(),email:x().email("Email inválido.").optional().or(R("")),is_active:de().default(!0),latitude:D(m=>String(m).replace(",","."),B.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:D(m=>String(m).replace(",","."),B.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),Ve=async()=>{const{data:m,error:v}=await y.from("restaurants").select("*").limit(1).single();if(v)throw new Error(`Erro ao buscar dados do restaurante: ${v.message}`);if(!m)throw new Error("Nenhum restaurante encontrado.");return m},H=j.memo(({center:m,markerPosition:v,onLocationChange:g})=>e.jsx(fe,{center:m,markerPosition:v,onLocationChange:g}));H.displayName="MemoizedLocationPickerMap";const so=()=>{const m=ne(),{playSound:v}=ve(),[g,_]=j.useState(null),[L,X]=j.useState(""),[w,G]=j.useState(""),[k,P]=j.useState(!1),[J,F]=j.useState(!1),{data:a,isLoading:M,isError:W,error:Y}=ie({queryKey:["restaurantSettings"],queryFn:Ve,staleTime:1e3*60*5}),s=ce({resolver:ue(Ee),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});j.useEffect(()=>{a&&(s.reset({name:a.name||"",description:a.description||"",logo_url:a.logo_url||"",street:a.street||"",number:a.number||"",neighborhood:a.neighborhood||"",city:a.city||"",zip_code:a.zip_code||"",phone:a.phone||"",email:a.email||"",is_active:a.is_active??!0,latitude:a.latitude??null,longitude:a.longitude??null}),a.latitude&&a.longitude&&F(!0))},[a,s.reset]);const N=s.watch("latitude"),C=s.watch("longitude"),ee=[-23.55052,-46.633308],U=j.useMemo(()=>typeof N=="number"&&typeof C=="number"&&!isNaN(N)&&!isNaN(C)?[N,C]:ee,[N,C]),$=j.useCallback(o=>{s.setValue("street",o.road||o.logradouro||"",{shouldValidate:!0}),s.setValue("number",o.house_number||"",{shouldValidate:!0}),s.setValue("neighborhood",o.suburb||o.bairro||"",{shouldValidate:!0}),s.setValue("city",o.city||o.localidade||"",{shouldValidate:!0}),s.setValue("zip_code",o.postcode||o.cep||"",{shouldValidate:!0})},[s]),oe=async()=>{const o=L.replace(/\D/g,"");if(o.length!==8||!w){t.warning("Por favor, digite um CEP válido e o número da casa.");return}P(!0);const n=t.loading("Buscando endereço e coordenadas...");try{const p=await fetch(`https://viacep.com.br/ws/${o}/json/`);if(!p.ok)throw new Error("Falha na busca do CEP.");const r=await p.json();if(r.erro){t.error("CEP não encontrado.");return}s.setValue("street",r.logradouro,{shouldValidate:!0}),s.setValue("number",w,{shouldValidate:!0}),s.setValue("neighborhood",r.bairro,{shouldValidate:!0}),s.setValue("city",r.localidade,{shouldValidate:!0}),s.setValue("zip_code",r.cep,{shouldValidate:!0});const b=`${r.logradouro}, ${w}, ${r.localidade}, ${r.uf}`,f=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(b)}`,z=await(await fetch(f)).json();if(z.length>0){const{lat:re,lon:te}=z[0];s.setValue("latitude",parseFloat(re),{shouldValidate:!0}),s.setValue("longitude",parseFloat(te),{shouldValidate:!0}),F(!0),t.success("Endereço e mapa atualizados com sucesso!")}else t.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(p){t.error(`Erro na busca: ${p.message}`)}finally{P(!1),t.dismiss(n)}},se=j.useCallback(async(o,n)=>{s.setValue("latitude",o,{shouldValidate:!0}),s.setValue("longitude",n,{shouldValidate:!0});const p=t.loading("Buscando endereço para a nova localização...");try{const r=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${o}&lon=${n}&addressdetails=1`,b=await fetch(r);if(!b.ok)throw new Error("Falha ao obter detalhes do endereço.");const f=await b.json();f.address?($(f.address),t.success("Endereço atualizado a partir do mapa.")):t.warning("Não foi possível encontrar um endereço para esta localização.")}catch(r){t.error(`Erro ao buscar endereço: ${r.message}`)}finally{t.dismiss(p)}},[s,$]),E=q({mutationFn:async o=>{if(!(a!=null&&a.id))throw new Error("ID do restaurante não disponível.");const{id:n,...p}={...o,id:a.id},{error:r}=await y.from("restaurants").update(p).eq("id",n);if(r)throw r},onSuccess:()=>{t.success("Configurações salvas com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings"]})},onError:o=>t.error(`Erro ao salvar configurações: ${o.message}`)}),V=q({mutationFn:async o=>{if(!(a!=null&&a.id))throw new Error("ID do restaurante não disponível.");if(o.type!=="audio/mpeg"&&o.type!=="audio/mp3")throw new Error("O arquivo deve ser do tipo MP3.");const n=`${a.id}/notification.mp3`;console.log(`[Sound Upload] Attempting upload to settings/${n}`);const{error:p}=await y.storage.from("settings").upload(n,o,{upsert:!0,contentType:"audio/mpeg"});if(p)throw p;const{data:r}=y.storage.from("settings").getPublicUrl(n);if(!r.publicUrl)throw new Error("Falha ao obter a URL pública do arquivo.");const b=`${r.publicUrl}?t=${new Date().getTime()}`;console.log(`[DB Update] Updating restaurant ID: ${a.id} with URL: ${b}`);const{error:f}=await y.from("restaurants").update({notification_sound_url:b}).eq("id",a.id);if(f)throw console.error("[DB Update Error] Supabase Error:",f),new Error(`Falha ao salvar URL no banco de dados: ${f.message}`)},onSuccess:()=>{t.success("Som de notificação atualizado com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings"]}),_(null)},onError:o=>{console.error("Erro detalhado no upload do som:",o),t.error(`Erro ao salvar som: ${o.message}`)}}),ae=()=>{g&&V.mutate(g)},T=!!(a!=null&&a.notification_sound_url);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(I,{children:[e.jsx(A,{children:e.jsx(Q,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(K,{children:M?e.jsx(ge,{className:"h-96 w-full"}):W?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",Y.message]}):e.jsx(je,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(o=>E.mutate(o)),className:"space-y-6",children:[e.jsx(i,{control:s.control,name:"name",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Nome do Restaurante *"}),e.jsx(c,{children:e.jsx(h,{...o})}),e.jsx(u,{})]})}),e.jsx(i,{control:s.control,name:"description",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Descrição"}),e.jsx(c,{children:e.jsx(me,{...o,rows:3})}),e.jsx(u,{})]})}),e.jsx(i,{control:s.control,name:"logo_url",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"URL do Logo"}),e.jsx(c,{children:e.jsx(h,{...o})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{placeholder:"Digite o CEP",value:L,onChange:o=>X(o.target.value)}),e.jsx(h,{placeholder:"Número",value:w,onChange:o=>G(o.target.value)}),e.jsx(S,{type:"button",onClick:oe,disabled:k,children:k?e.jsx(xe,{className:"h-4 w-4 animate-spin"}):e.jsx(be,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(i,{control:s.control,name:"street",render:({field:o})=>e.jsxs(l,{className:"md:col-span-2",children:[e.jsx(d,{children:"Rua"}),e.jsx(c,{children:e.jsx(h,{...o,disabled:!0})}),e.jsx(u,{})]})}),e.jsx(i,{control:s.control,name:"number",render:({field:o})=>e.jsxs(l,{className:"md:col-span-1",children:[e.jsx(d,{children:"Número"}),e.jsx(c,{children:e.jsx(h,{...o,disabled:!0})}),e.jsx(u,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:s.control,name:"neighborhood",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Bairro"}),e.jsx(c,{children:e.jsx(h,{...o,disabled:!0})}),e.jsx(u,{})]})}),e.jsx(i,{control:s.control,name:"city",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Cidade"}),e.jsx(c,{children:e.jsx(h,{...o,disabled:!0})}),e.jsx(u,{})]})})]}),e.jsx(i,{control:s.control,name:"zip_code",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"CEP"}),e.jsx(c,{children:e.jsx(Z,{...o,disabled:!0})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:J&&e.jsx(H,{center:U,markerPosition:U,onLocationChange:se})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:s.control,name:"latitude",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Latitude"}),e.jsx(c,{children:e.jsx(h,{...o,placeholder:"-22.7627908",value:o.value??""})}),e.jsx(u,{})]})}),e.jsx(i,{control:s.control,name:"longitude",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Longitude"}),e.jsx(c,{children:e.jsx(h,{...o,placeholder:"-47.408315",value:o.value??""})}),e.jsx(u,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:s.control,name:"phone",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Telefone"}),e.jsx(c,{children:e.jsx(h,{...o})}),e.jsx(u,{})]})}),e.jsx(i,{control:s.control,name:"email",render:({field:o})=>e.jsxs(l,{children:[e.jsx(d,{children:"Email"}),e.jsx(c,{children:e.jsx(h,{...o})}),e.jsx(u,{})]})})]}),e.jsx(i,{control:s.control,name:"is_active",render:({field:o})=>e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(d,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(c,{children:e.jsx(pe,{checked:o.value,onCheckedChange:o.onChange})})]})}),e.jsx(S,{type:"submit",className:"w-full h-12 text-lg",disabled:E.isPending,children:E.isPending?"Salvando...":"Salvar Configurações"})]})})})]}),e.jsxs(I,{children:[e.jsxs(A,{children:[e.jsxs(Q,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Se,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(K,{className:"space-y-4",children:[T&&e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-green-50/50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Som Salvo: notification.mp3"})]}),e.jsxs(S,{variant:"outline",size:"sm",onClick:v,children:[e.jsx(ye,{className:"h-4 w-4 mr-2"})," Testar"]})]}),!T&&!M&&e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-yellow-50/50 dark:bg-yellow-900/20",children:[e.jsx(Ne,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Nenhum som de notificação configurado."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(Ce,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(g==null?void 0:g.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:o=>{var n;return _(((n=o.target.files)==null?void 0:n[0])||null)}})]})]}),e.jsx(S,{onClick:ae,className:"w-full h-12 text-lg",disabled:!g||V.isPending,children:V.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{so as default};
