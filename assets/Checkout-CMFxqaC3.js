import{u as ne,j as e,a as Pt,b as ve}from"./tanstack-C7aOFagJ.js";import{r as m,R as It,h as Mt,i as Ot,L as De}from"./vendor-DjsPZZVP.js";import{c as kt,s as P,$ as Ze,a0 as Ne,a1 as pe,a2 as _e,a3 as At,a4 as Lt,a9 as Dt,a5 as Ft,a as fe,j as N,D as Fe,q as Te,L as ue,r as Tt,v as Gt,w as qt,B as H,o as Qe,l as A,K as $t,av as Vt,J as Bt,m as zt,aw as Kt,u as Ut,p as Ge,O as z,Q as qe,R as Y,V as ee,d as $e,a6 as Zt,ax as Qt,U as Ve,ay as Xt,C as K,e as U,f as Z,b as Q,h as M,I as X,az as re,P as Ht,i as Wt,W as Be,Y as Jt,aA as Yt,a7 as er,T as tr,t as ze}from"./index-ByACkhN0.js";import{c as Xe,R as rr,I as nr}from"./index-CuzAY5FI.js";import{u as ar}from"./index-C3WaO5Hu.js";import{S as Ke}from"./separator-Dng9pX-2.js";import{Z as sr}from"./ZipCodeInput-jSaq2wTw.js";import{C as He}from"./credit-card-Ca2C9DDu.js";import{T as we}from"./truck-fx4LF3tY.js";import{C as de}from"./circle-alert-BH7bpdkB.js";import{M as or}from"./mail-C-HvAFN8.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ir=kt("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),cr=async()=>{const{data:t,error:n}=await P.from("restaurants").select("id").limit(1).single();if(n||!t)return console.error("Failed to fetch restaurant ID for payment settings."),null;const r=t.id,{data:o,error:c}=await P.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${c.message}`);return(o==null?void 0:o.mercado_pago_public_key)||null},We=()=>ne({queryKey:["mercadoPagoPublicKey"],queryFn:cr,staleTime:1/0}),dr=(t,n,r,o)=>{const i=(r-t)*(Math.PI/180),a=(o-n)*(Math.PI/180),y=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t*(Math.PI/180))*Math.cos(r*(Math.PI/180))*Math.sin(a/2)*Math.sin(a/2);return 6371*(2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y)))},lr=async t=>{const n=t.replace(/\s+/g," ").trim(),r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=1`,o=new AbortController,c=setTimeout(()=>o.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",r);const i=await fetch(r,{signal:o.signal});if(!i.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",i.status),null;const a=await i.json();if(a&&Array.isArray(a)&&a.length>0){const y=a[0],j=parseFloat(y.lat),p=parseFloat(y.lon);if(Number.isFinite(j)&&Number.isFinite(p))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[j,p]),{lat:j,lng:p}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",n),null}catch(i){return i instanceof Error&&i.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",n):console.error("LOG: geocodeAddress - Erro durante a requisição:",i),null}finally{clearTimeout(c)}},ur=(t,n,r)=>{const o=dr(n[0],n[1],t[0],t[1]),c=r.find(i=>o<=i.max_distance_km);if(c){const i=c.delivery_fee||0,a=c.min_delivery_time_minutes||0,y=a+15;return{fee:parseFloat(i.toFixed(2)),minTime:a,maxTime:y}}return null};var Ee="Radio",[mr,Je]=Ze(Ee),[fr,pr]=mr(Ee),Ye=m.forwardRef((t,n)=>{const{__scopeRadio:r,name:o,checked:c=!1,required:i,disabled:a,value:y="on",onCheck:j,form:p,...l}=t,[g,k]=m.useState(null),E=Ne(n,O=>k(O)),R=m.useRef(!1),L=g?p||!!g.closest("form"):!0;return e.jsxs(fr,{scope:r,checked:c,disabled:a,children:[e.jsx(pe.button,{type:"button",role:"radio","aria-checked":c,"data-state":nt(c),"data-disabled":a?"":void 0,disabled:a,value:y,...l,ref:E,onClick:_e(t.onClick,O=>{c||j==null||j(),L&&(R.current=O.isPropagationStopped(),R.current||O.stopPropagation())})}),L&&e.jsx(rt,{control:g,bubbles:!R.current,name:o,value:y,checked:c,required:i,disabled:a,form:p,style:{transform:"translateX(-100%)"}})]})});Ye.displayName=Ee;var et="RadioIndicator",tt=m.forwardRef((t,n)=>{const{__scopeRadio:r,forceMount:o,...c}=t,i=pr(et,r);return e.jsx(At,{present:o||i.checked,children:e.jsx(pe.span,{"data-state":nt(i.checked),"data-disabled":i.disabled?"":void 0,...c,ref:n})})});tt.displayName=et;var hr="RadioBubbleInput",rt=m.forwardRef(({__scopeRadio:t,control:n,checked:r,bubbles:o=!0,...c},i)=>{const a=m.useRef(null),y=Ne(a,i),j=ar(r),p=Lt(n);return m.useEffect(()=>{const l=a.current;if(!l)return;const g=window.HTMLInputElement.prototype,E=Object.getOwnPropertyDescriptor(g,"checked").set;if(j!==r&&E){const R=new Event("click",{bubbles:o});E.call(l,r),l.dispatchEvent(R)}},[j,r,o]),e.jsx(pe.input,{type:"radio","aria-hidden":!0,defaultChecked:r,...c,tabIndex:-1,ref:y,style:{...c.style,...p,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});rt.displayName=hr;function nt(t){return t?"checked":"unchecked"}var xr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],he="RadioGroup",[gr,on]=Ze(he,[Xe,Je]),at=Xe(),st=Je(),[yr,jr]=gr(he),ot=m.forwardRef((t,n)=>{const{__scopeRadioGroup:r,name:o,defaultValue:c,value:i,required:a=!1,disabled:y=!1,orientation:j,dir:p,loop:l=!0,onValueChange:g,...k}=t,E=at(r),R=Dt(p),[L,O]=Ft({prop:i,defaultProp:c??null,onChange:g,caller:he});return e.jsx(yr,{scope:r,name:o,required:a,disabled:y,value:L,onValueChange:O,children:e.jsx(rr,{asChild:!0,...E,orientation:j,dir:R,loop:l,children:e.jsx(pe.div,{role:"radiogroup","aria-required":a,"aria-orientation":j,"data-disabled":y?"":void 0,dir:R,...k,ref:n})})})});ot.displayName=he;var it="RadioGroupItem",ct=m.forwardRef((t,n)=>{const{__scopeRadioGroup:r,disabled:o,...c}=t,i=jr(it,r),a=i.disabled||o,y=at(r),j=st(r),p=m.useRef(null),l=Ne(n,p),g=i.value===c.value,k=m.useRef(!1);return m.useEffect(()=>{const E=L=>{xr.includes(L.key)&&(k.current=!0)},R=()=>k.current=!1;return document.addEventListener("keydown",E),document.addEventListener("keyup",R),()=>{document.removeEventListener("keydown",E),document.removeEventListener("keyup",R)}},[]),e.jsx(nr,{asChild:!0,...y,focusable:!a,active:g,children:e.jsx(Ye,{disabled:a,required:i.required,checked:g,...j,...c,name:i.name,ref:l,onCheck:()=>i.onValueChange(c.value),onKeyDown:_e(E=>{E.key==="Enter"&&E.preventDefault()}),onFocus:_e(c.onFocus,()=>{var E;k.current&&((E=p.current)==null||E.click())})})})});ct.displayName=it;var vr="RadioGroupIndicator",dt=m.forwardRef((t,n)=>{const{__scopeRadioGroup:r,...o}=t,c=st(r);return e.jsx(tt,{...c,...o,ref:n})});dt.displayName=vr;var lt=ot,ut=ct,wr=dt;const be=m.forwardRef(({className:t,...n},r)=>e.jsx(lt,{className:fe("grid gap-2",t),...n,ref:r}));be.displayName=lt.displayName;const me=m.forwardRef(({className:t,...n},r)=>e.jsx(ut,{ref:r,className:fe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...n,children:e.jsx(wr,{className:"flex items-center justify-center",children:e.jsx(ir,{className:"h-2.5 w-2.5 fill-current text-current"})})}));me.displayName=ut.displayName;var Ce={};Object.defineProperty(Ce,"__esModule",{value:!0});var mt=Ce.loadMercadoPago=void 0;const ft="https://sdk.mercadopago.com/js/v2",_r=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Ue="MercadoPago has already been initialized in your window, please remove the duplicate import",br="MercadoPago.js not available",Nr="Failed to load MercadoPago.js",Er=()=>{for(var t=document.querySelectorAll(`script[src^="${ft}"`),n=0;n<t.length;n++){var r=t[n];if(_r.test(r.src))return r}return null},Cr=()=>{const t=document.createElement("script");t.src=ft;const n=document.head||document.body;if(!n)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return n.appendChild(t),t};let le=null;const Rr=()=>(le!==null||(le=new Promise((t,n)=>{if(typeof window>"u"){t(null);return}if(window.MercadoPago){console.warn(Ue),t(window.MercadoPago);return}try{let r=Er();r?console.warn(Ue):r||(r=Cr()),r.addEventListener("load",()=>{window.MercadoPago?t(window.MercadoPago):n(new Error(br))}),r.addEventListener("error",()=>{n(new Error(Nr))})}catch(r){n(r);return}})),le);mt=Ce.loadMercadoPago=Rr;var Sr=function(t,n,r,o){function c(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function y(l){try{p(o.next(l))}catch(g){a(g)}}function j(l){try{p(o.throw(l))}catch(g){a(g)}}function p(l){l.done?i(l.value):c(l.value).then(y,j)}p((o=o.apply(t,n||[])).next())})};class T{static getInstance(){return Sr(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield mt(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}T.publicKey=null;T.options={};T.instanceMercadoPago=void 0;T.loadedInstanceMercadoPago=!1;function Pr(t,n){return Object.keys(t).length===Object.keys(n).length&&Object.keys(t).every(o=>Object.prototype.hasOwnProperty.call(n,o)&&t[o]===n[o])}const Ir=(t,n)=>{const r=Object.assign(Object.assign({},n),{frontEndStack:"react"}),o=!Pr(T.options,r);(t!==T.publicKey||o)&&(T.publicKey=t,T.options=r,T.instanceMercadoPago=void 0)};var Mr=function(t,n,r,o){function c(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function y(l){try{p(o.next(l))}catch(g){a(g)}}function j(l){try{p(o.throw(l))}catch(g){a(g)}}function p(l){l.done?i(l.value):c(l.value).then(y,j)}p((o=o.apply(t,n||[])).next())})};const Or=()=>Mr(void 0,void 0,void 0,function*(){}),kr=()=>{},Ar=t=>{console.error(t)};var Lr=function(t,n,r,o){function c(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function y(l){try{p(o.next(l))}catch(g){a(g)}}function j(l){try{p(o.throw(l))}catch(g){a(g)}}function p(l){l.done?i(l.value):c(l.value).then(y,j)}p((o=o.apply(t,n||[])).next())})};const Dr=({settings:t,name:n,containerId:r,controller:o})=>Lr(void 0,void 0,void 0,function*(){const c=yield T.getInstance(),i=c==null?void 0:c.bricks();window[o]=yield i==null?void 0:i.create(n,r,t)}),Fr=200,Tr=({onReady:t=kr,onError:n=Ar,onSubmit:r=Or,customization:o,initialization:c,locale:i,id:a="walletBrick_container"})=>(m.useEffect(()=>{const y={settings:{initialization:c,customization:o,locale:i,callbacks:{onReady:t,onSubmit:r,onError:n}},name:"wallet",containerId:a,controller:"walletBrickController"},j=setTimeout(()=>{Dr(y)},Fr);return()=>{var p;clearTimeout(j),(p=window.walletBrickController)===null||p===void 0||p.unmount()}},[o,c,t,n,r]),It.createElement("div",{id:a})),Gr=({preferenceId:t,initPoint:n,onClose:r})=>{const{data:o,isLoading:c}=We();return m.useEffect(()=>{if(o)try{Ir(o,{locale:"pt-BR"})}catch(i){console.error("Erro ao inicializar Mercado Pago:",i),N.error("Erro ao carregar o SDK do Mercado Pago."),r()}},[o,r]),c||!o?e.jsx(Fe,{open:!0,onOpenChange:r,children:e.jsx(Te,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(Fe,{open:!0,onOpenChange:r,children:e.jsxs(Te,{className:"sm:max-w-[425px]",children:[e.jsxs(Tt,{children:[e.jsxs(Gt,{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-5 w-5 text-primary"}),"Pagamento Online"]}),e.jsx(qt,{children:"Você será redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsx("div",{className:"py-4",children:e.jsx(Tr,{initialization:{preferenceId:t},customization:{texts:{valueProp:"smart_option"}}})}),e.jsx(H,{variant:"outline",onClick:r,children:"Cancelar Pagamento"})]})})},qr=Qe({zip_code:A().min(1,"CEP é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===8,{message:"CEP deve ter 8 dígitos."}),street:A().min(1,"Rua é obrigatória."),number:A().min(1,"Número é obrigatório."),neighborhood:A().min(1,"Bairro é obrigatório."),city:A().min(1,"Cidade é obrigatória.")}),$r=Qe({name:A().min(1,"Nome é obrigatório."),phone:A().min(1,"Telefone é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:A().email("Email inválido.").optional().or($t("")),cpf_cnpj:A().optional().default("").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Vt(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:A().optional(),payment_method_id:A().min(1,"Selecione um método de pagamento."),change_for:Bt(t=>{const n=String(t).replace(",",".").trim();return n===""?void 0:n},zt.number({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}),Vr=async t=>{const{data:n,error:r}=await P.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",t).eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!n)throw new Error("Restaurante não encontrado ou inativo.");return n},Br=async t=>{const{data:n,error:r}=await P.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return n},zr=async t=>{const{data:n,error:r}=await P.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(r)throw new Error(`Erro ao buscar métodos de pagamento: ${r.message}`);return n},Kr=async t=>{const{data:n,error:r}=await P.from("customers").select("*").eq("user_id",t).limit(1).single();if(r&&r.code!=="PGRST116")throw new Error(r.message);return n||null},cn=()=>{var ke,Ae,Le;const t=Mt(),n=Ot(),r=Pt(),{items:o,totalAmount:c,clearCart:i}=Kt(),{data:a,isLoading:y}=Ut(),{data:j}=We(),[p,l]=m.useState(!1),[g,k]=m.useState(!1),[E,R]=m.useState(0),[L,O]=m.useState(null),[xe,$]=m.useState(!0),[ae,pt]=m.useState(null),[ht,ge]=m.useState(!1),[xt,gt]=m.useState(null),[Re,yt]=m.useState(null),[G,V]=m.useState(!1),q=(ke=n.state)==null?void 0:ke.restaurantId;m.useEffect(()=>{console.log("LOG: Checkout - User Status:",a?`Logged in as ${a.email}`:"Anonymous")},[a]);const{data:v,isLoading:jt,isError:vt,error:Se,refetch:wt}=ne({queryKey:["checkoutRestaurantData",q],queryFn:()=>Vr(q),enabled:!!q,staleTime:1/0}),{data:se,isLoading:_t}=ne({queryKey:["checkoutDeliveryZones",q],queryFn:()=>Br(v.id),enabled:!!v,staleTime:1/0}),{data:W,isLoading:bt}=ne({queryKey:["checkoutPaymentMethods",q],queryFn:()=>zr(v.id),enabled:!!v,staleTime:1/0}),{data:w,isLoading:Pe,refetch:Ur}=ne({queryKey:["checkoutCustomerData",a==null?void 0:a.id],queryFn:()=>Kr(a.id),enabled:!!a,staleTime:0}),ye=m.useMemo(()=>v!=null&&v.latitude&&(v!=null&&v.longitude)?[v.latitude,v.longitude]:null,[v]),je=m.useCallback(async(s,d,f,_,b,h)=>{if(!v||!ye||!v.delivery_enabled)return R(0),$(!0),O(null),{coords:null,fee:0,time:null,isValid:!0};const I=`${d}, ${f}, ${_}, ${s}`;let x=null;if(b&&h)x={lat:b,lng:h};else{k(!0);const S=N.loading("Calculando taxa de entrega...");x=await lr(I),k(!1),N.dismiss(S)}if(!x)return R(0),O(null),$(!1),N.error("Não foi possível encontrar o endereço. Verifique o CEP e o número."),{coords:null,fee:0,time:null,isValid:!1};if(pt([x.lat,x.lng]),se&&se.length>0){const S=ur([x.lat,x.lng],ye,se);return S?(R(S.fee),O([S.minTime,S.maxTime]),$(!0),{coords:x,fee:S.fee,time:[S.minTime,S.maxTime],isValid:!0}):(R(0),O(null),$(!1),N.error("Endereço fora da área de entrega."),{coords:x,fee:0,time:null,isValid:!1})}else return R(0),O(null),$(!0),{coords:x,fee:0,time:null,isValid:!0}},[v,ye,se]),u=Ge({resolver:ze($r),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:void 0},mode:"onBlur"}),C=Ge({resolver:ze(qr),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),D=u.watch("delivery_option"),Nt=u.watch("payment_method_id"),J=W==null?void 0:W.find(s=>s.id===Nt),oe=(Ae=J==null?void 0:J.name)==null?void 0:Ae.includes("online"),ie=(Le=J==null?void 0:J.name)==null?void 0:Le.includes("Dinheiro"),B=c+E,F=C.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{D==="pickup"?(R(0),$(!0),V(!0)):V(!1)},[D]),m.useEffect(()=>{if(w){let s="",d="",f="",_="",b="";if(w.address){const h=w.address.split(", ").map(I=>I.trim());h.length>=5?(s=h[0],d=h[1],f=h[2],_=h[3],b=h[4]):h.length>=4&&(s=h[0],f=h[1],_=h[2],b=h[3])}u.reset({...u.getValues(),name:w.name||"",phone:w.phone||"",email:w.email||"",cpf_cnpj:w.cpf_cnpj||""}),C.reset({zip_code:b,street:s,number:d,neighborhood:f,city:_}),w.address&&w.latitude&&w.longitude&&(V(!0),je(b,s,d,_,w.latitude,w.longitude))}else if(a&&!Pe){const s=a.user_metadata;u.reset({...u.getValues(),name:s.full_name||"",phone:s.phone||"",email:a.email||"",cpf_cnpj:s.cpf_cnpj||""})}},[w,u,a,Pe,C,je]);const te=u.watch("change_for");m.useEffect(()=>{ie&&te!==null&&te!==void 0&&te>0&&te<B?u.setError("change_for",{message:"O valor do troco deve ser maior ou igual ao total do pedido."}):u.clearErrors("change_for")},[ie,te,B,u]);const ce=ve({mutationFn:async s=>{var h;const f=(h=(await P.auth.getUser()).data.user)==null?void 0:h.id;if(!(w!=null&&w.id)&&!f)throw new Error("ID do cliente ou usuário não encontrado.");const _=`${s.street}, ${s.number}, ${s.neighborhood}, ${s.city}, ${s.zip_code}`,b={user_id:f||null,name:u.getValues("name"),phone:u.getValues("phone"),email:u.getValues("email")||null,cpf_cnpj:u.getValues("cpf_cnpj")||null,address:_,latitude:s.lat,longitude:s.lng};if(w!=null&&w.id){const{data:I,error:x}=await P.from("customers").update(b).eq("id",w.id).select().single();if(x)throw x;return I}else if(f){const{data:I,error:x}=await P.from("customers").insert(b).select().single();if(x)throw x;return I}else return{id:"anonymous",user_id:null,name:b.name,phone:b.phone,email:b.email,address:_,created_at:"",updated_at:"",latitude:s.lat,longitude:s.lng,cpf_cnpj:b.cpf_cnpj}},onSuccess:(s,d)=>{s.id!=="anonymous"&&r.invalidateQueries({queryKey:["checkoutCustomerData"]}),R(d.fee),O(d.time),$(d.isValid),V(!0),N.success("Endereço salvo e taxa de entrega calculada!")},onError:s=>{N.error(`Erro ao salvar endereço: ${s.message}`),V(!1)}}),Et=async()=>{if(D==="pickup")return;if(!await C.trigger()){N.error("Preencha todos os campos obrigatórios do endereço.");return}const d=C.getValues(),f=await je(d.zip_code,d.street,d.number,d.city);if(!f.isValid){V(!1);return}if(!f.coords){N.error("Não foi possível obter as coordenadas para salvar o endereço."),V(!1);return}ce.mutate({...d,lat:f.coords.lat,lng:f.coords.lng,fee:f.fee,time:f.time,isValid:f.isValid})},Ie=ve({mutationFn:async s=>{var h,I;(h=(await P.auth.getUser()).data.user)==null||h.id;const f=s.phone.replace(/\D/g,""),_=((I=s.cpf_cnpj)==null?void 0:I.replace(/\D/g,""))||null,b={user_id:(a==null?void 0:a.id)||null,name:s.name,phone:f,email:s.email||null,cpf_cnpj:_,address:D==="delivery"?`${F[1]}, ${F[2]}, ${F[3]}, ${F[4]}, ${F[0]}`:null,latitude:ae?ae[0]:null,longitude:ae?ae[1]:null};if(a)if(w){const{data:x,error:S}=await P.from("customers").update(b).eq("id",w.id).select().single();if(S)throw S;return x}else{const{data:x,error:S}=await P.from("customers").insert(b).select().single();if(S)throw S;return x}else{const{data:x,error:S}=await P.from("customers").insert(b).select().single();if(S)throw S;return x}},onSuccess:()=>{r.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:s=>{N.error(`Erro ao salvar dados do cliente: ${s.message}`)}}),Me=ve({mutationFn:async({customerId:s,data:d})=>{if(!v)throw new Error("Dados do restaurante não disponíveis.");const f={restaurant_id:v.id,customer_id:s,status:oe?"pending_payment":"pending",total_amount:B,delivery_fee:E,delivery_address:D==="delivery"?`${F[1]}, ${F[2]}, ${F[3]}, ${F[4]}, ${F[0]}`:null,notes:d.notes,payment_method_id:d.payment_method_id,change_for:ie&&d.change_for&&d.change_for>B?d.change_for:null},{data:_,error:b}=await P.from("orders").insert(f).select("id").single();if(b)throw b;const h=o.map(x=>({order_id:_.id,product_id:x.product.id,quantity:x.quantity,unit_price:x.product.price,subtotal:x.subtotal,notes:x.notes})),{error:I}=await P.from("order_items").insert(h);if(I)throw I;return _.id},onSuccess:s=>{r.invalidateQueries({queryKey:["orders"]})},onError:s=>{N.error(`Erro ao criar pedido: ${s.message}`)}}),Ct=async s=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",oe),console.log("LOG: deliveryOption:",D),console.log("LOG: isAddressSaved:",G),o.length===0){N.error("Seu carrinho está vazio."),t("/menu");return}if(D==="delivery"){if(!G){N.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!xe){N.error("O endereço de entrega está fora da área de cobertura.");return}}let d;try{console.log("LOG: Criando/Atualizando cliente..."),d=(await Ie.mutateAsync(s)).id,console.log("LOG: Cliente ID:",d)}catch(_){N.error(`Falha ao salvar cliente: ${_.message}`);return}let f;try{console.log("LOG: Criando pedido..."),f=await Me.mutateAsync({customerId:d,data:s}),console.log("LOG: Pedido ID:",f)}catch(_){N.error(`Falha ao criar pedido: ${_.message}`);return}oe?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Rt(f,s)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),i(),t(`/order-success/${f}`,{replace:!0}))},Rt=async(s,d)=>{if(!v)return;const f=window.location.origin+window.location.pathname,_=o.map(h=>({name:h.product.name,price:h.product.price,quantity:h.quantity})),b=N.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:h,error:I}=await P.functions.invoke("create-payment-preference",{body:{orderId:s,items:_,totalAmount:B,restaurantName:v.name,clientUrl:f,customerEmail:d.email||(a==null?void 0:a.email)||"cliente@anonimo.com",customerCpfCnpj:d.cpf_cnpj}});if(I)throw I;const{init_point:x}=h;console.log("LOG: Preferência MP criada. init_point:",x),gt(s),yt(x),ge(!0),N.dismiss(b)}catch(h){console.error("Erro ao criar preferência MP:",h),N.dismiss(b),N.error(`Erro no pagamento online: ${h.message}`),ge(!1)}},St=async()=>{await P.auth.signOut(),N.success("Você saiu da sua conta."),t("/auth",{replace:!0})};if(!q)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(qe,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Rastreamento"}),e.jsx(ee,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(De,{to:"/",children:e.jsx(H,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(o.length===0)return m.useEffect(()=>{t(`/menu/${q}`)},[t,q]),e.jsx($e,{});if(jt||_t||bt||y)return e.jsx($e,{});if(vt||!v)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(qe,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro Crítico"}),e.jsx(ee,{children:Se instanceof Error?Se.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(H,{onClick:()=>wt(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Zt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Oe=Ie.isPending||Me.isPending||ce.isPending||g||D==="delivery"&&!G;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Qt,{isOpen:p,onClose:()=>l(!1),customer:w}),ht&&Re&&e.jsx(Gr,{preferenceId:xt,initPoint:Re,onClose:()=>ge(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:v.name})]}),a&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{variant:"outline",size:"icon",onClick:()=>l(!0),"aria-label":"Meu Perfil",children:e.jsx(Ve,{className:"h-4 w-4"})}),e.jsxs(H,{variant:"outline",size:"sm",onClick:St,children:[e.jsx(Xt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ve,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(Q,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:a?`Logado como ${a.email}. ${w?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:u.handleSubmit(Ct),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(X,{id:"name",...u.register("name")}),u.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"phone",children:"Telefone *"}),e.jsx(re,{name:"phone",control:u.control,render:({field:s})=>e.jsx(Ht,{id:"phone",...s})}),u.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(X,{id:"email",type:"email",...u.register("email")}),u.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(re,{name:"cpf_cnpj",control:u.control,render:({field:s})=>e.jsx(Wt,{id:"cpf_cnpj",...s})}),u.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(Q,{children:e.jsx(re,{name:"delivery_option",control:u.control,render:({field:s})=>e.jsxs(be,{onValueChange:s.onChange,value:s.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(M,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(me,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(we,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(M,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(me,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Be,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),D==="delivery"&&e.jsxs(K,{className:fe(!G&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(U,{children:[e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Be,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",G&&e.jsx(Jt,{className:"h-5 w-5 text-green-500 ml-2"}),!G&&e.jsx(de,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(Q,{className:"space-y-4",children:[!v.delivery_enabled&&e.jsxs(z,{variant:"destructive",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(Y,{children:"Entrega Desativada"}),e.jsx(ee,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),Et()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(M,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(re,{name:"zip_code",control:C.control,render:({field:s})=>e.jsx(sr,{id:"zip_code",...s})}),C.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"street",children:"Rua *"}),e.jsx(X,{id:"street",...C.register("street")}),C.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"number",children:"Número *"}),e.jsx(X,{id:"number",...C.register("number")}),C.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(X,{id:"neighborhood",...C.register("neighborhood")}),C.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"city",children:"Cidade *"}),e.jsx(X,{id:"city",...C.register("city")}),C.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.city.message})]}),e.jsxs(H,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ce.isPending||g||!v.delivery_enabled,children:[ce.isPending||g?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Yt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),g&&e.jsxs(z,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(Y,{children:"Calculando Taxa de Entrega..."})]}),!xe&&G&&!g&&e.jsxs(z,{variant:"destructive",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(Y,{children:"Fora da Área de Entrega"}),e.jsx(ee,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),L&&xe&&G&&!g&&e.jsxs(z,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(Y,{children:"Entrega Disponível"}),e.jsxs(ee,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(E),". Tempo estimado: ",L[0]," - ",L[1]," minutos."]})]})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(He,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(Q,{children:[e.jsx(re,{name:"payment_method_id",control:u.control,render:({field:s})=>e.jsx(be,{onValueChange:s.onChange,value:s.value,className:"space-y-3",children:W==null?void 0:W.map(d=>{var _;const f=((_=d.name)==null?void 0:_.includes("online"))&&!j;return e.jsx(M,{htmlFor:d.id,className:fe("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",f&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(me,{value:d.id,id:d.id,disabled:f}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:d.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:d.description}),f&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},d.id)})})}),u.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:u.formState.errors.payment_method_id.message})]})]}),ie&&e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(er,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(X,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B),...u.register("change_for",{valueAsNumber:!0})}),u.formState.errors.change_for&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.change_for.message})]})})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(or,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(tr,{id:"notes",...u.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(K,{className:"shadow-lg",children:[e.jsx(U,{children:e.jsx(Z,{className:"text-2xl",children:"Resumo"})}),e.jsxs(Q,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:o.map(s=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[s.quantity,"x ",s.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s.subtotal)})]},s.product.id))}),e.jsx(Ke,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(E)})]})]}),e.jsx(Ke,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B)})]}),e.jsx(H,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Oe,children:Oe?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):oe?"Pagar e Finalizar":"Confirmar Pedido"}),D==="delivery"&&!G&&e.jsxs(z,{variant:"destructive",className:"mt-3",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(ee,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(De,{to:`/menu/${v.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{cn as default};
