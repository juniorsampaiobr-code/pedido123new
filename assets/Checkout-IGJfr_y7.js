import{j as e,b as Sr,u as ie,c as Fr}from"./tanstack-DS1wz2fm.js";import{r as m,R as Ge,u as kr,h as Vr,L as Ir}from"./vendor-DPb28zz8.js";import{o as Lr,s as F,l as $r,e as Mr,c as De,p as Ar,n as Tr,Z as z,u as zr,t as qr}from"./types-dEzyxwQ3.js";import{s as $}from"./client-BP8r4skJ.js";import{c as Re,f as Ke,g as Pe,P as he,i as Ce,h as Dr,l as Br,m as Or,b as oe,a as Gr,u as j,v as Kr,L as Ne}from"./index-V4cgCgal.js";import{B as ae}from"./button-_Kx6vQmI.js";import{C as le,b as ce,c as de,a as ue}from"./card-DVoeGlCC.js";import{I as L}from"./label-cJCNW6OK.js";import{c as Ue,R as Ur,I as Zr}from"./index-Boz4YhRn.js";import{u as Jr}from"./index-Dm27xrF8.js";import{u as Hr}from"./index-CJmVBZLB.js";import{S as Be}from"./separator-DL_S1_Hu.js";import{T as Qr}from"./textarea-v7WIy2u0.js";import{A as K,a as U,b as Z}from"./alert-ZIeD494G.js";import{F as Wr,b as E,c as v,a as w,e as R,d as W}from"./form-tzhNdVUz.js";import{Z as Xr,L as Yr}from"./ZipCodeInput-BOcbKYH0.js";import{T as Oe}from"./terminal-CPiPYzX_.js";import{A as ea}from"./arrow-left-CPYdsPWo.js";import{T as we}from"./truck-CVxsbWL_.js";import{S as Ze,a as ra}from"./store-AXK5HO7W.js";import{M as _e}from"./map-pin-84jtUn77.js";import{C as Je}from"./credit-card-CKTI8Ewn.js";import{P as aa}from"./package-CX5ArCx1.js";import{D as oa}from"./dollar-sign-CRORZmEi.js";import"./supabase-BT-vd-uw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sa=Re("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ta=Re("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const na=Re("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var Se="Radio",[ia,He]=Ke(Se),[la,ca]=ia(Se),Qe=m.forwardRef((o,a)=>{const{__scopeRadio:t,name:p,checked:n=!1,required:c,disabled:d,value:h="on",onCheck:g,form:x,...C}=o,[P,S]=m.useState(null),f=Pe(a,q=>S(q)),y=m.useRef(!1),_=P?x||!!P.closest("form"):!0;return e.jsxs(la,{scope:t,checked:n,disabled:d,children:[e.jsx(he.button,{type:"button",role:"radio","aria-checked":n,"data-state":er(n),"data-disabled":d?"":void 0,disabled:d,value:h,...C,ref:f,onClick:Ce(o.onClick,q=>{n||g==null||g(),_&&(y.current=q.isPropagationStopped(),y.current||q.stopPropagation())})}),_&&e.jsx(Ye,{control:P,bubbles:!y.current,name:p,value:h,checked:n,required:c,disabled:d,form:x,style:{transform:"translateX(-100%)"}})]})});Qe.displayName=Se;var We="RadioIndicator",Xe=m.forwardRef((o,a)=>{const{__scopeRadio:t,forceMount:p,...n}=o,c=ca(We,t);return e.jsx(Dr,{present:p||c.checked,children:e.jsx(he.span,{"data-state":er(c.checked),"data-disabled":c.disabled?"":void 0,...n,ref:a})})});Xe.displayName=We;var da="RadioBubbleInput",Ye=m.forwardRef(({__scopeRadio:o,control:a,checked:t,bubbles:p=!0,...n},c)=>{const d=m.useRef(null),h=Pe(d,c),g=Hr(t),x=Br(a);return m.useEffect(()=>{const C=d.current;if(!C)return;const P=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(P,"checked").set;if(g!==t&&f){const y=new Event("click",{bubbles:p});f.call(C,t),C.dispatchEvent(y)}},[g,t,p]),e.jsx(he.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...n,tabIndex:-1,ref:h,style:{...n.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Ye.displayName=da;function er(o){return o?"checked":"unchecked"}var ua=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],fe="RadioGroup",[ma,ao]=Ke(fe,[Ue,He]),rr=Ue(),ar=He(),[pa,ha]=ma(fe),or=m.forwardRef((o,a)=>{const{__scopeRadioGroup:t,name:p,defaultValue:n,value:c,required:d=!1,disabled:h=!1,orientation:g,dir:x,loop:C=!0,onValueChange:P,...S}=o,f=rr(t),y=Jr(x),[_,q]=Or({prop:c,defaultProp:n??null,onChange:P,caller:fe});return e.jsx(pa,{scope:t,name:p,required:d,disabled:h,value:_,onValueChange:q,children:e.jsx(Ur,{asChild:!0,...f,orientation:g,dir:y,loop:C,children:e.jsx(he.div,{role:"radiogroup","aria-required":d,"aria-orientation":g,"data-disabled":h?"":void 0,dir:y,...S,ref:a})})})});or.displayName=fe;var sr="RadioGroupItem",tr=m.forwardRef((o,a)=>{const{__scopeRadioGroup:t,disabled:p,...n}=o,c=ha(sr,t),d=c.disabled||p,h=rr(t),g=ar(t),x=m.useRef(null),C=Pe(a,x),P=c.value===n.value,S=m.useRef(!1);return m.useEffect(()=>{const f=_=>{ua.includes(_.key)&&(S.current=!0)},y=()=>S.current=!1;return document.addEventListener("keydown",f),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",f),document.removeEventListener("keyup",y)}},[]),e.jsx(Zr,{asChild:!0,...h,focusable:!d,active:P,children:e.jsx(Qe,{disabled:d,required:c.required,checked:P,...g,...n,name:c.name,ref:C,onCheck:()=>c.onValueChange(n.value),onKeyDown:Ce(f=>{f.key==="Enter"&&f.preventDefault()}),onFocus:Ce(n.onFocus,()=>{var f;S.current&&((f=x.current)==null||f.click())})})})});tr.displayName=sr;var fa="RadioGroupIndicator",nr=m.forwardRef((o,a)=>{const{__scopeRadioGroup:t,...p}=o,n=ar(t);return e.jsx(Xe,{...n,...p,ref:a})});nr.displayName=fa;var ir=or,lr=tr,ga=nr;const Ee=m.forwardRef(({className:o,...a},t)=>e.jsx(ir,{className:oe("grid gap-2",o),...a,ref:t}));Ee.displayName=ir.displayName;const me=m.forwardRef(({className:o,...a},t)=>e.jsx(lr,{ref:t,className:oe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",o),...a,children:e.jsx(ga,{className:"flex items-center justify-center",children:e.jsx(sa,{className:"h-2.5 w-2.5 fill-current text-current"})})}));me.displayName=lr.displayName;const xa=o=>{let a=o.replace(/\D/g,"");return a.length>11&&(a=a.slice(0,11)),a.length>0&&(a=`(${a}`),a.length>3&&(a=`${a.slice(0,3)}) ${a.slice(3)}`),a.length>10&&(a=`${a.slice(0,10)}-${a.slice(10)}`),a},cr=Ge.forwardRef(({className:o,value:a,onChange:t,...p},n)=>{const c=d=>{const h=d.target.value,g=xa(h),x={...d,target:{...d.target,value:g}};t(x)};return e.jsx(L,{ref:n,type:"tel",className:oe("w-full",o),placeholder:"(99) 99999-9999",value:a,onChange:c,...p})});cr.displayName="PhoneInput";const ya=o=>{let a=o.replace(/\D/g,"");return a.length>14&&(a=a.slice(0,14)),a.length<=11?(a.length>9&&(a=`${a.slice(0,9)}-${a.slice(9)}`),a.length>6&&(a=`${a.slice(0,6)}.${a.slice(6)}`),a.length>3&&(a=`${a.slice(0,3)}.${a.slice(3)}`),a):(a.length>12&&(a=`${a.slice(0,12)}-${a.slice(12)}`),a.length>8&&(a=`${a.slice(0,8)}/${a.slice(8)}`),a.length>5&&(a=`${a.slice(0,5)}.${a.slice(5)}`),a.length>2&&(a=`${a.slice(0,2)}.${a.slice(2)}`),a)},dr=Ge.forwardRef(({className:o,value:a,onChange:t,...p},n)=>{const c=d=>{const h=d.target.value,g=ya(h),x={...d,target:{...d.target,value:g}};t(x)};return e.jsx(L,{ref:n,type:"tel",className:oe("w-full",o),placeholder:"CPF ou CNPJ",value:a,onChange:c,maxLength:18,...p})});dr.displayName="CpfCnpjInput";const ja=(o,a,t,p)=>{const c=(t-o)*(Math.PI/180),d=(p-a)*(Math.PI/180),h=Math.sin(c/2)*Math.sin(c/2)+Math.cos(o*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))},va=async o=>{const a=o.replace(/\s+/g," ").trim(),t=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`;try{const p=await fetch(t);if(!p.ok)throw new Error("Falha na API de geocodificação.");const n=await p.json();if(n&&n.length>0){const c=parseFloat(n[0].lat),d=parseFloat(n[0].lon);if(!isNaN(c)&&!isNaN(d))return[c,d]}return console.warn("Geocodificação falhou para o endereço:",a,"Nenhum resultado encontrado."),null}catch(p){return console.error("Erro durante a geocodificação:",p),null}},ba=(o,a,t)=>{const p=ja(a[0],a[1],o[0],o[1]),n=t.find(c=>p<=c.max_distance_km);if(n){const c=n.delivery_fee||0,d=n.min_delivery_time_minutes||0,h=d+15;return{fee:parseFloat(c.toFixed(2)),minTime:d,maxTime:h}}return null},ur=o=>o.replace(/\D/g,""),mr=o=>o.replace(/\D/g,""),pe=o=>o.replace(/\D/g,""),Na=Lr({name:F().min(1,"Nome é obrigatório."),phone:F().min(1,"Telefone é obrigatório.").transform(ur).refine(o=>o.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:F().email("Email inválido.").optional().or($r("")),delivery_option:Mr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:F().optional().default(""),number:F().optional().default(""),complement:F().optional().default(""),neighborhood:F().optional().default(""),city:F().optional().default(""),zip_code:F().optional().default("").transform(mr).refine(o=>o.length===8||o.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:De.number().optional().nullable(),longitude:De.number().optional().nullable(),payment_method_id:F().min(1,"Selecione uma forma de pagamento."),notes:F().optional(),cpf_cnpj:F().optional().default("").transform(pe).refine(o=>o.length===0||o.length===11||o.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ar(o=>{if(o==null||o==="")return null;const a=String(o).replace(",","."),t=parseFloat(a);return isNaN(t)?a:t},Tr({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((o,a)=>{if(o.delivery_option==="delivery"&&(o.street.trim()===""&&a.addIssue({code:z.custom,message:"Rua é obrigatória.",path:["street"]}),o.number.trim()===""&&a.addIssue({code:z.custom,message:"Número é obrigatório.",path:["number"]}),o.neighborhood.trim()===""&&a.addIssue({code:z.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),o.city.trim()===""&&a.addIssue({code:z.custom,message:"Cidade é obrigatória.",path:["city"]}),o.zip_code.length!==8&&a.addIssue({code:z.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(o.latitude===null||o.longitude===null)&&a.addIssue({code:z.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),o.payment_method_id==="Dinheiro"&&o.change_for!==null&&o.change_for!==void 0&&o.change_for<=0&&a.addIssue({code:z.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),o.payment_method_id==="Pagamento online: Pix/Cartão"){const n=pe(o.cpf_cnpj||"");n.length!==11&&n.length!==14&&a.addIssue({code:z.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),wa=()=>{const o=window.location.origin,t=window.location.pathname.split("/")[1];return t?`${o}/${t}`:o},Ca=async()=>{const{data:o,error:a}=await $.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(a)throw new Error(`Erro ao buscar restaurante: ${a.message}`);if(!o)throw new Error("Nenhum restaurante ativo encontrado.");return o},_a=async o=>{const{data:a,error:t}=await $.from("restaurants").select("delivery_enabled").eq("id",o).single();if(t)throw new Error(`Erro ao buscar status de entrega: ${t.message}`);return a.delivery_enabled??!0},Ea=async o=>{const{data:a,error:t}=await $.from("payment_methods").select("*").eq("restaurant_id",o).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return a},Ra=async o=>{const{data:a,error:t}=await $.from("delivery_zones").select("*").eq("restaurant_id",o).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return a},Pa=o=>{switch(o){case"DollarSign":return oa;case"Smartphone":return ra;case"CreditCard":return Je;case"Package":return aa;default:return Ze}},Sa=({subtotal:o,deliveryFee:a,total:t,items:p})=>e.jsxs(le,{className:"sticky top-4",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(ue,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:p.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(Be,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(Be,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]})]})]}),Fa=({markerPosition:o,onLocationChange:a,updateAddressFields:t,restaurant:p})=>{const n=o[0],c=o[1];return e.jsxs("div",{className:"space-y-2 relative",children:[e.jsx("div",{className:"relative",children:e.jsx(Yr,{center:o,markerPosition:o,onLocationChange:a,isInteractive:!0})}),e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",n==null?void 0:n.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",c==null?void 0:c.toFixed(6)]})]}),e.jsxs(K,{variant:"default",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(U,{children:"Ajuste a Localização"}),e.jsx(Z,{children:"Arraste o pino azul para o local exato da entrega para garantir a precisão da taxa."})]})]})},oo=()=>{const o=kr(),a=Sr(),t=Gr(),{items:p,subtotal:n,deliveryFee:c,total:d,setDeliveryFee:h,clearCart:g}=t,[x]=Vr(),[C,P]=m.useState(!1),[S,f]=m.useState(!1),[y,_]=m.useState(null),[q,D]=m.useState(null),X=x.get("status"),se=x.get("external_reference"),Fe=x.has("collection_id")||x.has("external_reference"),[te,ke]=m.useState(!!se);m.useEffect(()=>{if(se)if(X==="approved"||X==="failure"||X==="pending"){o(`/order-success/${se}?status=${X}`,{replace:!0});return}else Fe&&(j.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),ke(!1));else ke(!1)},[se,X,Fe,o]);const{data:l,isLoading:pr,isError:hr,error:fr}=ie({queryKey:["checkoutRestaurantData"],queryFn:Ca}),{data:M,isLoading:ge}=ie({queryKey:["deliveryStatus",l==null?void 0:l.id],queryFn:()=>_a(l.id),enabled:!!(l!=null&&l.id)}),{data:J=[],isLoading:gr}=ie({queryKey:["checkoutPaymentMethods",l==null?void 0:l.id],queryFn:()=>Ea(l.id),enabled:!!(l!=null&&l.id)}),{data:Ve=[],isLoading:xr}=ie({queryKey:["checkoutDeliveryZones",l==null?void 0:l.id],queryFn:()=>Ra(l.id),enabled:!!(l!=null&&l.id)}),yr=pr||ge||gr||xr,jr=hr,Ie=fr,s=zr({resolver:qr(Na),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),H=s.watch("delivery_option"),xe=s.watch("payment_method_id"),Q=J.find(r=>r.id===xe),B=(Q==null?void 0:Q.name)==="Pagamento online: Pix/Cartão",Y=(Q==null?void 0:Q.name)==="Dinheiro",k=s.watch("latitude"),V=s.watch("longitude");s.watch(["street","number","neighborhood","city","zip_code"]);const O=H==="delivery",vr=m.useMemo(()=>JSON.stringify({deliveryOption:H,deliveryEnabled:M,lat:k,lng:V}),[H,M,k,V]),br=m.useMemo(()=>typeof k=="number"&&typeof V=="number"&&!isNaN(k)&&!isNaN(V)?[k,V]:l!=null&&l.latitude&&(l!=null&&l.longitude)?[l.latitude,l.longitude]:[-23.55052,-46.633308],[k,V,l]),ye=m.useCallback(r=>{const i=r.road||r.logradouro||"",u=r.house_number||"",b=r.suburb||r.bairro||"",N=r.city||r.localidade||"",A=r.postcode||r.cep||"";s.setValue("street",i,{shouldValidate:!0}),s.setValue("number",u||"",{shouldValidate:!0}),s.setValue("complement",r.suburb||"",{shouldValidate:!0}),s.setValue("neighborhood",b,{shouldValidate:!0}),s.setValue("city",N,{shouldValidate:!0}),s.setValue("zip_code",A,{shouldValidate:!0})},[s]),Nr=m.useCallback(async(r,i)=>{s.setValue("latitude",r,{shouldValidate:!0}),s.setValue("longitude",i,{shouldValidate:!0});const u=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${i}&addressdetails=1`,b=await fetch(u);if(b.ok){const N=await b.json();N.address&&(ye(N.address),j.info("Endereço preenchido a partir do mapa."))}},[s,ye]),wr=m.useCallback(()=>{s.setValue("street","",{shouldValidate:!0}),s.setValue("number","",{shouldValidate:!0}),s.setValue("complement","",{shouldValidate:!0}),s.setValue("neighborhood","",{shouldValidate:!0}),s.setValue("city","",{shouldValidate:!0}),s.setValue("zip_code","",{shouldValidate:!0}),s.setValue("latitude",null,{shouldValidate:!0}),s.setValue("longitude",null,{shouldValidate:!0}),h(0),_(null),D(null),j.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[s,h]),je=m.useCallback(r=>{try{const i={name:r.name,phone:r.phone,email:r.email,delivery_option:r.delivery_option,street:r.street,number:r.number,complement:r.complement,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code,latitude:r.latitude,longitude:r.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(i))}catch(i){console.error("Failed to save form data to local storage",i)}},[]),Le=m.useCallback(()=>{try{const r=localStorage.getItem("checkoutFormData");if(r){const i=JSON.parse(r);s.reset({...s.getValues(),...i,delivery_option:i.delivery_option||"delivery"})}}catch(r){console.error("Failed to load form data from local storage",r)}},[s]);m.useEffect(()=>{Le()},[Le]),m.useEffect(()=>{const r=s.watch(i=>{je(i)});return()=>r.unsubscribe()},[s,je]);const Cr=async()=>{const r=s.getValues(),[i,u,b,N,A]=[r.street,r.number,r.neighborhood,r.city,r.zip_code],ne=mr(A);if(!(i&&u&&b&&N&&ne.length===8)){j.error("Preencha o endereço completo (Rua, Número, Bairro, Cidade, CEP) antes de salvar.");return}f(!0);const be=j.loading("Buscando coordenadas e salvando endereço...");try{const ee=`${i}, ${u}, ${b}, ${N}, ${A}`,G=await va(ee);G?(s.setValue("latitude",G[0],{shouldValidate:!0}),s.setValue("longitude",G[1],{shouldValidate:!0}),je(s.getValues()),j.success("Endereço e localização salvos com sucesso!")):(s.setValue("latitude",null,{shouldValidate:!0}),s.setValue("longitude",null,{shouldValidate:!0}),j.error("Não foi possível encontrar as coordenadas exatas para este endereço. Por favor, ajuste o pino no mapa manualmente."))}catch{j.error("Erro ao buscar coordenadas.")}finally{f(!1),j.dismiss(be)}};m.useEffect(()=>{Y||s.setValue("change_for",null,{shouldValidate:!0})},[Y,s]),m.useEffect(()=>{H==="pickup"&&(h(0),_(null),D(null),s.setValue("latitude",null),s.setValue("longitude",null))},[H,O,s,h,k,V]),m.useEffect(()=>{J.length>0&&!xe&&s.setValue("payment_method_id",J[0].id)},[J,xe,s]),m.useEffect(()=>{B?s.trigger("cpf_cnpj"):s.clearErrors("cpf_cnpj")},[B,s]),m.useEffect(()=>{const r=async()=>{if(H==="pickup"||!(l!=null&&l.latitude)||!(l!=null&&l.longitude)){h(0),_(null),D(null);return}if(ge)return;if(M===!1){h(0),_(null),D(null),f(!1);return}f(!0),_(null);let u=null;if(k&&V)u=[k,V];else{h(0),D(null),f(!1);return}if(u){const b=[l.latitude,l.longitude],N=ba(u,b,Ve);N?(h(N.fee),_(null),D({minTime:N.minTime,maxTime:N.maxTime})):(h(0),_("Seu endereço está fora da nossa área de entrega."),D(null))}f(!1)},i=setTimeout(()=>{r()},500);return()=>clearTimeout(i)},[vr,l,Ve,s,h,O,k,V,M,ge]),m.useEffect(()=>{if(p.length===0&&!C&&!te){const r=setTimeout(()=>{j.info("Seu carrinho está vazio. Adicione itens para continuar."),o("/menu")},0);return()=>clearTimeout(r)}},[p.length,o,C,te]);const $e=Fr({mutationFn:async r=>{if(!l)throw new Error("Dados do restaurante indisponíveis.");if(r.delivery_option==="delivery"&&y)throw new Error(y);const i=[r.street,r.number,r.complement?`(${r.complement})`:null,r.neighborhood,r.city,r.zip_code].filter(Boolean).join(", "),u=r.delivery_option==="delivery"?i:"Retirada no Local";let b;const N=ur(r.phone),A=pe(r.cpf_cnpj||""),{data:ne}=await $.from("customers").select("id").eq("phone",N).limit(1).single();if(ne)b=ne.id,A&&await $.from("customers").update({cpf_cnpj:A}).eq("id",b);else{const{data:I,error:re}=await $.from("customers").insert({name:r.name,phone:N,email:r.email||null,address:u,latitude:r.latitude,longitude:r.longitude,cpf_cnpj:A||null}).select("id").single();if(re)throw new Error(`Erro ao criar cliente: ${re.message}`);b=I.id}const Te=B?"pending_payment":"pending",{data:be,error:ee}=await $.from("orders").insert({restaurant_id:l.id,customer_id:b,status:Te,total_amount:d,delivery_fee:c,notes:r.notes,delivery_address:u,payment_method_id:r.payment_method_id,change_for:Y?r.change_for:null}).select("id").single();if(ee)throw new Error(`Erro ao criar pedido: ${ee.message}`);const G=be.id,Pr=p.map(I=>({order_id:G,product_id:I.product_id,quantity:I.quantity,unit_price:I.price,subtotal:I.price*I.quantity,notes:I.notes})),{error:ze}=await $.from("order_items").insert(Pr);if(ze)throw new Error(`Erro ao adicionar itens do pedido: ${ze.message}`);if(B){g(),P(!0),j.info("Redirecionando para o pagamento online...");const I=wa(),re={orderId:G,items:p,totalAmount:parseFloat(d.toFixed(2)),restaurantName:l.name,clientUrl:I,customerEmail:r.email||"cliente@pedido123.com",customerCpfCnpj:A};console.log("Payload enviado para create-payment-preference:",re);try{const{data:T,error:qe}=await $.functions.invoke("create-payment-preference",{body:re});if(qe)throw new Error(qe.message);if(T&&T.error)throw new Error(`Mercado Pago Error: ${T.error}`);if(T&&T.init_point){window.location.href=T.init_point;return}else throw new Error("Resposta de pagamento inválida: init_point não encontrado.")}catch(T){throw console.error("Erro ao criar preferência de pagamento:",T),new Error(`Falha ao processar pagamento online: ${T.message}`)}}return G},onSuccess:r=>{B||(j.success(`Pedido #${r.slice(-4)} realizado com sucesso!`),a.invalidateQueries({queryKey:["orders"]}),localStorage.removeItem("checkoutFormData"),o(`/order-success/${r}`))},onError:r=>{let i="Ocorreu um erro ao finalizar seu pedido. Por favor, tente novamente.";const u=r.message||"";u.includes("Mercado Pago Error:")?(i=u.split("Mercado Pago Error:")[1].trim(),i.includes("access token")&&(i="O Access Token do Mercado Pago está incorreto ou ausente. Por favor, verifique as configurações do restaurante.")):u.toLowerCase().includes("access token")||u.toLowerCase().includes("credentials")?i="Ocorreu um problema com a configuração de pagamento do restaurante. Por favor, entre em contato com o estabelecimento.":u.toLowerCase().includes("fora da nossa área de entrega")?i="Seu endereço está fora da nossa área de entrega.":u.toLowerCase().includes("inconsistência no valor total")?i="Erro de cálculo no pedido. Por favor, tente limpar o carrinho e refazer o pedido.":u.toLowerCase().includes("falha ao processar pagamento online")&&(i=u.split("Falha ao processar pagamento online:")[1]||"Erro ao processar pagamento online. Por favor, tente novamente."),j.error("Falha ao processar o pagamento",{description:i,duration:1e4}),P(!1)}}),_r=async r=>{if(r.delivery_option==="delivery"&&(r.latitude===null||r.longitude===null)){s.setError("latitude",{type:"manual",message:"A localização deve ser salva no mapa para calcular a taxa de entrega."}),j.error('Por favor, clique em "Salvar Endereço" para confirmar a localização no mapa.');return}if(B){const i=r.cpf_cnpj||"",u=pe(i);if(u.length!==11&&u.length!==14){s.setError("cpf_cnpj",{type:"manual",message:"CPF/CNPJ é obrigatório para pagamento online."}),j.error("Por favor, preencha o CPF/CNPJ corretamente.");return}}if(Y){const i=r.change_for;if(i!=null&&i<d){j.error(`O valor do troco (R$ ${i.toFixed(2).replace(".",",")}) deve ser maior ou igual ao total do pedido (R$ ${d.toFixed(2).replace(".",",")}).`);return}}$e.mutate(r)},Er=r=>{Object.keys(r).length>0&&j.error("Por favor, preencha todos os campos obrigatórios e corrija os erros.")};if(p.length===0&&!C&&!te)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."});if(yr||te)return e.jsx(Kr,{});if(jr)return e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(K,{variant:"destructive",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx(U,{children:"Erro de Conexão"}),e.jsx(Z,{children:Ie instanceof Error?Ie.message:"Não foi possível carregar os dados."})]})});const ve=$e.isPending||C||S,Rr=!O||!y&&c>=0,Me=!O||k!==null&&V!==null,Ae=!ve&&Rr&&Me;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Ir,{to:"/menu",children:e.jsx(ae,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(ea,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8 max-w-6xl",children:e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(Wr,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(_r,Er),className:"space-y-6",children:[e.jsxs(le,{children:[e.jsx(ce,{children:e.jsx(de,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(ue,{className:"space-y-4",children:[e.jsx(E,{control:s.control,name:"name",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Nome Completo *"}),e.jsx(L,{placeholder:"Seu nome",...r}),e.jsx(R,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(E,{control:s.control,name:"phone",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Telefone *"}),e.jsx(cr,{...r}),e.jsx(R,{})]})}),e.jsx(E,{control:s.control,name:"email",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Email (Opcional)"}),e.jsx(L,{placeholder:"seu@email.com",...r}),e.jsx(R,{})]})})]})]})]}),e.jsxs(le,{children:[e.jsx(ce,{children:e.jsx(de,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(ue,{className:"space-y-4",children:[e.jsx(E,{control:s.control,name:"delivery_option",render:({field:r})=>e.jsxs(v,{className:"space-y-3",children:[e.jsx(W,{children:e.jsxs(Ee,{onValueChange:r.onChange,defaultValue:r.value,className:"flex flex-col space-y-1",children:[e.jsxs(v,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(W,{children:e.jsx(me,{value:"delivery"})}),e.jsx(we,{className:"h-5 w-5 text-primary"}),e.jsxs(w,{className:oe("font-normal flex-1 cursor-pointer"),children:["Delivery",M===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(v,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(W,{children:e.jsx(me,{value:"pickup"})}),e.jsx(Ze,{className:"h-5 w-5 text-primary"}),e.jsx(w,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(R,{})]})}),O&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:Cr,disabled:S,children:[e.jsx(na,{className:"h-4 w-4 mr-2"})," Salvar Endereço"]}),e.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:wr,children:[e.jsx(ta,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(E,{control:s.control,name:"street",render:({field:r})=>e.jsxs(v,{className:"col-span-2",children:[e.jsx(w,{children:"Rua *"}),e.jsx(L,{...r}),e.jsx(R,{})]})}),e.jsx(E,{control:s.control,name:"number",render:({field:r})=>e.jsxs(v,{className:"col-span-1",children:[e.jsx(w,{children:"Número *"}),e.jsx(L,{...r}),e.jsx(R,{})]})})]}),e.jsx(E,{control:s.control,name:"complement",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Complemento (Opcional)"}),e.jsx(L,{placeholder:"Apto, Bloco, Casa, etc.",...r,disabled:!1}),e.jsx(R,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(E,{control:s.control,name:"neighborhood",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Bairro *"}),e.jsx(L,{...r}),e.jsx(R,{})]})}),e.jsx(E,{control:s.control,name:"city",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Cidade *"}),e.jsx(L,{...r}),e.jsx(R,{})]})})]}),e.jsx(E,{control:s.control,name:"zip_code",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"CEP *"}),e.jsx(Xr,{...r}),e.jsx(R,{})]})}),O&&e.jsx(Fa,{markerPosition:br,onLocationChange:Nr,updateAddressFields:ye,restaurant:l}),S&&M!==!1&&e.jsxs(K,{children:[e.jsx(Ne,{className:"h-4 w-4 animate-spin"}),e.jsx(U,{children:"Calculando Taxa..."}),e.jsx(Z,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),y&&M!==!1&&e.jsxs(K,{variant:"destructive",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx(U,{children:"Erro de Entrega"}),e.jsx(Z,{children:y})]}),M===!1&&e.jsxs(K,{className:"mt-4",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(U,{children:"Taxas de Entrega Desativadas"}),e.jsx(Z,{children:"O restaurante desativou as taxas de entrega. A entrega será gratuita."})]}),c>0&&!S&&M!==!1&&e.jsxs(K,{className:"mt-4",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(U,{children:"Taxa de Entrega Aplicada"}),e.jsxs(Z,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)]})]}),O&&!Me&&e.jsxs(K,{variant:"destructive",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(U,{children:"Localização Obrigatória"}),e.jsx(Z,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(le,{children:[e.jsx(ce,{children:e.jsx(de,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(ue,{className:"space-y-4",children:[e.jsx(E,{control:s.control,name:"payment_method_id",render:({field:r})=>e.jsxs(v,{className:"space-y-3",children:[e.jsx(W,{children:e.jsx(Ee,{onValueChange:i=>{r.onChange(i);const u=J.find(b=>b.id===i);(u==null?void 0:u.name)!=="Dinheiro"&&s.setValue("change_for",null,{shouldValidate:!0}),(u==null?void 0:u.name)==="Pagamento online: Pix/Cartão"?s.trigger("cpf_cnpj"):s.clearErrors("cpf_cnpj")},defaultValue:r.value,className:"flex flex-col space-y-2",children:J.map(i=>{const u=Pa(i.icon||"Store");return e.jsxs(v,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(W,{children:e.jsx(me,{value:i.id})}),e.jsx(u,{className:"h-5 w-5 text-primary"}),e.jsxs(w,{className:"font-normal flex-1 cursor-pointer",children:[i.name,e.jsx("span",{className:"block text-xs text-muted-foreground",children:i.description})]})]},i.id)})})}),e.jsx(R,{})]})}),B&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Je,{className:"h-4 w-4"})," Detalhes Adicionais"]}),e.jsx(E,{control:s.control,name:"cpf_cnpj",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"CPF/CNPJ * (obrigatório para pagamento online)"}),e.jsx(W,{children:e.jsx(dr,{...r})}),e.jsx(R,{})]})})]}),Y&&e.jsx(E,{control:s.control,name:"change_for",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Precisa de troco para quanto? (R$)"}),e.jsx(L,{type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2}).format(d),...r,value:r.value===null||r.value===void 0?"":String(r.value),onChange:i=>{const u=i.target.value;r.onChange(u===""?null:u)}}),e.jsx(R,{})]})}),e.jsx(E,{control:s.control,name:"notes",render:({field:r})=>e.jsxs(v,{children:[e.jsx(w,{children:"Observações do Pedido (Opcional)"}),e.jsx(Qr,{placeholder:"Ex: Tocar a campainha duas vezes...",...r,rows:2}),e.jsx(R,{})]})})]})]}),e.jsx("div",{className:"lg:hidden sticky bottom-0 bg-card p-4 border-t shadow-2xl",children:e.jsx(ae,{type:"submit",className:"w-full h-12 text-lg",disabled:!Ae,children:ve?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}`})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(ae,{type:"submit",className:"w-full h-12 text-lg",disabled:!Ae,children:ve?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}`})})]})})}),e.jsx("div",{className:"lg:col-span-1 hidden lg:block",children:e.jsx(Sa,{...t})})]})})]})};export{oo as default};
