import{j as e,u as Kr,b as ie,c as Zr}from"./tanstack-QxCZ3Wpf.js";import{r as i,u as Jr,i as Hr,R as Qr,L as Qe}from"./vendor-CIxFcw7z.js";import{o as Wr,s as O,l as Xr,e as Yr,p as Se,c as We,n as es,Z as K,u as rs,t as ss}from"./types-C33Up_9v.js";import{s as k}from"./client-BskZ_u5h.js";import{c as sr,f as Le,g as ye,P as H,i as je,h as tr,l as ts,m as or,b as Oe,n as os,k as as,a as ar,u as D,v as Xe,L as Ye}from"./index-CPuB9f0O.js";import{B as X}from"./button-1ZWIUviP.js";import{C as ce,b as de,c as ue,a as me}from"./card-C3fWCbHb.js";import{I as Z}from"./label-lcYyqsqN.js";import{c as nr,R as ns,I as is,a as ls,C as cs}from"./index-DOKP_sB1.js";import{u as ds}from"./index-BvB5LvD-.js";import{u as us}from"./index-ClxNZ_uN.js";import{S as pe}from"./separator-Cv_ZaZO5.js";import{T as ms}from"./textarea-0dAbuaJR.js";import{A as Y,a as ee,b as re}from"./alert-CAfsnd2i.js";import{F as ps,b as I,c as _,a as R,e as F,d as le}from"./form-OT-VFoVm.js";import{P as hs}from"./PhoneInput-BGdSSujt.js";import{Z as fs,M as xs}from"./MapLocationSection-DHz32HHk.js";import{C as gs,a as js}from"./CustomerProfileModal-kUbv7Hka.js";import{S as ys}from"./shopping-cart-r76I8_iZ.js";import{T as Ie}from"./terminal-V9bBRNPZ.js";import{A as bs}from"./arrow-left-zvc4kINk.js";import{U as vs}from"./user-DAQ-E9_6.js";import{T as er}from"./truck-B9DPRQql.js";import{S as ir}from"./store-DLpW-JLc.js";import{M as rr}from"./map-pin-LHKlsah9.js";import{S as Ns}from"./save-BE4MJGZr.js";import{P as _s}from"./package-ByB0Khpx.js";import{C as Cs}from"./credit-card-CPTOqU5l.js";import{S as ws}from"./smartphone-BLk0y_nS.js";import{D as Rs}from"./dollar-sign-CH_JrfmO.js";import"./supabase-DGFirUEE.js";import"./dialog-BEZvn-_c.js";import"./index-C7RU0jW9.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=sr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ps=sr("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var Te="Radio",[Ss,lr]=Le(Te),[Is,Fs]=Ss(Te),cr=i.forwardRef((r,a)=>{const{__scopeRadio:o,name:m,checked:n=!1,required:d,disabled:c,value:p="on",onCheck:h,form:x,...N}=r,[j,y]=i.useState(null),b=ye(a,V=>y(V)),g=i.useRef(!1),E=j?x||!!j.closest("form"):!0;return e.jsxs(Is,{scope:o,checked:n,disabled:c,children:[e.jsx(H.button,{type:"button",role:"radio","aria-checked":n,"data-state":pr(n),"data-disabled":c?"":void 0,disabled:c,value:p,...N,ref:b,onClick:je(r.onClick,V=>{n||h==null||h(),E&&(g.current=V.isPropagationStopped(),g.current||V.stopPropagation())})}),E&&e.jsx(mr,{control:j,bubbles:!g.current,name:m,value:p,checked:n,required:d,disabled:c,form:x,style:{transform:"translateX(-100%)"}})]})});cr.displayName=Te;var dr="RadioIndicator",ur=i.forwardRef((r,a)=>{const{__scopeRadio:o,forceMount:m,...n}=r,d=Fs(dr,o);return e.jsx(tr,{present:m||d.checked,children:e.jsx(H.span,{"data-state":pr(d.checked),"data-disabled":d.disabled?"":void 0,...n,ref:a})})});ur.displayName=dr;var Vs="RadioBubbleInput",mr=i.forwardRef(({__scopeRadio:r,control:a,checked:o,bubbles:m=!0,...n},d)=>{const c=i.useRef(null),p=ye(c,d),h=us(o),x=ts(a);return i.useEffect(()=>{const N=c.current;if(!N)return;const j=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(j,"checked").set;if(h!==o&&b){const g=new Event("click",{bubbles:m});b.call(N,o),N.dispatchEvent(g)}},[h,o,m]),e.jsx(H.input,{type:"radio","aria-hidden":!0,defaultChecked:o,...n,tabIndex:-1,ref:p,style:{...n.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});mr.displayName=Vs;function pr(r){return r?"checked":"unchecked"}var ks=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],be="RadioGroup",[Ls,Dt]=Le(be,[nr,lr]),hr=nr(),fr=lr(),[Os,Ts]=Ls(be),xr=i.forwardRef((r,a)=>{const{__scopeRadioGroup:o,name:m,defaultValue:n,value:d,required:c=!1,disabled:p=!1,orientation:h,dir:x,loop:N=!0,onValueChange:j,...y}=r,b=hr(o),g=ds(x),[E,V]=or({prop:d,defaultProp:n??null,onChange:j,caller:be});return e.jsx(Os,{scope:o,name:m,required:c,disabled:p,value:E,onValueChange:V,children:e.jsx(ns,{asChild:!0,...b,orientation:h,dir:g,loop:N,children:e.jsx(H.div,{role:"radiogroup","aria-required":c,"aria-orientation":h,"data-disabled":p?"":void 0,dir:g,...y,ref:a})})})});xr.displayName=be;var gr="RadioGroupItem",jr=i.forwardRef((r,a)=>{const{__scopeRadioGroup:o,disabled:m,...n}=r,d=Ts(gr,o),c=d.disabled||m,p=hr(o),h=fr(o),x=i.useRef(null),N=ye(a,x),j=d.value===n.value,y=i.useRef(!1);return i.useEffect(()=>{const b=E=>{ks.includes(E.key)&&(y.current=!0)},g=()=>y.current=!1;return document.addEventListener("keydown",b),document.addEventListener("keyup",g),()=>{document.removeEventListener("keydown",b),document.removeEventListener("keyup",g)}},[]),e.jsx(is,{asChild:!0,...p,focusable:!c,active:j,children:e.jsx(cr,{disabled:c,required:d.required,checked:j,...h,...n,name:d.name,ref:N,onCheck:()=>d.onValueChange(n.value),onKeyDown:je(b=>{b.key==="Enter"&&b.preventDefault()}),onFocus:je(n.onFocus,()=>{var b;y.current&&((b=x.current)==null||b.click())})})})});jr.displayName=gr;var As="RadioGroupIndicator",yr=i.forwardRef((r,a)=>{const{__scopeRadioGroup:o,...m}=r,n=fr(o);return e.jsx(ur,{...n,...m,ref:a})});yr.displayName=As;var br=xr,vr=jr,Ds=yr;const Fe=i.forwardRef(({className:r,...a},o)=>e.jsx(br,{className:Oe("grid gap-2",r),...a,ref:o}));Fe.displayName=br.displayName;const ge=i.forwardRef(({className:r,...a},o)=>e.jsx(vr,{ref:o,className:Oe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(Ds,{className:"flex items-center justify-center",children:e.jsx(Es,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ge.displayName=vr.displayName;const Ms=(r,a,o,m)=>{const d=(o-r)*(Math.PI/180),c=(m-a)*(Math.PI/180),p=Math.sin(d/2)*Math.sin(d/2)+Math.cos(r*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))},qs=async r=>{const a=r.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,m=new AbortController,n=setTimeout(()=>m.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const d=await fetch(o,{signal:m.signal});if(!d.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",d.status),null;const c=await d.json();if(c&&Array.isArray(c)&&c.length>0){const p=c[0],h=parseFloat(p.lat),x=parseFloat(p.lon);if(Number.isFinite(h)&&Number.isFinite(x))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[h,x]),{lat:h,lng:x}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(d){return d instanceof Error&&d.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",d),null}finally{clearTimeout(n)}},$s=(r,a,o)=>{const m=Ms(a[0],a[1],r[0],r[1]),n=o.find(d=>m<=d.max_distance_km);if(n){const d=n.delivery_fee||0,c=n.min_delivery_time_minutes||0,p=c+15;return{fee:parseFloat(d.toFixed(2)),minTime:c,maxTime:p}}return null};var ve="Collapsible",[Gs,Mt]=Le(ve),[zs,Ae]=Gs(ve),Nr=i.forwardRef((r,a)=>{const{__scopeCollapsible:o,open:m,defaultOpen:n,disabled:d,onOpenChange:c,...p}=r,[h,x]=or({prop:m,defaultProp:n??!1,onChange:c,caller:ve});return e.jsx(zs,{scope:o,disabled:d,contentId:os(),open:h,onOpenToggle:i.useCallback(()=>x(N=>!N),[x]),children:e.jsx(H.div,{"data-state":Me(h),"data-disabled":d?"":void 0,...p,ref:a})})});Nr.displayName=ve;var _r="CollapsibleTrigger",Cr=i.forwardRef((r,a)=>{const{__scopeCollapsible:o,...m}=r,n=Ae(_r,o);return e.jsx(H.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":Me(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...m,ref:a,onClick:je(r.onClick,n.onOpenToggle)})});Cr.displayName=_r;var De="CollapsibleContent",wr=i.forwardRef((r,a)=>{const{forceMount:o,...m}=r,n=Ae(De,r.__scopeCollapsible);return e.jsx(tr,{present:o||n.open,children:({present:d})=>e.jsx(Bs,{...m,ref:a,present:d})})});wr.displayName=De;var Bs=i.forwardRef((r,a)=>{const{__scopeCollapsible:o,present:m,children:n,...d}=r,c=Ae(De,o),[p,h]=i.useState(m),x=i.useRef(null),N=ye(a,x),j=i.useRef(0),y=j.current,b=i.useRef(0),g=b.current,E=c.open||p,V=i.useRef(E),T=i.useRef(void 0);return i.useEffect(()=>{const w=requestAnimationFrame(()=>V.current=!1);return()=>cancelAnimationFrame(w)},[]),as(()=>{const w=x.current;if(w){T.current=T.current||{transitionDuration:w.style.transitionDuration,animationName:w.style.animationName},w.style.transitionDuration="0s",w.style.animationName="none";const se=w.getBoundingClientRect();j.current=se.height,b.current=se.width,V.current||(w.style.transitionDuration=T.current.transitionDuration,w.style.animationName=T.current.animationName),h(m)}},[c.open,m]),e.jsx(H.div,{"data-state":Me(c.open),"data-disabled":c.disabled?"":void 0,id:c.contentId,hidden:!E,...d,ref:N,style:{"--radix-collapsible-content-height":y?`${y}px`:void 0,"--radix-collapsible-content-width":g?`${g}px`:void 0,...r.style},children:E&&n})});function Me(r){return r?"open":"closed"}var Us=Nr;const Ks=Us,Zs=Cr,Js=wr,Hs=()=>{const{items:r,subtotal:a,deliveryFee:o,total:m,totalItems:n}=ar(),[d,c]=i.useState(!1);return n===0?null:e.jsxs(Ks,{open:d,onOpenChange:c,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Zs,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ys,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m)}),d?e.jsx(ls,{className:"h-5 w-5"}):e.jsx(cs,{className:"h-5 w-5"})]})]})}),e.jsxs(Js,{className:"p-4 pt-0",children:[e.jsx(pe,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:r.map(p=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[p.quantity,"x ",p.name,p.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",p.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(p.price*p.quantity)})]},p.id))}),e.jsx(pe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(pe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m)})]})]})]})]})},Ve=r=>r.replace(/\D/g,""),Rr=r=>r.replace(/\D/g,""),ke=r=>r.replace(/\D/g,""),Qs=Wr({name:O().min(1,"Nome é obrigatório."),phone:O().min(1,"Telefone é obrigatório.").transform(Ve).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:O().email("Email inválido.").optional().or(Xr("")),delivery_option:Yr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:O().optional().default(""),number:O().optional().default(""),complement:O().optional().default(""),neighborhood:O().optional().default(""),city:O().optional().default(""),zip_code:O().optional().default("").transform(Rr).refine(r=>r.length===8||r.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Se(r=>typeof r=="string"?parseFloat(r):r,We.number().optional().nullable()),longitude:Se(r=>typeof r=="string"?parseFloat(r):r,We.number().optional().nullable()),payment_method_id:O().min(1,"Selecione uma forma de pagamento."),notes:O().optional(),cpf_cnpj:O().optional().default("").transform(ke).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Se(r=>{if(r==null||r==="")return null;const a=String(r).replace(",","."),o=parseFloat(a);return isNaN(o)?a:o},es({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((r,a)=>{if(r.delivery_option==="delivery"?(r.street.trim()===""&&a.addIssue({code:K.custom,message:"Rua é obrigatória.",path:["street"]}),r.number.trim()===""&&a.addIssue({code:K.custom,message:"Número é obrigatório.",path:["number"]}),r.neighborhood.trim()===""&&a.addIssue({code:K.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),r.city.trim()===""&&a.addIssue({code:K.custom,message:"Cidade é obrigatória.",path:["city"]}),r.zip_code.length!==8&&a.addIssue({code:K.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(r.latitude===null||r.longitude===null)&&a.addIssue({code:K.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})):r.latitude!==null||r.longitude,r.payment_method_id==="Dinheiro"&&r.change_for!==null&&r.change_for!==void 0&&r.change_for<=0&&a.addIssue({code:K.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),r.payment_method_id==="Pagamento online: Pix/Cartão"){const n=ke(r.cpf_cnpj||"");n.length!==11&&n.length!==14&&a.addIssue({code:K.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Ws=()=>{const r=window.location.origin,o=window.location.pathname.split("/")[1];return o?`${r}/${o}`:r},Xs=async()=>{const{data:r,error:a}=await k.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(a)throw new Error(`Erro ao buscar restaurante: ${a.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},Ys=async r=>{const{data:a,error:o}=await k.from("restaurants").select("delivery_enabled").eq("id",r).single();if(o)throw new Error(`Erro ao buscar status de entrega: ${o.message}`);return a.delivery_enabled??!0},et=async r=>{const{data:a,error:o}=await k.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(o)throw new Error(`Erro ao buscar métodos de pagamento: ${o.message}`);return a},rt=async r=>{const{data:a,error:o}=await k.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(o)throw new Error(`Erro ao buscar zonas de entrega: ${o.message}`);return a},st=async()=>{const{data:{user:r}}=await k.auth.getUser();if(!r)return null;const{data:a,error:o}=await k.from("customers").select("*").eq("user_id",r.id).limit(1).single();if(o&&o.code!=="PGRST116")throw new Error(`Erro ao buscar dados do cliente: ${o.message}`);if(a)return a;const m=r.user_metadata;return{id:r.id,user_id:r.id,name:m.full_name||"",phone:m.phone||"",email:r.email||"",address:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),latitude:null,longitude:null,cpf_cnpj:null}},tt=r=>{switch(r){case"DollarSign":return Rs;case"Smartphone":return ws;case"CreditCard":return Cs;case"Package":return _s;default:return ir}},ot=({subtotal:r,deliveryFee:a,total:o,items:m})=>e.jsxs(ce,{className:"sticky top-4",children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(me,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(pe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(pe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]})]})]}),qt=()=>{Ws();const r=Jr();Kr();const a=ar(),{items:o,subtotal:m,deliveryFee:n,total:d,setDeliveryFee:c,clearCart:p}=a,[h]=Hr(),[x,N]=i.useState(!1),[j,y]=i.useState(null),[b,g]=i.useState(null),[E,V]=i.useState(null),T=Qr.useRef(!1),[w,se]=i.useState(!1),[Er,qe]=i.useState(!1),te=h.get("status"),Ne=h.get("external_reference"),$e=h.has("collection_id")||h.has("external_reference");i.useEffect(()=>{if(Ne)if(te==="approved"||te==="failure"||te==="pending"){r(`/order-success/${Ne}?status=${te}`,{replace:!0});return}else $e&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),se(!1));else se(!1)},[Ne,te,$e,r]);const{data:u,isLoading:Pr,isError:Sr,error:Ir}=ie({queryKey:["checkoutRestaurantData"],queryFn:Xs}),{data:$,isLoading:_e}=ie({queryKey:["deliveryStatus",u==null?void 0:u.id],queryFn:()=>Ys(u.id),enabled:!!(u!=null&&u.id)}),{data:Q=[],isLoading:Fr}=ie({queryKey:["checkoutPaymentMethods",u==null?void 0:u.id],queryFn:()=>et(u.id),enabled:!!(u!=null&&u.id)}),{data:Ge=[],isLoading:Vr}=ie({queryKey:["checkoutDeliveryZones",u==null?void 0:u.id],queryFn:()=>rt(u.id),enabled:!!(u!=null&&u.id)}),{data:G,isLoading:kr}=ie({queryKey:["checkoutCustomerData"],queryFn:st,staleTime:0}),Lr=Pr||_e||Fr||Vr||kr,Or=Sr,ze=Ir,t=rs({resolver:ss(Qs),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"});i.useEffect(()=>{if(G){const s=Ve(G.phone||""),l=localStorage.getItem("checkoutFormData");let f={};if(l)try{f=JSON.parse(l)}catch(v){console.error("Failed to parse local storage data",v)}t.reset({...t.getValues(),...f,name:G.name||"",phone:s,email:G.email||"",cpf_cnpj:G.cpf_cnpj||""})}},[G,t]);const q=t.watch("delivery_option"),Ce=t.watch("payment_method_id"),W=Q.find(s=>s.id===Ce),he=(W==null?void 0:W.name)==="Pagamento online: Pix/Cartão",fe=(W==null?void 0:W.name)==="Dinheiro",P=t.watch("latitude"),S=t.watch("longitude");t.watch(["street","number","neighborhood","city","zip_code"]);const z=q==="delivery",Tr=i.useMemo(()=>JSON.stringify({deliveryOption:q,deliveryEnabled:$,lat:P,lng:S}),[q,$,P,S]),Ar=i.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:u!=null&&u.latitude&&(u!=null&&u.longitude)?[u.latitude,u.longitude]:[-23.55052,-46.633308],[P,S,u]),Dr=i.useMemo(()=>P===null||S===null?`map-${q}-null`:`map-${q}-${P.toFixed(6)}-${S.toFixed(6)}`,[z,q,P,S]),we=i.useCallback(s=>{const l=s.road||s.logradouro||"",f=s.house_number||"",v=s.suburb||s.bairro||"",C=s.city||s.localidade||"",B=s.postcode||s.cep||"";t.setValue("street",l,{shouldValidate:!0}),t.setValue("number",f||"",{shouldValidate:!0}),t.setValue("complement",s.suburb||"",{shouldValidate:!0}),t.setValue("neighborhood",v,{shouldValidate:!0}),t.setValue("city",C,{shouldValidate:!0}),t.setValue("zip_code",B,{shouldValidate:!0})},[t]),Mr=i.useCallback(async(s,l)=>{t.setValue("latitude",s,{shouldValidate:!0}),t.setValue("longitude",l,{shouldValidate:!0});const f=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${l}&addressdetails=1`,v=await fetch(f);if(v.ok){const C=await v.json();C.address&&we(C.address)}},[t,we]),qr=i.useCallback(()=>{t.setValue("street","",{shouldValidate:!0}),t.setValue("number","",{shouldValidate:!0}),t.setValue("complement","",{shouldValidate:!0}),t.setValue("neighborhood","",{shouldValidate:!0}),t.setValue("city","",{shouldValidate:!0}),t.setValue("zip_code","",{shouldValidate:!0}),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),c(0),y(null),g(null),D.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[t,c]),Re=i.useCallback(s=>{try{const l={name:s.name,phone:s.phone,email:s.email,delivery_option:s.delivery_option,street:s.street,number:s.number,complement:s.complement,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code,latitude:s.latitude,longitude:s.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(l))}catch(l){console.error("Failed to save form data to local storage",l)}},[]),Be=i.useCallback(()=>{try{const s=localStorage.getItem("checkoutFormData");if(s){const l=JSON.parse(s);t.reset({...t.getValues(),...l,delivery_option:l.delivery_option||"delivery"})}}catch(s){console.error("Failed to load form data from local storage",s)}},[t]);i.useEffect(()=>{Be()},[Be]),i.useEffect(()=>{const s=t.watch(l=>{Re(l)});return()=>s.unsubscribe()},[t,Re]);const $r=()=>{if(T.current)return;V(null),T.current=!0;const s=D.loading("Buscando endereço e coordenadas...");Promise.resolve().then(async()=>{try{const l=t.getValues(),[f,v,C,B,J]=[l.street,l.number,l.neighborhood,l.city,l.zip_code],ae=Rr(J);if(!(f&&v&&C&&B&&ae.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),t.trigger(["street","number","neighborhood","city","zip_code","zip_code"]),D.error("Preencha todos os campos de endereço obrigatórios.");return}console.log("LOG: Iniciando geocodificação para:",`${f}, ${v}, ${C}, ${B}, ${J}`);const xe=`${f}, ${v}, ${C}, ${B}, ${J}`,U=await qs(xe);U?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",U),t.setValue("latitude",U.lat,{shouldValidate:!0}),t.setValue("longitude",U.lng,{shouldValidate:!0}),Re(t.getValues()),D.success("Endereço e mapa atualizados com sucesso!")):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),V("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),D.warning("Endereço não encontrado. Ajuste manualmente no mapa ou verifique os dados."))}catch(l){console.error("LOG: Erro capturado durante a geocodificação:",l),V(`Erro ao buscar coordenadas: ${l.message}`),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),D.error(`Erro na busca: ${l.message}`)}finally{T.current=!1,D.dismiss(s)}}).catch(l=>{console.error("LOG: Erro nao capturado:",l),T.current=!1,D.dismiss(s)})};i.useEffect(()=>{fe||t.setValue("change_for",null,{shouldValidate:!0})},[fe,t]),i.useEffect(()=>{q==="pickup"&&(c(0),y(null),g(null),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}))},[q,z,t,c,P,S]),i.useEffect(()=>{Q.length>0&&!Ce&&t.setValue("payment_method_id",Q[0].id)},[Q,Ce,t]),i.useEffect(()=>{he?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},[he,t]),i.useEffect(()=>{const s=async()=>{if(q==="pickup"||!(u!=null&&u.latitude)||!(u!=null&&u.longitude)){c(0),y(null),g(null);return}if(_e)return;if($===!1){c(0),y(null),g(null),N(!1);return}N(!0),y(null);let f=null;if(P&&S)f=[P,S];else{c(0),g(null),N(!1);return}if(f){const v=[u.latitude,u.longitude],C=$s(f,v,Ge);C?(c(C.fee),y(null),g({minTime:C.minTime,maxTime:C.maxTime})):(c(0),y("Seu endereço está fora da nossa área de entrega."),g(null))}N(!1)},l=setTimeout(()=>{s()},500);return()=>clearTimeout(l)},[Tr,u,Ge,t,c,z,P,S,$,_e]);const oe=Zr({mutationFn:async s=>{if(!u)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&j)throw new Error(j);const l=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),f=s.delivery_option==="delivery"?l:"Retirada no Local";let v;const C=Ve(s.phone),B=ke(s.cpf_cnpj||""),{data:{user:J}}=await k.auth.getUser(),ae=(J==null?void 0:J.id)||null;if(!ae)throw new Error("Autenticação necessária. Por favor, faça login para finalizar o pedido.");const{data:Pe}=await k.from("customers").select("id, user_id, name, cpf_cnpj").eq("user_id",ae).limit(1).single();if(Pe){v=Pe.id;const L={name:s.name,phone:C,email:s.email||null,cpf_cnpj:B||null},{error:M}=await k.from("customers").update(L).eq("id",v);if(M)throw new Error(`Erro ao atualizar cliente existente: ${M.message}`)}else{const L={name:s.name,phone:C,email:s.email||null,address:f,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:B||null,user_id:ae},{data:M,error:A}=await k.from("customers").insert(L).select("id").single();if(A)throw new Error(`Erro ao criar cliente: ${A.message}`);v=M.id}const xe=he?"pending_payment":"pending",{data:U,error:Ze}=await k.from("orders").insert({restaurant_id:u.id,customer_id:v,status:xe,total_amount:d,delivery_fee:n,notes:s.notes,delivery_address:f,payment_method_id:s.payment_method_id,change_for:fe?s.change_for:null}).select("id").single();if(Ze)throw new Error(`Erro ao criar pedido: ${Ze.message}`);const Ur=o.map(L=>{const M=Number(L.quantity),A=Number(L.price),ne={order_id:U.id,product_id:L.product_id,quantity:M,unit_price:A,subtotal:M*A};return L.notes&&L.notes.trim()&&(ne.notes=L.notes.trim()),ne}),{error:Je}=await k.from("order_items").insert(Ur);if(Je){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Je);const L=o.map(A=>{const ne=Number(A.quantity),He=Number(A.price);return{order_id:U.id,quantity:ne,unit_price:He,subtotal:ne*He,notes:A.notes&&A.notes.trim()?A.notes.trim():null}}),{error:M}=await k.from("order_items").insert(L);if(M)throw new Error(`Erro ao adicionar itens do pedido: ${M.message}`)}return{orderId:U.id,orderStatus:xe}},onSuccess:s=>{const l=s.orderStatus==="pending_payment"?`/payment/${s.orderId}`:`/order-success/${s.orderId}`;t.reset(),localStorage.removeItem("checkoutFormData"),setTimeout(()=>{r(l,{replace:!0})},100)},onError:s=>{console.error("LOG: Erro ao processar pedido:",s),D.error("Falha ao finalizar pedido.",{description:s.message||"Ocorreu um erro desconhecido. Verifique o console para detalhes.",duration:1e4})}}),Gr=async s=>{if(!await t.trigger()){Ue(t.formState.errors);return}if(s.delivery_option==="delivery"&&j){D.error("Não é possível finalizar o pedido.",{description:j});return}oe.mutate(s)},Ue=s=>{console.error("Validation errors:",s);const l=Object.keys(s)[0];l&&D.error("Preencha todos os campos obrigatórios.",{description:`Erro no campo: ${l}.`})},Ke=oe.isPending||x,zr=!z||!j&&n>=0,Ee=!z||P!==null&&S!==null,Br=!Ke&&zr&&Ee;return i.useEffect(()=>{if(o.length===0&&!oe.isPending&&!w){const s=setTimeout(()=>{r("/menu",{replace:!0})},100);return()=>clearTimeout(s)}},[o.length,oe.isPending,w,r]),o.length===0&&!oe.isPending&&!w?e.jsx(Xe,{}):Lr||w?e.jsx(Xe,{}):Or?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(Y,{variant:"destructive",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(ee,{children:"Erro de Conexão"}),e.jsx(re,{children:ze instanceof Error?ze.message:"Não foi possível carregar os dados."})]})}):e.jsxs(e.Fragment,{children:[e.jsx(gs,{isOpen:Er,onClose:()=>qe(!1),customer:G}),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Qe,{to:"/menu",children:e.jsx(X,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(bs,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]}),G&&e.jsx(X,{variant:"outline",size:"icon",onClick:()=>qe(!0),"aria-label":"Editar Perfil",children:e.jsx(vs,{className:"h-5 w-5"})})]})}),e.jsx("div",{children:e.jsx(Hs,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ps,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(Gr,Ue),className:"space-y-6",children:[e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(me,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"name",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Nome Completo *"}),e.jsx(Z,{placeholder:"Seu nome",...s}),e.jsx(F,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"phone",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Telefone *"}),e.jsx(hs,{...s}),e.jsx(F,{})]})}),e.jsx(I,{control:t.control,name:"email",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Email (Opcional)"}),e.jsx(Z,{placeholder:"seu@email.com",...s}),e.jsx(F,{})]})})]})]})]}),e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(me,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"delivery_option",render:({field:s})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(le,{children:e.jsxs(Fe,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(le,{children:e.jsx(ge,{value:"delivery"})}),e.jsx(er,{className:"h-5 w-5 text-primary"}),e.jsxs(R,{className:Oe("font-normal flex-1 cursor-pointer"),children:["Delivery",$===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(le,{children:e.jsx(ge,{value:"pickup"})}),e.jsx(ir,{className:"h-5 w-5 text-primary"}),e.jsx(R,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(F,{})]})}),z&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(rr,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(X,{type:"button",variant:"outline",size:"sm",onClick:s=>{s.preventDefault(),$r()},disabled:x||T.current,children:[e.jsx(Ns,{className:"h-4 w-4 mr-2"})," ",x||T.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(X,{type:"button",variant:"outline",size:"sm",onClick:qr,children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:t.control,name:"street",render:({field:s})=>e.jsxs(_,{className:"col-span-2",children:[e.jsx(R,{children:"Rua *"}),e.jsx(Z,{...s}),e.jsx(F,{})]})}),e.jsx(I,{control:t.control,name:"number",render:({field:s})=>e.jsxs(_,{className:"col-span-1",children:[e.jsx(R,{children:"Número *"}),e.jsx(Z,{...s}),e.jsx(F,{})]})})]}),e.jsx(I,{control:t.control,name:"complement",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Complemento (Opcional)"}),e.jsx(Z,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(F,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"neighborhood",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Bairro *"}),e.jsx(Z,{...s}),e.jsx(F,{})]})}),e.jsx(I,{control:t.control,name:"city",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Cidade *"}),e.jsx(Z,{...s}),e.jsx(F,{})]})})]}),e.jsx(I,{control:t.control,name:"zip_code",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"CEP *"}),e.jsx(fs,{...s}),e.jsx(F,{})]})}),z&&Ee&&e.jsx("div",{children:e.jsx(xs,{mapKey:Dr,markerPosition:Ar,onLocationChange:Mr,updateAddressFields:we,restaurant:u})}),x&&$!==!1&&e.jsxs(Y,{children:[e.jsx(Ye,{className:"h-4 w-4 animate-spin"}),e.jsx(ee,{children:"Calculando Taxa..."}),e.jsx(re,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),j&&$!==!1&&e.jsxs(Y,{variant:"destructive",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(ee,{children:"Erro de Entrega"}),e.jsx(re,{children:j})]}),n>0&&!x&&$!==!1&&e.jsxs(Y,{className:"mt-4",children:[e.jsx(er,{className:"h-4 w-4"}),e.jsx(ee,{children:"Taxa de Entrega Aplicada"}),e.jsxs(re,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n)]})]}),E&&e.jsxs(Y,{variant:"destructive",className:"mt-4",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(ee,{children:"Erro ao Buscar Endereço"}),e.jsx(re,{children:E})]}),z&&!Ee&&!E&&e.jsxs(Y,{variant:"destructive",children:[e.jsx(rr,{className:"h-4 w-4"}),e.jsx(ee,{children:"Localização Obrigatória"}),e.jsx(re,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(me,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"payment_method_id",render:({field:s})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(le,{children:e.jsx(Fe,{onValueChange:l=>{s.onChange(l);const f=Q.find(v=>v.id===l);(f==null?void 0:f.name)!=="Dinheiro"&&t.setValue("change_for",null,{shouldValidate:!0}),(f==null?void 0:f.name)==="Pagamento online: Pix/Cartão"?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:Q.map(l=>{const f=tt(l.icon||"Store");return e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(le,{children:e.jsx(ge,{value:l.id})}),e.jsx(f,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(R,{className:"font-normal cursor-pointer",children:l.name}),l.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description})]})]},l.id)})})}),e.jsx(F,{})]})}),fe&&e.jsx(I,{control:t.control,name:"change_for",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Troco para (Opcional)"}),e.jsx(Z,{type:"number",placeholder:"Ex: 50.00",...s,value:s.value||"",onChange:l=>s.onChange(l.target.value?parseFloat(l.target.value):null)}),e.jsx(F,{})]})}),he&&e.jsx(I,{control:t.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"CPF/CNPJ *"}),e.jsx(js,{...s}),e.jsx(F,{})]})})]})]}),e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"4. Observações"})}),e.jsx(me,{children:e.jsx(I,{control:t.control,name:"notes",render:({field:s})=>e.jsxs(_,{children:[e.jsx(R,{children:"Observações do Pedido (Opcional)"}),e.jsx(ms,{placeholder:"Ex: Sem cebola, sem alface...",...s}),e.jsx(F,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Qe,{to:"/menu",className:"flex-1",children:e.jsx(X,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(X,{type:"submit",className:"flex-1",disabled:!Br,size:"lg",children:Ke?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(ot,{subtotal:m,deliveryFee:n,total:d,items:o})})]})]})]})]})};export{qt as default};
