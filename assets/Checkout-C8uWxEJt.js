import{j as e,u as Jr,b as ie,c as Hr}from"./tanstack-QxCZ3Wpf.js";import{r as i,u as Qr,i as Wr,R as Xr,L as We}from"./vendor-CIxFcw7z.js";import{o as Yr,s as T,l as es,e as rs,p as Se,c as Xe,n as ss,Z as K,u as ts,t as os}from"./types-C33Up_9v.js";import{s as F}from"./client-BskZ_u5h.js";import{c as tr,f as Le,g as je,P as W,i as ye,h as or,l as as,m as ar,b as Oe,n as ns,k as is,a as nr,u as L,v as Ye,L as er}from"./index-Bw88mmh7.js";import{B as Q}from"./button-CaK9rN5p.js";import{C as ce,b as de,c as ue,a as me}from"./card-Cf4OiIKP.js";import{I as Z}from"./label-Cii9FMiu.js";import{c as ir,R as ls,I as cs,a as ds,C as us}from"./index-BTcORWfT.js";import{u as ms}from"./index-BvB5LvD-.js";import{u as ps}from"./index-ClxNZ_uN.js";import{S as pe}from"./separator-B-ELBSYL.js";import{T as hs}from"./textarea-B3mfM8M4.js";import{A as ee,a as re,b as se}from"./alert-CI1xVgq5.js";import{F as fs,b as I,c as _,a as E,e as V,d as le}from"./form-CK3pYmjB.js";import{P as xs}from"./PhoneInput-ReCwNo7e.js";import{Z as gs,M as ys}from"./MapLocationSection-DN5UssYv.js";import{C as js,L as bs,a as vs}from"./CustomerProfileModal-CG2u4-D8.js";import{S as Ns}from"./shopping-cart-CdmfqQp8.js";import{T as Ie}from"./terminal-CjNP_fdb.js";import{A as Cs}from"./arrow-left-CJZ5JYnm.js";import{U as _s}from"./user-D2Ijq5iF.js";import{T as rr}from"./truck-Cl3RGBQm.js";import{S as lr}from"./store-BguYPimL.js";import{M as sr}from"./map-pin-eG0ljB30.js";import{S as ws}from"./save-Dur0GQR0.js";import{P as Rs}from"./package-BS3c0_3j.js";import{C as Es}from"./credit-card-C8YHoZMm.js";import{S as Ps}from"./smartphone-BI6JEJYn.js";import{D as Ss}from"./dollar-sign-NNtvPKt6.js";import"./supabase-DGFirUEE.js";import"./dialog-C_r7sAfS.js";import"./index-BUlZrBRB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=tr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vs=tr("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var Te="Radio",[Fs,cr]=Le(Te),[ks,Ls]=Fs(Te),dr=i.forwardRef((s,a)=>{const{__scopeRadio:o,name:d,checked:n=!1,required:c,disabled:p,value:m="on",onCheck:g,form:x,...y}=s,[v,j]=i.useState(null),h=je(a,k=>j(k)),R=i.useRef(!1),N=v?x||!!v.closest("form"):!0;return e.jsxs(ks,{scope:o,checked:n,disabled:p,children:[e.jsx(W.button,{type:"button",role:"radio","aria-checked":n,"data-state":hr(n),"data-disabled":p?"":void 0,disabled:p,value:m,...y,ref:h,onClick:ye(s.onClick,k=>{n||g==null||g(),N&&(R.current=k.isPropagationStopped(),R.current||k.stopPropagation())})}),N&&e.jsx(pr,{control:v,bubbles:!R.current,name:d,value:m,checked:n,required:c,disabled:p,form:x,style:{transform:"translateX(-100%)"}})]})});dr.displayName=Te;var ur="RadioIndicator",mr=i.forwardRef((s,a)=>{const{__scopeRadio:o,forceMount:d,...n}=s,c=Ls(ur,o);return e.jsx(or,{present:d||c.checked,children:e.jsx(W.span,{"data-state":hr(c.checked),"data-disabled":c.disabled?"":void 0,...n,ref:a})})});mr.displayName=ur;var Os="RadioBubbleInput",pr=i.forwardRef(({__scopeRadio:s,control:a,checked:o,bubbles:d=!0,...n},c)=>{const p=i.useRef(null),m=je(p,c),g=ps(o),x=as(a);return i.useEffect(()=>{const y=p.current;if(!y)return;const v=window.HTMLInputElement.prototype,h=Object.getOwnPropertyDescriptor(v,"checked").set;if(g!==o&&h){const R=new Event("click",{bubbles:d});h.call(y,o),y.dispatchEvent(R)}},[g,o,d]),e.jsx(W.input,{type:"radio","aria-hidden":!0,defaultChecked:o,...n,tabIndex:-1,ref:m,style:{...n.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});pr.displayName=Os;function hr(s){return s?"checked":"unchecked"}var Ts=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],be="RadioGroup",[As,$t]=Le(be,[ir,cr]),fr=ir(),xr=cr(),[Ds,qs]=As(be),gr=i.forwardRef((s,a)=>{const{__scopeRadioGroup:o,name:d,defaultValue:n,value:c,required:p=!1,disabled:m=!1,orientation:g,dir:x,loop:y=!0,onValueChange:v,...j}=s,h=fr(o),R=ms(x),[N,k]=ar({prop:c,defaultProp:n??null,onChange:v,caller:be});return e.jsx(Ds,{scope:o,name:d,required:p,disabled:m,value:N,onValueChange:k,children:e.jsx(ls,{asChild:!0,...h,orientation:g,dir:R,loop:y,children:e.jsx(W.div,{role:"radiogroup","aria-required":p,"aria-orientation":g,"data-disabled":m?"":void 0,dir:R,...j,ref:a})})})});gr.displayName=be;var yr="RadioGroupItem",jr=i.forwardRef((s,a)=>{const{__scopeRadioGroup:o,disabled:d,...n}=s,c=qs(yr,o),p=c.disabled||d,m=fr(o),g=xr(o),x=i.useRef(null),y=je(a,x),v=c.value===n.value,j=i.useRef(!1);return i.useEffect(()=>{const h=N=>{Ts.includes(N.key)&&(j.current=!0)},R=()=>j.current=!1;return document.addEventListener("keydown",h),document.addEventListener("keyup",R),()=>{document.removeEventListener("keydown",h),document.removeEventListener("keyup",R)}},[]),e.jsx(cs,{asChild:!0,...m,focusable:!p,active:v,children:e.jsx(dr,{disabled:p,required:c.required,checked:v,...g,...n,name:c.name,ref:y,onCheck:()=>c.onValueChange(n.value),onKeyDown:ye(h=>{h.key==="Enter"&&h.preventDefault()}),onFocus:ye(n.onFocus,()=>{var h;j.current&&((h=x.current)==null||h.click())})})})});jr.displayName=yr;var Ms="RadioGroupIndicator",br=i.forwardRef((s,a)=>{const{__scopeRadioGroup:o,...d}=s,n=xr(o);return e.jsx(mr,{...n,...d,ref:a})});br.displayName=Ms;var vr=gr,Nr=jr,$s=br;const Ve=i.forwardRef(({className:s,...a},o)=>e.jsx(vr,{className:Oe("grid gap-2",s),...a,ref:o}));Ve.displayName=vr.displayName;const ge=i.forwardRef(({className:s,...a},o)=>e.jsx(Nr,{ref:o,className:Oe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...a,children:e.jsx($s,{className:"flex items-center justify-center",children:e.jsx(Is,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ge.displayName=Nr.displayName;const Gs=(s,a,o,d)=>{const c=(o-s)*(Math.PI/180),p=(d-a)*(Math.PI/180),m=Math.sin(c/2)*Math.sin(c/2)+Math.cos(s*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(p/2)*Math.sin(p/2);return 6371*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))},zs=async s=>{const a=s.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,d=new AbortController,n=setTimeout(()=>d.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const c=await fetch(o,{signal:d.signal});if(!c.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",c.status),null;const p=await c.json();if(p&&Array.isArray(p)&&p.length>0){const m=p[0],g=parseFloat(m.lat),x=parseFloat(m.lon);if(Number.isFinite(g)&&Number.isFinite(x))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[g,x]),{lat:g,lng:x}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(c){return c instanceof Error&&c.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",c),null}finally{clearTimeout(n)}},Bs=(s,a,o)=>{const d=Gs(a[0],a[1],s[0],s[1]),n=o.find(c=>d<=c.max_distance_km);if(n){const c=n.delivery_fee||0,p=n.min_delivery_time_minutes||0,m=p+15;return{fee:parseFloat(c.toFixed(2)),minTime:p,maxTime:m}}return null};var ve="Collapsible",[Us,Gt]=Le(ve),[Ks,Ae]=Us(ve),Cr=i.forwardRef((s,a)=>{const{__scopeCollapsible:o,open:d,defaultOpen:n,disabled:c,onOpenChange:p,...m}=s,[g,x]=ar({prop:d,defaultProp:n??!1,onChange:p,caller:ve});return e.jsx(Ks,{scope:o,disabled:c,contentId:ns(),open:g,onOpenToggle:i.useCallback(()=>x(y=>!y),[x]),children:e.jsx(W.div,{"data-state":qe(g),"data-disabled":c?"":void 0,...m,ref:a})})});Cr.displayName=ve;var _r="CollapsibleTrigger",wr=i.forwardRef((s,a)=>{const{__scopeCollapsible:o,...d}=s,n=Ae(_r,o);return e.jsx(W.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":qe(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...d,ref:a,onClick:ye(s.onClick,n.onOpenToggle)})});wr.displayName=_r;var De="CollapsibleContent",Rr=i.forwardRef((s,a)=>{const{forceMount:o,...d}=s,n=Ae(De,s.__scopeCollapsible);return e.jsx(or,{present:o||n.open,children:({present:c})=>e.jsx(Zs,{...d,ref:a,present:c})})});Rr.displayName=De;var Zs=i.forwardRef((s,a)=>{const{__scopeCollapsible:o,present:d,children:n,...c}=s,p=Ae(De,o),[m,g]=i.useState(d),x=i.useRef(null),y=je(a,x),v=i.useRef(0),j=v.current,h=i.useRef(0),R=h.current,N=p.open||m,k=i.useRef(N),M=i.useRef(void 0);return i.useEffect(()=>{const C=requestAnimationFrame(()=>k.current=!1);return()=>cancelAnimationFrame(C)},[]),is(()=>{const C=x.current;if(C){M.current=M.current||{transitionDuration:C.style.transitionDuration,animationName:C.style.animationName},C.style.transitionDuration="0s",C.style.animationName="none";const J=C.getBoundingClientRect();v.current=J.height,h.current=J.width,k.current||(C.style.transitionDuration=M.current.transitionDuration,C.style.animationName=M.current.animationName),g(d)}},[p.open,d]),e.jsx(W.div,{"data-state":qe(p.open),"data-disabled":p.disabled?"":void 0,id:p.contentId,hidden:!N,...c,ref:y,style:{"--radix-collapsible-content-height":j?`${j}px`:void 0,"--radix-collapsible-content-width":R?`${R}px`:void 0,...s.style},children:N&&n})});function qe(s){return s?"open":"closed"}var Js=Cr;const Hs=Js,Qs=wr,Ws=Rr,Xs=()=>{const{items:s,subtotal:a,deliveryFee:o,total:d,totalItems:n}=nr(),[c,p]=i.useState(!1);return n===0?null:e.jsxs(Hs,{open:c,onOpenChange:p,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Qs,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ns,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}),c?e.jsx(ds,{className:"h-5 w-5"}):e.jsx(us,{className:"h-5 w-5"})]})]})}),e.jsxs(Ws,{className:"p-4 pt-0",children:[e.jsx(pe,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:s.map(m=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[m.quantity,"x ",m.name,m.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",m.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m.price*m.quantity)})]},m.id))}),e.jsx(pe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(pe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)})]})]})]})]})},Fe=s=>s.replace(/\D/g,""),Er=s=>s.replace(/\D/g,""),ke=s=>s.replace(/\D/g,""),Ys=Yr({name:T().min(1,"Nome é obrigatório."),phone:T().min(1,"Telefone é obrigatório.").transform(Fe).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:T().email("Email inválido.").optional().or(es("")),delivery_option:rs(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:T().optional().default(""),number:T().optional().default(""),complement:T().optional().default(""),neighborhood:T().optional().default(""),city:T().optional().default(""),zip_code:T().optional().default("").transform(Er).refine(s=>s.length===8||s.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Se(s=>typeof s=="string"?parseFloat(s):s,Xe.number().optional().nullable()),longitude:Se(s=>typeof s=="string"?parseFloat(s):s,Xe.number().optional().nullable()),payment_method_id:T().min(1,"Selecione uma forma de pagamento."),notes:T().optional(),cpf_cnpj:T().optional().default("").transform(ke).refine(s=>s.length===0||s.length===11||s.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Se(s=>{if(s==null||s==="")return null;const a=String(s).replace(",","."),o=parseFloat(a);return isNaN(o)?a:o},ss({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((s,a)=>{if(s.delivery_option==="delivery"?(s.street.trim()===""&&a.addIssue({code:K.custom,message:"Rua é obrigatória.",path:["street"]}),s.number.trim()===""&&a.addIssue({code:K.custom,message:"Número é obrigatório.",path:["number"]}),s.neighborhood.trim()===""&&a.addIssue({code:K.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),s.city.trim()===""&&a.addIssue({code:K.custom,message:"Cidade é obrigatória.",path:["city"]}),s.zip_code.length!==8&&a.addIssue({code:K.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(s.latitude===null||s.longitude===null)&&a.addIssue({code:K.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})):s.latitude!==null||s.longitude,s.payment_method_id==="Dinheiro"&&s.change_for!==null&&s.change_for!==void 0&&s.change_for<=0&&a.addIssue({code:K.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),s.payment_method_id==="Pagamento online: Pix/Cartão"){const n=ke(s.cpf_cnpj||"");n.length!==11&&n.length!==14&&a.addIssue({code:K.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),et=()=>{const s=window.location.origin,o=window.location.pathname.split("/")[1];return o?`${s}/${o}`:s},rt=async()=>{const{data:s,error:a}=await F.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(a)throw new Error(`Erro ao buscar restaurante: ${a.message}`);if(!s)throw new Error("Nenhum restaurante ativo encontrado.");return s},st=async s=>{const{data:a,error:o}=await F.from("restaurants").select("delivery_enabled").eq("id",s).single();if(o)throw new Error(`Erro ao buscar status de entrega: ${o.message}`);return a.delivery_enabled??!0},tt=async s=>{const{data:a,error:o}=await F.from("payment_methods").select("*").eq("restaurant_id",s).eq("is_active",!0).order("name",{ascending:!0});if(o)throw new Error(`Erro ao buscar métodos de pagamento: ${o.message}`);return a},ot=async s=>{const{data:a,error:o}=await F.from("delivery_zones").select("*").eq("restaurant_id",s).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(o)throw new Error(`Erro ao buscar zonas de entrega: ${o.message}`);return a},at=async()=>{const{data:{user:s}}=await F.auth.getUser();if(!s)return null;const{data:a,error:o}=await F.from("customers").select("*").eq("user_id",s.id).limit(1).single();if(o&&o.code!=="PGRST116")throw new Error(`Erro ao buscar dados do cliente: ${o.message}`);if(a)return a;const d=s.user_metadata;return{id:s.id,user_id:s.id,name:d.full_name||"",phone:d.phone||"",email:s.email||"",address:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),latitude:null,longitude:null,cpf_cnpj:null}},nt=s=>{switch(s){case"DollarSign":return Ss;case"Smartphone":return Ps;case"CreditCard":return Es;case"Package":return Rs;default:return lr}},it=({subtotal:s,deliveryFee:a,total:o,items:d})=>e.jsxs(ce,{className:"sticky top-4",children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(me,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:d.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(pe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(pe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]})]})]}),zt=()=>{et();const s=Qr(),a=Jr(),o=nr(),{items:d,subtotal:n,deliveryFee:c,total:p,setDeliveryFee:m,clearCart:g}=o,[x]=Wr(),[y,v]=i.useState(!1),[j,h]=i.useState(null),[R,N]=i.useState(null),[k,M]=i.useState(null),C=Xr.useRef(!1),[J,Me]=i.useState(!1),[Pr,$e]=i.useState(!1),te=x.get("status"),Ne=x.get("external_reference"),Ge=x.has("collection_id")||x.has("external_reference");i.useEffect(()=>{if(Ne)if(te==="approved"||te==="failure"||te==="pending"){s(`/order-success/${Ne}?status=${te}`,{replace:!0});return}else Ge&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Me(!1));else Me(!1)},[Ne,te,Ge,s]);const{data:u,isLoading:Sr,isError:Ir,error:Vr}=ie({queryKey:["checkoutRestaurantData"],queryFn:rt}),{data:$,isLoading:Ce}=ie({queryKey:["deliveryStatus",u==null?void 0:u.id],queryFn:()=>st(u.id),enabled:!!(u!=null&&u.id)}),{data:X=[],isLoading:Fr}=ie({queryKey:["checkoutPaymentMethods",u==null?void 0:u.id],queryFn:()=>tt(u.id),enabled:!!(u!=null&&u.id)}),{data:ze=[],isLoading:kr}=ie({queryKey:["checkoutDeliveryZones",u==null?void 0:u.id],queryFn:()=>ot(u.id),enabled:!!(u!=null&&u.id)}),{data:G,isLoading:Lr}=ie({queryKey:["checkoutCustomerData"],queryFn:at,staleTime:0}),Or=Sr||Ce||Fr||kr||Lr,Tr=Ir,Be=Vr,t=ts({resolver:os(Ys),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"});i.useEffect(()=>{if(G){const r=Fe(G.phone||""),l=localStorage.getItem("checkoutFormData");let f={};if(l)try{f=JSON.parse(l)}catch(b){console.error("Failed to parse local storage data",b)}t.reset({...t.getValues(),...f,name:G.name||"",phone:r,email:G.email||"",cpf_cnpj:G.cpf_cnpj||""})}},[G,t]);const q=t.watch("delivery_option"),_e=t.watch("payment_method_id"),Y=X.find(r=>r.id===_e),he=(Y==null?void 0:Y.name)==="Pagamento online: Pix/Cartão",fe=(Y==null?void 0:Y.name)==="Dinheiro",P=t.watch("latitude"),S=t.watch("longitude");t.watch(["street","number","neighborhood","city","zip_code"]);const z=q==="delivery",Ar=i.useMemo(()=>JSON.stringify({deliveryOption:q,deliveryEnabled:$,lat:P,lng:S}),[q,$,P,S]),Dr=i.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:u!=null&&u.latitude&&(u!=null&&u.longitude)?[u.latitude,u.longitude]:[-23.55052,-46.633308],[P,S,u]),qr=i.useMemo(()=>P===null||S===null?`map-${q}-null`:`map-${q}-${P.toFixed(6)}-${S.toFixed(6)}`,[z,q,P,S]),we=i.useCallback(r=>{const l=r.road||r.logradouro||"",f=r.house_number||"",b=r.suburb||r.bairro||"",w=r.city||r.localidade||"",B=r.postcode||r.cep||"";t.setValue("street",l,{shouldValidate:!0}),t.setValue("number",f||"",{shouldValidate:!0}),t.setValue("complement",r.suburb||"",{shouldValidate:!0}),t.setValue("neighborhood",b,{shouldValidate:!0}),t.setValue("city",w,{shouldValidate:!0}),t.setValue("zip_code",B,{shouldValidate:!0})},[t]),Mr=i.useCallback(async(r,l)=>{t.setValue("latitude",r,{shouldValidate:!0}),t.setValue("longitude",l,{shouldValidate:!0});const f=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${l}&addressdetails=1`,b=await fetch(f);if(b.ok){const w=await b.json();w.address&&we(w.address)}},[t,we]),$r=i.useCallback(()=>{t.setValue("street","",{shouldValidate:!0}),t.setValue("number","",{shouldValidate:!0}),t.setValue("complement","",{shouldValidate:!0}),t.setValue("neighborhood","",{shouldValidate:!0}),t.setValue("city","",{shouldValidate:!0}),t.setValue("zip_code","",{shouldValidate:!0}),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),m(0),h(null),N(null),L.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[t,m]),Re=i.useCallback(r=>{try{const l={name:r.name,phone:r.phone,email:r.email,delivery_option:r.delivery_option,street:r.street,number:r.number,complement:r.complement,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code,latitude:r.latitude,longitude:r.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(l))}catch(l){console.error("Failed to save form data to local storage",l)}},[]),Ue=i.useCallback(()=>{try{const r=localStorage.getItem("checkoutFormData");if(r){const l=JSON.parse(r);t.reset({...t.getValues(),...l,delivery_option:l.delivery_option||"delivery"})}}catch(r){console.error("Failed to load form data from local storage",r)}},[t]);i.useEffect(()=>{Ue()},[Ue]),i.useEffect(()=>{const r=t.watch(l=>{Re(l)});return()=>r.unsubscribe()},[t,Re]);const Gr=()=>{if(C.current)return;M(null),C.current=!0;const r=L.loading("Buscando endereço e coordenadas...");Promise.resolve().then(async()=>{try{const l=t.getValues(),[f,b,w,B,H]=[l.street,l.number,l.neighborhood,l.city,l.zip_code],ae=Er(H);if(!(f&&b&&w&&B&&ae.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),t.trigger(["street","number","neighborhood","city","zip_code","zip_code"]),L.error("Preencha todos os campos de endereço obrigatórios.");return}console.log("LOG: Iniciando geocodificação para:",`${f}, ${b}, ${w}, ${B}, ${H}`);const xe=`${f}, ${b}, ${w}, ${B}, ${H}`,U=await zs(xe);U?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",U),t.setValue("latitude",U.lat,{shouldValidate:!0}),t.setValue("longitude",U.lng,{shouldValidate:!0}),Re(t.getValues()),L.success("Endereço e mapa atualizados com sucesso!")):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),M("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),L.warning("Endereço não encontrado. Ajuste manualmente no mapa ou verifique os dados."))}catch(l){console.error("LOG: Erro capturado durante a geocodificação:",l),M(`Erro ao buscar coordenadas: ${l.message}`),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),L.error(`Erro na busca: ${l.message}`)}finally{C.current=!1,L.dismiss(r)}}).catch(l=>{console.error("LOG: Erro nao capturado:",l),C.current=!1,L.dismiss(r)})};i.useEffect(()=>{fe||t.setValue("change_for",null,{shouldValidate:!0})},[fe,t]),i.useEffect(()=>{q==="pickup"&&(m(0),h(null),N(null),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}))},[q,z,t,m,P,S]),i.useEffect(()=>{X.length>0&&!_e&&t.setValue("payment_method_id",X[0].id)},[X,_e,t]),i.useEffect(()=>{he?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},[he,t]),i.useEffect(()=>{const r=async()=>{if(q==="pickup"||!(u!=null&&u.latitude)||!(u!=null&&u.longitude)){m(0),h(null),N(null);return}if(Ce)return;if($===!1){m(0),h(null),N(null),v(!1);return}v(!0),h(null);let f=null;if(P&&S)f=[P,S];else{m(0),N(null),v(!1);return}if(f){const b=[u.latitude,u.longitude],w=Bs(f,b,ze);w?(m(w.fee),h(null),N({minTime:w.minTime,maxTime:w.maxTime})):(m(0),h("Seu endereço está fora da nossa área de entrega."),N(null))}v(!1)},l=setTimeout(()=>{r()},500);return()=>clearTimeout(l)},[Ar,u,ze,t,m,z,P,S,$,Ce]);const oe=Hr({mutationFn:async r=>{if(!u)throw new Error("Dados do restaurante indisponíveis.");if(r.delivery_option==="delivery"&&j)throw new Error(j);const l=[r.street,r.number,r.complement?`(${r.complement})`:null,r.neighborhood,r.city,r.zip_code].filter(Boolean).join(", "),f=r.delivery_option==="delivery"?l:"Retirada no Local";let b;const w=Fe(r.phone),B=ke(r.cpf_cnpj||""),{data:{user:H}}=await F.auth.getUser(),ae=(H==null?void 0:H.id)||null;if(!ae)throw new Error("Autenticação necessária. Por favor, faça login para finalizar o pedido.");const{data:Pe}=await F.from("customers").select("id, user_id, name, cpf_cnpj").eq("user_id",ae).limit(1).single();if(Pe){b=Pe.id;const O={name:r.name,phone:w,email:r.email||null,cpf_cnpj:B||null},{error:D}=await F.from("customers").update(O).eq("id",b);if(D)throw new Error(`Erro ao atualizar cliente existente: ${D.message}`)}else{const O={name:r.name,phone:w,email:r.email||null,address:f,latitude:r.latitude,longitude:r.longitude,cpf_cnpj:B||null,user_id:ae},{data:D,error:A}=await F.from("customers").insert(O).select("id").single();if(A)throw new Error(`Erro ao criar cliente: ${A.message}`);b=D.id}const xe=he?"pending_payment":"pending",{data:U,error:Je}=await F.from("orders").insert({restaurant_id:u.id,customer_id:b,status:xe,total_amount:p,delivery_fee:c,notes:r.notes,delivery_address:f,payment_method_id:r.payment_method_id,change_for:fe?r.change_for:null}).select("id").single();if(Je)throw new Error(`Erro ao criar pedido: ${Je.message}`);const Zr=d.map(O=>{const D=Number(O.quantity),A=Number(O.price),ne={order_id:U.id,product_id:O.product_id,quantity:D,unit_price:A,subtotal:D*A};return O.notes&&O.notes.trim()&&(ne.notes=O.notes.trim()),ne}),{error:He}=await F.from("order_items").insert(Zr);if(He){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",He);const O=d.map(A=>{const ne=Number(A.quantity),Qe=Number(A.price);return{order_id:U.id,quantity:ne,unit_price:Qe,subtotal:ne*Qe,notes:A.notes&&A.notes.trim()?A.notes.trim():null}}),{error:D}=await F.from("order_items").insert(O);if(D)throw new Error(`Erro ao adicionar itens do pedido: ${D.message}`)}return{orderId:U.id,orderStatus:xe}},onSuccess:r=>{const l=r.orderStatus==="pending_payment"?`/payment/${r.orderId}`:`/order-success/${r.orderId}`;t.reset(),localStorage.removeItem("checkoutFormData"),setTimeout(()=>{s(l,{replace:!0})},100)},onError:r=>{console.error("LOG: Erro ao processar pedido:",r),L.error("Falha ao finalizar pedido.",{description:r.message||"Ocorreu um erro desconhecido. Verifique o console para detalhes.",duration:1e4})}}),zr=async r=>{if(!await t.trigger()){Ke(t.formState.errors);return}if(r.delivery_option==="delivery"&&j){L.error("Não é possível finalizar o pedido.",{description:j});return}oe.mutate(r)},Ke=r=>{console.error("Validation errors:",r);const l=Object.keys(r)[0];l&&L.error("Preencha todos os campos obrigatórios.",{description:`Erro no campo: ${l}.`})},Br=async()=>{const{error:r}=await F.auth.signOut();r?L.error("Erro ao sair.",{description:r.message}):(L.success("Você saiu da sua conta."),a.invalidateQueries({queryKey:["checkoutCustomerData"]}),s("/auth",{replace:!0}))},Ze=oe.isPending||y,Ur=!z||!j&&c>=0,Ee=!z||P!==null&&S!==null,Kr=!Ze&&Ur&&Ee;return i.useEffect(()=>{if(d.length===0&&!oe.isPending&&!J){const r=setTimeout(()=>{s("/menu",{replace:!0})},100);return()=>clearTimeout(r)}},[d.length,oe.isPending,J,s]),d.length===0&&!oe.isPending&&!J?e.jsx(Ye,{}):Or||J?e.jsx(Ye,{}):Tr?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(ee,{variant:"destructive",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro de Conexão"}),e.jsx(se,{children:Be instanceof Error?Be.message:"Não foi possível carregar os dados."})]})}):e.jsxs(e.Fragment,{children:[e.jsx(js,{isOpen:Pr,onClose:()=>$e(!1),customer:G}),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(We,{to:"/menu",children:e.jsx(Q,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(Cs,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]}),G&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{variant:"outline",size:"icon",onClick:()=>$e(!0),"aria-label":"Editar Perfil",children:e.jsx(_s,{className:"h-5 w-5"})}),e.jsx(Q,{variant:"destructive",size:"icon",onClick:Br,"aria-label":"Sair da Conta",children:e.jsx(bs,{className:"h-5 w-5"})})]})]})}),e.jsx("div",{children:e.jsx(Xs,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(fs,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(zr,Ke),className:"space-y-6",children:[e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(me,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"name",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Nome Completo *"}),e.jsx(Z,{placeholder:"Seu nome",...r}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"phone",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Telefone *"}),e.jsx(xs,{...r}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"email",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Email (Opcional)"}),e.jsx(Z,{placeholder:"seu@email.com",...r}),e.jsx(V,{})]})})]})]})]}),e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(me,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"delivery_option",render:({field:r})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(le,{children:e.jsxs(Ve,{onValueChange:r.onChange,defaultValue:r.value,className:"flex flex-col space-y-1",children:[e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(le,{children:e.jsx(ge,{value:"delivery"})}),e.jsx(rr,{className:"h-5 w-5 text-primary"}),e.jsxs(E,{className:Oe("font-normal flex-1 cursor-pointer"),children:["Delivery",$===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(le,{children:e.jsx(ge,{value:"pickup"})}),e.jsx(lr,{className:"h-5 w-5 text-primary"}),e.jsx(E,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(V,{})]})}),z&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(sr,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Q,{type:"button",variant:"outline",size:"sm",onClick:r=>{r.preventDefault(),Gr()},disabled:y||C.current,children:[e.jsx(ws,{className:"h-4 w-4 mr-2"})," ",y||C.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(Q,{type:"button",variant:"outline",size:"sm",onClick:$r,children:[e.jsx(Vs,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:t.control,name:"street",render:({field:r})=>e.jsxs(_,{className:"col-span-2",children:[e.jsx(E,{children:"Rua *"}),e.jsx(Z,{...r}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"number",render:({field:r})=>e.jsxs(_,{className:"col-span-1",children:[e.jsx(E,{children:"Número *"}),e.jsx(Z,{...r}),e.jsx(V,{})]})})]}),e.jsx(I,{control:t.control,name:"complement",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Complemento (Opcional)"}),e.jsx(Z,{placeholder:"Apto, Bloco, Casa, etc.",...r,disabled:!1}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"neighborhood",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Bairro *"}),e.jsx(Z,{...r}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"city",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Cidade *"}),e.jsx(Z,{...r}),e.jsx(V,{})]})})]}),e.jsx(I,{control:t.control,name:"zip_code",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"CEP *"}),e.jsx(gs,{...r}),e.jsx(V,{})]})}),z&&Ee&&e.jsx("div",{children:e.jsx(ys,{mapKey:qr,markerPosition:Dr,onLocationChange:Mr,updateAddressFields:we,restaurant:u})}),y&&$!==!1&&e.jsxs(ee,{children:[e.jsx(er,{className:"h-4 w-4 animate-spin"}),e.jsx(re,{children:"Calculando Taxa..."}),e.jsx(se,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),j&&$!==!1&&e.jsxs(ee,{variant:"destructive",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro de Entrega"}),e.jsx(se,{children:j})]}),c>0&&!y&&$!==!1&&e.jsxs(ee,{className:"mt-4",children:[e.jsx(rr,{className:"h-4 w-4"}),e.jsx(re,{children:"Taxa de Entrega Aplicada"}),e.jsxs(se,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)]})]}),k&&e.jsxs(ee,{variant:"destructive",className:"mt-4",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro ao Buscar Endereço"}),e.jsx(se,{children:k})]}),z&&!Ee&&!k&&e.jsxs(ee,{variant:"destructive",children:[e.jsx(sr,{className:"h-4 w-4"}),e.jsx(re,{children:"Localização Obrigatória"}),e.jsx(se,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(me,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"payment_method_id",render:({field:r})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(le,{children:e.jsx(Ve,{onValueChange:l=>{r.onChange(l);const f=X.find(b=>b.id===l);(f==null?void 0:f.name)!=="Dinheiro"&&t.setValue("change_for",null,{shouldValidate:!0}),(f==null?void 0:f.name)==="Pagamento online: Pix/Cartão"?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},defaultValue:r.value,className:"flex flex-col space-y-2",children:X.map(l=>{const f=nt(l.icon||"Store");return e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(le,{children:e.jsx(ge,{value:l.id})}),e.jsx(f,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(E,{className:"font-normal cursor-pointer",children:l.name}),l.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description})]})]},l.id)})})}),e.jsx(V,{})]})}),fe&&e.jsx(I,{control:t.control,name:"change_for",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Troco para (Opcional)"}),e.jsx(Z,{type:"number",placeholder:"Ex: 50.00",...r,value:r.value||"",onChange:l=>r.onChange(l.target.value?parseFloat(l.target.value):null)}),e.jsx(V,{})]})}),he&&e.jsx(I,{control:t.control,name:"cpf_cnpj",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"CPF/CNPJ *"}),e.jsx(vs,{...r}),e.jsx(V,{})]})})]})]}),e.jsxs(ce,{children:[e.jsx(de,{children:e.jsx(ue,{className:"text-xl",children:"4. Observações"})}),e.jsx(me,{children:e.jsx(I,{control:t.control,name:"notes",render:({field:r})=>e.jsxs(_,{children:[e.jsx(E,{children:"Observações do Pedido (Opcional)"}),e.jsx(hs,{placeholder:"Ex: Sem cebola, sem alface...",...r}),e.jsx(V,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(We,{to:"/menu",className:"flex-1",children:e.jsx(Q,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(Q,{type:"submit",className:"flex-1",disabled:!Kr,size:"lg",children:Ze?e.jsxs(e.Fragment,{children:[e.jsx(er,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(it,{subtotal:n,deliveryFee:c,total:p,items:d})})]})]})]})]})};export{zt as default};
