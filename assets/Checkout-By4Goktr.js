import{b as ue,j as e,u as Zr,c as Ie}from"./tanstack-Ch7Ewlpa.js";import{r as d,u as Qr,h as Xr,j as Hr,L as Oe}from"./vendor-CCvq-0xx.js";import{s as P}from"./client-3S0ugJ5L.js";import{c as Wr,d as dr,e as Le,P as Ne,f as Fe,g as Jr,h as Yr,i as et,a as fe,u as j,L as me,p as rt,b as We}from"./index-Bn-SZedN.js";import{L as tt,g as Je,c as Ye,Z as nt}from"./location-RJoD_0D2.js";import{u as at}from"./use-auth-status-_H4u97lH.js";import{o as lr,s as G,e as st,u as er,C as le,t as rr}from"./types-CtpoKdVi.js";import{B as Q}from"./button-CYXY6_Fn.js";import{C as X,b as H,c as W,a as J}from"./card-BNQM1yK5.js";import{L as k,I as se}from"./label-BISwx90N.js";import{T as ot}from"./textarea-BNPmFiwu.js";import{c as ur,R as it,I as ct}from"./index-D9Jrl-2y.js";import{u as dt}from"./index-MFjXM7kG.js";import{u as lt}from"./index-BMYbFAKC.js";import{S as tr}from"./separator-BAkNhP8G.js";import{A as ne,a as oe,b as ie}from"./alert-DrjQucMO.js";import{P as ut,M as mt}from"./PhoneInput-DEd3cR0p.js";import{C as ft,L as pt}from"./CustomerProfileModal-BaWSTOIS.js";import{D as nr,a as ar,b as ht,c as xt,d as gt}from"./dialog-o_wzaSvC.js";import{C as mr}from"./credit-card-DjLeg7Uh.js";import{C as yt}from"./CpfCnpjInput-32pTmDdL.js";import{M as Me,R as jt}from"./refresh-cw-BBVpzWSp.js";import{A as vt,a as wt,b as _t,c as bt,d as Nt,e as Ct,g as Et}from"./alert-dialog-DC_Hand_.js";import{C as _e}from"./circle-alert-muD0-bbo.js";import{F as sr,b as Pt,d as St}from"./form-NPl9lFcL.js";import{T as or}from"./terminal-DjWqGE4R.js";import{A as Rt}from"./arrow-left-n_lrlV9b.js";import{U as ir}from"./user-sRHw_lqm.js";import{T as ve}from"./truck-DqFtjtAt.js";import{C as It}from"./circle-check-big-D6pDqkyw.js";import{S as Ot}from"./save-CoOnhzHN.js";import{D as Ft}from"./dollar-sign-B1DS1s-q.js";import"./supabase-t-NbcSY6.js";import"./skeleton-Db_PMplP.js";import"./package-Bg4GzeEC.js";import"./check-DeyI5t8R.js";import"./circle-x-DFKOC-HA.js";import"./euro-B945-N9c.js";import"./format-BeKxgCCE.js";import"./pt-BR-CbDebePx.js";import"./index-BpHSCaiT.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=Wr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),At=async r=>{const{data:a,error:n}=await P.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${n.message}`);return(a==null?void 0:a.mercado_pago_public_key)||null},fr=r=>ue({queryKey:["mercadoPagoPublicKey",r],queryFn:()=>At(r),enabled:!!r,staleTime:1/0});var ke="Radio",[Lt,pr]=dr(ke),[kt,Dt]=Lt(ke),hr=d.forwardRef((r,a)=>{const{__scopeRadio:n,name:m,checked:f=!1,required:h,disabled:w,value:o="on",onCheck:S,form:R,...C}=r,[g,F]=d.useState(null),E=Le(a,$=>F($)),O=d.useRef(!1),D=g?R||!!g.closest("form"):!0;return e.jsxs(kt,{scope:n,checked:f,disabled:w,children:[e.jsx(Ne.button,{type:"button",role:"radio","aria-checked":f,"data-state":jr(f),"data-disabled":w?"":void 0,disabled:w,value:o,...C,ref:E,onClick:Fe(r.onClick,$=>{f||S==null||S(),D&&(O.current=$.isPropagationStopped(),O.current||$.stopPropagation())})}),D&&e.jsx(yr,{control:g,bubbles:!O.current,name:m,value:o,checked:f,required:h,disabled:w,form:R,style:{transform:"translateX(-100%)"}})]})});hr.displayName=ke;var xr="RadioIndicator",gr=d.forwardRef((r,a)=>{const{__scopeRadio:n,forceMount:m,...f}=r,h=Dt(xr,n);return e.jsx(Jr,{present:m||h.checked,children:e.jsx(Ne.span,{"data-state":jr(h.checked),"data-disabled":h.disabled?"":void 0,...f,ref:a})})});gr.displayName=xr;var Tt="RadioBubbleInput",yr=d.forwardRef(({__scopeRadio:r,control:a,checked:n,bubbles:m=!0,...f},h)=>{const w=d.useRef(null),o=Le(w,h),S=lt(n),R=Yr(a);return d.useEffect(()=>{const C=w.current;if(!C)return;const g=window.HTMLInputElement.prototype,E=Object.getOwnPropertyDescriptor(g,"checked").set;if(S!==n&&E){const O=new Event("click",{bubbles:m});E.call(C,n),C.dispatchEvent(O)}},[S,n,m]),e.jsx(Ne.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...f,tabIndex:-1,ref:o,style:{...f.style,...R,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});yr.displayName=Tt;function jr(r){return r?"checked":"unchecked"}var $t=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Ce="RadioGroup",[Vt,Yn]=dr(Ce,[ur,pr]),vr=ur(),wr=pr(),[Gt,qt]=Vt(Ce),_r=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,name:m,defaultValue:f,value:h,required:w=!1,disabled:o=!1,orientation:S,dir:R,loop:C=!0,onValueChange:g,...F}=r,E=vr(n),O=dt(R),[D,$]=et({prop:h,defaultProp:f??null,onChange:g,caller:Ce});return e.jsx(Gt,{scope:n,name:m,required:w,disabled:o,value:D,onValueChange:$,children:e.jsx(it,{asChild:!0,...E,orientation:S,dir:O,loop:C,children:e.jsx(Ne.div,{role:"radiogroup","aria-required":w,"aria-orientation":S,"data-disabled":o?"":void 0,dir:O,...F,ref:a})})})});_r.displayName=Ce;var br="RadioGroupItem",Nr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,disabled:m,...f}=r,h=qt(br,n),w=h.disabled||m,o=vr(n),S=wr(n),R=d.useRef(null),C=Le(a,R),g=h.value===f.value,F=d.useRef(!1);return d.useEffect(()=>{const E=D=>{$t.includes(D.key)&&(F.current=!0)},O=()=>F.current=!1;return document.addEventListener("keydown",E),document.addEventListener("keyup",O),()=>{document.removeEventListener("keydown",E),document.removeEventListener("keyup",O)}},[]),e.jsx(ct,{asChild:!0,...o,focusable:!w,active:g,children:e.jsx(hr,{disabled:w,required:h.required,checked:g,...S,...f,name:h.name,ref:C,onCheck:()=>h.onValueChange(f.value),onKeyDown:Fe(E=>{E.key==="Enter"&&E.preventDefault()}),onFocus:Fe(f.onFocus,()=>{var E;F.current&&((E=R.current)==null||E.click())})})})});Nr.displayName=br;var Bt="RadioGroupIndicator",Cr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,...m}=r,f=wr(n);return e.jsx(gr,{...f,...m,ref:a})});Cr.displayName=Bt;var Er=_r,Pr=Nr,zt=Cr;const Ae=d.forwardRef(({className:r,...a},n)=>e.jsx(Er,{className:fe("grid gap-2",r),...a,ref:n}));Ae.displayName=Er.displayName;const be=d.forwardRef(({className:r,...a},n)=>e.jsx(Pr,{ref:n,className:fe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(zt,{className:"flex items-center justify-center",children:e.jsx(Mt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));be.displayName=Pr.displayName;var De={};Object.defineProperty(De,"__esModule",{value:!0});var Sr=De.loadMercadoPago=void 0;const Rr="https://sdk.mercadopago.com/js/v2",Kt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,cr="MercadoPago has already been initialized in your window, please remove the duplicate import",Ut="MercadoPago.js not available",Zt="Failed to load MercadoPago.js",Qt=()=>{for(var r=document.querySelectorAll(`script[src^="${Rr}"`),a=0;a<r.length;a++){var n=r[a];if(Kt.test(n.src))return n}return null},Xt=()=>{const r=document.createElement("script");r.src=Rr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let we=null;const Ht=()=>(we!==null||(we=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(cr),r(window.MercadoPago);return}try{let n=Qt();n?console.warn(cr):n||(n=Xt()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(Ut))}),n.addEventListener("error",()=>{a(new Error(Zt))})}catch(n){a(n);return}})),we);Sr=De.loadMercadoPago=Ht;var Wt=function(r,a,n,m){function f(h){return h instanceof n?h:new n(function(w){w(h)})}return new(n||(n=Promise))(function(h,w){function o(C){try{R(m.next(C))}catch(g){w(g)}}function S(C){try{R(m.throw(C))}catch(g){w(g)}}function R(C){C.done?h(C.value):f(C.value).then(o,S)}R((m=m.apply(r,a||[])).next())})};class Z{static getInstance(){return Wt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield Sr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}Z.publicKey=null;Z.options={};Z.instanceMercadoPago=void 0;Z.loadedInstanceMercadoPago=!1;function Jt(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(m=>Object.prototype.hasOwnProperty.call(a,m)&&r[m]===a[m])}const Yt=(r,a)=>{const n=Object.assign(Object.assign({},a),{frontEndStack:"react"}),m=!Jt(Z.options,n);(r!==Z.publicKey||m)&&(Z.publicKey=r,Z.options=n,Z.instanceMercadoPago=void 0)},en=({preferenceId:r,initPoint:a,onClose:n})=>{const{data:m,isLoading:f}=fr();return d.useEffect(()=>{if(m)try{Yt(m,{locale:"pt-BR"})}catch(h){console.error("Erro ao inicializar Mercado Pago:",h),j.error("Erro ao carregar o SDK do Mercado Pago."),n();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[m,n,a]),f||!m?e.jsx(nr,{open:!0,onOpenChange:n,children:e.jsx(ar,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(me,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(nr,{open:!0,onOpenChange:n,children:e.jsxs(ar,{className:"sm:max-w-[425px]",children:[e.jsxs(ht,{children:[e.jsxs(xt,{className:"flex items-center gap-2",children:[e.jsx(mr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(gt,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(me,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Q,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},rn=({latitude:r,longitude:a,address:n,className:m})=>{const f=d.useMemo(()=>[r,a],[r,a]),h=d.useMemo(()=>[r,a],[r,a]),w=d.useMemo(()=>`client-location-${r.toFixed(6)}-${a.toFixed(6)}`,[r,a]);return e.jsxs(X,{className:fe("w-full",m),children:[e.jsxs(H,{children:[e.jsxs(W,{className:"text-lg flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(J,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(tt,{center:h,markerPosition:f,onMarkerDragEnd:()=>{},zoom:16},w)})})]})},tn=({isOpen:r,onConfirm:a})=>e.jsx(vt,{open:r,children:e.jsxs(wt,{children:[e.jsxs(_t,{children:[e.jsxs(bt,{className:"flex items-center gap-2 text-primary",children:[e.jsx(_e,{className:"h-6 w-6"}),"Atenção ao Pagamento Online!"]}),e.jsxs(Nt,{children:["Você escolheu o pagamento online (Pix ou Cartão).",e.jsx("br",{}),e.jsx("br",{}),"Ao prosseguir, você será redirecionado para o checkout do Mercado Pago.",e.jsx("br",{}),e.jsx("br",{}),'**IMPORTANTE:** Se você escolher **PIX**, após o pagamento, você pode precisar clicar no botão **"Voltar ao site"** na tela do Mercado Pago para que seu pedido seja finalizado e rastreado corretamente.']})]}),e.jsx(Ct,{children:e.jsx(Et,{onClick:a,className:"w-full",children:"Entendi e Continuar"})})]})}),nn=lr({zip_code:G().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:G().min(1,"Rua é obrigatória."),number:G().min(1,"Número é obrigatório."),neighborhood:G().min(1,"Bairro é obrigatório."),city:G().min(1,"Cidade é obrigatória.")}),an=lr({name:G().min(1,"Nome é obrigatório."),phone:G().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:G().min(1,"CPF/CNPJ é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:st(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:G().optional(),payment_method_id:G().min(1,"Selecione um método de pagamento."),change_for:G().optional()}),sn=async r=>{const{data:a,error:n}=await P.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},on=async r=>{const{data:a,error:n}=await P.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return a},cn=async r=>{const{data:a,error:n}=await P.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return a},dn=async r=>{const{data:a,error:n}=await P.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return a||null},ea=()=>{var Ue,Ze,Qe,Xe,He;const r=Qr(),a=Xr(),[n]=Hr(),m=Zr(),{items:f,totalAmount:h,clearCart:w}=rt(),{data:o,isLoading:S}=at(),[R]=d.useState((Ue=a.state)==null?void 0:Ue.restaurantId),C=n.get("restaurantId"),g=R||C,{data:F}=fr(g),[E,O]=d.useState(!1),[D,$]=d.useState(!1),[pe,q]=d.useState(0),[ce,V]=d.useState(null),[Ee,B]=d.useState(!0),[Y,he]=d.useState(null),[Ir,Pe]=d.useState(!1),[Or,Fr]=d.useState(null),[Te,Mr]=d.useState(null),[K,ee]=d.useState(!1),[Ar,$e]=d.useState(!1),[Ve,Se]=d.useState(null);d.useEffect(()=>{console.log("LOG: Checkout - User Status:",o?`Logged in as ${o.email}`:"Anonymous")},[o]);const{data:x,isLoading:Lr,isError:kr,error:Ge,refetch:Dr}=ue({queryKey:["checkoutRestaurantData",g],queryFn:()=>sn(g),enabled:!!g,staleTime:1/0}),{data:re,isLoading:Tr}=ue({queryKey:["checkoutDeliveryZones",g],queryFn:()=>on(x.id),enabled:!!x,staleTime:1/0}),{data:U,isLoading:$r}=ue({queryKey:["checkoutPaymentMethods",g],queryFn:()=>cn(x.id),enabled:!!x,staleTime:1/0}),{data:y,isLoading:qe,refetch:ln}=ue({queryKey:["checkoutCustomerData",o==null?void 0:o.id],queryFn:()=>dn(o.id),enabled:!!o,staleTime:0}),xe=d.useMemo(()=>x!=null&&x.latitude&&(x!=null&&x.longitude)?[x.latitude,x.longitude]:null,[x]),Re=d.useCallback(async(t,s,l,p,u,c,N)=>{const v=[30,45];if(x&&x.delivery_enabled===!1){const _=`${s}, ${l}, ${u}, ${p}, ${t}`;let L=null;if(c&&N)L={lat:c,lng:N};else{$(!0);const te=j.loading("Validando endereço para frete grátis...");L=await Je(_),$(!1),j.dismiss(te)}if(!L)return q(0),V(null),B(!1),j.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(he([L.lat,L.lng]),re&&re.length>0){const te=Ye([L.lat,L.lng],xe,re);if(te)return q(0),V([te.minTime,te.maxTime]),B(!0),{coords:L,fee:0,time:[te.minTime,te.maxTime],isValid:!0}}return q(0),V(v),B(!0),{coords:L,fee:0,time:v,isValid:!0}}if(!x||!xe)return q(0),B(!0),V(v),{coords:null,fee:0,time:v,isValid:!0};const T=`${s}, ${l}, ${u}, ${p}, ${t}`;let A=null;if(c&&N)A={lat:c,lng:N};else{$(!0);const _=j.loading("Calculando taxa de entrega...");A=await Je(T),$(!1),j.dismiss(_)}if(!A)return q(0),V(null),B(!1),j.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(he([A.lat,A.lng]),re&&re.length>0){const _=Ye([A.lat,A.lng],xe,re);return _?(q(_.fee),V([_.minTime,_.maxTime]),B(!0),{coords:A,fee:_.fee,time:[_.minTime,_.maxTime],isValid:!0}):(q(0),V(null),B(!1),j.error("Endereço fora da área de entrega."),{coords:A,fee:0,time:null,isValid:!1})}else return q(0),V(v),B(!0),{coords:A,fee:0,time:v,isValid:!0}},[x,xe,re]),i=er({resolver:rr(an),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),b=er({resolver:rr(nn),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),M=i.watch("delivery_option"),Vr=i.watch("payment_method_id"),ae=U==null?void 0:U.find(t=>t.id===Vr),ge=(Ze=ae==null?void 0:ae.name)==null?void 0:Ze.includes("online"),de=(Qe=ae==null?void 0:ae.name)==null?void 0:Qe.includes("Dinheiro"),z=h+pe,I=b.watch(["zip_code","street","number","city","neighborhood"]);d.useEffect(()=>{const t=[15,30];M==="pickup"?(q(0),B(!0),ee(!0),V(t)):(ee(!1),V(null))},[M]),d.useEffect(()=>{if(y){let t="",s="",l="",p="",u="";if(y.address){const c=y.address.split(", ").map(N=>N.trim());c.length>=5?(t=c[0],s=c[1],l=c[2],p=c[3],u=c[4]):c.length>=4&&(t=c[0],l=c[1],p=c[2],u=c[3])}i.reset({...i.getValues(),name:y.name||"",phone:y.phone||"",cpf_cnpj:y.cpf_cnpj||"",change_for:""}),b.reset({zip_code:u,street:t,number:s,neighborhood:l,city:p}),y.address&&y.latitude&&y.longitude&&(he([y.latitude,y.longitude]),ee(!0),Re(u,t,s,p,l,y.latitude,y.longitude))}else if(o&&!qe){const t=o.user_metadata;i.reset({...i.getValues(),name:t.full_name||"",phone:t.phone||"",cpf_cnpj:t.cpf_cnpj||"",change_for:""})}},[y,i,o,qe,b,Re]);const ye=i.watch("change_for");d.useEffect(()=>{if(de&&ye&&ye.trim()!==""){const t=ye.replace(",","."),s=parseFloat(t);isNaN(s)?i.setError("change_for",{message:"O troco deve ser um número válido."}):s<z?i.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)}).`}):i.clearErrors("change_for")}else i.clearErrors("change_for")},[de,ye,z,i]);const je=Ie({mutationFn:async t=>{var c;const l=(c=(await P.auth.getUser()).data.user)==null?void 0:c.id;if(!(y!=null&&y.id)&&!l)throw new Error("ID do cliente ou usuário não encontrado.");const p=`${t.street}, ${t.number}, ${t.neighborhood}, ${t.city}, ${t.zip_code}`,u={user_id:(o==null?void 0:o.id)||null,name:i.getValues("name"),phone:i.getValues("phone"),email:(o==null?void 0:o.email)||null,cpf_cnpj:i.getValues("cpf_cnpj")||null,address:p,latitude:t.lat,longitude:t.lng};if(y!=null&&y.id){const{data:N,error:v}=await P.from("customers").update(u).eq("id",y.id).select().single();if(v)throw v;return N}else if(l){const{data:N,error:v}=await P.from("customers").insert(u).select().single();if(v)throw v;return N}else return{id:"anonymous",user_id:null,name:u.name,phone:u.phone,email:u.email,address:p,created_at:"",updated_at:"",latitude:t.lat,longitude:t.lng,cpf_cnpj:u.cpf_cnpj}},onSuccess:(t,s)=>{t.id!=="anonymous"&&m.invalidateQueries({queryKey:["checkoutCustomerData"]}),q(s.fee),V(s.time),B(s.isValid),ee(!0),he([s.lat,s.lng]),j.success("Endereço salvo e taxa de entrega calculada!")},onError:t=>{j.error(`Erro ao salvar endereço: ${t.message}`),ee(!1)}}),Gr=async()=>{if(M==="pickup")return;if(!await b.trigger()){j.error("Preencha todos os campos obrigatórios do endereço.");return}const s=b.getValues(),l=await Re(s.zip_code,s.street,s.number,s.city,s.neighborhood);if(!l.isValid){ee(!1);return}if(!l.coords){j.error("Não foi possível obter as coordenadas para salvar o endereço."),ee(!1);return}je.mutate({...s,lat:l.coords.lat,lng:l.coords.lng,fee:l.fee,time:l.time,isValid:l.isValid})},Be=Ie({mutationFn:async t=>{var c,N;(c=(await P.auth.getUser()).data.user)==null||c.id;const l=t.phone.replace(/\D/g,""),p=((N=t.cpf_cnpj)==null?void 0:N.replace(/\D/g,""))||null,u={user_id:(o==null?void 0:o.id)||null,name:t.name,phone:l,email:(o==null?void 0:o.email)||null,cpf_cnpj:p,address:M==="delivery"?`${I[1]}, ${I[2]}, ${I[4]}, ${I[3]}, ${I[0]}`:null,latitude:Y?Y[0]:null,longitude:Y?Y[1]:null};if(o)if(y){const{data:v,error:T}=await P.from("customers").update(u).eq("id",y.id).select().single();if(T)throw T;return v}else{const{data:v,error:T}=await P.from("customers").insert(u).select().single();if(T)throw T;return v}else{const{data:v,error:T}=await P.from("customers").insert(u).select().single();if(T)throw T;return v}},onSuccess:()=>{m.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:t=>{j.error(`Erro ao salvar dados do cliente: ${t.message}`)}}),ze=Ie({mutationFn:async({customerId:t,data:s})=>{if(!x)throw new Error("Dados do restaurante não disponíveis.");let l=null;if(de&&s.change_for&&s.change_for.trim()!==""){const _=s.change_for.replace(",","."),L=parseFloat(_);!isNaN(L)&&L>z&&(l=L)}let[p,u]=ce||[null,null];if((M==="delivery"||M==="pickup")&&(!p||!u)){const _=M==="pickup"?[15,30]:[30,45];p=_[0],u=_[1]}console.log("LOG: Tempo de entrega salvo no pedido:",p,u);const c={restaurant_id:x.id,customer_id:t,status:ge?"pending_payment":"pending",total_amount:z,delivery_fee:pe,delivery_address:M==="delivery"?`${I[1]}, ${I[2]}, ${I[4]}, ${I[3]}, ${I[0]}`:null,notes:s.notes,payment_method_id:s.payment_method_id,change_for:l,min_delivery_time_minutes:p,max_delivery_time_minutes:u},{data:N,error:v}=await P.from("orders").insert(c).select("id").single();if(v)throw v;const T=f.map(_=>({order_id:N.id,product_id:_.product.id,quantity:parseFloat(_.quantity.toFixed(3)),unit_price:parseFloat(_.product.price.toFixed(2)),subtotal:parseFloat(_.subtotal.toFixed(2)),notes:_.notes})),{error:A}=await P.from("order_items").insert(T);if(A)throw A;return N.id},onSuccess:t=>{m.invalidateQueries({queryKey:["orders"]})},onError:t=>{j.error(`Erro ao criar pedido: ${t.message}`)}}),qr=async t=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",ge),console.log("LOG: deliveryOption:",M),console.log("LOG: isAddressSaved: ",K),console.log("LOG: change_for data:",t.change_for),de&&t.change_for&&t.change_for.trim()!==""){const p=t.change_for.replace(",","."),u=parseFloat(p);if(isNaN(u)){j.error("O troco deve ser um número válido.");return}if(u<z){i.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)}).`});return}}if(f.length===0){j.error("Seu carrinho está vazio."),r(`/menu/${g}`);return}if(M==="delivery"){if(!K){j.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!Ee){j.error("O endereço de entrega está fora da área de cobertura.");return}}let s;try{console.log("LOG: Criando/Atualizando cliente..."),s=(await Be.mutateAsync(t)).id,console.log("LOG: Cliente ID:",s)}catch(p){j.error(`Falha ao salvar cliente: ${p.message}`);return}let l;try{console.log("LOG: Criando pedido..."),l=await ze.mutateAsync({customerId:s,data:t}),console.log("LOG: Pedido ID:",l)}catch(p){j.error(`Falha ao criar pedido: ${p.message}`);return}ge?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Br(l,t)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),w(),r(`/order-success/${l}`,{replace:!0}))},Br=async(t,s)=>{if(!x)return;const l=window.location.origin+window.location.pathname,p=f.map(c=>({name:c.product.name,price:c.product.price,quantity:c.quantity})),u=j.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:c,error:N}=await P.functions.invoke("create-payment-preference",{body:{orderId:t,items:p,totalAmount:z,restaurantName:x.name,clientUrl:l,customerEmail:(o==null?void 0:o.email)||"cliente@anonimo.com",customerCpfCnpj:s.cpf_cnpj}});if(N)throw N;const{init_point:v}=c;console.log("LOG: Preferência MP criada. init_point:",v),Fr(t),Mr(v),Pe(!0),j.dismiss(u)}catch(c){console.error("Erro ao criar preferência MP:",c),j.dismiss(u),j.error(`Erro no pagamento online: ${c.message}`),Pe(!1)}},zr=async()=>{await P.auth.signOut(),j.success("Você saiu da sua conta."),r("/auth",{replace:!0})},Kr=(t,s,l)=>{s&&l?(Se(t),$e(!0)):(i.setValue("payment_method_id",t,{shouldValidate:!0}),Se(null))},Ur=()=>{Ve&&i.setValue("payment_method_id",Ve,{shouldValidate:!0}),$e(!1),Se(null)};if(!g)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(ne,{variant:"destructive",className:"max-w-lg",children:[e.jsx(or,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro de Rastreamento"}),e.jsx(ie,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Oe,{to:"/",children:e.jsx(Q,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(f.length===0)return d.useEffect(()=>{r(`/menu/${g}`)},[r,g]),e.jsx(We,{});if(Lr||Tr||$r||S)return e.jsx(We,{});if(kr||!x)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(ne,{variant:"destructive",className:"max-w-lg",children:[e.jsx(or,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro Crítico"}),e.jsx(ie,{children:Ge instanceof Error?Ge.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Q,{onClick:()=>Dr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(jt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ke=Be.isPending||ze.isPending||je.isPending||D||M==="delivery"&&!K;return e.jsxs("div",{className:"min-h-screen bg-background py-4 sm:py-8 px-4 sm:px-8",children:[e.jsx(ft,{isOpen:E,onClose:()=>O(!1),customer:y}),e.jsx(tn,{isOpen:Ar,onConfirm:Ur}),Ir&&Te&&e.jsx(en,{preferenceId:Or,initPoint:Te,onClose:()=>Pe(!1)}),e.jsxs("div",{className:"w-full lg:max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Oe,{to:`/menu/${g}`,children:e.jsx(Q,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(Rt,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:x.name})]})]}),o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Q,{variant:"outline",size:"sm",onClick:()=>O(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(ir,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(Q,{variant:"outline",size:"sm",onClick:zr,children:[e.jsx(pt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(ir,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(J,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:o?`Logado como ${o.email}. ${y?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsxs(sr,{...i,children:[" ",e.jsx("form",{onSubmit:i.handleSubmit(qr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(se,{id:"name",...i.register("name")}),i.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"phone",children:"Telefone *"}),e.jsx(le,{name:"phone",control:i.control,render:({field:t})=>e.jsx(ut,{id:"phone",...t})}),i.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(le,{name:"cpf_cnpj",control:i.control,render:({field:t})=>e.jsx(yt,{id:"cpf_cnpj",...t})}),i.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.cpf_cnpj.message})]})]})})]})]})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(ve,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(J,{children:e.jsx(le,{name:"delivery_option",control:i.control,render:({field:t})=>e.jsxs(Ae,{onValueChange:t.onChange,value:t.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(k,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(be,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(ve,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(k,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(be,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Me,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),M==="delivery"&&e.jsxs(X,{className:fe(!K&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(H,{children:[e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",K&&e.jsx(It,{className:"h-5 w-5 text-green-500 ml-2"}),!K&&e.jsx(_e,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(J,{className:"space-y-4",children:[x.delivery_enabled===!1&&e.jsxs(ne,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(oe,{children:"Frete Grátis Ativo"}),e.jsx(ie,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsxs(sr,{...b,children:[" ",e.jsxs("form",{onSubmit:t=>{t.preventDefault(),Gr()},id:"address-form-inner",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(k,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(le,{name:"zip_code",control:b.control,render:({field:t})=>e.jsx(Pt,{className:"flex-1 space-y-0",children:e.jsx(St,{children:e.jsx(nt,{placeholder:"Digite o CEP",...t})})})}),b.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(k,{htmlFor:"street",children:"Rua *"}),e.jsx(se,{id:"street",...b.register("street")}),b.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"number",children:"Número *"}),e.jsx(se,{id:"number",...b.register("number")}),b.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(k,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(se,{id:"neighborhood",...b.register("neighborhood")}),b.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"city",children:"Cidade *"}),e.jsx(se,{id:"city",...b.register("city")}),b.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.city.message})]}),e.jsxs(Q,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:je.isPending||D,children:[je.isPending||D?e.jsx(me,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ot,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]})]}),D&&e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4 animate-spin"}),e.jsx(oe,{children:"Calculando Taxa de Entrega..."})]}),K&&!D&&e.jsxs(e.Fragment,{children:[x.delivery_enabled!==!1&&!Ee&&e.jsxs(ne,{variant:"destructive",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(oe,{children:"Fora da Área de Entrega"}),e.jsx(ie,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(x.delivery_enabled===!1||Ee&&ce)&&e.jsxs(ne,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(oe,{children:"Entrega Disponível"}),e.jsxs(ie,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(pe),". Tempo estimado: ",ce?`${ce[0]} - ${ce[1]}`:"30 - 45"," minutos."]})]})]}),K&&Y&&e.jsx("div",{className:"mt-6",children:e.jsx(rn,{latitude:Y[0],longitude:Y[1],address:`${I[1]}, ${I[2]} - ${I[4]}, ${I[3]}, ${I[0]}`})})]})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(mr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(J,{children:[e.jsx(le,{name:"payment_method_id",control:i.control,render:({field:t})=>e.jsx(Ae,{onValueChange:s=>{var c;const l=U==null?void 0:U.find(N=>N.id===s),p=(c=l==null?void 0:l.name)==null?void 0:c.includes("online"),u=!!F&&F.trim()!=="";Kr(s,!!p,u)},value:t.value,className:"space-y-3",children:U==null?void 0:U.map(s=>{var c;const l=(c=s.name)==null?void 0:c.includes("online"),p=!!F&&F.trim()!=="",u=l&&!p;return e.jsx(k,{htmlFor:s.id,className:fe("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",u&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(be,{value:s.id,id:s.id,disabled:u}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description}),u&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},s.id)})})}),i.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:i.formState.errors.payment_method_id.message})]})]}),de&&e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ft,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(se,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z),...i.register("change_for")}),((Xe=i.formState.errors.change_for)==null?void 0:Xe.message)&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message}),((He=i.formState.errors.change_for)==null?void 0:He.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message})]})})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(W,{className:"text-xl flex items-center gap-2",children:[e.jsx(mt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(ot,{id:"notes",...i.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(X,{className:"shadow-lg",children:[e.jsx(H,{children:e.jsx(W,{className:"text-2xl",children:"Resumo"})}),e.jsxs(J,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:f.map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[t.quantity,"x ",t.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.subtotal)})]},t.product.id))}),e.jsx(tr,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(h)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(pe)})]})]}),e.jsx(tr,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)})]}),e.jsx(Q,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ke,children:Ke?e.jsx(me,{className:"h-5 w-5 animate-spin mr-2"}):ge?"Pagar e Finalizar":"Confirmar Pedido"}),M==="delivery"&&!K&&e.jsxs(ne,{variant:"destructive",className:"mt-3",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(ie,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Oe,{to:`/menu/${x.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{ea as default};
