import{j as e,a as W,u as X,b as Y}from"./tanstack-C7aOFagJ.js";import{c as ee,j as i,C as I,e as q,f as A,$ as se,b as B,B as D,L as O,af as re,o as oe,n as x,O as P,q as ae,N as T,p as R,r as ne,m as te,F as le,z as d,A as t,E as u,G as l,I as p,H as c,T as ie,h as ce,aB as $,P as de,t as ue,s as G}from"./index-D8IjPnex.js";import{S as me}from"./switch-CjAnUwDF.js";import{r as h,j as he}from"./vendor-DjsPZZVP.js";import{L as xe,Z as k,g as pe}from"./location-BEDlQ1Du.js";import"./supabase-BAEEEeUB.js";import"./index-C3WaO5Hu.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=ee("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),ge=({mapKey:a,markerPosition:n,onLocationChange:f,updateAddressFields:y,restaurant:g})=>{const[N,o]=h.useState(!1),w=h.useCallback(async()=>{o(!0);const z=i.loading("Buscando endereço a partir do mapa..."),[r,j]=n;try{const m=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${j}&zoom=18&addressdetails=1`,E=await fetch(m);if(!E.ok)throw new Error("Falha na geocodificação reversa.");const _=await E.json();_.address?(y(_.address),i.success("Endereço atualizado com base na localização do mapa!")):i.warning("Não foi possível encontrar um endereço detalhado para esta localização.")}catch(m){i.error(`Erro na busca reversa: ${m.message}`)}finally{o(!1),i.dismiss(z)}},[n,y]),C=h.useMemo(()=>[g.street,g.number,g.neighborhood,g.city,g.zip_code].filter(Boolean).join(", "),[g]);return e.jsxs(I,{className:"mt-6",children:[e.jsx(q,{children:e.jsxs(A,{className:"flex items-center gap-2 text-lg",children:[e.jsx(se,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(B,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(xe,{center:n,markerPosition:n,onMarkerDragEnd:f,zoom:15},a)}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[70%] truncate",children:["Endereço atual: ",C||"N/A"]}),e.jsxs(D,{type:"button",variant:"outline",onClick:w,disabled:N,children:[N?e.jsx(O,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(re,{className:"h-4 w-4 mr-2"}),"Atualizar Endereço"]})]})]})]})},fe=h.memo(ge),be=a=>a.replace(/\D/g,""),ve=oe({name:x().min(1,"O nome do restaurante é obrigatório."),description:x().optional(),logo_url:x().url("URL do logo inválida.").optional().or(P("")),street:x().optional(),number:x().min(1,"O número é obrigatório."),neighborhood:x().optional(),city:x().optional(),zip_code:x().min(1,"O CEP é obrigatório.").transform(a=>a.replace(/\D/g,"")).refine(a=>a.length===8,{message:"O CEP deve ter 8 dígitos."}),phone:x().min(1,"Telefone é obrigatório.").transform(be).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:x().email("Email inválido.").optional().or(P("")),is_active:ae().default(!0),latitude:T(a=>String(a).replace(",","."),R.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:T(a=>String(a).replace(",","."),R.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),ye=async a=>{const{data:n,error:f}=await G.from("restaurants").select("*").eq("id",a).single();if(f)throw new Error(`Erro ao buscar dados do restaurante: ${f.message}`);if(!n)throw new Error("Nenhum restaurante encontrado.");return n},ze=()=>{const a=W(),{userRestaurantId:n}=he(),[f,y]=h.useState(!1),[g,N]=h.useState(!1),{data:o,isLoading:w,isError:C,error:z}=X({queryKey:["restaurantSettings",n],queryFn:()=>ye(n),enabled:!!n,staleTime:1e3*60*5}),r=ne({resolver:ue(ve),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});h.useEffect(()=>{o&&(r.reset({name:o.name||"",description:o.description||"",logo_url:o.logo_url||"",street:o.street||"",number:o.number||"",neighborhood:o.neighborhood||"",city:o.city||"",zip_code:o.zip_code||"",phone:o.phone||"",email:o.email||"",is_active:o.is_active??!0,latitude:o.latitude??null,longitude:o.longitude??null}),o.latitude&&o.longitude&&N(!0))},[o,r.reset]);const j=r.watch("latitude"),m=r.watch("longitude"),E=[-23.55052,-46.633308],_=h.useMemo(()=>typeof j=="number"&&typeof m=="number"&&!isNaN(j)&&!isNaN(m)?[j,m]:E,[j,m]),U=h.useCallback(s=>{r.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),r.setValue("number",s.house_number||"",{shouldValidate:!0}),r.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),r.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),r.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[r]),K=async()=>{if(!await r.trigger(["zip_code","number"])){i.error("Por favor, preencha o CEP e o Número corretamente.");return}const v=r.getValues(),V=v.zip_code.replace(/\D/g,""),Z=v.number;y(!0);const M=i.loading("Buscando endereço e coordenadas...");try{const S=await fetch(`https://viacep.com.br/ws/${V}/json/`);if(!S.ok)throw new Error("Falha na busca do CEP.");const b=await S.json();if(b.erro){i.error("CEP não encontrado.");return}r.setValue("street",b.logradouro,{shouldValidate:!0}),r.setValue("neighborhood",b.bairro,{shouldValidate:!0}),r.setValue("city",b.localidade,{shouldValidate:!0});const J=`${b.logradouro}, ${Z}, ${b.localidade}, ${b.uf}`,F=await pe(J);F?(r.setValue("latitude",F.lat,{shouldValidate:!0}),r.setValue("longitude",F.lng,{shouldValidate:!0}),N(!0),i.success("Endereço e mapa atualizados com sucesso!")):i.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(S){i.dismiss(M),i.error(`Erro na busca: ${S.message}`)}finally{y(!1),i.dismiss(M)}},Q=h.useCallback((s,v)=>{r.setValue("latitude",s,{shouldValidate:!0}),r.setValue("longitude",v,{shouldValidate:!0})},[r]),L=Y({mutationFn:async s=>{if(!n)throw new Error("ID do restaurante não disponível.");const v={name:s.name,description:s.description,logo_url:s.logo_url,street:s.street,number:s.number,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code.replace(/\D/g,""),phone:s.phone,email:s.email,is_active:s.is_active,latitude:s.latitude,longitude:s.longitude},{error:V}=await G.from("restaurants").update(v).eq("id",n);if(V)throw V},onSuccess:()=>{i.success("Configurações salvas com sucesso!"),a.invalidateQueries({queryKey:["restaurantSettings",n]})},onError:s=>i.error(`Erro ao salvar configurações: ${s.message}`)}),H=h.useMemo(()=>j===null||m===null?"map-settings-null":`map-settings-${j.toFixed(6)}-${m.toFixed(6)}`,[j,m]);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(I,{children:[e.jsx(q,{children:e.jsx(A,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(B,{children:[w&&e.jsx(te,{className:"h-96 w-full"}),C&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",z.message]}),!n&&!w&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),o&&!C&&!w&&e.jsx(le,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(s=>L.mutate(s)),className:"space-y-6",children:[e.jsx(d,{control:r.control,name:"name",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Nome do Restaurante *"}),e.jsx(l,{children:e.jsx(p,{...s})}),e.jsx(c,{})]})}),e.jsx(d,{control:r.control,name:"description",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Descrição"}),e.jsx(l,{children:e.jsx(ie,{...s,rows:3})}),e.jsx(c,{})]})}),e.jsx(d,{control:r.control,name:"logo_url",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"URL do Logo"}),e.jsx(l,{children:e.jsx(p,{...s})}),e.jsx(c,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{name:"zip_code",control:r.control,render:({field:s})=>e.jsxs(t,{className:"flex-1",children:[e.jsx(l,{children:e.jsx(k,{placeholder:"Digite o CEP",...s})}),e.jsx(c,{})]})}),e.jsx($,{name:"number",control:r.control,render:({field:s})=>e.jsxs(t,{className:"w-24",children:[e.jsx(l,{children:e.jsx(p,{placeholder:"Nº",...s})}),e.jsx(c,{})]})}),e.jsx(D,{type:"button",onClick:K,disabled:f,children:f?e.jsx(O,{className:"h-4 w-4 animate-spin"}):e.jsx(je,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(d,{control:r.control,name:"street",render:({field:s})=>e.jsxs(t,{className:"md:col-span-2",children:[e.jsx(u,{children:"Rua"}),e.jsx(l,{children:e.jsx(p,{...s,disabled:!0})}),e.jsx(c,{})]})}),e.jsx(d,{control:r.control,name:"number",render:({field:s})=>e.jsxs(t,{className:"md:col-span-1",children:[e.jsx(u,{children:"Número *"}),e.jsx(l,{children:e.jsx(p,{...s,disabled:!0})}),e.jsx(c,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:r.control,name:"neighborhood",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Bairro"}),e.jsx(l,{children:e.jsx(p,{...s,disabled:!0})}),e.jsx(c,{})]})}),e.jsx(d,{control:r.control,name:"city",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Cidade"}),e.jsx(l,{children:e.jsx(p,{...s,disabled:!0})}),e.jsx(c,{})]})})]}),e.jsx(d,{control:r.control,name:"zip_code",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"CEP *"}),e.jsx(l,{children:e.jsx(k,{...s,disabled:!0})}),e.jsx(c,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:g&&e.jsx(fe,{mapKey:H,markerPosition:_,onLocationChange:Q,updateAddressFields:U,restaurant:o})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:r.control,name:"latitude",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Latitude"}),e.jsx(l,{children:e.jsx(p,{...s,placeholder:"-22.7627908",value:s.value??""})}),e.jsx(c,{})]})}),e.jsx(d,{control:r.control,name:"longitude",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Longitude"}),e.jsx(l,{children:e.jsx(p,{...s,placeholder:"-47.408315",value:s.value??""})}),e.jsx(c,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:r.control,name:"phone",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Telefone *"}),e.jsx(l,{children:e.jsx(de,{...s})}),e.jsx(c,{})]})}),e.jsx(d,{control:r.control,name:"email",render:({field:s})=>e.jsxs(t,{children:[e.jsx(u,{children:"Email"}),e.jsx(l,{children:e.jsx(p,{...s})}),e.jsx(c,{})]})})]}),e.jsx(d,{control:r.control,name:"is_active",render:({field:s})=>e.jsxs(t,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(u,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(l,{children:e.jsx(me,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx(D,{type:"submit",className:"w-full h-12 text-lg",disabled:L.isPending||!n,children:L.isPending?"Salvando...":"Salvar Configurações"})]})})]})]})})})};export{ze as default};
