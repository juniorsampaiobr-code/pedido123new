import{c as w,u as E,L as T,a as z}from"./index-D6bl_y6n.js";import{u as B,b as H,c as R,j as e}from"./tanstack-d4AvmB45.js";import{o as U,s as g,u as O,t as Q}from"./types-DKlirIXB.js";import{s as c}from"./client-D5i5GwB9.js";import{B as j}from"./button-DsFq3Iwn.js";import{D as $,a as J,b as K,c as V,d as X,e as G}from"./dialog-BqnxrynT.js";import{F as W,c as x,a as y,b,d as N,e as C}from"./form-CAgpR4vy.js";import{I as k}from"./label-D3zDN2-W.js";import{M as Y,P as Z}from"./PhoneInput-CaXG2sly.js";import{C as ee}from"./CpfCnpjInput-DOVDBdYc.js";import{r as F,L as se}from"./vendor-CnEXr6gt.js";import{S as ae}from"./skeleton-Jf3He3nr.js";import{U as re}from"./user-DRBRGQqH.js";import{S as oe}from"./save-BF-XGXpk.js";import{C as S,T as te}from"./truck-ChM6a2qG.js";import{C as ne}from"./credit-card-A1Sq_L2L.js";import{P as ie}from"./package-LHicBchW.js";import{C as le}from"./circle-check-big-EedbfBLq.js";import{C as ce}from"./check-CB3GbOWq.js";import{C as de}from"./circle-x-DJAUkrwb.js";import{E as me}from"./euro-BzH0jocV.js";import{f as pe}from"./format-BeKxgCCE.js";import{p as ue}from"./pt-BR-kGHPxgjw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=w("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=w("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=w("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]),fe={pending:{label:"Pendente",icon:S,color:"bg-yellow-500"},preparing:{label:"Em Preparação",icon:ie,color:"bg-orange-500"},ready:{label:"Pronto",icon:le,color:"bg-green-500"},delivering:{label:"Em Entrega",icon:te,color:"bg-blue-500"},delivered:{label:"Entregue",icon:ce,color:"bg-primary"},cancelled:{label:"Cancelado",icon:de,color:"bg-destructive"},pending_payment:{label:"Aguardando Pag.",icon:me,color:"bg-gray-500"}},ge=r=>r.replace(/\D/g,""),je=r=>r.replace(/\D/g,""),ye=U({name:g().min(1,"Nome é obrigatório."),phone:g().min(1,"Telefone é obrigatório.").transform(ge).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),cpf_cnpj:g().min(1,"CPF/CNPJ é obrigatório.").transform(je).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."})}),be=async r=>{const{data:i,error:a}=await c.from("orders").select(`
      *,
      order_items(*, products(name)),
      payment_methods(name)
    `).eq("customer_id",r).order("created_at",{ascending:!1}).limit(5);if(a)throw console.error("Erro ao buscar pedidos do cliente:",a),new Error(`Erro ao buscar histórico de pedidos: ${a.message}`);return i},$e=({isOpen:r,onClose:i,customer:a})=>{const v=B(),[M,_]=F.useState(null),t=O({resolver:Q(ye),defaultValues:{name:"",phone:"",cpf_cnpj:""}}),{data:d,isLoading:L}=H({queryKey:["customerOrders",a==null?void 0:a.id],queryFn:()=>be(a.id),enabled:!!(a!=null&&a.id)&&r,staleTime:0});F.useEffect(()=>{r&&(async()=>{const{data:{user:o}}=await c.auth.getUser();if(o){if(_(o.email||null),a)t.reset({name:a.name||"",phone:a.phone||"",cpf_cnpj:a.cpf_cnpj||""});else if(r){const n=o.user_metadata;t.reset({name:n.full_name||"",phone:n.phone||"",cpf_cnpj:n.cpf_cnpj||""})}}else t.reset({name:"",phone:"",cpf_cnpj:""}),_(null)})()},[a,t,r]);const f=R({mutationFn:async s=>{var p,u;const o=await c.auth.getUser(),n=(p=o.data.user)==null?void 0:p.id;if(!(a!=null&&a.id)&&!n)throw new Error("ID do cliente ou usuário não encontrado.");const m={name:s.name,phone:s.phone,cpf_cnpj:s.cpf_cnpj||null};if(a!=null&&a.id){const{error:l}=await c.from("customers").update(m).eq("id",a.id);if(l)throw new Error(l.message)}else if(n){const l={...m,user_id:n,name:s.name,phone:s.phone,email:((u=o.data.user)==null?void 0:u.email)||null},{error:h}=await c.from("customers").insert(l);if(h)throw new Error(h.message)}else throw new Error("Não foi possível identificar o cliente para salvar.")},onSuccess:()=>{E.success("Perfil atualizado com sucesso!"),v.invalidateQueries({queryKey:["menuCustomerData"]}),v.invalidateQueries({queryKey:["checkoutCustomerData"]}),i()},onError:s=>{E.error(`Erro ao atualizar perfil: ${s.message}`)}}),I=s=>{f.mutate(s)},q=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s);return e.jsx($,{open:r,onOpenChange:i,children:e.jsxs(J,{className:"sm:max-w-xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(K,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5 text-primary"}),"Seu Perfil de Cliente"]}),e.jsx(X,{children:"Atualize seus dados de contato e identificação."})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 pt-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold border-b pb-2",children:"Dados Pessoais"}),e.jsx(W,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(I),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"})," Email"]}),e.jsx(k,{value:M||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email é usado para login e não pode ser alterado aqui."})]}),e.jsx(y,{control:t.control,name:"name",render:({field:s})=>e.jsxs(b,{children:[e.jsx(x,{children:"Nome Completo *"}),e.jsx(N,{children:e.jsx(k,{placeholder:"Seu nome",...s})}),e.jsx(C,{})]})}),e.jsx(y,{control:t.control,name:"phone",render:({field:s})=>e.jsxs(b,{children:[e.jsx(x,{children:"Telefone *"}),e.jsx(N,{children:e.jsx(Z,{...s})}),e.jsx(C,{})]})}),e.jsx(y,{control:t.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(b,{children:[e.jsx(x,{children:"CPF/CNPJ *"}),e.jsx(N,{children:e.jsx(ee,{...s})}),e.jsx(C,{})]})}),e.jsx("div",{className:"pt-4",children:e.jsxs(j,{type:"submit",disabled:f.isPending,className:"w-full",children:[f.isPending?e.jsx(T,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Salvar Alterações"]})})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold border-b pb-2 flex items-center gap-2",children:[e.jsx(xe,{className:"h-5 w-5 text-primary"}),"Últimos Pedidos"]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Apenas os 5 pedidos mais recentes são exibidos aqui."}),L?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((s,o)=>e.jsx(ae,{className:"h-20 w-full"},o))}):e.jsx("div",{className:"space-y-3",children:d&&d.length>0?d.map(s=>{var P;const o=fe[s.status||"pending"],n=s.id?s.id.slice(-4):"N/A",m=new Date(s.created_at),p=pe(m,"dd/MM/yy 'às' HH:mm",{locale:ue}),u=((P=s.payment_methods)==null?void 0:P.name)||"Não especificado",l=s.order_items.slice(0,2).map(A=>{var D;return((D=A.products)==null?void 0:D.name)||"Item"}).join(", "),h=s.order_items.length>2?` +${s.order_items.length-2} itens`:"";return e.jsxs("div",{className:"border p-3 rounded-lg hover:bg-muted/50 transition-colors space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("p",{className:"font-bold text-sm",children:["Pedido #",n]}),e.jsx("span",{className:z("text-xs font-semibold px-2 py-0.5 rounded-full text-white flex-shrink-0",o.color),children:o.label})]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[l,h]}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-muted-foreground pt-1 border-t border-dashed border-muted-foreground/30",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"h-3 w-3"}),e.jsx("span",{children:p})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"h-3 w-3"}),e.jsx("span",{children:u})]}),e.jsx("span",{className:"font-bold text-foreground",children:q(s.total_amount)})]}),d[0].id===s.id&&e.jsx(se,{to:`/order-success/${s.id}`,onClick:i,children:e.jsxs(j,{variant:"secondary",size:"sm",className:"w-full mt-2",children:[e.jsx(he,{className:"h-4 w-4 mr-2"})," Ver Pedido"]})})]},s.id)}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Nenhum pedido encontrado."})})]})]}),e.jsx(G,{className:"pt-4",children:e.jsx(j,{type:"button",variant:"outline",onClick:i,children:"Fechar"})})]})})};export{$e as C,Qe as L};
