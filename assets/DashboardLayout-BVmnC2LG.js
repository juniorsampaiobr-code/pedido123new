import{j as e,a as Z,u as ee,b as he}from"./tanstack-C7aOFagJ.js";import{i as re,L as fe,r as l,h as pe,O as xe}from"./vendor-DjsPZZVP.js";import{c as k,a as ge,S as ae,X as je,aB as be,aC as ye,B as w,aD as ve,o as Se,l as G,s as p,p as we,t as Ne,i as d,D as Ce,q as Ee,r as Pe,v as Ae,U as O,w as ke,F as De,g as Te,I as H,x as $,y as K,z as Q,A as B,E as X,P as _e,G as Ie,L as se,aE as Me,aF as qe,j as I,O as W,R as J,V as Y,aG as M,aH as q,aI as L}from"./index-CHvJi2XO.js";import{L as Le}from"./Logo-Dw1U6r2u.js";import{P as Re}from"./package-CYhSmXkN.js";import{C as Oe}from"./credit-card-lkieMkH3.js";import{T as Fe}from"./truck-Bi1SvfWU.js";import{S as ze}from"./settings-B0TC_RxR.js";import{A as Ue,a as Ve,b as Ge,c as He,d as $e,e as Ke,g as Qe}from"./alert-dialog-N1Oj-3dO.js";import{V as oe}from"./volume-2-BCAeIHbP.js";import{S as Be}from"./use-sound-BhkF2W4n.js";import{S as P}from"./skeleton-xiKd25XY.js";import{M as Xe}from"./mail-BeGqgA2v.js";import{C as R}from"./circle-alert-CzcxQkDO.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=k("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=k("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=k("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=k("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),er=[{href:"/dashboard",label:"Dashboard",icon:We},{href:"/products",label:"Produtos",icon:Re},{href:"/orders",label:"Pedidos",icon:ae},{href:"/cashier",label:"Caixa",icon:Ze},{href:"/hours",label:"Hor√°rios",icon:je},{href:"/payments",label:"Pagamentos",icon:Oe},{href:"/delivery",label:"Taxa de Entrega",icon:Fe},{href:"/settings",label:"Configura√ß√µes",icon:ze}],ne=()=>{const r=re();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(Le,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:er.map(a=>e.jsx("li",{children:e.jsxs(fe,{to:a.href,className:ge("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",r.pathname===a.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(a.icon,{className:"h-4 w-4"}),a.label]})},a.href))})})]})},rr=({isOpen:r,onEnable:a})=>e.jsx(Ue,{open:r,children:e.jsxs(Ve,{children:[e.jsxs(Ge,{children:[e.jsxs(He,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-6 w-6 text-primary"}),"Ativar Notifica√ß√µes Sonoras?"]}),e.jsxs($e,{children:["Para garantir que voc√™ n√£o perca nenhum novo pedido, precisamos da sua permiss√£o para tocar um som de notifica√ß√£o.",e.jsx("br",{}),e.jsx("br",{}),'Ao clicar em "Ativar", um som de teste ser√° reproduzido.']})]}),e.jsx(Ke,{children:e.jsx(Qe,{onClick:a,className:"w-full",children:"Sim, ativar som"})})]})}),ar=()=>e.jsxs(be,{children:[e.jsx(ye,{asChild:!0,children:e.jsx(w,{variant:"outline",size:"icon",children:e.jsx(Je,{className:"h-4 w-4"})})}),e.jsx(ve,{side:"left",className:"p-0 w-64",children:e.jsx(ne,{})})]}),sr=r=>r.replace(/\D/g,""),or=Se({full_name:G().min(1,"Nome √© obrigat√≥rio."),phone:G().min(1,"Telefone √© obrigat√≥rio.").transform(sr).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."})}),nr=async r=>{const{data:a,error:t}=await p.from("profiles").select("*").eq("id",r).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${t.message}`);return a||{id:r,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null}},tr=({isOpen:r,onClose:a,userId:t})=>{var i;const v=Z(),{data:j,isLoading:x}=ee({queryKey:["adminProfile",t],queryFn:()=>nr(t),enabled:!!t&&r,staleTime:0}),N=(i=p.auth.currentUser)==null?void 0:i.email,c=we({resolver:Ne(or),defaultValues:{full_name:"",phone:""}});l.useEffect(()=>{j&&c.reset({full_name:j.full_name||"",phone:j.phone||""})},[j,c]);const y=he({mutationFn:async u=>{if(!t)throw new Error("ID do usu√°rio n√£o encontrado.");const D={full_name:u.full_name,phone:u.phone},{error:C}=await p.from("profiles").upsert({...D,id:t},{onConflict:"id"});if(C)throw new Error(C.message)},onSuccess:()=>{d.success("Perfil atualizado com sucesso!"),v.invalidateQueries({queryKey:["adminProfile"]}),a()},onError:u=>{d.error(`Erro ao atualizar perfil: ${u.message}`)}}),n=u=>{y.mutate(u)};return e.jsx(Ce,{open:r,onOpenChange:a,children:e.jsxs(Ee,{className:"sm:max-w-[425px]",children:[e.jsxs(Pe,{children:[e.jsxs(Ae,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(ke,{children:"Atualize seus dados de contato."})]}),x?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(P,{className:"h-4 w-1/3"}),e.jsx(P,{className:"h-10 w-full"}),e.jsx(P,{className:"h-4 w-1/3"}),e.jsx(P,{className:"h-10 w-full"}),e.jsx(P,{className:"h-10 w-full mt-6"})]}):e.jsx(De,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(n),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Te,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Xe,{className:"h-4 w-4"})," Email"]}),e.jsx(H,{value:N||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx($,{control:c.control,name:"full_name",render:({field:u})=>e.jsxs(K,{children:[e.jsx(Q,{children:"Nome Completo *"}),e.jsx(B,{children:e.jsx(H,{placeholder:"Seu nome",...u})}),e.jsx(X,{})]})}),e.jsx($,{control:c.control,name:"phone",render:({field:u})=>e.jsxs(K,{children:[e.jsx(Q,{children:"Telefone *"}),e.jsx(B,{children:e.jsx(_e,{...u})}),e.jsx(X,{})]})}),e.jsx(Ie,{className:"pt-4",children:e.jsxs(w,{type:"submit",disabled:y.isPending,children:[y.isPending?e.jsx(se,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},ir=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes",icon:O}],lr=r=>{const a=ir.find(t=>t.href===r);return a?a.label:"Dashboard"},cr=async r=>{const{data:a,error:t}=await p.from("user_roles").select("role, restaurant_id").eq("user_id",r).limit(1).single();return t&&t.code!=="PGRST116"?(console.error("Error checking role and restaurant:",t),{role:null,restaurantId:null}):a?{role:a.role,restaurantId:a.restaurant_id}:{role:null,restaurantId:null}},dr=()=>{const r=pe(),a=re(),t=Z(),[v,j]=l.useState(null),[x,N]=l.useState(void 0),[c,y]=l.useState(null),n=l.useRef(null),[i,u]=l.useState("loading"),[D,C]=l.useState(!1),[E,T]=l.useState(null);qe();const[te,F]=l.useState(!1),[m,g]=l.useState(()=>localStorage.getItem("soundNotificationStatus")||"disabled");l.useEffect(()=>{localStorage.setItem("soundNotificationStatus",m)},[m]);const{data:h,isLoading:ie,isError:le,error:z}=ee({queryKey:["dashboardRestaurant",c],queryFn:async()=>{if(!c)throw new Error("Restaurant ID not found for user.");const{data:s,error:f}=await p.from("restaurants").select("*").eq("id",c).single();if(f)throw new Error(f.message);return s},enabled:!!v&&(x==="admin"||x==="moderator")&&!!c,staleTime:1/0});l.useEffect(()=>{const s=async o=>{if(!(o!=null&&o.user)){j(null),N(null),y(null),r("/admin-auth",{replace:!0});return}const{role:b,restaurantId:V}=await cr(o.user.id);if(j(o.user),N(b),y(V),b==="user"){d.error("Acesso restrito.",{description:"Esta conta √© de cliente e n√£o tem permiss√£o para acessar o painel.",duration:5e3}),await p.auth.signOut();const me=`${window.location.origin}${window.location.pathname}#/`;window.location.href=me;return}b!=="admin"&&b!=="moderator"&&(d.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),r("/admin-auth",{replace:!0})),(b==="admin"||b==="moderator")&&!V&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:f}}=p.auth.onAuthStateChange((o,b)=>{o==="SIGNED_OUT"?(j(null),N(null),y(null),r("/admin-auth",{replace:!0})):s(b)});return p.auth.getSession().then(({data:{session:o}})=>{s(o)}),()=>f.unsubscribe()},[r]),l.useEffect(()=>{var s;h!=null&&h.notification_sound_url?((s=n.current)==null?void 0:s.src)!==h.notification_sound_url&&u("loading"):u("error")},[h==null?void 0:h.notification_sound_url]),l.useEffect(()=>{!localStorage.getItem("hasSeenSoundPermissionModal")&&m!=="enabled"&&i==="ready"&&C(!0)},[m,i]);const S=l.useCallback(()=>{n.current&&(n.current.pause(),n.current.loop=!1,T(null))},[]),U=l.useCallback(s=>{if(m==="enabled"&&n.current&&i==="ready"){if(E)return;T(s),n.current.loop=!0,n.current.play().catch(f=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",f),T(null),d.warning("N√£o foi poss√≠vel tocar o som automaticamente.",{description:"Interaja com a p√°gina para permitir a reprodu√ß√£o de som."})})}},[m,i,E]);l.useEffect(()=>{if(x!=="admin"&&x!=="moderator"||!c)return;const s=p.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},f=>{t.invalidateQueries({queryKey:["orders"]});const o=f.new;o.status==="pending"&&o.id&&o.restaurant_id===c&&(d.info("üîî Novo pedido recebido!",{description:`Pedido #${o.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),U(o.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},f=>{t.invalidateQueries({queryKey:["orders"]});const o=f.new;o.id===E&&S(),o.status==="pending"&&o.id&&f.old.status==="pending_payment"&&o.restaurant_id===c&&d.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${o.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3})}).subscribe();return()=>{p.removeChannel(s)}},[t,U,S,E,x,c]);const _=l.useCallback(()=>{if(m==="enabled"&&n.current&&i==="ready"){S(),n.current.loop=!1,n.current.currentTime=0;const s=n.current.play();s!==void 0&&s.then(()=>{console.log("Som de teste tocado com sucesso")}).catch(f=>{console.error("Erro ao tocar som de teste:",f),g("error"),d.error("N√£o foi poss√≠vel tocar o som de teste.",{description:"Interaja com a p√°gina para permitir a reprodu√ß√£o de som."})})}else i==="ready"?(g("enabled"),setTimeout(()=>_(),100)):(d.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado.",{description:"Verifique se a URL do som est√° correta nas Configura√ß√µes."}),g("error"))},[m,i,S]),ce=async()=>{if(i!=="ready"||!n.current){d.error("O arquivo de som ainda n√£o est√° pronto. Tente novamente em um momento.");return}try{n.current.currentTime=0,await n.current.play(),g("enabled"),d.success("Notifica√ß√µes sonoras ativadas!"),localStorage.setItem("hasSeenSoundPermissionModal","true")}catch(s){console.error("Audio activation failed from modal:",s),d.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado a reprodu√ß√£o. Por favor, tente ativar manualmente no √≠cone do cabe√ßalho."}),g("error")}finally{C(!1)}},de=async()=>{if(m==="enabled"){S(),g("disabled"),d.info("Notifica√ß√µes sonoras desativadas.");return}if(i!=="ready"||!n.current){d.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado."),g("error");return}try{n.current.currentTime=0,await n.current.play(),g("enabled"),d.success("Notifica√ß√µes sonoras ativadas!",{description:"Voc√™ ouviu o som de teste."})}catch(s){console.error("Audio activation failed:",s),d.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado. Clique na p√°gina e tente novamente."}),g("error")}},ue=async()=>{await p.auth.signOut()};if(x===void 0||ie)return e.jsx(I,{});if(x!=="admin"&&x!=="moderator")return e.jsx(I,{});if(!c)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(W,{variant:"destructive",className:"max-w-md",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro de Configura√ß√£o"}),e.jsx(Y,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})});if(le)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(W,{variant:"destructive",className:"max-w-md",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro ao Carregar Restaurante"}),e.jsx(Y,{children:z instanceof Error?z.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})});if(!h)return e.jsx(I,{});const A=i!=="ready";return e.jsxs(Be.Provider,{value:{playSound:_,stopSoundLoop:S,soundStatus:m,loopingOrderId:E},children:[e.jsx(rr,{isOpen:D,onEnable:ce}),e.jsx(tr,{isOpen:te,onClose:()=>F(!1),userId:(v==null?void 0:v.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(ne,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(ar,{})}),e.jsx(ae,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:lr(a.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(M,{children:[e.jsx(q,{asChild:!0,children:e.jsx(w,{variant:"outline",size:"icon",onClick:()=>F(!0),"aria-label":"Meu Perfil",children:e.jsx(O,{className:"h-4 w-4"})})}),e.jsx(L,{children:"Meu Perfil"})]}),e.jsxs(M,{children:[e.jsx(q,{asChild:!0,children:e.jsx(w,{variant:"outline",size:"sm",onClick:_,disabled:A,children:"Testar Som"})}),A&&e.jsx(L,{children:i==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsxs(M,{children:[e.jsx(q,{asChild:!0,children:e.jsxs(w,{variant:"outline",size:"icon",onClick:de,disabled:A,"aria-label":m==="enabled"?"Desativar som":"Ativar som",children:[i==="loading"&&e.jsx(se,{className:"h-4 w-4 animate-spin"}),i==="ready"&&m==="enabled"&&e.jsx(oe,{className:"h-4 w-4 text-green-500"}),i==="ready"&&m==="disabled"&&e.jsx(Ye,{className:"h-4 w-4"}),i==="error"&&e.jsx(R,{className:"h-4 w-4 text-destructive"})]})}),A&&e.jsx(L,{children:i==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsx(w,{variant:"outline",onClick:ue,children:"Sair"})]})]})}),e.jsx(xe,{context:{restaurant:h,userRestaurantId:c}})]}),(h==null?void 0:h.notification_sound_url)&&e.jsx("audio",{ref:n,src:h.notification_sound_url,onCanPlayThrough:()=>{u("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:s=>{console.error("Erro ao carregar o √°udio:",s),d.error("Erro ao carregar o som de notifica√ß√£o.",{description:"Verifique o arquivo em Configura√ß√µes."}),u("error"),g("error")},className:"hidden"})]})]})},Er=l.memo(dr);export{Er as default};
