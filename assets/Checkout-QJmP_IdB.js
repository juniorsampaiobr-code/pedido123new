import{j as e,b as Mr,u as ue,c as Ar}from"./tanstack-DS1wz2fm.js";import{r as u,R as Xe,u as Tr,h as qr,L as Dr}from"./vendor-DPb28zz8.js";import{o as zr,s as k,l as Br,e as Or,c as Ze,p as Gr,n as Ur,Z as G,u as Kr,t as Zr}from"./types-dEzyxwQ3.js";import{s as T}from"./client-BP8r4skJ.js";import{c as Jr,g as Ye,h as Ve,P as ye,j as Pe,i as Hr,t as Qr,m as Wr,b as ve,u as g,a as Xr,v as Yr,L as me}from"./index-BUwp1co6.js";import{B as pe}from"./button-Cu3hB-bv.js";import{C as he,b as fe,c as ge,a as xe}from"./card-C21rN-Dn.js";import{I as L,L as _e}from"./label-DVQHZV6G.js";import{c as er,R as es,I as rs}from"./index-CJSaUxq7.js";import{u as ss}from"./index-Dm27xrF8.js";import{u as as}from"./index-CJmVBZLB.js";import{S as Je}from"./separator-BGsQ-Qq1.js";import{T as os}from"./textarea-CPdt7lGE.js";import{A as ae,a as oe,b as te}from"./alert-gBtguY9I.js";import{F as ts,b as E,c as j,a as C,e as P,d as q}from"./form-e9lCMucd.js";import{Z as He,S as ns,L as is}from"./ZipCodeInput-CJ8iUuGc.js";import{T as Qe}from"./terminal-Cx6cJUcj.js";import{A as ls}from"./arrow-left-gXDpOjmK.js";import{T as Ee}from"./truck-FKltdYp5.js";import{S as rr,a as cs}from"./store-Dxh00oF8.js";import{M as ds}from"./map-pin-CyK6oeQ0.js";import{C as sr}from"./credit-card-1T7L5414.js";import{P as us}from"./package-D5wEYY4n.js";import{D as ms}from"./dollar-sign-D9V2lA0x.js";import"./supabase-BT-vd-uw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=Jr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);var Fe="Radio",[hs,ar]=Ye(Fe),[fs,gs]=hs(Fe),or=u.forwardRef((a,r)=>{const{__scopeRadio:t,name:m,checked:i=!1,required:p,disabled:d,value:h="on",onCheck:x,form:y,..._}=a,[R,S]=u.useState(null),v=Ve(r,D=>S(D)),b=u.useRef(!1),w=R?y||!!R.closest("form"):!0;return e.jsxs(fs,{scope:t,checked:i,disabled:d,children:[e.jsx(ye.button,{type:"button",role:"radio","aria-checked":i,"data-state":lr(i),"data-disabled":d?"":void 0,disabled:d,value:h,..._,ref:v,onClick:Pe(a.onClick,D=>{i||x==null||x(),w&&(b.current=D.isPropagationStopped(),b.current||D.stopPropagation())})}),w&&e.jsx(ir,{control:R,bubbles:!b.current,name:m,value:h,checked:i,required:p,disabled:d,form:y,style:{transform:"translateX(-100%)"}})]})});or.displayName=Fe;var tr="RadioIndicator",nr=u.forwardRef((a,r)=>{const{__scopeRadio:t,forceMount:m,...i}=a,p=gs(tr,t);return e.jsx(Hr,{present:m||p.checked,children:e.jsx(ye.span,{"data-state":lr(p.checked),"data-disabled":p.disabled?"":void 0,...i,ref:r})})});nr.displayName=tr;var xs="RadioBubbleInput",ir=u.forwardRef(({__scopeRadio:a,control:r,checked:t,bubbles:m=!0,...i},p)=>{const d=u.useRef(null),h=Ve(d,p),x=as(t),y=Qr(r);return u.useEffect(()=>{const _=d.current;if(!_)return;const R=window.HTMLInputElement.prototype,v=Object.getOwnPropertyDescriptor(R,"checked").set;if(x!==t&&v){const b=new Event("click",{bubbles:m});v.call(_,t),_.dispatchEvent(b)}},[x,t,m]),e.jsx(ye.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...i,tabIndex:-1,ref:h,style:{...i.style,...y,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ir.displayName=xs;function lr(a){return a?"checked":"unchecked"}var js=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],be="RadioGroup",[ys,ia]=Ye(be,[er,ar]),cr=er(),dr=ar(),[vs,bs]=ys(be),ur=u.forwardRef((a,r)=>{const{__scopeRadioGroup:t,name:m,defaultValue:i,value:p,required:d=!1,disabled:h=!1,orientation:x,dir:y,loop:_=!0,onValueChange:R,...S}=a,v=cr(t),b=ss(y),[w,D]=Wr({prop:p,defaultProp:i??null,onChange:R,caller:be});return e.jsx(vs,{scope:t,name:m,required:d,disabled:h,value:w,onValueChange:D,children:e.jsx(es,{asChild:!0,...v,orientation:x,dir:b,loop:_,children:e.jsx(ye.div,{role:"radiogroup","aria-required":d,"aria-orientation":x,"data-disabled":h?"":void 0,dir:b,...S,ref:r})})})});ur.displayName=be;var mr="RadioGroupItem",pr=u.forwardRef((a,r)=>{const{__scopeRadioGroup:t,disabled:m,...i}=a,p=bs(mr,t),d=p.disabled||m,h=cr(t),x=dr(t),y=u.useRef(null),_=Ve(r,y),R=p.value===i.value,S=u.useRef(!1);return u.useEffect(()=>{const v=w=>{js.includes(w.key)&&(S.current=!0)},b=()=>S.current=!1;return document.addEventListener("keydown",v),document.addEventListener("keyup",b),()=>{document.removeEventListener("keydown",v),document.removeEventListener("keyup",b)}},[]),e.jsx(rs,{asChild:!0,...h,focusable:!d,active:R,children:e.jsx(or,{disabled:d,required:p.required,checked:R,...x,...i,name:p.name,ref:_,onCheck:()=>p.onValueChange(i.value),onKeyDown:Pe(v=>{v.key==="Enter"&&v.preventDefault()}),onFocus:Pe(i.onFocus,()=>{var v;S.current&&((v=y.current)==null||v.click())})})})});pr.displayName=mr;var Ns="RadioGroupIndicator",hr=u.forwardRef((a,r)=>{const{__scopeRadioGroup:t,...m}=a,i=dr(t);return e.jsx(nr,{...i,...m,ref:r})});hr.displayName=Ns;var fr=ur,gr=pr,ws=hr;const je=u.forwardRef(({className:a,...r},t)=>e.jsx(fr,{className:ve("grid gap-2",a),...r,ref:t}));je.displayName=fr.displayName;const W=u.forwardRef(({className:a,...r},t)=>e.jsx(gr,{ref:t,className:ve("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),...r,children:e.jsx(ws,{className:"flex items-center justify-center",children:e.jsx(ps,{className:"h-2.5 w-2.5 fill-current text-current"})})}));W.displayName=gr.displayName;const Cs=a=>{let r=a.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},xr=Xe.forwardRef(({className:a,value:r,onChange:t,...m},i)=>{const p=d=>{const h=d.target.value,x=Cs(h),y={...d,target:{...d.target,value:x}};t(y)};return e.jsx(L,{ref:i,type:"tel",className:ve("w-full",a),placeholder:"(99) 99999-9999",value:r,onChange:p,...m})});xr.displayName="PhoneInput";const _s=a=>{let r=a.replace(/\D/g,"");return r.length>14&&(r=r.slice(0,14)),r.length<=11?(r.length>9&&(r=`${r.slice(0,9)}-${r.slice(9)}`),r.length>6&&(r=`${r.slice(0,6)}.${r.slice(6)}`),r.length>3&&(r=`${r.slice(0,3)}.${r.slice(3)}`),r):(r.length>12&&(r=`${r.slice(0,12)}-${r.slice(12)}`),r.length>8&&(r=`${r.slice(0,8)}/${r.slice(8)}`),r.length>5&&(r=`${r.slice(0,5)}.${r.slice(5)}`),r.length>2&&(r=`${r.slice(0,2)}.${r.slice(2)}`),r)},jr=Xe.forwardRef(({className:a,value:r,onChange:t,...m},i)=>{const p=d=>{const h=d.target.value,x=_s(h),y={...d,target:{...d.target,value:x}};t(y)};return e.jsx(L,{ref:i,type:"tel",className:ve("w-full",a),placeholder:"CPF ou CNPJ",value:r,onChange:p,maxLength:18,...m})});jr.displayName="CpfCnpjInput";const Es=(a,r,t,m)=>{const p=(t-a)*(Math.PI/180),d=(m-r)*(Math.PI/180),h=Math.sin(p/2)*Math.sin(p/2)+Math.cos(a*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))},We=async a=>{const r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`;try{const t=await fetch(r);if(!t.ok)throw new Error("Falha na API de geocodificação.");const m=await t.json();if(m&&m.length>0){const i=parseFloat(m[0].lat),p=parseFloat(m[0].lon);if(!isNaN(i)&&!isNaN(p))return[i,p]}return console.warn("Geocodificação falhou para o endereço:",a,"Usando coordenadas padrão."),null}catch(t){return console.error("Erro durante a geocodificação:",t),g.error("Erro ao buscar coordenadas do endereço. Verifique o endereço."),null}},Ps=(a,r,t)=>{const m=Es(r[0],r[1],a[0],a[1]),i=t.find(p=>m<=p.max_distance_km);if(i){const p=i.delivery_fee||0,d=i.min_delivery_time_minutes||0,h=d+15;return{fee:parseFloat(p.toFixed(2)),minTime:d,maxTime:h}}return null},yr=a=>a.replace(/\D/g,""),Re=a=>a.replace(/\D/g,""),Se=a=>a.replace(/\D/g,""),Rs=zr({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(yr).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:k().email("Email inválido.").optional().or(Br("")),delivery_option:Or(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:k().optional().default(""),number:k().optional().default(""),complement:k().optional().default(""),neighborhood:k().optional().default(""),city:k().optional().default(""),zip_code:k().optional().default("").transform(Re).refine(a=>a.length===8||a.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ze.number().optional().nullable(),longitude:Ze.number().optional().nullable(),payment_method_id:k().min(1,"Selecione uma forma de pagamento."),notes:k().optional(),cpf_cnpj:k().optional().default("").transform(Se).refine(a=>a.length===0||a.length===11||a.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Gr(a=>a==null||a===""?null:String(a).replace(",","."),Ur({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((a,r)=>{if(a.delivery_option==="delivery"&&(a.street.trim()===""&&r.addIssue({code:G.custom,message:"Rua é obrigatória.",path:["street"]}),a.number.trim()===""&&r.addIssue({code:G.custom,message:"Número é obrigatório.",path:["number"]}),a.neighborhood.trim()===""&&r.addIssue({code:G.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),a.city.trim()===""&&r.addIssue({code:G.custom,message:"Cidade é obrigatória.",path:["city"]}),a.zip_code.length!==8&&r.addIssue({code:G.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]})),a.payment_method_id==="Dinheiro"&&a.change_for!==null&&a.change_for!==void 0&&a.change_for<=0&&r.addIssue({code:G.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),a.payment_method_id==="Pagamento online: Pix/Cartão"){const i=Se(a.cpf_cnpj||"");i.length!==11&&i.length!==14&&r.addIssue({code:G.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Ss=()=>{const a=window.location.origin,t=window.location.pathname.split("/")[1];return t?`${a}/${t}`:a},Vs=async()=>{const{data:a,error:r}=await T.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!a)throw new Error("Nenhum restaurante ativo encontrado.");return a},Fs=async a=>{const{data:r,error:t}=await T.from("restaurants").select("delivery_enabled").eq("id",a).single();if(t)throw new Error(`Erro ao buscar status de entrega: ${t.message}`);return r.delivery_enabled??!0},Is=async a=>{const{data:r,error:t}=await T.from("payment_methods").select("*").eq("restaurant_id",a).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return r},$s=async a=>{const{data:r,error:t}=await T.from("delivery_zones").select("*").eq("restaurant_id",a).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return r},ks=a=>{switch(a){case"DollarSign":return ms;case"Smartphone":return cs;case"CreditCard":return sr;case"Package":return us;default:return rr}},Ls=({subtotal:a,deliveryFee:r,total:t,items:m})=>e.jsxs(he,{className:"sticky top-4",children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(xe,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(i=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[i.quantity,"x ",i.name,i.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",i.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i.price*i.quantity)})]},i.id))}),e.jsx(Je,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:r>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r):"Grátis"})]})]}),e.jsx(Je,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]})]})]}),la=()=>{const a=Tr(),r=Mr(),t=Xr(),{items:m,subtotal:i,deliveryFee:p,total:d,setDeliveryFee:h,clearCart:x}=t,[y]=qr(),[_,R]=u.useState(!1),[S,v]=u.useState(!1),[b,w]=u.useState(null),[D,U]=u.useState(null),[Ie,$e]=u.useState(""),[X,ke]=u.useState(""),[Le,Me]=u.useState(!1),[vr,Y]=u.useState(!1),[V,br]=u.useState("search"),ee=y.get("status"),ne=y.get("external_reference"),Ae=y.has("collection_id")||y.has("external_reference"),[ie,Te]=u.useState(!!ne);u.useEffect(()=>{if(ne)if(ee==="approved"||ee==="failure"||ee==="pending"){a(`/order-success/${ne}?status=${ee}`,{replace:!0});return}else Ae&&(g.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Te(!1));else Te(!1)},[ne,ee,Ae,a]);const{data:n,isLoading:Nr,isError:wr,error:Cr}=ue({queryKey:["checkoutRestaurantData"],queryFn:Vs}),{data:Ne=!0,isLoading:_r}=ue({queryKey:["deliveryStatus",n==null?void 0:n.id],queryFn:()=>Fs(n.id),enabled:!!(n!=null&&n.id),initialData:!0}),{data:K=[],isLoading:Er}=ue({queryKey:["checkoutPaymentMethods",n==null?void 0:n.id],queryFn:()=>Is(n.id),enabled:!!(n!=null&&n.id)}),{data:qe=[],isLoading:Pr}=ue({queryKey:["checkoutDeliveryZones",n==null?void 0:n.id],queryFn:()=>$s(n.id),enabled:!!(n!=null&&n.id)}),Rr=Nr||_r||Er||Pr,Sr=wr,De=Cr,o=Kr({resolver:Zr(Rs),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),re=o.watch("delivery_option"),we=o.watch("payment_method_id"),Z=K.find(s=>s.id===we),z=(Z==null?void 0:Z.name)==="Pagamento online: Pix/Cartão",le=(Z==null?void 0:Z.name)==="Dinheiro",F=o.watch("latitude"),I=o.watch("longitude"),ce=o.watch(["street","number","complement","neighborhood","city","zip_code"]),J=re==="delivery",Vr=JSON.stringify({mode:V,fields:ce,lat:F,lng:I,deliveryOption:re}),ze=u.useMemo(()=>typeof F=="number"&&typeof I=="number"&&!isNaN(F)&&!isNaN(I)?[F,I]:n!=null&&n.latitude&&(n!=null&&n.longitude)?[n.latitude,n.longitude]:[-23.55052,-46.633308],[F,I,n]),Be=u.useCallback(s=>{o.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),o.setValue("number",s.house_number||X||"",{shouldValidate:!0}),o.setValue("complement",s.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),o.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[o,X]),Fr=async()=>{const s=Ie.replace(/\D/g,"");if(s.length!==8){g.warning("Por favor, digite um CEP válido.");return}Me(!0);const c=g.loading("Buscando endereço...");try{const l=await fetch(`https://viacep.com.br/ws/${s}/json/`);if(!l.ok)throw new Error("Falha na busca do CEP.");const f=await l.json();if(f.erro){g.error("CEP não encontrado.");return}o.setValue("street",f.logradouro,{shouldValidate:!0}),o.setValue("number",X,{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood",f.bairro,{shouldValidate:!0}),o.setValue("city",f.localidade,{shouldValidate:!0}),o.setValue("zip_code",f.cep,{shouldValidate:!0});const N=`${f.logradouro}, ${X||"1"}, ${f.localidade}, ${f.uf}`,$=await We(N);$?(o.setValue("latitude",$[0],{shouldValidate:!0}),o.setValue("longitude",$[1],{shouldValidate:!0}),Y(!0),g.success("Endereço encontrado e mapa atualizado!")):(o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),g.warning("Endereço encontrado, mas não foi possível obter as coordenadas. Ajuste o pino no mapa manualmente."))}catch(l){g.error(`Erro na busca: ${l.message}`)}finally{Me(!1),g.dismiss(c)}},Ir=u.useCallback(async(s,c)=>{o.setValue("latitude",s,{shouldValidate:!0}),o.setValue("longitude",c,{shouldValidate:!0});const l=g.loading("Atualizando endereço...");try{const f=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${c}&addressdetails=1`,N=await fetch(f);if(!N.ok)throw new Error("Falha ao obter detalhes do endereço.");const $=await N.json();$.address&&(Be($.address),g.success("Endereço atualizado a partir do mapa."))}catch(f){g.error(`Erro ao buscar endereço: ${f.message}`)}finally{g.dismiss(l)}},[o,Be]);u.useEffect(()=>{le||o.setValue("change_for",null,{shouldValidate:!0})},[le,o]),u.useEffect(()=>{re==="pickup"&&(h(0),w(null),U(null),o.setValue("latitude",null),o.setValue("longitude",null),Y(!1)),J&&(o.setValue("latitude",null),o.setValue("longitude",null),Y(!1),V==="manual"&&($e(""),ke("")),V==="search"&&(o.setValue("street",""),o.setValue("number",""),o.setValue("complement",""),o.setValue("neighborhood",""),o.setValue("city",""),o.setValue("zip_code","")))},[re,V,J,o,h]),u.useEffect(()=>{K.length>0&&!we&&o.setValue("payment_method_id",K[0].id)},[K,we,o]),u.useEffect(()=>{z?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},[z,o]),u.useEffect(()=>{const s=async()=>{if(!Ne){h(0),w(null),U(null);return}if(re==="pickup"||!(n!=null&&n.latitude)||!(n!=null&&n.longitude)){h(0),w(null),U(null);return}v(!0),w(null);let l=null;if(F&&I)l=[F,I];else{const[f,N,$,H,Q,B]=ce,O=Re(B);if(f&&N&&H&&Q&&O.length===8){const de=`${f}, ${N} ${$}, ${H}, ${Q}, ${B}`;l=await We(de),l&&(o.setValue("latitude",l[0]),o.setValue("longitude",l[1]),Y(!0))}}if(l){const f=[n.latitude,n.longitude],N=Ps(l,f,qe);N?(h(N.fee),w(null),U({minTime:N.minTime,maxTime:N.maxTime})):(h(0),w("Seu endereço está fora da nossa área de entrega."),U(null))}else{h(0),U(null);const[f,N,$,H,Q,B]=ce,O=f&&N&&H&&Q&&Re(B).length===8;J&&O?(w("Não foi possível localizar seu endereço para calcular a taxa. Por favor, verifique o endereço ou ajuste o pino no mapa."),n!=null&&n.latitude&&(n!=null&&n.longitude)&&(o.setValue("latitude",n.latitude),o.setValue("longitude",n.longitude),Y(!0))):w(null)}v(!1)},c=setTimeout(()=>{s()},500);return()=>clearTimeout(c)},[Vr,n,qe,o,h,J,F,I,V,ce,Ne]),u.useEffect(()=>{if(m.length===0&&!_&&!ie){const s=setTimeout(()=>{g.info("Seu carrinho está vazio. Adicione itens para continuar."),a("/menu")},0);return()=>clearTimeout(s)}},[m.length,a,_,ie]);const Oe=Ar({mutationFn:async s=>{if(!n)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&b)throw new Error(b);const c=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),l=s.delivery_option==="delivery"?c:"Retirada no Local";let f;const N=yr(s.phone),{data:$}=await T.from("customers").select("id").eq("phone",N).limit(1).single();if($)f=$.id;else{const{data:M,error:se}=await T.from("customers").insert({name:s.name,phone:N,email:s.email||null,address:l,latitude:s.latitude,longitude:s.longitude}).select("id").single();if(se)throw new Error(`Erro ao criar cliente: ${se.message}`);f=M.id}const H=z?"pending_payment":"pending",{data:Q,error:B}=await T.from("orders").insert({restaurant_id:n.id,customer_id:f,status:H,total_amount:d,delivery_fee:p,notes:s.notes,delivery_address:l}).select("id").single();if(B)throw new Error(`Erro ao criar pedido: ${B.message}`);const O=Q.id,Ue=m.map(M=>({order_id:O,product_id:M.product_id,quantity:M.quantity,unit_price:M.price,subtotal:M.price*M.quantity,notes:M.notes})),{error:de}=await T.from("order_items").insert(Ue);if(de)throw new Error(`Erro ao adicionar itens do pedido: ${de.message}`);if(z){x(),R(!0),g.info("Redirecionando para o pagamento online...");const M=Ss(),se={orderId:O,items:m,totalAmount:parseFloat(d.toFixed(2)),restaurantName:n.name,clientUrl:M,customerEmail:s.email||"cliente@pedido123.com",customerCpfCnpj:s.cpf_cnpj};console.log("Payload enviado para create-payment-preference:",se);try{const{data:A,error:Ke}=await T.functions.invoke("create-payment-preference",{body:se});if(Ke)throw new Error(Ke.message);if(A&&A.error)throw new Error(`Mercado Pago Error: ${A.error}`);if(A&&A.init_point){window.location.href=A.init_point;return}else throw new Error("Resposta de pagamento inválida: init_point não encontrado.")}catch(A){throw console.error("Erro ao criar preferência de pagamento:",A),new Error(`Falha ao processar pagamento online: ${A.message}`)}}return O},onSuccess:s=>{z||(g.success(`Pedido #${s.slice(-4)} realizado com sucesso!`),r.invalidateQueries({queryKey:["orders"]}),x(),a(`/order-success/${s}`))},onError:s=>{let c="Ocorreu um erro ao finalizar seu pedido. Por favor, tente novamente.";const l=s.message||"";l.includes("Mercado Pago Error:")?(c=l.split("Mercado Pago Error:")[1].trim(),c.includes("access token")&&(c="O Access Token do Mercado Pago está incorreto ou ausente. Por favor, verifique as configurações do restaurante.")):l.toLowerCase().includes("access token")||l.toLowerCase().includes("credentials")?c="Ocorreu um problema com a configuração de pagamento do restaurante. Por favor, entre em contato com o estabelecimento.":l.toLowerCase().includes("fora da nossa área de entrega")?c="Seu endereço está fora da nossa área de entrega.":l.toLowerCase().includes("inconsistência no valor total")?c="Erro de cálculo no pedido. Por favor, tente limpar o carrinho e refazer o pedido.":l.toLowerCase().includes("falha ao processar pagamento online")&&(c=l.split("Falha ao processar pagamento online:")[1]||"Erro ao processar pagamento online. Por favor, tente novamente."),g.error("Falha ao processar o pagamento",{description:c,duration:1e4}),R(!1)}}),$r=async s=>{if(z){const c=s.cpf_cnpj||"",l=Se(c);if(l.length!==11&&l.length!==14){o.setError("cpf_cnpj",{type:"manual",message:"CPF/CNPJ é obrigatório para pagamento online."}),g.error("Por favor, preencha o CPF/CNPJ corretamente.");return}}if(le){const c=s.change_for;if(c!=null&&c<d){g.error(`O valor do troco (R$ ${c.toFixed(2).replace(".",",")}) deve ser maior ou igual ao total do pedido (R$ ${d.toFixed(2).replace(".",",")}).`);return}}Oe.mutate(s)},kr=s=>{Object.keys(s).length>0&&g.error("Por favor, preencha todos os campos obrigatórios e corrija os erros.")};if(m.length===0&&!_&&!ie)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."});if(Rr||ie)return e.jsx(Yr,{});if(Sr)return e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(ae,{variant:"destructive",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro de Conexão"}),e.jsx(te,{children:De instanceof Error?De.message:"Não foi possível carregar os dados."})]})});const Ce=Oe.isPending||_||S,Lr=!J||!b&&p>=0,Ge=!Ce&&Lr;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Dr,{to:"/menu",children:e.jsx(pe,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(ls,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8 max-w-6xl",children:e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ts,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit($r,kr),className:"space-y-6",children:[e.jsxs(he,{children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(xe,{className:"space-y-4",children:[e.jsx(E,{control:o.control,name:"name",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Nome Completo *"}),e.jsx(L,{placeholder:"Seu nome",...s}),e.jsx(P,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(E,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Telefone *"}),e.jsx(xr,{...s}),e.jsx(P,{})]})}),e.jsx(E,{control:o.control,name:"email",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Email (Opcional)"}),e.jsx(L,{placeholder:"seu@email.com",...s}),e.jsx(P,{})]})})]})]})]}),e.jsxs(he,{children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(xe,{className:"space-y-4",children:[e.jsx(E,{control:o.control,name:"delivery_option",render:({field:s})=>e.jsxs(j,{className:"space-y-3",children:[e.jsx(q,{children:e.jsxs(je,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(q,{children:e.jsx(W,{value:"delivery"})}),e.jsx(Ee,{className:"h-5 w-5 text-primary"}),e.jsx(C,{className:"font-normal flex-1 cursor-pointer",children:"Delivery"})]}),e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(q,{children:e.jsx(W,{value:"pickup"})}),e.jsx(rr,{className:"h-5 w-5 text-primary"}),e.jsx(C,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(P,{})]})}),J&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(ds,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs(je,{value:V,onValueChange:s=>br(s),className:"flex gap-4",children:[e.jsxs(j,{className:"flex items-center space-x-2",children:[e.jsx(q,{children:e.jsx(W,{value:"search",id:"r-search"})}),e.jsx(_e,{htmlFor:"r-search",className:"cursor-pointer",children:"Buscar por CEP"})]}),e.jsxs(j,{className:"flex items-center space-x-2",children:[e.jsx(q,{children:e.jsx(W,{value:"manual",id:"r-manual"})}),e.jsx(_e,{htmlFor:"r-manual",className:"cursor-pointer",children:"Digitar Manualmente"})]})]}),V==="search"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{children:"Buscar Endereço por CEP e Número"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(He,{placeholder:"Digite o CEP",value:Ie,onChange:s=>$e(s.target.value)}),e.jsx(L,{placeholder:"Número",value:X,onChange:s=>ke(s.target.value)}),e.jsx(pe,{type:"button",onClick:Fr,disabled:Le,children:Le?e.jsx(me,{className:"h-4 w-4 animate-spin"}):e.jsx(ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(E,{control:o.control,name:"street",render:({field:s})=>e.jsxs(j,{className:"col-span-2",children:[e.jsx(C,{children:"Rua *"}),e.jsx(L,{...s,disabled:V==="search"}),e.jsx(P,{})]})}),e.jsx(E,{control:o.control,name:"number",render:({field:s})=>e.jsxs(j,{className:"col-span-1",children:[e.jsx(C,{children:"Número *"}),e.jsx(L,{...s,disabled:V==="search"}),e.jsx(P,{})]})})]}),e.jsx(E,{control:o.control,name:"complement",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Complemento (Opcional)"}),e.jsx(L,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(P,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(E,{control:o.control,name:"neighborhood",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Bairro *"}),e.jsx(L,{...s,disabled:V==="search"}),e.jsx(P,{})]})}),e.jsx(E,{control:o.control,name:"city",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Cidade *"}),e.jsx(L,{...s,disabled:V==="search"}),e.jsx(P,{})]})})]}),e.jsx(E,{control:o.control,name:"zip_code",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"CEP *"}),e.jsx(He,{...s,disabled:V==="search"}),e.jsx(P,{})]})}),vr&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(is,{center:ze,markerPosition:ze,onLocationChange:Ir,isInteractive:!1}),F!==null&&I!==null&&e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",F==null?void 0:F.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",I==null?void 0:I.toFixed(6)]})]})]}),S&&e.jsxs(ae,{children:[e.jsx(me,{className:"h-4 w-4 animate-spin"}),e.jsx(oe,{children:"Calculando Taxa..."}),e.jsx(te,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),b&&e.jsxs(ae,{variant:"destructive",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro de Entrega"}),e.jsx(te,{children:b})]}),p>0&&!S&&e.jsxs(ae,{className:"mt-4",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx(oe,{children:"Taxa de Entrega Aplicada"}),e.jsxs(te,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(p)]})]}),!Ne&&e.jsxs(ae,{className:"mt-4",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx(oe,{children:"Taxas de Entrega Desativadas"}),e.jsx(te,{children:"No momento, as taxas de entrega estão desativadas. A entrega será gratuita."})]})]})]})]}),e.jsxs(he,{children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(xe,{className:"space-y-4",children:[e.jsx(E,{control:o.control,name:"payment_method_id",render:({field:s})=>e.jsxs(j,{className:"space-y-3",children:[e.jsx(q,{children:e.jsx(je,{onValueChange:c=>{s.onChange(c);const l=K.find(f=>f.id===c);(l==null?void 0:l.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0}),(l==null?void 0:l.name)==="Pagamento online: Pix/Cartão"?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:K.map(c=>{const l=ks(c.icon||"Store");return e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(q,{children:e.jsx(W,{value:c.id})}),e.jsx(l,{className:"h-5 w-5 text-primary"}),e.jsxs(C,{className:"font-normal flex-1 cursor-pointer",children:[c.name,e.jsx("span",{className:"block text-xs text-muted-foreground",children:c.description})]})]},c.id)})})}),e.jsx(P,{})]})}),z&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(sr,{className:"h-4 w-4"})," Detalhes Adicionais"]}),e.jsx(E,{control:o.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"CPF/CNPJ * (obrigatório para pagamento online)"}),e.jsx(q,{children:e.jsx(jr,{...s})}),e.jsx(P,{})]})})]}),le&&e.jsx(E,{control:o.control,name:"change_for",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Precisa de troco para quanto? (R$)"}),e.jsx(L,{type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2}).format(d),...s,value:s.value===null||s.value===void 0?"":String(s.value),onChange:c=>s.onChange(c.target.value===""?null:c.target.value)}),e.jsx(P,{})]})}),e.jsx(E,{control:o.control,name:"notes",render:({field:s})=>e.jsxs(j,{children:[e.jsx(C,{children:"Observações do Pedido (Opcional)"}),e.jsx(os,{placeholder:"Ex: Tocar a campainha duas vezes...",...s,rows:2}),e.jsx(P,{})]})})]})]}),e.jsx("div",{className:"lg:hidden sticky bottom-0 bg-card p-4 border-t shadow-2xl",children:e.jsx(pe,{type:"submit",className:"w-full h-12 text-lg",disabled:!Ge,children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}`})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(pe,{type:"submit",className:"w-full h-12 text-lg",disabled:!Ge,children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}`})})]})})}),e.jsx("div",{className:"lg:col-span-1 hidden lg:block",children:e.jsx(Ls,{...t})})]})})]})};export{la as default};
