import{u as ie,j as e,a as Fr,b as be}from"./tanstack-C7aOFagJ.js";import{r as m,h as kr,i as Dr,k as Gr,L as $e}from"./vendor-DjsPZZVP.js";import{c as Tr,s as O,j as h,$ as Je,a0 as Se,a1 as ge,a2 as Ee,a3 as qr,a4 as Vr,a9 as $r,a5 as zr,a as de,D as ze,q as Be,L as ce,r as Br,v as Kr,w as Ur,B as W,C as K,e as U,f as Q,W as Ce,b as Z,o as We,l as D,K as Qr,av as Zr,aw as Xr,u as Hr,p as Ke,O as Y,Q as Ue,R as te,V as ne,d as Qe,a6 as Yr,ax as Jr,U as Ze,ay as Wr,h as F,I as J,az as se,P as et,i as rt,Y as tt,aA as nt,a7 as ot,T as at,t as Xe}from"./index-DuIGoJX7.js";import{c as er,R as st,I as it}from"./index-CycQg9ZZ.js";import{u as ct}from"./index-C3WaO5Hu.js";import{S as He}from"./separator-JzjotOJ8.js";import{L as dt,Z as lt}from"./LazyMap-CZPxinPF.js";import{C as rr}from"./credit-card-BDvSjF89.js";import{T as Ne}from"./truck-CjLjFMFv.js";import{C as pe}from"./circle-alert-BEtDJpwT.js";import{M as ut}from"./mail-BQFyE5e7.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=Tr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),ft=async()=>{const{data:r,error:o}=await O.from("restaurants").select("id").limit(1).single();if(o||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const t=r.id,{data:s,error:c}=await O.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",t).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${c.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},tr=()=>ie({queryKey:["mercadoPagoPublicKey"],queryFn:ft,staleTime:1/0}),pt=(r,o,t,s)=>{const l=(t-r)*(Math.PI/180),u=(s-o)*(Math.PI/180),a=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(u/2)*Math.sin(u/2);return 6371*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))},ht=async(r,o)=>{const t=r.replace(/\s+/g," ").trim(),s=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1&addressdetails=1`,c=new AbortController,l=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",s);const u=await fetch(s,{signal:c.signal,headers:{"User-Agent":"Pedido123-App/1.0 (https://juniorsampaiobr-code.github.io/pedido123new/)"}});if(!u.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",u.status),null;const a=await u.json();if(a&&Array.isArray(a)&&a.length>0){const b=a[0],S=parseFloat(b.lat),w=parseFloat(b.lon);if(Number.isFinite(S)&&Number.isFinite(w)){if(console.log("LOG: geocodeAddress - Geocodificação bem-sucedida. Coordenadas:",[S,w]),console.log("LOG: geocodeAddress - Detalhes do endereço retornado:",b.address),o){const N=b.address,E=G=>G?G.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim():"",_=E(o.neighborhood||""),C=E(N.suburb||N.neighbourhood||""),P=E(o.city||""),A=E(N.city||"");console.log("LOG: geocodeAddress - Validação de componentes:"),console.log("  Esperado Bairro:",_,"| Retornado:",C),console.log("  Esperado Cidade:",P,"| Retornado:",A);const z=!_||C.includes(_)||_.includes(C),oe=!P||A.includes(P)||P.includes(A);if(!z)return console.warn("LOG: geocodeAddress - Validação falhou: Bairro não corresponde."),h.error("O bairro informado não corresponde ao endereço encontrado. Por favor, verifique."),null;if(!oe)return console.warn("LOG: geocodeAddress - Validação falhou: Cidade não corresponde."),h.error("A cidade informada não corresponde ao endereço encontrado. Por favor, verifique."),null;console.log("LOG: geocodeAddress - Todos os componentes validados com sucesso.")}return{lat:S,lng:w}}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",t),h.error("Não foi possível encontrar o endereço. Verifique todos os campos e tente novamente."),null}catch(u){return u instanceof Error&&u.name==="AbortError"?(console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",t),h.error("A requisição para encontrar o endereço demorou muito. Tente novamente.")):(console.error("LOG: geocodeAddress - Erro durante a requisição:",u),h.error("Ocorreu um erro ao buscar o endereço. Tente novamente.")),null}finally{clearTimeout(l)}},xt=(r,o,t)=>{const s=pt(o[0],o[1],r[0],r[1]),c=t.find(l=>s<=l.max_distance_km);if(c){const l=c.delivery_fee||0,u=c.min_delivery_time_minutes||0,a=u+15;return{fee:parseFloat(l.toFixed(2)),minTime:u,maxTime:a}}return null};var Pe="Radio",[gt,nr]=Je(Pe),[yt,jt]=gt(Pe),or=m.forwardRef((r,o)=>{const{__scopeRadio:t,name:s,checked:c=!1,required:l,disabled:u,value:a="on",onCheck:b,form:S,...w}=r,[N,E]=m.useState(null),_=Se(o,A=>E(A)),C=m.useRef(!1),P=N?S||!!N.closest("form"):!0;return e.jsxs(yt,{scope:t,checked:c,disabled:u,children:[e.jsx(ge.button,{type:"button",role:"radio","aria-checked":c,"data-state":cr(c),"data-disabled":u?"":void 0,disabled:u,value:a,...w,ref:_,onClick:Ee(r.onClick,A=>{c||b==null||b(),P&&(C.current=A.isPropagationStopped(),C.current||A.stopPropagation())})}),P&&e.jsx(ir,{control:N,bubbles:!C.current,name:s,value:a,checked:c,required:l,disabled:u,form:S,style:{transform:"translateX(-100%)"}})]})});or.displayName=Pe;var ar="RadioIndicator",sr=m.forwardRef((r,o)=>{const{__scopeRadio:t,forceMount:s,...c}=r,l=jt(ar,t);return e.jsx(qr,{present:s||l.checked,children:e.jsx(ge.span,{"data-state":cr(l.checked),"data-disabled":l.disabled?"":void 0,...c,ref:o})})});sr.displayName=ar;var vt="RadioBubbleInput",ir=m.forwardRef(({__scopeRadio:r,control:o,checked:t,bubbles:s=!0,...c},l)=>{const u=m.useRef(null),a=Se(u,l),b=ct(t),S=Vr(o);return m.useEffect(()=>{const w=u.current;if(!w)return;const N=window.HTMLInputElement.prototype,_=Object.getOwnPropertyDescriptor(N,"checked").set;if(b!==t&&_){const C=new Event("click",{bubbles:s});_.call(w,t),w.dispatchEvent(C)}},[b,t,s]),e.jsx(ge.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...c,tabIndex:-1,ref:a,style:{...c.style,...S,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ir.displayName=vt;function cr(r){return r?"checked":"unchecked"}var wt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ye="RadioGroup",[_t,on]=Je(ye,[er,nr]),dr=er(),lr=nr(),[bt,Nt]=_t(ye),ur=m.forwardRef((r,o)=>{const{__scopeRadioGroup:t,name:s,defaultValue:c,value:l,required:u=!1,disabled:a=!1,orientation:b,dir:S,loop:w=!0,onValueChange:N,...E}=r,_=dr(t),C=$r(S),[P,A]=zr({prop:l,defaultProp:c??null,onChange:N,caller:ye});return e.jsx(bt,{scope:t,name:s,required:u,disabled:a,value:P,onValueChange:A,children:e.jsx(st,{asChild:!0,..._,orientation:b,dir:C,loop:w,children:e.jsx(ge.div,{role:"radiogroup","aria-required":u,"aria-orientation":b,"data-disabled":a?"":void 0,dir:C,...E,ref:o})})})});ur.displayName=ye;var mr="RadioGroupItem",fr=m.forwardRef((r,o)=>{const{__scopeRadioGroup:t,disabled:s,...c}=r,l=Nt(mr,t),u=l.disabled||s,a=dr(t),b=lr(t),S=m.useRef(null),w=Se(o,S),N=l.value===c.value,E=m.useRef(!1);return m.useEffect(()=>{const _=P=>{wt.includes(P.key)&&(E.current=!0)},C=()=>E.current=!1;return document.addEventListener("keydown",_),document.addEventListener("keyup",C),()=>{document.removeEventListener("keydown",_),document.removeEventListener("keyup",C)}},[]),e.jsx(it,{asChild:!0,...a,focusable:!u,active:N,children:e.jsx(or,{disabled:u,required:l.required,checked:N,...b,...c,name:l.name,ref:w,onCheck:()=>l.onValueChange(c.value),onKeyDown:Ee(_=>{_.key==="Enter"&&_.preventDefault()}),onFocus:Ee(c.onFocus,()=>{var _;E.current&&((_=S.current)==null||_.click())})})})});fr.displayName=mr;var Et="RadioGroupIndicator",pr=m.forwardRef((r,o)=>{const{__scopeRadioGroup:t,...s}=r,c=lr(t);return e.jsx(sr,{...c,...s,ref:o})});pr.displayName=Et;var hr=ur,xr=fr,Ct=pr;const Re=m.forwardRef(({className:r,...o},t)=>e.jsx(hr,{className:de("grid gap-2",r),...o,ref:t}));Re.displayName=hr.displayName;const xe=m.forwardRef(({className:r,...o},t)=>e.jsx(xr,{ref:t,className:de("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...o,children:e.jsx(Ct,{className:"flex items-center justify-center",children:e.jsx(mt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));xe.displayName=xr.displayName;var Ie={};Object.defineProperty(Ie,"__esModule",{value:!0});var gr=Ie.loadMercadoPago=void 0;const yr="https://sdk.mercadopago.com/js/v2",Rt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Ye="MercadoPago has already been initialized in your window, please remove the duplicate import",St="MercadoPago.js not available",Pt="Failed to load MercadoPago.js",It=()=>{for(var r=document.querySelectorAll(`script[src^="${yr}"`),o=0;o<r.length;o++){var t=r[o];if(Rt.test(t.src))return t}return null},Ot=()=>{const r=document.createElement("script");r.src=yr;const o=document.head||document.body;if(!o)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return o.appendChild(r),r};let he=null;const Mt=()=>(he!==null||(he=new Promise((r,o)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(Ye),r(window.MercadoPago);return}try{let t=It();t?console.warn(Ye):t||(t=Ot()),t.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):o(new Error(St))}),t.addEventListener("error",()=>{o(new Error(Pt))})}catch(t){o(t);return}})),he);gr=Ie.loadMercadoPago=Mt;var Lt=function(r,o,t,s){function c(l){return l instanceof t?l:new t(function(u){u(l)})}return new(t||(t=Promise))(function(l,u){function a(w){try{S(s.next(w))}catch(N){u(N)}}function b(w){try{S(s.throw(w))}catch(N){u(N)}}function S(w){w.done?l(w.value):c(w.value).then(a,b)}S((s=s.apply(r,o||[])).next())})};class ${static getInstance(){return Lt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield gr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}$.publicKey=null;$.options={};$.instanceMercadoPago=void 0;$.loadedInstanceMercadoPago=!1;function At(r,o){return Object.keys(r).length===Object.keys(o).length&&Object.keys(r).every(s=>Object.prototype.hasOwnProperty.call(o,s)&&r[s]===o[s])}const Ft=(r,o)=>{const t=Object.assign(Object.assign({},o),{frontEndStack:"react"}),s=!At($.options,t);(r!==$.publicKey||s)&&($.publicKey=r,$.options=t,$.instanceMercadoPago=void 0)},kt=({preferenceId:r,initPoint:o,onClose:t})=>{const{data:s,isLoading:c}=tr();return m.useEffect(()=>{if(s)try{Ft(s,{locale:"pt-BR"})}catch(l){console.error("Erro ao inicializar Mercado Pago:",l),h.error("Erro ao carregar o SDK do Mercado Pago."),t();return}o&&(console.log("Redirecionando para o Mercado Pago:",o),window.location.href=o)},[s,t,o]),c||!s?e.jsx(ze,{open:!0,onOpenChange:t,children:e.jsx(Be,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ce,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(ze,{open:!0,onOpenChange:t,children:e.jsxs(Be,{className:"sm:max-w-[425px]",children:[e.jsxs(Br,{children:[e.jsxs(Kr,{className:"flex items-center gap-2",children:[e.jsx(rr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Ur,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ce,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(W,{variant:"outline",onClick:t,children:"Cancelar e Voltar"})]})})},Dt=({latitude:r,longitude:o,address:t,className:s})=>{const c=m.useMemo(()=>[r,o],[r,o]),l=m.useMemo(()=>[r,o],[r,o]),u=m.useMemo(()=>`client-location-${r.toFixed(6)}-${o.toFixed(6)}`,[r,o]);return e.jsxs(K,{className:de("w-full",s),children:[e.jsxs(U,{children:[e.jsxs(Q,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t})]}),e.jsx(Z,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(dt,{center:l,markerPosition:c,onMarkerDragEnd:()=>{},zoom:16},u)})})]})},Gt=We({zip_code:D().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:D().min(1,"Rua é obrigatória."),number:D().min(1,"Número é obrigatório."),neighborhood:D().min(1,"Bairro é obrigatório."),city:D().min(1,"Cidade é obrigatória.")}),Tt=We({name:D().min(1,"Nome é obrigatório."),phone:D().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:D().email("Email inválido.").optional().or(Qr("")),cpf_cnpj:D().optional().default("").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Zr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:D().optional(),payment_method_id:D().min(1,"Selecione um método de pagamento."),change_for:D().optional()}),qt=async r=>{const{data:o,error:t}=await O.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!o)throw new Error("Restaurante não encontrado ou inativo.");return o},Vt=async r=>{const{data:o,error:t}=await O.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return o},$t=async r=>{const{data:o,error:t}=await O.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return o},zt=async r=>{const{data:o,error:t}=await O.from("customers").select("*").eq("user_id",r).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(t.message);return o||null},an=()=>{var De,Ge,Te,qe,Ve;const r=kr(),o=Dr(),[t]=Gr(),s=Fr(),{items:c,totalAmount:l,clearCart:u}=Xr(),{data:a,isLoading:b}=Hr(),{data:S}=tr(),[w,N]=m.useState(!1),[E,_]=m.useState(!1),[C,P]=m.useState(0),[A,z]=m.useState(null),[oe,G]=m.useState(!0),[X,je]=m.useState(null),[jr,ve]=m.useState(!1),[vr,wr]=m.useState(null),[Oe,_r]=m.useState(null),[T,H]=m.useState(!1),br=(De=o.state)==null?void 0:De.restaurantId,Nr=t.get("restaurantId"),B=br||Nr;m.useEffect(()=>{console.log("LOG: Checkout - User Status:",a?`Logged in as ${a.email}`:"Anonymous")},[a]);const{data:v,isLoading:Er,isError:Cr,error:Me,refetch:Rr}=ie({queryKey:["checkoutRestaurantData",B],queryFn:()=>qt(B),enabled:!!B,staleTime:1/0}),{data:le,isLoading:Sr}=ie({queryKey:["checkoutDeliveryZones",B],queryFn:()=>Vt(v.id),enabled:!!v,staleTime:1/0}),{data:ee,isLoading:Pr}=ie({queryKey:["checkoutPaymentMethods",B],queryFn:()=>$t(v.id),enabled:!!v,staleTime:1/0}),{data:g,isLoading:Le,refetch:Bt}=ie({queryKey:["checkoutCustomerData",a==null?void 0:a.id],queryFn:()=>zt(a.id),enabled:!!a,staleTime:0}),we=m.useMemo(()=>v!=null&&v.latitude&&(v!=null&&v.longitude)?[v.latitude,v.longitude]:null,[v]),_e=m.useCallback(async(n,i,f,y,j,p,M)=>{if(!v||!we||!v.delivery_enabled)return P(0),G(!0),z(null),{coords:null,fee:0,time:null,isValid:!0};const I=`${i}, ${f}, ${y}, ${n}`;let x=null;if(p&&M)x={lat:p,lng:M};else{_(!0);const k=h.loading("Calculando taxa de entrega...");x=await ht(I,{city:y,neighborhood:j}),_(!1),h.dismiss(k)}if(!x)return P(0),z(null),G(!1),h.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(je([x.lat,x.lng]),le&&le.length>0){const k=xt([x.lat,x.lng],we,le);return k?(P(k.fee),z([k.minTime,k.maxTime]),G(!0),{coords:x,fee:k.fee,time:[k.minTime,k.maxTime],isValid:!0}):(P(0),z(null),G(!1),h.error("Endereço fora da área de entrega."),{coords:x,fee:0,time:null,isValid:!1})}else return P(0),z(null),G(!0),{coords:x,fee:0,time:null,isValid:!0}},[v,we,le]),d=Ke({resolver:Xe(Tt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),R=Ke({resolver:Xe(Gt),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),q=d.watch("delivery_option"),Ir=d.watch("payment_method_id"),re=ee==null?void 0:ee.find(n=>n.id===Ir),ue=(Ge=re==null?void 0:re.name)==null?void 0:Ge.includes("online"),ae=(Te=re==null?void 0:re.name)==null?void 0:Te.includes("Dinheiro"),V=l+C,L=R.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{q==="pickup"?(P(0),G(!0),H(!0)):H(!1)},[q]),m.useEffect(()=>{if(g){let n="",i="",f="",y="",j="";if(g.address){const p=g.address.split(", ").map(M=>M.trim());p.length>=5?(n=p[0],i=p[1],f=p[2],y=p[3],j=p[4]):p.length>=4&&(n=p[0],f=p[1],y=p[2],j=p[3])}d.reset({...d.getValues(),name:g.name||"",phone:g.phone||"",email:g.email||"",cpf_cnpj:g.cpf_cnpj||"",change_for:""}),R.reset({zip_code:j,street:n,number:i,neighborhood:f,city:y}),g.address&&g.latitude&&g.longitude&&(je([g.latitude,g.longitude]),H(!0),_e(j,n,i,y,f,g.latitude,g.longitude))}else if(a&&!Le){const n=a.user_metadata;d.reset({...d.getValues(),name:n.full_name||"",phone:n.phone||"",email:a.email||"",cpf_cnpj:n.cpf_cnpj||"",change_for:""})}},[g,d,a,Le,R,_e]);const me=d.watch("change_for");m.useEffect(()=>{if(ae&&me&&me.trim()!==""){const n=me.replace(",","."),i=parseFloat(n);isNaN(i)?d.setError("change_for",{message:"O troco deve ser um número válido."}):i<V?d.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(V)}).`}):d.clearErrors("change_for")}else d.clearErrors("change_for")},[ae,me,V,d]);const fe=be({mutationFn:async n=>{var p;const f=(p=(await O.auth.getUser()).data.user)==null?void 0:p.id;if(!(g!=null&&g.id)&&!f)throw new Error("ID do cliente ou usuário não encontrado.");const y=`${n.street}, ${n.number}, ${n.neighborhood}, ${n.city}, ${n.zip_code}`,j={user_id:(a==null?void 0:a.id)||null,name:d.getValues("name"),phone:d.getValues("phone"),email:d.getValues("email")||null,cpf_cnpj:d.getValues("cpf_cnpj")||null,address:y,latitude:n.lat,longitude:n.lng};if(g!=null&&g.id){const{data:M,error:I}=await O.from("customers").update(j).eq("id",g.id).select().single();if(I)throw I;return M}else if(f){const{data:M,error:I}=await O.from("customers").insert(j).select().single();if(I)throw I;return M}else return{id:"anonymous",user_id:null,name:j.name,phone:j.phone,email:j.email,address:y,created_at:"",updated_at:"",latitude:n.lat,longitude:n.lng,cpf_cnpj:j.cpf_cnpj}},onSuccess:(n,i)=>{n.id!=="anonymous"&&s.invalidateQueries({queryKey:["checkoutCustomerData"]}),P(i.fee),z(i.time),G(i.isValid),H(!0),je([i.lat,i.lng]),h.success("Endereço salvo e taxa de entrega calculada!")},onError:n=>{h.error(`Erro ao salvar endereço: ${n.message}`),H(!1)}}),Or=async()=>{if(q==="pickup")return;if(!await R.trigger()){h.error("Preencha todos os campos obrigatórios do endereço.");return}const i=R.getValues(),f=await _e(i.zip_code,i.street,i.number,i.city,i.neighborhood);if(!f.isValid){H(!1);return}if(!f.coords){h.error("Não foi possível obter as coordenadas para salvar o endereço."),H(!1);return}fe.mutate({...i,lat:f.coords.lat,lng:f.coords.lng,fee:f.fee,time:f.time,isValid:f.isValid})},Ae=be({mutationFn:async n=>{var p,M;(p=(await O.auth.getUser()).data.user)==null||p.id;const f=n.phone.replace(/\D/g,""),y=((M=n.cpf_cnpj)==null?void 0:M.replace(/\D/g,""))||null,j={user_id:(a==null?void 0:a.id)||null,name:n.name,phone:f,email:n.email||null,cpf_cnpj:y,address:q==="delivery"?`${L[1]}, ${L[2]}, ${L[4]}, ${L[3]}, ${L[0]}`:null,latitude:X?X[0]:null,longitude:X?X[1]:null};if(a)if(g){const{data:I,error:x}=await O.from("customers").update(j).eq("id",g.id).select().single();if(x)throw x;return I}else{const{data:I,error:x}=await O.from("customers").insert(j).select().single();if(x)throw x;return I}else{const{data:I,error:x}=await O.from("customers").insert(j).select().single();if(x)throw x;return I}},onSuccess:()=>{s.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:n=>{h.error(`Erro ao salvar dados do cliente: ${n.message}`)}}),Fe=be({mutationFn:async({customerId:n,data:i})=>{if(!v)throw new Error("Dados do restaurante não disponíveis.");let f=null;if(ae&&i.change_for&&i.change_for.trim()!==""){const x=i.change_for.replace(",","."),k=parseFloat(x);!isNaN(k)&&k>V&&(f=k)}const y={restaurant_id:v.id,customer_id:n,status:ue?"pending_payment":"pending",total_amount:V,delivery_fee:C,delivery_address:q==="delivery"?`${L[1]}, ${L[2]}, ${L[4]}, ${L[3]}, ${L[0]}`:null,notes:i.notes,payment_method_id:i.payment_method_id,change_for:f},{data:j,error:p}=await O.from("orders").insert(y).select("id").single();if(p)throw p;const M=c.map(x=>({order_id:j.id,product_id:x.product.id,quantity:x.quantity,unit_price:x.product.price,subtotal:x.subtotal,notes:x.notes})),{error:I}=await O.from("order_items").insert(M);if(I)throw I;return j.id},onSuccess:n=>{s.invalidateQueries({queryKey:["orders"]})},onError:n=>{h.error(`Erro ao criar pedido: ${n.message}`)}}),Mr=async n=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",ue),console.log("LOG: deliveryOption:",q),console.log("LOG: isAddressSaved:",T),console.log("LOG: change_for data:",n.change_for),ae&&n.change_for&&n.change_for.trim()!==""){const y=n.change_for.replace(",","."),j=parseFloat(y);if(isNaN(j)){h.error("O troco deve ser um número válido.");return}if(j<V){h.error(`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(V)}).`);return}}if(c.length===0){h.error("Seu carrinho está vazio."),r("/menu");return}if(q==="delivery"){if(!T){h.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!oe){h.error("O endereço de entrega está fora da área de cobertura.");return}}let i;try{console.log("LOG: Criando/Atualizando cliente..."),i=(await Ae.mutateAsync(n)).id,console.log("LOG: Cliente ID:",i)}catch(y){h.error(`Falha ao salvar cliente: ${y.message}`);return}let f;try{console.log("LOG: Criando pedido..."),f=await Fe.mutateAsync({customerId:i,data:n}),console.log("LOG: Pedido ID:",f)}catch(y){h.error(`Falha ao criar pedido: ${y.message}`);return}ue?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Lr(f,n)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),u(),r(`/order-success/${f}`,{replace:!0}))},Lr=async(n,i)=>{if(!v)return;const f=window.location.origin+window.location.pathname,y=c.map(p=>({name:p.product.name,price:p.product.price,quantity:p.quantity})),j=h.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:p,error:M}=await O.functions.invoke("create-payment-preference",{body:{orderId:n,items:y,totalAmount:V,restaurantName:v.name,clientUrl:f,customerEmail:i.email||(a==null?void 0:a.email)||"cliente@anonimo.com",customerCpfCnpj:i.cpf_cnpj}});if(M)throw M;const{init_point:I}=p;console.log("LOG: Preferência MP criada. init_point:",I),wr(n),_r(I),ve(!0),h.dismiss(j)}catch(p){console.error("Erro ao criar preferência MP:",p),h.dismiss(j),h.error(`Erro no pagamento online: ${p.message}`),ve(!1)}},Ar=async()=>{await O.auth.signOut(),h.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!B)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(Y,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx(te,{children:"Erro de Rastreamento"}),e.jsx(ne,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx($e,{to:"/",children:e.jsx(W,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(c.length===0)return m.useEffect(()=>{r(`/menu/${B}`)},[r,B]),e.jsx(Qe,{});if(Er||Sr||Pr||b)return e.jsx(Qe,{});if(Cr||!v)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(Y,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx(te,{children:"Erro Crítico"}),e.jsx(ne,{children:Me instanceof Error?Me.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(W,{onClick:()=>Rr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Yr,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const ke=Ae.isPending||Fe.isPending||fe.isPending||E||q==="delivery"&&!T;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Jr,{isOpen:w,onClose:()=>N(!1),customer:g}),jr&&Oe&&e.jsx(kt,{preferenceId:vr,initPoint:Oe,onClose:()=>ve(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:v.name})]}),a&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{variant:"outline",size:"icon",onClick:()=>N(!0),"aria-label":"Meu Perfil",children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsxs(W,{variant:"outline",size:"sm",onClick:Ar,children:[e.jsx(Wr,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ze,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(Z,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:a?`Logado como ${a.email}. ${g?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:d.handleSubmit(Mr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(J,{id:"name",...d.register("name")}),d.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"phone",children:"Telefone *"}),e.jsx(se,{name:"phone",control:d.control,render:({field:n})=>e.jsx(et,{id:"phone",...n})}),d.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(J,{id:"email",type:"email",...d.register("email")}),d.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(se,{name:"cpf_cnpj",control:d.control,render:({field:n})=>e.jsx(rt,{id:"cpf_cnpj",...n})}),d.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(Z,{children:e.jsx(se,{name:"delivery_option",control:d.control,render:({field:n})=>e.jsxs(Re,{onValueChange:n.onChange,value:n.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(F,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(xe,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(Ne,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(F,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(xe,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ce,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),q==="delivery"&&e.jsxs(K,{className:de(!T&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(U,{children:[e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",T&&e.jsx(tt,{className:"h-5 w-5 text-green-500 ml-2"}),!T&&e.jsx(pe,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(Z,{className:"space-y-4",children:[!v.delivery_enabled&&e.jsxs(Y,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(te,{children:"Entrega Desativada"}),e.jsx(ne,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),Or()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(F,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(se,{name:"zip_code",control:R.control,render:({field:n})=>e.jsx(lt,{id:"zip_code",...n})}),R.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(F,{htmlFor:"street",children:"Rua *"}),e.jsx(J,{id:"street",...R.register("street")}),R.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"number",children:"Número *"}),e.jsx(J,{id:"number",...R.register("number")}),R.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(F,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(J,{id:"neighborhood",...R.register("neighborhood")}),R.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"city",children:"Cidade *"}),e.jsx(J,{id:"city",...R.register("city")}),R.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:R.formState.errors.city.message})]}),e.jsxs(W,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:fe.isPending||E||!v.delivery_enabled,children:[fe.isPending||E?e.jsx(ce,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(nt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),E&&e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 animate-spin"}),e.jsx(te,{children:"Calculando Taxa de Entrega..."})]}),!oe&&T&&!E&&e.jsxs(Y,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(te,{children:"Fora da Área de Entrega"}),e.jsx(ne,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),A&&oe&&T&&!E&&e.jsxs(Y,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(te,{children:"Entrega Disponível"}),e.jsxs(ne,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C),". Tempo estimado: ",A[0]," - ",A[1]," minutos."]})]}),T&&X&&e.jsx("div",{className:"mt-6",children:e.jsx(Dt,{latitude:X[0],longitude:X[1],address:`${L[1]}, ${L[2]} - ${L[4]}, ${L[3]}, ${L[0]}`})})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(rr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(Z,{children:[e.jsx(se,{name:"payment_method_id",control:d.control,render:({field:n})=>e.jsx(Re,{onValueChange:n.onChange,value:n.value,className:"space-y-3",children:ee==null?void 0:ee.map(i=>{var y;const f=((y=i.name)==null?void 0:y.includes("online"))&&!S;return e.jsx(F,{htmlFor:i.id,className:de("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",f&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(xe,{value:i.id,id:i.id,disabled:f}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.description}),f&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},i.id)})})}),d.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:d.formState.errors.payment_method_id.message})]})]}),ae&&e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(ot,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(J,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(V),...d.register("change_for")}),((qe=d.formState.errors.change_for)==null?void 0:qe.message)&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message}),((Ve=d.formState.errors.change_for)==null?void 0:Ve.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message})]})})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(ut,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(at,{id:"notes",...d.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(K,{className:"shadow-lg",children:[e.jsx(U,{children:e.jsx(Q,{className:"text-2xl",children:"Resumo"})}),e.jsxs(Z,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[n.quantity,"x ",n.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.subtotal)})]},n.product.id))}),e.jsx(He,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C)})]})]}),e.jsx(He,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(V)})]}),e.jsx(W,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:ke,children:ke?e.jsx(ce,{className:"h-5 w-5 animate-spin mr-2"}):ue?"Pagar e Finalizar":"Confirmar Pedido"}),q==="delivery"&&!T&&e.jsxs(Y,{variant:"destructive",className:"mt-3",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(ne,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx($e,{to:`/menu/${v.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{an as default};
