import{j as e,u as Ur,b as ae,c as Kr}from"./tanstack-QxCZ3Wpf.js";import{r as i,u as Zr,i as Jr,R as Hr,L as He}from"./vendor-CIxFcw7z.js";import{o as Qr,s as T,l as Wr,e as Xr,p as Pe,c as Qe,n as Yr,Z as z,u as es,t as rs}from"./types-C33Up_9v.js";import{s as k}from"./client-BskZ_u5h.js";import{c as rr,f as ke,g as ye,P as Z,i as ge,h as sr,l as ss,m as tr,b as Le,n as ts,k as os,a as or,v as We,L as Xe}from"./index-BMINKugR.js";import{B as Q}from"./button-U4wKQAEJ.js";import{C as ie,b as le,c as ce,a as de}from"./card-ChYInxld.js";import{I as U}from"./label-DUOZaaI-.js";import{c as ar,R as as,I as ns,a as is,C as ls}from"./index-DqH2XyJB.js";import{u as cs}from"./index-BvB5LvD-.js";import{u as ds}from"./index-ClxNZ_uN.js";import{S as ue}from"./separator-C3dm_VkJ.js";import{T as us}from"./textarea-B_0v2GFE.js";import{A as W,a as X,b as Y}from"./alert-lwRylplB.js";import{F as ms,b as I,c as C,a as R,e as V,d as ne}from"./form-idu6vROI.js";import{P as ps}from"./PhoneInput-G6p71oos.js";import{Z as hs,M as fs}from"./MapLocationSection-DX9yapue.js";import{C as xs,a as gs}from"./CustomerProfileModal-C0m7lIEM.js";import{S as ys}from"./shopping-cart-g_hpjqDb.js";import{T as Se}from"./terminal-D3hAdXL-.js";import{A as js}from"./arrow-left-BAKJUBzS.js";import{U as bs}from"./user-Lav-izIT.js";import{T as Ye}from"./truck-BMF4HRRJ.js";import{S as nr}from"./store-B5i0MBpL.js";import{M as er}from"./map-pin-DmCtVCDS.js";import{S as vs}from"./save-Cl_n01a1.js";import{P as Ns}from"./package-Bj-HFETK.js";import{C as Cs}from"./credit-card-i9qQL23p.js";import{S as _s}from"./smartphone-MW09qmQu.js";import{D as ws}from"./dollar-sign-CFuwcJWQ.js";import"./supabase-DGFirUEE.js";import"./dialog-DaIuzMSF.js";import"./index-DqLsah2f.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=rr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=rr("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var Oe="Radio",[Ps,ir]=ke(Oe),[Ss,Is]=Ps(Oe),lr=i.forwardRef((s,a)=>{const{__scopeRadio:o,name:m,checked:n=!1,required:c,disabled:l,value:p="on",onCheck:f,form:x,...N}=s,[y,j]=i.useState(null),b=ye(a,F=>j(F)),g=i.useRef(!1),E=y?x||!!y.closest("form"):!0;return e.jsxs(Ss,{scope:o,checked:n,disabled:l,children:[e.jsx(Z.button,{type:"button",role:"radio","aria-checked":n,"data-state":mr(n),"data-disabled":l?"":void 0,disabled:l,value:p,...N,ref:b,onClick:ge(s.onClick,F=>{n||f==null||f(),E&&(g.current=F.isPropagationStopped(),g.current||F.stopPropagation())})}),E&&e.jsx(ur,{control:y,bubbles:!g.current,name:m,value:p,checked:n,required:c,disabled:l,form:x,style:{transform:"translateX(-100%)"}})]})});lr.displayName=Oe;var cr="RadioIndicator",dr=i.forwardRef((s,a)=>{const{__scopeRadio:o,forceMount:m,...n}=s,c=Is(cr,o);return e.jsx(sr,{present:m||c.checked,children:e.jsx(Z.span,{"data-state":mr(c.checked),"data-disabled":c.disabled?"":void 0,...n,ref:a})})});dr.displayName=cr;var Vs="RadioBubbleInput",ur=i.forwardRef(({__scopeRadio:s,control:a,checked:o,bubbles:m=!0,...n},c)=>{const l=i.useRef(null),p=ye(l,c),f=ds(o),x=ss(a);return i.useEffect(()=>{const N=l.current;if(!N)return;const y=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(y,"checked").set;if(f!==o&&b){const g=new Event("click",{bubbles:m});b.call(N,o),N.dispatchEvent(g)}},[f,o,m]),e.jsx(Z.input,{type:"radio","aria-hidden":!0,defaultChecked:o,...n,tabIndex:-1,ref:p,style:{...n.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ur.displayName=Vs;function mr(s){return s?"checked":"unchecked"}var Fs=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],je="RadioGroup",[ks,At]=ke(je,[ar,ir]),pr=ar(),hr=ir(),[Ls,Os]=ks(je),fr=i.forwardRef((s,a)=>{const{__scopeRadioGroup:o,name:m,defaultValue:n,value:c,required:l=!1,disabled:p=!1,orientation:f,dir:x,loop:N=!0,onValueChange:y,...j}=s,b=pr(o),g=cs(x),[E,F]=tr({prop:c,defaultProp:n??null,onChange:y,caller:je});return e.jsx(Ls,{scope:o,name:m,required:l,disabled:p,value:E,onValueChange:F,children:e.jsx(as,{asChild:!0,...b,orientation:f,dir:g,loop:N,children:e.jsx(Z.div,{role:"radiogroup","aria-required":l,"aria-orientation":f,"data-disabled":p?"":void 0,dir:g,...j,ref:a})})})});fr.displayName=je;var xr="RadioGroupItem",gr=i.forwardRef((s,a)=>{const{__scopeRadioGroup:o,disabled:m,...n}=s,c=Os(xr,o),l=c.disabled||m,p=pr(o),f=hr(o),x=i.useRef(null),N=ye(a,x),y=c.value===n.value,j=i.useRef(!1);return i.useEffect(()=>{const b=E=>{Fs.includes(E.key)&&(j.current=!0)},g=()=>j.current=!1;return document.addEventListener("keydown",b),document.addEventListener("keyup",g),()=>{document.removeEventListener("keydown",b),document.removeEventListener("keyup",g)}},[]),e.jsx(ns,{asChild:!0,...p,focusable:!l,active:y,children:e.jsx(lr,{disabled:l,required:c.required,checked:y,...f,...n,name:c.name,ref:N,onCheck:()=>c.onValueChange(n.value),onKeyDown:ge(b=>{b.key==="Enter"&&b.preventDefault()}),onFocus:ge(n.onFocus,()=>{var b;j.current&&((b=x.current)==null||b.click())})})})});gr.displayName=xr;var Ts="RadioGroupIndicator",yr=i.forwardRef((s,a)=>{const{__scopeRadioGroup:o,...m}=s,n=hr(o);return e.jsx(dr,{...n,...m,ref:a})});yr.displayName=Ts;var jr=fr,br=gr,As=yr;const Ie=i.forwardRef(({className:s,...a},o)=>e.jsx(jr,{className:Le("grid gap-2",s),...a,ref:o}));Ie.displayName=jr.displayName;const xe=i.forwardRef(({className:s,...a},o)=>e.jsx(br,{ref:o,className:Le("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...a,children:e.jsx(As,{className:"flex items-center justify-center",children:e.jsx(Rs,{className:"h-2.5 w-2.5 fill-current text-current"})})}));xe.displayName=br.displayName;const Ds=(s,a,o,m)=>{const c=(o-s)*(Math.PI/180),l=(m-a)*(Math.PI/180),p=Math.sin(c/2)*Math.sin(c/2)+Math.cos(s*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))},Ms=async s=>{const a=s.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,m=new AbortController,n=setTimeout(()=>m.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const c=await fetch(o,{signal:m.signal});if(!c.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",c.status),null;const l=await c.json();if(l&&Array.isArray(l)&&l.length>0){const p=l[0],f=parseFloat(p.lat),x=parseFloat(p.lon);if(Number.isFinite(f)&&Number.isFinite(x))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[f,x]),{lat:f,lng:x}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(c){return c instanceof Error&&c.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",c),null}finally{clearTimeout(n)}},qs=(s,a,o)=>{const m=Ds(a[0],a[1],s[0],s[1]),n=o.find(c=>m<=c.max_distance_km);if(n){const c=n.delivery_fee||0,l=n.min_delivery_time_minutes||0,p=l+15;return{fee:parseFloat(c.toFixed(2)),minTime:l,maxTime:p}}return null};var be="Collapsible",[Gs,Dt]=ke(be),[$s,Te]=Gs(be),vr=i.forwardRef((s,a)=>{const{__scopeCollapsible:o,open:m,defaultOpen:n,disabled:c,onOpenChange:l,...p}=s,[f,x]=tr({prop:m,defaultProp:n??!1,onChange:l,caller:be});return e.jsx($s,{scope:o,disabled:c,contentId:ts(),open:f,onOpenToggle:i.useCallback(()=>x(N=>!N),[x]),children:e.jsx(Z.div,{"data-state":De(f),"data-disabled":c?"":void 0,...p,ref:a})})});vr.displayName=be;var Nr="CollapsibleTrigger",Cr=i.forwardRef((s,a)=>{const{__scopeCollapsible:o,...m}=s,n=Te(Nr,o);return e.jsx(Z.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":De(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...m,ref:a,onClick:ge(s.onClick,n.onOpenToggle)})});Cr.displayName=Nr;var Ae="CollapsibleContent",_r=i.forwardRef((s,a)=>{const{forceMount:o,...m}=s,n=Te(Ae,s.__scopeCollapsible);return e.jsx(sr,{present:o||n.open,children:({present:c})=>e.jsx(Bs,{...m,ref:a,present:c})})});_r.displayName=Ae;var Bs=i.forwardRef((s,a)=>{const{__scopeCollapsible:o,present:m,children:n,...c}=s,l=Te(Ae,o),[p,f]=i.useState(m),x=i.useRef(null),N=ye(a,x),y=i.useRef(0),j=y.current,b=i.useRef(0),g=b.current,E=l.open||p,F=i.useRef(E),L=i.useRef(void 0);return i.useEffect(()=>{const w=requestAnimationFrame(()=>F.current=!1);return()=>cancelAnimationFrame(w)},[]),os(()=>{const w=x.current;if(w){L.current=L.current||{transitionDuration:w.style.transitionDuration,animationName:w.style.animationName},w.style.transitionDuration="0s",w.style.animationName="none";const ee=w.getBoundingClientRect();y.current=ee.height,b.current=ee.width,F.current||(w.style.transitionDuration=L.current.transitionDuration,w.style.animationName=L.current.animationName),f(m)}},[l.open,m]),e.jsx(Z.div,{"data-state":De(l.open),"data-disabled":l.disabled?"":void 0,id:l.contentId,hidden:!E,...c,ref:N,style:{"--radix-collapsible-content-height":j?`${j}px`:void 0,"--radix-collapsible-content-width":g?`${g}px`:void 0,...s.style},children:E&&n})});function De(s){return s?"open":"closed"}var zs=vr;const Us=zs,Ks=Cr,Zs=_r,Js=()=>{const{items:s,subtotal:a,deliveryFee:o,total:m,totalItems:n}=or(),[c,l]=i.useState(!1);return n===0?null:e.jsxs(Us,{open:c,onOpenChange:l,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Ks,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ys,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m)}),c?e.jsx(is,{className:"h-5 w-5"}):e.jsx(ls,{className:"h-5 w-5"})]})]})}),e.jsxs(Zs,{className:"p-4 pt-0",children:[e.jsx(ue,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:s.map(p=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[p.quantity,"x ",p.name,p.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",p.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(p.price*p.quantity)})]},p.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m)})]})]})]})]})},Ve=s=>s.replace(/\D/g,""),wr=s=>s.replace(/\D/g,""),Fe=s=>s.replace(/\D/g,""),Hs=Qr({name:T().min(1,"Nome é obrigatório."),phone:T().min(1,"Telefone é obrigatório.").transform(Ve).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:T().email("Email inválido.").optional().or(Wr("")),delivery_option:Xr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:T().optional().default(""),number:T().optional().default(""),complement:T().optional().default(""),neighborhood:T().optional().default(""),city:T().optional().default(""),zip_code:T().optional().default("").transform(wr).refine(s=>s.length===8||s.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Pe(s=>typeof s=="string"?parseFloat(s):s,Qe.number().optional().nullable()),longitude:Pe(s=>typeof s=="string"?parseFloat(s):s,Qe.number().optional().nullable()),payment_method_id:T().min(1,"Selecione uma forma de pagamento."),notes:T().optional(),cpf_cnpj:T().optional().default("").transform(Fe).refine(s=>s.length===0||s.length===11||s.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Pe(s=>{if(s==null||s==="")return null;const a=String(s).replace(",","."),o=parseFloat(a);return isNaN(o)?a:o},Yr({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((s,a)=>{if(s.delivery_option==="delivery"?(s.street.trim()===""&&a.addIssue({code:z.custom,message:"Rua é obrigatória.",path:["street"]}),s.number.trim()===""&&a.addIssue({code:z.custom,message:"Número é obrigatório.",path:["number"]}),s.neighborhood.trim()===""&&a.addIssue({code:z.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),s.city.trim()===""&&a.addIssue({code:z.custom,message:"Cidade é obrigatória.",path:["city"]}),s.zip_code.length!==8&&a.addIssue({code:z.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(s.latitude===null||s.longitude===null)&&a.addIssue({code:z.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})):s.latitude!==null||s.longitude,s.payment_method_id==="Dinheiro"&&s.change_for!==null&&s.change_for!==void 0&&s.change_for<=0&&a.addIssue({code:z.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),s.payment_method_id==="Pagamento online: Pix/Cartão"){const n=Fe(s.cpf_cnpj||"");n.length!==11&&n.length!==14&&a.addIssue({code:z.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Qs=()=>{const s=window.location.origin,o=window.location.pathname.split("/")[1];return o?`${s}/${o}`:s},Ws=async()=>{const{data:s,error:a}=await k.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(a)throw new Error(`Erro ao buscar restaurante: ${a.message}`);if(!s)throw new Error("Nenhum restaurante ativo encontrado.");return s},Xs=async s=>{const{data:a,error:o}=await k.from("restaurants").select("delivery_enabled").eq("id",s).single();if(o)throw new Error(`Erro ao buscar status de entrega: ${o.message}`);return a.delivery_enabled??!0},Ys=async s=>{const{data:a,error:o}=await k.from("payment_methods").select("*").eq("restaurant_id",s).eq("is_active",!0).order("name",{ascending:!0});if(o)throw new Error(`Erro ao buscar métodos de pagamento: ${o.message}`);return a},et=async s=>{const{data:a,error:o}=await k.from("delivery_zones").select("*").eq("restaurant_id",s).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(o)throw new Error(`Erro ao buscar zonas de entrega: ${o.message}`);return a},rt=async()=>{const{data:{user:s}}=await k.auth.getUser();if(!s)return null;const{data:a,error:o}=await k.from("customers").select("*").eq("user_id",s.id).limit(1).single();if(o&&o.code!=="PGRST116")throw new Error(`Erro ao buscar dados do cliente: ${o.message}`);if(a)return a;const m=s.user_metadata;return{id:s.id,user_id:s.id,name:m.full_name||"",phone:m.phone||"",email:s.email||"",address:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),latitude:null,longitude:null,cpf_cnpj:null}},st=s=>{switch(s){case"DollarSign":return ws;case"Smartphone":return _s;case"CreditCard":return Cs;case"Package":return Ns;default:return nr}},tt=({subtotal:s,deliveryFee:a,total:o,items:m})=>e.jsxs(ie,{className:"sticky top-4",children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(de,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]})]})]}),Mt=()=>{Qs();const s=Zr();Ur();const a=or(),{items:o,subtotal:m,deliveryFee:n,total:c,setDeliveryFee:l,clearCart:p}=a,[f]=Jr(),[x,N]=i.useState(!1),[y,j]=i.useState(null),[b,g]=i.useState(null),[E,F]=i.useState(null),L=Hr.useRef(!1),[w,ee]=i.useState(!1),[Rr,Me]=i.useState(!1),re=f.get("status"),ve=f.get("external_reference"),qe=f.has("collection_id")||f.has("external_reference");i.useEffect(()=>{if(ve)if(re==="approved"||re==="failure"||re==="pending"){s(`/order-success/${ve}?status=${re}`,{replace:!0});return}else qe&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),ee(!1));else ee(!1)},[ve,re,qe,s]);const{data:u,isLoading:Er,isError:Pr,error:Sr}=ae({queryKey:["checkoutRestaurantData"],queryFn:Ws}),{data:q,isLoading:Ne}=ae({queryKey:["deliveryStatus",u==null?void 0:u.id],queryFn:()=>Xs(u.id),enabled:!!(u!=null&&u.id)}),{data:J=[],isLoading:Ir}=ae({queryKey:["checkoutPaymentMethods",u==null?void 0:u.id],queryFn:()=>Ys(u.id),enabled:!!(u!=null&&u.id)}),{data:Ge=[],isLoading:Vr}=ae({queryKey:["checkoutDeliveryZones",u==null?void 0:u.id],queryFn:()=>et(u.id),enabled:!!(u!=null&&u.id)}),{data:G,isLoading:Fr}=ae({queryKey:["checkoutCustomerData"],queryFn:rt,staleTime:0}),kr=Er||Ne||Ir||Vr||Fr,Lr=Pr,$e=Sr,t=es({resolver:rs(Hs),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"});i.useEffect(()=>{if(G){const r=Ve(G.phone||""),d=localStorage.getItem("checkoutFormData");let h={};if(d)try{h=JSON.parse(d)}catch(v){console.error("Failed to parse local storage data",v)}t.reset({...t.getValues(),...h,name:G.name||"",phone:r,email:G.email||"",cpf_cnpj:G.cpf_cnpj||""})}},[G,t]);const M=t.watch("delivery_option"),Ce=t.watch("payment_method_id"),H=J.find(r=>r.id===Ce),me=(H==null?void 0:H.name)==="Pagamento online: Pix/Cartão",pe=(H==null?void 0:H.name)==="Dinheiro",P=t.watch("latitude"),S=t.watch("longitude");t.watch(["street","number","neighborhood","city","zip_code"]);const $=M==="delivery",Or=i.useMemo(()=>JSON.stringify({deliveryOption:M,deliveryEnabled:q,lat:P,lng:S}),[M,q,P,S]),Tr=i.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:u!=null&&u.latitude&&(u!=null&&u.longitude)?[u.latitude,u.longitude]:[-23.55052,-46.633308],[P,S,u]),Ar=i.useMemo(()=>P===null||S===null?`map-${M}-null`:`map-${M}-${P.toFixed(6)}-${S.toFixed(6)}`,[$,M,P,S]),_e=i.useCallback(r=>{const d=r.road||r.logradouro||"",h=r.house_number||"",v=r.suburb||r.bairro||"",_=r.city||r.localidade||"",B=r.postcode||r.cep||"";t.setValue("street",d,{shouldValidate:!0}),t.setValue("number",h||"",{shouldValidate:!0}),t.setValue("complement",r.suburb||"",{shouldValidate:!0}),t.setValue("neighborhood",v,{shouldValidate:!0}),t.setValue("city",_,{shouldValidate:!0}),t.setValue("zip_code",B,{shouldValidate:!0})},[t]),Dr=i.useCallback(async(r,d)=>{t.setValue("latitude",r,{shouldValidate:!0}),t.setValue("longitude",d,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${d}&addressdetails=1`,v=await fetch(h);if(v.ok){const _=await v.json();_.address&&_e(_.address)}},[t,_e]),Mr=i.useCallback(()=>{t.setValue("street","",{shouldValidate:!0}),t.setValue("number","",{shouldValidate:!0}),t.setValue("complement","",{shouldValidate:!0}),t.setValue("neighborhood","",{shouldValidate:!0}),t.setValue("city","",{shouldValidate:!0}),t.setValue("zip_code","",{shouldValidate:!0}),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),l(0),j(null),g(null),localStorage.removeItem("checkoutFormData")},[t,l]),we=i.useCallback(r=>{try{const d={name:r.name,phone:r.phone,email:r.email,delivery_option:r.delivery_option,street:r.street,number:r.number,complement:r.complement,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code,latitude:r.latitude,longitude:r.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(d))}catch(d){console.error("Failed to save form data to local storage",d)}},[]),Be=i.useCallback(()=>{try{const r=localStorage.getItem("checkoutFormData");if(r){const d=JSON.parse(r);t.reset({...t.getValues(),...d,delivery_option:d.delivery_option||"delivery"})}}catch(r){console.error("Failed to load form data from local storage",r)}},[t]);i.useEffect(()=>{Be()},[Be]),i.useEffect(()=>{const r=t.watch(d=>{we(d)});return()=>r.unsubscribe()},[t,we]);const qr=()=>{L.current||(F(null),L.current=!0,Promise.resolve().then(async()=>{try{const r=t.getValues(),[d,h,v,_,B]=[r.street,r.number,r.neighborhood,r.city,r.zip_code],te=wr(B);if(!(d&&h&&v&&_&&te.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),t.trigger(["street","number","neighborhood","city","zip_code"]),L.current=!1;return}console.log("LOG: Iniciando geocodificação para:",`${d}, ${h}, ${v}, ${_}, ${B}`);const fe=`${d}, ${h}, ${v}, ${_}, ${B}`,K=await Ms(fe);K?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",K),t.setValue("latitude",K.lat,{shouldValidate:!0}),t.setValue("longitude",K.lng,{shouldValidate:!0}),we(t.getValues())):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),setTimeout(()=>{F("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0})},100))}catch(r){console.error("LOG: Erro capturado durante a geocodificação:",r),setTimeout(()=>{F("Erro ao buscar coordenadas. Verifique sua conexão ou tente novamente."),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0})},100)}finally{L.current=!1}}).catch(r=>{console.error("LOG: Erro nao capturado:",r),L.current=!1}))};i.useEffect(()=>{pe||t.setValue("change_for",null,{shouldValidate:!0})},[pe,t]),i.useEffect(()=>{M==="pickup"&&(l(0),j(null),g(null),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}))},[M,$,t,l,P,S]),i.useEffect(()=>{J.length>0&&!Ce&&t.setValue("payment_method_id",J[0].id)},[J,Ce,t]),i.useEffect(()=>{me?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},[me,t]),i.useEffect(()=>{const r=async()=>{if(M==="pickup"||!(u!=null&&u.latitude)||!(u!=null&&u.longitude)){l(0),j(null),g(null);return}if(Ne)return;if(q===!1){l(0),j(null),g(null),N(!1);return}N(!0),j(null);let h=null;if(P&&S)h=[P,S];else{l(0),g(null),N(!1);return}if(h){const v=[u.latitude,u.longitude],_=qs(h,v,Ge);_?(l(_.fee),j(null),g({minTime:_.minTime,maxTime:_.maxTime})):(l(0),j("Seu endereço está fora da nossa área de entrega."),g(null))}N(!1)},d=setTimeout(()=>{r()},500);return()=>clearTimeout(d)},[Or,u,Ge,t,l,$,P,S,q,Ne]);const se=Kr({mutationFn:async r=>{if(!u)throw new Error("Dados do restaurante indisponíveis.");if(r.delivery_option==="delivery"&&y)throw new Error(y);const d=[r.street,r.number,r.complement?`(${r.complement})`:null,r.neighborhood,r.city,r.zip_code].filter(Boolean).join(", "),h=r.delivery_option==="delivery"?d:"Retirada no Local";let v;const _=Ve(r.phone),B=Fe(r.cpf_cnpj||""),{data:{user:te}}=await k.auth.getUser(),he=(te==null?void 0:te.id)||null;if(!he)throw new Error("Autenticação necessária. Por favor, faça login para finalizar o pedido.");const{data:fe}=await k.from("customers").select("id, user_id, name, cpf_cnpj").eq("user_id",he).limit(1).single();if(fe){v=fe.id;const O={name:r.name,phone:_,email:r.email||null,cpf_cnpj:B||null},{error:D}=await k.from("customers").update(O).eq("id",v);if(D)throw new Error(`Erro ao atualizar cliente existente: ${D.message}`)}else{const O={name:r.name,phone:_,email:r.email||null,address:h,latitude:r.latitude,longitude:r.longitude,cpf_cnpj:B||null,user_id:he},{data:D,error:A}=await k.from("customers").insert(O).select("id").single();if(A)throw new Error(`Erro ao criar cliente: ${A.message}`);v=D.id}const K=me?"pending_payment":"pending",{data:Ee,error:Ke}=await k.from("orders").insert({restaurant_id:u.id,customer_id:v,status:K,total_amount:c,delivery_fee:n,notes:r.notes,delivery_address:h,payment_method_id:r.payment_method_id,change_for:pe?r.change_for:null}).select("id").single();if(Ke)throw new Error(`Erro ao criar pedido: ${Ke.message}`);const zr=o.map(O=>{const D=Number(O.quantity),A=Number(O.price),oe={order_id:Ee.id,product_id:O.product_id,quantity:D,unit_price:A,subtotal:D*A};return O.notes&&O.notes.trim()&&(oe.notes=O.notes.trim()),oe}),{error:Ze}=await k.from("order_items").insert(zr);if(Ze){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Ze);const O=o.map(A=>{const oe=Number(A.quantity),Je=Number(A.price);return{order_id:Ee.id,quantity:oe,unit_price:Je,subtotal:oe*Je,notes:A.notes&&A.notes.trim()?A.notes.trim():null}}),{error:D}=await k.from("order_items").insert(O);if(D)throw new Error(`Erro ao adicionar itens do pedido: ${D.message}`)}return{orderId:Ee.id,orderStatus:K}},onSuccess:r=>{const d=r.orderStatus==="pending_payment"?`/payment/${r.orderId}`:`/order-success/${r.orderId}`;t.reset(),localStorage.removeItem("checkoutFormData"),setTimeout(()=>{s(d,{replace:!0})},100)},onError:r=>{console.error("LOG: Erro ao processar pedido:",r),alert(`Falha ao finalizar pedido: ${r.message}. Verifique o console para mais detalhes.`)}}),Gr=async r=>{if(!await t.trigger()){ze(t.formState.errors);return}if(r.delivery_option==="delivery"&&y){alert(`Não é possível finalizar o pedido: ${y}`);return}se.mutate(r)},ze=r=>{var h;console.error("Validation errors:",r);const d=Object.keys(r)[0];d&&console.error("LOG: Erro de validação:",((h=r[d])==null?void 0:h.message)||"Preencha todos os campos obrigatórios.")},Ue=se.isPending||x,$r=!$||!y&&n>=0,Re=!$||P!==null&&S!==null,Br=!Ue&&$r&&Re;return i.useEffect(()=>{if(o.length===0&&!se.isPending&&!w){const r=setTimeout(()=>{s("/menu",{replace:!0})},100);return()=>clearTimeout(r)}},[o.length,se.isPending,w,s]),o.length===0&&!se.isPending&&!w?e.jsx(We,{}):kr||w?e.jsx(We,{}):Lr?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(W,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro de Conexão"}),e.jsx(Y,{children:$e instanceof Error?$e.message:"Não foi possível carregar os dados."})]})}):e.jsxs(e.Fragment,{children:[e.jsx(xs,{isOpen:Rr,onClose:()=>Me(!1),customer:G}),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(He,{to:"/menu",children:e.jsx(Q,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(js,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]}),G&&e.jsx(Q,{variant:"outline",size:"icon",onClick:()=>Me(!0),"aria-label":"Editar Perfil",children:e.jsx(bs,{className:"h-5 w-5"})})]})}),e.jsx("div",{children:e.jsx(Js,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ms,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(Gr,ze),className:"space-y-6",children:[e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"name",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Nome Completo *"}),e.jsx(U,{placeholder:"Seu nome",...r}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"phone",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Telefone *"}),e.jsx(ps,{...r}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"email",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Email (Opcional)"}),e.jsx(U,{placeholder:"seu@email.com",...r}),e.jsx(V,{})]})})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"delivery_option",render:({field:r})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsxs(Ie,{onValueChange:r.onChange,defaultValue:r.value,className:"flex flex-col space-y-1",children:[e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:"delivery"})}),e.jsx(Ye,{className:"h-5 w-5 text-primary"}),e.jsxs(R,{className:Le("font-normal flex-1 cursor-pointer"),children:["Delivery",q===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:"pickup"})}),e.jsx(nr,{className:"h-5 w-5 text-primary"}),e.jsx(R,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(V,{})]})}),$&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(er,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Q,{type:"button",variant:"outline",size:"sm",onClick:r=>{r.preventDefault(),qr()},disabled:x||L.current,children:[e.jsx(vs,{className:"h-4 w-4 mr-2"})," ",x||L.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(Q,{type:"button",variant:"outline",size:"sm",onClick:Mr,children:[e.jsx(Es,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:t.control,name:"street",render:({field:r})=>e.jsxs(C,{className:"col-span-2",children:[e.jsx(R,{children:"Rua *"}),e.jsx(U,{...r}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"number",render:({field:r})=>e.jsxs(C,{className:"col-span-1",children:[e.jsx(R,{children:"Número *"}),e.jsx(U,{...r}),e.jsx(V,{})]})})]}),e.jsx(I,{control:t.control,name:"complement",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Complemento (Opcional)"}),e.jsx(U,{placeholder:"Apto, Bloco, Casa, etc.",...r,disabled:!1}),e.jsx(V,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:t.control,name:"neighborhood",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Bairro *"}),e.jsx(U,{...r}),e.jsx(V,{})]})}),e.jsx(I,{control:t.control,name:"city",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Cidade *"}),e.jsx(U,{...r}),e.jsx(V,{})]})})]}),e.jsx(I,{control:t.control,name:"zip_code",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"CEP *"}),e.jsx(hs,{...r}),e.jsx(V,{})]})}),$&&Re&&e.jsx("div",{children:e.jsx(fs,{mapKey:Ar,markerPosition:Tr,onLocationChange:Dr,updateAddressFields:_e,restaurant:u})}),x&&q!==!1&&e.jsxs(W,{children:[e.jsx(Xe,{className:"h-4 w-4 animate-spin"}),e.jsx(X,{children:"Calculando Taxa..."}),e.jsx(Y,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),y&&q!==!1&&e.jsxs(W,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro de Entrega"}),e.jsx(Y,{children:y})]}),n>0&&!x&&q!==!1&&e.jsxs(W,{className:"mt-4",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx(X,{children:"Taxa de Entrega Aplicada"}),e.jsxs(Y,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n)]})]}),E&&e.jsxs(W,{variant:"destructive",className:"mt-4",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro ao Buscar Endereço"}),e.jsx(Y,{children:E})]}),$&&!Re&&!E&&e.jsxs(W,{variant:"destructive",children:[e.jsx(er,{className:"h-4 w-4"}),e.jsx(X,{children:"Localização Obrigatória"}),e.jsx(Y,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:t.control,name:"payment_method_id",render:({field:r})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsx(Ie,{onValueChange:d=>{r.onChange(d);const h=J.find(v=>v.id===d);(h==null?void 0:h.name)!=="Dinheiro"&&t.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},defaultValue:r.value,className:"flex flex-col space-y-2",children:J.map(d=>{const h=st(d.icon||"Store");return e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:d.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(R,{className:"font-normal cursor-pointer",children:d.name}),d.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d.description})]})]},d.id)})})}),e.jsx(V,{})]})}),pe&&e.jsx(I,{control:t.control,name:"change_for",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Troco para (Opcional)"}),e.jsx(U,{type:"number",placeholder:"Ex: 50.00",...r,value:r.value||"",onChange:d=>r.onChange(d.target.value?parseFloat(d.target.value):null)}),e.jsx(V,{})]})}),me&&e.jsx(I,{control:t.control,name:"cpf_cnpj",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"CPF/CNPJ *"}),e.jsx(gs,{...r}),e.jsx(V,{})]})})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"4. Observações"})}),e.jsx(de,{children:e.jsx(I,{control:t.control,name:"notes",render:({field:r})=>e.jsxs(C,{children:[e.jsx(R,{children:"Observações do Pedido (Opcional)"}),e.jsx(us,{placeholder:"Ex: Sem cebola, sem alface...",...r}),e.jsx(V,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(He,{to:"/menu",className:"flex-1",children:e.jsx(Q,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(Q,{type:"submit",className:"flex-1",disabled:!Br,size:"lg",children:Ue?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(tt,{subtotal:m,deliveryFee:n,total:c,items:o})})]})]})]})]})};export{Mt as default};
