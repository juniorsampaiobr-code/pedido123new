import{j as e}from"./tanstack-DVJTcRV8.js";import{u as D,r as u,L as R}from"./vendor-C5yldPn0.js";import{L as U}from"./Logo-DxwTUMXK.js";import{B as S}from"./button-DTCXS7fQ.js";import{L as g,I as N}from"./label-CIEy50wN.js";import{C as q,a as _,b as O,c as T,d as $}from"./card-C-Qkmx7q.js";import{c as E,d as z,L as G,u as i}from"./index-Q2vd15TQ.js";import{s as h}from"./client-DM5R7jeC.js";import{P as M}from"./PhoneInput-DdVwTRDx.js";import{S as V}from"./separator-BS7eKo5e.js";import"./shopping-cart-KQLA8Sp0.js";import"./supabase-SdGmRSUE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=E("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=E("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),C=o=>o.replace(/\D/g,""),b=async o=>{const{data:c,error:s}=await h.from("user_roles").select("role, restaurant_id").eq("user_id",o).in("role",["admin","moderator"]).limit(1).single();return s&&s.code!=="PGRST116"?(console.error("Error checking role and restaurant:",s),{role:null,restaurantId:null}):c?{role:c.role,restaurantId:c.restaurant_id}:{role:null,restaurantId:null}},J=async o=>{let{role:c,restaurantId:s}=await b(o.id);if(c!=="admin"&&c!=="moderator"||!s){console.log(`[AdminAuth] Running setup for user ${o.id}. Current role: ${c}, Restaurant ID: ${s}`);const p=o.user_metadata.full_name||"Novo Usuário",{error:m,data:r}=await h.functions.invoke("ensure-admin-access",{body:{userId:o.id,fullName:p}});if(m){console.error("Error setting up admin access:",m);let d="Falha ao configurar acesso de administrador.";throw r&&typeof r=="object"&&"error"in r?d=r.error:m.message.includes("non-2xx status code")?d="Erro interno do servidor (500). Verifique os logs do Supabase.":d=m.message,new Error(d)}const f=await b(o.id);c=f.role,s=f.restaurantId}return{role:c,restaurantId:s}},ie=()=>{const o=D(),[c,s]=u.useState(!0),[p,m]=u.useState(!1),[r,f]=u.useState(!1),[d,I]=u.useState(""),[x,k]=u.useState(""),[j,L]=u.useState(""),[y,A]=u.useState(""),[W,w]=u.useState(null),v=async t=>{s(!0);try{const{role:a,restaurantId:n}=await J(t);if(a==="admin"||a==="moderator")if(n)i.success("Acesso ao painel concedido."),o("/dashboard",{replace:!0});else throw new Error("Sua conta de administrador não está vinculada a um restaurante. Tente novamente ou contate o suporte.");else{i.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await h.auth.signOut();const l=`${window.location.origin}${window.location.pathname}#/menu`;window.location.href=l}}catch(a){console.error("Error during admin setup/redirect:",a),i.error("Erro crítico de autenticação.",{description:a instanceof Error?a.message:"Ocorreu um erro desconhecido. Tente novamente.",duration:8e3}),await h.auth.signOut(),s(!1)}};u.useEffect(()=>{(async()=>{const{data:{session:n}}=await h.auth.getSession();w(n),n!=null&&n.user?v(n.user):s(!1)})();const{data:{subscription:a}}=h.auth.onAuthStateChange((n,l)=>{w(l),n==="SIGNED_IN"&&(l!=null&&l.user)?v(l.user):n==="SIGNED_OUT"&&s(!1)});return()=>a.unsubscribe()},[o]);const P=()=>{if(r){if(!j.trim())return i.error("O Nome Completo é obrigatório."),!1;if(C(y).length!==11)return i.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1}return d.trim()?x.length<6?(i.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(i.error("O Email é obrigatório."),!1)},F=async t=>{if(t.preventDefault(),!!P()){m(!0);try{if(r){const a=C(y),{data:n,error:l}=await h.auth.signUp({email:d,password:x,options:{data:{full_name:j,phone:a}}});if(l)throw l;n.session?i.success("Conta de administrador criada e login efetuado!"):(i.success("Conta criada! Verifique seu email para confirmar."),m(!1))}else{const{error:a}=await h.auth.signInWithPassword({email:d,password:x});if(a)throw a;i.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?i.error("Por favor, verifique seu e-mail para confirmar sua conta."):i.error(a.message||"Erro ao processar autenticação"),m(!1)}}};return c?e.jsx(z,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(U,{className:"justify-center mb-4"})}),e.jsxs(q,{className:"shadow-xl border-2",children:[e.jsxs(_,{className:"space-y-1",children:[e.jsxs(O,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[r?e.jsx(H,{className:"h-6 w-6 text-primary"}):e.jsx(B,{className:"h-6 w-6 text-destructive"}),r?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(T,{className:"text-center",children:r?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(N,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:j,onChange:t=>L(t.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"phone",children:"Telefone *"}),e.jsx(M,{id:"phone",value:y,onChange:t=>A(t.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"email",children:"Email *"}),e.jsx(N,{id:"email",type:"email",placeholder:"seu@email.com",value:d,onChange:t=>I(t.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"password",children:"Senha *"}),e.jsx(N,{id:"password",type:"password",placeholder:"••••••••",value:x,onChange:t=>k(t.target.value),required:!0,className:"h-12"})]}),e.jsx(S,{type:"submit",className:"w-full",size:"lg",disabled:p,children:p?e.jsx(G,{className:"h-4 w-4 animate-spin mr-2"}):r?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(S,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>f(!r),children:r?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(V,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(R,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{ie as default};
