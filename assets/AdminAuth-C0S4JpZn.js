import{j as e}from"./tanstack-d4AvmB45.js";import{u as H,r as l,L as W}from"./vendor-CnEXr6gt.js";import{L as K}from"./Logo-D3s2yFWH.js";import{B as v}from"./button-C3LCGBt_.js";import{L as j,I as y}from"./label-B0XVMVo7.js";import{C as Q,b as X,c as Y,d as Z,a as ee}from"./card-CbzoTecv.js";import{c as ae,b as re,L as F,u as s}from"./index-BjIwDNSh.js";import{s as m}from"./client-D5i5GwB9.js";import{M as A,P as se}from"./PhoneInput-CTk5FLgV.js";import{S as te}from"./separator-4sTaRu3B.js";import{C as oe}from"./CpfCnpjInput-xxlL6JHr.js";import{L as ne}from"./lock-Sa5QFszS.js";import{A as ie}from"./arrow-left-qCgNz1ns.js";import"./shopping-cart-CqBOgfsj.js";import"./supabase-BZV_3FV3.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=ae("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),D=t=>t.replace(/\D/g,""),q=t=>t.replace(/\D/g,""),U=async t=>{const{data:i,error:n}=await m.from("user_roles").select("role, restaurant_id").eq("user_id",t).limit(1).single();return n&&n.code!=="PGRST116"?(console.error("Error checking role and restaurant:",n),{role:null,restaurantId:null}):i?{role:i.role,restaurantId:i.restaurant_id}:{role:null,restaurantId:null}},le=async t=>{let{role:i,restaurantId:n}=await U(t.id);if((i==="admin"||i==="moderator")&&n)return{role:i,restaurantId:n};console.log(`[AdminAuth] Running setup for user ${t.id}. Current role: ${i}, Restaurant ID: ${n}`);const g=t.user_metadata.full_name||"Novo Usuário",p=t.user_metadata.store_name||g,c=t.user_metadata.cpf_cnpj||null,w=t.user_metadata.phone||null,{error:h,data:f}=await m.functions.invoke("ensure-admin-access",{body:{userId:t.id,fullName:g,storeName:p,cpfCnpj:c,phone:w}});if(h){console.error("Error setting up admin access:",h);let x="Falha ao configurar acesso de administrador.";throw f&&typeof f=="object"&&"error"in f?x=f.error:h.message.includes("non-2xx status code")?x="Erro interno do servidor (500). Verifique os logs do Supabase.":x=h.message,new Error(x)}const d=await U(t.id);return i=d.role,n=d.restaurantId,{role:i,restaurantId:n}},Se=()=>{const t=H(),[i,n]=l.useState(!0),[g,p]=l.useState(!1),[c,w]=l.useState(!1),[h,f]=l.useState(!1),[d,x]=l.useState(""),[N,R]=l.useState(""),[b,O]=l.useState(""),[E,T]=l.useState(""),[S,z]=l.useState(""),[P,J]=l.useState(""),[de,L]=l.useState(null),I=async r=>{n(!0);try{const{role:a,restaurantId:o}=await le(r);if(a==="admin"||a==="moderator")if(o)s.success("Acesso ao painel concedido."),t("/dashboard",{replace:!0});else throw new Error("Sua conta de administrador não está vinculada a um restaurante. Tente novamente ou contate o suporte.");else s.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await m.auth.signOut(),t("/",{replace:!0})}catch(a){console.error("Error during admin setup/redirect:",a),s.error("Erro crítico de autenticação.",{description:a instanceof Error?a.message:"Ocorreu um erro desconhecido. Tente novamente.",duration:8e3}),await m.auth.signOut(),n(!1)}};l.useEffect(()=>{(async()=>{const{data:{session:o}}=await m.auth.getSession();L(o),o!=null&&o.user?I(o.user):n(!1)})();const{data:{subscription:a}}=m.auth.onAuthStateChange((o,u)=>{L(u),o==="SIGNED_IN"&&(u!=null&&u.user)?I(u.user):o==="SIGNED_OUT"&&n(!1)});return()=>a.unsubscribe()},[t]);const M=()=>{if(c){if(!b.trim())return s.error("O Nome Completo é obrigatório."),!1;if(!S.trim())return s.error("O Nome da Loja é obrigatório."),!1;if(D(E).length!==11)return s.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1;const a=q(P);if(a.length!==11&&a.length!==14)return s.error("O CPF deve ter 11 dígitos ou CNPJ 14 dígitos."),!1}return d.trim()?N.length<6?(s.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(s.error("O Email é obrigatório."),!1)},V=async r=>{if(r.preventDefault(),!!M()){p(!0);try{if(c){const a=D(E),o=q(P),{data:u,error:_}=await m.rpc("check_registration_data",{phone_in:a,cpf_cnpj_in:o});if(_)console.error("Erro ao verificar dados:",_);else if(u){const{phone_exists:C,cpf_exists:B}=u;if(C){s.error("Este telefone já está cadastrado em outra conta."),p(!1);return}if(B){s.error("Este CPF/CNPJ já está cadastrado em outra conta."),p(!1);return}}const{data:G,error:k}=await m.auth.signUp({email:d,password:N,options:{data:{full_name:b,phone:a,store_name:S,cpf_cnpj:o}}});if(k){if(k.message.includes("User already registered")){s.warning("Usuário já cadastrado com este email. Tentando fazer login...");const{error:C}=await m.auth.signInWithPassword({email:d,password:N});if(C)throw C;s.success("Login realizado com sucesso!");return}throw k}G.session?s.success("Conta de administrador criada e login efetuado!"):(s.success("Conta criada! Verifique seu email para confirmar."),p(!1))}else{const{error:a}=await m.auth.signInWithPassword({email:d,password:N});if(a)throw a;s.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?s.error("Por favor, verifique seu e-mail para confirmar sua conta."):s.error(a.message||"Erro ao processar autenticação"),p(!1)}}},$=async r=>{if(r.preventDefault(),!d.trim()){s.error("O Email é obrigatório para recuperação de senha.");return}p(!0);try{const o=`${window.location.origin+window.location.pathname}#/password-recovery`,{error:u}=await m.auth.resetPasswordForEmail(d,{redirectTo:o});if(u)throw u;s.success("Email de recuperação enviado!",{description:"Verifique sua caixa de entrada (e spam) para o link de redefinição de senha.",duration:8e3}),f(!1)}catch(a){s.error(a.message||"Erro ao enviar email de recuperação.")}finally{p(!1)}};return i?e.jsx(re,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(K,{className:"justify-center mb-4"})}),e.jsxs(Q,{className:"shadow-xl border-2",children:[e.jsxs(X,{className:"space-y-1",children:[e.jsxs(Y,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[h?e.jsx(A,{className:"h-6 w-6 text-primary"}):c?e.jsx(ce,{className:"h-6 w-6 text-primary"}):e.jsx(ne,{className:"h-6 w-6 text-destructive"}),h?"Recuperar Senha":c?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(Z,{className:"text-center",children:h?"Digite seu email para receber o link de redefinição.":c?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs(ee,{className:"space-y-4",children:[h?e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"email",children:"Email *"}),e.jsx(y,{id:"email",type:"email",placeholder:"seu@email.com",value:d,onChange:r=>x(r.target.value),required:!0,className:"h-12"})]}),e.jsxs(v,{type:"submit",className:"w-full",size:"lg",disabled:g,children:[g?e.jsx(F,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(A,{className:"h-4 w-4 mr-2"}),"Enviar Link de Recuperação"]}),e.jsx("div",{className:"text-center",children:e.jsxs(v,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{f(!1),x("")},children:[e.jsx(ie,{className:"h-4 w-4 mr-1"})," Voltar para o Login"]})})]}):e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(y,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:b,onChange:r=>O(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"storeName",children:"Nome da Loja *"}),e.jsx(y,{id:"storeName",type:"text",placeholder:"Nome do seu restaurante",value:S,onChange:r=>z(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"phone",children:"Telefone *"}),e.jsx(se,{id:"phone",value:E,onChange:r=>T(r.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cpfCnpj",children:"CPF/CNPJ *"}),e.jsx(oe,{id:"cpfCnpj",value:P,onChange:r=>J(r.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"CPF (11 dígitos) ou CNPJ (14 dígitos)."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"email",children:"Email *"}),e.jsx(y,{id:"email",type:"email",placeholder:"seu@email.com",value:d,onChange:r=>x(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"password",children:"Senha *"}),e.jsx(y,{id:"password",type:"password",placeholder:"••••••••",value:N,onChange:r=>R(r.target.value),required:!0,className:"h-12"})]}),!c&&e.jsx("div",{className:"text-right",children:e.jsx(v,{variant:"link",type:"button",className:"p-0 h-auto text-sm text-muted-foreground hover:text-primary",onClick:()=>f(!0),children:"Esqueci minha senha"})}),e.jsx(v,{type:"submit",className:"w-full",size:"lg",disabled:g,children:g?e.jsx(F,{className:"h-4 w-4 animate-spin mr-2"}):c?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(v,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>w(!c),children:c?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(te,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(W,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{Se as default};
