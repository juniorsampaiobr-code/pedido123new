import{u as U,b,c as $,j as e}from"./tanstack-d4AvmB45.js";import{o as A,s as W,p,c as x,a as G,u as J,d as X,t as Y}from"./types-DKlirIXB.js";import{s as m}from"./client-D5i5GwB9.js";import{B as v}from"./button-DVc_LyvO.js";import{C as ee,b as ae,c as re,a as se}from"./card-ZfdPw1Dx.js";import{I as g}from"./label-DGymdVt7.js";import{S as te}from"./skeleton-BJDmEsKh.js";import{a as ne,u as y}from"./index-CNGolnCh.js";import{A as z,a as T,b as Z}from"./alert-4e1haCKc.js";import{F as oe,a as h,b as N,d as w,e as E}from"./form-B2jBlwAP.js";import{u as ie,i as le,r as f,L as de}from"./vendor-CnEXr6gt.js";import{S as ce}from"./switch-6uhYeAeA.js";import{T as me}from"./terminal-COabtAMI.js";import{S as ue}from"./settings-2XOed4Le.js";import{T as pe}from"./trash-2-DZ2lhV7a.js";import{P as xe}from"./plus-CYlqDNra.js";import"./supabase-BZV_3FV3.js";import"./index-KNP7Yozt.js";const ve=A({id:W().optional(),max_distance_km:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Distância deve ser um número."}).positive("A distância máxima deve ser maior que zero.")),delivery_fee:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Taxa deve ser um número."}).min(0,"A taxa não pode ser negativa.")),min_delivery_time_minutes:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Tempo deve ser um número."}).min(0,"O tempo mínimo não pode ser negativo.")),center_latitude:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),center_longitude:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),ge=A({zones:G(ve)}),he=async t=>{const{data:i,error:r}=await m.from("restaurants").select("*").eq("id",t).single();if(r)throw new Error(`Erro ao buscar dados do restaurante: ${r.message}`);if(!i)throw new Error("Nenhum restaurante encontrado.");return i},ye=async t=>{const{data:i,error:r}=await m.from("delivery_zones").select("*").eq("restaurant_id",t).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return i},fe=async t=>{const{data:i,error:r}=await m.from("restaurants").select("delivery_enabled").eq("id",t).single();return r?(console.warn("Erro ao buscar status de entrega:",r),!0):i.delivery_enabled??!0},_e=async(t,i)=>{const r={delivery_enabled:i},{error:s}=await m.from("restaurants").update(r).eq("id",t);if(s)throw new Error(`Erro ao atualizar status de entrega: ${s.message}`)},Ie=()=>{const t=ie(),i=U(),{userRestaurantId:r}=le(),{data:s,isLoading:L}=b({queryKey:["restaurantDataForDelivery",r],queryFn:()=>he(r),enabled:!!r}),{data:_,isLoading:F,isError:R,error:C}=b({queryKey:["deliveryZones",r],queryFn:()=>ye(r),enabled:!!r}),{data:S,isLoading:I}=b({queryKey:["deliveryStatus",r],queryFn:()=>fe(r),enabled:!!r}),l=J({resolver:Y(ge),defaultValues:{zones:[]},mode:"onChange"}),{fields:P,append:k,remove:K,replace:D}=X({control:l.control,name:"zones"}),j=f.useMemo(()=>typeof(s==null?void 0:s.latitude)=="number"&&typeof(s==null?void 0:s.longitude)=="number"?[s.latitude,s.longitude]:[-23.55052,-46.633308],[s==null?void 0:s.latitude,s==null?void 0:s.longitude]),q=f.useCallback(n=>{const o=n.map(a=>({id:a.id,delivery_fee:a.delivery_fee,max_distance_km:a.max_distance_km&&typeof a.max_distance_km=="number"?a.max_distance_km:1,min_delivery_time_minutes:a.min_delivery_time_minutes??0,center_latitude:a.center_latitude,center_longitude:a.center_longitude}));D(o)},[D]);f.useEffect(()=>{_&&q(_)},[_,q]);const Q=$({mutationFn:({restaurantId:n,enabled:o})=>_e(n,o),onSuccess:(n,o)=>{i.invalidateQueries({queryKey:["deliveryStatus",o.restaurantId]}),i.invalidateQueries({queryKey:["checkoutRestaurantData"]}),y.success(`Taxas de entrega ${o.enabled?"ativadas":"desativadas"} com sucesso!`)},onError:n=>{y.error(`Erro ao atualizar status: ${n.message}`)}}),u=$({mutationFn:async n=>{if(!r)throw new Error("ID do restaurante não disponível.");const o=n.zones.map(c=>({restaurant_id:r,delivery_fee:c.delivery_fee,max_distance_km:c.max_distance_km,min_delivery_time_minutes:c.min_delivery_time_minutes,center_latitude:c.center_latitude,center_longitude:c.center_longitude,is_active:!0})),{error:a}=await m.from("delivery_zones").delete().eq("restaurant_id",r);if(a)throw new Error(`Erro ao limpar zonas antigas: ${a.message}`);const{error:d}=await m.from("delivery_zones").insert(o);if(d)throw new Error(`Erro ao inserir novas zonas: ${d.message}`)},onSuccess:()=>{y.success("Faixas de entrega salvas com sucesso!"),i.invalidateQueries({queryKey:["deliveryZones",r]}),i.invalidateQueries({queryKey:["checkoutDeliveryZones"]})},onError:n=>{y.error(`Erro ao salvar faixas de entrega: ${n.message}`)}}),M=n=>{u.mutate(n)},O=f.useCallback(()=>{k({delivery_fee:5,max_distance_km:10,min_delivery_time_minutes:30,center_latitude:j[0],center_longitude:j[1]})},[k,j]),V=(s==null?void 0:s.latitude)&&(s==null?void 0:s.longitude),B=n=>{r&&Q.mutate({restaurantId:r,enabled:n})};return F||L||I?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsx(te,{className:"h-96 w-full"})})}):R?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(z,{variant:"destructive",children:[e.jsx(me,{className:"h-4 w-4"}),e.jsx(T,{children:"Erro ao carregar zonas de entrega"}),e.jsx(Z,{children:C instanceof Error?C.message:"Ocorreu um erro desconhecido."})]})})}):V?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(ee,{children:[e.jsx(ae,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(re,{className:"text-2xl font-bold",children:"Taxa de Entrega Dinâmica"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina a taxa de entrega com base na distância máxima em quilômetros (km) a partir do centro do seu restaurante."})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-muted p-3 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Taxas de Entrega"}),e.jsx(ce,{checked:S??!0,onCheckedChange:B}),e.jsx("span",{className:"text-sm font-medium",children:S?"Ativadas":"Desativadas"})]})]})}),e.jsx(se,{children:e.jsx(oe,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(M),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-3 rounded-lg bg-muted/50 font-semibold text-sm text-muted-foreground",children:[e.jsx("div",{className:"col-span-1",children:"Distância (km)"}),e.jsx("div",{className:"col-span-1",children:"Valor da taxa (R$)"}),e.jsx("div",{className:"col-span-1",children:"Tempo mínimo (min)"}),e.jsx("div",{className:"col-span-1 text-center",children:"Ações"})]}),P.map((n,o)=>e.jsxs("div",{className:"grid grid-cols-4 gap-4 items-center p-4 border rounded-lg relative",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${o}.max_distance_km`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",step:"0.1",placeholder:"km",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>{const c=d.target.value,H=c===""?"":parseFloat(c.replace(",","."));a.onChange(H)}})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${o}.delivery_fee`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",step:"0.01",placeholder:"R$",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${o}.min_delivery_time_minutes`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",placeholder:"min",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1 flex justify-center gap-2",children:e.jsx(v,{type:"button",variant:"destructive",size:"icon",onClick:()=>K(o),children:e.jsx(pe,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"hidden",children:[e.jsx(h,{control:l.control,name:`zones.${o}.center_latitude`,render:({field:a})=>e.jsx(g,{type:"hidden",...a})}),e.jsx(h,{control:l.control,name:`zones.${o}.center_longitude`,render:({field:a})=>e.jsx(g,{type:"hidden",...a})})]})]},n.id)),e.jsxs("div",{className:"mt-8 text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:"Atenção!"}),e.jsx("p",{className:"text-muted-foreground",children:"Com a taxa dinâmica habilitada, você pode adicionar cobrar a taxa de entrega de acordo com a distância do local de entrega. Exemplo: até 2km cobrar R$4,00."})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>t("/settings"),children:"Redefinir local da loja"}),e.jsxs(v,{type:"button",className:ne("bg-pink-500 hover:bg-pink-600 text-white",u.isPending&&"opacity-70 cursor-not-allowed"),onClick:O,disabled:u.isPending||!r,children:[e.jsx(xe,{className:"mr-2 h-4 w-4"})," Adicionar taxa dinâmica"]}),e.jsx(v,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:u.isPending||!r,children:u.isPending?"Salvando...":"Salvar Configurações"})]})]})})})]})})}):e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(z,{children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(T,{children:"Endereço Não Configurado"}),e.jsxs(Z,{children:["Para configurar zonas de entrega baseadas em distância, primeiro configure o endereço e as coordenadas do seu restaurante na página de Configurações.",e.jsx(de,{to:"/settings",children:e.jsx(v,{variant:"link",className:"p-0 h-auto mt-2",children:"Ir para Configurações"})})]})]})})})};export{Ie as default};
