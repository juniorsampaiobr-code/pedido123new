import{j as e,b as ee,u as re}from"./tanstack-D8i8yNxB.js";import{j as T,L as R,r as s,u as oe,O as ae}from"./vendor-Dl0Wzy4_.js";import{s as x}from"./client-BmrnLCXS.js";import{L as V}from"./Logo-D_hIrF4H.js";import{c as v,b as z,u as d,v as q,T as D,d as M,e as O,L as se}from"./index-BV2pXnCR.js";import{P as H}from"./package-DfGqLqpX.js";import{S as P}from"./shopping-cart-CGu56WKn.js";import{C as U}from"./clock-BDg6nOaw.js";import{C as F}from"./credit-card-DfK9wCkF.js";import{T as $}from"./truck-0p2d6qjr.js";import{S as B}from"./settings-Dn2T-tF7.js";import{B as w}from"./button-Cy6QGYdZ.js";import{A as te,b as ne,c as ie,d as le,e as de,f as ce,h as ue}from"./alert-dialog-C95GKMdl.js";import{V as G}from"./volume-2-DBAbbqce.js";import{S as me,f as he,a as fe}from"./sheet-Cefy3Hw6.js";import{S as pe}from"./use-sound-BBGoA6Ap.js";import"./supabase-A1WgB1xz.js";import"./index-C8hQQgVv.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=v("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=v("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=v("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=v("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=v("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),be=[{href:"/dashboard",label:"Dashboard",icon:K},{href:"/products",label:"Produtos",icon:H},{href:"/orders",label:"Pedidos",icon:P},{href:"/cashier",label:"Caixa",icon:Q},{href:"/hours",label:"Hor√°rios",icon:U},{href:"/payments",label:"Pagamentos",icon:F},{href:"/delivery",label:"Taxa de Entrega",icon:$},{href:"/settings",label:"Configura√ß√µes",icon:B}],ye=()=>{const n=T();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(V,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:be.map(o=>e.jsx("li",{children:e.jsxs(R,{to:o.href,className:z("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",n.pathname===o.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(o.icon,{className:"h-4 w-4"}),o.label]})},o.href))})})]})},ve=({isOpen:n,onEnable:o})=>e.jsx(te,{open:n,children:e.jsxs(ne,{children:[e.jsxs(ie,{children:[e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-6 w-6 text-primary"}),"Ativar Notifica√ß√µes Sonoras?"]}),e.jsxs(de,{children:["Para garantir que voc√™ n√£o perca nenhum novo pedido, precisamos da sua permiss√£o para tocar um som de notifica√ß√£o.",e.jsx("br",{}),e.jsx("br",{}),'Ao clicar em "Ativar", um som de teste ser√° reproduzido.']})]}),e.jsx(ce,{children:e.jsx(ue,{onClick:o,className:"w-full",children:"Sim, ativar som"})})]})}),je=[{href:"/dashboard",label:"Dashboard",icon:K},{href:"/products",label:"Produtos",icon:H},{href:"/orders",label:"Pedidos",icon:P},{href:"/cashier",label:"Caixa",icon:Q},{href:"/hours",label:"Hor√°rios",icon:U},{href:"/payments",label:"Pagamentos",icon:F},{href:"/delivery",label:"Taxa de Entrega",icon:$},{href:"/settings",label:"Configura√ß√µes",icon:B}],Se=()=>{const n=T(),[o,l]=s.useState(!1);return e.jsxs(me,{open:o,onOpenChange:l,children:[e.jsx(he,{asChild:!0,children:e.jsx(w,{variant:"ghost",size:"icon",children:e.jsx(xe,{className:"h-6 w-6"})})}),e.jsxs(fe,{side:"left",className:"flex flex-col w-64",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(V,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:je.map(h=>e.jsx("li",{children:e.jsxs(R,{to:h.href,onClick:()=>l(!1),className:z("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",n.pathname===h.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(h.icon,{className:"h-4 w-4"}),h.label]})},h.href))})})]})]})},A=768;function we(){const[n,o]=s.useState(void 0);return s.useEffect(()=>{const l=window.matchMedia(`(max-width: ${A-1}px)`),h=()=>{o(window.innerWidth<A)};return l.addEventListener("change",h),o(window.innerWidth<A),()=>l.removeEventListener("change",h)},[]),!!n}const Ce=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes"}],Ne=n=>{const o=Ce.find(l=>l.href===n);return o?o.label:"Dashboard"},ke=async n=>{const{data:o,error:l}=await x.from("user_roles").select("role").eq("user_id",n).in("role",["admin","moderator"]).limit(1).single();return l&&l.code!=="PGRST116"?(console.error("Error checking role:",l),null):(o==null?void 0:o.role)||null},Ee=()=>{const n=oe(),o=T(),l=ee(),[h,C]=s.useState(null),[p,N]=s.useState(void 0),t=s.useRef(null),[i,j]=s.useState("loading"),[W,L]=s.useState(!1),[b,k]=s.useState(null);we();const[c,f]=s.useState(()=>localStorage.getItem("soundNotificationStatus")||"disabled");s.useEffect(()=>{localStorage.setItem("soundNotificationStatus",c)},[c]);const{data:u,isLoading:X}=re({queryKey:["dashboardRestaurant"],queryFn:async()=>{const{data:r,error:m}=await x.from("restaurants").select("*").limit(1).single();if(m)throw new Error(m.message);return r},enabled:!!h&&(p==="admin"||p==="moderator"),staleTime:1/0});s.useEffect(()=>{const r=async a=>{if(!(a!=null&&a.user)){C(null),N(null),n("/admin-auth",{replace:!0});return}const y=await ke(a.user.id);C(a.user),N(y),y!=="admin"&&y!=="moderator"&&(d.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),n("/admin-auth",{replace:!0}))},{data:{subscription:m}}=x.auth.onAuthStateChange((a,y)=>{a==="SIGNED_OUT"?(C(null),N(null),n("/admin-auth",{replace:!0})):r(y)});return x.auth.getSession().then(({data:{session:a}})=>{r(a)}),()=>m.unsubscribe()},[n]),s.useEffect(()=>{var r;u!=null&&u.notification_sound_url?((r=t.current)==null?void 0:r.src)!==u.notification_sound_url&&j("loading"):j("error")},[u==null?void 0:u.notification_sound_url]),s.useEffect(()=>{!localStorage.getItem("hasSeenSoundPermissionModal")&&c!=="enabled"&&i==="ready"&&L(!0)},[c,i]);const g=s.useCallback(()=>{t.current&&(t.current.pause(),t.current.loop=!1,k(null))},[]),I=s.useCallback(r=>{if(c==="enabled"&&t.current&&i==="ready"){if(b)return;k(r),t.current.loop=!0,t.current.play().catch(m=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",m),k(null),d.warning("N√£o foi poss√≠vel tocar o som automaticamente.",{description:"Interaja com a p√°gina para permitir a reprodu√ß√£o de som."})})}},[c,i,b]);s.useEffect(()=>{if(p!=="admin"&&p!=="moderator")return;const r=x.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},m=>{l.invalidateQueries({queryKey:["orders"]});const a=m.new;a.status==="pending"&&a.id&&(d.info("üîî Novo pedido recebido!",{description:`Pedido #${a.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),I(a.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},m=>{l.invalidateQueries({queryKey:["orders"]});const a=m.new;a.id===b&&g(),a.status==="pending"&&a.id&&m.old.status==="pending_payment"&&d.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${a.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3})}).subscribe();return()=>{x.removeChannel(r)}},[l,I,g,b,p]);const E=s.useCallback(()=>{if(c==="enabled"&&t.current&&i==="ready"){g(),t.current.loop=!1,t.current.currentTime=0;const r=t.current.play();r!==void 0&&r.then(()=>{console.log("Som de teste tocado com sucesso")}).catch(m=>{console.error("Erro ao tocar som de teste:",m),f("error"),d.error("N√£o foi poss√≠vel tocar o som de teste.",{description:"Seu navegador pode ter bloqueado a reprodu√ß√£o. Interaja com a p√°gina e tente novamente."})})}else i==="ready"?(f("enabled"),setTimeout(()=>E(),100)):(d.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado.",{description:"Verifique se a URL do som est√° correta nas Configura√ß√µes."}),f("error"))},[c,i,g]),J=async()=>{if(i!=="ready"||!t.current){d.error("O arquivo de som ainda n√£o est√° pronto. Tente novamente em um momento.");return}try{t.current.currentTime=0,await t.current.play(),f("enabled"),d.success("Notifica√ß√µes sonoras ativadas!"),localStorage.setItem("hasSeenSoundPermissionModal","true")}catch(r){console.error("Audio activation failed from modal:",r),d.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado a reprodu√ß√£o. Por favor, tente ativar manualmente no √≠cone do cabe√ßalho."}),f("error")}finally{L(!1)}},Y=async()=>{if(c==="enabled"){g(),f("disabled"),d.info("Notifica√ß√µes sonoras desativadas.");return}if(i!=="ready"||!t.current){d.error("Som de notifica√ß√£o n√£o est√° pronto ou configurado."),f("error");return}try{t.current.currentTime=0,await t.current.play(),f("enabled"),d.success("Notifica√ß√µes sonoras ativadas!",{description:"Voc√™ ouviu o som de teste."})}catch(r){console.error("Audio activation failed:",r),d.error("Falha ao ativar o som.",{description:"Seu navegador pode ter bloqueado. Clique na p√°gina e tente novamente."}),f("error")}},Z=async()=>{await x.auth.signOut()};if(p===void 0||X)return e.jsx(q,{});if(p!=="admin"&&p!=="moderator")return e.jsx(q,{});if(!u)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(Alert,{variant:"destructive",className:"max-w-md",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx(AlertTitle,{children:"Erro Cr√≠tico"}),e.jsx(AlertDescription,{children:"N√£o foi poss√≠vel carregar os dados do restaurante. Verifique as configura√ß√µes ou entre em contato com o suporte."})]})});const S=i!=="ready";return e.jsxs(pe.Provider,{value:{playSound:E,stopSoundLoop:g,soundStatus:c,loopingOrderId:b},children:[e.jsx(ve,{isOpen:W,onEnable:J}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(ye,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(Se,{})}),e.jsx(P,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:Ne(o.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(D,{children:[e.jsx(M,{asChild:!0,children:e.jsx(w,{variant:"outline",size:"sm",onClick:E,disabled:S,children:"Testar Som"})}),S&&e.jsx(O,{children:i==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsxs(D,{children:[e.jsx(M,{asChild:!0,children:e.jsxs(w,{variant:"outline",size:"icon",onClick:Y,disabled:S,"aria-label":c==="enabled"?"Desativar som":"Ativar som",children:[i==="loading"&&e.jsx(se,{className:"h-4 w-4 animate-spin"}),i==="ready"&&c==="enabled"&&e.jsx(G,{className:"h-4 w-4 text-green-500"}),i==="ready"&&c==="disabled"&&e.jsx(ge,{className:"h-4 w-4"}),i==="error"&&e.jsx(_,{className:"h-4 w-4 text-destructive"})]})}),S&&e.jsx(O,{children:i==="loading"?"Carregando som...":"Som n√£o dispon√≠vel"})]}),e.jsx(w,{variant:"outline",onClick:Z,children:"Sair"})]})]})}),e.jsx(ae,{context:{restaurant:u}})]}),(u==null?void 0:u.notification_sound_url)&&e.jsx("audio",{ref:t,src:u.notification_sound_url,onCanPlayThrough:()=>{j("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:r=>{console.error("Erro ao carregar o √°udio:",r),d.error("Erro ao carregar o som de notifica√ß√£o.",{description:"Verifique o arquivo em Configura√ß√µes."}),j("error"),f("error")},className:"hidden"})]})]})},Ge=s.memo(Ee);export{Ge as default};
