import{u as I,j as e}from"./tanstack-C7aOFagJ.js";import{h as C,u as $,k as b,r as f}from"./vendor-DjsPZZVP.js";import{j as n,C as N,e as R,f as S,L as k,Y as q,b as L,s as j}from"./index-BSHpdu2X.js";import{C as M}from"./circle-alert-B7RHA_S0.js";import"./supabase-BAEEEeUB.js";const O=async r=>{const{data:d,error:a}=await j.from("orders").select("*").eq("id",r).limit(1).single();if(a)throw new Error(`Erro ao buscar pedido: ${a.message}`);if(!d)throw new Error("Pedido não encontrado.");return d},U=()=>{const r=C(),{orderId:d}=$(),[a]=b(),[w,t]=f.useState("Verificando status do pagamento..."),[x,i]=f.useState(!0),[p,u]=f.useState(!1);a.get("status");const E=a.get("external_reference"),v=a.get("restaurantId"),s=d||E,{data:c,isLoading:h}=I({queryKey:["paymentRedirectOrder",s],queryFn:()=>O(s),enabled:!!s,staleTime:0}),o=(c==null?void 0:c.restaurant_id)||v;return f.useEffect(()=>{if(!s){t("ID do pedido não encontrado na URL."),u(!0),i(!1),n.error("Erro de redirecionamento: ID do pedido ausente."),r("/menu",{replace:!0});return}if(h)return;if(!c){t("Pedido não encontrado no banco de dados."),u(!0),i(!1),n.error("Erro: Pedido não existe."),r("/menu",{replace:!0});return}(async()=>{i(!0),t("Confirmando pagamento com Mercado Pago...");try{const{data:m,error:P}=await j.functions.invoke("confirm-payment",{body:{orderId:s}});if(P){let g=P.message;throw g.includes("non-2xx status code")&&(g="Falha de comunicação com o servidor. Verifique se a função 'confirm-payment' está implantada."),new Error(g)}const l=m,y=`/order-success/${s}?status=${l.status}${o?`&restaurantId=${o}`:""}`;l.status==="approved"?(t("Pagamento Aprovado! Redirecionando..."),n.success("Pagamento aprovado!"),r(y,{replace:!0})):l.status==="pending"?(t("Pagamento Pendente. Aguardando confirmação..."),n.warning("Pagamento pendente. Você será notificado quando for confirmado."),r(y,{replace:!0})):(t(`Pagamento Recusado. Status: ${l.status}`),n.error("Pagamento recusado. Tente novamente."),u(!0),r(`/checkout${o?`?restaurantId=${o}`:""}`,{replace:!0}))}catch(m){console.error("Erro na confirmação de pagamento:",m),t(`Erro ao processar pagamento: ${m.message}`),u(!0),i(!1),n.error("Erro ao processar pagamento. Tente novamente."),r(`/checkout${o?`?restaurantId=${o}`:""}`,{replace:!0})}})()},[s,h,c,r,a,o]),e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-muted",children:e.jsxs(N,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(R,{children:e.jsxs(S,{className:"text-2xl font-bold flex items-center justify-center gap-2",children:[x?e.jsx(k,{className:"h-6 w-6 animate-spin text-primary"}):p?e.jsx(M,{className:"h-6 w-6 text-destructive"}):e.jsx(q,{className:"h-6 w-6 text-green-500"}),x?"Processando Pagamento":p?"Erro de Pagamento":"Redirecionando..."]})}),e.jsxs(L,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:w}),p&&e.jsx("div",{className:"mt-4",children:e.jsx("p",{className:"text-sm text-destructive",children:"Você será redirecionado em breve."})})]})]})})};export{U as default};
