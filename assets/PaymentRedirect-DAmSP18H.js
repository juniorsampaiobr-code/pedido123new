import{b as c,c as D,j as r}from"./tanstack-QxCZ3Wpf.js";import{j as R,r as $}from"./vendor-CIxFcw7z.js";import{s as n}from"./client-BskZ_u5h.js";import{v as E}from"./index-DR7ijjK_.js";import{A as u,a as p,b as f}from"./alert-C88zZOqu.js";import{B as v}from"./button-Cp-6nRfW.js";import{T as N}from"./terminal-CKYie6bb.js";import{C as _}from"./credit-card-COI8_m7y.js";import"./supabase-DGFirUEE.js";const F=async a=>{const{data:t,error:e}=await n.from("orders").select("*").eq("id",a).limit(1).single();if(e)throw new Error(`Erro ao buscar pedido: ${e.message}`);if(!t)throw new Error("Pedido não encontrado.");return t},S=async a=>{const{data:t,error:e}=await n.from("order_items").select("*, products(name)").eq("order_id",a);if(e)throw new Error(`Erro ao buscar itens do pedido: ${e.message}`);return t},A=async a=>{const{data:t,error:e}=await n.from("customers").select("*").eq("id",a).limit(1).single();if(e)throw new Error(`Erro ao buscar cliente: ${e.message}`);return t},K=async a=>{const{data:t,error:e}=await n.from("restaurants").select("id, name").eq("id",a).limit(1).single();if(e)throw new Error(`Erro ao buscar restaurante: ${e.message}`);return t},M=()=>{const a=window.location.origin,e=window.location.pathname.split("/")[1];return e?`${a}/${e}`:a},W=()=>{const{orderId:a}=R(),t=M(),{data:e,isLoading:q,isError:P,error:h}=c({queryKey:["paymentOrder",a],queryFn:()=>F(a),enabled:!!a}),{data:d,isLoading:C}=c({queryKey:["paymentOrderItems",a],queryFn:()=>S(a),enabled:!!a}),{data:i,isLoading:L}=c({queryKey:["paymentCustomer",e==null?void 0:e.customer_id],queryFn:()=>A(e.customer_id),enabled:!!(e!=null&&e.customer_id)}),{data:m,isLoading:O}=c({queryKey:["paymentRestaurant",e==null?void 0:e.restaurant_id],queryFn:()=>K(e.restaurant_id),enabled:!!(e!=null&&e.restaurant_id)}),g=q||C||L||O,x=e&&d&&i&&m&&!g,s=D({mutationFn:async()=>{var w;if(!e||!d||!i||!m)throw new Error("Dados incompletos para iniciar o pagamento.");const o=d.map(l=>{var b;return{name:((b=l.products)==null?void 0:b.name)||"Item Desconhecido",price:l.unit_price,quantity:l.quantity}}),I=((w=i.cpf_cnpj)==null?void 0:w.replace(/\D/g,""))||void 0,j={orderId:e.id,items:o,totalAmount:e.total_amount,restaurantName:m.name,clientUrl:t,customerEmail:i.email||"pagador_anonimo@pedido123.com",customerCpfCnpj:I};console.log("LOG: Calling create-payment-preference with payload:",j);const{data:k,error:y}=await n.functions.invoke("create-payment-preference",{body:j});if(y)throw new Error(y.message);return k},onSuccess:o=>{console.log("LOG: Redirecionando para o Mercado Pago:",o.init_point),window.location.href=o.init_point},onError:o=>{console.error("LOG: Erro ao criar preferência de pagamento:",o)}});return $.useEffect(()=>{x&&!s.isPending&&!s.isSuccess&&s.mutate()},[x,s]),a?P?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:r.jsxs(u,{variant:"destructive",className:"w-full max-w-md",children:[r.jsx(N,{className:"h-4 w-4"}),r.jsx(p,{children:"Erro ao Carregar Pedido"}),r.jsx(f,{children:h instanceof Error?h.message:"Ocorreu um erro desconhecido."})]})}):g||s.isPending?r.jsx(E,{}):s.isError?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:r.jsxs(u,{variant:"destructive",className:"w-full max-w-md",children:[r.jsx(_,{className:"h-4 w-4"}),r.jsx(p,{children:"Falha ao Iniciar Pagamento"}),r.jsxs(f,{children:["Não foi possível iniciar o pagamento online. Por favor, volte ao checkout e tente novamente ou escolha outro método.",r.jsxs("p",{className:"mt-2 text-xs italic",children:["Detalhe: ",s.error.message]})]}),r.jsx("div",{className:"mt-4",children:r.jsx("a",{href:`${t}/#/checkout`,children:r.jsx(v,{variant:"default",children:"Voltar ao Checkout"})})})]})}):s.isSuccess?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:r.jsxs("div",{className:"text-center",children:[r.jsx(_,{className:"h-12 w-12 text-primary mx-auto mb-4 animate-pulse"}),r.jsx("p",{className:"text-lg font-semibold",children:"Redirecionando para o Mercado Pago..."}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Se o redirecionamento não ocorrer, clique no botão abaixo."}),r.jsx("a",{href:s.data.init_point,target:"_self",children:r.jsx(v,{className:"mt-4",children:"Ir para o Pagamento"})})]})}):r.jsx(E,{}):r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:r.jsxs(u,{variant:"destructive",className:"w-full max-w-md",children:[r.jsx(N,{className:"h-4 w-4"}),r.jsx(p,{children:"Erro de Pedido"}),r.jsx(f,{children:"ID do pedido não fornecido."})]})})};export{W as default};
