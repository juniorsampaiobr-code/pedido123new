import{b as Y,u as j,c as N,j as e}from"./tanstack-D8i8yNxB.js";import{o as q,s as T,a as Z,b as ee,u as K,t as O}from"./types-BCrSgEF3.js";import{s as u}from"./client-BmrnLCXS.js";import{B as k}from"./button-i8Y55Lz8.js";import{C,b as S,c as P,a as E}from"./card-WRQFOCxn.js";import{I as R}from"./label-CsBceXwz.js";import{S as se}from"./switch-Diugg2pG.js";import{c as ae,L as re,u as f}from"./index-BbcQOFOF.js";import{F as B,b as F,c as M,a as Q,d as L,e as V}from"./form-D1ajIO9-.js";import{S as d}from"./skeleton-BNhFBgxI.js";import{r as A,L as oe}from"./vendor-Dl0Wzy4_.js";import{A as te,a as ne,b as ie}from"./alert-DX5m7DrV.js";import{C as ce,a as de}from"./circle-x-BmNE794Z.js";import{S as $,a as me}from"./store-DF0tjUPp.js";import{P as G}from"./package-X-QugCMK.js";import{C as H}from"./credit-card-B4aUGWvx.js";import{D as z}from"./dollar-sign-Bvx4m8Ke.js";import"./supabase-A1WgB1xz.js";import"./index-PuW-_iwo.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=ae("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]),ue=q({mercado_pago_public_key:T().optional(),mercado_pago_access_token:T().optional()}),xe=q({methods:Z(q({id:T(),is_active:ee()}))}),pe=async()=>{const{data:o,error:a}=await u.from("restaurants").select("id").limit(1).single();if(a)throw new Error(a.message);return o.id},he=async o=>{const{data:a,error:i}=await u.from("payment_settings").select("*").eq("restaurant_id",o).limit(1).single();if(i&&i.code!=="PGRST116")throw new Error(i.message);return a},U=async o=>{const{data:a,error:i}=await u.from("payment_methods").select("*").eq("restaurant_id",o).order("name",{ascending:!0});if(i)throw new Error(i.message);return a},fe=async()=>{const{data:o,error:a}=await u.functions.invoke("check-mp-credentials");if(a)throw new Error(a.message);return o},ge=[{name:"Dinheiro",description:"Pagamento em dinheiro na entrega",icon:z},{name:"Pagamento online: Pix/Cartão",description:"Pagamento online via Mercado Pago (Pix, Cartão de Crédito, etc.)",icon:H},{name:"Pagamento com cartão na entrega",description:"Aceita pagamento com cartão de débito ou crédito na entrega",icon:G}],je=o=>{switch(o){case"DollarSign":return z;case"Smartphone":return me;case"CreditCard":return H;case"Package":return G;default:return $}},ye=({method:o,index:a,control:i,icon:h})=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(h,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:o.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o.description})]})]}),e.jsx(F,{control:i,name:`methods.${a}.is_active`,render:({field:g})=>e.jsx(M,{children:e.jsx(L,{children:e.jsx(se,{checked:g.value,onCheckedChange:g.onChange})})})})]}),Oe=()=>{const o=Y(),{data:a,isLoading:i}=j({queryKey:["restaurantId"],queryFn:pe}),{data:h,isLoading:g}=j({queryKey:["paymentSettings",a],queryFn:()=>he(a),enabled:!!a}),{data:c,isLoading:y,refetch:J}=j({queryKey:["paymentMethods",a],queryFn:()=>U(a),enabled:!!a}),{data:t,isLoading:b}=j({queryKey:["credentialsStatus"],queryFn:fe}),x=K({resolver:O(ue),defaultValues:{mercado_pago_public_key:"",mercado_pago_access_token:"APP_USR-2065423906870531-102020-7f478dfd0d5a75ff13deb0e5548dc1f3-228392372"},mode:"onBlur"});A.useEffect(()=>{h&&x.reset({mercado_pago_public_key:h.mercado_pago_public_key||"",mercado_pago_access_token:"APP_USR-2065423906870531-102020-7f478dfd0d5a75ff13deb0e5548dc1f3-228392372"})},[h,x]);const v=N({mutationFn:async s=>{if(!a)throw new Error("ID do restaurante não disponível.");const n=await u.functions.invoke("save-mp-credentials",{body:JSON.stringify({restaurant_id:a,public_key:s.mercado_pago_public_key,access_token:s.mercado_pago_access_token})});if(n.error)throw new Error(n.error.message);return n.data},onSuccess:s=>{s.token_verified?f.success("Credenciais do Mercado Pago salvas com sucesso!"):f.warning("Atenção!",{description:s.message,duration:15e3}),o.invalidateQueries({queryKey:["paymentSettings"]}),o.invalidateQueries({queryKey:["credentialsStatus"]})},onError:s=>{f.error(`Erro ao salvar credenciais: ${s.message}`)}}),X=s=>{v.mutate(s)},_=N({mutationFn:async s=>{const n=await U(s),m=new Set(n.map(r=>r.name)),l=ge.filter(r=>!m.has(r.name)).map(r=>({restaurant_id:s,name:r.name,description:r.description,icon:r.icon.displayName,is_active:!0}));if(l.length>0){const{error:r}=await u.from("payment_methods").insert(l);if(r)throw new Error(r.message);await J()}},onError:s=>{console.error("Erro ao garantir métodos padrão:",s)}});A.useEffect(()=>{a&&c&&c.length===0&&!y&&_.mutate(a)},[a,c,y,_]);const p=K({resolver:O(xe),defaultValues:{methods:[]},mode:"onBlur"});A.useEffect(()=>{c&&c.length>0&&p.reset({methods:c.map(s=>({id:s.id,is_active:s.is_active??!0}))})},[c,p]);const w=N({mutationFn:async s=>{const n=s.methods.map(r=>u.from("payment_methods").update({is_active:r.is_active}).eq("id",r.id)),l=(await Promise.all(n)).filter(r=>r.error).map(r=>{var D;return(D=r.error)==null?void 0:D.message}).join(", ");if(l)throw new Error(l)},onSuccess:()=>{f.success("Configurações de métodos de pagamento salvas!"),o.invalidateQueries({queryKey:["paymentMethods"]})},onError:s=>{f.error(`Erro ao salvar métodos: ${s.message}`)}}),W=s=>{w.mutate(s)};if(i)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Carregando..."});if(!a)return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8",children:e.jsxs(C,{className:"max-w-md text-center mx-auto",children:[e.jsx(S,{children:e.jsx(P,{children:"Restaurante Não Encontrado"})}),e.jsxs(E,{children:[e.jsx("p",{className:"text-muted-foreground",children:"Não foi possível carregar o ID do restaurante. Por favor, verifique se o seu restaurante está configurado corretamente na página de Configurações."}),e.jsx(oe,{to:"/settings",children:e.jsx(k,{className:"mt-4",children:"Ir para Configurações"})})]})]})});const I=g||y;return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-8",children:[e.jsxs(C,{children:[e.jsxs(S,{children:[e.jsx(P,{className:"text-2xl font-bold flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-6 w-6 text-primary"}),"Credenciais Mercado Pago"]})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure suas chaves de API do Mercado Pago para aceitar pagamentos online."})]}),e.jsx(E,{children:I?e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-4 w-1/4"}),e.jsx(d,{className:"h-10 w-full"}),e.jsx(d,{className:"h-4 w-1/4"}),e.jsx(d,{className:"h-10 w-full"}),e.jsx(d,{className:"h-12 w-full mt-4"})]}):e.jsx(B,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(X),className:"space-y-6",children:[e.jsxs(te,{variant:t!=null&&t.configured?"default":"destructive",children:[b?e.jsx(re,{className:"h-4 w-4 animate-spin"}):t!=null&&t.configured?e.jsx(ce,{className:"h-4 w-4 text-green-500"}):e.jsx(de,{className:"h-4 w-4"}),e.jsx(ne,{children:b?"Verificando Status do Access Token...":t!=null&&t.configured?"Access Token Configurado Corretamente!":"Ação Necessária: Access Token Não Encontrado!"}),e.jsxs(ie,{children:[b?"Aguarde um momento...":t!=null&&t.configured?"O Access Token foi encontrado nos segredos do seu projeto Supabase. O pagamento online deve funcionar.":"O Access Token não foi encontrado ou está vazio nos segredos do seu projeto Supabase. O pagamento online não funcionará até que você o configure.",e.jsxs("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:[e.jsxs("li",{children:[e.jsx("a",{href:"https://www.mercadopago.com.br/developers/panel/credentials",target:"_blank",rel:"noopener noreferrer",className:"font-bold underline",children:"Copie seu Access Token de Produção"})," no painel do Mercado Pago."]}),e.jsxs("li",{children:[e.jsx("a",{href:"https://supabase.com/dashboard/project/vtskautbkbhqwinuassp/settings/functions",target:"_blank",rel:"noopener noreferrer",className:"font-bold underline",children:"Clique aqui para ir aos Segredos do Supabase"})," e salve-o com o nome `MERCADO_PAGO_ACCESS_TOKEN`."]})]})]})]}),e.jsx(F,{control:x.control,name:"mercado_pago_public_key",render:({field:s})=>e.jsxs(M,{children:[e.jsx(Q,{children:"Public Key"}),e.jsx(L,{children:e.jsx(R,{...s,placeholder:"APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta chave é pública e pode ser salva aqui."}),e.jsx(V,{})]})}),e.jsx(F,{control:x.control,name:"mercado_pago_access_token",render:({field:s})=>e.jsxs(M,{children:[e.jsx(Q,{children:"Verificar Access Token"}),e.jsx(L,{children:e.jsx(R,{...s,type:"password",placeholder:"Cole seu Access Token aqui para verificar",className:"h-12"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este campo serve apenas para **verificar** se o token que você salvou no Supabase está correto. Ele **não** salva o token aqui."}),e.jsx(V,{})]})}),e.jsx(k,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:v.isPending,children:v.isPending?"Salvando...":"Salvar Chave Pública e Verificar Token"})]})})})]}),e.jsxs(C,{children:[e.jsxs(S,{children:[e.jsx(P,{className:"text-2xl font-bold",children:"Métodos de Pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ative ou desative os métodos de pagamento aceitos pelo seu estabelecimento."})]}),e.jsx(E,{children:I||_.isPending?e.jsxs("div",{className:"space-y-4",children:[[...Array(4)].map((s,n)=>e.jsxs("div",{className:"flex items-center justify-between py-4 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(d,{className:"h-10 w-10 rounded-md"}),e.jsxs("div",{children:[e.jsx(d,{className:"h-4 w-32 mb-1"}),e.jsx(d,{className:"h-3 w-48"})]})]}),e.jsx(d,{className:"h-6 w-10 rounded-full"})]},n)),e.jsx(d,{className:"h-12 w-full mt-4"})]}):e.jsx(B,{...p,children:e.jsxs("form",{onSubmit:p.handleSubmit(W),className:"space-y-4",children:[p.watch("methods").map((s,n)=>{const m=c==null?void 0:c.find(r=>r.id===s.id),l=m!=null&&m.icon?je(m.icon):$;return e.jsx(ye,{method:m,index:n,control:p.control,icon:l},s.id)}),e.jsx(k,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg mt-6",disabled:w.isPending,children:w.isPending?"Salvando...":"Salvar Configurações"})]})})})]})]})})};export{Oe as default};
