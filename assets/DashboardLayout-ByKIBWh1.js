import{j as e,u as W,a as B,b as te}from"./tanstack-b27kfv6r.js";import{a as X,L as oe,r as n,u as ne,O as ie}from"./vendor-CrUvlFU9.js";import{s as c}from"./client-CNbeM-CQ.js";import{L as le}from"./Logo-B23nbk2P.js";import{b as Q,c as ce,u as v,a as de,L as V,T as ue,o as me,p as he}from"./index-Br5M4KeF.js";import{P as fe}from"./package-BOAdSTNL.js";import{S as Y}from"./shopping-cart-Bx_cyn2A.js";import{C as pe,T as xe}from"./truck-CtXQ2m7y.js";import{C as Z}from"./credit-card-C0OBmbbH.js";import{S as ge}from"./settings-CUdwLib0.js";import{B as I}from"./button-DyiApUNa.js";import{S as je,a as be,b as ye}from"./sheet-BuGIq_bE.js";import{o as we,s as L,u as Ne,t as ve}from"./types-Z9mbP6pS.js";import{D as Ce,a as Se,b as Ee,c as _e,d as Pe,e as De,S as ke}from"./dialog-z-dwmrxU.js";import{F as Le,a as R,b as T,e as A,c as $,d as q}from"./form-lOr0BRe5.js";import{L as Re,I as U}from"./label-DewyFIm5.js";import{M as Te,P as Ae}from"./PhoneInput-3ILgWYGM.js";import{C as $e}from"./CpfCnpjInput-CcWKhMAx.js";import{S as N}from"./skeleton-CwDwFmoR.js";import{U as G}from"./user-DWqOWFhy.js";import{S as qe}from"./store-zSZEKQj5.js";import{P as Ie}from"./phone-DMEw4fjn.js";import{A as M,a as O,b as z}from"./alert-DDFTeZbA.js";import{C as K}from"./circle-alert-BcWjdRQw.js";import"./supabase-hDq9CU0q.js";import"./index-BInv8mUE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=Q("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=Q("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=Q("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),Oe=[{href:"/dashboard",label:"Dashboard",icon:Fe},{href:"/products",label:"Produtos",icon:fe},{href:"/orders",label:"Pedidos",icon:Y},{href:"/cashier",label:"Caixa",icon:Me},{href:"/hours",label:"Hor√°rios",icon:pe},{href:"/payments",label:"Pagamentos",icon:Z},{href:"/delivery",label:"Taxa de Entrega",icon:xe},{href:"/settings",label:"Configura√ß√µes",icon:ge}],ee=()=>{const s=X();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(le,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:Oe.map(r=>e.jsx("li",{children:e.jsxs(oe,{to:r.href,className:ce("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",s.pathname===r.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(r.icon,{className:"h-4 w-4"}),r.label]})},r.href))})})]})},ze=()=>e.jsxs(je,{children:[e.jsx(be,{asChild:!0,children:e.jsx(I,{variant:"outline",size:"icon",children:e.jsx(Ue,{className:"h-4 w-4"})})}),e.jsx(ye,{side:"left",className:"p-0 w-64",children:e.jsx(ee,{})})]}),Ke=s=>s.replace(/\D/g,""),Qe=s=>s.replace(/\D/g,""),Ge=s=>{if(!s)return"";let r=s.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},He=we({full_name:L().min(1,"Nome √© obrigat√≥rio."),phone:L().min(1,"Telefone √© obrigat√≥rio.").transform(Ke).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."}),store_name:L().min(1,"O nome da loja √© obrigat√≥rio."),cpf_cnpj:L().min(1,"CPF/CNPJ √© obrigat√≥rio.").transform(Qe).refine(s=>s.length===11||s.length===14,{message:"CPF deve ter 11 d√≠gitos ou CNPJ 14 d√≠gitos."})}),Je=async s=>{const{data:r,error:o}=await c.from("profiles").select("*").eq("id",s).limit(1).single();if(o&&o.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${o.message}`);const x=r||{id:s,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null},{data:S,error:C}=await c.from("restaurants").select("*").eq("owner_user_id",s).limit(1).single();return C&&C.code!=="PGRST116"&&console.warn("Erro ao buscar restaurante vinculado ao usu√°rio:",C.message),{profile:x,restaurant:S||null}},Ve=({isOpen:s,onClose:r,userId:o})=>{const x=W(),[S,C]=n.useState(null),[_,p]=n.useState(null),{data:d,isLoading:u}=B({queryKey:["adminProfile",o],queryFn:()=>Je(o),enabled:!!o&&s,staleTime:0});n.useEffect(()=>{s&&c.auth.getSession().then(({data:{session:a}})=>{var i,j,y;C(((i=a==null?void 0:a.user)==null?void 0:i.email)||null),p(((y=(j=a==null?void 0:a.user)==null?void 0:j.user_metadata)==null?void 0:y.cpf_cnpj)||null)})},[s]);const m=Ne({resolver:ve(He),defaultValues:{full_name:"",phone:"",store_name:"",cpf_cnpj:""}});n.useEffect(()=>{var a;d&&m.reset({full_name:d.profile.full_name||"",phone:Ge(d.profile.phone||""),store_name:((a=d.restaurant)==null?void 0:a.name)||"",cpf_cnpj:_||""})},[d,m,_]);const h=te({mutationFn:async a=>{var E;if(!o)throw new Error("ID do usu√°rio n√£o encontrado.");const i={full_name:a.full_name,phone:a.phone},{error:j}=await c.from("profiles").update(i).eq("id",o);if(j)throw new Error(`Erro ao atualizar perfil: ${j.message}`);if((E=d==null?void 0:d.restaurant)!=null&&E.id){const f={name:a.store_name,phone:a.phone},{error:D}=await c.from("restaurants").update(f).eq("id",d.restaurant.id);if(D)throw new Error(`Erro ao atualizar nome/telefone da loja: ${D.message}`)}const{error:y}=await c.auth.updateUser({data:{cpf_cnpj:a.cpf_cnpj}});if(y)throw new Error(`Erro ao atualizar CPF/CNPJ: ${y.message}`)},onSuccess:(a,i)=>{v.success("Perfil e nome da loja atualizados com sucesso!"),p(i.cpf_cnpj),x.invalidateQueries({queryKey:["adminProfile"]}),x.invalidateQueries({queryKey:["dashboardRestaurant"]}),x.invalidateQueries({queryKey:["restaurantSettings"]}),r()},onError:a=>{v.error(`Erro ao atualizar perfil: ${a.message}`)}}),P=a=>{h.mutate(a)};return e.jsx(Ce,{open:s,onOpenChange:r,children:e.jsxs(Se,{className:"sm:max-w-[425px]",children:[e.jsxs(Ee,{children:[e.jsxs(_e,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(Pe,{children:"Atualize seus dados de contato e o nome da sua loja."})]}),u?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(N,{className:"h-4 w-1/3"}),e.jsx(N,{className:"h-10 w-full"}),e.jsx(N,{className:"h-4 w-1/3"}),e.jsx(N,{className:"h-10 w-full"}),e.jsx(N,{className:"h-4 w-1/3"}),e.jsx(N,{className:"h-10 w-full"}),e.jsx(N,{className:"h-10 w-full mt-6"})]}):e.jsx(Le,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(P),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Re,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Te,{className:"h-4 w-4"})," Email"]}),e.jsx(U,{value:S||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx(R,{control:m.control,name:"store_name",render:({field:a})=>e.jsxs(T,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"})," Nome da Loja *"]}),e.jsx($,{children:e.jsx(U,{placeholder:"Nome do seu restaurante",...a})}),e.jsx(q,{})]})}),e.jsx(R,{control:m.control,name:"full_name",render:({field:a})=>e.jsxs(T,{children:[e.jsx(A,{children:"Nome Completo *"}),e.jsx($,{children:e.jsx(U,{placeholder:"Seu nome",...a})}),e.jsx(q,{})]})}),e.jsx(R,{control:m.control,name:"phone",render:({field:a})=>e.jsxs(T,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4"})," Telefone *"]}),e.jsx($,{children:e.jsx(Ae,{...a})}),e.jsx(q,{})]})}),e.jsx(R,{control:m.control,name:"cpf_cnpj",render:({field:a})=>e.jsxs(T,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"})," CPF/CNPJ *"]}),e.jsx($,{children:e.jsx($e,{...a})}),e.jsx(q,{})]})}),e.jsx(De,{className:"pt-4",children:e.jsxs(I,{type:"submit",disabled:h.isPending,children:[h.isPending?e.jsx(de,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},We=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes",icon:G}],Be=s=>{const r=We.find(o=>o.href===s);return r?r.label:"Dashboard"},Xe=async s=>{const{data:r,error:o}=await c.from("user_roles").select("role, restaurant_id").eq("user_id",s).limit(1).single();return o&&o.code!=="PGRST116"?(console.error("Error checking role and restaurant:",o),{role:null,restaurantId:null}):r?{role:r.role,restaurantId:r.restaurant_id}:{role:null,restaurantId:null}},Ye=()=>{const s=ne(),r=X(),o=W(),{data:x,isLoading:S}=useAuthStatus(),{data:C,isLoading:_}=useActiveRestaurantId(),[p,d]=n.useState(void 0),[u,m]=n.useState(null),h=n.useRef(null),[P,a]=n.useState("loading"),[i,j]=n.useState(null),[y,E]=n.useState(!1),{data:f,isLoading:D,isError:re,error:H}=B({queryKey:["dashboardRestaurant",u],queryFn:async()=>{if(!u)throw new Error("Restaurant ID not found for user.");const{data:l,error:g}=await c.from("restaurants").select("*").eq("id",u).single();if(g)throw new Error(g.message);return l},enabled:!!x&&(p==="admin"||p==="moderator")&&!!u,staleTime:1/0}),w=n.useMemo(()=>!(f!=null&&f.notification_sound_url)||f.notification_sound_url.trim()===""?"./default-notification.mp3":f.notification_sound_url,[f==null?void 0:f.notification_sound_url]);n.useEffect(()=>{const l=async t=>{if(!(t!=null&&t.user)){setUser(null),d(null),m(null),s("/admin-auth",{replace:!0});return}const{role:b,restaurantId:J}=await Xe(t.user.id);if(setUser(t.user),d(b),m(J),b==="user"){v.error("Acesso restrito.",{description:"Esta conta √© de cliente e n√£o tem permiss√£o para acessar o painel.",duration:5e3}),await c.auth.signOut();const se=`${window.location.origin}${window.location.pathname}#/`;window.location.href=se;return}b!=="admin"&&b!=="moderator"&&(v.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),s("/admin-auth",{replace:!0})),(b==="admin"||b==="moderator")&&!J&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:g}}=c.auth.onAuthStateChange((t,b)=>{t==="SIGNED_OUT"?(setUser(null),d(null),m(null),s("/admin-auth",{replace:!0})):l(b)});return c.auth.getSession().then(({data:{session:t}})=>{l(t)}),()=>g.unsubscribe()},[s]),n.useEffect(()=>{var l;w?((l=h.current)==null?void 0:l.src)!==`${window.location.origin}${window.location.pathname}${w}`&&a("loading"):a("error")},[w]);const k=n.useCallback(()=>{h.current&&(h.current.pause(),h.current.loop=!1,j(null))},[]),F=n.useCallback(l=>{h.current&&P==="ready"&&(i&&i!==l&&k(),(!i||i===l)&&(j(l),h.current.loop=!0,h.current.play().catch(g=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",g),j(null)})))},[P,i,k]);n.useEffect(()=>{if(p!=="admin"&&p!=="moderator"||!u)return;const l=c.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},g=>{o.invalidateQueries({queryKey:["orders"]});const t=g.new;t.status==="pending"&&t.id&&t.restaurant_id===u&&(v.info("üîî Novo pedido recebido!",{description:`Pedido #${t.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),F(t.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},g=>{o.invalidateQueries({queryKey:["orders"]});const t=g.new;t.restaurant_id===u&&(t.status==="pending"&&t.id&&t.id!==i&&(v.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${t.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3}),F(t.id)),t.id===i&&t.status!=="pending"&&t.status!=="pending_payment"&&k())}).subscribe();return()=>{c.removeChannel(l)}},[o,F,k,i,p,u]);const ae=async()=>{await c.auth.signOut()};return S||_||p===void 0||D?e.jsx(V,{}):p!=="admin"&&p!=="moderator"?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(M,{variant:"destructive",className:"max-w-md",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(O,{children:"Acesso Negado"}),e.jsx(z,{children:"Voc√™ n√£o tem permiss√£o para acessar este painel. Redirecionando para o login."})]})}):u?re?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(M,{variant:"destructive",className:"max-w-md",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(O,{children:"Erro ao Carregar Restaurante"}),e.jsx(z,{children:H instanceof Error?H.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})}):f?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{isOpen:y,onClose:()=>E(!1),userId:(x==null?void 0:x.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(ee,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(ze,{})}),e.jsx(Y,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:Be(r.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ue,{children:[e.jsx(me,{asChild:!0,children:e.jsx(I,{variant:"outline",size:"icon",onClick:()=>E(!0),"aria-label":"Meu Perfil",children:e.jsx(G,{className:"h-4 w-4"})})}),e.jsx(he,{children:"Meu Perfil"})]}),e.jsx(I,{variant:"outline",onClick:ae,children:"Sair"})]})]})}),e.jsx(ie,{context:{restaurant:f,userRestaurantId:u}})]}),w&&e.jsx("audio",{ref:h,src:w.startsWith("http")?w:`${window.location.origin}${window.location.pathname}${w}`,onCanPlayThrough:()=>{a("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:l=>{console.error("Erro ao carregar o √°udio:",l),v.error("Erro ao carregar o som de notifica√ß√£o.",{description:"O som de notifica√ß√£o autom√°tica pode n√£o funcionar."}),a("error")},className:"hidden"})]})]}):e.jsx(V,{}):e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(M,{variant:"destructive",className:"max-w-md",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(O,{children:"Erro de Configura√ß√£o"}),e.jsx(z,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})})},Sr=n.memo(Ye);export{Sr as default};
