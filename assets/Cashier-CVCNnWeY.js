import{b as B,u as N,c as S,j as e}from"./tanstack-DXzASLyu.js";import{o as T,p as A,c as O,s as M,u as C,t as E}from"./types-CUwlEUMq.js";import{s as i}from"./client-lAKPhnc8.js";import{B as F}from"./button-BWCSr8HJ.js";import{C as k,b as q,c as D,a as L}from"./card-EBxuDhAr.js";import{L as f,I as y}from"./label-B2Wo9HZe.js";import{S as o}from"./skeleton-DwsbelVv.js";import{c as I,u as p}from"./index-eFV2myc2.js";import{A as $,a as P,b as U}from"./alert-Czwy49iM.js";import{f as K}from"./vendor-YgypLURK.js";import{T as Q}from"./terminal-C9nGWIn8.js";import{D as V}from"./dollar-sign-BNRVUxN4.js";import"./supabase-Bm28tI2t.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=I("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=I("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),z=T({opening_balance:A(a=>String(a).replace(",","."),O.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo inicial não pode ser negativo."))}),J=T({closing_balance:A(a=>String(a).replace(",","."),O.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo final não pode ser negativo.")),notes:M().optional()}),W=async a=>{const{data:{session:t}}=await i.auth.getSession();if(!t)throw new Error("Usuário não autenticado");const{data:s,error:c}=await i.from("cash_register").select("*").eq("restaurant_id",a).is("closed_at",null).order("opened_at",{ascending:!1}).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Erro ao buscar caixa: ${c.message}`);return s||null},X=async()=>0,j=({title:a,value:t,icon:s})=>e.jsxs(k,{children:[e.jsxs(q,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:a}),e.jsx(s,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(L,{children:e.jsx("div",{className:"text-2xl font-bold",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})})]}),me=()=>{const{restaurant:a}=K(),t=B(),{data:s,isLoading:c,isError:R,error:v}=N({queryKey:["currentCashier",a.id],queryFn:()=>W(a.id),enabled:!!a.id}),{data:_=0}=N({queryKey:["salesToday",s==null?void 0:s.opened_at],queryFn:X,enabled:!!s}),x=((s==null?void 0:s.opening_balance)||0)+_,u=!!s,l=C({resolver:E(z),defaultValues:{opening_balance:0}}),n=C({resolver:E(J),defaultValues:{closing_balance:x,notes:""},values:{closing_balance:x,notes:""}}),h=S({mutationFn:async r=>{const{data:{user:d}}=await i.auth.getUser();if(!a.id||!d)throw new Error("Dados de usuário ou restaurante indisponíveis.");const b={restaurant_id:a.id,opening_balance:r.opening_balance,opened_by:d.id},{error:m}=await i.from("cash_register").insert(b);if(m)throw new Error(m.message)},onSuccess:()=>{p.success("Caixa aberto com sucesso!"),t.invalidateQueries({queryKey:["currentCashier"]}),l.reset({opening_balance:0})},onError:r=>{p.error(`Erro ao abrir caixa: ${r.message}`)}}),g=S({mutationFn:async r=>{const{data:{user:d}}=await i.auth.getUser();if(!(s!=null&&s.id)||!d)throw new Error("Nenhum caixa aberto para fechar.");const b={closed_at:new Date().toISOString(),closed_by:d.id,closing_balance:r.closing_balance,notes:r.notes},{error:m}=await i.from("cash_register").update(b).eq("id",s.id);if(m)throw new Error(m.message)},onSuccess:()=>{p.success("Caixa fechado com sucesso!"),t.invalidateQueries({queryKey:["currentCashier"]}),n.reset()},onError:r=>{p.error(`Erro ao fechar caixa: ${r.message}`)}}),w=c||!a.id;return e.jsxs("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:[R&&e.jsxs($,{variant:"destructive",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:"Erro ao carregar caixa"}),e.jsx(U,{children:v instanceof Error?v.message:"Ocorreu um erro desconhecido."})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:w?e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"h-28 w-full"}),e.jsx(o,{className:"h-28 w-full"}),e.jsx(o,{className:"h-28 w-full"})]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{title:"Saldo Inicial",value:(s==null?void 0:s.opening_balance)||0,icon:V}),e.jsx(j,{title:"Vendas Hoje",value:_,icon:G}),e.jsx(j,{title:"Saldo Atual",value:x,icon:H})]})}),e.jsxs(k,{className:"max-w-3xl mx-auto",children:[e.jsxs(q,{children:[e.jsx(D,{className:"text-2xl font-bold",children:"Controle de Caixa"}),e.jsxs("p",{className:`text-sm font-medium ${u?"text-green-600":"text-destructive"}`,children:["Caixa está ",u?"aberto":"fechado"]}),u&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Aberto em: ",new Date(s.opened_at).toLocaleString("pt-BR")]})]}),e.jsx(L,{children:w?e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{className:"h-10 w-1/3"}),e.jsx(o,{className:"h-12 w-full"}),e.jsx(o,{className:"h-12 w-full mt-4"})]}):u?e.jsxs("form",{onSubmit:n.handleSubmit(r=>g.mutate(r)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"closing_balance",children:"Saldo Final (R$)"}),e.jsx(y,{id:"closing_balance",type:"number",step:"0.01",...n.register("closing_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),n.formState.errors.closing_balance&&e.jsx("p",{className:"text-destructive text-sm",children:n.formState.errors.closing_balance.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"notes",children:"Observações (Opcional)"}),e.jsx(y,{id:"notes",...n.register("notes"),className:"h-12"})]}),e.jsx(F,{type:"submit",className:"w-full bg-destructive hover:bg-destructive/90 text-destructive-foreground h-12 text-lg",disabled:g.isPending,children:g.isPending?"Fechando...":"Fechar Caixa"})]}):e.jsxs("form",{onSubmit:l.handleSubmit(r=>h.mutate(r)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"opening_balance",children:"Saldo Inicial (R$)"}),e.jsx(y,{id:"opening_balance",type:"number",step:"0.01",...l.register("opening_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),l.formState.errors.opening_balance&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.opening_balance.message})]}),e.jsx(F,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg",disabled:h.isPending,children:h.isPending?"Abrindo...":"Abrir Caixa"})]})})]})]})};export{me as default};
