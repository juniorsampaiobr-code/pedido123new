import{j as e,b as Or,u as me,c as Tr}from"./tanstack-D8i8yNxB.js";import{r as d,R as he,u as Ar,h as Gr,L as Be}from"./vendor-Dl0Wzy4_.js";import{o as Mr,s as k,l as qr,e as Dr,p as Ee,c as Ue,n as zr,Z as q,u as Br,t as Ur}from"./types-BCrSgEF3.js";import{s as F}from"./client-BmrnLCXS.js";import{c as Ve,f as Qe,g as ke,P as fe,i as Pe,h as Kr,l as Zr,m as Hr,b as ie,a as Jr,v as Qr,L as Ke}from"./index-C28RKmd8.js";import{B as re}from"./button-uoUUVmK6.js";import{C as se,b as te,c as ae,a as ne}from"./card-B-edsjJO.js";import{I as L}from"./label-DaoH6xfQ.js";import{c as We,R as Wr,I as Xr}from"./index-Dr6VB3-R.js";import{u as Yr}from"./index-BB_oiUC3.js";import{u as eo}from"./index-PuW-_iwo.js";import{S as Ze}from"./separator-BnfuJ_e3.js";import{T as ro}from"./textarea-zw8mmWQI.js";import{A as H,a as J,b as Q}from"./alert-BX_9XMLd.js";import{F as oo,b as P,c as v,a as N,e as S,d as oe}from"./form-V8o4uD7U.js";import{Z as so,M as to}from"./MapLocationSection-BdLs3zgp.js";import{T as Re}from"./terminal-nzsVTFeN.js";import{A as ao}from"./arrow-left-2-Zx5SvV.js";import{T as He}from"./truck-BT7vTeHa.js";import{S as Xe,a as no}from"./store-C9U2eY4J.js";import{M as Je}from"./map-pin-CsyyaZYk.js";import{P as io}from"./package-CcyxlXH8.js";import{C as lo}from"./credit-card-MrAi12xI.js";import{D as co}from"./dollar-sign-DzmXqnK5.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uo=Ve("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mo=Ve("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const po=Ve("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var Le="Radio",[ho,Ye]=Qe(Le),[fo,go]=ho(Le),er=d.forwardRef((s,o)=>{const{__scopeRadio:a,name:m,checked:n=!1,required:c,disabled:u,value:p="on",onCheck:f,form:g,..._}=s,[V,C]=d.useState(null),x=ke(o,D=>C(D)),y=d.useRef(!1),w=V?g||!!V.closest("form"):!0;return e.jsxs(fo,{scope:a,checked:n,disabled:u,children:[e.jsx(fe.button,{type:"button",role:"radio","aria-checked":n,"data-state":tr(n),"data-disabled":u?"":void 0,disabled:u,value:p,..._,ref:x,onClick:Pe(s.onClick,D=>{n||f==null||f(),w&&(y.current=D.isPropagationStopped(),y.current||D.stopPropagation())})}),w&&e.jsx(sr,{control:V,bubbles:!y.current,name:m,value:p,checked:n,required:c,disabled:u,form:g,style:{transform:"translateX(-100%)"}})]})});er.displayName=Le;var rr="RadioIndicator",or=d.forwardRef((s,o)=>{const{__scopeRadio:a,forceMount:m,...n}=s,c=go(rr,a);return e.jsx(Kr,{present:m||c.checked,children:e.jsx(fe.span,{"data-state":tr(c.checked),"data-disabled":c.disabled?"":void 0,...n,ref:o})})});or.displayName=rr;var xo="RadioBubbleInput",sr=d.forwardRef(({__scopeRadio:s,control:o,checked:a,bubbles:m=!0,...n},c)=>{const u=d.useRef(null),p=ke(u,c),f=eo(a),g=Zr(o);return d.useEffect(()=>{const _=u.current;if(!_)return;const V=window.HTMLInputElement.prototype,x=Object.getOwnPropertyDescriptor(V,"checked").set;if(f!==a&&x){const y=new Event("click",{bubbles:m});x.call(_,a),_.dispatchEvent(y)}},[f,a,m]),e.jsx(fe.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...n,tabIndex:-1,ref:p,style:{...n.style,...g,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});sr.displayName=xo;function tr(s){return s?"checked":"unchecked"}var yo=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ge="RadioGroup",[jo,ls]=Qe(ge,[We,Ye]),ar=We(),nr=Ye(),[vo,bo]=jo(ge),ir=d.forwardRef((s,o)=>{const{__scopeRadioGroup:a,name:m,defaultValue:n,value:c,required:u=!1,disabled:p=!1,orientation:f,dir:g,loop:_=!0,onValueChange:V,...C}=s,x=ar(a),y=Yr(g),[w,D]=Hr({prop:c,defaultProp:n??null,onChange:V,caller:ge});return e.jsx(vo,{scope:a,name:m,required:u,disabled:p,value:w,onValueChange:D,children:e.jsx(Wr,{asChild:!0,...x,orientation:f,dir:y,loop:_,children:e.jsx(fe.div,{role:"radiogroup","aria-required":u,"aria-orientation":f,"data-disabled":p?"":void 0,dir:y,...C,ref:o})})})});ir.displayName=ge;var lr="RadioGroupItem",cr=d.forwardRef((s,o)=>{const{__scopeRadioGroup:a,disabled:m,...n}=s,c=bo(lr,a),u=c.disabled||m,p=ar(a),f=nr(a),g=d.useRef(null),_=ke(o,g),V=c.value===n.value,C=d.useRef(!1);return d.useEffect(()=>{const x=w=>{yo.includes(w.key)&&(C.current=!0)},y=()=>C.current=!1;return document.addEventListener("keydown",x),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",x),document.removeEventListener("keyup",y)}},[]),e.jsx(Xr,{asChild:!0,...p,focusable:!u,active:V,children:e.jsx(er,{disabled:u,required:c.required,checked:V,...f,...n,name:c.name,ref:_,onCheck:()=>c.onValueChange(n.value),onKeyDown:Pe(x=>{x.key==="Enter"&&x.preventDefault()}),onFocus:Pe(n.onFocus,()=>{var x;C.current&&((x=g.current)==null||x.click())})})})});cr.displayName=lr;var No="RadioGroupIndicator",dr=d.forwardRef((s,o)=>{const{__scopeRadioGroup:a,...m}=s,n=nr(a);return e.jsx(or,{...n,...m,ref:o})});dr.displayName=No;var ur=ir,mr=cr,_o=dr;const Se=d.forwardRef(({className:s,...o},a)=>e.jsx(ur,{className:ie("grid gap-2",s),...o,ref:a}));Se.displayName=ur.displayName;const pe=d.forwardRef(({className:s,...o},a)=>e.jsx(mr,{ref:a,className:ie("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...o,children:e.jsx(_o,{className:"flex items-center justify-center",children:e.jsx(uo,{className:"h-2.5 w-2.5 fill-current text-current"})})}));pe.displayName=mr.displayName;const Co=s=>{let o=s.replace(/\D/g,"");return o.length>11&&(o=o.slice(0,11)),o.length>0&&(o=`(${o}`),o.length>3&&(o=`${o.slice(0,3)}) ${o.slice(3)}`),o.length>10&&(o=`${o.slice(0,10)}-${o.slice(10)}`),o},pr=he.forwardRef(({className:s,value:o,onChange:a,...m},n)=>{const c=u=>{const p=u.target.value,f=Co(p),g={...u,target:{...u.target,value:f}};a(g)};return e.jsx(L,{ref:n,type:"tel",className:ie("w-full",s),placeholder:"(99) 99999-9999",value:o,onChange:c,...m})});pr.displayName="PhoneInput";const wo=s=>{let o=s.replace(/\D/g,"");return o.length>14&&(o=o.slice(0,14)),o.length<=11?(o.length>9&&(o=`${o.slice(0,9)}-${o.slice(9)}`),o.length>6&&(o=`${o.slice(0,6)}.${o.slice(6)}`),o.length>3&&(o=`${o.slice(0,3)}.${o.slice(3)}`),o):(o.length>12&&(o=`${o.slice(0,12)}-${o.slice(12)}`),o.length>8&&(o=`${o.slice(0,8)}/${o.slice(8)}`),o.length>5&&(o=`${o.slice(0,5)}.${o.slice(5)}`),o.length>2&&(o=`${o.slice(0,2)}.${o.slice(2)}`),o)},hr=he.forwardRef(({className:s,value:o,onChange:a,...m},n)=>{const c=u=>{const p=u.target.value,f=wo(p),g={...u,target:{...u.target,value:f}};a(g)};return e.jsx(L,{ref:n,type:"tel",className:ie("w-full",s),placeholder:"CPF ou CNPJ",value:o,onChange:c,maxLength:18,...m})});hr.displayName="CpfCnpjInput";const Eo=(s,o,a,m)=>{const c=(a-s)*(Math.PI/180),u=(m-o)*(Math.PI/180),p=Math.sin(c/2)*Math.sin(c/2)+Math.cos(s*(Math.PI/180))*Math.cos(a*(Math.PI/180))*Math.sin(u/2)*Math.sin(u/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))},Ro=async s=>{const o=s.replace(/\s+/g," ").trim(),a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&limit=1`,m=new AbortController,n=setTimeout(()=>m.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",a);const c=await fetch(a,{signal:m.signal});if(!c.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",c.status),null;const u=await c.json();if(u&&Array.isArray(u)&&u.length>0){const p=u[0],f=parseFloat(p.lat),g=parseFloat(p.lon);if(Number.isFinite(f)&&Number.isFinite(g))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[f,g]),{lat:f,lng:g}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",o),null}catch(c){return c instanceof Error&&c.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",o):console.error("LOG: geocodeAddress - Erro durante a requisição:",c),null}finally{clearTimeout(n)}},Po=(s,o,a)=>{const m=Eo(o[0],o[1],s[0],s[1]),n=a.find(c=>m<=c.max_distance_km);if(n){const c=n.delivery_fee||0,u=n.min_delivery_time_minutes||0,p=u+15;return{fee:parseFloat(c.toFixed(2)),minTime:u,maxTime:p}}return null},fr=s=>s.replace(/\D/g,""),gr=s=>s.replace(/\D/g,""),Ie=s=>s.replace(/\D/g,""),So=Mr({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(fr).refine(s=>s.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:k().email("Email inválido.").optional().or(qr("")),delivery_option:Dr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:k().optional().default(""),number:k().optional().default(""),complement:k().optional().default(""),neighborhood:k().optional().default(""),city:k().optional().default(""),zip_code:k().optional().default("").transform(gr).refine(s=>s.length===8||s.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ee(s=>typeof s=="string"?parseFloat(s):s,Ue.number().optional().nullable()),longitude:Ee(s=>typeof s=="string"?parseFloat(s):s,Ue.number().optional().nullable()),payment_method_id:k().min(1,"Selecione uma forma de pagamento."),notes:k().optional(),cpf_cnpj:k().optional().default("").transform(Ie).refine(s=>s.length===0||s.length===11||s.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ee(s=>{if(s==null||s==="")return null;const o=String(s).replace(",","."),a=parseFloat(o);return isNaN(a)?o:a},zr({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((s,o)=>{if(s.delivery_option==="delivery"&&(s.street.trim()===""&&o.addIssue({code:q.custom,message:"Rua é obrigatória.",path:["street"]}),s.number.trim()===""&&o.addIssue({code:q.custom,message:"Número é obrigatório.",path:["number"]}),s.neighborhood.trim()===""&&o.addIssue({code:q.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),s.city.trim()===""&&o.addIssue({code:q.custom,message:"Cidade é obrigatória.",path:["city"]}),s.zip_code.length!==8&&o.addIssue({code:q.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(s.latitude===null||s.longitude===null)&&o.addIssue({code:q.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),s.payment_method_id==="Dinheiro"&&s.change_for!==null&&s.change_for!==void 0&&s.change_for<=0&&o.addIssue({code:q.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),s.payment_method_id==="Pagamento online: Pix/Cartão"){const n=Ie(s.cpf_cnpj||"");n.length!==11&&n.length!==14&&o.addIssue({code:q.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Io=()=>{const s=window.location.origin,a=window.location.pathname.split("/")[1];return a?`${s}/${a}`:s},Vo=async()=>{const{data:s,error:o}=await F.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(o)throw new Error(`Erro ao buscar restaurante: ${o.message}`);if(!s)throw new Error("Nenhum restaurante ativo encontrado.");return s},ko=async s=>{const{data:o,error:a}=await F.from("restaurants").select("delivery_enabled").eq("id",s).single();if(a)throw new Error(`Erro ao buscar status de entrega: ${a.message}`);return o.delivery_enabled??!0},Lo=async s=>{const{data:o,error:a}=await F.from("payment_methods").select("*").eq("restaurant_id",s).eq("is_active",!0).order("name",{ascending:!0});if(a)throw new Error(`Erro ao buscar métodos de pagamento: ${a.message}`);return o},Fo=async s=>{const{data:o,error:a}=await F.from("delivery_zones").select("*").eq("restaurant_id",s).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return o},$o=s=>{switch(s){case"DollarSign":return co;case"Smartphone":return no;case"CreditCard":return lo;case"Package":return io;default:return Xe}},Oo=({subtotal:s,deliveryFee:o,total:a,items:m})=>e.jsxs(se,{className:"sticky top-4",children:[e.jsx(te,{children:e.jsx(ae,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(ne,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(Ze,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(Ze,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]})]})]}),cs=()=>{const s=Io(),o=Ar();Or();const a=Jr(),{items:m,subtotal:n,deliveryFee:c,total:u,setDeliveryFee:p,clearCart:f}=a,[g]=Gr(),[_,V]=d.useState(!1),[C,x]=d.useState(!1),[y,w]=d.useState(null),[D,z]=d.useState(null),[xe,ye]=d.useState(null),[Fe,xr]=d.useState(!1),W=he.useRef(!1),U=he.useRef(!1),X=g.get("status"),je=g.get("external_reference"),$e=g.has("collection_id")||g.has("external_reference"),[le,Oe]=d.useState(!1);d.useEffect(()=>{if(je)if(X==="approved"||X==="failure"||X==="pending"){o(`/order-success/${je}?status=${X}`,{replace:!0});return}else $e&&(toast.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Oe(!1));else Oe(!1)},[je,X,$e,o]);const{data:i,isLoading:yr,isError:jr,error:vr}=me({queryKey:["checkoutRestaurantData"],queryFn:Vo}),{data:T,isLoading:ve}=me({queryKey:["deliveryStatus",i==null?void 0:i.id],queryFn:()=>ko(i.id),enabled:!!(i!=null&&i.id)}),{data:K=[],isLoading:br}=me({queryKey:["checkoutPaymentMethods",i==null?void 0:i.id],queryFn:()=>Lo(i.id),enabled:!!(i!=null&&i.id)}),{data:Te=[],isLoading:Nr}=me({queryKey:["checkoutDeliveryZones",i==null?void 0:i.id],queryFn:()=>Fo(i.id),enabled:!!(i!=null&&i.id)}),_r=yr||ve||br||Nr,Cr=jr,Ae=vr,t=Br({resolver:Ur(So),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),$=t.watch("delivery_option"),be=t.watch("payment_method_id"),Z=K.find(r=>r.id===be),ce=(Z==null?void 0:Z.name)==="Pagamento online: Pix/Cartão",de=(Z==null?void 0:Z.name)==="Dinheiro",E=t.watch("latitude"),R=t.watch("longitude");t.watch(["street","number","neighborhood","city","zip_code"]);const A=$==="delivery",wr=d.useMemo(()=>JSON.stringify({deliveryOption:$,deliveryEnabled:T,lat:E,lng:R}),[$,T,E,R]),Er=d.useMemo(()=>typeof E=="number"&&typeof R=="number"&&!isNaN(E)&&!isNaN(R)?[E,R]:i!=null&&i.latitude&&(i!=null&&i.longitude)?[i.latitude,i.longitude]:[-23.55052,-46.633308],[E,R,i]),Rr=d.useMemo(()=>E===null||R===null?`map-${$}-null`:`map-${$}-${E.toFixed(6)}-${R.toFixed(6)}`,[A,$,E,R]),Ne=d.useCallback(r=>{const l=r.road||r.logradouro||"",h=r.house_number||"",j=r.suburb||r.bairro||"",b=r.city||r.localidade||"",O=r.postcode||r.cep||"";t.setValue("street",l,{shouldValidate:!0}),t.setValue("number",h||"",{shouldValidate:!0}),t.setValue("complement",r.suburb||"",{shouldValidate:!0}),t.setValue("neighborhood",j,{shouldValidate:!0}),t.setValue("city",b,{shouldValidate:!0}),t.setValue("zip_code",O,{shouldValidate:!0})},[t]),Pr=d.useCallback(async(r,l)=>{t.setValue("latitude",r,{shouldValidate:!0}),t.setValue("longitude",l,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${l}&addressdetails=1`,j=await fetch(h);if(j.ok){const b=await j.json();b.address&&(Ne(b.address),toast.info("Endereço preenchido a partir do mapa."))}},[t,Ne]),Sr=d.useCallback(()=>{t.setValue("street","",{shouldValidate:!0}),t.setValue("number","",{shouldValidate:!0}),t.setValue("complement","",{shouldValidate:!0}),t.setValue("neighborhood","",{shouldValidate:!0}),t.setValue("city","",{shouldValidate:!0}),t.setValue("zip_code","",{shouldValidate:!0}),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),p(0),w(null),z(null),toast.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[t,p]),_e=d.useCallback(r=>{try{const l={name:r.name,phone:r.phone,email:r.email,delivery_option:r.delivery_option,street:r.street,number:r.number,complement:r.complement,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code,latitude:r.latitude,longitude:r.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(l))}catch(l){console.error("Failed to save form data to local storage",l)}},[]),Ge=d.useCallback(()=>{try{const r=localStorage.getItem("checkoutFormData");if(r){const l=JSON.parse(r);t.reset({...t.getValues(),...l,delivery_option:l.delivery_option||"delivery"})}}catch(r){console.error("Failed to load form data from local storage",r)}},[t]);d.useEffect(()=>{Ge()},[Ge]),d.useEffect(()=>{const r=t.watch(l=>{_e(l)});return()=>r.unsubscribe()},[t,_e]);const Ir=()=>{W.current||(ye(null),W.current=!0,Promise.resolve().then(async()=>{try{const r=t.getValues(),[l,h,j,b,O]=[r.street,r.number,r.neighborhood,r.city,r.zip_code],ue=gr(O);if(!(l&&h&&j&&b&&ue.length===8)){console.log("LOG: Validau00e7u00e3o de endereu00e7o incompleto falhou."),W.current=!1;return}console.log("LOG: Iniciando geocodificau00e7u00e3o para:",`${l}, ${h}, ${j}, ${b}, ${O}`);const Y=`${l}, ${h}, ${j}, ${b}, ${O}`,B=await Ro(Y);B?(console.log("LOG: Geocodificau00e7u00e3o bem-sucedida. Coordenadas:",B),t.setValue("latitude",B.lat,{shouldValidate:!1}),t.setValue("longitude",B.lng,{shouldValidate:!1}),_e(t.getValues())):(console.log("LOG: Geocodificau00e7u00e3o falhou ou retornou coordenadas invu00e1lidas."),setTimeout(()=>{ye("Endereu00e7o nu00e3o encontrado. Por favor, verifique se estu00e1 correto e tente novamente.")},100))}catch(r){console.error("LOG: Erro capturado durante a geocodificau00e7u00e3o:",r),setTimeout(()=>{ye("Erro ao buscar coordenadas. Verifique sua conexu00e3o ou tente novamente.")},100)}finally{W.current=!1}}).catch(r=>{console.error("LOG: Erro nao capturado:",r),W.current=!1}))};d.useEffect(()=>{de||t.setValue("change_for",null,{shouldValidate:!0})},[de,t]),d.useEffect(()=>{$==="pickup"&&(p(0),w(null),z(null),t.setValue("latitude",null),t.setValue("longitude",null))},[$,A,t,p,E,R]),d.useEffect(()=>{K.length>0&&!be&&t.setValue("payment_method_id",K[0].id)},[K,be,t]),d.useEffect(()=>{ce?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},[ce,t]),d.useEffect(()=>{const r=async()=>{if($==="pickup"||!(i!=null&&i.latitude)||!(i!=null&&i.longitude)){p(0),w(null),z(null);return}if(ve)return;if(T===!1){p(0),w(null),z(null),x(!1);return}x(!0),w(null);let h=null;if(E&&R)h=[E,R];else{p(0),z(null),x(!1);return}if(h){const j=[i.latitude,i.longitude],b=Po(h,j,Te);b?(p(b.fee),w(null),z({minTime:b.minTime,maxTime:b.maxTime})):(p(0),w("Seu endereço está fora da nossa área de entrega."),z(null))}x(!1)},l=setTimeout(()=>{r()},500);return()=>clearTimeout(l)},[wr,i,Te,t,p,A,E,R,T,ve]),d.useEffect(()=>{if(m.length===0&&!_&&!le&&!Fe){const r=setTimeout(()=>{console.log("LOG: Carrinho vazio. Redirecionando para o menu."),o("/menu")},0);return()=>clearTimeout(r)}},[m.length,o,_,le,Fe]);const Me=Tr({mutationFn:async r=>{if(!i)throw new Error("Dados do restaurante indisponíveis.");if(r.delivery_option==="delivery"&&y)throw new Error(y);const l=[r.street,r.number,r.complement?`(${r.complement})`:null,r.neighborhood,r.city,r.zip_code].filter(Boolean).join(", "),h=r.delivery_option==="delivery"?l:"Retirada no Local";let j;const b=fr(r.phone),O=Ie(r.cpf_cnpj||""),{data:ue}=await F.from("customers").select("id").eq("phone",b).limit(1).single();if(ue){j=ue.id;const I={name:r.name};O&&(I.cpf_cnpj=O),await F.from("customers").update(I).eq("id",j)}else{const{data:I,error:G}=await F.from("customers").insert({name:r.name,phone:b,email:r.email||null,address:h,latitude:r.latitude,longitude:r.longitude,cpf_cnpj:O||null}).select("id").single();if(G)throw new Error(`Erro ao criar cliente: ${G.message}`);j=I.id}const we=ce?"pending_payment":"pending",{data:Y,error:B}=await F.from("orders").insert({restaurant_id:i.id,customer_id:j,status:we,total_amount:u,delivery_fee:c,notes:r.notes,delivery_address:h,payment_method_id:r.payment_method_id,change_for:de?r.change_for:null}).select("id").single();if(B)throw new Error(`Erro ao criar pedido: ${B.message}`);const $r=m.map(I=>{const G=Number(I.quantity),M=Number(I.price),ee={order_id:Y.id,product_id:I.product_id,quantity:G,unit_price:M,subtotal:G*M};return I.notes&&I.notes.trim()&&(ee.notes=I.notes.trim()),ee}),{error:De}=await F.from("order_items").insert($r);if(De){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",De);const I=m.map(M=>{const ee=Number(M.quantity),ze=Number(M.price);return{order_id:Y.id,quantity:ee,unit_price:ze,subtotal:ee*ze,notes:M.notes&&M.notes.trim()?M.notes.trim():null}}),{error:G}=await F.from("order_items").insert(I);if(G)throw new Error(`Erro ao adicionar itens do pedido: ${G.message}`)}return{orderId:Y.id,orderStatus:we}},onSuccess:r=>{U.current=!1,xr(!0);const l=r.orderStatus==="pending_payment"?`/payment/${r.orderId}`:`/order-success/${r.orderId}`;console.log("LOG: Redirecionando para:",l),r.orderStatus==="pending_payment"&&V(!0),U.current=!1;const h=`${s}/#${l}`;console.log("LOG: Redirecionando com URL absoluta:",h),window.location.href=h,setTimeout(()=>{f()},500)},onError:r=>{U.current=!1,console.error("LOG: Erro ao processar pedido:",r)}}),Vr=async r=>{if(U.current){console.log("LOG: Pagamento ja em processamento, ignorando nova chamada.");return}U.current=!0,Promise.resolve().then(()=>{Me.mutate(r)}).catch(l=>{console.error("LOG: Erro nao capturado em onSubmit:",l),U.current=!1})},kr=r=>{var h;console.error("Validation errors:",r);const l=Object.keys(r)[0];l&&console.error("LOG: Erro de validação:",((h=r[l])==null?void 0:h.message)||"Preencha todos os campos obrigatórios.")},qe=Me.isPending||_||C,Lr=!A||!y&&c>=0,Ce=!A||E!==null&&R!==null,Fr=!qe&&Lr&&Ce;return m.length===0&&!_&&!le?e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."}):_r||le?e.jsx(Qr,{}):Cr?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(H,{variant:"destructive",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro de Conexão"}),e.jsx(Q,{children:Ae instanceof Error?Ae.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Be,{to:"/menu",children:e.jsx(re,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(ao,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(oo,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(Vr,kr),className:"space-y-6",children:[e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(ne,{className:"space-y-4",children:[e.jsx(P,{control:t.control,name:"name",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Nome Completo *"}),e.jsx(L,{placeholder:"Seu nome",...r}),e.jsx(S,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(P,{control:t.control,name:"phone",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Telefone *"}),e.jsx(pr,{...r}),e.jsx(S,{})]})}),e.jsx(P,{control:t.control,name:"email",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Email (Opcional)"}),e.jsx(L,{placeholder:"seu@email.com",...r}),e.jsx(S,{})]})})]})]})]}),e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(ne,{className:"space-y-4",children:[e.jsx(P,{control:t.control,name:"delivery_option",render:({field:r})=>e.jsxs(v,{className:"space-y-3",children:[e.jsx(oe,{children:e.jsxs(Se,{onValueChange:r.onChange,defaultValue:r.value,className:"flex flex-col space-y-1",children:[e.jsxs(v,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(oe,{children:e.jsx(pe,{value:"delivery"})}),e.jsx(He,{className:"h-5 w-5 text-primary"}),e.jsxs(N,{className:ie("font-normal flex-1 cursor-pointer"),children:["Delivery",T===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(v,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(oe,{children:e.jsx(pe,{value:"pickup"})}),e.jsx(Xe,{className:"h-5 w-5 text-primary"}),e.jsx(N,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(S,{})]})}),A&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Je,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(re,{type:"button",variant:"outline",size:"sm",onClick:r=>{r.preventDefault(),Ir()},disabled:C,children:[e.jsx(po,{className:"h-4 w-4 mr-2"})," ",C?"Buscando...":"Salvar Endereço"]}),e.jsxs(re,{type:"button",variant:"outline",size:"sm",onClick:Sr,children:[e.jsx(mo,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(P,{control:t.control,name:"street",render:({field:r})=>e.jsxs(v,{className:"col-span-2",children:[e.jsx(N,{children:"Rua *"}),e.jsx(L,{...r}),e.jsx(S,{})]})}),e.jsx(P,{control:t.control,name:"number",render:({field:r})=>e.jsxs(v,{className:"col-span-1",children:[e.jsx(N,{children:"Número *"}),e.jsx(L,{...r}),e.jsx(S,{})]})})]}),e.jsx(P,{control:t.control,name:"complement",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Complemento (Opcional)"}),e.jsx(L,{placeholder:"Apto, Bloco, Casa, etc.",...r,disabled:!1}),e.jsx(S,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(P,{control:t.control,name:"neighborhood",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Bairro *"}),e.jsx(L,{...r}),e.jsx(S,{})]})}),e.jsx(P,{control:t.control,name:"city",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Cidade *"}),e.jsx(L,{...r}),e.jsx(S,{})]})})]}),e.jsx(P,{control:t.control,name:"zip_code",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"CEP *"}),e.jsx(so,{...r}),e.jsx(S,{})]})}),A&&Ce&&e.jsx("div",{children:e.jsx(to,{mapKey:Rr,markerPosition:Er,onLocationChange:Pr,updateAddressFields:Ne,restaurant:i})}),C&&T!==!1&&e.jsxs(H,{children:[e.jsx(Ke,{className:"h-4 w-4 animate-spin"}),e.jsx(J,{children:"Calculando Taxa..."}),e.jsx(Q,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),y&&T!==!1&&e.jsxs(H,{variant:"destructive",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro de Entrega"}),e.jsx(Q,{children:y})]}),c>0&&!C&&T!==!1&&e.jsxs(H,{className:"mt-4",children:[e.jsx(He,{className:"h-4 w-4"}),e.jsx(J,{children:"Taxa de Entrega Aplicada"}),e.jsxs(Q,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)]})]}),xe&&e.jsxs(H,{variant:"destructive",className:"mt-4",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro ao Buscar Endereu00e7o"}),e.jsx(Q,{children:xe})]}),A&&!Ce&&!xe&&e.jsxs(H,{variant:"destructive",children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx(J,{children:"Localização Obrigatória"}),e.jsx(Q,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(ne,{className:"space-y-4",children:[e.jsx(P,{control:t.control,name:"payment_method_id",render:({field:r})=>e.jsxs(v,{className:"space-y-3",children:[e.jsx(oe,{children:e.jsx(Se,{onValueChange:l=>{r.onChange(l);const h=K.find(j=>j.id===l);(h==null?void 0:h.name)!=="Dinheiro"&&t.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},defaultValue:r.value,className:"flex flex-col space-y-2",children:K.map(l=>{const h=$o(l.icon||"Store");return e.jsxs(v,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(oe,{children:e.jsx(pe,{value:l.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(N,{className:"font-normal cursor-pointer",children:l.name}),l.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description})]})]},l.id)})})}),e.jsx(S,{})]})}),de&&e.jsx(P,{control:t.control,name:"change_for",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Troco para (Opcional)"}),e.jsx(L,{type:"number",placeholder:"Ex: 50.00",...r,value:r.value||"",onChange:l=>r.onChange(l.target.value?parseFloat(l.target.value):null)}),e.jsx(S,{})]})}),ce&&e.jsx(P,{control:t.control,name:"cpf_cnpj",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"CPF/CNPJ *"}),e.jsx(hr,{...r}),e.jsx(S,{})]})})]})]}),e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{className:"text-xl",children:"4. Observações"})}),e.jsx(ne,{children:e.jsx(P,{control:t.control,name:"notes",render:({field:r})=>e.jsxs(v,{children:[e.jsx(N,{children:"Observações do Pedido (Opcional)"}),e.jsx(ro,{placeholder:"Ex: Sem cebola, sem alface...",...r}),e.jsx(S,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Be,{to:"/menu",className:"flex-1",children:e.jsx(re,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(re,{type:"submit",className:"flex-1",disabled:!Fr,size:"lg",children:qe?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(Oo,{subtotal:n,deliveryFee:c,total:u,items:m})})]})]})]})};export{cs as default};
