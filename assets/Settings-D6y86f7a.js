const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./MapComponent-Djgerl36.js","./tanstack-B7K8dk_R.js","./vendor-C31pEpEI.js","./index-Dk6ctkd8.js","./supabase-CdSQIpsr.js","./index-B5UZKk8H.css"])))=>i.map(i=>d[i]);
import{j as e,b as de,u as ue,c as O}from"./tanstack-B7K8dk_R.js";import{o as me,s as j,l as Q,b as he,p as G,c as Z,u as pe,t as xe}from"./types-D_gJSKSC.js";import{s as M}from"./client-Bx906Zta.js";import{B as k}from"./button-Dlo7ULga.js";import{C as q,b as D,c as T,a as I}from"./card-BDStEJfw.js";import{I as x}from"./input-CxIG7_mC.js";import{L as H}from"./label-C88BZ7Az.js";import{T as je}from"./textarea-CQTU_-eK.js";import{S as ge}from"./switch-BXfPAzos.js";import{c as J,b as fe,u as t,L as W}from"./index-Dk6ctkd8.js";import{F as be,a as i,b as c,c as d,d as u,e as h}from"./form-CfHOmuGt.js";import{S as ve}from"./skeleton-Cif5uAhG.js";import{r as n,i as ye}from"./vendor-C31pEpEI.js";import{Z as X}from"./ZipCodeInput-DOtxRjGU.js";import{u as we}from"./use-sound-CHM3vRxZ.js";import{_ as Ne}from"./supabase-CdSQIpsr.js";import{M as Ce}from"./map-pin-hjBeTR7K.js";import{R as Se}from"./refresh-cw-Cc5jdsYC.js";import{C as Ee}from"./circle-check-big-DY12njxu.js";import{V as _e}from"./volume-2-D1Z5iKHl.js";import{C as Ve}from"./circle-x-BMwYR71L.js";import{U as Le}from"./upload-BOFNupSX.js";import"./index-D4ekbOML.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=J("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=J("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),ze=n.lazy(()=>Ne(()=>import("./MapComponent-Djgerl36.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),Fe=m=>e.jsx(n.Suspense,{fallback:e.jsx(fe,{}),children:e.jsx(ze,{...m})}),Re=({mapKey:m,markerPosition:g,onLocationChange:r,updateAddressFields:f,restaurant:b})=>{const[E,_]=n.useState(!1),C=n.useCallback(async()=>{_(!0);const F=t.loading("Buscando endereço a partir do mapa..."),[R,$]=g;try{const S=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${R}&lon=${$}&zoom=18&addressdetails=1`,a=await fetch(S);if(!a.ok)throw new Error("Falha na geocodificação reversa.");const v=await a.json();v.address?(f(v.address),t.success("Endereço atualizado com base na localização do mapa!")):t.warning("Não foi possível encontrar um endereço detalhado para esta localização.")}catch(S){t.error(`Erro na busca reversa: ${S.message}`)}finally{_(!1),t.dismiss(F)}},[g,f]),z=n.useMemo(()=>[b.street,b.number,b.neighborhood,b.city,b.zip_code].filter(Boolean).join(", "),[b]);return e.jsxs(q,{className:"mt-6",children:[e.jsx(D,{children:e.jsxs(T,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(I,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(Fe,{center:g,markerPosition:g,onMarkerDragEnd:r,zoom:15},m)}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[70%] truncate",children:["Endereço atual: ",z||"N/A"]}),e.jsxs(k,{type:"button",variant:"outline",onClick:C,disabled:E,children:[E?e.jsx(W,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Atualizar Endereço"]})]})]})]})},$e=n.memo(Re),Ue=me({name:j().min(1,"O nome do restaurante é obrigatório."),description:j().optional(),logo_url:j().url("URL do logo inválida.").optional().or(Q("")),street:j().optional(),number:j().optional(),neighborhood:j().optional(),city:j().optional(),zip_code:j().optional(),phone:j().optional(),email:j().email("Email inválido.").optional().or(Q("")),is_active:he().default(!0),latitude:G(m=>String(m).replace(",","."),Z.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:G(m=>String(m).replace(",","."),Z.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),Pe=async m=>{const{data:g,error:r}=await M.from("restaurants").select("*").eq("id",m).single();if(r)throw new Error(`Erro ao buscar dados do restaurante: ${r.message}`);if(!g)throw new Error("Nenhum restaurante encontrado.");return g},io=()=>{const m=de(),{playSound:g}=we(),{userRestaurantId:r}=ye(),[f,b]=n.useState(null),[E,_]=n.useState(""),[C,z]=n.useState(""),[F,R]=n.useState(!1),[$,S]=n.useState(!1),{data:a,isLoading:v,isError:A,error:Y}=ue({queryKey:["restaurantSettings",r],queryFn:()=>Pe(r),enabled:!!r,staleTime:1e3*60*5}),s=pe({resolver:xe(Ue),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});n.useEffect(()=>{a&&(s.reset({name:a.name||"",description:a.description||"",logo_url:a.logo_url||"",street:a.street||"",number:a.number||"",neighborhood:a.neighborhood||"",city:a.city||"",zip_code:a.zip_code||"",phone:a.phone||"",email:a.email||"",is_active:a.is_active??!0,latitude:a.latitude??null,longitude:a.longitude??null}),a.latitude&&a.longitude&&S(!0))},[a,s.reset]);const y=s.watch("latitude"),w=s.watch("longitude"),ee=[-23.55052,-46.633308],oe=n.useMemo(()=>typeof y=="number"&&typeof w=="number"&&!isNaN(y)&&!isNaN(w)?[y,w]:ee,[y,w]),se=n.useCallback(o=>{s.setValue("street",o.road||o.logradouro||"",{shouldValidate:!0}),s.setValue("number",o.house_number||"",{shouldValidate:!0}),s.setValue("neighborhood",o.suburb||o.bairro||"",{shouldValidate:!0}),s.setValue("city",o.city||o.localidade||"",{shouldValidate:!0}),s.setValue("zip_code",o.postcode||o.cep||"",{shouldValidate:!0}),_((o.postcode||o.cep||"").replace(/\D/g,"")),z(o.house_number||"")},[s]),ae=async()=>{const o=s.getValues();o.street,o.number,o.neighborhood,o.city,o.zip_code;const l=E.replace(/\D/g,"");if(l.length!==8||!C){t.warning("Por favor, digite um CEP válido e o número da casa.");return}R(!0);const V=t.loading("Buscando endereço e coordenadas...");try{const N=await fetch(`https://viacep.com.br/ws/${l}/json/`);if(!N.ok)throw new Error("Falha na busca do CEP.");const p=await N.json();if(p.erro){t.error("CEP não encontrado.");return}s.setValue("street",p.logradouro,{shouldValidate:!0}),s.setValue("number",C,{shouldValidate:!0}),s.setValue("neighborhood",p.bairro,{shouldValidate:!0}),s.setValue("city",p.localidade,{shouldValidate:!0}),s.setValue("zip_code",p.cep,{shouldValidate:!0});const L=`${p.logradouro}, ${C}, ${p.localidade}, ${p.uf}`,le=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(L)}`,K=await(await fetch(le)).json();if(K.length>0){const{lat:ie,lon:ce}=K[0];s.setValue("latitude",parseFloat(ie),{shouldValidate:!0}),s.setValue("longitude",parseFloat(ce),{shouldValidate:!0}),S(!0),t.success("Endereço e mapa atualizados com sucesso!")}else t.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(N){t.dismiss(V),t.error(`Erro na busca: ${N.message}`)}finally{R(!1),t.dismiss(V)}},re=n.useCallback((o,l)=>{s.setValue("latitude",o,{shouldValidate:!0}),s.setValue("longitude",l,{shouldValidate:!0})},[s]),U=O({mutationFn:async o=>{if(!r)throw new Error("ID do restaurante não disponível.");const{error:l}=await M.from("restaurants").update(o).eq("id",r);if(l)throw l},onSuccess:()=>{t.success("Configurações salvas com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings",r]})},onError:o=>t.error(`Erro ao salvar configurações: ${o.message}`)}),P=O({mutationFn:async o=>{if(!r)throw new Error("ID do restaurante não disponível.");if(o.type!=="audio/mpeg"&&o.type!=="audio/mp3")throw new Error("O arquivo deve ser do tipo MP3.");const l=`${r}/notification.mp3`;console.log(`[Sound Upload] Attempting upload to settings/${l}`);const{error:V}=await M.storage.from("settings").upload(l,o,{upsert:!0,contentType:"audio/mpeg"});if(V)throw V;const{data:N}=M.storage.from("settings").getPublicUrl(l);if(!N.publicUrl)throw new Error("Falha ao obter a URL pública do arquivo.");const p=`${N.publicUrl}?t=${new Date().getTime()}`;console.log(`[DB Update] Updating restaurant ID: ${r} with URL: ${p}`);const{error:L}=await M.from("restaurants").update({notification_sound_url:p}).eq("id",r);if(L)throw console.error("[DB Update Error] Supabase Error:",L),new Error(`Falha ao salvar URL no banco de dados: ${L.message}`)},onSuccess:()=>{t.success("Som de notificação atualizado com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings",r]}),b(null)},onError:o=>{console.error("Erro detalhado no upload do som:",o),t.error(`Erro ao salvar som: ${o.message}`)}}),te=()=>{f&&P.mutate(f)},B=!!(a!=null&&a.notification_sound_url),ne=n.useMemo(()=>y===null||w===null?"map-settings-null":`map-settings-${y.toFixed(6)}-${w.toFixed(6)}`,[y,w]);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(q,{children:[e.jsx(D,{children:e.jsx(T,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(I,{children:[v&&e.jsx(ve,{className:"h-96 w-full"}),A&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",Y.message]}),!r&&!v&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),a&&!A&&!v&&e.jsx(be,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(o=>U.mutate(o)),className:"space-y-6",children:[e.jsx(i,{control:s.control,name:"name",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Nome do Restaurante *"}),e.jsx(u,{children:e.jsx(x,{...o})}),e.jsx(h,{})]})}),e.jsx(i,{control:s.control,name:"description",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Descrição"}),e.jsx(u,{children:e.jsx(je,{...o,rows:3})}),e.jsx(h,{})]})}),e.jsx(i,{control:s.control,name:"logo_url",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"URL do Logo"}),e.jsx(u,{children:e.jsx(x,{...o})}),e.jsx(h,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(X,{placeholder:"Digite o CEP",value:E,onChange:o=>_(o.target.value)}),e.jsx(x,{placeholder:"Número",value:C,onChange:o=>z(o.target.value)}),e.jsx(k,{type:"button",onClick:ae,disabled:F,children:F?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(ke,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(i,{control:s.control,name:"street",render:({field:o})=>e.jsxs(c,{className:"md:col-span-2",children:[e.jsx(d,{children:"Rua"}),e.jsx(u,{children:e.jsx(x,{...o,disabled:!0})}),e.jsx(h,{})]})}),e.jsx(i,{control:s.control,name:"number",render:({field:o})=>e.jsxs(c,{className:"md:col-span-1",children:[e.jsx(d,{children:"Número"}),e.jsx(u,{children:e.jsx(x,{...o,disabled:!0})}),e.jsx(h,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:s.control,name:"neighborhood",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Bairro"}),e.jsx(u,{children:e.jsx(x,{...o,disabled:!0})}),e.jsx(h,{})]})}),e.jsx(i,{control:s.control,name:"city",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Cidade"}),e.jsx(u,{children:e.jsx(x,{...o,disabled:!0})}),e.jsx(h,{})]})})]}),e.jsx(i,{control:s.control,name:"zip_code",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"CEP"}),e.jsx(u,{children:e.jsx(X,{...o,disabled:!0})}),e.jsx(h,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:$&&e.jsx($e,{mapKey:ne,markerPosition:oe,onLocationChange:re,updateAddressFields:se,restaurant:a})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:s.control,name:"latitude",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Latitude"}),e.jsx(u,{children:e.jsx(x,{...o,placeholder:"-22.7627908",value:o.value??""})}),e.jsx(h,{})]})}),e.jsx(i,{control:s.control,name:"longitude",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Longitude"}),e.jsx(u,{children:e.jsx(x,{...o,placeholder:"-47.408315",value:o.value??""})}),e.jsx(h,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{control:s.control,name:"phone",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Telefone"}),e.jsx(u,{children:e.jsx(x,{...o})}),e.jsx(h,{})]})}),e.jsx(i,{control:s.control,name:"email",render:({field:o})=>e.jsxs(c,{children:[e.jsx(d,{children:"Email"}),e.jsx(u,{children:e.jsx(x,{...o})}),e.jsx(h,{})]})})]}),e.jsx(i,{control:s.control,name:"is_active",render:({field:o})=>e.jsxs(c,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(d,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(u,{children:e.jsx(ge,{checked:o.value,onCheckedChange:o.onChange})})]})}),e.jsx(k,{type:"submit",className:"w-full h-12 text-lg",disabled:U.isPending||!r,children:U.isPending?"Salvando...":"Salvar Configurações"})]})})]})]}),e.jsxs(q,{children:[e.jsxs(D,{children:[e.jsxs(T,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Me,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(I,{className:"space-y-4",children:[B&&e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-green-50/50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ee,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Som Salvo: notification.mp3"})]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:g,children:[e.jsx(_e,{className:"h-4 w-4 mr-2"})," Testar"]})]}),!B&&!v&&e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-yellow-50/50 dark:bg-yellow-900/20",children:[e.jsx(Ve,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Nenhum som de notificação configurado."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(Le,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(f==null?void 0:f.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:o=>{var l;return b(((l=o.target.files)==null?void 0:l[0])||null)}})]})]}),e.jsx(k,{onClick:te,className:"w-full h-12 text-lg",disabled:!f||P.isPending||!r,children:P.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{io as default};
