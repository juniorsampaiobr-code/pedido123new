import{b as fe,j as e,u as rt,c as De}from"./tanstack-d4AvmB45.js";import{r as d,u as tt,h as nt,j as st,L as ke}from"./vendor-CnEXr6gt.js";import{s as P}from"./client-D5i5GwB9.js";import{c as ot,d as xr,e as Ve,P as Ce,f as Oe,g as at,h as it,i as ct,a as he,u as S,L as pe,p as dt,b as or}from"./index-Pm3iw6_f.js";import{L as lt,g as ar,c as $e,Z as ut}from"./location-Fq7EVbks.js";import{u as mt}from"./use-auth-status-b07NBuTX.js";import{o as gr,s as L,e as ft,u as ir,C as me,t as cr}from"./types-DKlirIXB.js";import{B as Q}from"./button-CWqV81hu.js";import{C as X,b as H,c as J,a as W}from"./card-DiGUcvFK.js";import{L as k,I as se}from"./label-Ba4Ktnmq.js";import{T as pt}from"./textarea-CQ4SwagS.js";import{c as yr,R as ht,I as xt}from"./index-qaonqlS7.js";import{u as gt}from"./index-DrlxvCXN.js";import{u as yt}from"./index-KNP7Yozt.js";import{S as dr}from"./separator-Ckumvy7Z.js";import{A as ee,a as oe,b as ae}from"./alert-jX6TGt9r.js";import{P as jt,M as vt}from"./PhoneInput-D6_LabEr.js";import{C as wt,L as bt}from"./CustomerProfileModal-DcKQysrF.js";import{D as lr,a as ur,b as _t,c as Nt,d as Ct}from"./dialog-BTd50cG8.js";import{C as jr}from"./credit-card-usS6h3yX.js";import{C as Et}from"./CpfCnpjInput-MACw2Wjb.js";import{M as Te}from"./map-pin-AMW1S87K.js";import{A as St,a as Pt,b as Rt,c as It,d as At,e as Ft,g as Mt}from"./alert-dialog-DbnB15em.js";import{C as _e}from"./circle-alert-CZUeTWow.js";import{F as mr,b as Dt,d as kt}from"./form-BO4yNMuO.js";import{T as fr}from"./terminal-DgdRDunJ.js";import{R as $t}from"./pt-BR-DDjzJeRX.js";import{A as Ot}from"./arrow-left-BMhUd1F0.js";import{U as pr}from"./user-DmdMpx6p.js";import{T as we}from"./truck-DJYV22RZ.js";import{C as Tt}from"./circle-check-big-DFQususb.js";import{S as Lt}from"./save-CDNOdiRe.js";import{D as Vt}from"./dollar-sign-ecRfomiY.js";import"./supabase-BZV_3FV3.js";import"./skeleton-DqQYM1Rs.js";import"./package-CjgKwon-.js";import"./check-ClJ5r1Pv.js";import"./circle-x-DHNA-0_w.js";import"./euro-C1028z6Z.js";import"./format-BeKxgCCE.js";import"./index-DWWauXze.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=ot("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),qt=async t=>{const{data:s,error:n}=await P.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",t).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${n.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},vr=t=>fe({queryKey:["mercadoPagoPublicKey",t],queryFn:()=>qt(t),enabled:!!t,staleTime:1/0});var ze="Radio",[Gt,wr]=xr(ze),[Bt,Kt]=Gt(ze),br=d.forwardRef((t,s)=>{const{__scopeRadio:n,name:u,checked:p=!1,required:g,disabled:b,value:c="on",onCheck:R,form:I,...C}=t,[y,M]=d.useState(null),E=Ve(s,G=>M(G)),A=d.useRef(!1),$=y?I||!!y.closest("form"):!0;return e.jsxs(Bt,{scope:n,checked:p,disabled:b,children:[e.jsx(Ce.button,{type:"button",role:"radio","aria-checked":p,"data-state":Er(p),"data-disabled":b?"":void 0,disabled:b,value:c,...C,ref:E,onClick:Oe(t.onClick,G=>{p||R==null||R(),$&&(A.current=G.isPropagationStopped(),A.current||G.stopPropagation())})}),$&&e.jsx(Cr,{control:y,bubbles:!A.current,name:u,value:c,checked:p,required:g,disabled:b,form:I,style:{transform:"translateX(-100%)"}})]})});br.displayName=ze;var _r="RadioIndicator",Nr=d.forwardRef((t,s)=>{const{__scopeRadio:n,forceMount:u,...p}=t,g=Kt(_r,n);return e.jsx(at,{present:u||g.checked,children:e.jsx(Ce.span,{"data-state":Er(g.checked),"data-disabled":g.disabled?"":void 0,...p,ref:s})})});Nr.displayName=_r;var Ut="RadioBubbleInput",Cr=d.forwardRef(({__scopeRadio:t,control:s,checked:n,bubbles:u=!0,...p},g)=>{const b=d.useRef(null),c=Ve(b,g),R=yt(n),I=it(s);return d.useEffect(()=>{const C=b.current;if(!C)return;const y=window.HTMLInputElement.prototype,E=Object.getOwnPropertyDescriptor(y,"checked").set;if(R!==n&&E){const A=new Event("click",{bubbles:u});E.call(C,n),C.dispatchEvent(A)}},[R,n,u]),e.jsx(Ce.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...p,tabIndex:-1,ref:c,style:{...p.style,...I,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Cr.displayName=Ut;function Er(t){return t?"checked":"unchecked"}var Zt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Ee="RadioGroup",[Qt,is]=xr(Ee,[yr,wr]),Sr=yr(),Pr=wr(),[Xt,Ht]=Qt(Ee),Rr=d.forwardRef((t,s)=>{const{__scopeRadioGroup:n,name:u,defaultValue:p,value:g,required:b=!1,disabled:c=!1,orientation:R,dir:I,loop:C=!0,onValueChange:y,...M}=t,E=Sr(n),A=gt(I),[$,G]=ct({prop:g,defaultProp:p??null,onChange:y,caller:Ee});return e.jsx(Xt,{scope:n,name:u,required:b,disabled:c,value:$,onValueChange:G,children:e.jsx(ht,{asChild:!0,...E,orientation:R,dir:A,loop:C,children:e.jsx(Ce.div,{role:"radiogroup","aria-required":b,"aria-orientation":R,"data-disabled":c?"":void 0,dir:A,...M,ref:s})})})});Rr.displayName=Ee;var Ir="RadioGroupItem",Ar=d.forwardRef((t,s)=>{const{__scopeRadioGroup:n,disabled:u,...p}=t,g=Ht(Ir,n),b=g.disabled||u,c=Sr(n),R=Pr(n),I=d.useRef(null),C=Ve(s,I),y=g.value===p.value,M=d.useRef(!1);return d.useEffect(()=>{const E=$=>{Zt.includes($.key)&&(M.current=!0)},A=()=>M.current=!1;return document.addEventListener("keydown",E),document.addEventListener("keyup",A),()=>{document.removeEventListener("keydown",E),document.removeEventListener("keyup",A)}},[]),e.jsx(xt,{asChild:!0,...c,focusable:!b,active:y,children:e.jsx(br,{disabled:b,required:g.required,checked:y,...R,...p,name:g.name,ref:C,onCheck:()=>g.onValueChange(p.value),onKeyDown:Oe(E=>{E.key==="Enter"&&E.preventDefault()}),onFocus:Oe(p.onFocus,()=>{var E;M.current&&((E=I.current)==null||E.click())})})})});Ar.displayName=Ir;var Jt="RadioGroupIndicator",Fr=d.forwardRef((t,s)=>{const{__scopeRadioGroup:n,...u}=t,p=Pr(n);return e.jsx(Nr,{...p,...u,ref:s})});Fr.displayName=Jt;var Mr=Rr,Dr=Ar,Wt=Fr;const Le=d.forwardRef(({className:t,...s},n)=>e.jsx(Mr,{className:he("grid gap-2",t),...s,ref:n}));Le.displayName=Mr.displayName;const Ne=d.forwardRef(({className:t,...s},n)=>e.jsx(Dr,{ref:n,className:he("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(Wt,{className:"flex items-center justify-center",children:e.jsx(zt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Ne.displayName=Dr.displayName;var qe={};Object.defineProperty(qe,"__esModule",{value:!0});var kr=qe.loadMercadoPago=void 0;const $r="https://sdk.mercadopago.com/js/v2",Yt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,hr="MercadoPago has already been initialized in your window, please remove the duplicate import",en="MercadoPago.js not available",rn="Failed to load MercadoPago.js",tn=()=>{for(var t=document.querySelectorAll(`script[src^="${$r}"`),s=0;s<t.length;s++){var n=t[s];if(Yt.test(n.src))return n}return null},nn=()=>{const t=document.createElement("script");t.src=$r;const s=document.head||document.body;if(!s)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return s.appendChild(t),t};let be=null;const sn=()=>(be!==null||(be=new Promise((t,s)=>{if(typeof window>"u"){t(null);return}if(window.MercadoPago){console.warn(hr),t(window.MercadoPago);return}try{let n=tn();n?console.warn(hr):n||(n=nn()),n.addEventListener("load",()=>{window.MercadoPago?t(window.MercadoPago):s(new Error(en))}),n.addEventListener("error",()=>{s(new Error(rn))})}catch(n){s(n);return}})),be);kr=qe.loadMercadoPago=sn;var on=function(t,s,n,u){function p(g){return g instanceof n?g:new n(function(b){b(g)})}return new(n||(n=Promise))(function(g,b){function c(C){try{I(u.next(C))}catch(y){b(y)}}function R(C){try{I(u.throw(C))}catch(y){b(y)}}function I(C){C.done?g(C.value):p(C.value).then(c,R)}I((u=u.apply(t,s||[])).next())})};class K{static getInstance(){return on(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield kr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}K.publicKey=null;K.options={};K.instanceMercadoPago=void 0;K.loadedInstanceMercadoPago=!1;function an(t,s){return Object.keys(t).length===Object.keys(s).length&&Object.keys(t).every(u=>Object.prototype.hasOwnProperty.call(s,u)&&t[u]===s[u])}const cn=(t,s)=>{const n=Object.assign(Object.assign({},s),{frontEndStack:"react"}),u=!an(K.options,n);(t!==K.publicKey||u)&&(K.publicKey=t,K.options=n,K.instanceMercadoPago=void 0)},dn=({preferenceId:t,initPoint:s,onClose:n})=>{const{data:u,isLoading:p}=vr();return d.useEffect(()=>{if(u)try{cn(u,{locale:"pt-BR"})}catch(g){console.error("Erro ao inicializar Mercado Pago:",g),S.error("Erro ao carregar o SDK do Mercado Pago."),n();return}s&&(console.log("Redirecionando para o Mercado Pago:",s),window.location.href=s)},[u,n,s]),p||!u?e.jsx(lr,{open:!0,onOpenChange:n,children:e.jsx(ur,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(pe,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(lr,{open:!0,onOpenChange:n,children:e.jsxs(ur,{className:"sm:max-w-[425px]",children:[e.jsxs(_t,{children:[e.jsxs(Nt,{className:"flex items-center gap-2",children:[e.jsx(jr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Ct,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(pe,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Q,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},ln=({latitude:t,longitude:s,address:n,className:u})=>{const p=d.useMemo(()=>[t,s],[t,s]),g=d.useMemo(()=>[t,s],[t,s]);return e.jsxs(X,{className:he("w-full",u),children:[e.jsxs(H,{children:[e.jsxs(J,{className:"text-lg flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(W,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(lt,{center:g,markerPosition:p,onMarkerDragEnd:()=>{},zoom:16})})})]})},un=({isOpen:t,onConfirm:s})=>e.jsx(St,{open:t,children:e.jsxs(Pt,{children:[e.jsxs(Rt,{children:[e.jsxs(It,{className:"flex items-center gap-2 text-primary",children:[e.jsx(_e,{className:"h-6 w-6"}),"Atenção ao Pagamento Online!"]}),e.jsxs(At,{children:["Você escolheu o pagamento online (Pix ou Cartão).",e.jsx("br",{}),e.jsx("br",{}),"Ao prosseguir, você será redirecionado para o checkout do Mercado Pago.",e.jsx("br",{}),e.jsx("br",{}),'**IMPORTANTE:** Se você escolher **PIX**, após o pagamento, você pode precisar clicar no botão **"Voltar ao site"** na tela do Mercado Pago para que seu pedido seja finalizado e rastreado corretamente.']})]}),e.jsx(Ft,{children:e.jsx(Mt,{onClick:s,className:"w-full",children:"Entendi e Continuar"})})]})}),mn=gr({zip_code:L().min(1,"CEP é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===8,{message:"CEP deve ter 8 dígitos."}),street:L().min(1,"Rua é obrigatória."),number:L().min(1,"Número é obrigatório."),neighborhood:L().min(1,"Bairro é obrigatório."),city:L().min(1,"Cidade é obrigatória.")}),fn=gr({name:L().min(1,"Nome é obrigatório."),phone:L().min(1,"Telefone é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:L().min(1,"CPF/CNPJ é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:ft(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:L().optional(),payment_method_id:L().min(1,"Selecione um método de pagamento."),change_for:L().optional()}),pn=async t=>{const{data:s,error:n}=await P.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",t).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!s)throw new Error("Restaurante não encontrado ou inativo.");return s},hn=async t=>{const{data:s,error:n}=await P.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return s},xn=async t=>{const{data:s,error:n}=await P.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return s},gn=async t=>{const{data:s,error:n}=await P.from("customers").select("*").eq("user_id",t).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return s||null},cs=()=>{var Ye,er,rr,tr,nr;const t=tt(),s=nt(),[n]=st(),u=rt(),{items:p,totalAmount:g,clearCart:b}=dt(),{data:c,isLoading:R}=mt(),[I]=d.useState((Ye=s.state)==null?void 0:Ye.restaurantId),C=n.get("restaurantId"),y=I||C,{data:M}=vr(y),[E,A]=d.useState(!1),[$,G]=d.useState(!1),[xe,ie]=d.useState(0),[ce,ge]=d.useState(null),[Se,re]=d.useState(!0),[Y,de]=d.useState(null),[Or,Pe]=d.useState(!1),[Tr,Lr]=d.useState(null),[Ge,Vr]=d.useState(null),[U,te]=d.useState(!1),[zr,Be]=d.useState(!1),[Ke,Re]=d.useState(null),[Ie,Ae]=d.useState(null),{data:x,isLoading:qr,isError:Gr,error:Ue,refetch:Br}=fe({queryKey:["checkoutRestaurantData",y],queryFn:()=>pn(y),enabled:!!y,staleTime:1/0}),{data:V,isLoading:Kr}=fe({queryKey:["checkoutDeliveryZones",y],queryFn:()=>hn(x.id),enabled:!!x,staleTime:1/0}),{data:B,isLoading:Ur}=fe({queryKey:["checkoutPaymentMethods",y],queryFn:()=>xn(x.id),enabled:!!x,staleTime:1/0}),{data:f,isLoading:Ze,refetch:yn}=fe({queryKey:["checkoutCustomerData",c==null?void 0:c.id],queryFn:()=>gn(c.id),enabled:!!c,staleTime:0}),Z=d.useMemo(()=>x!=null&&x.latitude&&(x!=null&&x.longitude)?[x.latitude,x.longitude]:null,[x]),Zr=d.useCallback(async(r,o,a,l,m,h,v)=>{const D=[30,45];if(x&&x.delivery_enabled===!1){const N=`${o}, ${a}, ${m}, ${l}, ${r}`;let w=null;if(h&&v?w={lat:h,lng:v}:w=await ar(N),!w)return{coords:null,fee:0,time:null,isValid:!1};if(V&&V.length>0&&Z){const q=$e([w.lat,w.lng],Z,V);if(q)return{coords:w,fee:0,time:[q.minTime,q.maxTime],isValid:!0}}return{coords:w,fee:0,time:D,isValid:!0}}if(!x||!Z)return{coords:null,fee:0,time:D,isValid:!0};const T=`${o}, ${a}, ${m}, ${l}, ${r}`;let _=null;if(h&&v?_={lat:h,lng:v}:_=await ar(T),!_)return{coords:null,fee:0,time:null,isValid:!1};if(V&&V.length>0){const N=$e([_.lat,_.lng],Z,V);return N?{coords:_,fee:N.fee,time:[N.minTime,N.maxTime],isValid:!0}:{coords:_,fee:0,time:null,isValid:!1}}else return{coords:null,fee:0,time:D,isValid:!0}},[x,Z,V]),i=ir({resolver:cr(fn),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),j=ir({resolver:cr(mn),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),O=i.watch("delivery_option"),Qr=i.watch("payment_method_id"),ne=B==null?void 0:B.find(r=>r.id===Qr),Fe=(er=ne==null?void 0:ne.name)==null?void 0:er.includes("online"),le=(rr=ne==null?void 0:ne.name)==null?void 0:rr.includes("Dinheiro"),z=g+xe,F=j.watch(["zip_code","street","number","city","neighborhood"]),Qe=d.useMemo(()=>{const[r,o,a,l,m]=F;return`${o}|${a}|${m}|${l}|${r}`},[F]);d.useEffect(()=>{if(te(!1),de(null),ie(0),ge(null),re(!0),Ae(null),j.reset({zip_code:"",street:"",number:"",neighborhood:"",city:""}),f){if(i.reset({...i.getValues(),name:f.name||"",phone:f.phone||"",cpf_cnpj:f.cpf_cnpj||"",change_for:""}),f.latitude&&f.longitude&&f.street&&f.number&&f.zip_code){const r=f.zip_code||"",o=f.street||"",a=f.number||"",l=f.neighborhood||"",m=f.city||"";j.reset({zip_code:r,street:o,number:a,neighborhood:l,city:m});const h=`${o}|${a}|${l}|${m}|${r}`;if(Ae(h),Z&&V){const v=$e([f.latitude,f.longitude],Z,V);v?(ie(v.fee),ge([v.minTime,v.maxTime]),re(!0),te(!0),de([f.latitude,f.longitude])):(ie(0),re(!1),te(!0),de([f.latitude,f.longitude]))}}}else if(c&&!Ze){const r=c.user_metadata;i.reset({...i.getValues(),name:r.full_name||"",phone:r.phone||"",cpf_cnpj:r.cpf_cnpj||"",change_for:""})}},[f,i,c,Ze,j,Z,V]),d.useEffect(()=>{O==="delivery"&&Ie!==null&&Qe!==Ie&&(te(!1),ie(0),ge(null),re(!0),de(null))},[Qe,Ie,O]);const ye=i.watch("change_for");d.useEffect(()=>{if(le&&ye&&ye.trim()!==""){const r=ye.replace(",","."),o=parseFloat(r);isNaN(o)?i.setError("change_for",{message:"O troco deve ser um número válido."}):o<z?i.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)}).`}):i.clearErrors("change_for")}else i.clearErrors("change_for")},[le,ye,z,i]);const je=De({mutationFn:async r=>{var sr;G(!0);const o=`${r.street}, ${r.number}, ${r.neighborhood}, ${r.city}, ${r.zip_code}`,a=await Zr(r.zip_code,r.street,r.number,r.city,r.neighborhood);if(G(!1),!a.isValid)throw new Error((x==null?void 0:x.delivery_enabled)===!1?"O endereço está errado ou incompleto, revise todos os campos.":"Endereço fora da área de entrega.");if(!a.coords)throw new Error("Não foi possível obter as coordenadas para salvar o endereço.");const m=(sr=(await P.auth.getUser()).data.user)==null?void 0:sr.id,h=i.getValues("name"),v=i.getValues("phone"),D=i.getValues("cpf_cnpj"),T=v.replace(/\D/g,""),_=D.replace(/\D/g,"");if(!h||T.length<10||_.length!==11&&_.length!==14)throw new Error("Preencha Nome, Telefone (10+ dígitos) e CPF/CNPJ (11 ou 14 dígitos) nos Seus Dados antes de salvar o endereço.");if(!(f!=null&&f.id)&&!m)return{customer:{id:"anonymous",user_id:null,name:h,phone:T,email:null,address:o,created_at:"",updated_at:"",latitude:a.coords.lat,longitude:a.coords.lng,cpf_cnpj:_,street:r.street,number:r.number,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code},feeResult:a};const N={name:h,phone:T,cpf_cnpj:_||null},w={user_id:(c==null?void 0:c.id)||null,...N,email:(c==null?void 0:c.email)||null,address:o,latitude:a.coords.lat,longitude:a.coords.lng,street:r.street,number:r.number,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code},q="*, street, number, neighborhood, city, zip_code";let Me;if(f!=null&&f.id){const{data:ve,error:ue}=await P.from("customers").update(w).eq("id",f.id).select(q).single();if(ue)throw ue;Me=ve}else if(m){const{data:ve,error:ue}=await P.from("customers").insert(w).select(q).single();if(ue)throw ue;Me=ve}else throw new Error("Não foi possível identificar o cliente para salvar.");return{customer:Me,feeResult:a}},onSuccess:(r,o)=>{const{customer:a,feeResult:l}=r;(a==null?void 0:a.id)!=="anonymous"&&u.invalidateQueries({queryKey:["checkoutCustomerData"]}),ie(l.fee),ge(l.time),re(l.isValid),te(!0),de([l.coords.lat,l.coords.lng]);const m=`${o.street}|${o.number}|${o.neighborhood}|${o.city}|${o.zip_code}`;Ae(m),S.success("Endereço salvo e taxa de entrega calculada!")},onError:r=>{S.error(`Erro ao salvar endereço: ${r.message}`),re(!1),te(!1)}}),Xr=r=>{i.trigger(["name","phone","cpf_cnpj"]).then(o=>{o?je.mutate(r):S.error("Preencha Nome, Telefone e CPF/CNPJ nos Seus Dados antes de salvar o endereço.")})},Xe=De({mutationFn:async r=>{var D,T;(D=(await P.auth.getUser()).data.user)==null||D.id;const a=r.phone.replace(/\D/g,""),l=((T=r.cpf_cnpj)==null?void 0:T.replace(/\D/g,""))||null;if(!r.name||a.length<10||l&&l.length!==11&&l.length!==14)throw new Error("Dados de contato incompletos ou inválidos.");const m=O==="delivery"?`${F[1]}, ${F[2]}, ${F[4]}, ${F[3]}, ${F[0]}`:null,h={user_id:(c==null?void 0:c.id)||null,name:r.name,phone:a,email:(c==null?void 0:c.email)||null,cpf_cnpj:l,address:m,latitude:Y?Y[0]:null,longitude:Y?Y[1]:null,street:j.getValues("street")||null,number:j.getValues("number")||null,neighborhood:j.getValues("neighborhood")||null,city:j.getValues("city")||null,zip_code:j.getValues("zip_code")||null};c||(h.email=null);const v="*, street, number, neighborhood, city, zip_code";if(c)if(f){const{data:_,error:N}=await P.from("customers").update(h).eq("id",f.id).select(v).single();if(N)throw N;return _}else{const{data:_,error:N}=await P.from("customers").insert(h).select(v).single();if(N)throw N;return _}else{const{data:_,error:N}=await P.from("customers").insert(h).select(v).single();if(N)throw N;return _}},onSuccess:()=>{u.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:r=>{S.error(`Erro ao salvar dados do cliente: ${r.message}`)}}),He=De({mutationFn:async({customerId:r,data:o})=>{if(!x)throw new Error("Dados do restaurante não disponíveis.");let a=null;if(le&&o.change_for&&o.change_for.trim()!==""){const w=o.change_for.replace(",","."),q=parseFloat(w);!isNaN(q)&&q>z&&(a=q)}let[l,m]=ce||[null,null];if((O==="delivery"||O==="pickup")&&(!l||!m)){const w=O==="pickup"?[15,30]:[30,45];l=w[0],m=w[1]}const h=O==="delivery"?`${F[1]}, ${F[2]}, ${F[4]}, ${F[3]}, ${F[0]}`:null,v={restaurant_id:x.id,customer_id:r,status:Fe?"pending_payment":"pending",total_amount:z,delivery_fee:xe,delivery_address:h,notes:o.notes,payment_method_id:o.payment_method_id,change_for:a,min_delivery_time_minutes:l,max_delivery_time_minutes:m},{data:D,error:T}=await P.from("orders").insert(v).select("id").single();if(T)throw T;const _=p.map(w=>({order_id:D.id,product_id:w.product.id,quantity:parseFloat(w.quantity.toFixed(3)),unit_price:parseFloat(w.product.price.toFixed(2)),subtotal:parseFloat(w.subtotal.toFixed(2)),notes:w.notes})),{error:N}=await P.from("order_items").insert(_);if(N)throw N;return D.id},onSuccess:r=>{u.invalidateQueries({queryKey:["orders"]})},onError:r=>{S.error(`Erro ao criar pedido: ${r.message}`)}}),Hr=async r=>{if(le&&r.change_for&&r.change_for.trim()!==""){const l=r.change_for.replace(",","."),m=parseFloat(l);if(isNaN(m)){S.error("O troco deve ser um número válido.");return}if(m<z){i.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)}).`});return}}if(p.length===0){S.error("Seu carrinho está vazio."),t(`/menu/${y}`);return}if(O==="delivery"){if(!U){S.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!Se){S.error("O endereço de entrega está fora da área de cobertura.");return}}let o;try{o=(await Xe.mutateAsync(r)).id}catch(l){S.error(`Falha ao salvar cliente: ${l.message}`);return}let a;try{a=await He.mutateAsync({customerId:o,data:r})}catch(l){S.error(`Falha ao criar pedido: ${l.message}`);return}Fe?await Jr(a,r):(b(),t(`/order-success/${a}`,{replace:!0}))},Jr=async(r,o)=>{if(!x)return;const a=window.location.origin+window.location.pathname,l=p.map(h=>({name:h.product.name,price:h.product.price,quantity:h.quantity})),m=S.loading("Preparando pagamento online...");try{const{data:h,error:v}=await P.functions.invoke("create-payment-preference",{body:{orderId:r,items:l,totalAmount:z,restaurantName:x.name,clientUrl:a,customerEmail:(c==null?void 0:c.email)||"cliente@anonimo.com",customerCpfCnpj:o.cpf_cnpj}});if(v)throw v;const{init_point:D}=h;Lr(r),Vr(D),Pe(!0),S.dismiss(m)}catch(h){S.dismiss(m),S.error(`Erro no pagamento online: ${h.message}`),Pe(!1)}},Wr=async()=>{await P.auth.signOut(),S.success("Você saiu da sua conta."),t("/auth",{replace:!0})},Yr=(r,o,a)=>{o&&a?(Re(r),Be(!0)):(i.setValue("payment_method_id",r,{shouldValidate:!0}),Re(null))},et=()=>{Ke&&i.setValue("payment_method_id",Ke,{shouldValidate:!0}),Be(!1),Re(null)},Je=d.useMemo(()=>{const[r,o,a,l,m]=F;return o&&a&&m&&l&&r?`${o}, ${a} - ${m}, ${l}, ${r}`:""},[F]);if(!y)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(ee,{variant:"destructive",className:"max-w-lg",children:[e.jsx(fr,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro de Rastreamento"}),e.jsx(ae,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(ke,{to:"/",children:e.jsx(Q,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(p.length===0)return d.useEffect(()=>{t(`/menu/${y}`)},[t,y]),e.jsx(or,{});if(qr||Kr||Ur||R)return e.jsx(or,{});if(Gr||!x)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(ee,{variant:"destructive",className:"max-w-lg",children:[e.jsx(fr,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro Crítico"}),e.jsx(ae,{children:Ue instanceof Error?Ue.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Q,{onClick:()=>Br(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx($t,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const We=Xe.isPending||He.isPending||je.isPending||$||O==="delivery"&&!U;return e.jsxs("div",{className:"min-h-screen bg-background py-4 sm:py-8 px-4 sm:px-8",children:[e.jsx(wt,{isOpen:E,onClose:()=>A(!1),customer:f}),e.jsx(un,{isOpen:zr,onConfirm:et}),Or&&Ge&&e.jsx(dn,{preferenceId:Tr,initPoint:Ge,onClose:()=>Pe(!1)}),e.jsxs("div",{className:"w-full lg:max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{to:`/menu/${y}`,children:e.jsx(Q,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(Ot,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:x.name})]})]}),c&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Q,{variant:"outline",size:"sm",onClick:()=>A(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(pr,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(Q,{variant:"outline",size:"sm",onClick:Wr,children:[e.jsx(bt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(J,{className:"text-xl flex items-center gap-2",children:[e.jsx(pr,{className:"h-5 w-5 text-primary"})," Seus Dados"]})}),e.jsxs(W,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:c?`Logado como ${c.email}. ${f?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx(mr,{...i,children:e.jsx("form",{onSubmit:i.handleSubmit(Hr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(se,{id:"name",...i.register("name")}),i.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"phone",children:"Telefone *"}),e.jsx(me,{name:"phone",control:i.control,render:({field:r})=>e.jsx(jt,{id:"phone",...r})}),i.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(me,{name:"cpf_cnpj",control:i.control,render:({field:r})=>e.jsx(Et,{id:"cpf_cnpj",...r})}),i.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.cpf_cnpj.message})]})]})})})]})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(J,{className:"text-xl flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5 text-primary"})," Opção de Entrega"]})}),e.jsx(W,{children:e.jsx(me,{name:"delivery_option",control:i.control,render:({field:r})=>e.jsxs(Le,{onValueChange:r.onChange,value:r.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(k,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(Ne,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(we,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(k,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(Ne,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Te,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),O==="delivery"&&e.jsxs(X,{className:he(!U&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(H,{children:[e.jsxs(J,{className:"text-xl flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5 text-primary"})," Endereço de Entrega",U&&e.jsx(Tt,{className:"h-5 w-5 text-green-500 ml-2"}),!U&&e.jsx(_e,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(W,{className:"space-y-4",children:[x.delivery_enabled===!1&&e.jsxs(ee,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(oe,{children:"Frete Grátis Ativo"}),e.jsx(ae,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsx(mr,{...j,children:e.jsxs("form",{onSubmit:j.handleSubmit(Xr),id:"address-form-inner",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(k,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(me,{name:"zip_code",control:j.control,render:({field:r})=>e.jsx(Dt,{className:"flex-1 space-y-0",children:e.jsx(kt,{children:e.jsx(ut,{placeholder:"Digite o CEP",...r})})})}),j.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(k,{htmlFor:"street",children:"Rua *"}),e.jsx(se,{id:"street",...j.register("street")}),j.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"number",children:"Número *"}),e.jsx(se,{id:"number",...j.register("number")}),j.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(k,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(se,{id:"neighborhood",...j.register("neighborhood")}),j.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"city",children:"Cidade *"}),e.jsx(se,{id:"city",...j.register("city")}),j.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.city.message})]}),e.jsxs(Q,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:je.isPending||$,children:[je.isPending||$?e.jsx(pe,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Lt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]})}),$&&e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 animate-spin"}),e.jsx(oe,{children:"Calculando Taxa de Entrega..."})]}),U&&!$&&e.jsxs(e.Fragment,{children:[x.delivery_enabled!==!1&&!Se&&e.jsxs(ee,{variant:"destructive",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(oe,{children:"Fora da Área de Entrega"}),e.jsx(ae,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(x.delivery_enabled===!1||Se&&ce)&&e.jsxs(ee,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(oe,{children:"Entrega Disponível"}),e.jsxs(ae,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(xe),". Tempo estimado: ",ce?`${ce[0]} - ${ce[1]}`:"30 - 45"," minutos."]})]})]}),U&&Y&&Je&&e.jsx("div",{className:"mt-6",children:e.jsx(ln,{latitude:Y[0],longitude:Y[1],address:Je})})]})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(J,{className:"text-xl flex items-center gap-2",children:[e.jsx(jr,{className:"h-5 w-5 text-primary"})," Método de Pagamento *"]})}),e.jsxs(W,{children:[e.jsx(me,{name:"payment_method_id",control:i.control,render:({field:r})=>e.jsx(Le,{onValueChange:o=>{var h;const a=B==null?void 0:B.find(v=>v.id===o),l=(h=a==null?void 0:a.name)==null?void 0:h.includes("online"),m=!!M&&M.trim()!=="";Yr(o,!!l,m)},value:r.value,className:"space-y-3",children:B==null?void 0:B.map(o=>{var h;const a=(h=o.name)==null?void 0:h.includes("online"),l=!!M&&M.trim()!=="",m=a&&!l;return e.jsx(k,{htmlFor:o.id,className:he("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",m&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ne,{value:o.id,id:o.id,disabled:m}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:o.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o.description}),m&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},o.id)})})}),i.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:i.formState.errors.payment_method_id.message})]})]}),le&&e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(J,{className:"text-xl flex items-center gap-2",children:[e.jsx(Vt,{className:"h-5 w-5 text-primary"})," Troco"]})}),e.jsx(W,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(se,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z),...i.register("change_for")}),((tr=i.formState.errors.change_for)==null?void 0:tr.message)&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message}),((nr=i.formState.errors.change_for)==null?void 0:nr.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message})]})})]}),e.jsxs(X,{children:[e.jsx(H,{children:e.jsxs(J,{className:"text-xl flex items-center gap-2",children:[e.jsx(vt,{className:"h-5 w-5 text-primary"})," Observações"]})}),e.jsx(W,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(pt,{id:"notes",...i.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(X,{className:"shadow-lg",children:[e.jsx(H,{children:e.jsx(J,{className:"text-2xl",children:"Resumo"})}),e.jsxs(W,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:p.map(r=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[r.quantity,"x ",r.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r.subtotal)})]},r.product.id))}),e.jsx(dr,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(g)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(xe)})]})]}),e.jsx(dr,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)})]}),e.jsx(Q,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:We,children:We?e.jsx(pe,{className:"h-5 w-5 animate-spin mr-2"}):Fe?"Pagar e Finalizar":"Confirmar Pedido"}),O==="delivery"&&!U&&e.jsxs(ee,{variant:"destructive",className:"mt-3",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(ae,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(ke,{to:`/menu/${x.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{cs as default};
