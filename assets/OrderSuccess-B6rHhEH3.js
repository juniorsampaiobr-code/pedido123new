import{a as $,u as L,b as U,j as e}from"./tanstack-C7aOFagJ.js";import{u as V,k as X,R as W,r as Y,L as p}from"./vendor-DjsPZZVP.js";import{aw as Z,C as f,e as g,f as j,b as y,B as l,d as G,Q as J,a6 as ee,a as se,W as re,L as ae,Z as D,s as b,j as S,X as te,Y as ne}from"./index-B-46Ikd-.js";import{A as ce,h as oe,a as le,b as ie,c as de,d as me,e as ue,f as xe,g as he,C as pe}from"./alert-dialog-D4B4dy72.js";import{C as fe}from"./circle-alert-CUdBE3XT.js";import{C as T}from"./credit-card-CsylM8cO.js";import{P as ge}from"./package-CwjFxhRa.js";import{T as je}from"./truck-LbIX4IES.js";import{f as ye}from"./format-BeKxgCCE.js";import{p as be}from"./pt-BR-CbDebePx.js";import"./supabase-BAEEEeUB.js";const B={pending:{label:"Pedido Recebido",icon:te,color:"bg-yellow-500"},preparing:{label:"Em Preparação",icon:ge,color:"bg-orange-500"},ready:{label:"Pronto para Entrega",icon:ne,color:"bg-green-500"},delivering:{label:"Em Entrega",icon:je,color:"bg-blue-500"},delivered:{label:"Entregue",icon:pe,color:"bg-primary"},cancelled:{label:"Cancelado",icon:D,color:"bg-destructive"},pending_payment:{label:"Aguardando Pagamento",icon:T,color:"bg-gray-500"}},Ne=["pending_payment","pending","preparing","ready"],we=async c=>{const{data:t,error:n}=await b.from("orders").select("*, customer:customers(name, phone, email, cpf_cnpj), payment_methods(name)").eq("id",c).limit(1).single();if(n)throw new Error(`Erro ao buscar pedido: ${n.message}`);if(!t)throw new Error("Pedido não encontrado.");return t},ve=async c=>{const{data:t,error:n}=await b.from("order_items").select("*, products(name, is_price_by_weight)").eq("order_id",c);if(n)throw new Error(n.message);return t},Te=()=>{var A;const{orderId:c}=V(),[t]=X(),n=$(),a=c||t.get("external_reference"),F=t.get("restaurantId");t.get("status");const{clearCart:N}=Z(),[w,k]=W.useState(!1),{data:s,isLoading:q,isError:O,error:u,refetch:M}=L({queryKey:["orderSuccessDetails",a],queryFn:()=>we(a),enabled:!!a,staleTime:0}),{data:x,isLoading:Q,isError:z}=L({queryKey:["orderSuccessItems",a],queryFn:()=>ve(a),enabled:!!a,staleTime:0}),i=U({mutationFn:async r=>{const{error:o}=await b.from("orders").update({status:"cancelled"}).eq("id",r);if(o)throw new Error(o.message)},onSuccess:()=>{S.success("Pedido cancelado com sucesso."),n.invalidateQueries({queryKey:["orderSuccessDetails",a]}),n.invalidateQueries({queryKey:["orders"]})},onError:r=>{S.error(`Falha ao cancelar pedido: ${r.message}`)}});Y.useEffect(()=>{a&&!w&&(N(),k(!0))},[a,N,w]);const d=(s==null?void 0:s.status)||"pending_payment",h=B[d]||B.pending_payment,v=s!=null&&s.id?s.id.slice(-4):"N/A",m=(s==null?void 0:s.restaurant_id)||F,C=(s==null?void 0:s.total_amount)||0,_=(s==null?void 0:s.delivery_fee)||0,H=C-_,E=s!=null&&s.created_at?new Date(s.created_at):null;E&&ye(E,"dd 'de' MMMM 'de' yyyy 'às' HH:mm",{locale:be});const P=s!=null&&s.change_for?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s.change_for):null,K=((A=s==null?void 0:s.payment_methods)==null?void 0:A.name)||"Não especificado",R=Ne.includes(d);return a?q||Q?e.jsx(G,{}):O||z||!s?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(f,{className:"max-w-lg w-full text-center",children:[e.jsx(g,{children:e.jsxs(j,{className:"text-2xl font-bold text-destructive flex items-center justify-center gap-2",children:[e.jsx(J,{className:"h-6 w-6"}),"Erro ao Carregar Pedido"]})}),e.jsxs(y,{children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:(u==null?void 0:u.message)||"Ocorreu um erro desconhecido ao buscar os detalhes do pedido."}),e.jsxs(l,{onClick:()=>M(),className:"mr-2",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]}),e.jsx(p,{to:m?`/menu/${m}`:"/",children:e.jsx(l,{variant:"outline",children:"Voltar ao Cardápio"})})]})]})}):e.jsx("div",{className:"min-h-screen bg-background flex justify-center p-4 sm:p-8",children:e.jsxs(f,{className:"w-full max-w-3xl shadow-xl",children:[e.jsxs(g,{className:"text-center space-y-4",children:[e.jsx("div",{className:se("mx-auto p-3 rounded-full w-16 h-16 flex items-center justify-center",h.color),children:e.jsx(h.icon,{className:"h-8 w-8 text-white"})}),e.jsx(j,{className:"text-3xl font-bold",children:d==="cancelled"?"Pedido Cancelado":"Pedido Realizado com Sucesso!"}),e.jsxs("p",{className:"text-lg text-muted-foreground",children:["Seu pedido #",v," está em ",h.label.toLowerCase(),"."]})]}),e.jsxs(y,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(re,{className:"h-5 w-5 text-primary flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Entrega"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.delivery_address||"Retirada no local"})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(T,{className:"h-5 w-5 text-primary flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:K}),P&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Troco para: ",P]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Resumo do Pedido"}),e.jsx("div",{className:"space-y-2",children:x==null?void 0:x.map(r=>{var o,I;return e.jsxs("div",{className:"flex justify-between items-start p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((o=r.products)==null?void 0:o.name)||"Produto Removido"}),r.notes&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Obs: ",r.notes]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.quantity," ",(I=r.products)!=null&&I.is_price_by_weight?"kg":"x"," ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r.unit_price)]}),e.jsx("p",{className:"font-semibold",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r.subtotal)})]})]},r.id)})})]}),e.jsxs("div",{className:"pt-4 border-t space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(H)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(_)})]}),e.jsxs("div",{className:"flex justify-between font-bold text-xl pt-2 border-t",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C)})]})]}),e.jsxs("div",{className:"pt-6 flex flex-col sm:flex-row justify-center gap-4",children:[R&&e.jsxs(ce,{children:[e.jsx(oe,{asChild:!0,children:e.jsxs(l,{variant:"destructive",disabled:i.isPending,children:[i.isPending?e.jsx(ae,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(D,{className:"h-4 w-4 mr-2"}),"Cancelar Pedido"]})}),e.jsxs(le,{children:[e.jsxs(ie,{children:[e.jsxs(de,{children:["Tem certeza que deseja cancelar o pedido #",v,"?"]}),e.jsx(me,{children:"O cancelamento só é possível se o restaurante ainda não tiver iniciado a entrega. Esta ação não pode ser desfeita."})]}),e.jsxs(ue,{children:[e.jsx(xe,{children:"Não, Manter Pedido"}),e.jsx(he,{onClick:()=>i.mutate(a),className:"bg-destructive hover:bg-destructive/90",disabled:i.isPending,children:"Sim, Cancelar"})]})]})]}),e.jsx(p,{to:m?`/menu/${m}`:"/",children:e.jsx(l,{size:"lg",className:"w-full sm:w-auto",children:"Fazer Novo Pedido"})})]}),!R&&d!=="cancelled"&&e.jsx("p",{className:"text-center text-sm text-muted-foreground mt-4",children:"O pedido não pode mais ser cancelado, pois está em fase de entrega ou já foi entregue."})]})]})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(f,{className:"max-w-lg w-full text-center",children:[e.jsx(g,{children:e.jsxs(j,{className:"text-2xl font-bold text-destructive flex items-center justify-center gap-2",children:[e.jsx(fe,{className:"h-6 w-6"}),"Erro no Pedido"]})}),e.jsxs(y,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:"ID do pedido não encontrado. Por favor, volte ao menu."}),e.jsx(p,{to:"/",children:e.jsx(l,{size:"lg",children:"Voltar ao Início"})})]})]})})};export{Te as default};
