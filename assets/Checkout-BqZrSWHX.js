import{j as e,b as Ls,u as ce,c as As}from"./tanstack-DS1wz2fm.js";import{r as p,R as Qe,u as Ms,h as Ts,L as qs}from"./vendor-DPb28zz8.js";import{o as Ds,s as $,l as zs,e as Bs,c as Ge,p as Os,n as Gs,Z as G,u as Ks,t as Us}from"./types-dEzyxwQ3.js";import{s as T}from"./client-BP8r4skJ.js";import{c as Zs,g as We,h as Se,P as je,j as Ee,i as Js,t as Hs,m as Qs,b as ye,u as x,a as Ws,L as de}from"./index-BzZ195gm.js";import{B as ue}from"./button-CUYNz81_.js";import{C as pe,b as he,c as fe,a as xe}from"./card-DANg4y3A.js";import{I as L,L as _e}from"./label-DTkoDdZE.js";import{c as Xe,R as Xs,I as Ys}from"./index-B35AYamI.js";import{u as er}from"./index-Dm27xrF8.js";import{u as sr}from"./index-CJmVBZLB.js";import{S as Ke}from"./separator-BK0wWaXm.js";import{T as rr}from"./textarea-q-ssYWSs.js";import{A as re,a as ae,b as oe}from"./alert-B5hFkYda.js";import{S as me}from"./skeleton-D7QTo0Hl.js";import{F as ar,b as R,c as j,a as C,e as E,d as q}from"./form-CkMk1eb9.js";import{Z as Ue,S as or,L as tr}from"./ZipCodeInput-IIY61dPp.js";import{T as Ze}from"./terminal-CJlM8qV4.js";import{A as nr}from"./arrow-left-K1fMQJfE.js";import{T as Re}from"./truck-P7bzhUiw.js";import{S as Ye,a as ir}from"./store-Cw-EqDr6.js";import{M as lr}from"./map-pin-BV0aKWN6.js";import{C as es}from"./credit-card-DxRVchGe.js";import{P as cr}from"./package-j4xXXoUE.js";import{D as dr}from"./dollar-sign-ChbvCqeS.js";import"./supabase-BT-vd-uw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ur=Zs("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);var Ve="Radio",[mr,ss]=We(Ve),[pr,hr]=mr(Ve),rs=p.forwardRef((a,s)=>{const{__scopeRadio:t,name:d,checked:i=!1,required:u,disabled:c,value:h="on",onCheck:g,form:N,..._}=a,[P,S]=p.useState(null),y=Se(s,D=>S(D)),v=p.useRef(!1),w=P?N||!!P.closest("form"):!0;return e.jsxs(pr,{scope:t,checked:i,disabled:c,children:[e.jsx(je.button,{type:"button",role:"radio","aria-checked":i,"data-state":ns(i),"data-disabled":c?"":void 0,disabled:c,value:h,..._,ref:y,onClick:Ee(a.onClick,D=>{i||g==null||g(),w&&(v.current=D.isPropagationStopped(),v.current||D.stopPropagation())})}),w&&e.jsx(ts,{control:P,bubbles:!v.current,name:d,value:h,checked:i,required:u,disabled:c,form:N,style:{transform:"translateX(-100%)"}})]})});rs.displayName=Ve;var as="RadioIndicator",os=p.forwardRef((a,s)=>{const{__scopeRadio:t,forceMount:d,...i}=a,u=hr(as,t);return e.jsx(Js,{present:d||u.checked,children:e.jsx(je.span,{"data-state":ns(u.checked),"data-disabled":u.disabled?"":void 0,...i,ref:s})})});os.displayName=as;var fr="RadioBubbleInput",ts=p.forwardRef(({__scopeRadio:a,control:s,checked:t,bubbles:d=!0,...i},u)=>{const c=p.useRef(null),h=Se(c,u),g=sr(t),N=Hs(s);return p.useEffect(()=>{const _=c.current;if(!_)return;const P=window.HTMLInputElement.prototype,y=Object.getOwnPropertyDescriptor(P,"checked").set;if(g!==t&&y){const v=new Event("click",{bubbles:d});y.call(_,t),_.dispatchEvent(v)}},[g,t,d]),e.jsx(je.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...i,tabIndex:-1,ref:h,style:{...i.style,...N,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ts.displayName=fr;function ns(a){return a?"checked":"unchecked"}var xr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ve="RadioGroup",[gr,ta]=We(ve,[Xe,ss]),is=Xe(),ls=ss(),[jr,yr]=gr(ve),cs=p.forwardRef((a,s)=>{const{__scopeRadioGroup:t,name:d,defaultValue:i,value:u,required:c=!1,disabled:h=!1,orientation:g,dir:N,loop:_=!0,onValueChange:P,...S}=a,y=is(t),v=er(N),[w,D]=Qs({prop:u,defaultProp:i??null,onChange:P,caller:ve});return e.jsx(jr,{scope:t,name:d,required:c,disabled:h,value:w,onValueChange:D,children:e.jsx(Xs,{asChild:!0,...y,orientation:g,dir:v,loop:_,children:e.jsx(je.div,{role:"radiogroup","aria-required":c,"aria-orientation":g,"data-disabled":h?"":void 0,dir:v,...S,ref:s})})})});cs.displayName=ve;var ds="RadioGroupItem",us=p.forwardRef((a,s)=>{const{__scopeRadioGroup:t,disabled:d,...i}=a,u=yr(ds,t),c=u.disabled||d,h=is(t),g=ls(t),N=p.useRef(null),_=Se(s,N),P=u.value===i.value,S=p.useRef(!1);return p.useEffect(()=>{const y=w=>{xr.includes(w.key)&&(S.current=!0)},v=()=>S.current=!1;return document.addEventListener("keydown",y),document.addEventListener("keyup",v),()=>{document.removeEventListener("keydown",y),document.removeEventListener("keyup",v)}},[]),e.jsx(Ys,{asChild:!0,...h,focusable:!c,active:P,children:e.jsx(rs,{disabled:c,required:u.required,checked:P,...g,...i,name:u.name,ref:_,onCheck:()=>u.onValueChange(i.value),onKeyDown:Ee(y=>{y.key==="Enter"&&y.preventDefault()}),onFocus:Ee(i.onFocus,()=>{var y;S.current&&((y=N.current)==null||y.click())})})})});us.displayName=ds;var vr="RadioGroupIndicator",ms=p.forwardRef((a,s)=>{const{__scopeRadioGroup:t,...d}=a,i=ls(t);return e.jsx(os,{...i,...d,ref:s})});ms.displayName=vr;var ps=cs,hs=us,br=ms;const ge=p.forwardRef(({className:a,...s},t)=>e.jsx(ps,{className:ye("grid gap-2",a),...s,ref:t}));ge.displayName=ps.displayName;const W=p.forwardRef(({className:a,...s},t)=>e.jsx(hs,{ref:t,className:ye("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),...s,children:e.jsx(br,{className:"flex items-center justify-center",children:e.jsx(ur,{className:"h-2.5 w-2.5 fill-current text-current"})})}));W.displayName=hs.displayName;const Nr=a=>{let s=a.replace(/\D/g,"");return s.length>11&&(s=s.slice(0,11)),s.length>0&&(s=`(${s}`),s.length>3&&(s=`${s.slice(0,3)}) ${s.slice(3)}`),s.length>10&&(s=`${s.slice(0,10)}-${s.slice(10)}`),s},fs=Qe.forwardRef(({className:a,value:s,onChange:t,...d},i)=>{const u=c=>{const h=c.target.value,g=Nr(h),N={...c,target:{...c.target,value:g}};t(N)};return e.jsx(L,{ref:i,type:"tel",className:ye("w-full",a),placeholder:"(99) 99999-9999",value:s,onChange:u,...d})});fs.displayName="PhoneInput";const wr=a=>{let s=a.replace(/\D/g,"");return s.length>14&&(s=s.slice(0,14)),s.length<=11?(s.length>9&&(s=`${s.slice(0,9)}-${s.slice(9)}`),s.length>6&&(s=`${s.slice(0,6)}.${s.slice(6)}`),s.length>3&&(s=`${s.slice(0,3)}.${s.slice(3)}`),s):(s.length>12&&(s=`${s.slice(0,12)}-${s.slice(12)}`),s.length>8&&(s=`${s.slice(0,8)}/${s.slice(8)}`),s.length>5&&(s=`${s.slice(0,5)}.${s.slice(5)}`),s.length>2&&(s=`${s.slice(0,2)}.${s.slice(2)}`),s)},xs=Qe.forwardRef(({className:a,value:s,onChange:t,...d},i)=>{const u=c=>{const h=c.target.value,g=wr(h),N={...c,target:{...c.target,value:g}};t(N)};return e.jsx(L,{ref:i,type:"tel",className:ye("w-full",a),placeholder:"CPF ou CNPJ",value:s,onChange:u,maxLength:18,...d})});xs.displayName="CpfCnpjInput";const Cr=(a,s,t,d)=>{const u=(t-a)*(Math.PI/180),c=(d-s)*(Math.PI/180),h=Math.sin(u/2)*Math.sin(u/2)+Math.cos(a*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))},Je=async a=>{const s=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`;try{const t=await fetch(s);if(!t.ok)throw new Error("Falha na API de geocodificação.");const d=await t.json();if(d&&d.length>0){const i=parseFloat(d[0].lat),u=parseFloat(d[0].lon);if(!isNaN(i)&&!isNaN(u))return[i,u]}return console.warn("Geocodificação falhou para o endereço:",a,"Usando coordenadas padrão."),null}catch(t){return console.error("Erro durante a geocodificação:",t),x.error("Erro ao buscar coordenadas do endereço. Verifique o endereço."),null}},_r=(a,s,t)=>{const d=Cr(s[0],s[1],a[0],a[1]),i=t.find(u=>d<=u.max_distance_km);if(i){const u=i.delivery_fee||0,c=i.min_delivery_time_minutes||0,h=c+15;return{fee:parseFloat(u.toFixed(2)),minTime:c,maxTime:h}}return null},gs=a=>a.replace(/\D/g,""),Pe=a=>a.replace(/\D/g,""),He=a=>a.replace(/\D/g,""),Rr=Ds({name:$().min(1,"Nome é obrigatório."),phone:$().min(1,"Telefone é obrigatório.").transform(gs).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:$().email("Email inválido.").optional().or(zs("")),delivery_option:Bs(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:$().optional().default(""),number:$().optional().default(""),complement:$().optional().default(""),neighborhood:$().optional().default(""),city:$().optional().default(""),zip_code:$().optional().default("").transform(Pe).refine(a=>a.length===8||a.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ge.number().optional().nullable(),longitude:Ge.number().optional().nullable(),payment_method_id:$().min(1,"Selecione uma forma de pagamento."),notes:$().optional(),cpf_cnpj:$().optional().default("").transform(He).refine(a=>a.length===0||a.length===11||a.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Os(a=>a==null||a===""?null:String(a).replace(",","."),Gs({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((a,s)=>{if(a.delivery_option==="delivery"&&(a.street.trim()===""&&s.addIssue({code:G.custom,message:"Rua é obrigatória.",path:["street"]}),a.number.trim()===""&&s.addIssue({code:G.custom,message:"Número é obrigatório.",path:["number"]}),a.neighborhood.trim()===""&&s.addIssue({code:G.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),a.city.trim()===""&&s.addIssue({code:G.custom,message:"Cidade é obrigatória.",path:["city"]}),a.zip_code.length!==8&&s.addIssue({code:G.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]})),a.payment_method_id==="Dinheiro"&&a.change_for!==null&&a.change_for!==void 0&&a.change_for<=0&&s.addIssue({code:G.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),a.payment_method_id==="Pagamento online: Pix/Cartão"){const i=He(a.cpf_cnpj||"");i.length!==11&&i.length!==14&&s.addIssue({code:G.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Er=async()=>{const{data:a,error:s}=await T.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(s)throw new Error(`Erro ao buscar restaurante: ${s.message}`);if(!a)throw new Error("Nenhum restaurante ativo encontrado.");return a},Pr=async a=>{const{data:s,error:t}=await T.from("restaurants").select("delivery_enabled").eq("id",a).single();if(t)throw new Error(`Erro ao buscar status de entrega: ${t.message}`);return s.delivery_enabled??!0},Sr=async a=>{const{data:s,error:t}=await T.from("payment_methods").select("*").eq("restaurant_id",a).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return s},Vr=async a=>{const{data:s,error:t}=await T.from("delivery_zones").select("*").eq("restaurant_id",a).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return s},Fr=a=>{switch(a){case"DollarSign":return dr;case"Smartphone":return ir;case"CreditCard":return es;case"Package":return cr;default:return Ye}},Ir=({subtotal:a,deliveryFee:s,total:t,items:d})=>e.jsxs(pe,{className:"sticky top-4",children:[e.jsx(he,{children:e.jsx(fe,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(xe,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:d.map(i=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[i.quantity,"x ",i.name,i.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",i.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i.price*i.quantity)})]},i.id))}),e.jsx(Ke,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:s>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s):"Grátis"})]})]}),e.jsx(Ke,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]})]})]}),na=()=>{const a=Ms(),s=Ls(),t=Ws(),{items:d,subtotal:i,deliveryFee:u,total:c,setDeliveryFee:h,clearCart:g}=t,[N]=Ts(),[_,P]=p.useState(!1),[S,y]=p.useState(!1),[v,w]=p.useState(null),[D,K]=p.useState(null),[Fe,Ie]=p.useState(""),[X,ke]=p.useState(""),[$e,Le]=p.useState(!1),[js,Y]=p.useState(!1),[V,ys]=p.useState("search"),z=N.get("status"),be=N.get("external_reference"),{data:n,isLoading:vs,isError:bs,error:Ns}=ce({queryKey:["checkoutRestaurantData"],queryFn:Er}),{data:Ne=!0,isLoading:ws}=ce({queryKey:["deliveryStatus",n==null?void 0:n.id],queryFn:()=>Pr(n.id),enabled:!!(n!=null&&n.id),initialData:!0}),{data:U=[],isLoading:Cs}=ce({queryKey:["checkoutPaymentMethods",n==null?void 0:n.id],queryFn:()=>Sr(n.id),enabled:!!(n!=null&&n.id)}),{data:Ae=[],isLoading:_s}=ce({queryKey:["checkoutDeliveryZones",n==null?void 0:n.id],queryFn:()=>Vr(n.id),enabled:!!(n!=null&&n.id)}),Rs=vs||ws||Cs||_s,Es=bs,Me=Ns,o=Ks({resolver:Us(Rr),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),ee=o.watch("delivery_option"),we=o.watch("payment_method_id"),Z=U.find(r=>r.id===we),te=(Z==null?void 0:Z.name)==="Pagamento online: Pix/Cartão",ne=(Z==null?void 0:Z.name)==="Dinheiro",F=o.watch("latitude"),I=o.watch("longitude"),ie=o.watch(["street","number","complement","neighborhood","city","zip_code"]),J=ee==="delivery",Ps=JSON.stringify({mode:V,fields:ie,lat:F,lng:I,deliveryOption:ee}),Te=p.useMemo(()=>typeof F=="number"&&typeof I=="number"&&!isNaN(F)&&!isNaN(I)?[F,I]:n!=null&&n.latitude&&(n!=null&&n.longitude)?[n.latitude,n.longitude]:[-23.55052,-46.633308],[F,I,n]),qe=p.useCallback(r=>{o.setValue("street",r.road||r.logradouro||"",{shouldValidate:!0}),o.setValue("number",r.house_number||X||"",{shouldValidate:!0}),o.setValue("complement",r.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",r.suburb||r.bairro||"",{shouldValidate:!0}),o.setValue("city",r.city||r.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",r.postcode||r.cep||"",{shouldValidate:!0})},[o,X]),Ss=async()=>{const r=Fe.replace(/\D/g,"");if(r.length!==8){x.warning("Por favor, digite um CEP válido.");return}Le(!0);const l=x.loading("Buscando endereço...");try{const m=await fetch(`https://viacep.com.br/ws/${r}/json/`);if(!m.ok)throw new Error("Falha na busca do CEP.");const f=await m.json();if(f.erro){x.error("CEP não encontrado.");return}o.setValue("street",f.logradouro,{shouldValidate:!0}),o.setValue("number",X,{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood",f.bairro,{shouldValidate:!0}),o.setValue("city",f.localidade,{shouldValidate:!0}),o.setValue("zip_code",f.cep,{shouldValidate:!0});const b=`${f.logradouro}, ${X||"1"}, ${f.localidade}, ${f.uf}`,k=await Je(b);k?(o.setValue("latitude",k[0],{shouldValidate:!0}),o.setValue("longitude",k[1],{shouldValidate:!0}),Y(!0),x.success("Endereço encontrado e mapa atualizado!")):(o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),x.warning("Endereço encontrado, mas não foi possível obter as coordenadas. Ajuste o pino no mapa manualmente."))}catch(m){x.error(`Erro na busca: ${m.message}`)}finally{Le(!1),x.dismiss(l)}},Vs=p.useCallback(async(r,l)=>{o.setValue("latitude",r,{shouldValidate:!0}),o.setValue("longitude",l,{shouldValidate:!0});const m=x.loading("Atualizando endereço...");try{const f=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${l}&addressdetails=1`,b=await fetch(f);if(!b.ok)throw new Error("Falha ao obter detalhes do endereço.");const k=await b.json();k.address&&(qe(k.address),x.success("Endereço atualizado a partir do mapa."))}catch(f){x.error(`Erro ao buscar endereço: ${f.message}`)}finally{x.dismiss(m)}},[o,qe]);p.useEffect(()=>{ne||o.setValue("change_for",null,{shouldValidate:!0})},[ne,o]),p.useEffect(()=>{ee==="pickup"&&(h(0),w(null),K(null),o.setValue("latitude",null),o.setValue("longitude",null),Y(!1)),J&&(o.setValue("latitude",null),o.setValue("longitude",null),Y(!1),V==="manual"&&(Ie(""),ke("")),V==="search"&&(o.setValue("street",""),o.setValue("number",""),o.setValue("complement",""),o.setValue("neighborhood",""),o.setValue("city",""),o.setValue("zip_code","")))},[ee,V,J,o,h]),p.useEffect(()=>{U.length>0&&!we&&o.setValue("payment_method_id",U[0].id)},[U,we,o]),p.useEffect(()=>{const r=async()=>{if(!Ne){h(0),w(null),K(null);return}if(ee==="pickup"||!(n!=null&&n.latitude)||!(n!=null&&n.longitude)){h(0),w(null),K(null);return}y(!0),w(null);let m=null;if(F&&I)m=[F,I];else{const[f,b,k,H,Q,B]=ie,O=Pe(B);if(f&&b&&H&&Q&&O.length===8){const le=`${f}, ${b} ${k}, ${H}, ${Q}, ${B}`;m=await Je(le),m&&(o.setValue("latitude",m[0]),o.setValue("longitude",m[1]),Y(!0))}}if(m){const f=[n.latitude,n.longitude],b=_r(m,f,Ae);b?(h(b.fee),w(null),K({minTime:b.minTime,maxTime:b.maxTime})):(h(0),w("Seu endereço está fora da nossa área de entrega."),K(null))}else{h(0),K(null);const[f,b,k,H,Q,B]=ie,O=f&&b&&H&&Q&&Pe(B).length===8;J&&O?(w("Não foi possível localizar seu endereço para calcular a taxa. Por favor, verifique o endereço ou ajuste o pino no mapa."),n!=null&&n.latitude&&(n!=null&&n.longitude)&&(o.setValue("latitude",n.latitude),o.setValue("longitude",n.longitude),Y(!0))):w(null)}y(!1)},l=setTimeout(()=>{r()},500);return()=>clearTimeout(l)},[Ps,n,Ae,o,h,J,F,I,V,ie,Ne]),p.useEffect(()=>{const r=z==="failure"||z==="pending";if(d.length===0&&!_&&!r){const l=setTimeout(()=>{x.info("Seu carrinho está vazio. Adicione itens para continuar."),a("/menu")},0);return()=>clearTimeout(l)}r&&(z==="failure"?x.error("Pagamento Recusado",{description:"O pagamento online falhou. Por favor, tente novamente ou escolha outro método de pagamento.",duration:1e4}):z==="pending"&&x.warning("Pagamento Pendente",{description:"Seu pagamento está em análise. Você pode acompanhar o status na página de sucesso do pedido.",duration:1e4}),be&&a(`/order-success/${be}`,{replace:!0}))},[d.length,a,_,z,be]);const De=As({mutationFn:async r=>{if(!n)throw new Error("Dados do restaurante indisponíveis.");if(r.delivery_option==="delivery"&&v)throw new Error(v);const l=[r.street,r.number,r.complement?`(${r.complement})`:null,r.neighborhood,r.city,r.zip_code].filter(Boolean).join(", "),m=r.delivery_option==="delivery"?l:"Retirada no Local";let f;const b=gs(r.phone),{data:k}=await T.from("customers").select("id").eq("phone",b).limit(1).single();if(k)f=k.id;else{const{data:A,error:se}=await T.from("customers").insert({name:r.name,phone:b,email:r.email||null,address:m,latitude:r.latitude,longitude:r.longitude}).select("id").single();if(se)throw new Error(`Erro ao criar cliente: ${se.message}`);f=A.id}const H=te?"pending_payment":"pending",{data:Q,error:B}=await T.from("orders").insert({restaurant_id:n.id,customer_id:f,status:H,total_amount:c,delivery_fee:u,notes:r.notes,delivery_address:m}).select("id").single();if(B)throw new Error(`Erro ao criar pedido: ${B.message}`);const O=Q.id,Be=d.map(A=>({order_id:O,product_id:A.product_id,quantity:A.quantity,unit_price:A.price,subtotal:A.price*A.quantity,notes:A.notes})),{error:le}=await T.from("order_items").insert(Be);if(le)throw new Error(`Erro ao adicionar itens do pedido: ${le.message}`);if(te){g(),P(!0),x.info("Redirecionando para o pagamento online...");const A=window.location.origin,se={orderId:O,items:d,totalAmount:parseFloat(c.toFixed(2)),restaurantName:n.name,clientUrl:A,customerEmail:r.email||"cliente@pedido123.com",customerCpfCnpj:r.cpf_cnpj};console.log("Payload enviado para create-payment-preference:",se);try{const{data:M,error:Oe}=await T.functions.invoke("create-payment-preference",{body:se});if(Oe)throw new Error(Oe.message);if(M&&M.error)throw new Error(`Mercado Pago Error: ${M.error}`);if(M&&M.init_point){window.location.href=M.init_point;return}else throw new Error("Resposta de pagamento inválida: init_point não encontrado.")}catch(M){throw console.error("Erro ao criar preferência de pagamento:",M),new Error(`Falha ao processar pagamento online: ${M.message}`)}}return O},onSuccess:r=>{te||(x.success(`Pedido #${r.slice(-4)} realizado com sucesso!`),s.invalidateQueries({queryKey:["orders"]}),g(),a(`/order-success/${r}`))},onError:r=>{let l="Ocorreu um erro ao finalizar seu pedido. Por favor, tente novamente.";const m=r.message||"";m.includes("Mercado Pago Error:")?(l=m.split("Mercado Pago Error:")[1].trim(),l.includes("access token")&&(l="O Access Token do Mercado Pago está incorreto ou ausente. Por favor, verifique as configurações do restaurante.")):m.toLowerCase().includes("access token")||m.toLowerCase().includes("credentials")?l="Ocorreu um problema com a configuração de pagamento do restaurante. Por favor, entre em contato com o estabelecimento.":m.toLowerCase().includes("fora da nossa área de entrega")?l="Seu endereço está fora da nossa área de entrega.":m.toLowerCase().includes("inconsistência no valor total")?l="Erro de cálculo no pedido. Por favor, tente limpar o carrinho e refazer o pedido.":m.toLowerCase().includes("falha ao processar pagamento online")&&(l=m.split("Falha ao processar pagamento online:")[1]||"Erro ao processar pagamento online. Por favor, tente novamente."),x.error("Falha ao processar o pagamento",{description:l,duration:1e4}),P(!1)}}),Fs=r=>{if(ne){const l=r.change_for;if(l!=null&&l<c){x.error(`O valor do troco (R$ ${l.toFixed(2).replace(".",",")}) deve ser maior ou igual ao total do pedido (R$ ${c.toFixed(2).replace(".",",")}).`);return}}De.mutate(r)},Is=r=>{Object.keys(r).length>0&&x.error("Por favor, preencha todos os campos obrigatórios e corrija os erros.")},ks=z==="failure"||z==="pending";if(d.length===0&&!_&&!ks)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."});if(Rs)return e.jsxs("div",{className:"container mx-auto p-4 max-w-6xl",children:[e.jsx(me,{className:"h-10 w-48 mb-6"}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(me,{className:"h-64 w-full"}),e.jsx(me,{className:"h-64 w-full"})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(me,{className:"h-96 w-full sticky top-4"})})]})]});if(Es)return e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(re,{variant:"destructive",children:[e.jsx(Ze,{className:"h-4 w-4"}),e.jsx(ae,{children:"Erro de Conexão"}),e.jsx(oe,{children:Me instanceof Error?Me.message:"Não foi possível carregar os dados."})]})});const Ce=De.isPending||_||S,$s=!J||!v&&u>=0,ze=!Ce&&$s;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(qs,{to:"/menu",children:e.jsx(ue,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(nr,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8 max-w-6xl",children:e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ar,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(Fs,Is),className:"space-y-6",children:[e.jsxs(pe,{children:[e.jsx(he,{children:e.jsx(fe,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(xe,{className:"space-y-4",children:[e.jsx(R,{control:o.control,name:"name",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Nome Completo *"}),e.jsx(L,{placeholder:"Seu nome",...r}),e.jsx(E,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(R,{control:o.control,name:"phone",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Telefone *"}),e.jsx(fs,{...r}),e.jsx(E,{})]})}),e.jsx(R,{control:o.control,name:"email",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Email (Opcional)"}),e.jsx(L,{placeholder:"seu@email.com",...r}),e.jsx(E,{})]})})]})]})]}),e.jsxs(pe,{children:[e.jsx(he,{children:e.jsx(fe,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(xe,{className:"space-y-4",children:[e.jsx(R,{control:o.control,name:"delivery_option",render:({field:r})=>e.jsxs(j,{className:"space-y-3",children:[e.jsx(q,{children:e.jsxs(ge,{onValueChange:r.onChange,defaultValue:r.value,className:"flex flex-col space-y-1",children:[e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(q,{children:e.jsx(W,{value:"delivery"})}),e.jsx(Re,{className:"h-5 w-5 text-primary"}),e.jsx(C,{className:"font-normal flex-1 cursor-pointer",children:"Delivery"})]}),e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(q,{children:e.jsx(W,{value:"pickup"})}),e.jsx(Ye,{className:"h-5 w-5 text-primary"}),e.jsx(C,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(E,{})]})}),J&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(lr,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs(ge,{value:V,onValueChange:r=>ys(r),className:"flex gap-4",children:[e.jsxs(j,{className:"flex items-center space-x-2",children:[e.jsx(q,{children:e.jsx(W,{value:"search",id:"r-search"})}),e.jsx(_e,{htmlFor:"r-search",className:"cursor-pointer",children:"Buscar por CEP"})]}),e.jsxs(j,{className:"flex items-center space-x-2",children:[e.jsx(q,{children:e.jsx(W,{value:"manual",id:"r-manual"})}),e.jsx(_e,{htmlFor:"r-manual",className:"cursor-pointer",children:"Digitar Manualmente"})]})]}),V==="search"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{children:"Buscar Endereço por CEP e Número"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ue,{placeholder:"Digite o CEP",value:Fe,onChange:r=>Ie(r.target.value)}),e.jsx(L,{placeholder:"Número",value:X,onChange:r=>ke(r.target.value)}),e.jsx(ue,{type:"button",onClick:Ss,disabled:$e,children:$e?e.jsx(de,{className:"h-4 w-4 animate-spin"}):e.jsx(or,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(R,{control:o.control,name:"street",render:({field:r})=>e.jsxs(j,{className:"col-span-2",children:[e.jsx(C,{children:"Rua *"}),e.jsx(L,{...r,disabled:V==="search"}),e.jsx(E,{})]})}),e.jsx(R,{control:o.control,name:"number",render:({field:r})=>e.jsxs(j,{className:"col-span-1",children:[e.jsx(C,{children:"Número *"}),e.jsx(L,{...r,disabled:V==="search"}),e.jsx(E,{})]})})]}),e.jsx(R,{control:o.control,name:"complement",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Complemento (Opcional)"}),e.jsx(L,{placeholder:"Apto, Bloco, Casa, etc.",...r,disabled:!1}),e.jsx(E,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(R,{control:o.control,name:"neighborhood",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Bairro *"}),e.jsx(L,{...r,disabled:V==="search"}),e.jsx(E,{})]})}),e.jsx(R,{control:o.control,name:"city",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Cidade *"}),e.jsx(L,{...r,disabled:V==="search"}),e.jsx(E,{})]})})]}),e.jsx(R,{control:o.control,name:"zip_code",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"CEP *"}),e.jsx(Ue,{...r,disabled:V==="search"}),e.jsx(E,{})]})}),js&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(tr,{center:Te,markerPosition:Te,onLocationChange:Vs,isInteractive:!1}),F!==null&&I!==null&&e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",F==null?void 0:F.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",I==null?void 0:I.toFixed(6)]})]})]}),S&&e.jsxs(re,{children:[e.jsx(de,{className:"h-4 w-4 animate-spin"}),e.jsx(ae,{children:"Calculando Taxa..."}),e.jsx(oe,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),v&&e.jsxs(re,{variant:"destructive",children:[e.jsx(Ze,{className:"h-4 w-4"}),e.jsx(ae,{children:"Erro de Entrega"}),e.jsx(oe,{children:v})]}),u>0&&!S&&e.jsxs(re,{className:"mt-4",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx(ae,{children:"Taxa de Entrega Aplicada"}),e.jsxs(oe,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u)]})]}),!Ne&&e.jsxs(re,{className:"mt-4",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx(ae,{children:"Taxas de Entrega Desativadas"}),e.jsx(oe,{children:"No momento, as taxas de entrega estão desativadas. A entrega será gratuita."})]})]})]})]}),e.jsxs(pe,{children:[e.jsx(he,{children:e.jsx(fe,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(xe,{className:"space-y-4",children:[e.jsx(R,{control:o.control,name:"payment_method_id",render:({field:r})=>e.jsxs(j,{className:"space-y-3",children:[e.jsx(q,{children:e.jsx(ge,{onValueChange:l=>{r.onChange(l);const m=U.find(f=>f.id===l);(m==null?void 0:m.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0})},defaultValue:r.value,className:"flex flex-col space-y-2",children:U.map(l=>{const m=Fr(l.icon||"Store");return e.jsxs(j,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(q,{children:e.jsx(W,{value:l.id})}),e.jsx(m,{className:"h-5 w-5 text-primary"}),e.jsxs(C,{className:"font-normal flex-1 cursor-pointer",children:[l.name,e.jsx("span",{className:"block text-xs text-muted-foreground",children:l.description})]})]},l.id)})})}),e.jsx(E,{})]})}),te&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4"})," Detalhes Adicionais"]}),e.jsx(R,{control:o.control,name:"cpf_cnpj",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"CPF/CNPJ * (obrigatório para pagamento online)"}),e.jsx(q,{children:e.jsx(xs,{...r})}),e.jsx(E,{})]})})]}),ne&&e.jsx(R,{control:o.control,name:"change_for",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Precisa de troco para quanto? (R$)"}),e.jsx(L,{type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2}).format(c),...r,value:r.value===null||r.value===void 0?"":String(r.value),onChange:l=>r.onChange(l.target.value===""?null:l.target.value)}),e.jsx(E,{})]})}),e.jsx(R,{control:o.control,name:"notes",render:({field:r})=>e.jsxs(j,{children:[e.jsx(C,{children:"Observações do Pedido (Opcional)"}),e.jsx(rr,{placeholder:"Ex: Tocar a campainha duas vezes...",...r,rows:2}),e.jsx(E,{})]})})]})]}),e.jsx("div",{className:"lg:hidden sticky bottom-0 bg-card p-4 border-t shadow-2xl",children:e.jsx(ue,{type:"submit",className:"w-full h-12 text-lg",disabled:!ze,children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)}`})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(ue,{type:"submit",className:"w-full h-12 text-lg",disabled:!ze,children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)}`})})]})})}),e.jsx("div",{className:"lg:col-span-1 hidden lg:block",children:e.jsx(Ir,{...t})})]})})]})};export{na as default};
