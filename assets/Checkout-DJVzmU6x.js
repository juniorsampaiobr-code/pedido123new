import{u as Q,j as e,a as xt,b as Re}from"./tanstack-C7aOFagJ.js";import{r as p,R as yt,h as gt,L as jt}from"./vendor-DjsPZZVP.js";import{c as vt,s as S,Z as Ae,_ as fe,$ as ae,a0 as ue,a1 as wt,a2 as _t,a7 as bt,a3 as Nt,a as he,u as R,D as Se,n as Ie,g as me,p as Et,q as Ct,r as Rt,B as X,o as St,j as k,H as It,at as Pt,G as Mt,k as kt,au as te,av as Dt,aw as Ft,m as Ot,h as Pe,M as U,O as Z,Q as re,a4 as At,ax as Lt,U as Me,ay as Tt,C as A,d as L,e as T,b as q,L as E,I as G,az as H,P as qt,aA as Gt,R as ke,a5 as Bt,T as $t,t as zt}from"./index-CV42jepX.js";import{c as Le,R as Kt,I as Vt}from"./index-DsAmbHHE.js";import{u as Ut}from"./index-C3WaO5Hu.js";import{S as De}from"./separator-CFvWQo-D.js";import{Z as Zt}from"./ZipCodeInput-BEbzXXX1.js";import{C as Te}from"./credit-card-BKfn9w5x.js";import{T as le}from"./truck-DVrElWVN.js";import{C as Fe}from"./circle-alert-TK9EuB3G.js";import{M as Ht}from"./mail-DkfT3NkL.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=vt("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),Xt=async()=>{const{data:t,error:o}=await S.from("restaurants").select("id").limit(1).single();if(o||!t)return console.error("Failed to fetch restaurant ID for payment settings."),null;const r=t.id,{data:a,error:i}=await S.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(i&&i.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${i.message}`);return(a==null?void 0:a.mercado_pago_public_key)||null},qe=()=>Q({queryKey:["mercadoPagoPublicKey"],queryFn:Xt,staleTime:1/0}),Wt=(t,o,r,a)=>{const n=(r-t)*(Math.PI/180),d=(a-o)*(Math.PI/180),f=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t*(Math.PI/180))*Math.cos(r*(Math.PI/180))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)))},Jt=async t=>{const o=t.replace(/\s+/g," ").trim(),r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&limit=1`,a=new AbortController,i=setTimeout(()=>a.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",r);const n=await fetch(r,{signal:a.signal});if(!n.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",n.status),null;const d=await n.json();if(d&&Array.isArray(d)&&d.length>0){const f=d[0],h=parseFloat(f.lat),m=parseFloat(f.lon);if(Number.isFinite(h)&&Number.isFinite(m))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[h,m]),{lat:h,lng:m}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",o),null}catch(n){return n instanceof Error&&n.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",o):console.error("LOG: geocodeAddress - Erro durante a requisição:",n),null}finally{clearTimeout(i)}},Yt=(t,o,r)=>{const a=Wt(o[0],o[1],t[0],t[1]),i=r.find(n=>a<=n.max_distance_km);if(i){const n=i.delivery_fee||0,d=i.min_delivery_time_minutes||0,f=d+15;return{fee:parseFloat(n.toFixed(2)),minTime:d,maxTime:f}}return null};var xe="Radio",[er,Ge]=Ae(xe),[tr,rr]=er(xe),Be=p.forwardRef((t,o)=>{const{__scopeRadio:r,name:a,checked:i=!1,required:n,disabled:d,value:f="on",onCheck:h,form:m,...l}=t,[x,C]=p.useState(null),v=fe(o,P=>C(P)),N=p.useRef(!1),I=x?m||!!x.closest("form"):!0;return e.jsxs(tr,{scope:r,checked:i,disabled:d,children:[e.jsx(ae.button,{type:"button",role:"radio","aria-checked":i,"data-state":Ve(i),"data-disabled":d?"":void 0,disabled:d,value:f,...l,ref:v,onClick:ue(t.onClick,P=>{i||h==null||h(),I&&(N.current=P.isPropagationStopped(),N.current||P.stopPropagation())})}),I&&e.jsx(Ke,{control:x,bubbles:!N.current,name:a,value:f,checked:i,required:n,disabled:d,form:m,style:{transform:"translateX(-100%)"}})]})});Be.displayName=xe;var $e="RadioIndicator",ze=p.forwardRef((t,o)=>{const{__scopeRadio:r,forceMount:a,...i}=t,n=rr($e,r);return e.jsx(wt,{present:a||n.checked,children:e.jsx(ae.span,{"data-state":Ve(n.checked),"data-disabled":n.disabled?"":void 0,...i,ref:o})})});ze.displayName=$e;var nr="RadioBubbleInput",Ke=p.forwardRef(({__scopeRadio:t,control:o,checked:r,bubbles:a=!0,...i},n)=>{const d=p.useRef(null),f=fe(d,n),h=Ut(r),m=_t(o);return p.useEffect(()=>{const l=d.current;if(!l)return;const x=window.HTMLInputElement.prototype,v=Object.getOwnPropertyDescriptor(x,"checked").set;if(h!==r&&v){const N=new Event("click",{bubbles:a});v.call(l,r),l.dispatchEvent(N)}},[h,r,a]),e.jsx(ae.input,{type:"radio","aria-hidden":!0,defaultChecked:r,...i,tabIndex:-1,ref:f,style:{...i.style,...m,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Ke.displayName=nr;function Ve(t){return t?"checked":"unchecked"}var or=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],se="RadioGroup",[ar,Zr]=Ae(se,[Le,Ge]),Ue=Le(),Ze=Ge(),[sr,ir]=ar(se),He=p.forwardRef((t,o)=>{const{__scopeRadioGroup:r,name:a,defaultValue:i,value:n,required:d=!1,disabled:f=!1,orientation:h,dir:m,loop:l=!0,onValueChange:x,...C}=t,v=Ue(r),N=bt(m),[I,P]=Nt({prop:n,defaultProp:i??null,onChange:x,caller:se});return e.jsx(sr,{scope:r,name:a,required:d,disabled:f,value:I,onValueChange:P,children:e.jsx(Kt,{asChild:!0,...v,orientation:h,dir:N,loop:l,children:e.jsx(ae.div,{role:"radiogroup","aria-required":d,"aria-orientation":h,"data-disabled":f?"":void 0,dir:N,...C,ref:o})})})});He.displayName=se;var Qe="RadioGroupItem",Xe=p.forwardRef((t,o)=>{const{__scopeRadioGroup:r,disabled:a,...i}=t,n=ir(Qe,r),d=n.disabled||a,f=Ue(r),h=Ze(r),m=p.useRef(null),l=fe(o,m),x=n.value===i.value,C=p.useRef(!1);return p.useEffect(()=>{const v=I=>{or.includes(I.key)&&(C.current=!0)},N=()=>C.current=!1;return document.addEventListener("keydown",v),document.addEventListener("keyup",N),()=>{document.removeEventListener("keydown",v),document.removeEventListener("keyup",N)}},[]),e.jsx(Vt,{asChild:!0,...f,focusable:!d,active:x,children:e.jsx(Be,{disabled:d,required:n.required,checked:x,...h,...i,name:n.name,ref:l,onCheck:()=>n.onValueChange(i.value),onKeyDown:ue(v=>{v.key==="Enter"&&v.preventDefault()}),onFocus:ue(i.onFocus,()=>{var v;C.current&&((v=m.current)==null||v.click())})})})});Xe.displayName=Qe;var cr="RadioGroupIndicator",We=p.forwardRef((t,o)=>{const{__scopeRadioGroup:r,...a}=t,i=Ze(r);return e.jsx(ze,{...i,...a,ref:o})});We.displayName=cr;var Je=He,Ye=Xe,dr=We;const pe=p.forwardRef(({className:t,...o},r)=>e.jsx(Je,{className:he("grid gap-2",t),...o,ref:r}));pe.displayName=Je.displayName;const oe=p.forwardRef(({className:t,...o},r)=>e.jsx(Ye,{ref:r,className:he("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...o,children:e.jsx(dr,{className:"flex items-center justify-center",children:e.jsx(Qt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));oe.displayName=Ye.displayName;var ye={};Object.defineProperty(ye,"__esModule",{value:!0});var et=ye.loadMercadoPago=void 0;const tt="https://sdk.mercadopago.com/js/v2",lr=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Oe="MercadoPago has already been initialized in your window, please remove the duplicate import",ur="MercadoPago.js not available",mr="Failed to load MercadoPago.js",pr=()=>{for(var t=document.querySelectorAll(`script[src^="${tt}"`),o=0;o<t.length;o++){var r=t[o];if(lr.test(r.src))return r}return null},fr=()=>{const t=document.createElement("script");t.src=tt;const o=document.head||document.body;if(!o)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return o.appendChild(t),t};let ne=null;const hr=()=>(ne!==null||(ne=new Promise((t,o)=>{if(typeof window>"u"){t(null);return}if(window.MercadoPago){console.warn(Oe),t(window.MercadoPago);return}try{let r=pr();r?console.warn(Oe):r||(r=fr()),r.addEventListener("load",()=>{window.MercadoPago?t(window.MercadoPago):o(new Error(ur))}),r.addEventListener("error",()=>{o(new Error(mr))})}catch(r){o(r);return}})),ne);et=ye.loadMercadoPago=hr;var xr=function(t,o,r,a){function i(n){return n instanceof r?n:new r(function(d){d(n)})}return new(r||(r=Promise))(function(n,d){function f(l){try{m(a.next(l))}catch(x){d(x)}}function h(l){try{m(a.throw(l))}catch(x){d(x)}}function m(l){l.done?n(l.value):i(l.value).then(f,h)}m((a=a.apply(t,o||[])).next())})};class F{static getInstance(){return xr(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield et(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}F.publicKey=null;F.options={};F.instanceMercadoPago=void 0;F.loadedInstanceMercadoPago=!1;function yr(t,o){return Object.keys(t).length===Object.keys(o).length&&Object.keys(t).every(a=>Object.prototype.hasOwnProperty.call(o,a)&&t[a]===o[a])}const gr=(t,o)=>{const r=Object.assign(Object.assign({},o),{frontEndStack:"react"}),a=!yr(F.options,r);(t!==F.publicKey||a)&&(F.publicKey=t,F.options=r,F.instanceMercadoPago=void 0)};var jr=function(t,o,r,a){function i(n){return n instanceof r?n:new r(function(d){d(n)})}return new(r||(r=Promise))(function(n,d){function f(l){try{m(a.next(l))}catch(x){d(x)}}function h(l){try{m(a.throw(l))}catch(x){d(x)}}function m(l){l.done?n(l.value):i(l.value).then(f,h)}m((a=a.apply(t,o||[])).next())})};const vr=()=>jr(void 0,void 0,void 0,function*(){}),wr=()=>{},_r=t=>{console.error(t)};var br=function(t,o,r,a){function i(n){return n instanceof r?n:new r(function(d){d(n)})}return new(r||(r=Promise))(function(n,d){function f(l){try{m(a.next(l))}catch(x){d(x)}}function h(l){try{m(a.throw(l))}catch(x){d(x)}}function m(l){l.done?n(l.value):i(l.value).then(f,h)}m((a=a.apply(t,o||[])).next())})};const Nr=({settings:t,name:o,containerId:r,controller:a})=>br(void 0,void 0,void 0,function*(){const i=yield F.getInstance(),n=i==null?void 0:i.bricks();window[a]=yield n==null?void 0:n.create(o,r,t)}),Er=200,Cr=({onReady:t=wr,onError:o=_r,onSubmit:r=vr,customization:a,initialization:i,locale:n,id:d="walletBrick_container"})=>(p.useEffect(()=>{const f={settings:{initialization:i,customization:a,locale:n,callbacks:{onReady:t,onSubmit:r,onError:o}},name:"wallet",containerId:d,controller:"walletBrickController"},h=setTimeout(()=>{Nr(f)},Er);return()=>{var m;clearTimeout(h),(m=window.walletBrickController)===null||m===void 0||m.unmount()}},[a,i,t,o,r]),yt.createElement("div",{id:d})),Rr=({preferenceId:t,initPoint:o,onClose:r})=>{const{data:a,isLoading:i}=qe();return p.useEffect(()=>{if(a)try{gr(a,{locale:"pt-BR"})}catch(n){console.error("Erro ao inicializar Mercado Pago:",n),R.error("Erro ao carregar o SDK do Mercado Pago."),r()}},[a,r]),i||!a?e.jsx(Se,{open:!0,onOpenChange:r,children:e.jsx(Ie,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(me,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(Se,{open:!0,onOpenChange:r,children:e.jsxs(Ie,{className:"sm:max-w-[425px]",children:[e.jsxs(Et,{children:[e.jsxs(Ct,{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5 text-primary"}),"Pagamento Online"]}),e.jsx(Rt,{children:"Você será redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsx("div",{className:"py-4",children:e.jsx(Cr,{initialization:{preferenceId:t},customization:{texts:{valueProp:"smart_option"}}})}),e.jsx(X,{variant:"outline",onClick:r,children:"Cancelar Pagamento"})]})})},Sr=St({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:k().email("Email inválido.").optional().or(It("")),cpf_cnpj:k().optional().default("").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Pt(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),zip_code:k().optional(),street:k().optional(),number:k().optional(),neighborhood:k().optional(),city:k().optional(),notes:k().optional(),payment_method_id:k().min(1,"Selecione um método de pagamento."),change_for:Mt(t=>String(t).replace(",","."),kt.number().optional().nullable())}).superRefine((t,o)=>{t.delivery_option==="delivery"&&((!t.zip_code||t.zip_code.replace(/\D/g,"").length!==8)&&o.addIssue({code:te.custom,message:"CEP é obrigatório para entrega.",path:["zip_code"]}),t.street||o.addIssue({code:te.custom,message:"Rua é obrigatória para entrega.",path:["street"]}),t.number||o.addIssue({code:te.custom,message:"Número é obrigatório para entrega.",path:["number"]}),t.neighborhood||o.addIssue({code:te.custom,message:"Bairro é obrigatório para entrega.",path:["neighborhood"]}))}),Ir=async()=>{const{data:t,error:o}=await S.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1).single();if(o)throw new Error(`Erro ao buscar restaurante: ${o.message}`);if(!t)throw new Error("Nenhum restaurante ativo encontrado.");return t},Pr=async t=>{const{data:o,error:r}=await S.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return o},Mr=async t=>{const{data:o,error:r}=await S.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(r)throw new Error(`Erro ao buscar métodos de pagamento: ${r.message}`);return o},kr=async t=>{const{data:o,error:r}=await S.from("customers").select("*").eq("user_id",t).limit(1).single();if(r&&r.code!=="PGRST116")throw new Error(r.message);return o||null},Hr=()=>{var Ee,Ce;const t=gt(),o=xt(),{items:r,totalAmount:a,clearCart:i}=Dt(),{data:n,isLoading:d}=Ft(),{data:f}=qe(),[h,m]=p.useState(!1),[l,x]=p.useState(!1),[C,v]=p.useState(0),[N,I]=p.useState(null),[P,B]=p.useState(!0),[W,rt]=p.useState(null),[nt,ie]=p.useState(!1),[ot,at]=p.useState(null),[ge,st]=p.useState(null),{data:g,isLoading:it,isError:ct,error:je,refetch:dt}=Q({queryKey:["checkoutRestaurantData"],queryFn:Ir,staleTime:1/0}),{data:J,isLoading:lt}=Q({queryKey:["checkoutDeliveryZones"],queryFn:()=>Pr(g.id),enabled:!!g,staleTime:1/0}),{data:$,isLoading:ut}=Q({queryKey:["checkoutPaymentMethods"],queryFn:()=>Mr(g.id),enabled:!!g,staleTime:1/0}),{data:M,isLoading:ve,refetch:Dr}=Q({queryKey:["checkoutCustomerData",n==null?void 0:n.id],queryFn:()=>kr(n.id),enabled:!!n,staleTime:0}),c=Ot({resolver:zt(Sr),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",zip_code:"",street:"",number:"",neighborhood:"",city:"",notes:"",payment_method_id:"",change_for:null},mode:"onBlur"}),V=c.watch("delivery_option"),mt=c.watch("payment_method_id"),z=$==null?void 0:$.find(s=>s.id===mt),ce=(Ee=z==null?void 0:z.name)==null?void 0:Ee.includes("online"),Y=(Ce=z==null?void 0:z.name)==null?void 0:Ce.includes("Dinheiro"),O=a+C;p.useEffect(()=>{if(M){let s="",u="",_="",j="",b="";if(M.address){const y=M.address.split(", ").map(w=>w.trim());y.length>=5?(s=y[0],u=y[1],_=y[2],j=y[3],b=y[4]):y.length>=4&&(s=y[0],_=y[1],j=y[2],b=y[3])}c.reset({...c.getValues(),name:M.name||"",phone:M.phone||"",email:M.email||"",cpf_cnpj:M.cpf_cnpj||"",street:s,number:u,neighborhood:_,city:j,zip_code:b})}else n&&!ve&&c.setValue("email",n.email||"")},[M,c,n,ve]);const we=c.watch(["zip_code","street","number","city"]),de=p.useMemo(()=>g!=null&&g.latitude&&(g!=null&&g.longitude)?[g.latitude,g.longitude]:null,[g]),K=p.useCallback(async()=>{if(V==="pickup"||!g||!de||!g.delivery_enabled){v(0),B(!0),I(null);return}const[s,u,_,j]=we,b=`${u}, ${_}, ${j}, ${s}`;if(!s||s.replace(/\D/g,"").length!==8||!u||!_||!j){v(0),B(!0);return}x(!0);const y=R.loading("Calculando taxa de entrega..."),w=await Jt(b);if(x(!1),R.dismiss(y),!w){v(0),B(!1),I(null),R.error("Não foi possível encontrar o endereço. Verifique o CEP e o número.");return}if(rt([w.lat,w.lng]),J&&J.length>0){const D=Yt([w.lat,w.lng],de,J);D?(v(D.fee),I([D.minTime,D.maxTime]),B(!0)):(v(0),I(null),B(!1),R.error("Endereço fora da área de entrega."))}else v(0),I(null),B(!0)},[V,we,g,de,J]);p.useEffect(()=>{K()},[K]);const ee=c.watch("change_for");p.useEffect(()=>{Y&&ee!==null&&ee!==void 0&&ee<O?c.setError("change_for",{message:"O valor do troco deve ser maior ou igual ao total do pedido."}):c.clearErrors("change_for")},[Y,ee,O,c]);const _e=Re({mutationFn:async s=>{var b;const u=s.phone.replace(/\D/g,""),_=((b=s.cpf_cnpj)==null?void 0:b.replace(/\D/g,""))||null,j={user_id:(n==null?void 0:n.id)||null,name:s.name,phone:u,email:s.email||null,cpf_cnpj:_,address:s.delivery_option==="delivery"?`${s.street}, ${s.number}, ${s.neighborhood}, ${s.city}, ${s.zip_code}`:null,latitude:W?W[0]:null,longitude:W?W[1]:null};if(n)if(M){const{data:y,error:w}=await S.from("customers").update(j).eq("id",M.id).select().single();if(w)throw w;return y}else{const{data:y,error:w}=await S.from("customers").insert(j).select().single();if(w)throw w;return y}else{const{data:y,error:w}=await S.from("customers").insert(j).select().single();if(w)throw w;return y}},onSuccess:()=>{o.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:s=>{R.error(`Erro ao salvar dados do cliente: ${s.message}`)}}),be=Re({mutationFn:async({customerId:s,data:u})=>{if(!g)throw new Error("Dados do restaurante não disponíveis.");const _={restaurant_id:g.id,customer_id:s,status:ce?"pending_payment":"pending",total_amount:O,delivery_fee:C,delivery_address:u.delivery_option==="delivery"?`${u.street}, ${u.number}, ${u.neighborhood}, ${u.city}, ${u.zip_code}`:null,notes:u.notes,payment_method_id:u.payment_method_id,change_for:Y&&u.change_for&&u.change_for>O?u.change_for:null},{data:j,error:b}=await S.from("orders").insert(_).select("id").single();if(b)throw b;const y=r.map(D=>({order_id:j.id,product_id:D.product.id,quantity:D.quantity,unit_price:D.product.price,subtotal:D.subtotal,notes:D.notes})),{error:w}=await S.from("order_items").insert(y);if(w)throw w;return j.id},onSuccess:s=>{o.invalidateQueries({queryKey:["orders"]})},onError:s=>{R.error(`Erro ao criar pedido: ${s.message}`)}}),pt=async s=>{if(r.length===0){R.error("Seu carrinho está vazio."),t("/menu");return}if(V==="delivery"&&!P){R.error("O endereço de entrega está fora da área de cobertura.");return}let u;try{u=(await _e.mutateAsync(s)).id}catch(j){R.error(`Falha ao salvar cliente: ${j.message}`);return}let _;try{_=await be.mutateAsync({customerId:u,data:s})}catch(j){R.error(`Falha ao criar pedido: ${j.message}`);return}ce?await ft(_,s):(i(),t(`/order-success/${_}`,{replace:!0}))},ft=async(s,u)=>{if(!g)return;ie(!0);const _=window.location.origin+window.location.pathname,j=r.map(b=>({name:b.product.name,price:b.product.price,quantity:b.quantity}));try{const{data:b,error:y}=await S.functions.invoke("create-payment-preference",{body:{orderId:s,items:j,totalAmount:O,restaurantName:g.name,clientUrl:_,customerEmail:u.email||(n==null?void 0:n.email)||"cliente@anonimo.com",customerCpfCnpj:u.cpf_cnpj}});if(y)throw y;const{init_point:w}=b;at(s),st(w)}catch(b){console.error("Erro ao criar preferência MP:",b),R.error(`Erro no pagamento online: ${b.message}`),ie(!1)}},ht=async()=>{await S.auth.signOut(),R.success("Você saiu da sua conta."),t("/auth",{replace:!0})};if(r.length===0)return p.useEffect(()=>{t("/menu",{replace:!0})},[t]),e.jsx(Pe,{});if(it||lt||ut||d)return e.jsx(Pe,{});if(ct||!g)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(U,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Terminal,{className:"h-4 w-4"}),e.jsx(Z,{children:"Erro Crítico"}),e.jsx(re,{children:je instanceof Error?je.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(X,{onClick:()=>dt(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(At,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ne=_e.isPending||be.isPending||l||V==="delivery"&&!P;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Lt,{isOpen:h,onClose:()=>m(!1),customer:M}),nt&&ge&&e.jsx(Rr,{preferenceId:ot,initPoint:ge,onClose:()=>ie(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),n&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{variant:"outline",size:"icon",onClick:()=>m(!0),"aria-label":"Meu Perfil",children:e.jsx(Me,{className:"h-4 w-4"})}),e.jsxs(X,{variant:"outline",size:"sm",onClick:ht,children:[e.jsx(Tt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(A,{children:[e.jsx(L,{children:e.jsxs(T,{className:"text-xl flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(q,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:n?`Logado como ${n.email}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:c.handleSubmit(pt),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(G,{id:"name",...c.register("name")}),c.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"phone",children:"Telefone *"}),e.jsx(H,{name:"phone",control:c.control,render:({field:s})=>e.jsx(qt,{id:"phone",...s})}),c.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(G,{id:"email",type:"email",...c.register("email")}),c.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(H,{name:"cpf_cnpj",control:c.control,render:({field:s})=>e.jsx(Gt,{id:"cpf_cnpj",...s})}),c.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(A,{children:[e.jsx(L,{children:e.jsxs(T,{className:"text-xl flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(q,{children:e.jsx(H,{name:"delivery_option",control:c.control,render:({field:s})=>e.jsxs(pe,{onValueChange:s.onChange,value:s.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(E,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(oe,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(le,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(E,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(oe,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(ke,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),V==="delivery"&&e.jsxs(A,{children:[e.jsx(L,{children:e.jsxs(T,{className:"text-xl flex items-center gap-2",children:[e.jsx(ke,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega"]})}),e.jsxs(q,{className:"space-y-4",children:[!g.delivery_enabled&&e.jsxs(U,{variant:"destructive",children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx(Z,{children:"Entrega Desativada"}),e.jsx(re,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(E,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(H,{name:"zip_code",control:c.control,render:({field:s})=>e.jsx(Zt,{id:"zip_code",...s,onBlur:K})}),c.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(E,{htmlFor:"street",children:"Rua *"}),e.jsx(G,{id:"street",...c.register("street"),onBlur:K}),c.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"number",children:"Número *"}),e.jsx(G,{id:"number",...c.register("number"),onBlur:K}),c.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(E,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(G,{id:"neighborhood",...c.register("neighborhood"),onBlur:K}),c.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"city",children:"Cidade"}),e.jsx(G,{id:"city",...c.register("city")})]}),l&&e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4 animate-spin"}),e.jsx(Z,{children:"Calculando Taxa de Entrega..."})]}),!P&&!l&&e.jsxs(U,{variant:"destructive",children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx(Z,{children:"Fora da Área de Entrega"}),e.jsx(re,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),N&&P&&!l&&e.jsxs(U,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(Z,{children:"Entrega Disponível"}),e.jsxs(re,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C),". Tempo estimado: ",N[0]," - ",N[1]," minutos."]})]})]})]}),e.jsxs(A,{children:[e.jsx(L,{children:e.jsxs(T,{className:"text-xl flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(q,{children:[e.jsx(H,{name:"payment_method_id",control:c.control,render:({field:s})=>e.jsx(pe,{onValueChange:s.onChange,value:s.value,className:"space-y-3",children:$==null?void 0:$.map(u=>{var j;const _=((j=u.name)==null?void 0:j.includes("online"))&&!f;return e.jsx(E,{htmlFor:u.id,className:he("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",_&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(oe,{value:u.id,id:u.id,disabled:_}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:u.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u.description}),_&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},u.id)})})}),c.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:c.formState.errors.payment_method_id.message})]})]}),Y&&e.jsxs(A,{children:[e.jsx(L,{children:e.jsxs(T,{className:"text-xl flex items-center gap-2",children:[e.jsx(Bt,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(G,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(O),...c.register("change_for",{valueAsNumber:!0})}),c.formState.errors.change_for&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.change_for.message})]})})]}),e.jsxs(A,{children:[e.jsx(L,{children:e.jsxs(T,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ht,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx($t,{id:"notes",...c.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(A,{className:"shadow-lg",children:[e.jsx(L,{children:e.jsx(T,{className:"text-2xl",children:"Resumo"})}),e.jsxs(q,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:r.map(s=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[s.quantity,"x ",s.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s.subtotal)})]},s.product.id))}),e.jsx(De,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(C)})]})]}),e.jsx(De,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(O)})]}),e.jsx(X,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ne,children:Ne?e.jsx(me,{className:"h-5 w-5 animate-spin mr-2"}):ce?"Pagar e Finalizar":"Confirmar Pedido"}),e.jsx(jt,{to:`/menu/${g.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{Hr as default};
