import{j as e,u as H,b as J,c as W}from"./tanstack-d4AvmB45.js";import{o as X,s as h,l as Y,b as ee,p as A,c as D,u as re,t as se}from"./types-DKlirIXB.js";import{s as y}from"./client-D5i5GwB9.js";import{B as oe}from"./button-D_vNnRms.js";import{C as V,b as q,c as I,a as R}from"./card-5zdX1mCS.js";import{I as g,L as ae}from"./label-CfDoPnsH.js";import{T as te}from"./textarea-C6Jv2INE.js";import{S as ne}from"./switch-Bp7Lyql3.js";import{u as b,L as ie}from"./index-iuYFWvRc.js";import{F as le,a as l,b as c,c as d,d as m,e as u}from"./form-CNi6rS0S.js";import{S as ce}from"./skeleton-v8u8bZhP.js";import{r as n,i as de}from"./vendor-CnEXr6gt.js";import{L as me,g as ue,Z as he}from"./location-CBB945Ne.js";import{M as pe,P as xe}from"./PhoneInput-CUWWn4aw.js";import{M as ge}from"./map-pin-CPcG0sO3.js";import{P as je}from"./phone-F9KJlSj8.js";import"./supabase-BZV_3FV3.js";import"./index-KNP7Yozt.js";const fe=({markerPosition:o,onLocationChange:t,restaurant:i})=>{const v=n.useMemo(()=>[i.street,i.number,i.neighborhood,i.city,i.zip_code].filter(Boolean).join(", "),[i]);return e.jsxs(V,{className:"mt-6",children:[e.jsx(q,{children:e.jsxs(I,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(R,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(me,{center:o,markerPosition:o,onMarkerDragEnd:t,zoom:15})}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[100%] truncate",children:["Endereço atual: ",v||"N/A"]})})]})]})},be=n.memo(fe),Ne=o=>o.replace(/\D/g,""),ye=X({name:h().min(1,"O nome do restaurante é obrigatório."),description:h().optional(),street:h().min(1,"A rua é obrigatória."),number:h().min(1,"O número é obrigatório."),neighborhood:h().min(1,"O bairro é obrigatório."),city:h().min(1,"A cidade é obrigatória."),zip_code:h().min(1,"O CEP é obrigatório.").transform(o=>o.replace(/\D/g,"")).refine(o=>o.length===8,{message:"O CEP deve ter 8 dígitos."}),phone:h().min(1,"Telefone é obrigatório.").transform(Ne).refine(o=>o.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:h().email("Email inválido.").optional().or(Y("")),is_active:ee().default(!0),latitude:A(o=>String(o).replace(",","."),D.number({invalid_type_error:"Latitude deve ser um número."}).refine(o=>o!==null,{message:"A localização no mapa é obrigatória. Mova o pino no mapa para definir a localização."})),longitude:A(o=>String(o).replace(",","."),D.number({invalid_type_error:"Longitude deve ser um número."}).refine(o=>o!==null,{message:"A localização no mapa é obrigatória. Mova o pino no pino para definir a localização."}))}),ve=async o=>{const{data:t,error:i}=await y.from("restaurants").select("*").eq("id",o).single();if(i)throw new Error(`Erro ao buscar dados do restaurante: ${i.message}`);if(!t)throw new Error("Nenhum restaurante encontrado.");return t},Be=()=>{const o=H(),{userRestaurantId:t}=de(),[i,v]=n.useState(!1),[B,O]=n.useState(null),[N,L]=n.useState(!1),{data:a,isLoading:w,isError:F,error:k}=J({queryKey:["restaurantSettings",t],queryFn:()=>ve(t),enabled:!!t,staleTime:1e3*60*5});n.useEffect(()=>{y.auth.getSession().then(({data:{session:r}})=>{var p;O(((p=r==null?void 0:r.user)==null?void 0:p.email)||null)})},[]);const s=re({resolver:se(ye),defaultValues:{name:"",description:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});n.useEffect(()=>{a&&(s.reset({name:a.name||"",description:a.description||"",street:a.street||"",number:a.number||"",neighborhood:a.neighborhood||"",city:a.city||"",zip_code:a.zip_code||"",phone:a.phone||"",email:a.email||"",is_active:a.is_active??!0,latitude:a.latitude??null,longitude:a.longitude??null}),a.latitude&&a.longitude&&v(!0))},[a,s.reset]);const j=s.watch("latitude"),f=s.watch("longitude"),Q=s.watch(["street","number","neighborhood","city","zip_code"]),[E,C,_,S,z]=Q,U=[-23.55052,-46.633308],G=n.useMemo(()=>typeof j=="number"&&typeof f=="number"&&!isNaN(j)&&!isNaN(f)?[j,f]:U,[j,f]),K=n.useCallback((r,p)=>{s.setValue("latitude",r,{shouldValidate:!0}),s.setValue("longitude",p,{shouldValidate:!0})},[s]),T=n.useCallback(async()=>{if(!E||!C||!_||!S||z.replace(/\D/g,"").length!==8)return;const r=`${E}, ${C}, ${_}, ${S}, ${z}`;if(N)return;L(!0);const p=b.loading("Buscando coordenadas do endereço...");try{const x=await ue(r);x?(s.setValue("latitude",x.lat,{shouldValidate:!0}),s.setValue("longitude",x.lng,{shouldValidate:!0}),b.success("Localização do mapa atualizada!")):b.warning("Não foi possível encontrar o endereço no mapa. Verifique os campos.")}catch(x){console.error("Geocoding error:",x),b.error("Erro ao buscar coordenadas.")}finally{L(!1),b.dismiss(p)}},[E,C,_,S,z,s,N]);n.useEffect(()=>{const r=setTimeout(()=>{T()},500);return()=>{clearTimeout(r)}},[T]);const M=W({mutationFn:async r=>{if(!t)throw new Error("ID do restaurante não disponível.");const p={name:r.name,description:r.description,logo_url:null,street:r.street,number:r.number,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code.replace(/\D/g,""),phone:r.phone,email:r.email,is_active:r.is_active,latitude:r.latitude,longitude:r.longitude,address:`${r.street}, ${r.number}, ${r.neighborhood}, ${r.city}, ${r.zip_code}`},{error:x}=await y.from("restaurants").update(p).eq("id",t);if(x)throw x;const{data:{user:P}}=await y.auth.getUser();if(P){const Z={phone:r.phone},{error:$}=await y.from("profiles").update(Z).eq("id",P.id);$&&console.warn("Falha ao sincronizar telefone com o perfil:",$.message)}},onSuccess:()=>{b.success("Configurações salvas com sucesso!"),o.invalidateQueries({queryKey:["restaurantSettings",t]}),o.invalidateQueries({queryKey:["adminProfile"]})},onError:r=>b.error(`Erro ao salvar configurações: ${r.message}`)});return n.useMemo(()=>j===null||f===null?"map-settings-null":`map-settings-${j.toFixed(6)}-${f.toFixed(6)}`,[j,f]),e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(V,{children:[e.jsx(q,{children:e.jsx(I,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(R,{children:[w&&e.jsx(ce,{className:"h-96 w-full"}),F&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",k.message]}),!t&&!w&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),a&&!F&&!w&&e.jsx(le,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(r=>M.mutate(r)),className:"space-y-6",children:[e.jsx(l,{control:s.control,name:"name",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Nome do Restaurante *"}),e.jsx(m,{children:e.jsx(g,{...r})}),e.jsx(u,{})]})}),e.jsx(l,{control:s.control,name:"description",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Descrição"}),e.jsx(m,{children:e.jsx(te,{...r,rows:3})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Contato e Status"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ae,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(pe,{className:"h-4 w-4"}),"Email do Administrador"]}),e.jsx(g,{value:B||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este é o email de login do administrador."})]}),e.jsx(l,{control:s.control,name:"phone",render:({field:r})=>e.jsxs(c,{children:[e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4"}),"Telefone do Restaurante *"]}),e.jsx(m,{children:e.jsx(xe,{...r})}),e.jsx(u,{})]})})]}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{control:s.control,name:"street",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Rua *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Nome da rua",...r})}),e.jsx(u,{})]})}),e.jsx(l,{control:s.control,name:"number",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Número *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Número",...r})}),e.jsx(u,{})]})}),e.jsx(l,{control:s.control,name:"neighborhood",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Bairro *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Bairro",...r})}),e.jsx(u,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:s.control,name:"city",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Cidade *"}),e.jsx(m,{children:e.jsx(g,{placeholder:"Cidade",...r})}),e.jsx(u,{})]})}),e.jsx(l,{control:s.control,name:"zip_code",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"CEP *"}),e.jsx(m,{children:e.jsx(he,{placeholder:"00000-000",...r})}),e.jsx(u,{})]})})]}),e.jsx("div",{className:"pt-4 border-t",children:i&&e.jsx(be,{markerPosition:G,onLocationChange:K,restaurant:a})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{control:s.control,name:"latitude",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Latitude *"}),e.jsx(m,{children:e.jsx(g,{...r,placeholder:"-22.7627908",value:r.value??"",disabled:N})}),e.jsx(u,{})]})}),e.jsx(l,{control:s.control,name:"longitude",render:({field:r})=>e.jsxs(c,{children:[e.jsx(d,{children:"Longitude *"}),e.jsx(m,{children:e.jsx(g,{...r,placeholder:"-47.408315",value:r.value??"",disabled:N})}),e.jsx(u,{})]})})]}),e.jsx(l,{control:s.control,name:"is_active",render:({field:r})=>e.jsxs(c,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(d,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(m,{children:e.jsx(ne,{checked:r.value,onCheckedChange:r.onChange})})]})}),e.jsx(oe,{type:"submit",className:"w-full h-12 text-lg",disabled:M.isPending||!t||N,children:M.isPending||N?e.jsx(ie,{className:"h-4 w-4 animate-spin mr-2"}):"Salvar Configurações"})]})})]})]})})})};export{Be as default};
