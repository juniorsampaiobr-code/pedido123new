import{u as j,j as e}from"./tanstack-BMR5QDBT.js";import{h as w,u as E,k as v,r as m}from"./vendor-DjsPZZVP.js";import{u as o,C,d as b,e as N,L as R,t as I,b as S,s as h}from"./index-BcGHpLdN.js";import{C as k}from"./circle-alert-CkFHLaum.js";import"./supabase-BAEEEeUB.js";const L=async r=>{const{data:n,error:t}=await h.from("orders").select("*").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar pedido: ${t.message}`);if(!n)throw new Error("Pedido não encontrado.");return n},M=()=>{const r=w(),{orderId:n}=E(),[t]=v(),[P,s]=m.useState("Verificando status do pagamento..."),[p,c]=m.useState(!0),[u,d]=m.useState(!1);t.get("status");const y=t.get("external_reference"),a=n||y,{data:f,isLoading:g}=j({queryKey:["paymentRedirectOrder",a],queryFn:()=>L(a),enabled:!!a,staleTime:0});return m.useEffect(()=>{if(!a){s("ID do pedido não encontrado na URL."),d(!0),c(!1),o.error("Erro de redirecionamento: ID do pedido ausente."),r("/menu",{replace:!0});return}if(g)return;if(!f){s("Pedido não encontrado no banco de dados."),d(!0),c(!1),o.error("Erro: Pedido não existe."),r("/menu",{replace:!0});return}(async()=>{c(!0),s("Confirmando pagamento com Mercado Pago...");try{const{data:i,error:x}=await h.functions.invoke("confirm-payment",{body:{orderId:a}});if(x)throw new Error(x.message);const l=i;l.status==="approved"?(s("Pagamento Aprovado! Redirecionando..."),o.success("Pagamento aprovado!"),r(`/order-success/${a}?status=approved`,{replace:!0})):l.status==="pending"?(s("Pagamento Pendente. Aguardando confirmação..."),o.warning("Pagamento pendente. Você será notificado quando for confirmado."),r(`/order-success/${a}?status=pending`,{replace:!0})):(s(`Pagamento Recusado. Status: ${l.status}`),o.error("Pagamento recusado. Tente novamente."),d(!0),r("/checkout",{replace:!0}))}catch(i){console.error("Erro na confirmação de pagamento:",i),s(`Erro ao processar pagamento: ${i.message}`),d(!0),c(!1),o.error("Erro ao processar pagamento. Tente novamente."),r("/checkout",{replace:!0})}})()},[a,g,f,r,t]),e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-muted",children:e.jsxs(C,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(b,{children:e.jsxs(N,{className:"text-2xl font-bold flex items-center justify-center gap-2",children:[p?e.jsx(R,{className:"h-6 w-6 animate-spin text-primary"}):u?e.jsx(k,{className:"h-6 w-6 text-destructive"}):e.jsx(I,{className:"h-6 w-6 text-green-500"}),p?"Processando Pagamento":u?"Erro de Pagamento":"Redirecionando..."]})}),e.jsxs(S,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:P}),u&&e.jsx("div",{className:"mt-4",children:e.jsx("p",{className:"text-sm text-destructive",children:"Você será redirecionado em breve."})})]})]})})};export{M as default};
