import{j as e,b as Us,u as fe,c as Ks}from"./tanstack-D8i8yNxB.js";import{r as l,R as Fe,u as Zs,h as Hs,L as Je}from"./vendor-Dl0Wzy4_.js";import{o as Js,s as $,l as Qs,e as Ws,p as Pe,c as Qe,n as Xs,Z as U,u as Ys,t as er}from"./types-BCrSgEF3.js";import{s as O}from"./client-BmrnLCXS.js";import{c as ke,f as Le,g as ye,P as H,i as ge,h as ss,l as sr,m as rs,b as me,n as rr,k as tr,a as ts,v as We,L as Xe}from"./index-Bn6N6XxC.js";import{B as ae}from"./button-D_oFN4mE.js";import{C as ie,b as le,c as ce,a as de}from"./card-Cfw_dEbs.js";import{I as A}from"./label-C9Cl5wrh.js";import{c as os,R as or,I as ar,a as nr,C as ir}from"./index-CPfjPpqz.js";import{u as lr}from"./index-BB_oiUC3.js";import{u as cr}from"./index-PuW-_iwo.js";import{S as ue}from"./separator-BdoLEJDE.js";import{T as dr}from"./textarea-f78nAb6X.js";import{A as W,a as X,b as Y}from"./alert-BM-s1_b-.js";import{F as ur,b as F,c as _,a as P,e as k,d as ne}from"./form-DR2y_4H4.js";import{Z as mr,M as pr}from"./MapLocationSection-DGKmI-wk.js";import{S as hr}from"./shopping-cart-B6RVkLK-.js";import{T as Se}from"./terminal-DO-Cu6f3.js";import{A as fr}from"./arrow-left-tBahtXAc.js";import{T as Ye}from"./truck-BdqvCh4E.js";import{S as as,a as xr}from"./store-CG7apUue.js";import{M as es}from"./map-pin-CIzCNjaU.js";import{P as gr}from"./package-BfBdoac_.js";import{C as yr}from"./credit-card-DZMB0dgT.js";import{D as jr}from"./dollar-sign-CFGBPkDx.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vr=ke("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const br=ke("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nr=ke("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var $e="Radio",[Cr,ns]=Le($e),[_r,wr]=Cr($e),is=l.forwardRef((t,s)=>{const{__scopeRadio:a,name:c,checked:n=!1,required:i,disabled:d,value:u="on",onCheck:x,form:f,...y}=t,[v,j]=l.useState(null),g=ye(s,L=>j(L)),R=l.useRef(!1),b=v?f||!!v.closest("form"):!0;return e.jsxs(_r,{scope:a,checked:n,disabled:d,children:[e.jsx(H.button,{type:"button",role:"radio","aria-checked":n,"data-state":us(n),"data-disabled":d?"":void 0,disabled:d,value:u,...y,ref:g,onClick:ge(t.onClick,L=>{n||x==null||x(),b&&(R.current=L.isPropagationStopped(),R.current||L.stopPropagation())})}),b&&e.jsx(ds,{control:v,bubbles:!R.current,name:c,value:u,checked:n,required:i,disabled:d,form:f,style:{transform:"translateX(-100%)"}})]})});is.displayName=$e;var ls="RadioIndicator",cs=l.forwardRef((t,s)=>{const{__scopeRadio:a,forceMount:c,...n}=t,i=wr(ls,a);return e.jsx(ss,{present:c||i.checked,children:e.jsx(H.span,{"data-state":us(i.checked),"data-disabled":i.disabled?"":void 0,...n,ref:s})})});cs.displayName=ls;var Rr="RadioBubbleInput",ds=l.forwardRef(({__scopeRadio:t,control:s,checked:a,bubbles:c=!0,...n},i)=>{const d=l.useRef(null),u=ye(d,i),x=cr(a),f=sr(s);return l.useEffect(()=>{const y=d.current;if(!y)return;const v=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(v,"checked").set;if(x!==a&&g){const R=new Event("click",{bubbles:c});g.call(y,a),y.dispatchEvent(R)}},[x,a,c]),e.jsx(H.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...n,tabIndex:-1,ref:u,style:{...n.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ds.displayName=Rr;function us(t){return t?"checked":"unchecked"}var Er=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],je="RadioGroup",[Pr,Rt]=Le(je,[os,ns]),ms=os(),ps=ns(),[Sr,Ir]=Pr(je),hs=l.forwardRef((t,s)=>{const{__scopeRadioGroup:a,name:c,defaultValue:n,value:i,required:d=!1,disabled:u=!1,orientation:x,dir:f,loop:y=!0,onValueChange:v,...j}=t,g=ms(a),R=lr(f),[b,L]=rs({prop:i,defaultProp:n??null,onChange:v,caller:je});return e.jsx(Sr,{scope:a,name:c,required:d,disabled:u,value:b,onValueChange:L,children:e.jsx(or,{asChild:!0,...g,orientation:x,dir:R,loop:y,children:e.jsx(H.div,{role:"radiogroup","aria-required":d,"aria-orientation":x,"data-disabled":u?"":void 0,dir:R,...j,ref:s})})})});hs.displayName=je;var fs="RadioGroupItem",xs=l.forwardRef((t,s)=>{const{__scopeRadioGroup:a,disabled:c,...n}=t,i=Ir(fs,a),d=i.disabled||c,u=ms(a),x=ps(a),f=l.useRef(null),y=ye(s,f),v=i.value===n.value,j=l.useRef(!1);return l.useEffect(()=>{const g=b=>{Er.includes(b.key)&&(j.current=!0)},R=()=>j.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",R),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",R)}},[]),e.jsx(ar,{asChild:!0,...u,focusable:!d,active:v,children:e.jsx(is,{disabled:d,required:i.required,checked:v,...x,...n,name:i.name,ref:y,onCheck:()=>i.onValueChange(n.value),onKeyDown:ge(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:ge(n.onFocus,()=>{var g;j.current&&((g=f.current)==null||g.click())})})})});xs.displayName=fs;var Vr="RadioGroupIndicator",gs=l.forwardRef((t,s)=>{const{__scopeRadioGroup:a,...c}=t,n=ps(a);return e.jsx(cs,{...n,...c,ref:s})});gs.displayName=Vr;var ys=hs,js=xs,Fr=gs;const Ie=l.forwardRef(({className:t,...s},a)=>e.jsx(ys,{className:me("grid gap-2",t),...s,ref:a}));Ie.displayName=ys.displayName;const xe=l.forwardRef(({className:t,...s},a)=>e.jsx(js,{ref:a,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(Fr,{className:"flex items-center justify-center",children:e.jsx(vr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));xe.displayName=js.displayName;const kr=t=>{let s=t.replace(/\D/g,"");return s.length>11&&(s=s.slice(0,11)),s.length>0&&(s=`(${s}`),s.length>3&&(s=`${s.slice(0,3)}) ${s.slice(3)}`),s.length>10&&(s=`${s.slice(0,10)}-${s.slice(10)}`),s},vs=Fe.forwardRef(({className:t,value:s,onChange:a,...c},n)=>{const i=d=>{const u=d.target.value,x=kr(u),f={...d,target:{...d.target,value:x}};a(f)};return e.jsx(A,{ref:n,type:"tel",className:me("w-full",t),placeholder:"(99) 99999-9999",value:s,onChange:i,...c})});vs.displayName="PhoneInput";const Lr=t=>{let s=t.replace(/\D/g,"");return s.length>14&&(s=s.slice(0,14)),s.length<=11?(s.length>9&&(s=`${s.slice(0,9)}-${s.slice(9)}`),s.length>6&&(s=`${s.slice(0,6)}.${s.slice(6)}`),s.length>3&&(s=`${s.slice(0,3)}.${s.slice(3)}`),s):(s.length>12&&(s=`${s.slice(0,12)}-${s.slice(12)}`),s.length>8&&(s=`${s.slice(0,8)}/${s.slice(8)}`),s.length>5&&(s=`${s.slice(0,5)}.${s.slice(5)}`),s.length>2&&(s=`${s.slice(0,2)}.${s.slice(2)}`),s)},bs=Fe.forwardRef(({className:t,value:s,onChange:a,...c},n)=>{const i=d=>{const u=d.target.value,x=Lr(u),f={...d,target:{...d.target,value:x}};a(f)};return e.jsx(A,{ref:n,type:"tel",className:me("w-full",t),placeholder:"CPF ou CNPJ",value:s,onChange:i,maxLength:18,...c})});bs.displayName="CpfCnpjInput";const $r=(t,s,a,c)=>{const i=(a-t)*(Math.PI/180),d=(c-s)*(Math.PI/180),u=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t*(Math.PI/180))*Math.cos(a*(Math.PI/180))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},Tr=async t=>{const s=t.replace(/\s+/g," ").trim(),a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(s)}&limit=1`,c=new AbortController,n=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",a);const i=await fetch(a,{signal:c.signal});if(!i.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",i.status),null;const d=await i.json();if(d&&Array.isArray(d)&&d.length>0){const u=d[0],x=parseFloat(u.lat),f=parseFloat(u.lon);if(Number.isFinite(x)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[x,f]),{lat:x,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",s),null}catch(i){return i instanceof Error&&i.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",s):console.error("LOG: geocodeAddress - Erro durante a requisição:",i),null}finally{clearTimeout(n)}},Or=(t,s,a)=>{const c=$r(s[0],s[1],t[0],t[1]),n=a.find(i=>c<=i.max_distance_km);if(n){const i=n.delivery_fee||0,d=n.min_delivery_time_minutes||0,u=d+15;return{fee:parseFloat(i.toFixed(2)),minTime:d,maxTime:u}}return null};var ve="Collapsible",[Ar,Et]=Le(ve),[Mr,Te]=Ar(ve),Ns=l.forwardRef((t,s)=>{const{__scopeCollapsible:a,open:c,defaultOpen:n,disabled:i,onOpenChange:d,...u}=t,[x,f]=rs({prop:c,defaultProp:n??!1,onChange:d,caller:ve});return e.jsx(Mr,{scope:a,disabled:i,contentId:rr(),open:x,onOpenToggle:l.useCallback(()=>f(y=>!y),[f]),children:e.jsx(H.div,{"data-state":Ae(x),"data-disabled":i?"":void 0,...u,ref:s})})});Ns.displayName=ve;var Cs="CollapsibleTrigger",_s=l.forwardRef((t,s)=>{const{__scopeCollapsible:a,...c}=t,n=Te(Cs,a);return e.jsx(H.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":Ae(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...c,ref:s,onClick:ge(t.onClick,n.onOpenToggle)})});_s.displayName=Cs;var Oe="CollapsibleContent",ws=l.forwardRef((t,s)=>{const{forceMount:a,...c}=t,n=Te(Oe,t.__scopeCollapsible);return e.jsx(ss,{present:a||n.open,children:({present:i})=>e.jsx(Gr,{...c,ref:s,present:i})})});ws.displayName=Oe;var Gr=l.forwardRef((t,s)=>{const{__scopeCollapsible:a,present:c,children:n,...i}=t,d=Te(Oe,a),[u,x]=l.useState(c),f=l.useRef(null),y=ye(s,f),v=l.useRef(0),j=v.current,g=l.useRef(0),R=g.current,b=d.open||u,L=l.useRef(b),G=l.useRef(void 0);return l.useEffect(()=>{const N=requestAnimationFrame(()=>L.current=!1);return()=>cancelAnimationFrame(N)},[]),tr(()=>{const N=f.current;if(N){G.current=G.current||{transitionDuration:N.style.transitionDuration,animationName:N.style.animationName},N.style.transitionDuration="0s",N.style.animationName="none";const K=N.getBoundingClientRect();v.current=K.height,g.current=K.width,L.current||(N.style.transitionDuration=G.current.transitionDuration,N.style.animationName=G.current.animationName),x(c)}},[d.open,c]),e.jsx(H.div,{"data-state":Ae(d.open),"data-disabled":d.disabled?"":void 0,id:d.contentId,hidden:!b,...i,ref:y,style:{"--radix-collapsible-content-height":j?`${j}px`:void 0,"--radix-collapsible-content-width":R?`${R}px`:void 0,...t.style},children:b&&n})});function Ae(t){return t?"open":"closed"}var qr=Ns;const Dr=qr,Br=_s,zr=ws,Ur=()=>{const{items:t,subtotal:s,deliveryFee:a,total:c,totalItems:n}=ts(),[i,d]=l.useState(!1);return n===0?null:e.jsxs(Dr,{open:i,onOpenChange:d,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Br,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(hr,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)}),i?e.jsx(nr,{className:"h-5 w-5"}):e.jsx(ir,{className:"h-5 w-5"})]})]})}),e.jsxs(zr,{className:"p-4 pt-0",children:[e.jsx(ue,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:t.map(u=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[u.quantity,"x ",u.name,u.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",u.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u.price*u.quantity)})]},u.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)})]})]})]})]})},Rs=t=>t.replace(/\D/g,""),Es=t=>t.replace(/\D/g,""),Ve=t=>t.replace(/\D/g,""),Kr=Js({name:$().min(1,"Nome é obrigatório."),phone:$().min(1,"Telefone é obrigatório.").transform(Rs).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:$().email("Email inválido.").optional().or(Qs("")),delivery_option:Ws(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:$().optional().default(""),number:$().optional().default(""),complement:$().optional().default(""),neighborhood:$().optional().default(""),city:$().optional().default(""),zip_code:$().optional().default("").transform(Es).refine(t=>t.length===8||t.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Pe(t=>typeof t=="string"?parseFloat(t):t,Qe.number().optional().nullable()),longitude:Pe(t=>typeof t=="string"?parseFloat(t):t,Qe.number().optional().nullable()),payment_method_id:$().min(1,"Selecione uma forma de pagamento."),notes:$().optional(),cpf_cnpj:$().optional().default("").transform(Ve).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Pe(t=>{if(t==null||t==="")return null;const s=String(t).replace(",","."),a=parseFloat(s);return isNaN(a)?s:a},Xs({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((t,s)=>{if(t.delivery_option==="delivery"?(t.street.trim()===""&&s.addIssue({code:U.custom,message:"Rua é obrigatória.",path:["street"]}),t.number.trim()===""&&s.addIssue({code:U.custom,message:"Número é obrigatório.",path:["number"]}),t.neighborhood.trim()===""&&s.addIssue({code:U.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),t.city.trim()===""&&s.addIssue({code:U.custom,message:"Cidade é obrigatória.",path:["city"]}),t.zip_code.length!==8&&s.addIssue({code:U.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(t.latitude===null||t.longitude===null)&&s.addIssue({code:U.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})):t.latitude!==null||t.longitude,t.payment_method_id==="Dinheiro"&&t.change_for!==null&&t.change_for!==void 0&&t.change_for<=0&&s.addIssue({code:U.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),t.payment_method_id==="Pagamento online: Pix/Cartão"){const n=Ve(t.cpf_cnpj||"");n.length!==11&&n.length!==14&&s.addIssue({code:U.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Zr=()=>{const t=window.location.origin,a=window.location.pathname.split("/")[1];return a?`${t}/${a}`:t},Hr=async()=>{const{data:t,error:s}=await O.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(s)throw new Error(`Erro ao buscar restaurante: ${s.message}`);if(!t)throw new Error("Nenhum restaurante ativo encontrado.");return t},Jr=async t=>{const{data:s,error:a}=await O.from("restaurants").select("delivery_enabled").eq("id",t).single();if(a)throw new Error(`Erro ao buscar status de entrega: ${a.message}`);return s.delivery_enabled??!0},Qr=async t=>{const{data:s,error:a}=await O.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(a)throw new Error(`Erro ao buscar métodos de pagamento: ${a.message}`);return s},Wr=async t=>{const{data:s,error:a}=await O.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(a)throw new Error(`Erro ao buscar zonas de entrega: ${a.message}`);return s},Xr=t=>{switch(t){case"DollarSign":return jr;case"Smartphone":return xr;case"CreditCard":return yr;case"Package":return gr;default:return as}},Yr=({subtotal:t,deliveryFee:s,total:a,items:c})=>e.jsxs(ie,{className:"sticky top-4",children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(de,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:s>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]})]})]}),Pt=()=>{const t=Zr(),s=Zs();Us();const a=ts(),{items:c,subtotal:n,deliveryFee:i,total:d,setDeliveryFee:u,clearCart:x}=a,[f]=Hs(),[y,v]=l.useState(!1),[j,g]=l.useState(null),[R,b]=l.useState(null),[L,G]=l.useState(null),N=Fe.useRef(!1),[K,Me]=l.useState(!1),ee=f.get("status"),be=f.get("external_reference"),Ge=f.has("collection_id")||f.has("external_reference");l.useEffect(()=>{if(be)if(ee==="approved"||ee==="failure"||ee==="pending"){s(`/order-success/${be}?status=${ee}`,{replace:!0});return}else Ge&&(window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Me(!1));else Me(!1)},[be,ee,Ge,s]);const{data:m,isLoading:Ps,isError:Ss,error:Is}=fe({queryKey:["checkoutRestaurantData"],queryFn:Hr}),{data:q,isLoading:Ne}=fe({queryKey:["deliveryStatus",m==null?void 0:m.id],queryFn:()=>Jr(m.id),enabled:!!(m!=null&&m.id)}),{data:J=[],isLoading:Vs}=fe({queryKey:["checkoutPaymentMethods",m==null?void 0:m.id],queryFn:()=>Qr(m.id),enabled:!!(m!=null&&m.id)}),{data:qe=[],isLoading:Fs}=fe({queryKey:["checkoutDeliveryZones",m==null?void 0:m.id],queryFn:()=>Wr(m.id),enabled:!!(m!=null&&m.id)}),ks=Ps||Ne||Vs||Fs,Ls=Ss,De=Is,o=Ys({resolver:er(Kr),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),M=o.watch("delivery_option"),Ce=o.watch("payment_method_id"),Q=J.find(r=>r.id===Ce),pe=(Q==null?void 0:Q.name)==="Pagamento online: Pix/Cartão",he=(Q==null?void 0:Q.name)==="Dinheiro",S=o.watch("latitude"),I=o.watch("longitude");o.watch(["street","number","neighborhood","city","zip_code"]);const D=M==="delivery",$s=l.useMemo(()=>JSON.stringify({deliveryOption:M,deliveryEnabled:q,lat:S,lng:I}),[M,q,S,I]),Ts=l.useMemo(()=>typeof S=="number"&&typeof I=="number"&&!isNaN(S)&&!isNaN(I)?[S,I]:m!=null&&m.latitude&&(m!=null&&m.longitude)?[m.latitude,m.longitude]:[-23.55052,-46.633308],[S,I,m]),Os=l.useMemo(()=>S===null||I===null?`map-${M}-null`:`map-${M}-${S.toFixed(6)}-${I.toFixed(6)}`,[D,M,S,I]),_e=l.useCallback(r=>{const p=r.road||r.logradouro||"",h=r.house_number||"",C=r.suburb||r.bairro||"",w=r.city||r.localidade||"",T=r.postcode||r.cep||"";o.setValue("street",p,{shouldValidate:!0}),o.setValue("number",h||"",{shouldValidate:!0}),o.setValue("complement",r.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",C,{shouldValidate:!0}),o.setValue("city",w,{shouldValidate:!0}),o.setValue("zip_code",T,{shouldValidate:!0})},[o]),As=l.useCallback(async(r,p)=>{o.setValue("latitude",r,{shouldValidate:!0}),o.setValue("longitude",p,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${p}&addressdetails=1`,C=await fetch(h);if(C.ok){const w=await C.json();w.address&&_e(w.address)}},[o,_e]),Ms=l.useCallback(()=>{o.setValue("street","",{shouldValidate:!0}),o.setValue("number","",{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood","",{shouldValidate:!0}),o.setValue("city","",{shouldValidate:!0}),o.setValue("zip_code","",{shouldValidate:!0}),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),u(0),g(null),b(null),localStorage.removeItem("checkoutFormData")},[o,u]),we=l.useCallback(r=>{try{const p={name:r.name,phone:r.phone,email:r.email,delivery_option:r.delivery_option,street:r.street,number:r.number,complement:r.complement,neighborhood:r.neighborhood,city:r.city,zip_code:r.zip_code,latitude:r.latitude,longitude:r.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(p))}catch(p){console.error("Failed to save form data to local storage",p)}},[]),Be=l.useCallback(()=>{try{const r=localStorage.getItem("checkoutFormData");if(r){const p=JSON.parse(r);o.reset({...o.getValues(),...p,delivery_option:p.delivery_option||"delivery"})}}catch(r){console.error("Failed to load form data from local storage",r)}},[o]);l.useEffect(()=>{Be()},[Be]),l.useEffect(()=>{const r=o.watch(p=>{we(p)});return()=>r.unsubscribe()},[o,we]);const Gs=()=>{N.current||(G(null),N.current=!0,Promise.resolve().then(async()=>{try{const r=o.getValues(),[p,h,C,w,T]=[r.street,r.number,r.neighborhood,r.city,r.zip_code],re=Es(T);if(!(p&&h&&C&&w&&re.length===8)){console.log("LOG: Validação de endereço incompleto falhou."),o.trigger(["street","number","neighborhood","city","zip_code"]),N.current=!1;return}console.log("LOG: Iniciando geocodificação para:",`${p}, ${h}, ${C}, ${w}, ${T}`);const B=`${p}, ${h}, ${C}, ${w}, ${T}`,Z=await Tr(B);Z?(console.log("LOG: Geocodificação bem-sucedida. Coordenadas:",Z),o.setValue("latitude",Z.lat,{shouldValidate:!0}),o.setValue("longitude",Z.lng,{shouldValidate:!0}),we(o.getValues())):(console.log("LOG: Geocodificação falhou ou retornou coordenadas inválidas."),setTimeout(()=>{G("Endereço não encontrado. Por favor, verifique se está correto e tente novamente."),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0})},100))}catch(r){console.error("LOG: Erro capturado durante a geocodificação:",r),setTimeout(()=>{G("Erro ao buscar coordenadas. Verifique sua conexão ou tente novamente."),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0})},100)}finally{N.current=!1}}).catch(r=>{console.error("LOG: Erro nao capturado:",r),N.current=!1}))};l.useEffect(()=>{he||o.setValue("change_for",null,{shouldValidate:!0})},[he,o]),l.useEffect(()=>{M==="pickup"&&(u(0),g(null),b(null),o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}))},[M,D,o,u,S,I]),l.useEffect(()=>{J.length>0&&!Ce&&o.setValue("payment_method_id",J[0].id)},[J,Ce,o]),l.useEffect(()=>{pe?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},[pe,o]),l.useEffect(()=>{const r=async()=>{if(M==="pickup"||!(m!=null&&m.latitude)||!(m!=null&&m.longitude)){u(0),g(null),b(null);return}if(Ne)return;if(q===!1){u(0),g(null),b(null),v(!1);return}v(!0),g(null);let h=null;if(S&&I)h=[S,I];else{u(0),b(null),v(!1);return}if(h){const C=[m.latitude,m.longitude],w=Or(h,C,qe);w?(u(w.fee),g(null),b({minTime:w.minTime,maxTime:w.maxTime})):(u(0),g("Seu endereço está fora da nossa área de entrega."),b(null))}v(!1)},p=setTimeout(()=>{r()},500);return()=>clearTimeout(p)},[$s,m,qe,o,u,D,S,I,q,Ne]);const se=Ks({mutationFn:async r=>{if(!m)throw new Error("Dados do restaurante indisponíveis.");if(r.delivery_option==="delivery"&&j)throw new Error(j);const p=[r.street,r.number,r.complement?`(${r.complement})`:null,r.neighborhood,r.city,r.zip_code].filter(Boolean).join(", "),h=r.delivery_option==="delivery"?p:"Retirada no Local";let C;const w=Rs(r.phone),T=Ve(r.cpf_cnpj||""),{data:{user:re}}=await O.auth.getUser(),te=(re==null?void 0:re.id)||null,{data:B}=await O.from("customers").select("id, user_id, name, cpf_cnpj").eq("phone",w).limit(1).single();if(B){C=B.id;const E={name:r.name};if(T&&(E.cpf_cnpj=T),te&&B.user_id===null&&(E.user_id=te),E.name!==B.name||T&&T!==B.cpf_cnpj||te&&B.user_id===null){const{error:V}=await O.from("customers").update(E).eq("id",C);if(V)throw new Error(`Erro ao atualizar cliente existente: ${V.message}`)}}else{const E={name:r.name,phone:w,email:r.email||null,address:h,latitude:r.latitude,longitude:r.longitude,cpf_cnpj:T||null,user_id:te},{data:z,error:V}=await O.from("customers").insert(E).select("id").single();if(V)throw new Error(`Erro ao criar cliente: ${V.message}`);C=z.id}const Z=pe?"pending_payment":"pending",{data:Ee,error:Ke}=await O.from("orders").insert({restaurant_id:m.id,customer_id:C,status:Z,total_amount:d,delivery_fee:i,notes:r.notes,delivery_address:h,payment_method_id:r.payment_method_id,change_for:he?r.change_for:null}).select("id").single();if(Ke)throw new Error(`Erro ao criar pedido: ${Ke.message}`);const zs=c.map(E=>{const z=Number(E.quantity),V=Number(E.price),oe={order_id:Ee.id,product_id:E.product_id,quantity:z,unit_price:V,subtotal:z*V};return E.notes&&E.notes.trim()&&(oe.notes=E.notes.trim()),oe}),{error:Ze}=await O.from("order_items").insert(zs);if(Ze){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Ze);const E=c.map(V=>{const oe=Number(V.quantity),He=Number(V.price);return{order_id:Ee.id,quantity:oe,unit_price:He,subtotal:oe*He,notes:V.notes&&V.notes.trim()?V.notes.trim():null}}),{error:z}=await O.from("order_items").insert(E);if(z)throw new Error(`Erro ao adicionar itens do pedido: ${z.message}`)}return{orderId:Ee.id,orderStatus:Z}},onSuccess:r=>{x();const p=r.orderStatus==="pending_payment"?`/payment/${r.orderId}`:`/order-success/${r.orderId}`;if(r.orderStatus==="pending_payment"){const h=`${t}/#${p}`;console.log("LOG: Tentando redirecionamento forçado para MP/PaymentRedirect:",h),window.location.href=h}else s(p,{replace:!0})},onError:r=>{console.error("LOG: Erro ao processar pedido:",r),alert(`Falha ao finalizar pedido: ${r.message}. Verifique o console para mais detalhes.`)}}),qs=async r=>{if(!await o.trigger()){ze(o.formState.errors);return}if(r.delivery_option==="delivery"&&j){alert(`Não é possível finalizar o pedido: ${j}`);return}se.mutate(r)},ze=r=>{var h;console.error("Validation errors:",r);const p=Object.keys(r)[0];p&&console.error("LOG: Erro de validação:",((h=r[p])==null?void 0:h.message)||"Preencha todos os campos obrigatórios.")},Ue=se.isPending||y,Ds=!D||!j&&i>=0,Re=!D||S!==null&&I!==null,Bs=!Ue&&Ds&&Re;return l.useEffect(()=>{if(c.length===0&&!se.isPending&&!K){const r=setTimeout(()=>{s("/menu",{replace:!0})},100);return()=>clearTimeout(r)}},[c.length,se.isPending,K,s]),c.length===0&&!se.isPending&&!K?e.jsx(We,{}):ks||K?e.jsx(We,{}):Ls?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(W,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro de Conexão"}),e.jsx(Y,{children:De instanceof Error?De.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Je,{to:"/menu",children:e.jsx(ae,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(fr,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("div",{children:e.jsx(Ur,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ur,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(qs,ze),className:"space-y-6",children:[e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(F,{control:o.control,name:"name",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Nome Completo *"}),e.jsx(A,{placeholder:"Seu nome",...r}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(F,{control:o.control,name:"phone",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Telefone *"}),e.jsx(vs,{...r}),e.jsx(k,{})]})}),e.jsx(F,{control:o.control,name:"email",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Email (Opcional)"}),e.jsx(A,{placeholder:"seu@email.com",...r}),e.jsx(k,{})]})})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(F,{control:o.control,name:"delivery_option",render:({field:r})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsxs(Ie,{onValueChange:r.onChange,defaultValue:r.value,className:"flex flex-col space-y-1",children:[e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:"delivery"})}),e.jsx(Ye,{className:"h-5 w-5 text-primary"}),e.jsxs(P,{className:me("font-normal flex-1 cursor-pointer"),children:["Delivery",q===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:"pickup"})}),e.jsx(as,{className:"h-5 w-5 text-primary"}),e.jsx(P,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(k,{})]})}),D&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:r=>{r.preventDefault(),Gs()},disabled:y||N.current,children:[e.jsx(Nr,{className:"h-4 w-4 mr-2"})," ",y||N.current?"Buscando...":"Salvar Endereço"]}),e.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:Ms,children:[e.jsx(br,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(F,{control:o.control,name:"street",render:({field:r})=>e.jsxs(_,{className:"col-span-2",children:[e.jsx(P,{children:"Rua *"}),e.jsx(A,{...r}),e.jsx(k,{})]})}),e.jsx(F,{control:o.control,name:"number",render:({field:r})=>e.jsxs(_,{className:"col-span-1",children:[e.jsx(P,{children:"Número *"}),e.jsx(A,{...r}),e.jsx(k,{})]})})]}),e.jsx(F,{control:o.control,name:"complement",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Complemento (Opcional)"}),e.jsx(A,{placeholder:"Apto, Bloco, Casa, etc.",...r,disabled:!1}),e.jsx(k,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(F,{control:o.control,name:"neighborhood",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Bairro *"}),e.jsx(A,{...r}),e.jsx(k,{})]})}),e.jsx(F,{control:o.control,name:"city",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Cidade *"}),e.jsx(A,{...r}),e.jsx(k,{})]})})]}),e.jsx(F,{control:o.control,name:"zip_code",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"CEP *"}),e.jsx(mr,{...r}),e.jsx(k,{})]})}),D&&Re&&e.jsx("div",{children:e.jsx(pr,{mapKey:Os,markerPosition:Ts,onLocationChange:As,updateAddressFields:_e,restaurant:m})}),y&&q!==!1&&e.jsxs(W,{children:[e.jsx(Xe,{className:"h-4 w-4 animate-spin"}),e.jsx(X,{children:"Calculando Taxa..."}),e.jsx(Y,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),j&&q!==!1&&e.jsxs(W,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro de Entrega"}),e.jsx(Y,{children:j})]}),i>0&&!y&&q!==!1&&e.jsxs(W,{className:"mt-4",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx(X,{children:"Taxa de Entrega Aplicada"}),e.jsxs(Y,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i)]})]}),L&&e.jsxs(W,{variant:"destructive",className:"mt-4",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(X,{children:"Erro ao Buscar Endereço"}),e.jsx(Y,{children:L})]}),D&&!Re&&!L&&e.jsxs(W,{variant:"destructive",children:[e.jsx(es,{className:"h-4 w-4"}),e.jsx(X,{children:"Localização Obrigatória"}),e.jsx(Y,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(F,{control:o.control,name:"payment_method_id",render:({field:r})=>e.jsxs(_,{className:"space-y-3",children:[e.jsx(ne,{children:e.jsx(Ie,{onValueChange:p=>{r.onChange(p);const h=J.find(C=>C.id===p);(h==null?void 0:h.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},defaultValue:r.value,className:"flex flex-col space-y-2",children:J.map(p=>{const h=Xr(p.icon||"Store");return e.jsxs(_,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ne,{children:e.jsx(xe,{value:p.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(P,{className:"font-normal cursor-pointer",children:p.name}),p.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:p.description})]})]},p.id)})})}),e.jsx(k,{})]})}),he&&e.jsx(F,{control:o.control,name:"change_for",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Troco para (Opcional)"}),e.jsx(A,{type:"number",placeholder:"Ex: 50.00",...r,value:r.value||"",onChange:p=>r.onChange(p.target.value?parseFloat(p.target.value):null)}),e.jsx(k,{})]})}),pe&&e.jsx(F,{control:o.control,name:"cpf_cnpj",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"CPF/CNPJ *"}),e.jsx(bs,{...r}),e.jsx(k,{})]})})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"4. Observações"})}),e.jsx(de,{children:e.jsx(F,{control:o.control,name:"notes",render:({field:r})=>e.jsxs(_,{children:[e.jsx(P,{children:"Observações do Pedido (Opcional)"}),e.jsx(dr,{placeholder:"Ex: Sem cebola, sem alface...",...r}),e.jsx(k,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Je,{to:"/menu",className:"flex-1",children:e.jsx(ae,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(ae,{type:"submit",className:"flex-1",disabled:!Bs,size:"lg",children:Ue?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(Yr,{subtotal:n,deliveryFee:i,total:d,items:c})})]})]})]})};export{Pt as default};
