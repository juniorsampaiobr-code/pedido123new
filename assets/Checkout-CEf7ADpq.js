import{j as e,b as Tr,u as me,c as qr}from"./tanstack-D8i8yNxB.js";import{r as d,R as Ye,u as Br,h as Dr,L as Mr}from"./vendor-Dl0Wzy4_.js";import{o as zr,s as k,l as Or,e as Gr,c as Je,p as Kr,n as Zr,Z as O,u as Ur,t as Jr}from"./types-BCrSgEF3.js";import{s as T}from"./client-BmrnLCXS.js";import{c as Hr,g as er,h as Ie,P as be,j as Ve,i as Qr,m as Wr,n as Xr,b as Ne,a as Yr,u as g,v as es,L as pe}from"./index-B-HD1QDF.js";import{B as he}from"./button-CRwDK82v.js";import{C as fe,b as ge,c as xe,a as je}from"./card-yTx8FfyR.js";import{I as L,L as Re}from"./label-BRqQi31F.js";import{c as rr,R as rs,I as ss}from"./index-5n7y5-Jz.js";import{u as as}from"./index-BB_oiUC3.js";import{u as os}from"./index-PuW-_iwo.js";import{S as He}from"./separator-it_qACD5.js";import{T as ts}from"./textarea-DPeIPaR7.js";import{A as te,a as ne,b as ie}from"./alert-B1XN9t6o.js";import{F as ns,b as P,c as x,a as C,e as R,d as B}from"./form-Bo8gHRIr.js";import{Z as Qe,S as is,g as We,c as ls}from"./location-BOK_XE8b.js";import{LocationPickerMap as cs}from"./LocationPickerMap-Czyd1Neu.js";import{T as Xe}from"./terminal-s-JFgfZX.js";import{A as ds}from"./arrow-left-CEixulNL.js";import{T as Se}from"./truck-3bn3w6Pq.js";import{S as sr,a as us}from"./store-BuQBCaq6.js";import{M as ms}from"./map-pin-1HLprzhY.js";import{C as ar}from"./credit-card-z_WWcyF4.js";import{P as ps}from"./package-CrNFVqa3.js";import{D as hs}from"./dollar-sign-CleFKxJV.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fs=Hr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);var $e="Radio",[gs,or]=er($e),[xs,js]=gs($e),tr=d.forwardRef((a,r)=>{const{__scopeRadio:n,name:p,checked:l=!1,required:h,disabled:u,value:f="on",onCheck:v,form:j,..._}=a,[S,V]=d.useState(null),y=Ie(r,D=>V(D)),b=d.useRef(!1),w=S?j||!!S.closest("form"):!0;return e.jsxs(xs,{scope:n,checked:l,disabled:u,children:[e.jsx(be.button,{type:"button",role:"radio","aria-checked":l,"data-state":cr(l),"data-disabled":u?"":void 0,disabled:u,value:f,..._,ref:y,onClick:Ve(a.onClick,D=>{l||v==null||v(),w&&(b.current=D.isPropagationStopped(),b.current||D.stopPropagation())})}),w&&e.jsx(lr,{control:S,bubbles:!b.current,name:p,value:f,checked:l,required:h,disabled:u,form:j,style:{transform:"translateX(-100%)"}})]})});tr.displayName=$e;var nr="RadioIndicator",ir=d.forwardRef((a,r)=>{const{__scopeRadio:n,forceMount:p,...l}=a,h=js(nr,n);return e.jsx(Qr,{present:p||h.checked,children:e.jsx(be.span,{"data-state":cr(h.checked),"data-disabled":h.disabled?"":void 0,...l,ref:r})})});ir.displayName=nr;var ys="RadioBubbleInput",lr=d.forwardRef(({__scopeRadio:a,control:r,checked:n,bubbles:p=!0,...l},h)=>{const u=d.useRef(null),f=Ie(u,h),v=os(n),j=Wr(r);return d.useEffect(()=>{const _=u.current;if(!_)return;const S=window.HTMLInputElement.prototype,y=Object.getOwnPropertyDescriptor(S,"checked").set;if(v!==n&&y){const b=new Event("click",{bubbles:p});y.call(_,n),_.dispatchEvent(b)}},[v,n,p]),e.jsx(be.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...l,tabIndex:-1,ref:f,style:{...l.style,...j,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});lr.displayName=ys;function cr(a){return a?"checked":"unchecked"}var vs=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],we="RadioGroup",[bs,la]=er(we,[rr,or]),dr=rr(),ur=or(),[Ns,ws]=bs(we),mr=d.forwardRef((a,r)=>{const{__scopeRadioGroup:n,name:p,defaultValue:l,value:h,required:u=!1,disabled:f=!1,orientation:v,dir:j,loop:_=!0,onValueChange:S,...V}=a,y=dr(n),b=as(j),[w,D]=Xr({prop:h,defaultProp:l??null,onChange:S,caller:we});return e.jsx(Ns,{scope:n,name:p,required:u,disabled:f,value:w,onValueChange:D,children:e.jsx(rs,{asChild:!0,...y,orientation:v,dir:b,loop:_,children:e.jsx(be.div,{role:"radiogroup","aria-required":u,"aria-orientation":v,"data-disabled":f?"":void 0,dir:b,...V,ref:r})})})});mr.displayName=we;var pr="RadioGroupItem",hr=d.forwardRef((a,r)=>{const{__scopeRadioGroup:n,disabled:p,...l}=a,h=ws(pr,n),u=h.disabled||p,f=dr(n),v=ur(n),j=d.useRef(null),_=Ie(r,j),S=h.value===l.value,V=d.useRef(!1);return d.useEffect(()=>{const y=w=>{vs.includes(w.key)&&(V.current=!0)},b=()=>V.current=!1;return document.addEventListener("keydown",y),document.addEventListener("keyup",b),()=>{document.removeEventListener("keydown",y),document.removeEventListener("keyup",b)}},[]),e.jsx(ss,{asChild:!0,...f,focusable:!u,active:S,children:e.jsx(tr,{disabled:u,required:h.required,checked:S,...v,...l,name:h.name,ref:_,onCheck:()=>h.onValueChange(l.value),onKeyDown:Ve(y=>{y.key==="Enter"&&y.preventDefault()}),onFocus:Ve(l.onFocus,()=>{var y;V.current&&((y=j.current)==null||y.click())})})})});hr.displayName=pr;var Cs="RadioGroupIndicator",fr=d.forwardRef((a,r)=>{const{__scopeRadioGroup:n,...p}=a,l=ur(n);return e.jsx(ir,{...l,...p,ref:r})});fr.displayName=Cs;var gr=mr,xr=hr,_s=fr;const ye=d.forwardRef(({className:a,...r},n)=>e.jsx(gr,{className:Ne("grid gap-2",a),...r,ref:n}));ye.displayName=gr.displayName;const W=d.forwardRef(({className:a,...r},n)=>e.jsx(xr,{ref:n,className:Ne("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),...r,children:e.jsx(_s,{className:"flex items-center justify-center",children:e.jsx(fs,{className:"h-2.5 w-2.5 fill-current text-current"})})}));W.displayName=xr.displayName;const Es=a=>{let r=a.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},jr=Ye.forwardRef(({className:a,value:r,onChange:n,...p},l)=>{const h=u=>{const f=u.target.value,v=Es(f),j={...u,target:{...u.target,value:v}};n(j)};return e.jsx(L,{ref:l,type:"tel",className:Ne("w-full",a),placeholder:"(99) 99999-9999",value:r,onChange:h,...p})});jr.displayName="PhoneInput";const Ps=a=>{let r=a.replace(/\D/g,"");return r.length>14&&(r=r.slice(0,14)),r.length<=11?(r.length>9&&(r=`${r.slice(0,9)}-${r.slice(9)}`),r.length>6&&(r=`${r.slice(0,6)}.${r.slice(6)}`),r.length>3&&(r=`${r.slice(0,3)}.${r.slice(3)}`),r):(r.length>12&&(r=`${r.slice(0,12)}-${r.slice(12)}`),r.length>8&&(r=`${r.slice(0,8)}/${r.slice(8)}`),r.length>5&&(r=`${r.slice(0,5)}.${r.slice(5)}`),r.length>2&&(r=`${r.slice(0,2)}.${r.slice(2)}`),r)},yr=Ye.forwardRef(({className:a,value:r,onChange:n,...p},l)=>{const h=u=>{const f=u.target.value,v=Ps(f),j={...u,target:{...u.target,value:v}};n(j)};return e.jsx(L,{ref:l,type:"tel",className:Ne("w-full",a),placeholder:"CPF ou CNPJ",value:r,onChange:h,maxLength:18,...p})});yr.displayName="CpfCnpjInput";const vr=a=>a.replace(/\D/g,""),Fe=a=>a.replace(/\D/g,""),ve=a=>a.replace(/\D/g,""),Rs=zr({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(vr).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:k().email("Email inválido.").optional().or(Or("")),delivery_option:Gr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:k().optional().default(""),number:k().optional().default(""),complement:k().optional().default(""),neighborhood:k().optional().default(""),city:k().optional().default(""),zip_code:k().optional().default("").transform(Fe).refine(a=>a.length===8||a.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Je.number().optional().nullable(),longitude:Je.number().optional().nullable(),payment_method_id:k().min(1,"Selecione uma forma de pagamento."),notes:k().optional(),cpf_cnpj:k().optional().default("").transform(ve).refine(a=>a.length===0||a.length===11||a.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Kr(a=>{if(a==null||a==="")return null;const r=String(a).replace(",","."),n=parseFloat(r);return isNaN(n)?r:n},Zr({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((a,r)=>{if(a.delivery_option==="delivery"&&(a.street.trim()===""&&r.addIssue({code:O.custom,message:"Rua é obrigatória.",path:["street"]}),a.number.trim()===""&&r.addIssue({code:O.custom,message:"Número é obrigatório.",path:["number"]}),a.neighborhood.trim()===""&&r.addIssue({code:O.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),a.city.trim()===""&&r.addIssue({code:O.custom,message:"Cidade é obrigatória.",path:["city"]}),a.zip_code.length!==8&&r.addIssue({code:O.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]})),a.payment_method_id==="Dinheiro"&&a.change_for!==null&&a.change_for!==void 0&&a.change_for<=0&&r.addIssue({code:O.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),a.payment_method_id==="Pagamento online: Pix/Cartão"){const l=ve(a.cpf_cnpj||"");l.length!==11&&l.length!==14&&r.addIssue({code:O.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Ss=()=>{const a=window.location.origin,n=window.location.pathname.split("/")[1];return n?`${a}/${n}`:a},Vs=async()=>{const{data:a,error:r}=await T.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!a)throw new Error("Nenhum restaurante ativo encontrado.");return a},Fs=async a=>{const{data:r,error:n}=await T.from("restaurants").select("delivery_enabled").eq("id",a).single();if(n)throw new Error(`Erro ao buscar status de entrega: ${n.message}`);return r.delivery_enabled??!0},Is=async a=>{const{data:r,error:n}=await T.from("payment_methods").select("*").eq("restaurant_id",a).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return r},$s=async a=>{const{data:r,error:n}=await T.from("delivery_zones").select("*").eq("restaurant_id",a).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return r},ks=a=>{switch(a){case"DollarSign":return hs;case"Smartphone":return us;case"CreditCard":return ar;case"Package":return ps;default:return sr}},Ls=({subtotal:a,deliveryFee:r,total:n,items:p})=>e.jsxs(fe,{className:"sticky top-4",children:[e.jsx(ge,{children:e.jsx(xe,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(je,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:p.map(l=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[l.quantity,"x ",l.name,l.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",l.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l.price*l.quantity)})]},l.id))}),e.jsx(He,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:r>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r):"Grátis"})]})]}),e.jsx(He,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n)})]})]})]}),ca=()=>{const a=Br(),r=Tr(),n=Yr(),{items:p,subtotal:l,deliveryFee:h,total:u,setDeliveryFee:f,clearCart:v}=n,[j]=Dr(),[_,S]=d.useState(!1),[V,y]=d.useState(!1),[b,w]=d.useState(null),[D,G]=d.useState(null),[ke,Le]=d.useState(""),[X,Ae]=d.useState(""),[Te,qe]=d.useState(!1),[br,Y]=d.useState(!1),[F,Nr]=d.useState("search"),ee=j.get("status"),le=j.get("external_reference"),Be=j.has("collection_id")||j.has("external_reference"),[ce,De]=d.useState(!!le);d.useEffect(()=>{if(le)if(ee==="approved"||ee==="failure"||ee==="pending"){a(`/order-success/${le}?status=${ee}`,{replace:!0});return}else Be&&(g.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),De(!1));else De(!1)},[le,ee,Be,a]);const{data:t,isLoading:wr,isError:Cr,error:_r}=me({queryKey:["checkoutRestaurantData"],queryFn:Vs}),{data:Ce=!0,isLoading:Er}=me({queryKey:["deliveryStatus",t==null?void 0:t.id],queryFn:()=>Fs(t.id),enabled:!!(t!=null&&t.id),initialData:!0}),{data:K=[],isLoading:Pr}=me({queryKey:["checkoutPaymentMethods",t==null?void 0:t.id],queryFn:()=>Is(t.id),enabled:!!(t!=null&&t.id)}),{data:Me=[],isLoading:Rr}=me({queryKey:["checkoutDeliveryZones",t==null?void 0:t.id],queryFn:()=>$s(t.id),enabled:!!(t!=null&&t.id)}),Sr=wr||Er||Pr||Rr,Vr=Cr,ze=_r,o=Ur({resolver:Jr(Rs),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),re=o.watch("delivery_option"),_e=o.watch("payment_method_id"),Z=K.find(s=>s.id===_e),M=(Z==null?void 0:Z.name)==="Pagamento online: Pix/Cartão",se=(Z==null?void 0:Z.name)==="Dinheiro",I=o.watch("latitude"),$=o.watch("longitude"),de=o.watch(["street","number","complement","neighborhood","city","zip_code"]),U=re==="delivery",Fr=JSON.stringify({mode:F,fields:de,lat:I,lng:$,deliveryOption:re}),Oe=d.useMemo(()=>typeof I=="number"&&typeof $=="number"&&!isNaN(I)&&!isNaN($)?[I,$]:t!=null&&t.latitude&&(t!=null&&t.longitude)?[t.latitude,t.longitude]:[-23.55052,-46.633308],[I,$,t]),Ge=d.useCallback(s=>{o.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),o.setValue("number",s.house_number||X||"",{shouldValidate:!0}),o.setValue("complement",s.suburb||"",{shouldValidate:!0}),o.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),o.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[o,X]),Ir=async()=>{const s=ke.replace(/\D/g,"");if(s.length!==8){g.warning("Por favor, digite um CEP válido.");return}qe(!0);const c=g.loading("Buscando endereço...");try{const i=await fetch(`https://viacep.com.br/ws/${s}/json/`);if(!i.ok)throw new Error("Falha na busca do CEP.");const m=await i.json();if(m.erro){g.error("CEP não encontrado.");return}o.setValue("street",m.logradouro,{shouldValidate:!0}),o.setValue("number",X,{shouldValidate:!0}),o.setValue("complement","",{shouldValidate:!0}),o.setValue("neighborhood",m.bairro,{shouldValidate:!0}),o.setValue("city",m.localidade,{shouldValidate:!0}),o.setValue("zip_code",m.cep,{shouldValidate:!0});const N=`${m.logradouro}, ${X||"1"}, ${m.localidade}, ${m.uf}`,E=await We(N);E?(o.setValue("latitude",E[0],{shouldValidate:!0}),o.setValue("longitude",E[1],{shouldValidate:!0}),Y(!0),g.success("Endereço encontrado e mapa atualizado!")):(o.setValue("latitude",null,{shouldValidate:!0}),o.setValue("longitude",null,{shouldValidate:!0}),g.warning("Endereço encontrado, mas não foi possível obter as coordenadas. Ajuste o pino no mapa manualmente."))}catch(i){g.error(`Erro na busca: ${i.message}`)}finally{qe(!1),g.dismiss(c)}},$r=d.useCallback(async(s,c)=>{o.setValue("latitude",s,{shouldValidate:!0}),o.setValue("longitude",c,{shouldValidate:!0});const i=g.loading("Atualizando endereço...");try{const m=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${c}&addressdetails=1`,N=await fetch(m);if(!N.ok)throw new Error("Falha ao obter detalhes do endereço.");const E=await N.json();E.address&&(Ge(E.address),g.success("Endereço atualizado a partir do mapa."))}catch(m){g.error(`Erro ao buscar endereço: ${m.message}`)}finally{g.dismiss(i)}},[o,Ge]);d.useEffect(()=>{se||o.setValue("change_for",null,{shouldValidate:!0})},[se,o]),d.useEffect(()=>{re==="pickup"&&(f(0),w(null),G(null),o.setValue("latitude",null),o.setValue("longitude",null),Y(!1)),U&&(o.setValue("latitude",null),o.setValue("longitude",null),Y(!1),F==="manual"&&(Le(""),Ae("")),F==="search"&&(o.setValue("street",""),o.setValue("number",""),o.setValue("complement",""),o.setValue("neighborhood",""),o.setValue("city",""),o.setValue("zip_code","")))},[re,F,U,o,f]),d.useEffect(()=>{K.length>0&&!_e&&o.setValue("payment_method_id",K[0].id)},[K,_e,o]),d.useEffect(()=>{M?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},[M,o]),d.useEffect(()=>{const s=async()=>{if(!Ce){f(0),w(null),G(null);return}if(re==="pickup"||!(t!=null&&t.latitude)||!(t!=null&&t.longitude)){f(0),w(null),G(null);return}y(!0),w(null);let i=null;if(I&&$)i=[I,$];else{const[m,N,E,z,J,H]=de,Q=Fe(H);if(m&&N&&z&&J&&Q.length===8){const Pe=`${m}, ${N} ${E}, ${z}, ${J}, ${H}`,ae=await We(Pe);ae&&(i=ae,o.setValue("latitude",i[0]),o.setValue("longitude",i[1]),Y(!0))}}if(i){const m=[t.latitude,t.longitude],N=ls(i,m,Me);N?(f(N.fee),w(null),G({minTime:N.minTime,maxTime:N.maxTime})):(f(0),w("Seu endereço está fora da nossa área de entrega."),G(null))}else{f(0),G(null);const[m,N,E,z,J,H]=de,Q=m&&N&&z&&J&&Fe(H).length===8;U&&Q?(w("Não foi possível localizar seu endereço para calcular a taxa. Por favor, verifique o endereço ou ajuste o pino no mapa."),t!=null&&t.latitude&&(t!=null&&t.longitude)&&(o.setValue("latitude",t.latitude),o.setValue("longitude",t.longitude),Y(!0))):w(null)}y(!1)},c=setTimeout(()=>{s()},500);return()=>clearTimeout(c)},[Fr,t,Me,o,f,U,I,$,F,de,Ce]),d.useEffect(()=>{if(p.length===0&&!_&&!ce){const s=setTimeout(()=>{g.info("Seu carrinho está vazio. Adicione itens para continuar."),a("/menu")},0);return()=>clearTimeout(s)}},[p.length,a,_,ce]);const Ke=qr({mutationFn:async s=>{if(!t)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&b)throw new Error(b);const c=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),i=s.delivery_option==="delivery"?c:"Retirada no Local";let m;const N=vr(s.phone),E=ve(s.cpf_cnpj||""),{data:z}=await T.from("customers").select("id").eq("phone",N).limit(1).single();if(z)m=z.id,E&&await T.from("customers").update({cpf_cnpj:E}).eq("id",m);else{const{data:A,error:oe}=await T.from("customers").insert({name:s.name,phone:N,email:s.email||null,address:i,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:E||null}).select("id").single();if(oe)throw new Error(`Erro ao criar cliente: ${oe.message}`);m=A.id}const J=M?"pending_payment":"pending",{data:H,error:Q}=await T.from("orders").insert({restaurant_id:t.id,customer_id:m,status:J,total_amount:u,delivery_fee:h,notes:s.notes,delivery_address:i,payment_method_id:s.payment_method_id,change_for:se?s.change_for:null}).select("id").single();if(Q)throw new Error(`Erro ao criar pedido: ${Q.message}`);const ue=H.id,Pe=p.map(A=>({order_id:ue,product_id:A.product_id,quantity:A.quantity,unit_price:A.price,subtotal:A.price*A.quantity,notes:A.notes})),{error:ae}=await T.from("order_items").insert(Pe);if(ae)throw new Error(`Erro ao adicionar itens do pedido: ${ae.message}`);if(M){v(),S(!0),g.info("Redirecionando para o pagamento online...");const A=Ss(),oe={orderId:ue,items:p,totalAmount:parseFloat(u.toFixed(2)),restaurantName:t.name,clientUrl:A,customerEmail:s.email||"cliente@pedido123.com",customerCpfCnpj:E};console.log("Payload enviado para create-payment-preference:",oe);try{const{data:q,error:Ue}=await T.functions.invoke("create-payment-preference",{body:oe});if(Ue)throw new Error(Ue.message);if(q&&q.error)throw new Error(`Mercado Pago Error: ${q.error}`);if(q&&q.init_point){window.location.href=q.init_point;return}else throw new Error("Resposta de pagamento inválida: init_point não encontrado.")}catch(q){throw console.error("Erro ao criar preferência de pagamento:",q),new Error(`Falha ao processar pagamento online: ${q.message}`)}}return ue},onSuccess:s=>{M||(g.success(`Pedido #${s.slice(-4)} realizado com sucesso!`),r.invalidateQueries({queryKey:["orders"]}),a(`/order-success/${s}`))},onError:s=>{let c="Ocorreu um erro ao finalizar seu pedido. Por favor, tente novamente.";const i=s.message||"";i.includes("Mercado Pago Error:")?(c=i.split("Mercado Pago Error:")[1].trim(),c.includes("access token")&&(c="O Access Token do Mercado Pago está incorreto ou ausente. Por favor, verifique as configurações do restaurante.")):i.toLowerCase().includes("access token")||i.toLowerCase().includes("credentials")?c="Ocorreu um problema com a configuração de pagamento do restaurante. Por favor, entre em contato com o estabelecimento.":i.toLowerCase().includes("fora da nossa área de entrega")?c="Seu endereço está fora da nossa área de entrega.":i.toLowerCase().includes("inconsistência no valor total")?c="Erro de cálculo no pedido. Por favor, tente limpar o carrinho e refazer o pedido.":i.toLowerCase().includes("falha ao processar pagamento online")&&(c=i.split("Falha ao processar pagamento online:")[1]||"Erro ao processar pagamento online. Por favor, tente novamente."),g.error("Falha ao processar o pagamento",{description:c,duration:1e4}),S(!1)}}),kr=async s=>{if(M){const c=s.cpf_cnpj||"",i=ve(c);if(i.length!==11&&i.length!==14){o.setError("cpf_cnpj",{type:"manual",message:"CPF/CNPJ é obrigatório para pagamento online."}),g.error("Por favor, preencha o CPF/CNPJ corretamente.");return}}if(se){const c=s.change_for;if(c!=null&&c<u){g.error(`O valor do troco (R$ ${c.toFixed(2).replace(".",",")}) deve ser maior ou igual ao total do pedido (R$ ${u.toFixed(2).replace(".",",")}).`);return}}Ke.mutate(s)},Lr=s=>{Object.keys(s).length>0&&g.error("Por favor, preencha todos os campos obrigatórios e corrija os erros.")};if(p.length===0&&!_&&!ce)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."});if(Sr||ce)return e.jsx(es,{});if(Vr)return e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(te,{variant:"destructive",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(ne,{children:"Erro de Conexão"}),e.jsx(ie,{children:ze instanceof Error?ze.message:"Não foi possível carregar os dados."})]})});const Ee=Ke.isPending||_||V,Ar=!U||!b&&h>=0,Ze=!Ee&&Ar;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Mr,{to:"/menu",children:e.jsx(he,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(ds,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8 max-w-6xl",children:e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(ns,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(kr,Lr),className:"space-y-6",children:[e.jsxs(fe,{children:[e.jsx(ge,{children:e.jsx(xe,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(je,{className:"space-y-4",children:[e.jsx(P,{control:o.control,name:"name",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Nome Completo *"}),e.jsx(L,{placeholder:"Seu nome",...s}),e.jsx(R,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(P,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Telefone *"}),e.jsx(jr,{...s}),e.jsx(R,{})]})}),e.jsx(P,{control:o.control,name:"email",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Email (Opcional)"}),e.jsx(L,{placeholder:"seu@email.com",...s}),e.jsx(R,{})]})})]})]})]}),e.jsxs(fe,{children:[e.jsx(ge,{children:e.jsx(xe,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(je,{className:"space-y-4",children:[e.jsx(P,{control:o.control,name:"delivery_option",render:({field:s})=>e.jsxs(x,{className:"space-y-3",children:[e.jsx(B,{children:e.jsxs(ye,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(x,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(B,{children:e.jsx(W,{value:"delivery"})}),e.jsx(Se,{className:"h-5 w-5 text-primary"}),e.jsx(C,{className:"font-normal flex-1 cursor-pointer",children:"Delivery"})]}),e.jsxs(x,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(B,{children:e.jsx(W,{value:"pickup"})}),e.jsx(sr,{className:"h-5 w-5 text-primary"}),e.jsx(C,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(R,{})]})}),U&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(ms,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs(ye,{value:F,onValueChange:s=>Nr(s),className:"flex gap-4",children:[e.jsxs(x,{className:"flex items-center space-x-2",children:[e.jsx(B,{children:e.jsx(W,{value:"search",id:"r-search"})}),e.jsx(Re,{htmlFor:"r-search",className:"cursor-pointer",children:"Buscar por CEP"})]}),e.jsxs(x,{className:"flex items-center space-x-2",children:[e.jsx(B,{children:e.jsx(W,{value:"manual",id:"r-manual"})}),e.jsx(Re,{htmlFor:"r-manual",className:"cursor-pointer",children:"Digitar Manualmente"})]})]}),F==="search"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Re,{children:"Buscar Endereço por CEP e Número"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Qe,{placeholder:"Digite o CEP",value:ke,onChange:s=>Le(s.target.value)}),e.jsx(L,{placeholder:"Número",value:X,onChange:s=>Ae(s.target.value)}),e.jsx(he,{type:"button",onClick:Ir,disabled:Te,children:Te?e.jsx(pe,{className:"h-4 w-4 animate-spin"}):e.jsx(is,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(P,{control:o.control,name:"street",render:({field:s})=>e.jsxs(x,{className:"col-span-2",children:[e.jsx(C,{children:"Rua *"}),e.jsx(L,{...s,disabled:F==="search"}),e.jsx(R,{})]})}),e.jsx(P,{control:o.control,name:"number",render:({field:s})=>e.jsxs(x,{className:"col-span-1",children:[e.jsx(C,{children:"Número *"}),e.jsx(L,{...s,disabled:F==="search"}),e.jsx(R,{})]})})]}),e.jsx(P,{control:o.control,name:"complement",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Complemento (Opcional)"}),e.jsx(L,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(R,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(P,{control:o.control,name:"neighborhood",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Bairro *"}),e.jsx(L,{...s,disabled:F==="search"}),e.jsx(R,{})]})}),e.jsx(P,{control:o.control,name:"city",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Cidade *"}),e.jsx(L,{...s,disabled:F==="search"}),e.jsx(R,{})]})})]}),e.jsx(P,{control:o.control,name:"zip_code",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"CEP *"}),e.jsx(Qe,{...s,disabled:F==="search"}),e.jsx(R,{})]})}),br&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(cs,{center:Oe,markerPosition:Oe,onLocationChange:$r,isInteractive:!1}),I!==null&&$!==null&&e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",I==null?void 0:I.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",$==null?void 0:$.toFixed(6)]})]})]}),V&&e.jsxs(te,{children:[e.jsx(pe,{className:"h-4 w-4 animate-spin"}),e.jsx(ne,{children:"Calculando Taxa..."}),e.jsx(ie,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),b&&e.jsxs(te,{variant:"destructive",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(ne,{children:"Erro de Entrega"}),e.jsx(ie,{children:b})]}),h>0&&!V&&e.jsxs(te,{className:"mt-4",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(ne,{children:"Taxa de Entrega Aplicada"}),e.jsxs(ie,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(h)]})]}),!Ce&&e.jsxs(te,{className:"mt-4",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(ne,{children:"Taxas de Entrega Desativadas"}),e.jsx(ie,{children:"No momento, as taxas de entrega estão desativadas. A entrega será gratuita."})]})]})]})]}),e.jsxs(fe,{children:[e.jsx(ge,{children:e.jsx(xe,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(je,{className:"space-y-4",children:[e.jsx(P,{control:o.control,name:"payment_method_id",render:({field:s})=>e.jsxs(x,{className:"space-y-3",children:[e.jsx(B,{children:e.jsx(ye,{onValueChange:c=>{s.onChange(c);const i=K.find(m=>m.id===c);(i==null?void 0:i.name)!=="Dinheiro"&&o.setValue("change_for",null,{shouldValidate:!0}),(i==null?void 0:i.name)==="Pagamento online: Pix/Cartão"?o.trigger("cpf_cnpj"):o.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:K.map(c=>{const i=ks(c.icon||"Store");return e.jsxs(x,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(B,{children:e.jsx(W,{value:c.id})}),e.jsx(i,{className:"h-5 w-5 text-primary"}),e.jsxs(C,{className:"font-normal flex-1 cursor-pointer",children:[c.name,e.jsx("span",{className:"block text-xs text-muted-foreground",children:c.description})]})]},c.id)})})}),e.jsx(R,{})]})}),M&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(ar,{className:"h-4 w-4"})," Detalhes Adicionais"]}),e.jsx(P,{control:o.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"CPF/CNPJ * (obrigatório para pagamento online)"}),e.jsx(B,{children:e.jsx(yr,{...s})}),e.jsx(R,{})]})})]}),se&&e.jsx(P,{control:o.control,name:"change_for",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Precisa de troco para quanto? (R$)"}),e.jsx(L,{type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2}).format(u),...s,value:s.value===null||s.value===void 0?"":String(s.value),onChange:c=>{const i=c.target.value;s.onChange(i===""?null:i)}}),e.jsx(R,{})]})}),e.jsx(P,{control:o.control,name:"notes",render:({field:s})=>e.jsxs(x,{children:[e.jsx(C,{children:"Observações do Pedido (Opcional)"}),e.jsx(ts,{placeholder:"Ex: Tocar a campainha duas vezes...",...s,rows:2}),e.jsx(R,{})]})})]})]}),e.jsx("div",{className:"lg:hidden sticky bottom-0 bg-card p-4 border-t shadow-2xl",children:e.jsx(he,{type:"submit",className:"w-full h-12 text-lg",disabled:!Ze,children:Ee?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u)}`})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(he,{type:"submit",className:"w-full h-12 text-lg",disabled:!Ze,children:Ee?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(u)}`})})]})})}),e.jsx("div",{className:"lg:col-span-1 hidden lg:block",children:e.jsx(Ls,{...n})})]})})]})};export{ca as default};
