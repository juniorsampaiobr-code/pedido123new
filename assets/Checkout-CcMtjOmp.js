import{u as le,j as e,a as Vr,b as Ce}from"./tanstack-C7aOFagJ.js";import{r as m,h as qr,i as zr,k as Br,L as Re}from"./vendor-DjsPZZVP.js";import{c as nr,s as I,j as g,a7 as ar,a8 as Fe,a9 as we,aa as Pe,ab as Kr,ac as Ur,ah as Zr,ad as Hr,a as me,D as Ue,v as Ze,L as ue,w as Qr,x as Xr,$ as sr,y as Yr,B as Z,C as H,e as Q,f as X,_ as Ie,b as Y,o as or,n as G,N as Jr,aD as Wr,aE as et,u as rt,r as He,V as te,W as Qe,X as oe,Y as ie,d as Xe,ae as tt,aF as nt,U as Ye,aG as at,h as O,I as ne,aH as de,P as st,i as ot,a2 as ye,a1 as it,R as ct,af as dt,T as lt,t as Je}from"./index-DZNM4xQE.js";import{c as ir,R as ut,I as mt}from"./index-Ch9ErxJC.js";import{u as ft}from"./index-C3WaO5Hu.js";import{S as We}from"./separator-DAiiqXv3.js";import{L as pt,Z as ht}from"./LazyMap-CDywOq3w.js";import{C as Se}from"./circle-alert-qFTegEqg.js";import{M as xt}from"./mail-wO8tiPq1.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=nr("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=nr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),jt=async()=>{const{data:r,error:a}=await I.from("restaurants").select("id").limit(1).single();if(a||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const t=r.id,{data:o,error:c}=await I.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",t).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${c.message}`);return(o==null?void 0:o.mercado_pago_public_key)||null},cr=()=>le({queryKey:["mercadoPagoPublicKey"],queryFn:jt,staleTime:1/0}),vt=(r,a,t,o)=>{const l=(t-r)*(Math.PI/180),u=(o-a)*(Math.PI/180),s=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(u/2)*Math.sin(u/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))},er=async(r,a)=>{const t=r.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1&addressdetails=1`,c=new AbortController,l=setTimeout(()=>c.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const u=await fetch(o,{signal:c.signal,headers:{"User-Agent":"Pedido123-App/1.0 (https://juniorsampaiobr-code.github.io/pedido123new/)"}});if(!u.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",u.status),null;const s=await u.json();if(s&&Array.isArray(s)&&s.length>0){const E=s[0],C=parseFloat(E.lat),w=parseFloat(E.lon);if(Number.isFinite(C)&&Number.isFinite(w))return console.log("LOG: geocodeAddress - Geocodificação bem-sucedida. Coordenadas:",[C,w]),{lat:C,lng:w}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",t),g.error("Não foi possível encontrar o endereço. Verifique todos os campos e tente novamente."),null}catch(u){return u instanceof Error&&u.name==="AbortError"?(console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",t),g.error("A requisição para encontrar o endereço demorou muito. Tente novamente.")):(console.error("LOG: geocodeAddress - Erro durante a requisição:",u),g.error("Ocorreu um erro ao buscar o endereço. Tente novamente.")),null}finally{clearTimeout(l)}},rr=(r,a,t)=>{const o=vt(a[0],a[1],r[0],r[1]),c=t.find(l=>o<=l.max_distance_km);if(c){const l=c.delivery_fee||0,u=c.min_delivery_time_minutes||0,s=u+15;return{fee:parseFloat(l.toFixed(2)),minTime:u,maxTime:s}}return null};var Le="Radio",[wt,dr]=ar(Le),[_t,bt]=wt(Le),lr=m.forwardRef((r,a)=>{const{__scopeRadio:t,name:o,checked:c=!1,required:l,disabled:u,value:s="on",onCheck:E,form:C,...w}=r,[S,L]=m.useState(null),b=Fe(a,D=>L(D)),M=m.useRef(!1),P=S?C||!!S.closest("form"):!0;return e.jsxs(_t,{scope:t,checked:c,disabled:u,children:[e.jsx(we.button,{type:"button",role:"radio","aria-checked":c,"data-state":pr(c),"data-disabled":u?"":void 0,disabled:u,value:s,...w,ref:b,onClick:Pe(r.onClick,D=>{c||E==null||E(),P&&(M.current=D.isPropagationStopped(),M.current||D.stopPropagation())})}),P&&e.jsx(fr,{control:S,bubbles:!M.current,name:o,value:s,checked:c,required:l,disabled:u,form:C,style:{transform:"translateX(-100%)"}})]})});lr.displayName=Le;var ur="RadioIndicator",mr=m.forwardRef((r,a)=>{const{__scopeRadio:t,forceMount:o,...c}=r,l=bt(ur,t);return e.jsx(Kr,{present:o||l.checked,children:e.jsx(we.span,{"data-state":pr(l.checked),"data-disabled":l.disabled?"":void 0,...c,ref:a})})});mr.displayName=ur;var Nt="RadioBubbleInput",fr=m.forwardRef(({__scopeRadio:r,control:a,checked:t,bubbles:o=!0,...c},l)=>{const u=m.useRef(null),s=Fe(u,l),E=ft(t),C=Ur(a);return m.useEffect(()=>{const w=u.current;if(!w)return;const S=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(S,"checked").set;if(E!==t&&b){const M=new Event("click",{bubbles:o});b.call(w,t),w.dispatchEvent(M)}},[E,t,o]),e.jsx(we.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...c,tabIndex:-1,ref:s,style:{...c.style,...C,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});fr.displayName=Nt;function pr(r){return r?"checked":"unchecked"}var Et=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],_e="RadioGroup",[Ct,on]=ar(_e,[ir,dr]),hr=ir(),xr=dr(),[Rt,St]=Ct(_e),gr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,name:o,defaultValue:c,value:l,required:u=!1,disabled:s=!1,orientation:E,dir:C,loop:w=!0,onValueChange:S,...L}=r,b=hr(t),M=Zr(C),[P,D]=Hr({prop:l,defaultProp:c??null,onChange:S,caller:_e});return e.jsx(Rt,{scope:t,name:o,required:u,disabled:s,value:P,onValueChange:D,children:e.jsx(ut,{asChild:!0,...b,orientation:E,dir:M,loop:w,children:e.jsx(we.div,{role:"radiogroup","aria-required":u,"aria-orientation":E,"data-disabled":s?"":void 0,dir:M,...L,ref:a})})})});gr.displayName=_e;var yr="RadioGroupItem",jr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,disabled:o,...c}=r,l=St(yr,t),u=l.disabled||o,s=hr(t),E=xr(t),C=m.useRef(null),w=Fe(a,C),S=l.value===c.value,L=m.useRef(!1);return m.useEffect(()=>{const b=P=>{Et.includes(P.key)&&(L.current=!0)},M=()=>L.current=!1;return document.addEventListener("keydown",b),document.addEventListener("keyup",M),()=>{document.removeEventListener("keydown",b),document.removeEventListener("keyup",M)}},[]),e.jsx(mt,{asChild:!0,...s,focusable:!u,active:S,children:e.jsx(lr,{disabled:u,required:l.required,checked:S,...E,...c,name:l.name,ref:w,onCheck:()=>l.onValueChange(c.value),onKeyDown:Pe(b=>{b.key==="Enter"&&b.preventDefault()}),onFocus:Pe(c.onFocus,()=>{var b;L.current&&((b=C.current)==null||b.click())})})})});jr.displayName=yr;var Pt="RadioGroupIndicator",vr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,...o}=r,c=xr(t);return e.jsx(mr,{...c,...o,ref:a})});vr.displayName=Pt;var wr=gr,_r=jr,It=vr;const Me=m.forwardRef(({className:r,...a},t)=>e.jsx(wr,{className:me("grid gap-2",r),...a,ref:t}));Me.displayName=wr.displayName;const ve=m.forwardRef(({className:r,...a},t)=>e.jsx(_r,{ref:t,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(It,{className:"flex items-center justify-center",children:e.jsx(yt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ve.displayName=_r.displayName;var Oe={};Object.defineProperty(Oe,"__esModule",{value:!0});var br=Oe.loadMercadoPago=void 0;const Nr="https://sdk.mercadopago.com/js/v2",Mt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,tr="MercadoPago has already been initialized in your window, please remove the duplicate import",Ft="MercadoPago.js not available",Lt="Failed to load MercadoPago.js",Ot=()=>{for(var r=document.querySelectorAll(`script[src^="${Nr}"`),a=0;a<r.length;a++){var t=r[a];if(Mt.test(t.src))return t}return null},At=()=>{const r=document.createElement("script");r.src=Nr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let je=null;const kt=()=>(je!==null||(je=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(tr),r(window.MercadoPago);return}try{let t=Ot();t?console.warn(tr):t||(t=At()),t.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(Ft))}),t.addEventListener("error",()=>{a(new Error(Lt))})}catch(t){a(t);return}})),je);br=Oe.loadMercadoPago=kt;var Tt=function(r,a,t,o){function c(l){return l instanceof t?l:new t(function(u){u(l)})}return new(t||(t=Promise))(function(l,u){function s(w){try{C(o.next(w))}catch(S){u(S)}}function E(w){try{C(o.throw(w))}catch(S){u(S)}}function C(w){w.done?l(w.value):c(w.value).then(s,E)}C((o=o.apply(r,a||[])).next())})};class U{static getInstance(){return Tt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield br(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}U.publicKey=null;U.options={};U.instanceMercadoPago=void 0;U.loadedInstanceMercadoPago=!1;function Dt(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(o=>Object.prototype.hasOwnProperty.call(a,o)&&r[o]===a[o])}const $t=(r,a)=>{const t=Object.assign(Object.assign({},a),{frontEndStack:"react"}),o=!Dt(U.options,t);(r!==U.publicKey||o)&&(U.publicKey=r,U.options=t,U.instanceMercadoPago=void 0)},Gt=({preferenceId:r,initPoint:a,onClose:t})=>{const{data:o,isLoading:c}=cr();return m.useEffect(()=>{if(o)try{$t(o,{locale:"pt-BR"})}catch(l){console.error("Erro ao inicializar Mercado Pago:",l),g.error("Erro ao carregar o SDK do Mercado Pago."),t();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[o,t,a]),c||!o?e.jsx(Ue,{open:!0,onOpenChange:t,children:e.jsx(Ze,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(Ue,{open:!0,onOpenChange:t,children:e.jsxs(Ze,{className:"sm:max-w-[425px]",children:[e.jsxs(Qr,{children:[e.jsxs(Xr,{className:"flex items-center gap-2",children:[e.jsx(sr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Yr,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Z,{variant:"outline",onClick:t,children:"Cancelar e Voltar"})]})})},Vt=({latitude:r,longitude:a,address:t,className:o})=>{const c=m.useMemo(()=>[r,a],[r,a]),l=m.useMemo(()=>[r,a],[r,a]),u=m.useMemo(()=>`client-location-${r.toFixed(6)}-${a.toFixed(6)}`,[r,a]);return e.jsxs(H,{className:me("w-full",o),children:[e.jsxs(Q,{children:[e.jsxs(X,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t})]}),e.jsx(Y,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(pt,{center:l,markerPosition:c,onMarkerDragEnd:()=>{},zoom:16},u)})})]})},qt=or({zip_code:G().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:G().min(1,"Rua é obrigatória."),number:G().min(1,"Número é obrigatório."),neighborhood:G().min(1,"Bairro é obrigatório."),city:G().min(1,"Cidade é obrigatória.")}),zt=or({name:G().min(1,"Nome é obrigatório."),phone:G().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:G().email("Email inválido.").optional().or(Jr("")),cpf_cnpj:G().optional().default("").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Wr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:G().optional(),payment_method_id:G().min(1,"Selecione um método de pagamento."),change_for:G().optional()}),Bt=async r=>{const{data:a,error:t}=await I.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},Kt=async r=>{const{data:a,error:t}=await I.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return a},Ut=async r=>{const{data:a,error:t}=await I.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return a},Zt=async r=>{const{data:a,error:t}=await I.from("customers").select("*").eq("user_id",r).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(t.message);return a||null},cn=()=>{var Ve,qe,ze,Be,Ke;const r=qr(),a=zr(),[t]=Br(),o=Vr(),{items:c,totalAmount:l,clearCart:u}=et(),{data:s,isLoading:E}=rt(),{data:C}=cr(),[w,S]=m.useState(!1),[L,b]=m.useState(!1),[M,P]=m.useState(0),[D,V]=m.useState(null),[be,q]=m.useState(!0),[J,fe]=m.useState(null),[Er,Ne]=m.useState(!1),[Cr,Rr]=m.useState(null),[Ae,Sr]=m.useState(null),[K,W]=m.useState(!1),Pr=(Ve=a.state)==null?void 0:Ve.restaurantId,Ir=t.get("restaurantId"),z=Pr||Ir;m.useEffect(()=>{console.log("LOG: Checkout - User Status:",s?`Logged in as ${s.email}`:"Anonymous")},[s]);const{data:y,isLoading:Mr,isError:Fr,error:ke,refetch:Lr}=le({queryKey:["checkoutRestaurantData",z],queryFn:()=>Bt(z),enabled:!!z,staleTime:1/0}),{data:ee,isLoading:Or}=le({queryKey:["checkoutDeliveryZones",z],queryFn:()=>Kt(y.id),enabled:!!y,staleTime:1/0}),{data:ae,isLoading:Ar}=le({queryKey:["checkoutPaymentMethods",z],queryFn:()=>Ut(y.id),enabled:!!y,staleTime:1/0}),{data:j,isLoading:Te,refetch:Ht}=le({queryKey:["checkoutCustomerData",s==null?void 0:s.id],queryFn:()=>Zt(s.id),enabled:!!s,staleTime:0}),pe=m.useMemo(()=>y!=null&&y.latitude&&(y!=null&&y.longitude)?[y.latitude,y.longitude]:null,[y]),Ee=m.useCallback(async(n,i,f,h,x,p,R)=>{const v=[30,45];if(y&&y.delivery_enabled===!1){const _=`${i}, ${f}, ${x}, ${h}, ${n}`;let T=null;if(p&&R)T={lat:p,lng:R};else{b(!0);const re=g.loading("Validando endereço para frete grátis...");T=await er(_),b(!1),g.dismiss(re)}if(!T)return P(0),V(null),q(!1),g.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(fe([T.lat,T.lng]),ee&&ee.length>0){const re=rr([T.lat,T.lng],pe,ee);if(re)return P(0),V([re.minTime,re.maxTime]),q(!0),{coords:T,fee:0,time:[re.minTime,re.maxTime],isValid:!0}}return P(0),V(v),q(!0),{coords:T,fee:0,time:v,isValid:!0}}if(!y||!pe)return P(0),q(!0),V(v),{coords:null,fee:0,time:v,isValid:!0};const $=`${i}, ${f}, ${x}, ${h}, ${n}`;let k=null;if(p&&R)k={lat:p,lng:R};else{b(!0);const _=g.loading("Calculando taxa de entrega...");k=await er($),b(!1),g.dismiss(_)}if(!k)return P(0),V(null),q(!1),g.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(fe([k.lat,k.lng]),ee&&ee.length>0){const _=rr([k.lat,k.lng],pe,ee);return _?(P(_.fee),V([_.minTime,_.maxTime]),q(!0),{coords:k,fee:_.fee,time:[_.minTime,_.maxTime],isValid:!0}):(P(0),V(null),q(!1),g.error("Endereço fora da área de entrega."),{coords:k,fee:0,time:null,isValid:!1})}else return P(0),V(v),q(!0),{coords:k,fee:0,time:v,isValid:!0}},[y,pe,ee]),d=He({resolver:Je(zt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),N=He({resolver:Je(qt),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),A=d.watch("delivery_option"),kr=d.watch("payment_method_id"),se=ae==null?void 0:ae.find(n=>n.id===kr),he=(qe=se==null?void 0:se.name)==null?void 0:qe.includes("online"),ce=(ze=se==null?void 0:se.name)==null?void 0:ze.includes("Dinheiro"),B=l+M,F=N.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{const n=[15,30];A==="pickup"?(P(0),q(!0),W(!0),V(n)):(W(!1),V(null))},[A]),m.useEffect(()=>{if(j){let n="",i="",f="",h="",x="";if(j.address){const p=j.address.split(", ").map(R=>R.trim());p.length>=5?(n=p[0],i=p[1],f=p[2],h=p[3],x=p[4]):p.length>=4&&(n=p[0],f=p[1],h=p[2],x=p[3])}d.reset({...d.getValues(),name:j.name||"",phone:j.phone||"",email:j.email||"",cpf_cnpj:j.cpf_cnpj||"",change_for:""}),N.reset({zip_code:x,street:n,number:i,neighborhood:f,city:h}),j.address&&j.latitude&&j.longitude&&(fe([j.latitude,j.longitude]),W(!0),Ee(x,n,i,h,f,j.latitude,j.longitude))}else if(s&&!Te){const n=s.user_metadata;d.reset({...d.getValues(),name:n.full_name||"",phone:n.phone||"",email:s.email||"",cpf_cnpj:n.cpf_cnpj||"",change_for:""})}},[j,d,s,Te,N,Ee]);const xe=d.watch("change_for");m.useEffect(()=>{if(ce&&xe&&xe.trim()!==""){const n=xe.replace(",","."),i=parseFloat(n);isNaN(i)?d.setError("change_for",{message:"O troco deve ser um número válido."}):i<B?d.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B)}).`}):d.clearErrors("change_for")}else d.clearErrors("change_for")},[ce,xe,B,d]);const ge=Ce({mutationFn:async n=>{var p;const f=(p=(await I.auth.getUser()).data.user)==null?void 0:p.id;if(!(j!=null&&j.id)&&!f)throw new Error("ID do cliente ou usuário não encontrado.");const h=`${n.street}, ${n.number}, ${n.neighborhood}, ${n.city}, ${n.zip_code}`,x={user_id:(s==null?void 0:s.id)||null,name:d.getValues("name"),phone:d.getValues("phone"),email:d.getValues("email")||null,cpf_cnpj:d.getValues("cpf_cnpj")||null,address:h,latitude:n.lat,longitude:n.lng};if(j!=null&&j.id){const{data:R,error:v}=await I.from("customers").update(x).eq("id",j.id).select().single();if(v)throw v;return R}else if(f){const{data:R,error:v}=await I.from("customers").insert(x).select().single();if(v)throw v;return R}else return{id:"anonymous",user_id:null,name:x.name,phone:x.phone,email:x.email,address:h,created_at:"",updated_at:"",latitude:n.lat,longitude:n.lng,cpf_cnpj:x.cpf_cnpj}},onSuccess:(n,i)=>{n.id!=="anonymous"&&o.invalidateQueries({queryKey:["checkoutCustomerData"]}),P(i.fee),V(i.time),q(i.isValid),W(!0),fe([i.lat,i.lng]),g.success("Endereço salvo e taxa de entrega calculada!")},onError:n=>{g.error(`Erro ao salvar endereço: ${n.message}`),W(!1)}}),Tr=async()=>{if(A==="pickup")return;if(!await N.trigger()){g.error("Preencha todos os campos obrigatórios do endereço.");return}const i=N.getValues(),f=await Ee(i.zip_code,i.street,i.number,i.city,i.neighborhood);if(!f.isValid){W(!1);return}if(!f.coords){g.error("Não foi possível obter as coordenadas para salvar o endereço."),W(!1);return}ge.mutate({...i,lat:f.coords.lat,lng:f.coords.lng,fee:f.fee,time:f.time,isValid:f.isValid})},De=Ce({mutationFn:async n=>{var p,R;(p=(await I.auth.getUser()).data.user)==null||p.id;const f=n.phone.replace(/\D/g,""),h=((R=n.cpf_cnpj)==null?void 0:R.replace(/\D/g,""))||null,x={user_id:(s==null?void 0:s.id)||null,name:n.name,phone:f,email:n.email||null,cpf_cnpj:h,address:A==="delivery"?`${F[1]}, ${F[2]}, ${F[4]}, ${F[3]}, ${F[0]}`:null,latitude:J?J[0]:null,longitude:J?J[1]:null};if(s)if(j){const{data:v,error:$}=await I.from("customers").update(x).eq("id",j.id).select().single();if($)throw $;return v}else{const{data:v,error:$}=await I.from("customers").insert(x).select().single();if($)throw $;return v}else{const{data:v,error:$}=await I.from("customers").insert(x).select().single();if($)throw $;return v}},onSuccess:()=>{o.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:n=>{g.error(`Erro ao salvar dados do cliente: ${n.message}`)}}),$e=Ce({mutationFn:async({customerId:n,data:i})=>{if(!y)throw new Error("Dados do restaurante não disponíveis.");let f=null;if(ce&&i.change_for&&i.change_for.trim()!==""){const _=i.change_for.replace(",","."),T=parseFloat(_);!isNaN(T)&&T>B&&(f=T)}let[h,x]=D||[null,null];if((A==="delivery"||A==="pickup")&&(!h||!x)){const _=A==="pickup"?[15,30]:[30,45];h=_[0],x=_[1]}console.log("LOG: Tempo de entrega salvo no pedido:",h,x);const p={restaurant_id:y.id,customer_id:n,status:he?"pending_payment":"pending",total_amount:B,delivery_fee:M,delivery_address:A==="delivery"?`${F[1]}, ${F[2]}, ${F[4]}, ${F[3]}, ${F[0]}`:null,notes:i.notes,payment_method_id:i.payment_method_id,change_for:f,min_delivery_time_minutes:h,max_delivery_time_minutes:x},{data:R,error:v}=await I.from("orders").insert(p).select("id").single();if(v)throw v;const $=c.map(_=>({order_id:R.id,product_id:_.product.id,quantity:parseFloat(_.quantity.toFixed(3)),unit_price:parseFloat(_.product.price.toFixed(2)),subtotal:parseFloat(_.subtotal.toFixed(2)),notes:_.notes})),{error:k}=await I.from("order_items").insert($);if(k)throw k;return R.id},onSuccess:n=>{o.invalidateQueries({queryKey:["orders"]})},onError:n=>{g.error(`Erro ao criar pedido: ${n.message}`)}}),Dr=async n=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",he),console.log("LOG: deliveryOption:",A),console.log("LOG: isAddressSaved: ",K),console.log("LOG: change_for data:",n.change_for),ce&&n.change_for&&n.change_for.trim()!==""){const h=n.change_for.replace(",","."),x=parseFloat(h);if(isNaN(x)){g.error("O troco deve ser um número válido.");return}if(x<B){d.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B)}).`});return}}if(c.length===0){g.error("Seu carrinho está vazio."),r(`/menu/${z}`);return}if(A==="delivery"){if(!K){g.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!be){g.error("O endereço de entrega está fora da área de cobertura.");return}}let i;try{console.log("LOG: Criando/Atualizando cliente..."),i=(await De.mutateAsync(n)).id,console.log("LOG: Cliente ID:",i)}catch(h){g.error(`Falha ao salvar cliente: ${h.message}`);return}let f;try{console.log("LOG: Criando pedido..."),f=await $e.mutateAsync({customerId:i,data:n}),console.log("LOG: Pedido ID:",f)}catch(h){g.error(`Falha ao criar pedido: ${h.message}`);return}he?(console.log("LOG: Iniciando checkout Mercado Pago..."),await $r(f,n)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),u(),r(`/order-success/${f}`,{replace:!0}))},$r=async(n,i)=>{if(!y)return;const f=window.location.origin+window.location.pathname,h=c.map(p=>({name:p.product.name,price:p.product.price,quantity:p.quantity})),x=g.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:p,error:R}=await I.functions.invoke("create-payment-preference",{body:{orderId:n,items:h,totalAmount:B,restaurantName:y.name,clientUrl:f,customerEmail:i.email||(s==null?void 0:s.email)||"cliente@anonimo.com",customerCpfCnpj:i.cpf_cnpj}});if(R)throw R;const{init_point:v}=p;console.log("LOG: Preferência MP criada. init_point:",v),Rr(n),Sr(v),Ne(!0),g.dismiss(x)}catch(p){console.error("Erro ao criar preferência MP:",p),g.dismiss(x),g.error(`Erro no pagamento online: ${p.message}`),Ne(!1)}},Gr=async()=>{await I.auth.signOut(),g.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!z)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro de Rastreamento"}),e.jsx(ie,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Re,{to:"/",children:e.jsx(Z,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(c.length===0)return m.useEffect(()=>{r(`/menu/${z}`)},[r,z]),e.jsx(Xe,{});if(Mr||Or||Ar||E)return e.jsx(Xe,{});if(Fr||!y)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx(oe,{children:"Erro Crítico"}),e.jsx(ie,{children:ke instanceof Error?ke.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Z,{onClick:()=>Lr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(tt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ge=De.isPending||$e.isPending||ge.isPending||L||A==="delivery"&&!K;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(nt,{isOpen:w,onClose:()=>S(!1),customer:j}),Er&&Ae&&e.jsx(Gt,{preferenceId:Cr,initPoint:Ae,onClose:()=>Ne(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Re,{to:`/menu/${z}`,children:e.jsx(Z,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(gt,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:y.name})]})]}),s&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{variant:"outline",size:"icon",onClick:()=>S(!0),"aria-label":"Meu Perfil",children:e.jsx(Ye,{className:"h-4 w-4"})}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:Gr,children:[e.jsx(at,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(X,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ye,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(Y,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:s?`Logado como ${s.email}. ${j?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:d.handleSubmit(Dr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(ne,{id:"name",...d.register("name")}),d.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"phone",children:"Telefone *"}),e.jsx(de,{name:"phone",control:d.control,render:({field:n})=>e.jsx(st,{id:"phone",...n})}),d.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(ne,{id:"email",type:"email",...d.register("email")}),d.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(de,{name:"cpf_cnpj",control:d.control,render:({field:n})=>e.jsx(ot,{id:"cpf_cnpj",...n})}),d.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(X,{className:"text-xl flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(Y,{children:e.jsx(de,{name:"delivery_option",control:d.control,render:({field:n})=>e.jsxs(Me,{onValueChange:n.onChange,value:n.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(O,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(ye,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(O,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ie,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),A==="delivery"&&e.jsxs(H,{className:me(!K&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(Q,{children:[e.jsxs(X,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",K&&e.jsx(it,{className:"h-5 w-5 text-green-500 ml-2"}),!K&&e.jsx(Se,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(Y,{className:"space-y-4",children:[y.delivery_enabled===!1&&e.jsxs(te,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(oe,{children:"Frete Grátis Ativo"}),e.jsx(ie,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),Tr()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(O,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(de,{name:"zip_code",control:N.control,render:({field:n})=>e.jsx(ht,{id:"zip_code",...n})}),N.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(O,{htmlFor:"street",children:"Rua *"}),e.jsx(ne,{id:"street",...N.register("street")}),N.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"number",children:"Número *"}),e.jsx(ne,{id:"number",...N.register("number")}),N.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(O,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(ne,{id:"neighborhood",...N.register("neighborhood")}),N.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"city",children:"Cidade *"}),e.jsx(ne,{id:"city",...N.register("city")}),N.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.city.message})]}),e.jsxs(Z,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ge.isPending||L,children:[ge.isPending||L?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(ct,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),L&&e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(oe,{children:"Calculando Taxa de Entrega..."})]}),K&&!L&&e.jsxs(e.Fragment,{children:[y.delivery_enabled!==!1&&!be&&e.jsxs(te,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(oe,{children:"Fora da Área de Entrega"}),e.jsx(ie,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(y.delivery_enabled===!1||be&&D)&&e.jsxs(te,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(oe,{children:"Entrega Disponível"}),e.jsxs(ie,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(M),". Tempo estimado: ",D?`${D[0]} - ${D[1]}`:"30 - 45"," minutos."]})]})]}),K&&J&&e.jsx("div",{className:"mt-6",children:e.jsx(Vt,{latitude:J[0],longitude:J[1],address:`${F[1]}, ${F[2]} - ${F[4]}, ${F[3]}, ${F[0]}`})})]})]}),e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(X,{className:"text-xl flex items-center gap-2",children:[e.jsx(sr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(Y,{children:[e.jsx(de,{name:"payment_method_id",control:d.control,render:({field:n})=>e.jsx(Me,{onValueChange:n.onChange,value:n.value,className:"space-y-3",children:ae==null?void 0:ae.map(i=>{var h;const f=((h=i.name)==null?void 0:h.includes("online"))&&!C;return e.jsx(O,{htmlFor:i.id,className:me("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",f&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{value:i.id,id:i.id,disabled:f}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.description}),f&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},i.id)})})}),d.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:d.formState.errors.payment_method_id.message})]})]}),ce&&e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(X,{className:"text-xl flex items-center gap-2",children:[e.jsx(dt,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(Y,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(ne,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B),...d.register("change_for")}),((Be=d.formState.errors.change_for)==null?void 0:Be.message)&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message}),((Ke=d.formState.errors.change_for)==null?void 0:Ke.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message})]})})]}),e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(X,{className:"text-xl flex items-center gap-2",children:[e.jsx(xt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(Y,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(lt,{id:"notes",...d.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(H,{className:"shadow-lg",children:[e.jsx(Q,{children:e.jsx(X,{className:"text-2xl",children:"Resumo"})}),e.jsxs(Y,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:c.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[n.quantity,"x ",n.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.subtotal)})]},n.product.id))}),e.jsx(We,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(M)})]})]}),e.jsx(We,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B)})]}),e.jsx(Z,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ge,children:Ge?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):he?"Pagar e Finalizar":"Confirmar Pedido"}),A==="delivery"&&!K&&e.jsxs(te,{variant:"destructive",className:"mt-3",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(ie,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Re,{to:`/menu/${y.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{cn as default};
