import{j as e,a as V,u as K,b as ae}from"./tanstack-C7aOFagJ.js";import{i as H,L as se,r as t,h as oe,O as ne}from"./vendor-DjsPZZVP.js";import{c as _,a as te,S as W,X as ie,aM as le,aN as ce,B as E,aO as de,o as ue,l as A,s as d,p as me,t as he,j as y,D as fe,q as xe,r as pe,v as ge,U as k,w as je,F as be,h as ye,I,x as M,y as q,z as O,A as F,E as $,P as we,G as ve,L as Ne,aL as Se,d as P,O as U,R as z,V as G,aP as Ce,aQ as Ee,aR as Pe}from"./index-DOftME5z.js";import{L as _e}from"./Logo-BWvTYTiS.js";import{P as ke}from"./package-BBmulOSc.js";import{C as De}from"./credit-card-BNbRjZ4H.js";import{T as Te}from"./truck-BnvlIx4u.js";import{S as Re}from"./settings-B93ZAuga.js";import{S as Le}from"./use-sound-BhkF2W4n.js";import{S}from"./skeleton-BavfB3xa.js";import{M as Ae}from"./mail-DGniynvj.js";import{C as Q}from"./circle-alert-C7Y2lt6n.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=_("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=_("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=_("Wallet",[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]]),Oe=[{href:"/dashboard",label:"Dashboard",icon:Ie},{href:"/products",label:"Produtos",icon:ke},{href:"/orders",label:"Pedidos",icon:W},{href:"/cashier",label:"Caixa",icon:qe},{href:"/hours",label:"Hor√°rios",icon:ie},{href:"/payments",label:"Pagamentos",icon:De},{href:"/delivery",label:"Taxa de Entrega",icon:Te},{href:"/settings",label:"Configura√ß√µes",icon:Re}],B=()=>{const a=H();return e.jsxs("aside",{className:"w-64 flex-shrink-0 border-r bg-card h-screen sticky top-0 flex-col flex",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx(_e,{})}),e.jsx("nav",{className:"flex-grow p-4",children:e.jsx("ul",{children:Oe.map(s=>e.jsx("li",{children:e.jsxs(se,{to:s.href,className:te("flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",a.pathname===s.href?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted hover:text-foreground"),children:[e.jsx(s.icon,{className:"h-4 w-4"}),s.label]})},s.href))})})]})},Fe=()=>e.jsxs(le,{children:[e.jsx(ce,{asChild:!0,children:e.jsx(E,{variant:"outline",size:"icon",children:e.jsx(Me,{className:"h-4 w-4"})})}),e.jsx(de,{side:"left",className:"p-0 w-64",children:e.jsx(B,{})})]}),$e=a=>a.replace(/\D/g,""),Ue=ue({full_name:A().min(1,"Nome √© obrigat√≥rio."),phone:A().min(1,"Telefone √© obrigat√≥rio.").transform($e).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 d√≠gitos (incluindo DDD)."})}),ze=async a=>{const{data:s,error:o}=await d.from("profiles").select("*").eq("id",a).limit(1).single();if(o&&o.code!=="PGRST116")throw new Error(`Erro ao buscar perfil: ${o.message}`);return s||{id:a,full_name:null,phone:null,avatar_url:null,created_at:null,updated_at:null}},Ge=({isOpen:a,onClose:s,userId:o})=>{var j;const w=V(),{data:f,isLoading:u}=K({queryKey:["adminProfile",o],queryFn:()=>ze(o),enabled:!!o&&a,staleTime:0}),N=(j=d.auth.currentUser)==null?void 0:j.email,n=me({resolver:he(Ue),defaultValues:{full_name:"",phone:""}});t.useEffect(()=>{f&&n.reset({full_name:f.full_name||"",phone:f.phone||""})},[f,n]);const g=ae({mutationFn:async i=>{if(!o)throw new Error("ID do usu√°rio n√£o encontrado.");const x={full_name:i.full_name,phone:i.phone},{error:v}=await d.from("profiles").upsert({...x,id:o},{onConflict:"id"});if(v)throw new Error(v.message)},onSuccess:()=>{y.success("Perfil atualizado com sucesso!"),w.invalidateQueries({queryKey:["adminProfile"]}),s()},onError:i=>{y.error(`Erro ao atualizar perfil: ${i.message}`)}}),m=i=>{g.mutate(i)};return e.jsx(fe,{open:a,onOpenChange:s,children:e.jsxs(xe,{className:"sm:max-w-[425px]",children:[e.jsxs(pe,{children:[e.jsxs(ge,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5 text-primary"}),"Meu Perfil (Admin)"]}),e.jsx(je,{children:"Atualize seus dados de contato."})]}),u?e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(S,{className:"h-4 w-1/3"}),e.jsx(S,{className:"h-10 w-full"}),e.jsx(S,{className:"h-4 w-1/3"}),e.jsx(S,{className:"h-10 w-full"}),e.jsx(S,{className:"h-10 w-full mt-6"})]}):e.jsx(be,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(m),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ye,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Ae,{className:"h-4 w-4"})," Email"]}),e.jsx(I,{value:N||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email n√£o pode ser alterado aqui."})]}),e.jsx(M,{control:n.control,name:"full_name",render:({field:i})=>e.jsxs(q,{children:[e.jsx(O,{children:"Nome Completo *"}),e.jsx(F,{children:e.jsx(I,{placeholder:"Seu nome",...i})}),e.jsx($,{})]})}),e.jsx(M,{control:n.control,name:"phone",render:({field:i})=>e.jsxs(q,{children:[e.jsx(O,{children:"Telefone *"}),e.jsx(F,{children:e.jsx(we,{...i})}),e.jsx($,{})]})}),e.jsx(ve,{className:"pt-4",children:e.jsxs(E,{type:"submit",disabled:g.isPending,children:[g.isPending?e.jsx(Ne,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Salvar Altera√ß√µes"]})})]})})]})})},Qe=[{href:"/dashboard",label:"Dashboard"},{href:"/products",label:"Produtos"},{href:"/orders",label:"Pedidos"},{href:"/cashier",label:"Caixa"},{href:"/hours",label:"Hor√°rios"},{href:"/payments",label:"Pagamentos"},{href:"/delivery",label:"Taxa de Entrega"},{href:"/settings",label:"Configura√ß√µes",icon:k}],Ve=a=>{const s=Qe.find(o=>o.href===a);return s?s.label:"Dashboard"},Ke=async a=>{const{data:s,error:o}=await d.from("user_roles").select("role, restaurant_id").eq("user_id",a).limit(1).single();return o&&o.code!=="PGRST116"?(console.error("Error checking role and restaurant:",o),{role:null,restaurantId:null}):s?{role:s.role,restaurantId:s.restaurant_id}:{role:null,restaurantId:null}},He=()=>{const a=oe(),s=H(),o=V(),[w,f]=t.useState(null),[u,N]=t.useState(void 0),[n,g]=t.useState(null),m=t.useRef(null),[j,i]=t.useState("loading"),[x,v]=t.useState(null),[X,D]=t.useState(!1),{data:h,isLoading:J,isError:Y,error:T}=K({queryKey:["dashboardRestaurant",n],queryFn:async()=>{if(!n)throw new Error("Restaurant ID not found for user.");const{data:l,error:c}=await d.from("restaurants").select("*").eq("id",n).single();if(c)throw new Error(c.message);return l},enabled:!!w&&(u==="admin"||u==="moderator")&&!!n,staleTime:1/0}),b=t.useMemo(()=>!(h!=null&&h.notification_sound_url)||h.notification_sound_url.trim()===""?"./default-notification.mp3":h.notification_sound_url,[h==null?void 0:h.notification_sound_url]);t.useEffect(()=>{const l=async r=>{if(!(r!=null&&r.user)){f(null),N(null),g(null),a("/admin-auth",{replace:!0});return}const{role:p,restaurantId:L}=await Ke(r.user.id);if(f(r.user),N(p),g(L),p==="user"){y.error("Acesso restrito.",{description:"Esta conta √© de cliente e n√£o tem permiss√£o para acessar o painel.",duration:5e3}),await d.auth.signOut();const re=`${window.location.origin}${window.location.pathname}#/`;window.location.href=re;return}p!=="admin"&&p!=="moderator"&&(y.error("Acesso restrito.",{description:"Voc√™ n√£o tem permiss√£o para acessar o painel. Redirecionando para o login de administrador.",duration:5e3}),a("/admin-auth",{replace:!0})),(p==="admin"||p==="moderator")&&!L&&console.error("Admin logged in but missing restaurant ID.")},{data:{subscription:c}}=d.auth.onAuthStateChange((r,p)=>{r==="SIGNED_OUT"?(f(null),N(null),g(null),a("/admin-auth",{replace:!0})):l(p)});return d.auth.getSession().then(({data:{session:r}})=>{l(r)}),()=>c.unsubscribe()},[a]),t.useEffect(()=>{var l;b?((l=m.current)==null?void 0:l.src)!==`${window.location.origin}${window.location.pathname}${b}`&&i("loading"):i("error")},[b]);const C=t.useCallback(()=>{m.current&&(m.current.pause(),m.current.loop=!1,v(null))},[]),R=t.useCallback(l=>{if(m.current&&j==="ready"){if(x)return;v(l),m.current.loop=!0,m.current.play().catch(c=>{console.error("Erro na reprodu√ß√£o autom√°tica de √°udio:",c),v(null)})}},[j,x]);t.useEffect(()=>{if(u!=="admin"&&u!=="moderator"||!n)return;const l=d.channel("new-orders-toast").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},c=>{o.invalidateQueries({queryKey:["orders"]});const r=c.new;r.status==="pending"&&r.id&&r.restaurant_id===n&&(y.info("üîî Novo pedido recebido!",{description:`Pedido #${r.id.slice(-4)} est√° aguardando confirma√ß√£o.`,duration:15e3}),R(r.id))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},c=>{o.invalidateQueries({queryKey:["orders"]});const r=c.new;r.id===x&&C(),r.status==="pending"&&r.id&&c.old.status==="pending_payment"&&r.restaurant_id===n&&y.success("‚úÖ Pagamento Confirmado!",{description:`Pedido #${r.id.slice(-4)} foi pago e est√° pronto para preparo.`,duration:5e3})}).subscribe();return()=>{d.removeChannel(l)}},[o,R,C,x,u,n]);const Z=async()=>{await d.auth.signOut()};if(u===void 0||J)return e.jsx(P,{});if(u!=="admin"&&u!=="moderator")return e.jsx(P,{});if(!n)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(U,{variant:"destructive",className:"max-w-md",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(z,{children:"Erro de Configura√ß√£o"}),e.jsx(G,{children:"Sua conta n√£o est√° vinculada a um restaurante. Por favor, tente fazer login novamente. Se o erro persistir, entre em contato com o suporte."})]})});if(Y)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs(U,{variant:"destructive",className:"max-w-md",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(z,{children:"Erro ao Carregar Restaurante"}),e.jsx(G,{children:T instanceof Error?T.message:"N√£o foi poss√≠vel carregar os dados do seu restaurante."})]})});if(!h)return e.jsx(P,{});const ee=t.useMemo(()=>({playSound:()=>{},stopSoundLoop:C,soundStatus:j==="ready"?"enabled":"disabled",loopingOrderId:x}),[C,j,x]);return e.jsxs(Le.Provider,{value:ee,children:[e.jsx(Ge,{isOpen:X,onClose:()=>D(!1),userId:(w==null?void 0:w.id)||null}),e.jsxs("div",{className:"flex min-h-screen bg-muted/40",children:[e.jsx("div",{className:"hidden lg:flex",children:e.jsx(B,{})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"border-b bg-background sticky top-0 z-40",children:e.jsxs("div",{className:"container max-w-none mx-auto px-4 sm:px-8 h-16 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"lg:hidden",children:e.jsx(Fe,{})}),e.jsx(W,{className:"h-6 w-6 hidden sm:block"}),e.jsx("h1",{className:"text-xl font-semibold",children:Ve(s.pathname)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ce,{children:[e.jsx(Ee,{asChild:!0,children:e.jsx(E,{variant:"outline",size:"icon",onClick:()=>D(!0),"aria-label":"Meu Perfil",children:e.jsx(k,{className:"h-4 w-4"})})}),e.jsx(Pe,{children:"Meu Perfil"})]}),e.jsx(E,{variant:"outline",onClick:Z,children:"Sair"})]})]})}),e.jsx(ne,{context:{restaurant:h,userRestaurantId:n}})]}),b&&e.jsx("audio",{ref:m,src:b.startsWith("http")?b:`${window.location.origin}${window.location.pathname}${b}`,onCanPlayThrough:()=>{i("ready"),console.log("√Åudio carregado e pronto para tocar.")},onError:l=>{console.error("Erro ao carregar o √°udio:",l),y.error("Erro ao carregar o som de notifica√ß√£o.",{description:"Verifique o arquivo em Configura√ß√µes."}),i("error")},className:"hidden"})]})]})},ir=t.memo(He);export{ir as default};
