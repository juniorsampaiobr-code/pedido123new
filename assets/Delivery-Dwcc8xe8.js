import{u as U,a as b,b as z,j as e}from"./tanstack-CuXR15uk.js";import{o as A,s as W,p,e as x,a as G,c as J,d as X,t as Y}from"./types-C7MDFQzg.js";import{s as m}from"./client-DZj4AdSj.js";import{B as v}from"./button-rGG64IHL.js";import{C as ee,a as ae,b as re,d as se}from"./card-C_U7HZMT.js";import{I as g}from"./label-DdASzcsa.js";import{S as te}from"./skeleton-DtKMiA3V.js";import{c as ne,b as oe,u as y}from"./index-BpHful0c.js";import{A as $,a as T,b as Z}from"./alert-DPutq1d9.js";import{F as ie,a as h,b as N,c as w,e as E}from"./form-CUnEKQWY.js";import{u as le,f as de,r as f,L as ce}from"./vendor-C8dS00GB.js";import{S as me}from"./switch-CV053g8g.js";import{T as ue}from"./terminal-BrJj7DNv.js";import{T as pe}from"./trash-2-Dv6rwl8u.js";import{P as xe}from"./plus-Frm8ZrY7.js";import"./supabase-Cd7r4f-z.js";import"./index-DmR3tAS3.js";import"./index-LXKxLGdO.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=ne("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),ge=A({id:W().optional(),max_distance_km:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Distância deve ser um número."}).positive("A distância máxima deve ser maior que zero.")),delivery_fee:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Taxa deve ser um número."}).min(0,"A taxa não pode ser negativa.")),min_delivery_time_minutes:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Tempo deve ser um número."}).min(0,"O tempo mínimo não pode ser negativo.")),center_latitude:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),center_longitude:p(t=>String(t).replace(",","."),x.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),he=A({zones:G(ge)}),ye=async t=>{const{data:i,error:r}=await m.from("restaurants").select("*").eq("id",t).single();if(r)throw new Error(`Erro ao buscar dados do restaurante: ${r.message}`);if(!i)throw new Error("Nenhum restaurante encontrado.");return i},fe=async t=>{const{data:i,error:r}=await m.from("delivery_zones").select("*").eq("restaurant_id",t).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return i},_e=async t=>{const{data:i,error:r}=await m.from("restaurants").select("delivery_enabled").eq("id",t).single();return r?(console.warn("Erro ao buscar status de entrega:",r),!0):i.delivery_enabled??!0},je=async(t,i)=>{const r={delivery_enabled:i},{error:s}=await m.from("restaurants").update(r).eq("id",t);if(s)throw new Error(`Erro ao atualizar status de entrega: ${s.message}`)},Pe=()=>{const t=le(),i=U(),{userRestaurantId:r}=de(),{data:s,isLoading:L}=b({queryKey:["restaurantDataForDelivery",r],queryFn:()=>ye(r),enabled:!!r}),{data:_,isLoading:F,isError:R,error:C}=b({queryKey:["deliveryZones",r],queryFn:()=>fe(r),enabled:!!r}),{data:k,isLoading:I}=b({queryKey:["deliveryStatus",r],queryFn:()=>_e(r),enabled:!!r}),l=J({resolver:Y(he),defaultValues:{zones:[]},mode:"onChange"}),{fields:P,append:S,remove:K,replace:q}=X({control:l.control,name:"zones"}),j=f.useMemo(()=>typeof(s==null?void 0:s.latitude)=="number"&&typeof(s==null?void 0:s.longitude)=="number"?[s.latitude,s.longitude]:[-23.55052,-46.633308],[s==null?void 0:s.latitude,s==null?void 0:s.longitude]),D=f.useCallback(n=>{const o=n.map(a=>({id:a.id,delivery_fee:a.delivery_fee,max_distance_km:a.max_distance_km&&typeof a.max_distance_km=="number"?a.max_distance_km:1,min_delivery_time_minutes:a.min_delivery_time_minutes??0,center_latitude:a.center_latitude,center_longitude:a.center_longitude}));q(o)},[q]);f.useEffect(()=>{_&&D(_)},[_,D]);const M=z({mutationFn:({restaurantId:n,enabled:o})=>je(n,o),onSuccess:(n,o)=>{i.invalidateQueries({queryKey:["deliveryStatus",o.restaurantId]}),i.invalidateQueries({queryKey:["checkoutRestaurantData"]}),y.success(`Taxas de entrega ${o.enabled?"ativadas":"desativadas"} com sucesso!`)},onError:n=>{y.error(`Erro ao atualizar status: ${n.message}`)}}),u=z({mutationFn:async n=>{if(!r)throw new Error("ID do restaurante não disponível.");const o=n.zones.map(c=>({restaurant_id:r,delivery_fee:c.delivery_fee,max_distance_km:c.max_distance_km,min_delivery_time_minutes:c.min_delivery_time_minutes,center_latitude:c.center_latitude,center_longitude:c.center_longitude,is_active:!0})),{error:a}=await m.from("delivery_zones").delete().eq("restaurant_id",r);if(a)throw new Error(`Erro ao limpar zonas antigas: ${a.message}`);const{error:d}=await m.from("delivery_zones").insert(o);if(d)throw new Error(`Erro ao inserir novas zonas: ${d.message}`)},onSuccess:()=>{y.success("Faixas de entrega salvas com sucesso!"),i.invalidateQueries({queryKey:["deliveryZones",r]}),i.invalidateQueries({queryKey:["checkoutDeliveryZones"]})},onError:n=>{y.error(`Erro ao salvar faixas de entrega: ${n.message}`)}}),Q=n=>{u.mutate(n)},V=f.useCallback(()=>{S({delivery_fee:5,max_distance_km:10,min_delivery_time_minutes:30,center_latitude:j[0],center_longitude:j[1]})},[S,j]),O=(s==null?void 0:s.latitude)&&(s==null?void 0:s.longitude),B=n=>{r&&M.mutate({restaurantId:r,enabled:n})};return F||L||I?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsx(te,{className:"h-96 w-full"})})}):R?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs($,{variant:"destructive",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(T,{children:"Erro ao carregar zonas de entrega"}),e.jsx(Z,{children:C instanceof Error?C.message:"Ocorreu um erro desconhecido."})]})})}):O?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(ee,{children:[e.jsx(ae,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(re,{className:"text-2xl font-bold",children:"Taxa de Entrega Dinâmica"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina a taxa de entrega com base na distância máxima em quilômetros (km) a partir do centro do seu restaurante."})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-muted p-3 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Taxas de Entrega"}),e.jsx(me,{checked:k??!0,onCheckedChange:B}),e.jsx("span",{className:"text-sm font-medium",children:k?"Ativadas":"Desativadas"})]})]})}),e.jsx(se,{children:e.jsx(ie,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(Q),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-3 rounded-lg bg-muted/50 font-semibold text-sm text-muted-foreground",children:[e.jsx("div",{className:"col-span-1",children:"Distância (km)"}),e.jsx("div",{className:"col-span-1",children:"Valor da taxa (R$)"}),e.jsx("div",{className:"col-span-1",children:"Tempo mínimo (min)"}),e.jsx("div",{className:"col-span-1 text-center",children:"Ações"})]}),P.map((n,o)=>e.jsxs("div",{className:"grid grid-cols-4 gap-4 items-center p-4 border rounded-lg relative",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${o}.max_distance_km`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",step:"0.1",placeholder:"km",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>{const c=d.target.value,H=c===""?"":parseFloat(c.replace(",","."));a.onChange(H)}})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${o}.delivery_fee`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",step:"0.01",placeholder:"R$",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(h,{control:l.control,name:`zones.${o}.min_delivery_time_minutes`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(g,{type:"number",placeholder:"min",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1 flex justify-center gap-2",children:e.jsx(v,{type:"button",variant:"destructive",size:"icon",onClick:()=>K(o),children:e.jsx(pe,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"hidden",children:[e.jsx(h,{control:l.control,name:`zones.${o}.center_latitude`,render:({field:a})=>e.jsx(g,{type:"hidden",...a})}),e.jsx(h,{control:l.control,name:`zones.${o}.center_longitude`,render:({field:a})=>e.jsx(g,{type:"hidden",...a})})]})]},n.id)),e.jsxs("div",{className:"mt-8 text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:"Atenção!"}),e.jsx("p",{className:"text-muted-foreground",children:"Com a taxa dinâmica habilitada, você pode adicionar cobrar a taxa de entrega de acordo com a distância do local de entrega. Exemplo: até 2km cobrar R$4,00."})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>t("/settings"),children:"Redefinir local da loja"}),e.jsxs(v,{type:"button",className:oe("bg-pink-500 hover:bg-pink-600 text-white",u.isPending&&"opacity-70 cursor-not-allowed"),onClick:V,disabled:u.isPending||!r,children:[e.jsx(xe,{className:"mr-2 h-4 w-4"})," Adicionar taxa dinâmica"]}),e.jsx(v,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:u.isPending||!r,children:u.isPending?"Salvando...":"Salvar Configurações"})]})]})})})]})})}):e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs($,{children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(T,{children:"Endereço Não Configurado"}),e.jsxs(Z,{children:["Para configurar zonas de entrega baseadas em distância, primeiro configure o endereço e as coordenadas do seu restaurante na página de Configurações.",e.jsx(ce,{to:"/settings",children:e.jsx(v,{variant:"link",className:"p-0 h-auto mt-2",children:"Ir para Configurações"})})]})]})})})};export{Pe as default};
