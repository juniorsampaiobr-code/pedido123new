import{j as e}from"./tanstack-d4AvmB45.js";import{u as K,r as c,L as Q}from"./vendor-CnEXr6gt.js";import{L as X}from"./Logo-BsqXqEFW.js";import{B as y}from"./button-DGHVzyiw.js";import{L as g,I as v}from"./label-BRONQEbd.js";import{C as Y,b as Z,c as ee,d as ae,a as re}from"./card-CRR63Gak.js";import{c as se,b as te,L as q,u as s}from"./index-BbQrgWeq.js";import{s as m}from"./client-D5i5GwB9.js";import{M as D,P as oe}from"./PhoneInput-C0Pq0d8P.js";import{S as ne}from"./separator-DycBSaAy.js";import{C as ie}from"./CpfCnpjInput-DHXvsvnI.js";import{L as ce}from"./lock-Bb6eg1xB.js";import{A as le}from"./arrow-left-4n8Zrut6.js";import"./shopping-cart-DQ7HrNB0.js";import"./supabase-BZV_3FV3.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=se("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),U=t=>t.replace(/\D/g,""),R=t=>t.replace(/\D/g,""),O=async t=>{const{data:l,error:n}=await m.from("user_roles").select("role, restaurant_id").eq("user_id",t).limit(1).single();return n&&n.code!=="PGRST116"?(console.error("Error checking role and restaurant:",n),{role:null,restaurantId:null}):l?{role:l.role,restaurantId:l.restaurant_id}:{role:null,restaurantId:null}},ue=async t=>{let{role:l,restaurantId:n}=await O(t.id);if((l==="admin"||l==="moderator")&&n)return{role:l,restaurantId:n};console.log(`[AdminAuth] Running setup for user ${t.id}. Current role: ${l}, Restaurant ID: ${n}`);const j=t.user_metadata.full_name||"Novo Usuário",p=t.user_metadata.store_name||j,i=t.user_metadata.cpf_cnpj||null,C=t.user_metadata.phone||null,{error:h,data:f}=await m.functions.invoke("ensure-admin-access",{body:{userId:t.id,fullName:j,storeName:p,cpfCnpj:i,phone:C}});if(h){console.error("Error setting up admin access:",h);let x="Falha ao configurar acesso de administrador.";throw f&&typeof f=="object"&&"error"in f?x=f.error:h.message.includes("non-2xx status code")?x="Erro interno do servidor (500). Verifique os logs do Supabase.":x=h.message,new Error(x)}const d=await O(t.id);return l=d.role,n=d.restaurantId,{role:l,restaurantId:n}},ke=()=>{const t=K(),[l,n]=c.useState(!0),[j,p]=c.useState(!1),[i,C]=c.useState(!1),[h,f]=c.useState(!1),[d,x]=c.useState(""),[N,T]=c.useState(""),[L,F]=c.useState(""),[S,z]=c.useState(""),[b,J]=c.useState(""),[E,M]=c.useState(""),[P,V]=c.useState(""),[me,I]=c.useState(null),_=async a=>{n(!0);try{const{role:r,restaurantId:o}=await ue(a);if(r==="admin"||r==="moderator")if(o)s.success("Acesso ao painel concedido."),t("/dashboard",{replace:!0});else throw new Error("Sua conta de administrador não está vinculada a um restaurante. Tente novamente ou contate o suporte.");else s.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await m.auth.signOut(),t("/",{replace:!0})}catch(r){console.error("Error during admin setup/redirect:",r),s.error("Erro crítico de autenticação.",{description:r instanceof Error?r.message:"Ocorreu um erro desconhecido. Tente novamente.",duration:8e3}),await m.auth.signOut(),n(!1)}};c.useEffect(()=>{(async()=>{const{data:{session:o}}=await m.auth.getSession();I(o),o!=null&&o.user?_(o.user):n(!1)})();const{data:{subscription:r}}=m.auth.onAuthStateChange((o,u)=>{I(u),o==="SIGNED_IN"&&(u!=null&&u.user)?_(u.user):o==="SIGNED_OUT"&&n(!1)});return()=>r.unsubscribe()},[t]);const $=()=>{if(i){if(!S.trim())return s.error("O Nome Completo é obrigatório."),!1;if(!E.trim())return s.error("O Nome da Loja é obrigatório."),!1;if(U(b).length!==11)return s.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1;const r=R(P);if(r.length!==11&&r.length!==14)return s.error("O CPF deve ter 11 dígitos ou CNPJ 14 dígitos."),!1}return d.trim()?N.length<6?(s.error("A Senha deve ter pelo menos 6 caracteres."),!1):i&&N!==L?(s.error("As senhas não coincidem. Por favor, digite novamente."),!1):!0:(s.error("O Email é obrigatório."),!1)},G=async a=>{if(a.preventDefault(),!!$()){p(!0);try{if(i){const r=U(b),o=R(P),{data:u,error:A}=await m.rpc("check_registration_data",{phone_in:r,cpf_cnpj_in:o});if(A)console.error("Erro ao verificar dados:",A);else if(u){const{phone_exists:w,cpf_exists:W}=u;if(w){s.error("Este telefone já está cadastrado em outra conta."),p(!1);return}if(W){s.error("Este CPF/CNPJ já está cadastrado em outra conta."),p(!1);return}}const{data:H,error:k}=await m.auth.signUp({email:d,password:N,options:{data:{full_name:S,phone:r,store_name:E,cpf_cnpj:o}}});if(k){if(k.message.includes("User already registered")){s.warning("Usuário já cadastrado com este email. Tentando fazer login...");const{error:w}=await m.auth.signInWithPassword({email:d,password:N});if(w)throw w;s.success("Login realizado com sucesso!");return}throw k}H.session?s.success("Conta de administrador criada e login efetuado!"):(s.success("Conta criada! Verifique seu email para confirmar."),p(!1))}else{const{error:r}=await m.auth.signInWithPassword({email:d,password:N});if(r)throw r;s.success("Login realizado com sucesso!")}}catch(r){r.message.includes("Email not confirmed")?s.error("Por favor, verifique seu e-mail para confirmar sua conta."):s.error(r.message||"Erro ao processar autenticação"),p(!1)}}},B=async a=>{if(a.preventDefault(),!d.trim()){s.error("O Email é obrigatório para recuperação de senha.");return}p(!0);try{const o=`${window.location.origin+window.location.pathname}#/password-recovery`,{error:u}=await m.auth.resetPasswordForEmail(d,{redirectTo:o});if(u)throw u;s.success("Email de recuperação enviado!",{description:"Verifique sua caixa de entrada (e spam) para o link de redefinição de senha.",duration:8e3}),f(!1)}catch(r){s.error(r.message||"Erro ao enviar email de recuperação.")}finally{p(!1)}};return l?e.jsx(te,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(X,{className:"justify-center mb-4"})}),e.jsxs(Y,{className:"shadow-xl border-2",children:[e.jsxs(Z,{className:"space-y-1",children:[e.jsxs(ee,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[h?e.jsx(D,{className:"h-6 w-6 text-primary"}):i?e.jsx(de,{className:"h-6 w-6 text-primary"}):e.jsx(ce,{className:"h-6 w-6 text-destructive"}),h?"Recuperar Senha":i?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(ae,{className:"text-center",children:h?"Digite seu email para receber o link de redefinição.":i?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs(re,{className:"space-y-4",children:[h?e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"email",children:"Email *"}),e.jsx(v,{id:"email",type:"email",placeholder:"seu@email.com",value:d,onChange:a=>x(a.target.value),required:!0,className:"h-12"})]}),e.jsxs(y,{type:"submit",className:"w-full",size:"lg",disabled:j,children:[j?e.jsx(q,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(D,{className:"h-4 w-4 mr-2"}),"Enviar Link de Recuperação"]}),e.jsx("div",{className:"text-center",children:e.jsxs(y,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{f(!1),x("")},children:[e.jsx(le,{className:"h-4 w-4 mr-1"})," Voltar para o Login"]})})]}):e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(v,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:S,onChange:a=>z(a.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"storeName",children:"Nome da Loja *"}),e.jsx(v,{id:"storeName",type:"text",placeholder:"Nome do seu restaurante",value:E,onChange:a=>M(a.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"phone",children:"Telefone *"}),e.jsx(oe,{id:"phone",value:b,onChange:a=>J(a.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"cpfCnpj",children:"CPF/CNPJ *"}),e.jsx(ie,{id:"cpfCnpj",value:P,onChange:a=>V(a.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"CPF (11 dígitos) ou CNPJ (14 dígitos)."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"email",children:"Email *"}),e.jsx(v,{id:"email",type:"email",placeholder:"seu@email.com",value:d,onChange:a=>x(a.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"password",children:"Senha *"}),e.jsx(v,{id:"password",type:"password",placeholder:"••••••••",value:N,onChange:a=>T(a.target.value),required:!0,className:"h-12"})]}),i&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"confirmPassword",children:"Confirmar Senha *"}),e.jsx(v,{id:"confirmPassword",type:"password",placeholder:"••••••••",value:L,onChange:a=>F(a.target.value),required:!0,className:"h-12"})]}),!i&&e.jsx("div",{className:"text-right",children:e.jsx(y,{variant:"link",type:"button",className:"p-0 h-auto text-sm text-muted-foreground hover:text-primary",onClick:()=>f(!0),children:"Esqueci minha senha"})}),e.jsx(y,{type:"submit",className:"w-full",size:"lg",disabled:j,children:j?e.jsx(q,{className:"h-4 w-4 animate-spin mr-2"}):i?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(y,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{C(!i),F("")},children:i?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(ne,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(Q,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{ke as default};
