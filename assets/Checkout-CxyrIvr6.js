import{j as e,b as Hs,u as ye,c as Js}from"./tanstack-D8i8yNxB.js";import{r as i,R as ve,u as Qs,h as Ws,L as We}from"./vendor-Dl0Wzy4_.js";import{o as Xs,s as V,l as Ys,e as er,p as Le,c as Xe,n as sr,Z as z,u as rr,t as tr}from"./types-BCrSgEF3.js";import{s as T}from"./client-BmrnLCXS.js";import{c as Oe,f as $e,g as Ne,P as K,i as be,h as rs,l as or,m as ts,b as me,n as nr,k as ar,a as os,u as oe,v as ir,L as Ye}from"./index-B-eaE5eQ.js";import{B as ne}from"./button-DC9egGt_.js";import{C as ie,b as le,c as ce,a as de}from"./card-MjMZ85AJ.js";import{I as $}from"./label-BkTiJV9x.js";import{c as ns,R as lr,I as cr,a as dr,C as ur}from"./index-BYLjGDc5.js";import{u as mr}from"./index-BB_oiUC3.js";import{u as pr}from"./index-PuW-_iwo.js";import{S as ue}from"./separator-DS32kYDb.js";import{T as hr}from"./textarea-BHYf2qaE.js";import{A as Q,a as W,b as X}from"./alert-CyKmQziw.js";import{F as fr,b as I,c as C,a as R,e as L,d as ae}from"./form-DyBaBguC.js";import{Z as xr,M as gr}from"./MapLocationSection-DhJJdmzi.js";import{S as yr}from"./shopping-cart-C76IfCUF.js";import{T as ke}from"./terminal-CzBliTcC.js";import{A as jr}from"./arrow-left-BLTCoXTD.js";import{T as es}from"./truck-BPqi_WSg.js";import{S as as,a as vr}from"./store-MuVYkb5z.js";import{M as ss}from"./map-pin-YmWKO3rX.js";import{P as br}from"./package-D8zdhFJO.js";import{C as Nr}from"./credit-card-BaUzCL6s.js";import{D as Cr}from"./dollar-sign-CVPpmV4B.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wr=Oe("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _r=Oe("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rr=Oe("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var Te="Radio",[Er,is]=$e(Te),[Pr,Sr]=Er(Te),ls=i.forwardRef((t,r)=>{const{__scopeRadio:o,name:d,checked:a=!1,required:l,disabled:u,value:m="on",onCheck:x,form:f,...v}=t,[_,N]=i.useState(null),g=Ne(r,O=>N(O)),y=i.useRef(!1),b=_?f||!!_.closest("form"):!0;return e.jsxs(Pr,{scope:o,checked:a,disabled:u,children:[e.jsx(K.button,{type:"button",role:"radio","aria-checked":a,"data-state":ms(a),"data-disabled":u?"":void 0,disabled:u,value:m,...v,ref:g,onClick:be(t.onClick,O=>{a||x==null||x(),b&&(y.current=O.isPropagationStopped(),y.current||O.stopPropagation())})}),b&&e.jsx(us,{control:_,bubbles:!y.current,name:d,value:m,checked:a,required:l,disabled:u,form:f,style:{transform:"translateX(-100%)"}})]})});ls.displayName=Te;var cs="RadioIndicator",ds=i.forwardRef((t,r)=>{const{__scopeRadio:o,forceMount:d,...a}=t,l=Sr(cs,o);return e.jsx(rs,{present:d||l.checked,children:e.jsx(K.span,{"data-state":ms(l.checked),"data-disabled":l.disabled?"":void 0,...a,ref:r})})});ds.displayName=cs;var Ir="RadioBubbleInput",us=i.forwardRef(({__scopeRadio:t,control:r,checked:o,bubbles:d=!0,...a},l)=>{const u=i.useRef(null),m=Ne(u,l),x=pr(o),f=or(r);return i.useEffect(()=>{const v=u.current;if(!v)return;const _=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(_,"checked").set;if(x!==o&&g){const y=new Event("click",{bubbles:d});g.call(v,o),v.dispatchEvent(y)}},[x,o,d]),e.jsx(K.input,{type:"radio","aria-hidden":!0,defaultChecked:o,...a,tabIndex:-1,ref:m,style:{...a.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});us.displayName=Ir;function ms(t){return t?"checked":"unchecked"}var Lr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Ce="RadioGroup",[kr,It]=$e(Ce,[ns,is]),ps=ns(),hs=is(),[Fr,Vr]=kr(Ce),fs=i.forwardRef((t,r)=>{const{__scopeRadioGroup:o,name:d,defaultValue:a,value:l,required:u=!1,disabled:m=!1,orientation:x,dir:f,loop:v=!0,onValueChange:_,...N}=t,g=ps(o),y=mr(f),[b,O]=ts({prop:l,defaultProp:a??null,onChange:_,caller:Ce});return e.jsx(Fr,{scope:o,name:d,required:u,disabled:m,value:b,onValueChange:O,children:e.jsx(lr,{asChild:!0,...g,orientation:x,dir:y,loop:v,children:e.jsx(K.div,{role:"radiogroup","aria-required":u,"aria-orientation":x,"data-disabled":m?"":void 0,dir:y,...N,ref:r})})})});fs.displayName=Ce;var xs="RadioGroupItem",gs=i.forwardRef((t,r)=>{const{__scopeRadioGroup:o,disabled:d,...a}=t,l=Vr(xs,o),u=l.disabled||d,m=ps(o),x=hs(o),f=i.useRef(null),v=Ne(r,f),_=l.value===a.value,N=i.useRef(!1);return i.useEffect(()=>{const g=b=>{Lr.includes(b.key)&&(N.current=!0)},y=()=>N.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",y)}},[]),e.jsx(cr,{asChild:!0,...m,focusable:!u,active:_,children:e.jsx(ls,{disabled:u,required:l.required,checked:_,...x,...a,name:l.name,ref:v,onCheck:()=>l.onValueChange(a.value),onKeyDown:be(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:be(a.onFocus,()=>{var g;N.current&&((g=f.current)==null||g.click())})})})});gs.displayName=xs;var Or="RadioGroupIndicator",ys=i.forwardRef((t,r)=>{const{__scopeRadioGroup:o,...d}=t,a=hs(o);return e.jsx(ds,{...a,...d,ref:r})});ys.displayName=Or;var js=fs,vs=gs,$r=ys;const Fe=i.forwardRef(({className:t,...r},o)=>e.jsx(js,{className:me("grid gap-2",t),...r,ref:o}));Fe.displayName=js.displayName;const je=i.forwardRef(({className:t,...r},o)=>e.jsx(vs,{ref:o,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...r,children:e.jsx($r,{className:"flex items-center justify-center",children:e.jsx(wr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));je.displayName=vs.displayName;const Tr=t=>{let r=t.replace(/\D/g,"");return r.length>11&&(r=r.slice(0,11)),r.length>0&&(r=`(${r}`),r.length>3&&(r=`${r.slice(0,3)}) ${r.slice(3)}`),r.length>10&&(r=`${r.slice(0,10)}-${r.slice(10)}`),r},bs=ve.forwardRef(({className:t,value:r,onChange:o,...d},a)=>{const l=u=>{const m=u.target.value,x=Tr(m),f={...u,target:{...u.target,value:x}};o(f)};return e.jsx($,{ref:a,type:"tel",className:me("w-full",t),placeholder:"(99) 99999-9999",value:r,onChange:l,...d})});bs.displayName="PhoneInput";const Ar=t=>{let r=t.replace(/\D/g,"");return r.length>14&&(r=r.slice(0,14)),r.length<=11?(r.length>9&&(r=`${r.slice(0,9)}-${r.slice(9)}`),r.length>6&&(r=`${r.slice(0,6)}.${r.slice(6)}`),r.length>3&&(r=`${r.slice(0,3)}.${r.slice(3)}`),r):(r.length>12&&(r=`${r.slice(0,12)}-${r.slice(12)}`),r.length>8&&(r=`${r.slice(0,8)}/${r.slice(8)}`),r.length>5&&(r=`${r.slice(0,5)}.${r.slice(5)}`),r.length>2&&(r=`${r.slice(0,2)}.${r.slice(2)}`),r)},Ns=ve.forwardRef(({className:t,value:r,onChange:o,...d},a)=>{const l=u=>{const m=u.target.value,x=Ar(m),f={...u,target:{...u.target,value:x}};o(f)};return e.jsx($,{ref:a,type:"tel",className:me("w-full",t),placeholder:"CPF ou CNPJ",value:r,onChange:l,maxLength:18,...d})});Ns.displayName="CpfCnpjInput";const Mr=(t,r,o,d)=>{const l=(o-t)*(Math.PI/180),u=(d-r)*(Math.PI/180),m=Math.sin(l/2)*Math.sin(l/2)+Math.cos(t*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(u/2)*Math.sin(u/2);return 6371*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))},Gr=async t=>{const r=t.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(r)}&limit=1`,d=new AbortController,a=setTimeout(()=>d.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",o);const l=await fetch(o,{signal:d.signal});if(!l.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",l.status),null;const u=await l.json();if(u&&Array.isArray(u)&&u.length>0){const m=u[0],x=parseFloat(m.lat),f=parseFloat(m.lon);if(Number.isFinite(x)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[x,f]),{lat:x,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",r),null}catch(l){return l instanceof Error&&l.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",r):console.error("LOG: geocodeAddress - Erro durante a requisição:",l),null}finally{clearTimeout(a)}},Dr=(t,r,o)=>{const d=Mr(r[0],r[1],t[0],t[1]),a=o.find(l=>d<=l.max_distance_km);if(a){const l=a.delivery_fee||0,u=a.min_delivery_time_minutes||0,m=u+15;return{fee:parseFloat(l.toFixed(2)),minTime:u,maxTime:m}}return null};var we="Collapsible",[qr,Lt]=$e(we),[Br,Ae]=qr(we),Cs=i.forwardRef((t,r)=>{const{__scopeCollapsible:o,open:d,defaultOpen:a,disabled:l,onOpenChange:u,...m}=t,[x,f]=ts({prop:d,defaultProp:a??!1,onChange:u,caller:we});return e.jsx(Br,{scope:o,disabled:l,contentId:nr(),open:x,onOpenToggle:i.useCallback(()=>f(v=>!v),[f]),children:e.jsx(K.div,{"data-state":Ge(x),"data-disabled":l?"":void 0,...m,ref:r})})});Cs.displayName=we;var ws="CollapsibleTrigger",_s=i.forwardRef((t,r)=>{const{__scopeCollapsible:o,...d}=t,a=Ae(ws,o);return e.jsx(K.button,{type:"button","aria-controls":a.contentId,"aria-expanded":a.open||!1,"data-state":Ge(a.open),"data-disabled":a.disabled?"":void 0,disabled:a.disabled,...d,ref:r,onClick:be(t.onClick,a.onOpenToggle)})});_s.displayName=ws;var Me="CollapsibleContent",Rs=i.forwardRef((t,r)=>{const{forceMount:o,...d}=t,a=Ae(Me,t.__scopeCollapsible);return e.jsx(rs,{present:o||a.open,children:({present:l})=>e.jsx(zr,{...d,ref:r,present:l})})});Rs.displayName=Me;var zr=i.forwardRef((t,r)=>{const{__scopeCollapsible:o,present:d,children:a,...l}=t,u=Ae(Me,o),[m,x]=i.useState(d),f=i.useRef(null),v=Ne(r,f),_=i.useRef(0),N=_.current,g=i.useRef(0),y=g.current,b=u.open||m,O=i.useRef(b),F=i.useRef(void 0);return i.useEffect(()=>{const E=requestAnimationFrame(()=>O.current=!1);return()=>cancelAnimationFrame(E)},[]),ar(()=>{const E=f.current;if(E){F.current=F.current||{transitionDuration:E.style.transitionDuration,animationName:E.style.animationName},E.style.transitionDuration="0s",E.style.animationName="none";const Z=E.getBoundingClientRect();_.current=Z.height,g.current=Z.width,O.current||(E.style.transitionDuration=F.current.transitionDuration,E.style.animationName=F.current.animationName),x(d)}},[u.open,d]),e.jsx(K.div,{"data-state":Ge(u.open),"data-disabled":u.disabled?"":void 0,id:u.contentId,hidden:!b,...l,ref:v,style:{"--radix-collapsible-content-height":N?`${N}px`:void 0,"--radix-collapsible-content-width":y?`${y}px`:void 0,...t.style},children:b&&a})});function Ge(t){return t?"open":"closed"}var Ur=Cs;const Kr=Ur,Zr=_s,Hr=Rs,Jr=()=>{const{items:t,subtotal:r,deliveryFee:o,total:d,totalItems:a}=os(),[l,u]=i.useState(!1);return a===0?null:e.jsxs(Kr,{open:l,onOpenChange:u,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Zr,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yr,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",a," ",a===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}),l?e.jsx(dr,{className:"h-5 w-5"}):e.jsx(ur,{className:"h-5 w-5"})]})]})}),e.jsxs(Hr,{className:"p-4 pt-0",children:[e.jsx(ue,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:t.map(m=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[m.quantity,"x ",m.name,m.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",m.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(m.price*m.quantity)})]},m.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)})]})]})]})]})},Es=t=>t.replace(/\D/g,""),Ps=t=>t.replace(/\D/g,""),Ve=t=>t.replace(/\D/g,""),Qr=Xs({name:V().min(1,"Nome é obrigatório."),phone:V().min(1,"Telefone é obrigatório.").transform(Es).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:V().email("Email inválido.").optional().or(Ys("")),delivery_option:er(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:V().optional().default(""),number:V().optional().default(""),complement:V().optional().default(""),neighborhood:V().optional().default(""),city:V().optional().default(""),zip_code:V().optional().default("").transform(Ps).refine(t=>t.length===8||t.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Le(t=>typeof t=="string"?parseFloat(t):t,Xe.number().optional().nullable()),longitude:Le(t=>typeof t=="string"?parseFloat(t):t,Xe.number().optional().nullable()),payment_method_id:V().min(1,"Selecione uma forma de pagamento."),notes:V().optional(),cpf_cnpj:V().optional().default("").transform(Ve).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Le(t=>{if(t==null||t==="")return null;const r=String(t).replace(",","."),o=parseFloat(r);return isNaN(o)?r:o},sr({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((t,r)=>{if(t.delivery_option==="delivery"&&(t.street.trim()===""&&r.addIssue({code:z.custom,message:"Rua é obrigatória.",path:["street"]}),t.number.trim()===""&&r.addIssue({code:z.custom,message:"Número é obrigatório.",path:["number"]}),t.neighborhood.trim()===""&&r.addIssue({code:z.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),t.city.trim()===""&&r.addIssue({code:z.custom,message:"Cidade é obrigatória.",path:["city"]}),t.zip_code.length!==8&&r.addIssue({code:z.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(t.latitude===null||t.longitude===null)&&r.addIssue({code:z.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),t.payment_method_id==="Dinheiro"&&t.change_for!==null&&t.change_for!==void 0&&t.change_for<=0&&r.addIssue({code:z.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),t.payment_method_id==="Pagamento online: Pix/Cartão"){const a=Ve(t.cpf_cnpj||"");a.length!==11&&a.length!==14&&r.addIssue({code:z.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Wr=()=>{const t=window.location.origin,o=window.location.pathname.split("/")[1];return o?`${t}/${o}`:t},Xr=async()=>{const{data:t,error:r}=await T.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(r)throw new Error(`Erro ao buscar restaurante: ${r.message}`);if(!t)throw new Error("Nenhum restaurante ativo encontrado.");return t},Yr=async t=>{const{data:r,error:o}=await T.from("restaurants").select("delivery_enabled").eq("id",t).single();if(o)throw new Error(`Erro ao buscar status de entrega: ${o.message}`);return r.delivery_enabled??!0},et=async t=>{const{data:r,error:o}=await T.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(o)throw new Error(`Erro ao buscar métodos de pagamento: ${o.message}`);return r},st=async t=>{const{data:r,error:o}=await T.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(o)throw new Error(`Erro ao buscar zonas de entrega: ${o.message}`);return r},rt=t=>{switch(t){case"DollarSign":return Cr;case"Smartphone":return vr;case"CreditCard":return Nr;case"Package":return br;default:return as}},tt=({subtotal:t,deliveryFee:r,total:o,items:d})=>e.jsxs(ie,{className:"sticky top-4",children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(de,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:d.map(a=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a.quantity,"x ",a.name,a.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",a.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a.price*a.quantity)})]},a.id))}),e.jsx(ue,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:r>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r):"Grátis"})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]})]})]}),kt=()=>{const t=Wr(),r=Qs();Hs();const o=os(),{items:d,subtotal:a,deliveryFee:l,total:u,setDeliveryFee:m,clearCart:x}=o,[f]=Ws(),[v,_]=i.useState(!1),[N,g]=i.useState(!1),[y,b]=i.useState(null),[O,F]=i.useState(null),[E,Z]=i.useState(null),[De,Ss]=i.useState(!1),Y=ve.useRef(!1),ee=ve.useRef(!1),se=f.get("status"),pe=f.get("external_reference"),qe=f.has("collection_id")||f.has("external_reference"),[he,Be]=i.useState(!!pe);i.useEffect(()=>{const s=c=>{var h,j;(j=(h=c.error)==null?void 0:h.message)!=null&&j.includes("removeChild")&&(console.error("LOG: Erro de DOM ignorado (Sonner):",c.error),c.preventDefault(),c.stopImmediatePropagation())};return window.addEventListener("error",s,!0),()=>window.removeEventListener("error",s,!0)},[]),i.useEffect(()=>{if(pe)if(se==="approved"||se==="failure"||se==="pending"){r(`/order-success/${pe}?status=${se}`,{replace:!0});return}else qe&&(oe.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Be(!1));else Be(!1)},[pe,se,qe,r]);const{data:p,isLoading:Is,isError:Ls,error:ks}=ye({queryKey:["checkoutRestaurantData"],queryFn:Xr}),{data:G,isLoading:_e}=ye({queryKey:["deliveryStatus",p==null?void 0:p.id],queryFn:()=>Yr(p.id),enabled:!!(p!=null&&p.id)}),{data:H=[],isLoading:Fs}=ye({queryKey:["checkoutPaymentMethods",p==null?void 0:p.id],queryFn:()=>et(p.id),enabled:!!(p!=null&&p.id)}),{data:ze=[],isLoading:Vs}=ye({queryKey:["checkoutDeliveryZones",p==null?void 0:p.id],queryFn:()=>st(p.id),enabled:!!(p!=null&&p.id)}),Os=Is||_e||Fs||Vs,$s=Ls,Ue=ks,n=rr({resolver:tr(Qr),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),A=n.watch("delivery_option"),Re=n.watch("payment_method_id"),J=H.find(s=>s.id===Re),fe=(J==null?void 0:J.name)==="Pagamento online: Pix/Cartão",xe=(J==null?void 0:J.name)==="Dinheiro",P=n.watch("latitude"),S=n.watch("longitude");n.watch(["street","number","neighborhood","city","zip_code"]);const D=A==="delivery",Ts=i.useMemo(()=>JSON.stringify({deliveryOption:A,deliveryEnabled:G,lat:P,lng:S}),[A,G,P,S]),As=i.useMemo(()=>typeof P=="number"&&typeof S=="number"&&!isNaN(P)&&!isNaN(S)?[P,S]:p!=null&&p.latitude&&(p!=null&&p.longitude)?[p.latitude,p.longitude]:[-23.55052,-46.633308],[P,S,p]),Ms=i.useMemo(()=>P===null||S===null?`map-${A}-null`:`map-${A}-${P.toFixed(6)}-${S.toFixed(6)}`,[D,A,P,S]),Ee=i.useCallback(s=>{const c=s.road||s.logradouro||"",h=s.house_number||"",j=s.suburb||s.bairro||"",w=s.city||s.localidade||"",M=s.postcode||s.cep||"";n.setValue("street",c,{shouldValidate:!0}),n.setValue("number",h||"",{shouldValidate:!0}),n.setValue("complement",s.suburb||"",{shouldValidate:!0}),n.setValue("neighborhood",j,{shouldValidate:!0}),n.setValue("city",w,{shouldValidate:!0}),n.setValue("zip_code",M,{shouldValidate:!0})},[n]),Gs=i.useCallback(async(s,c)=>{n.setValue("latitude",s,{shouldValidate:!0}),n.setValue("longitude",c,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${c}&addressdetails=1`,j=await fetch(h);if(j.ok){const w=await j.json();w.address&&(Ee(w.address),oe.info("Endereço preenchido a partir do mapa."))}},[n,Ee]),Ds=i.useCallback(()=>{n.setValue("street","",{shouldValidate:!0}),n.setValue("number","",{shouldValidate:!0}),n.setValue("complement","",{shouldValidate:!0}),n.setValue("neighborhood","",{shouldValidate:!0}),n.setValue("city","",{shouldValidate:!0}),n.setValue("zip_code","",{shouldValidate:!0}),n.setValue("latitude",null,{shouldValidate:!0}),n.setValue("longitude",null,{shouldValidate:!0}),m(0),b(null),F(null),oe.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[n,m]),Pe=i.useCallback(s=>{try{const c={name:s.name,phone:s.phone,email:s.email,delivery_option:s.delivery_option,street:s.street,number:s.number,complement:s.complement,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code,latitude:s.latitude,longitude:s.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(c))}catch(c){console.error("Failed to save form data to local storage",c)}},[]),Ke=i.useCallback(()=>{try{const s=localStorage.getItem("checkoutFormData");if(s){const c=JSON.parse(s);n.reset({...n.getValues(),...c,delivery_option:c.delivery_option||"delivery"})}}catch(s){console.error("Failed to load form data from local storage",s)}},[n]);i.useEffect(()=>{Ke()},[Ke]),i.useEffect(()=>{const s=n.watch(c=>{Pe(c)});return()=>s.unsubscribe()},[n,Pe]);const qs=()=>{Y.current||(Z(null),Y.current=!0,Promise.resolve().then(async()=>{try{const s=n.getValues(),[c,h,j,w,M]=[s.street,s.number,s.neighborhood,s.city,s.zip_code],ge=Ps(M);if(!(c&&h&&j&&w&&ge.length===8)){console.log("LOG: Validau00e7u00e3o de endereu00e7o incompleto falhou."),Y.current=!1;return}console.log("LOG: Iniciando geocodificau00e7u00e3o para:",`${c}, ${h}, ${j}, ${w}, ${M}`);const re=`${c}, ${h}, ${j}, ${w}, ${M}`,U=await Gr(re);U?(console.log("LOG: Geocodificau00e7u00e3o bem-sucedida. Coordenadas:",U),n.setValue("latitude",U.lat,{shouldValidate:!1}),n.setValue("longitude",U.lng,{shouldValidate:!1}),Pe(n.getValues())):(console.log("LOG: Geocodificau00e7u00e3o falhou ou retornou coordenadas invu00e1lidas."),setTimeout(()=>{Z("Endereu00e7o nu00e3o encontrado. Por favor, verifique se estu00e1 correto e tente novamente.")},100))}catch(s){console.error("LOG: Erro capturado durante a geocodificau00e7u00e3o:",s),setTimeout(()=>{Z("Erro ao buscar coordenadas. Verifique sua conexu00e3o ou tente novamente.")},100)}finally{Y.current=!1}}).catch(s=>{console.error("LOG: Erro nao capturado:",s),Y.current=!1}))};i.useEffect(()=>{xe||n.setValue("change_for",null,{shouldValidate:!0})},[xe,n]),i.useEffect(()=>{A==="pickup"&&(m(0),b(null),F(null),n.setValue("latitude",null),n.setValue("longitude",null))},[A,D,n,m,P,S]),i.useEffect(()=>{H.length>0&&!Re&&n.setValue("payment_method_id",H[0].id)},[H,Re,n]),i.useEffect(()=>{fe?n.trigger("cpf_cnpj"):n.clearErrors("cpf_cnpj")},[fe,n]),i.useEffect(()=>{const s=async()=>{if(A==="pickup"||!(p!=null&&p.latitude)||!(p!=null&&p.longitude)){m(0),b(null),F(null);return}if(_e)return;if(G===!1){m(0),b(null),F(null),g(!1);return}g(!0),b(null);let h=null;if(P&&S)h=[P,S];else{m(0),F(null),g(!1);return}if(h){const j=[p.latitude,p.longitude],w=Dr(h,j,ze);w?(m(w.fee),b(null),F({minTime:w.minTime,maxTime:w.maxTime})):(m(0),b("Seu endereço está fora da nossa área de entrega."),F(null))}g(!1)},c=setTimeout(()=>{s()},500);return()=>clearTimeout(c)},[Ts,p,ze,n,m,D,P,S,G,_e]),i.useEffect(()=>{if(d.length===0&&!v&&!he&&!De){const s=setTimeout(()=>{oe.info("Seu carrinho está vazio. Adicione itens para continuar."),r("/menu")},0);return()=>clearTimeout(s)}},[d.length,r,v,he,De]);const Ze=Js({mutationFn:async s=>{if(!p)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&y)throw new Error(y);const c=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),h=s.delivery_option==="delivery"?c:"Retirada no Local";let j;const w=Es(s.phone),M=Ve(s.cpf_cnpj||""),{data:ge}=await T.from("customers").select("id").eq("phone",w).limit(1).single();if(ge){j=ge.id;const k={name:s.name};M&&(k.cpf_cnpj=M),await T.from("customers").update(k).eq("id",j)}else{const{data:k,error:q}=await T.from("customers").insert({name:s.name,phone:w,email:s.email||null,address:h,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:M||null}).select("id").single();if(q)throw new Error(`Erro ao criar cliente: ${q.message}`);j=k.id}const Ie=fe?"pending_payment":"pending",{data:re,error:U}=await T.from("orders").insert({restaurant_id:p.id,customer_id:j,status:Ie,total_amount:u,delivery_fee:l,notes:s.notes,delivery_address:h,payment_method_id:s.payment_method_id,change_for:xe?s.change_for:null}).select("id").single();if(U)throw new Error(`Erro ao criar pedido: ${U.message}`);const Zs=d.map(k=>{const q=Number(k.quantity),B=Number(k.price),te={order_id:re.id,product_id:k.product_id,quantity:q,unit_price:B,subtotal:q*B};return k.notes&&k.notes.trim()&&(te.notes=k.notes.trim()),te}),{error:Je}=await T.from("order_items").insert(Zs);if(Je){console.error("LOG: Erro ao inserir com product_id, tentando sem product_id:",Je);const k=d.map(B=>{const te=Number(B.quantity),Qe=Number(B.price);return{order_id:re.id,quantity:te,unit_price:Qe,subtotal:te*Qe,notes:B.notes&&B.notes.trim()?B.notes.trim():null}}),{error:q}=await T.from("order_items").insert(k);if(q)throw new Error(`Erro ao adicionar itens do pedido: ${q.message}`)}return{orderId:re.id,orderStatus:Ie}},onSuccess:s=>{ee.current=!1,Ss(!0);const c=s.orderStatus==="pending_payment"?`/payment/${s.orderId}`:`/order-success/${s.orderId}`;console.log("LOG: Redirecionando para:",c),s.orderStatus==="pending_payment"&&_(!0);const h=`${t}/#${c}`;console.log("LOG: Redirecionando com URL absoluta:",h),window.location.href=h},onError:s=>{ee.current=!1,console.error("LOG: Erro ao processar pedido:",s)}}),Bs=async s=>{if(ee.current){console.log("LOG: Pagamento ja em processamento, ignorando nova chamada.");return}ee.current=!0,Promise.resolve().then(()=>{Ze.mutate(s)}).catch(c=>{console.error("LOG: Erro nao capturado em onSubmit:",c),ee.current=!1})},zs=s=>{var h;console.error("Validation errors:",s);const c=Object.keys(s)[0];c&&oe.error("Erro de validação",{description:((h=s[c])==null?void 0:h.message)||"Preencha todos os campos obrigatórios."})},He=Ze.isPending||v||N,Us=!D||!y&&l>=0,Se=!D||P!==null&&S!==null,Ks=!He&&Us&&Se;return d.length===0&&!v&&!he?e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."}):Os||he?e.jsx(ir,{}):$s?e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(Q,{variant:"destructive",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro de Conexão"}),e.jsx(X,{children:Ue instanceof Error?Ue.message:"Não foi possível carregar os dados."})]})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(We,{to:"/menu",children:e.jsx(ne,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(jr,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx("div",{children:e.jsx(Jr,{})}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(fr,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(Bs,zs),className:"space-y-6",children:[e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"name",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Nome Completo *"}),e.jsx($,{placeholder:"Seu nome",...s}),e.jsx(L,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(I,{control:n.control,name:"phone",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Telefone *"}),e.jsx(bs,{...s}),e.jsx(L,{})]})}),e.jsx(I,{control:n.control,name:"email",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Email (Opcional)"}),e.jsx($,{placeholder:"seu@email.com",...s}),e.jsx(L,{})]})})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"delivery_option",render:({field:s})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(ae,{children:e.jsxs(Fe,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(je,{value:"delivery"})}),e.jsx(es,{className:"h-5 w-5 text-primary"}),e.jsxs(R,{className:me("font-normal flex-1 cursor-pointer"),children:["Delivery",G===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(je,{value:"pickup"})}),e.jsx(as,{className:"h-5 w-5 text-primary"}),e.jsx(R,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(L,{})]})}),D&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(ss,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ne,{type:"button",variant:"outline",size:"sm",onClick:s=>{s.preventDefault(),qs()},disabled:N,children:[e.jsx(Rr,{className:"h-4 w-4 mr-2"})," ",N?"Buscando...":"Salvar Endereço"]}),e.jsxs(ne,{type:"button",variant:"outline",size:"sm",onClick:Ds,children:[e.jsx(_r,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(I,{control:n.control,name:"street",render:({field:s})=>e.jsxs(C,{className:"col-span-2",children:[e.jsx(R,{children:"Rua *"}),e.jsx($,{...s}),e.jsx(L,{})]})}),e.jsx(I,{control:n.control,name:"number",render:({field:s})=>e.jsxs(C,{className:"col-span-1",children:[e.jsx(R,{children:"Número *"}),e.jsx($,{...s}),e.jsx(L,{})]})})]}),e.jsx(I,{control:n.control,name:"complement",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Complemento (Opcional)"}),e.jsx($,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(L,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:n.control,name:"neighborhood",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Bairro *"}),e.jsx($,{...s}),e.jsx(L,{})]})}),e.jsx(I,{control:n.control,name:"city",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Cidade *"}),e.jsx($,{...s}),e.jsx(L,{})]})})]}),e.jsx(I,{control:n.control,name:"zip_code",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"CEP *"}),e.jsx(xr,{...s}),e.jsx(L,{})]})}),D&&Se&&e.jsx("div",{children:e.jsx(gr,{mapKey:Ms,markerPosition:As,onLocationChange:Gs,updateAddressFields:Ee,restaurant:p})}),N&&G!==!1&&e.jsxs(Q,{children:[e.jsx(Ye,{className:"h-4 w-4 animate-spin"}),e.jsx(W,{children:"Calculando Taxa..."}),e.jsx(X,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),y&&G!==!1&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro de Entrega"}),e.jsx(X,{children:y})]}),l>0&&!N&&G!==!1&&e.jsxs(Q,{className:"mt-4",children:[e.jsx(es,{className:"h-4 w-4"}),e.jsx(W,{children:"Taxa de Entrega Aplicada"}),e.jsxs(X,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)]})]}),E&&e.jsxs(Q,{variant:"destructive",className:"mt-4",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro ao Buscar Endereu00e7o"}),e.jsx(X,{children:E})]}),D&&!Se&&!E&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(ss,{className:"h-4 w-4"}),e.jsx(W,{children:"Localização Obrigatória"}),e.jsx(X,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsx(I,{control:n.control,name:"payment_method_id",render:({field:s})=>e.jsxs(C,{className:"space-y-3",children:[e.jsx(ae,{children:e.jsx(Fe,{onValueChange:c=>{s.onChange(c);const h=H.find(j=>j.id===c);(h==null?void 0:h.name)!=="Dinheiro"&&n.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?n.trigger("cpf_cnpj"):n.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:H.map(c=>{const h=rt(c.icon||"Store");return e.jsxs(C,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(ae,{children:e.jsx(je,{value:c.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(R,{className:"font-normal cursor-pointer",children:c.name}),c.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:c.description})]})]},c.id)})})}),e.jsx(L,{})]})}),xe&&e.jsx(I,{control:n.control,name:"change_for",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Troco para (Opcional)"}),e.jsx($,{type:"number",placeholder:"Ex: 50.00",...s,value:s.value||"",onChange:c=>s.onChange(c.target.value?parseFloat(c.target.value):null)}),e.jsx(L,{})]})}),fe&&e.jsx(I,{control:n.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"CPF/CNPJ *"}),e.jsx(Ns,{...s}),e.jsx(L,{})]})})]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:e.jsx(ce,{className:"text-xl",children:"4. Observações"})}),e.jsx(de,{children:e.jsx(I,{control:n.control,name:"notes",render:({field:s})=>e.jsxs(C,{children:[e.jsx(R,{children:"Observações do Pedido (Opcional)"}),e.jsx(hr,{placeholder:"Ex: Sem cebola, sem alface...",...s}),e.jsx(L,{})]})})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(We,{to:"/menu",className:"flex-1",children:e.jsx(ne,{type:"button",variant:"outline",className:"w-full",children:"Voltar ao Menu"})}),e.jsx(ne,{type:"submit",className:"flex-1",disabled:!Ks,size:"lg",children:He?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Confirmar Pedido"})]})]})})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(tt,{subtotal:a,deliveryFee:l,total:u,items:d})})]})]})]})};export{kt as default};
