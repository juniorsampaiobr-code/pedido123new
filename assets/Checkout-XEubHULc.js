import{u as K,j as e,b as Ge,c as ge}from"./tanstack-B7K8dk_R.js";import{r as p,R as Be,u as Mr,L as Fr}from"./vendor-C31pEpEI.js";import{s as R}from"./client-Bx906Zta.js";import{c as kr,e as ze,f as be,P as le,h as ye,g as Dr,k as Or,l as Ar,a as _e,u as I,L as de,d as Tr,b as Ae}from"./index-QUsrTu4A.js";import{o as Ke,s as C,l as Ve,u as Ue,t as Ze,e as Lr,p as $r,c as qr,Z as ee,C as U}from"./types-D_gJSKSC.js";import{B as Q}from"./button-C5Hyc_lW.js";import{C as A,b as T,c as L,a as $}from"./card-Bd3MAdjP.js";import{I as k}from"./input-jyeC-KY9.js";import{T as Gr}from"./textarea-D8ieEjEd.js";import{L as E}from"./label-C0Ydwr-8.js";import{c as Je,R as Br,I as zr}from"./index-B0GNeEwF.js";import{u as Kr}from"./index-Cvol2gBQ.js";import{u as Vr}from"./index-D4ekbOML.js";import{S as Te}from"./separator-D68Vfs1N.js";import{A as Z,a as J,b as re}from"./alert-Cmtu8dMI.js";import{Z as Ur}from"./ZipCodeInput-B-Y-z4KN.js";import{P as Qe}from"./PhoneInput-Cuo01dru.js";import{D as je,a as ve,b as Xe,c as He,d as We,e as Zr}from"./dialog-RYfncmLC.js";import{F as Jr,a as te,b as ne,c as oe,d as se,e as ae}from"./form-orDkixqc.js";import{U as Ye}from"./user-U3IhagZb.js";import{S as Qr,M as Xr}from"./save-DhiIs6di.js";import{C as er}from"./credit-card-cK7W0BdF.js";import{R as Hr}from"./refresh-cw-DgA1M8gz.js";import{T as xe}from"./truck-DRBsQPR5.js";import{M as Le}from"./map-pin-B-rJf3TQ.js";import{C as $e}from"./circle-alert-BdyWWA2B.js";import{D as Wr}from"./dollar-sign-Bliwv486.js";import"./supabase-CdSQIpsr.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yr=kr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),et=async()=>{const{data:r,error:t}=await R.from("restaurants").select("id").limit(1).single();if(t||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const n=r.id,{data:s,error:a}=await R.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",n).limit(1).single();if(a&&a.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${a.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},rr=()=>K({queryKey:["mercadoPagoPublicKey"],queryFn:et,staleTime:1/0}),rt=(r,t,n,s)=>{const o=(n-r)*(Math.PI/180),i=(s-t)*(Math.PI/180),d=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r*(Math.PI/180))*Math.cos(n*(Math.PI/180))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))},tt=async r=>{const t=r.replace(/\s+/g," ").trim(),n=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1`,s=new AbortController,a=setTimeout(()=>s.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",n);const o=await fetch(n,{signal:s.signal});if(!o.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",o.status),null;const i=await o.json();if(i&&Array.isArray(i)&&i.length>0){const d=i[0],f=parseFloat(d.lat),m=parseFloat(d.lon);if(Number.isFinite(f)&&Number.isFinite(m))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[f,m]),{lat:f,lng:m}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",t),null}catch(o){return o instanceof Error&&o.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",t):console.error("LOG: geocodeAddress - Erro durante a requisição:",o),null}finally{clearTimeout(a)}},nt=(r,t,n)=>{const s=rt(t[0],t[1],r[0],r[1]),a=n.find(o=>s<=o.max_distance_km);if(a){const o=a.delivery_fee||0,i=a.min_delivery_time_minutes||0,d=i+15;return{fee:parseFloat(o.toFixed(2)),minTime:i,maxTime:d}}return null},ot=()=>K({queryKey:["authStatus"],queryFn:async()=>{const{data:{session:r}}=await R.auth.getSession();return(r==null?void 0:r.user)||null},staleTime:1/0});var Ne="Radio",[st,tr]=ze(Ne),[at,it]=st(Ne),nr=p.forwardRef((r,t)=>{const{__scopeRadio:n,name:s,checked:a=!1,required:o,disabled:i,value:d="on",onCheck:f,form:m,...u}=r,[x,S]=p.useState(null),g=be(t,M=>S(M)),N=p.useRef(!1),P=x?m||!!x.closest("form"):!0;return e.jsxs(at,{scope:n,checked:a,disabled:i,children:[e.jsx(le.button,{type:"button",role:"radio","aria-checked":a,"data-state":ir(a),"data-disabled":i?"":void 0,disabled:i,value:d,...u,ref:g,onClick:ye(r.onClick,M=>{a||f==null||f(),P&&(N.current=M.isPropagationStopped(),N.current||M.stopPropagation())})}),P&&e.jsx(ar,{control:x,bubbles:!N.current,name:s,value:d,checked:a,required:o,disabled:i,form:m,style:{transform:"translateX(-100%)"}})]})});nr.displayName=Ne;var or="RadioIndicator",sr=p.forwardRef((r,t)=>{const{__scopeRadio:n,forceMount:s,...a}=r,o=it(or,n);return e.jsx(Dr,{present:s||o.checked,children:e.jsx(le.span,{"data-state":ir(o.checked),"data-disabled":o.disabled?"":void 0,...a,ref:t})})});sr.displayName=or;var ct="RadioBubbleInput",ar=p.forwardRef(({__scopeRadio:r,control:t,checked:n,bubbles:s=!0,...a},o)=>{const i=p.useRef(null),d=be(i,o),f=Vr(n),m=Or(t);return p.useEffect(()=>{const u=i.current;if(!u)return;const x=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(x,"checked").set;if(f!==n&&g){const N=new Event("click",{bubbles:s});g.call(u,n),u.dispatchEvent(N)}},[f,n,s]),e.jsx(le.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...a,tabIndex:-1,ref:d,style:{...a.style,...m,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ar.displayName=ct;function ir(r){return r?"checked":"unchecked"}var dt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ue="RadioGroup",[lt,wn]=ze(ue,[Je,tr]),cr=Je(),dr=tr(),[ut,mt]=lt(ue),lr=p.forwardRef((r,t)=>{const{__scopeRadioGroup:n,name:s,defaultValue:a,value:o,required:i=!1,disabled:d=!1,orientation:f,dir:m,loop:u=!0,onValueChange:x,...S}=r,g=cr(n),N=Kr(m),[P,M]=Ar({prop:o,defaultProp:a??null,onChange:x,caller:ue});return e.jsx(ut,{scope:n,name:s,required:i,disabled:d,value:P,onValueChange:M,children:e.jsx(Br,{asChild:!0,...g,orientation:f,dir:N,loop:u,children:e.jsx(le.div,{role:"radiogroup","aria-required":i,"aria-orientation":f,"data-disabled":d?"":void 0,dir:N,...S,ref:t})})})});lr.displayName=ue;var ur="RadioGroupItem",mr=p.forwardRef((r,t)=>{const{__scopeRadioGroup:n,disabled:s,...a}=r,o=mt(ur,n),i=o.disabled||s,d=cr(n),f=dr(n),m=p.useRef(null),u=be(t,m),x=o.value===a.value,S=p.useRef(!1);return p.useEffect(()=>{const g=P=>{dt.includes(P.key)&&(S.current=!0)},N=()=>S.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",N),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",N)}},[]),e.jsx(zr,{asChild:!0,...d,focusable:!i,active:x,children:e.jsx(nr,{disabled:i,required:o.required,checked:x,...f,...a,name:o.name,ref:u,onCheck:()=>o.onValueChange(a.value),onKeyDown:ye(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:ye(a.onFocus,()=>{var g;S.current&&((g=m.current)==null||g.click())})})})});mr.displayName=ur;var pt="RadioGroupIndicator",pr=p.forwardRef((r,t)=>{const{__scopeRadioGroup:n,...s}=r,a=dr(n);return e.jsx(sr,{...a,...s,ref:t})});pr.displayName=pt;var fr=lr,hr=mr,ft=pr;const we=p.forwardRef(({className:r,...t},n)=>e.jsx(fr,{className:_e("grid gap-2",r),...t,ref:n}));we.displayName=fr.displayName;const ce=p.forwardRef(({className:r,...t},n)=>e.jsx(hr,{ref:n,className:_e("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...t,children:e.jsx(ft,{className:"flex items-center justify-center",children:e.jsx(Yr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ce.displayName=hr.displayName;const ht=r=>{let t=r.replace(/\D/g,"");return t.length>14&&(t=t.slice(0,14)),t.length<=11?(t.length>9&&(t=`${t.slice(0,9)}-${t.slice(9)}`),t.length>6&&(t=`${t.slice(0,6)}.${t.slice(6)}`),t.length>3&&(t=`${t.slice(0,3)}.${t.slice(3)}`),t):(t.length>12&&(t=`${t.slice(0,12)}-${t.slice(12)}`),t.length>8&&(t=`${t.slice(0,8)}/${t.slice(8)}`),t.length>5&&(t=`${t.slice(0,5)}.${t.slice(5)}`),t.length>2&&(t=`${t.slice(0,2)}.${t.slice(2)}`),t)},Ce=Be.forwardRef(({className:r,value:t,onChange:n,...s},a)=>{const o=i=>{const d=i.target.value,f=ht(d),m={...i,target:{...i.target,value:f}};n(m)};return e.jsx(k,{ref:a,type:"tel",className:_e("w-full",r),placeholder:"CPF ou CNPJ",value:t,onChange:o,maxLength:18,...s})});Ce.displayName="CpfCnpjInput";const xt=r=>r.replace(/\D/g,""),gt=r=>r.replace(/\D/g,""),yt=Ke({name:C().min(1,"Nome é obrigatório."),phone:C().min(1,"Telefone é obrigatório.").transform(xt).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:C().email("Email inválido.").optional().or(Ve("")),cpf_cnpj:C().optional().default("").transform(gt).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."})}),jt=({isOpen:r,onClose:t,customer:n})=>{const s=Ge(),a=Ue({resolver:Ze(yt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:""}});p.useEffect(()=>{n&&a.reset({name:n.name||"",phone:n.phone||"",email:n.email||"",cpf_cnpj:n.cpf_cnpj||""})},[n,a]);const o=ge({mutationFn:async d=>{if(!(n!=null&&n.id))throw new Error("ID do cliente não encontrado.");const f={name:d.name,phone:d.phone,email:d.email||null,cpf_cnpj:d.cpf_cnpj||null},{error:m}=await R.from("customers").update(f).eq("id",n.id);if(m)throw new Error(m.message)},onSuccess:()=>{I.success("Perfil atualizado com sucesso!"),s.invalidateQueries({queryKey:["checkoutCustomerData"]}),t()},onError:d=>{I.error(`Erro ao atualizar perfil: ${d.message}`)}}),i=d=>{o.mutate(d)};return n?e.jsx(je,{open:r,onOpenChange:t,children:e.jsxs(ve,{className:"sm:max-w-[425px]",children:[e.jsxs(Xe,{children:[e.jsxs(He,{className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"h-5 w-5 text-primary"}),"Seu Perfil de Cliente"]}),e.jsx(We,{children:"Atualize seus dados de contato e identificação."})]}),e.jsx(Jr,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(i),className:"space-y-4 pt-4",children:[e.jsx(te,{control:a.control,name:"name",render:({field:d})=>e.jsxs(ne,{children:[e.jsx(oe,{children:"Nome Completo *"}),e.jsx(se,{children:e.jsx(k,{placeholder:"Seu nome",...d})}),e.jsx(ae,{})]})}),e.jsx(te,{control:a.control,name:"phone",render:({field:d})=>e.jsxs(ne,{children:[e.jsx(oe,{children:"Telefone *"}),e.jsx(se,{children:e.jsx(Qe,{...d})}),e.jsx(ae,{})]})}),e.jsx(te,{control:a.control,name:"email",render:({field:d})=>e.jsxs(ne,{children:[e.jsx(oe,{children:"Email (Opcional)"}),e.jsx(se,{children:e.jsx(k,{placeholder:"seu@email.com",...d})}),e.jsx(ae,{})]})}),e.jsx(te,{control:a.control,name:"cpf_cnpj",render:({field:d})=>e.jsxs(ne,{children:[e.jsx(oe,{children:"CPF/CNPJ (Opcional)"}),e.jsx(se,{children:e.jsx(Ce,{...d})}),e.jsx(ae,{})]})}),e.jsx(Zr,{className:"pt-4",children:e.jsxs(Q,{type:"submit",disabled:o.isPending,children:[o.isPending?e.jsx(de,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Qr,{className:"h-4 w-4 mr-2"}),"Salvar Alterações"]})})]})})]})}):null};var Ee={};Object.defineProperty(Ee,"__esModule",{value:!0});var xr=Ee.loadMercadoPago=void 0;const gr="https://sdk.mercadopago.com/js/v2",vt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,qe="MercadoPago has already been initialized in your window, please remove the duplicate import",wt="MercadoPago.js not available",bt="Failed to load MercadoPago.js",_t=()=>{for(var r=document.querySelectorAll(`script[src^="${gr}"`),t=0;t<r.length;t++){var n=r[t];if(vt.test(n.src))return n}return null},Nt=()=>{const r=document.createElement("script");r.src=gr;const t=document.head||document.body;if(!t)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return t.appendChild(r),r};let ie=null;const Ct=()=>(ie!==null||(ie=new Promise((r,t)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(qe),r(window.MercadoPago);return}try{let n=_t();n?console.warn(qe):n||(n=Nt()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):t(new Error(wt))}),n.addEventListener("error",()=>{t(new Error(bt))})}catch(n){t(n);return}})),ie);xr=Ee.loadMercadoPago=Ct;var Et=function(r,t,n,s){function a(o){return o instanceof n?o:new n(function(i){i(o)})}return new(n||(n=Promise))(function(o,i){function d(u){try{m(s.next(u))}catch(x){i(x)}}function f(u){try{m(s.throw(u))}catch(x){i(x)}}function m(u){u.done?o(u.value):a(u.value).then(d,f)}m((s=s.apply(r,t||[])).next())})};class D{static getInstance(){return Et(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield xr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}D.publicKey=null;D.options={};D.instanceMercadoPago=void 0;D.loadedInstanceMercadoPago=!1;function Rt(r,t){return Object.keys(r).length===Object.keys(t).length&&Object.keys(r).every(s=>Object.prototype.hasOwnProperty.call(t,s)&&r[s]===t[s])}const St=(r,t)=>{const n=Object.assign(Object.assign({},t),{frontEndStack:"react"}),s=!Rt(D.options,n);(r!==D.publicKey||s)&&(D.publicKey=r,D.options=n,D.instanceMercadoPago=void 0)};var Pt=function(r,t,n,s){function a(o){return o instanceof n?o:new n(function(i){i(o)})}return new(n||(n=Promise))(function(o,i){function d(u){try{m(s.next(u))}catch(x){i(x)}}function f(u){try{m(s.throw(u))}catch(x){i(x)}}function m(u){u.done?o(u.value):a(u.value).then(d,f)}m((s=s.apply(r,t||[])).next())})};const It=()=>Pt(void 0,void 0,void 0,function*(){}),Mt=()=>{},Ft=r=>{console.error(r)};var kt=function(r,t,n,s){function a(o){return o instanceof n?o:new n(function(i){i(o)})}return new(n||(n=Promise))(function(o,i){function d(u){try{m(s.next(u))}catch(x){i(x)}}function f(u){try{m(s.throw(u))}catch(x){i(x)}}function m(u){u.done?o(u.value):a(u.value).then(d,f)}m((s=s.apply(r,t||[])).next())})};const Dt=({settings:r,name:t,containerId:n,controller:s})=>kt(void 0,void 0,void 0,function*(){const a=yield D.getInstance(),o=a==null?void 0:a.bricks();window[s]=yield o==null?void 0:o.create(t,n,r)}),Ot=200,At=({onReady:r=Mt,onError:t=Ft,onSubmit:n=It,customization:s,initialization:a,locale:o,id:i="walletBrick_container"})=>(p.useEffect(()=>{const d={settings:{initialization:a,customization:s,locale:o,callbacks:{onReady:r,onSubmit:n,onError:t}},name:"wallet",containerId:i,controller:"walletBrickController"},f=setTimeout(()=>{Dt(d)},Ot);return()=>{var m;clearTimeout(f),(m=window.walletBrickController)===null||m===void 0||m.unmount()}},[s,a,r,t,n]),Be.createElement("div",{id:i})),Tt=({preferenceId:r,initPoint:t,onClose:n})=>{const{data:s,isLoading:a}=rr();return p.useEffect(()=>{if(s)try{St(s,{locale:"pt-BR"})}catch(o){console.error("Erro ao inicializar Mercado Pago:",o),I.error("Erro ao carregar o SDK do Mercado Pago."),n()}},[s,n]),a||!s?e.jsx(je,{open:!0,onOpenChange:n,children:e.jsx(ve,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(de,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(je,{open:!0,onOpenChange:n,children:e.jsxs(ve,{className:"sm:max-w-[425px]",children:[e.jsxs(Xe,{children:[e.jsxs(He,{className:"flex items-center gap-2",children:[e.jsx(er,{className:"h-5 w-5 text-primary"}),"Pagamento Online"]}),e.jsx(We,{children:"Você será redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsx("div",{className:"py-4",children:e.jsx(At,{initialization:{preferenceId:r},customization:{texts:{valueProp:"smart_option"}}})}),e.jsx(Q,{variant:"outline",onClick:n,children:"Cancelar Pagamento"})]})})},Lt=Ke({name:C().min(1,"Nome é obrigatório."),phone:C().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:C().email("Email inválido.").optional().or(Ve("")),cpf_cnpj:C().optional().default("").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Lr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),zip_code:C().optional(),street:C().optional(),number:C().optional(),neighborhood:C().optional(),city:C().optional(),notes:C().optional(),payment_method_id:C().min(1,"Selecione um método de pagamento."),change_for:$r(r=>String(r).replace(",","."),qr.number().optional().nullable())}).superRefine((r,t)=>{r.delivery_option==="delivery"&&((!r.zip_code||r.zip_code.replace(/\D/g,"").length!==8)&&t.addIssue({code:ee.custom,message:"CEP é obrigatório para entrega.",path:["zip_code"]}),r.street||t.addIssue({code:ee.custom,message:"Rua é obrigatória para entrega.",path:["street"]}),r.number||t.addIssue({code:ee.custom,message:"Número é obrigatório para entrega.",path:["number"]}),r.neighborhood||t.addIssue({code:ee.custom,message:"Bairro é obrigatório para entrega.",path:["neighborhood"]}))}),$t=async()=>{const{data:r,error:t}=await R.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},qt=async r=>{const{data:t,error:n}=await R.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return t},Gt=async r=>{const{data:t,error:n}=await R.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return t},Bt=async r=>{const{data:t,error:n}=await R.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return t||null},bn=()=>{var De,Oe;const r=Mr(),t=Ge(),{items:n,totalAmount:s,clearCart:a}=Tr(),{data:o,isLoading:i}=ot(),{data:d}=rr(),[f,m]=p.useState(!1),[u,x]=p.useState(!1),[S,g]=p.useState(0),[N,P]=p.useState(null),[M,q]=p.useState(!0),[X,yr]=p.useState(null),[jr,me]=p.useState(!1),[vr,wr]=p.useState(null),[Re,br]=p.useState(null),{data:y,isLoading:_r,isError:Nr,error:Se,refetch:Cr}=K({queryKey:["checkoutRestaurantData"],queryFn:$t,staleTime:1/0}),{data:H,isLoading:Er}=K({queryKey:["checkoutDeliveryZones"],queryFn:()=>qt(y.id),enabled:!!y,staleTime:1/0}),{data:G,isLoading:Rr}=K({queryKey:["checkoutPaymentMethods"],queryFn:()=>Gt(y.id),enabled:!!y,staleTime:1/0}),{data:F,isLoading:Pe,refetch:zt}=K({queryKey:["checkoutCustomerData",o==null?void 0:o.id],queryFn:()=>Bt(o.id),enabled:!!o,staleTime:0}),l=Ue({resolver:Ze(Lt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",zip_code:"",street:"",number:"",neighborhood:"",city:"",notes:"",payment_method_id:"",change_for:null},mode:"onBlur"}),W=l.watch("delivery_option"),Sr=l.watch("payment_method_id"),B=G==null?void 0:G.find(c=>c.id===Sr),pe=(De=B==null?void 0:B.name)==null?void 0:De.includes("online"),Y=(Oe=B==null?void 0:B.name)==null?void 0:Oe.includes("Dinheiro"),O=s+S;p.useEffect(()=>{var c;F?l.reset({...l.getValues(),name:F.name||"",phone:F.phone||"",email:F.email||"",cpf_cnpj:F.cpf_cnpj||"",street:((c=F.address)==null?void 0:c.split(", ")[0])||"",number:"",neighborhood:"",city:"",zip_code:""}):o&&!Pe&&l.setValue("email",o.email||"")},[F,l,o,Pe]);const Ie=l.watch(["zip_code","street","number","city"]),fe=p.useMemo(()=>y!=null&&y.latitude&&(y!=null&&y.longitude)?[y.latitude,y.longitude]:null,[y]),z=p.useCallback(async()=>{if(W==="pickup"||!y||!fe||!y.delivery_enabled){g(0),q(!0),P(null);return}const[c,h,w,j]=Ie,b=`${h}, ${w}, ${j}, ${c}`;if(!c||c.replace(/\D/g,"").length!==8||!h||!w||!j){g(0),q(!0);return}x(!0);const _=await tt(b);if(x(!1),!_){g(0),q(!1),P(null),I.error("Não foi possível encontrar o endereço. Verifique o CEP e o número.");return}if(yr([_.lat,_.lng]),H&&H.length>0){const v=nt([_.lat,_.lng],fe,H);v?(g(v.fee),P([v.minTime,v.maxTime]),q(!0)):(g(0),P(null),q(!1),I.error("Endereço fora da área de entrega."))}else g(0),P(null),q(!0)},[W,Ie,y,fe,H]);p.useEffect(()=>{z()},[z]);const he=l.watch("change_for");p.useEffect(()=>{Y&&he!==null&&he<O?l.setError("change_for",{message:"O valor do troco deve ser maior ou igual ao total do pedido."}):l.clearErrors("change_for")},[Y,he,O,l]);const Me=ge({mutationFn:async c=>{var b;const h=c.phone.replace(/\D/g,""),w=((b=c.cpf_cnpj)==null?void 0:b.replace(/\D/g,""))||null,j={user_id:(o==null?void 0:o.id)||null,name:c.name,phone:h,email:c.email||null,cpf_cnpj:w,address:c.delivery_option==="delivery"?`${c.street}, ${c.number}, ${c.neighborhood}, ${c.city}, ${c.zip_code}`:null,latitude:X?X[0]:null,longitude:X?X[1]:null};if(o)if(F){const{data:_,error:v}=await R.from("customers").update(j).eq("id",F.id).select().single();if(v)throw v;return _}else{const{data:_,error:v}=await R.from("customers").insert(j).select().single();if(v)throw v;return _}else{const{data:_,error:v}=await R.from("customers").insert(j).select().single();if(v)throw v;return _}},onSuccess:()=>{t.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:c=>{I.error(`Erro ao salvar dados do cliente: ${c.message}`)}}),Fe=ge({mutationFn:async({customerId:c,data:h})=>{if(!y)throw new Error("Dados do restaurante não disponíveis.");const w={restaurant_id:y.id,customer_id:c,status:pe?"pending_payment":"pending",total_amount:O,delivery_fee:S,delivery_address:h.delivery_option==="delivery"?`${h.street}, ${h.number}, ${h.neighborhood}, ${h.city}, ${h.zip_code}`:null,notes:h.notes,payment_method_id:h.payment_method_id,change_for:Y&&h.change_for&&h.change_for>O?h.change_for:null},{data:j,error:b}=await R.from("orders").insert(w).select("id").single();if(b)throw b;const _=n.map(V=>({order_id:j.id,product_id:V.product.id,quantity:V.quantity,unit_price:V.product.price,subtotal:V.subtotal,notes:V.notes})),{error:v}=await R.from("order_items").insert(_);if(v)throw v;return j.id},onSuccess:c=>{t.invalidateQueries({queryKey:["orders"]})},onError:c=>{I.error(`Erro ao criar pedido: ${c.message}`)}}),Pr=async c=>{if(n.length===0){I.error("Seu carrinho está vazio."),r("/menu");return}if(W==="delivery"&&!M){I.error("O endereço de entrega está fora da área de cobertura.");return}let h;try{h=(await Me.mutateAsync(c)).id}catch(j){I.error(`Falha ao salvar cliente: ${j.message}`);return}let w;try{w=await Fe.mutateAsync({customerId:h,data:c})}catch(j){I.error(`Falha ao criar pedido: ${j.message}`);return}pe?await Ir(w,c):(a(),r(`/order-success/${w}`,{replace:!0}))},Ir=async(c,h)=>{if(!y)return;me(!0);const w=window.location.origin+window.location.pathname,j=n.map(b=>({name:b.product.name,price:b.product.price,quantity:b.quantity}));try{const{data:b,error:_}=await R.functions.invoke("create-payment-preference",{body:{orderId:c,items:j,totalAmount:O,restaurantName:y.name,clientUrl:w,customerEmail:h.email||(o==null?void 0:o.email)||"cliente@anonimo.com",customerCpfCnpj:h.cpf_cnpj}});if(_)throw _;const{init_point:v}=b;wr(c),br(v)}catch(b){console.error("Erro ao criar preferência MP:",b),I.error(`Erro no pagamento online: ${b.message}`),me(!1)}};if(n.length===0)return p.useEffect(()=>{r("/menu",{replace:!0})},[r]),e.jsx(Ae,{});if(_r||Er||Rr||i)return e.jsx(Ae,{});if(Nr||!y)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(Z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Terminal,{className:"h-4 w-4"}),e.jsx(J,{children:"Erro Crítico"}),e.jsx(re,{children:Se instanceof Error?Se.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Q,{onClick:()=>Cr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Hr,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const ke=Me.isPending||Fe.isPending||u||!M;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(jt,{isOpen:f,onClose:()=>m(!1),customer:F}),jr&&Re&&e.jsx(Tt,{preferenceId:vr,initPoint:Re,onClose:()=>me(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(L,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ye,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs($,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:o?`Logado como ${o.email}`:"Você está fazendo um pedido anônimo."}),o&&e.jsx(Q,{variant:"link",size:"sm",onClick:()=>m(!0),children:"Editar Perfil"})]}),e.jsx("form",{onSubmit:l.handleSubmit(Pr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(k,{id:"name",...l.register("name")}),l.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"phone",children:"Telefone *"}),e.jsx(U,{name:"phone",control:l.control,render:({field:c})=>e.jsx(Qe,{id:"phone",...c})}),l.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(k,{id:"email",type:"email",...l.register("email")}),l.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(U,{name:"cpf_cnpj",control:l.control,render:({field:c})=>e.jsx(Ce,{id:"cpf_cnpj",...c})}),l.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(L,{className:"text-xl flex items-center gap-2",children:[e.jsx(xe,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx($,{children:e.jsx(U,{name:"delivery_option",control:l.control,render:({field:c})=>e.jsxs(we,{onValueChange:c.onChange,value:c.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(E,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ce,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(xe,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(E,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ce,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Le,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),W==="delivery"&&e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(L,{className:"text-xl flex items-center gap-2",children:[e.jsx(Le,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega"]})}),e.jsxs($,{className:"space-y-4",children:[!y.delivery_enabled&&e.jsxs(Z,{variant:"destructive",children:[e.jsx($e,{className:"h-4 w-4"}),e.jsx(J,{children:"Entrega Desativada"}),e.jsx(re,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(E,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(U,{name:"zip_code",control:l.control,render:({field:c})=>e.jsx(Ur,{id:"zip_code",...c,onBlur:z})}),l.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(E,{htmlFor:"street",children:"Rua *"}),e.jsx(k,{id:"street",...l.register("street"),onBlur:z}),l.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"number",children:"Número *"}),e.jsx(k,{id:"number",...l.register("number"),onBlur:z}),l.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(E,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(k,{id:"neighborhood",...l.register("neighborhood"),onBlur:z}),l.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"city",children:"Cidade"}),e.jsx(k,{id:"city",...l.register("city"),disabled:!0})]}),u&&e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4 animate-spin"}),e.jsx(J,{children:"Calculando Taxa de Entrega..."})]}),!M&&!u&&e.jsxs(Z,{variant:"destructive",children:[e.jsx($e,{className:"h-4 w-4"}),e.jsx(J,{children:"Fora da Área de Entrega"})," ",e.jsx(re,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),N&&M&&!u&&e.jsxs(Z,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx(J,{children:"Entrega Disponível"}),e.jsxs(re,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(S),". Tempo estimado: ",N[0]," - ",N[1]," minutos."]})]})]})]}),e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(L,{className:"text-xl flex items-center gap-2",children:[e.jsx(er,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs($,{children:[e.jsx(U,{name:"payment_method_id",control:l.control,render:({field:c})=>e.jsx(we,{onValueChange:c.onChange,value:c.value,className:"space-y-3",children:G==null?void 0:G.map(h=>{var j;const w=((j=h.name)==null?void 0:j.includes("online"))&&!d;return e.jsx(E,{htmlFor:h.id,className:cn("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",w&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ce,{value:h.id,id:h.id,disabled:w}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:h.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:h.description}),w&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},h.id)})})}),l.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:l.formState.errors.payment_method_id.message})]})]}),Y&&e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(L,{className:"text-xl flex items-center gap-2",children:[e.jsx(Wr,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx($,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(k,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(O),...l.register("change_for",{valueAsNumber:!0})}),l.formState.errors.change_for&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.change_for.message})]})})]}),e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(L,{className:"text-xl flex items-center gap-2",children:[e.jsx(Xr,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx($,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(Gr,{id:"notes",...l.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(A,{className:"shadow-lg",children:[e.jsx(T,{children:e.jsx(L,{className:"text-2xl",children:"Resumo"})}),e.jsxs($,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:n.map(c=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[c.quantity,"x ",c.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c.subtotal)})]},c.product.id))}),e.jsx(Te,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(S)})]})]}),e.jsx(Te,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(O)})]}),e.jsx(Q,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:ke,children:ke?e.jsx(de,{className:"h-5 w-5 animate-spin mr-2"}):pe?"Pagar e Finalizar":"Confirmar Pedido"}),e.jsx(Fr,{to:"/menu",className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})};export{bn as default};
