import{j as e,b as O,u as G,c as J}from"./tanstack-DS1wz2fm.js";import{o as W,s as h,l as z,b as X,p as P,c as T,u as Y,t as ee}from"./types-dEzyxwQ3.js";import{s as R}from"./client-BP8r4skJ.js";import{B as k}from"./button-7ZUs3ZdT.js";import{C as ae,b as oe,c as se,a as re}from"./card-4upxJB7h.js";import{I as u,L as te}from"./label-z6ZyLp45.js";import{T as ne}from"./textarea-D_2foz79.js";import{S as le}from"./switch-BS5p9uST.js";import{u as t,L as ie}from"./index-B_Xs51eY.js";import{F as de,b as n,c as l,a as i,d,e as c}from"./form-CUqspwQq.js";import{S as ce}from"./skeleton-DEqedZh5.js";import{r as p}from"./vendor-DPb28zz8.js";import{L as ue,Z as M,S as me}from"./ZipCodeInput-lOpBKvU4.js";import"./supabase-BT-vd-uw.js";import"./index-CJmVBZLB.js";const he=W({name:h().min(1,"O nome do restaurante é obrigatório."),description:h().optional(),logo_url:h().url("URL do logo inválida.").optional().or(z("")),street:h().optional(),number:h().optional(),neighborhood:h().optional(),city:h().optional(),zip_code:h().optional(),phone:h().optional(),email:h().email("Email inválido.").optional().or(z("")),is_active:X().default(!0),latitude:P(m=>String(m).replace(",","."),T.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:P(m=>String(m).replace(",","."),T.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),pe=async()=>{const{data:m,error:j}=await R.from("restaurants").select("*").limit(1).single();if(j)throw new Error(`Erro ao buscar dados do restaurante: ${j.message}`);if(!m)throw new Error("Nenhum restaurante encontrado.");return m},$=p.memo(({center:m,markerPosition:j,onLocationChange:N})=>e.jsx(ue,{center:m,markerPosition:j,onLocationChange:N}));$.displayName="MemoizedLocationPickerMap";const ze=()=>{const m=O(),[j,N]=p.useState(""),[g,D]=p.useState(""),[E,V]=p.useState(!1),[q,S]=p.useState(!1),{data:s,isLoading:B,isError:I,error:A}=G({queryKey:["restaurantSettings"],queryFn:pe,staleTime:1e3*60*5}),o=Y({resolver:ee(he),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});p.useEffect(()=>{s&&(o.reset({name:s.name||"",description:s.description||"",logo_url:s.logo_url||"",street:s.street||"",number:s.number||"",neighborhood:s.neighborhood||"",city:s.city||"",zip_code:s.zip_code||"",phone:s.phone||"",email:s.email||"",is_active:s.is_active??!0,latitude:s.latitude??null,longitude:s.longitude??null}),s.latitude&&s.longitude&&S(!0))},[s,o.reset]);const b=o.watch("latitude"),v=o.watch("longitude"),U=[-23.55052,-46.633308],_=p.useMemo(()=>typeof b=="number"&&typeof v=="number"&&!isNaN(b)&&!isNaN(v)?[b,v]:U,[b,v]),L=p.useCallback(a=>{o.setValue("street",a.road||a.logradouro||"",{shouldValidate:!0}),o.setValue("number",a.house_number||g||"",{shouldValidate:!0}),o.setValue("neighborhood",a.suburb||a.bairro||"",{shouldValidate:!0}),o.setValue("city",a.city||a.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",a.postcode||a.cep||"",{shouldValidate:!0})},[o,g]),Q=async()=>{const a=j.replace(/\D/g,"");if(a.length!==8||!g){t.warning("Por favor, digite um CEP válido e o número da casa.");return}V(!0);const f=t.loading("Buscando endereço e coordenadas...");try{const x=await fetch(`https://viacep.com.br/ws/${a}/json/`);if(!x.ok)throw new Error("Falha na busca do CEP.");const r=await x.json();if(r.erro){t.error("CEP não encontrado.");return}o.setValue("street",r.logradouro,{shouldValidate:!0}),o.setValue("number",g,{shouldValidate:!0}),o.setValue("neighborhood",r.bairro,{shouldValidate:!0}),o.setValue("city",r.localidade,{shouldValidate:!0}),o.setValue("zip_code",r.cep,{shouldValidate:!0});const y=`${r.logradouro}, ${g}, ${r.localidade}, ${r.uf}`,C=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(y)}`,F=await(await fetch(C)).json();if(F.length>0){const{lat:Z,lon:H}=F[0];o.setValue("latitude",parseFloat(Z),{shouldValidate:!0}),o.setValue("longitude",parseFloat(H),{shouldValidate:!0}),S(!0),t.success("Endereço e mapa atualizados com sucesso!")}else t.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(x){t.error(`Erro na busca: ${x.message}`)}finally{V(!1),t.dismiss(f)}},K=p.useCallback(async(a,f)=>{o.setValue("latitude",a,{shouldValidate:!0}),o.setValue("longitude",f,{shouldValidate:!0});const x=t.loading("Buscando endereço para a nova localização...");try{const r=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${a}&lon=${f}&addressdetails=1`,y=await fetch(r);if(!y.ok)throw new Error("Falha ao obter detalhes do endereço.");const C=await y.json();C.address?(L(C.address),t.success("Endereço atualizado a partir do mapa.")):t.warning("Não foi possível encontrar um endereço para esta localização.")}catch(r){t.error(`Erro ao buscar endereço: ${r.message}`)}finally{t.dismiss(x)}},[o,L]),w=J({mutationFn:async a=>{if(!(s!=null&&s.id))throw new Error("ID do restaurante não disponível.");const{id:f,...x}={...a,id:s.id},{error:r}=await R.from("restaurants").update(x).eq("id",f);if(r)throw r},onSuccess:()=>{t.success("Configurações salvas com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings"]})},onError:a=>t.error(`Erro ao salvar configurações: ${a.message}`)});return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(ae,{children:[e.jsx(oe,{children:e.jsx(se,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(re,{children:B?e.jsx(ce,{className:"h-96 w-full"}):I?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",A.message]}):e.jsx(de,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(a=>w.mutate(a)),className:"space-y-6",children:[e.jsx(n,{control:o.control,name:"name",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Nome do Restaurante *"}),e.jsx(d,{children:e.jsx(u,{...a})}),e.jsx(c,{})]})}),e.jsx(n,{control:o.control,name:"description",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Descrição"}),e.jsx(d,{children:e.jsx(ne,{...a,rows:3})}),e.jsx(c,{})]})}),e.jsx(n,{control:o.control,name:"logo_url",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"URL do Logo"}),e.jsx(d,{children:e.jsx(u,{...a})}),e.jsx(c,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{placeholder:"Digite o CEP",value:j,onChange:a=>N(a.target.value)}),e.jsx(u,{placeholder:"Número",value:g,onChange:a=>D(a.target.value)}),e.jsx(k,{type:"button",onClick:Q,disabled:E,children:E?e.jsx(ie,{className:"h-4 w-4 animate-spin"}):e.jsx(me,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(n,{control:o.control,name:"street",render:({field:a})=>e.jsxs(l,{className:"md:col-span-2",children:[e.jsx(i,{children:"Rua"}),e.jsx(d,{children:e.jsx(u,{...a,disabled:!0})}),e.jsx(c,{})]})}),e.jsx(n,{control:o.control,name:"number",render:({field:a})=>e.jsxs(l,{className:"md:col-span-1",children:[e.jsx(i,{children:"Número"}),e.jsx(d,{children:e.jsx(u,{...a,disabled:!0})}),e.jsx(c,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:o.control,name:"neighborhood",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Bairro"}),e.jsx(d,{children:e.jsx(u,{...a,disabled:!0})}),e.jsx(c,{})]})}),e.jsx(n,{control:o.control,name:"city",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Cidade"}),e.jsx(d,{children:e.jsx(u,{...a,disabled:!0})}),e.jsx(c,{})]})})]}),e.jsx(n,{control:o.control,name:"zip_code",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"CEP"}),e.jsx(d,{children:e.jsx(M,{...a,disabled:!0})}),e.jsx(c,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:q&&e.jsx($,{center:_,markerPosition:_,onLocationChange:K})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:o.control,name:"latitude",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Latitude"}),e.jsx(d,{children:e.jsx(u,{...a,placeholder:"-22.7627908",value:a.value??""})}),e.jsx(c,{})]})}),e.jsx(n,{control:o.control,name:"longitude",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Longitude"}),e.jsx(d,{children:e.jsx(u,{...a,placeholder:"-47.408315",value:a.value??""})}),e.jsx(c,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:o.control,name:"phone",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Telefone"}),e.jsx(d,{children:e.jsx(u,{...a})}),e.jsx(c,{})]})}),e.jsx(n,{control:o.control,name:"email",render:({field:a})=>e.jsxs(l,{children:[e.jsx(i,{children:"Email"}),e.jsx(d,{children:e.jsx(u,{...a})}),e.jsx(c,{})]})})]}),e.jsx(n,{control:o.control,name:"is_active",render:({field:a})=>e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(i,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(d,{children:e.jsx(le,{checked:a.value,onCheckedChange:a.onChange})})]})}),e.jsx(k,{type:"submit",className:"w-full h-12 text-lg",disabled:w.isPending,children:w.isPending?"Salvando...":"Salvar Configurações"})]})})})]})})})};export{ze as default};
