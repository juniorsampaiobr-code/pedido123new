import{j as e,b as re,u as te,c as z}from"./tanstack-DXzASLyu.js";import{o as ne,s as j,l as T,b as le,p as q,c as R,u as ie,t as de}from"./types-CUwlEUMq.js";import{s as b}from"./client-lAKPhnc8.js";import{B as V}from"./button-BNFJL9F0.js";import{C as D,b as U,c as I,a as A}from"./card-kO8gc-l0.js";import{I as x,L as B}from"./label-uyUgdqst.js";import{T as ce}from"./textarea-qjp6ZxCf.js";import{S as ue}from"./switch-nnIUR7db.js";import{c as me,u as t,L as he}from"./index-9b8Yj9sn.js";import{F as pe,b as n,c as l,a as i,d,e as u}from"./form-D72Hn6O7.js";import{S as xe}from"./skeleton-EgI8HOYM.js";import{r as g}from"./vendor-YgypLURK.js";import{L as je,Z as Q,S as ge}from"./ZipCodeInput-DA0rhWuT.js";import{U as fe}from"./upload-No_V6gGY.js";import"./supabase-Bm28tI2t.js";import"./index-CUvv1sQ9.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=me("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]),ve=ne({name:j().min(1,"O nome do restaurante é obrigatório."),description:j().optional(),logo_url:j().url("URL do logo inválida.").optional().or(T("")),street:j().optional(),number:j().optional(),neighborhood:j().optional(),city:j().optional(),zip_code:j().optional(),phone:j().optional(),email:j().email("Email inválido.").optional().or(T("")),is_active:le().default(!0),latitude:q(m=>String(m).replace(",","."),R.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:q(m=>String(m).replace(",","."),R.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),ye=async()=>{const{data:m,error:h}=await b.from("restaurants").select("*").limit(1).single();if(h)throw new Error(`Erro ao buscar dados do restaurante: ${h.message}`);if(!m)throw new Error("Nenhum restaurante encontrado.");return m},K=g.memo(({center:m,markerPosition:h,onLocationChange:v})=>e.jsx(je,{center:m,markerPosition:h,onLocationChange:v}));K.displayName="MemoizedLocationPickerMap";const De=()=>{const m=re(),[h,v]=g.useState(null),[_,Z]=g.useState(""),[y,H]=g.useState(""),[P,L]=g.useState(!1),[O,F]=g.useState(!1),{data:a,isLoading:G,isError:J,error:W}=te({queryKey:["restaurantSettings"],queryFn:ye,staleTime:1e3*60*5}),o=ie({resolver:de(ve),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});g.useEffect(()=>{a&&(o.reset({name:a.name||"",description:a.description||"",logo_url:a.logo_url||"",street:a.street||"",number:a.number||"",neighborhood:a.neighborhood||"",city:a.city||"",zip_code:a.zip_code||"",phone:a.phone||"",email:a.email||"",is_active:a.is_active??!0,latitude:a.latitude??null,longitude:a.longitude??null}),a.latitude&&a.longitude&&F(!0))},[a,o.reset]);const N=o.watch("latitude"),w=o.watch("longitude"),X=[-23.55052,-46.633308],M=g.useMemo(()=>typeof N=="number"&&typeof w=="number"&&!isNaN(N)&&!isNaN(w)?[N,w]:X,[N,w]),k=g.useCallback(s=>{o.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),o.setValue("number",s.house_number||"",{shouldValidate:!0}),o.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),o.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),o.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[o]),Y=async()=>{const s=_.replace(/\D/g,"");if(s.length!==8||!y){t.warning("Por favor, digite um CEP válido e o número da casa.");return}L(!0);const c=t.loading("Buscando endereço e coordenadas...");try{const p=await fetch(`https://viacep.com.br/ws/${s}/json/`);if(!p.ok)throw new Error("Falha na busca do CEP.");const r=await p.json();if(r.erro){t.error("CEP não encontrado.");return}o.setValue("street",r.logradouro,{shouldValidate:!0}),o.setValue("number",y,{shouldValidate:!0}),o.setValue("neighborhood",r.bairro,{shouldValidate:!0}),o.setValue("city",r.localidade,{shouldValidate:!0}),o.setValue("zip_code",r.cep,{shouldValidate:!0});const f=`${r.logradouro}, ${y}, ${r.localidade}, ${r.uf}`,C=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(f)}`,$=await(await fetch(C)).json();if($.length>0){const{lat:oe,lon:ae}=$[0];o.setValue("latitude",parseFloat(oe),{shouldValidate:!0}),o.setValue("longitude",parseFloat(ae),{shouldValidate:!0}),F(!0),t.success("Endereço e mapa atualizados com sucesso!")}else t.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(p){t.error(`Erro na busca: ${p.message}`)}finally{L(!1),t.dismiss(c)}},ee=g.useCallback(async(s,c)=>{o.setValue("latitude",s,{shouldValidate:!0}),o.setValue("longitude",c,{shouldValidate:!0});const p=t.loading("Buscando endereço para a nova localização...");try{const r=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${c}&addressdetails=1`,f=await fetch(r);if(!f.ok)throw new Error("Falha ao obter detalhes do endereço.");const C=await f.json();C.address?(k(C.address),t.success("Endereço atualizado a partir do mapa.")):t.warning("Não foi possível encontrar um endereço para esta localização.")}catch(r){t.error(`Erro ao buscar endereço: ${r.message}`)}finally{t.dismiss(p)}},[o,k]),S=z({mutationFn:async s=>{if(!(a!=null&&a.id))throw new Error("ID do restaurante não disponível.");const{id:c,...p}={...s,id:a.id},{error:r}=await b.from("restaurants").update(p).eq("id",c);if(r)throw r},onSuccess:()=>{t.success("Configurações salvas com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings"]})},onError:s=>t.error(`Erro ao salvar configurações: ${s.message}`)}),E=z({mutationFn:async s=>{if(!(a!=null&&a.id))throw new Error("ID do restaurante não disponível.");const c=`${a.id}/notification.mp3`,{error:p}=await b.storage.from("settings").upload(c,s,{upsert:!0});if(p)throw p;const{data:r}=b.storage.from("settings").getPublicUrl(c),{error:f}=await b.from("restaurants").update({notification_sound_url:`${r.publicUrl}?t=${new Date().getTime()}`}).eq("id",a.id);if(f)throw f},onSuccess:()=>{t.success("Som de notificação atualizado com sucesso!"),m.invalidateQueries({queryKey:["restaurantSettings"]}),v(null)},onError:s=>t.error(`Erro ao salvar som: ${s.message}`)}),se=()=>{h&&E.mutate(h)};return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(D,{children:[e.jsx(U,{children:e.jsx(I,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(A,{children:G?e.jsx(xe,{className:"h-96 w-full"}):J?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",W.message]}):e.jsx(pe,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(s=>S.mutate(s)),className:"space-y-6",children:[e.jsx(n,{control:o.control,name:"name",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Nome do Restaurante *"}),e.jsx(d,{children:e.jsx(x,{...s})}),e.jsx(u,{})]})}),e.jsx(n,{control:o.control,name:"description",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Descrição"}),e.jsx(d,{children:e.jsx(ce,{...s,rows:3})}),e.jsx(u,{})]})}),e.jsx(n,{control:o.control,name:"logo_url",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"URL do Logo"}),e.jsx(d,{children:e.jsx(x,{...s})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{placeholder:"Digite o CEP",value:_,onChange:s=>Z(s.target.value)}),e.jsx(x,{placeholder:"Número",value:y,onChange:s=>H(s.target.value)}),e.jsx(V,{type:"button",onClick:Y,disabled:P,children:P?e.jsx(he,{className:"h-4 w-4 animate-spin"}):e.jsx(ge,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(n,{control:o.control,name:"street",render:({field:s})=>e.jsxs(l,{className:"md:col-span-2",children:[e.jsx(i,{children:"Rua"}),e.jsx(d,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(u,{})]})}),e.jsx(n,{control:o.control,name:"number",render:({field:s})=>e.jsxs(l,{className:"md:col-span-1",children:[e.jsx(i,{children:"Número"}),e.jsx(d,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(u,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:o.control,name:"neighborhood",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Bairro"}),e.jsx(d,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(u,{})]})}),e.jsx(n,{control:o.control,name:"city",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Cidade"}),e.jsx(d,{children:e.jsx(x,{...s,disabled:!0})}),e.jsx(u,{})]})})]}),e.jsx(n,{control:o.control,name:"zip_code",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"CEP"}),e.jsx(d,{children:e.jsx(Q,{...s,disabled:!0})}),e.jsx(u,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:O&&e.jsx(K,{center:M,markerPosition:M,onLocationChange:ee})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:o.control,name:"latitude",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Latitude"}),e.jsx(d,{children:e.jsx(x,{...s,placeholder:"-22.7627908",value:s.value??""})}),e.jsx(u,{})]})}),e.jsx(n,{control:o.control,name:"longitude",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Longitude"}),e.jsx(d,{children:e.jsx(x,{...s,placeholder:"-47.408315",value:s.value??""})}),e.jsx(u,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Telefone"}),e.jsx(d,{children:e.jsx(x,{...s})}),e.jsx(u,{})]})}),e.jsx(n,{control:o.control,name:"email",render:({field:s})=>e.jsxs(l,{children:[e.jsx(i,{children:"Email"}),e.jsx(d,{children:e.jsx(x,{...s})}),e.jsx(u,{})]})})]}),e.jsx(n,{control:o.control,name:"is_active",render:({field:s})=>e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(i,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(d,{children:e.jsx(ue,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx(V,{type:"submit",className:"w-full h-12 text-lg",disabled:S.isPending,children:S.isPending?"Salvando...":"Salvar Configurações"})]})})})]}),e.jsxs(D,{children:[e.jsxs(U,{children:[e.jsxs(I,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(be,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(fe,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(h==null?void 0:h.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:s=>{var c;return v(((c=s.target.files)==null?void 0:c[0])||null)}})]})]}),e.jsx(V,{onClick:se,className:"w-full h-12 text-lg",disabled:!h||E.isPending,children:E.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{De as default};
