import{b as ie,u as ce,c as T,j as e}from"./tanstack-D8i8yNxB.js";import{o as de,s as p,l as R,b as ue,p as z,c as I,u as me,t as he}from"./types-BCrSgEF3.js";import{s as w}from"./client-BmrnLCXS.js";import{B as S}from"./button-CtbEP4Yx.js";import{C as A,b as B,c as K,a as Q}from"./card-DSR_BTWd.js";import{I as u,L as O}from"./label-DjS7mD5S.js";import{T as pe}from"./textarea-Dlvmb-i_.js";import{S as xe}from"./switch-B7cWs9dU.js";import{c as H,L as je,u as m}from"./index-BnWGrLjA.js";import{F as ge,b as t,c as n,a as l,d as i,e as c}from"./form-I1DU20dx.js";import{S as fe}from"./skeleton-Gm_IXYoe.js";import{r as x}from"./vendor-Dl0Wzy4_.js";import{Z,M as be}from"./MapLocationSection-D7ET_E5_.js";import{u as ve}from"./use-sound-BBGoA6Ap.js";import{C as ye,a as we}from"./circle-x-UG4vgKuq.js";import{V as Ne}from"./volume-2-QyZi4GIO.js";import{U as Ce}from"./upload-0hl_26Ai.js";import"./supabase-A1WgB1xz.js";import"./index-PuW-_iwo.js";import"./alert-C7baxq6O.js";import"./map-pin-UpoUpVRl.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=H("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=H("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),Ve=de({name:p().min(1,"O nome do restaurante é obrigatório."),description:p().optional(),logo_url:p().url("URL do logo inválida.").optional().or(R("")),street:p().optional(),number:p().optional(),neighborhood:p().optional(),city:p().optional(),zip_code:p().optional(),phone:p().optional(),email:p().email("Email inválido.").optional().or(R("")),is_active:ue().default(!0),latitude:z(j=>String(j).replace(",","."),I.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),longitude:z(j=>String(j).replace(",","."),I.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),_e=async()=>{const{data:j,error:N}=await w.from("restaurants").select("*").limit(1).single();if(N)throw new Error(`Erro ao buscar dados do restaurante: ${N.message}`);if(!j)throw new Error("Nenhum restaurante encontrado.");return j},Je=()=>{const j=ie(),{playSound:N}=ve(),[b,_]=x.useState(null),[F,L]=x.useState(""),[C,k]=x.useState(""),[P,U]=x.useState(!1),[X,$]=x.useState(!1),{data:r,isLoading:M,isError:G,error:J}=ce({queryKey:["restaurantSettings"],queryFn:_e,staleTime:1e3*60*5}),s=me({resolver:he(Ve),defaultValues:{name:"",description:"",logo_url:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});x.useEffect(()=>{r&&(s.reset({name:r.name||"",description:r.description||"",logo_url:r.logo_url||"",street:r.street||"",number:r.number||"",neighborhood:r.neighborhood||"",city:r.city||"",zip_code:r.zip_code||"",phone:r.phone||"",email:r.email||"",is_active:r.is_active??!0,latitude:r.latitude??null,longitude:r.longitude??null}),r.latitude&&r.longitude&&$(!0))},[r,s.reset]);const g=s.watch("latitude"),f=s.watch("longitude"),W=[-23.55052,-46.633308],Y=x.useMemo(()=>typeof g=="number"&&typeof f=="number"&&!isNaN(g)&&!isNaN(f)?[g,f]:W,[g,f]),ee=x.useCallback(o=>{s.setValue("street",o.road||o.logradouro||"",{shouldValidate:!0}),s.setValue("number",o.house_number||"",{shouldValidate:!0}),s.setValue("neighborhood",o.suburb||o.bairro||"",{shouldValidate:!0}),s.setValue("city",o.city||o.localidade||"",{shouldValidate:!0}),s.setValue("zip_code",o.postcode||o.cep||"",{shouldValidate:!0}),L((o.postcode||o.cep||"").replace(/\D/g,"")),k(o.house_number||"")},[s]),oe=async()=>{const o=s.getValues();o.street,o.number,o.neighborhood,o.city,o.zip_code;const a=F.replace(/\D/g,"");if(a.length!==8||!C){m.warning("Por favor, digite um CEP válido e o número da casa.");return}U(!0);const v=m.loading("Buscando endereço e coordenadas...");try{const h=await fetch(`https://viacep.com.br/ws/${a}/json/`);if(!h.ok)throw new Error("Falha na busca do CEP.");const d=await h.json();if(d.erro){m.error("CEP não encontrado.");return}s.setValue("street",d.logradouro,{shouldValidate:!0}),s.setValue("number",C,{shouldValidate:!0}),s.setValue("neighborhood",d.bairro,{shouldValidate:!0}),s.setValue("city",d.localidade,{shouldValidate:!0}),s.setValue("zip_code",d.cep,{shouldValidate:!0});const y=`${d.logradouro}, ${C}, ${d.localidade}, ${d.uf}`,te=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(y)}`,D=await(await fetch(te)).json();if(D.length>0){const{lat:ne,lon:le}=D[0];s.setValue("latitude",parseFloat(ne),{shouldValidate:!0}),s.setValue("longitude",parseFloat(le),{shouldValidate:!0}),$(!0),m.success("Endereço e mapa atualizados com sucesso!")}else m.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente.")}catch(h){m.error(`Erro na busca: ${h.message}`)}finally{U(!1),m.dismiss(v)}},se=x.useCallback((o,a)=>{s.setValue("latitude",o,{shouldValidate:!0}),s.setValue("longitude",a,{shouldValidate:!0})},[s]),E=T({mutationFn:async o=>{if(!(r!=null&&r.id))throw new Error("ID do restaurante não disponível.");const{id:a,...v}={...o,id:r.id},{error:h}=await w.from("restaurants").update(v).eq("id",a);if(h)throw h},onSuccess:()=>{m.success("Configurações salvas com sucesso!"),j.invalidateQueries({queryKey:["restaurantSettings"]})},onError:o=>m.error(`Erro ao salvar configurações: ${o.message}`)}),V=T({mutationFn:async o=>{if(!(r!=null&&r.id))throw new Error("ID do restaurante não disponível.");if(o.type!=="audio/mpeg"&&o.type!=="audio/mp3")throw new Error("O arquivo deve ser do tipo MP3.");const a=`${r.id}/notification.mp3`;console.log(`[Sound Upload] Attempting upload to settings/${a}`);const{error:v}=await w.storage.from("settings").upload(a,o,{upsert:!0,contentType:"audio/mpeg"});if(v)throw v;const{data:h}=w.storage.from("settings").getPublicUrl(a);if(!h.publicUrl)throw new Error("Falha ao obter a URL pública do arquivo.");const d=`${h.publicUrl}?t=${new Date().getTime()}`;console.log(`[DB Update] Updating restaurant ID: ${r.id} with URL: ${d}`);const{error:y}=await w.from("restaurants").update({notification_sound_url:d}).eq("id",r.id);if(y)throw console.error("[DB Update Error] Supabase Error:",y),new Error(`Falha ao salvar URL no banco de dados: ${y.message}`)},onSuccess:()=>{m.success("Som de notificação atualizado com sucesso!"),j.invalidateQueries({queryKey:["restaurantSettings"]}),_(null)},onError:o=>{console.error("Erro detalhado no upload do som:",o),m.error(`Erro ao salvar som: ${o.message}`)}}),re=()=>{b&&V.mutate(b)},q=!!(r!=null&&r.notification_sound_url),ae=x.useMemo(()=>g===null||f===null?"map-settings-null":`map-settings-${g.toFixed(6)}-${f.toFixed(6)}`,[g,f]);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs(A,{children:[e.jsx(B,{children:e.jsx(K,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsx(Q,{children:M?e.jsx(fe,{className:"h-96 w-full"}):G?e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",J.message]}):e.jsx(ge,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(o=>E.mutate(o)),className:"space-y-6",children:[e.jsx(t,{control:s.control,name:"name",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Nome do Restaurante *"}),e.jsx(i,{children:e.jsx(u,{...o})}),e.jsx(c,{})]})}),e.jsx(t,{control:s.control,name:"description",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Descrição"}),e.jsx(i,{children:e.jsx(pe,{...o,rows:3})}),e.jsx(c,{})]})}),e.jsx(t,{control:s.control,name:"logo_url",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"URL do Logo"}),e.jsx(i,{children:e.jsx(u,{...o})}),e.jsx(c,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{placeholder:"Digite o CEP",value:F,onChange:o=>L(o.target.value)}),e.jsx(u,{placeholder:"Número",value:C,onChange:o=>k(o.target.value)}),e.jsx(S,{type:"button",onClick:oe,disabled:P,children:P?e.jsx(je,{className:"h-4 w-4 animate-spin"}):e.jsx(Ee,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(t,{control:s.control,name:"street",render:({field:o})=>e.jsxs(n,{className:"md:col-span-2",children:[e.jsx(l,{children:"Rua"}),e.jsx(i,{children:e.jsx(u,{...o,disabled:!0})}),e.jsx(c,{})]})}),e.jsx(t,{control:s.control,name:"number",render:({field:o})=>e.jsxs(n,{className:"md:col-span-1",children:[e.jsx(l,{children:"Número"}),e.jsx(i,{children:e.jsx(u,{...o,disabled:!0})}),e.jsx(c,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:s.control,name:"neighborhood",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Bairro"}),e.jsx(i,{children:e.jsx(u,{...o,disabled:!0})}),e.jsx(c,{})]})}),e.jsx(t,{control:s.control,name:"city",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Cidade"}),e.jsx(i,{children:e.jsx(u,{...o,disabled:!0})}),e.jsx(c,{})]})})]}),e.jsx(t,{control:s.control,name:"zip_code",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"CEP"}),e.jsx(i,{children:e.jsx(Z,{...o,disabled:!0})}),e.jsx(c,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:X&&e.jsx(be,{mapKey:ae,markerPosition:Y,onLocationChange:se,updateAddressFields:ee,restaurant:r})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:s.control,name:"latitude",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Latitude"}),e.jsx(i,{children:e.jsx(u,{...o,placeholder:"-22.7627908",value:o.value??""})}),e.jsx(c,{})]})}),e.jsx(t,{control:s.control,name:"longitude",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Longitude"}),e.jsx(i,{children:e.jsx(u,{...o,placeholder:"-47.408315",value:o.value??""})}),e.jsx(c,{})]})})]}),e.jsx("h3",{className:"text-lg font-semibold pt-4 border-t mt-6",children:"Contato"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:s.control,name:"phone",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Telefone"}),e.jsx(i,{children:e.jsx(u,{...o})}),e.jsx(c,{})]})}),e.jsx(t,{control:s.control,name:"email",render:({field:o})=>e.jsxs(n,{children:[e.jsx(l,{children:"Email"}),e.jsx(i,{children:e.jsx(u,{...o})}),e.jsx(c,{})]})})]}),e.jsx(t,{control:s.control,name:"is_active",render:({field:o})=>e.jsxs(n,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(l,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(i,{children:e.jsx(xe,{checked:o.value,onCheckedChange:o.onChange})})]})}),e.jsx(S,{type:"submit",className:"w-full h-12 text-lg",disabled:E.isPending,children:E.isPending?"Salvando...":"Salvar Configurações"})]})})})]}),e.jsxs(A,{children:[e.jsxs(B,{children:[e.jsxs(K,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Se,{className:"h-6 w-6 text-primary"}),"Notificação Sonora"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Envie um arquivo MP3 para ser usado como som de notificação para novos pedidos."})]}),e.jsxs(Q,{className:"space-y-4",children:[q&&e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-green-50/50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ye,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Som Salvo: notification.mp3"})]}),e.jsxs(S,{variant:"outline",size:"sm",onClick:N,children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"})," Testar"]})]}),!q&&!M&&e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-yellow-50/50 dark:bg-yellow-900/20",children:[e.jsx(we,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),e.jsx("span",{className:"font-medium text-sm",children:"Nenhum som de notificação configurado."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"sound-upload",children:"Arquivo de Som (MP3)"}),e.jsxs("label",{className:"flex items-center justify-center w-full h-12 px-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-muted",children:[e.jsx(Ce,{className:"w-4 w-4 mr-2"}),e.jsx("span",{children:(b==null?void 0:b.name)||"Escolher Arquivo MP3"}),e.jsx("input",{id:"sound-upload",type:"file",className:"hidden",accept:".mp3",onChange:o=>{var a;return _(((a=o.target.files)==null?void 0:a[0])||null)}})]})]}),e.jsx(S,{onClick:re,className:"w-full h-12 text-lg",disabled:!b||V.isPending,children:V.isPending?"Salvando Som...":"Salvar Som de Notificação"})]})]})]})})};export{Je as default};
