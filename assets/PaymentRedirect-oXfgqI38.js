import{b as $,j as e}from"./tanstack-d4AvmB45.js";import{u as b,k as N,j as R,r as f}from"./vendor-CnEXr6gt.js";import{s as E}from"./client-D5i5GwB9.js";import{u as n,L as S}from"./index-fVAgBsXa.js";import{C as k,b as q,c as L,a as M}from"./card-Cbd63JDy.js";import{C as T}from"./circle-alert-DEkGIPpl.js";import{C as O}from"./circle-check-big-gSD4KwiD.js";import"./supabase-BZV_3FV3.js";const V=async r=>{const{data:d,error:t}=await E.from("orders").select("*").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar pedido: ${t.message}`);if(!d)throw new Error("Pedido não encontrado.");return d},K=()=>{const r=b(),{orderId:d}=N(),[t]=R(),[v,s]=f.useState("Verificando status do pagamento..."),[h,i]=f.useState(!0),[p,m]=f.useState(!1);t.get("status");const C=t.get("external_reference"),I=t.get("restaurantId"),o=d||C,{data:c,isLoading:P}=$({queryKey:["paymentRedirectOrder",o],queryFn:()=>V(o),enabled:!!o,staleTime:0}),a=(c==null?void 0:c.restaurant_id)||I,y=g=>{g?r(`/menu/${g}`,{replace:!0}):r("/",{replace:!0})};return f.useEffect(()=>{if(!o){s("ID do pedido não encontrado na URL."),m(!0),i(!1),n.error("Erro de redirecionamento: ID do pedido ausente."),y(a);return}if(P)return;if(!c){s("Pedido não encontrado no banco de dados."),m(!0),i(!1),n.error("Erro: Pedido não existe."),y(a);return}(async()=>{i(!0),s("Confirmando pagamento com Mercado Pago...");try{const{data:u,error:j}=await E.functions.invoke("confirm-payment",{body:{orderId:o}});if(j){let x=j.message;throw x.includes("non-2xx status code")&&(x="Falha de comunicação com o servidor. Verifique se a função 'confirm-payment' está implantada."),new Error(x)}const l=u,w=`/order-success/${o}?status=${l.status}${a?`&restaurantId=${a}`:""}`;l.status==="approved"?(s("Pagamento Aprovado! Redirecionando..."),n.success("Pagamento aprovado!"),r(w,{replace:!0})):l.status==="pending"?(s("Pagamento Pendente. Aguardando confirmação..."),n.warning("Pagamento pendente. Você será notificado quando for confirmado."),r(w,{replace:!0})):(s(`Pagamento Recusado. Status: ${l.status}`),n.error("Pagamento recusado. Tente novamente."),m(!0),r(`/checkout${a?`?restaurantId=${a}`:""}`,{replace:!0}))}catch(u){console.error("Erro na confirmação de pagamento:",u),s(`Erro ao processar pagamento: ${u.message}`),m(!0),i(!1),n.error("Erro ao processar pagamento. Tente novamente."),r(`/checkout${a?`?restaurantId=${a}`:""}`,{replace:!0})}})()},[o,P,c,r,t,a]),e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-muted",children:e.jsxs(k,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(q,{children:e.jsxs(L,{className:"text-2xl font-bold flex items-center justify-center gap-2",children:[h?e.jsx(S,{className:"h-6 w-6 animate-spin text-primary"}):p?e.jsx(T,{className:"h-6 w-6 text-destructive"}):e.jsx(O,{className:"h-6 w-6 text-green-500"}),h?"Processando Pagamento":p?"Erro de Pagamento":"Redirecionando..."]})}),e.jsxs(M,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:v}),p&&e.jsx("div",{className:"mt-4",children:e.jsx("p",{className:"text-sm text-destructive",children:"Você será redirecionado em breve."})})]})]})})};export{K as default};
