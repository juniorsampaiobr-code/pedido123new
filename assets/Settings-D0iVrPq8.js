import{j as e,u as ae,b as oe,c as te}from"./tanstack-Ch7Ewlpa.js";import{o as ne,s as g,l as ie,b as le,p as I,c as k,u as ce,C as q,t as de}from"./types-CtpoKdVi.js";import{s as C}from"./client-3S0ugJ5L.js";import{B as A}from"./button-COUWwmno.js";import{C as Q,b as G,c as Z,a as H}from"./card-CCmRprzK.js";import{I as j,L as U}from"./label-DNGrPJ6q.js";import{T as ue}from"./textarea-Cc5X7dnw.js";import{S as me}from"./switch-CtkQ96tM.js";import{u as n,L as J,a as O}from"./index-CPkED4PA.js";import{F as he,a as d,b as i,c as u,d as l,e as p}from"./form-Bf7_va0t.js";import{S as pe}from"./skeleton-DvYYkdup.js";import{r as c,i as xe}from"./vendor-CCvq-0xx.js";import{L as ge,Z as K,g as je}from"./location-BhUDE3G0.js";import{M as fe,P as be}from"./PhoneInput-DDZ3hamG.js";import{M as ve,R as Ne}from"./refresh-cw-CdgUwinh.js";import{P as ye}from"./phone-DqJOBicK.js";import{S as we}from"./search-9aKURJTV.js";import"./supabase-t-NbcSY6.js";import"./index-BMYbFAKC.js";const Ee=({mapKey:a,markerPosition:t,onLocationChange:b,updateAddressFields:w,restaurant:f})=>{const[y,S]=c.useState(!1),P=c.useCallback(async()=>{S(!0);const E=n.loading("Buscando endereço a partir do mapa..."),[V,M]=t;try{const r=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${V}&lon=${M}&zoom=18&addressdetails=1`,m=await fetch(r);if(!m.ok)throw new Error("Falha na geocodificação reversa.");const h=await m.json();h.address?(w(h.address),n.success("Endereço atualizado com base na localização do mapa!")):n.warning("Não foi possível encontrar um endereço detalhado para esta localização.")}catch(r){n.error(`Erro na busca reversa: ${r.message}`)}finally{S(!1),n.dismiss(E)}},[t,w]),o=c.useMemo(()=>[f.street,f.number,f.neighborhood,f.city,f.zip_code].filter(Boolean).join(", "),[f]);return e.jsxs(Q,{className:"mt-6",children:[e.jsx(G,{children:e.jsxs(Z,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ve,{className:"h-5 w-5 text-primary"}),"Localização no Mapa"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"h-80 w-full rounded-lg overflow-hidden border",children:e.jsx(ge,{center:t,markerPosition:t,onMarkerDragEnd:b,zoom:15},a)}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground max-w-[70%] truncate",children:["Endereço atual: ",o||"N/A"]}),e.jsxs(A,{type:"button",variant:"outline",onClick:P,disabled:y,children:[y?e.jsx(J,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Atualizar Endereço"]})]})]})]})},Ce=c.memo(Ee),Se=a=>a.replace(/\D/g,""),Ve=ne({name:g().min(1,"O nome do restaurante é obrigatório."),description:g().optional(),street:g().optional(),number:g().min(1,"O número é obrigatório."),neighborhood:g().optional(),city:g().optional(),zip_code:g().min(1,"O CEP é obrigatório.").transform(a=>a.replace(/\D/g,"")).refine(a=>a.length===8,{message:"O CEP deve ter 8 dígitos."}),phone:g().min(1,"Telefone é obrigatório.").transform(Se).refine(a=>a.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:g().email("Email inválido.").optional().or(ie("")),is_active:le().default(!0),latitude:I(a=>String(a).replace(",","."),k.number({invalid_type_error:"Latitude deve ser um número."}).refine(a=>a!==null,{message:'A localização no mapa é obrigatória. Use o botão "Buscar Endereço".'})),longitude:I(a=>String(a).replace(",","."),k.number({invalid_type_error:"Longitude deve ser um número."}).refine(a=>a!==null,{message:'A localização no mapa é obrigatória. Use o botão "Buscar Endereço".'}))}),_e=async a=>{const{data:t,error:b}=await C.from("restaurants").select("*").eq("id",a).single();if(b)throw new Error(`Erro ao buscar dados do restaurante: ${b.message}`);if(!t)throw new Error("Nenhum restaurante encontrado.");return t},Ze=()=>{var $,B;const a=ae(),{userRestaurantId:t}=xe(),[b,w]=c.useState(!1),[f,y]=c.useState(!1),[S,P]=c.useState(null),{data:o,isLoading:E,isError:V,error:M}=oe({queryKey:["restaurantSettings",t],queryFn:()=>_e(t),enabled:!!t,staleTime:1e3*60*5});c.useEffect(()=>{C.auth.getSession().then(({data:{session:s}})=>{var x;P(((x=s==null?void 0:s.user)==null?void 0:x.email)||null)})},[]);const r=ce({resolver:de(Ve),defaultValues:{name:"",description:"",street:"",number:"",neighborhood:"",city:"",zip_code:"",phone:"",email:"",is_active:!0,latitude:null,longitude:null},mode:"onBlur"});c.useEffect(()=>{o&&(r.reset({name:o.name||"",description:o.description||"",street:o.street||"",number:o.number||"",neighborhood:o.neighborhood||"",city:o.city||"",zip_code:o.zip_code||"",phone:o.phone||"",email:o.email||"",is_active:o.is_active??!0,latitude:o.latitude??null,longitude:o.longitude??null}),o.latitude&&o.longitude&&y(!0))},[o,r.reset]);const m=r.watch("latitude"),h=r.watch("longitude"),R=r.formState.errors.zip_code||r.formState.errors.number,F=[-23.55052,-46.633308],W=c.useMemo(()=>typeof m=="number"&&typeof h=="number"&&!isNaN(m)&&!isNaN(h)?[m,h]:F,[m,h]),X=c.useCallback(s=>{r.setValue("street",s.road||s.logradouro||"",{shouldValidate:!0}),r.setValue("number",s.house_number||"",{shouldValidate:!0}),r.setValue("neighborhood",s.suburb||s.bairro||"",{shouldValidate:!0}),r.setValue("city",s.city||s.localidade||"",{shouldValidate:!0}),r.setValue("zip_code",s.postcode||s.cep||"",{shouldValidate:!0})},[r]),Y=async()=>{if(!await r.trigger(["zip_code","number"])){n.error("Por favor, preencha o CEP e o Número corretamente.");return}const x=r.getValues(),_=x.zip_code.replace(/\D/g,""),z=x.number;w(!0);const L=n.loading("Buscando endereço e coordenadas...");try{const v=await fetch(`https://viacep.com.br/ws/${_}/json/`);if(!v.ok)throw new Error("Falha na busca do CEP.");const N=await v.json();if(N.erro){n.error("CEP não encontrado.");return}r.setValue("street",N.logradouro,{shouldValidate:!0}),r.setValue("neighborhood",N.bairro,{shouldValidate:!0}),r.setValue("city",N.localidade,{shouldValidate:!0});const re=`${N.logradouro}, ${z}, ${N.localidade}, ${N.uf}`,T=await je(re);T?(r.setValue("latitude",T.lat,{shouldValidate:!0}),r.setValue("longitude",T.lng,{shouldValidate:!0}),y(!0),n.success("Endereço e mapa atualizados com sucesso!")):(r.setValue("latitude",F[0],{shouldValidate:!0}),r.setValue("longitude",F[1],{shouldValidate:!0}),y(!0),n.warning("Endereço encontrado, mas não foi possível obter as coordenadas exatas. Ajuste o pino no mapa manualmente."))}catch(v){n.dismiss(L),n.error(`Erro na busca: ${v.message}`)}finally{n.dismiss(L),w(!1)}},ee=c.useCallback((s,x)=>{r.setValue("latitude",s,{shouldValidate:!0}),r.setValue("longitude",x,{shouldValidate:!0})},[r]),D=te({mutationFn:async s=>{if(!t)throw new Error("ID do restaurante não disponível.");const x={name:s.name,description:s.description,logo_url:null,street:s.street,number:s.number,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code.replace(/\D/g,""),phone:s.phone,email:s.email,is_active:s.is_active,latitude:s.latitude,longitude:s.longitude},{error:_}=await C.from("restaurants").update(x).eq("id",t);if(_)throw _;const{data:{user:z}}=await C.auth.getUser();if(z){const L={phone:s.phone},{error:v}=await C.from("profiles").update(L).eq("id",z.id);v&&console.warn("Falha ao sincronizar telefone com o perfil:",v.message)}},onSuccess:()=>{n.success("Configurações salvas com sucesso!"),a.invalidateQueries({queryKey:["restaurantSettings",t]}),a.invalidateQueries({queryKey:["adminProfile"]})},onError:s=>n.error(`Erro ao salvar configurações: ${s.message}`)}),se=c.useMemo(()=>m===null||h===null?"map-settings-null":`map-settings-${m.toFixed(6)}-${h.toFixed(6)}`,[m,h]);return e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs(Q,{children:[e.jsx(G,{children:e.jsx(Z,{className:"text-2xl font-bold",children:"Configurações do Restaurante"})}),e.jsxs(H,{children:[E&&e.jsx(pe,{className:"h-96 w-full"}),V&&e.jsxs("p",{className:"text-destructive",children:["Erro ao carregar dados: ",M.message]}),!t&&!E&&e.jsx("p",{className:"text-destructive",children:"Erro: ID do restaurante não encontrado."}),o&&!V&&!E&&e.jsx(he,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(s=>D.mutate(s)),className:"space-y-6",children:[e.jsx(d,{control:r.control,name:"name",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"Nome do Restaurante *"}),e.jsx(l,{children:e.jsx(j,{...s})}),e.jsx(p,{})]})}),e.jsx(d,{control:r.control,name:"description",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"Descrição"}),e.jsx(l,{children:e.jsx(ue,{...s,rows:3})}),e.jsx(p,{})]})}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Contato e Status"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(fe,{className:"h-4 w-4"})," Email do Administrador"]}),e.jsx(j,{value:S||"N/A",disabled:!0,className:"bg-muted/50"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este é o email de login do administrador."})]}),e.jsx(d,{control:r.control,name:"phone",render:({field:s})=>e.jsxs(i,{children:[e.jsxs(u,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4"})," Telefone do Restaurante *"]}),e.jsx(l,{children:e.jsx(be,{...s})}),e.jsx(p,{})]})})]}),e.jsx("div",{className:"pt-4 border-t mt-6",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Endereço e Localização"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{className:O(R&&"text-destructive"),children:"Buscar Endereço por CEP e Número *"}),e.jsxs("div",{className:O("flex gap-2 p-2 rounded-lg border",R?"border-destructive ring-2 ring-destructive/50":"border-input"),children:[e.jsx(q,{name:"zip_code",control:r.control,render:({field:s})=>e.jsx(i,{className:"flex-1 space-y-0",children:e.jsx(l,{children:e.jsx(K,{placeholder:"Digite o CEP",...s})})})}),e.jsx(q,{name:"number",control:r.control,render:({field:s})=>e.jsx(i,{className:"w-24 space-y-0",children:e.jsx(l,{children:e.jsx(j,{placeholder:"Nº",...s})})})}),e.jsx(A,{type:"button",onClick:Y,disabled:b,children:b?e.jsx(J,{className:"h-4 w-4 animate-spin"}):e.jsx(we,{className:"h-4 w-4"})})]}),(r.formState.errors.zip_code||r.formState.errors.number)&&e.jsx("p",{className:"text-destructive text-sm mt-1",children:(($=r.formState.errors.zip_code)==null?void 0:$.message)||((B=r.formState.errors.number)==null?void 0:B.message)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Coloque o CEP e nº do estabelecimento e para melhor precisão mova o alfinete no mapa e salve as configurações"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(d,{control:r.control,name:"street",render:({field:s})=>e.jsxs(i,{className:"md:col-span-2",children:[e.jsx(u,{children:"Rua"}),e.jsx(l,{children:e.jsx(j,{...s,disabled:!0})}),e.jsx(p,{})]})}),e.jsx(d,{control:r.control,name:"number",render:({field:s})=>e.jsxs(i,{className:"md:col-span-1",children:[e.jsx(u,{children:"Número *"}),e.jsx(l,{children:e.jsx(j,{...s,disabled:!0})}),e.jsx(p,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:r.control,name:"neighborhood",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"Bairro"}),e.jsx(l,{children:e.jsx(j,{...s,disabled:!0})}),e.jsx(p,{})]})}),e.jsx(d,{control:r.control,name:"city",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"Cidade"}),e.jsx(l,{children:e.jsx(j,{...s,disabled:!0})}),e.jsx(p,{})]})})]}),e.jsx(d,{control:r.control,name:"zip_code",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"CEP *"}),e.jsx(l,{children:e.jsx(K,{...s,disabled:!0})}),e.jsx(p,{})]})}),e.jsx("div",{className:"pt-4 border-t",children:f&&e.jsx(Ce,{mapKey:se,markerPosition:W,onLocationChange:ee,updateAddressFields:X,restaurant:o})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{control:r.control,name:"latitude",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"Latitude *"}),e.jsx(l,{children:e.jsx(j,{...s,placeholder:"-22.7627908",value:s.value??""})}),e.jsx(p,{})]})}),e.jsx(d,{control:r.control,name:"longitude",render:({field:s})=>e.jsxs(i,{children:[e.jsx(u,{children:"Longitude *"}),e.jsx(l,{children:e.jsx(j,{...s,placeholder:"-47.408315",value:s.value??""})}),e.jsx(p,{})]})})]}),e.jsx(d,{control:r.control,name:"is_active",render:({field:s})=>e.jsxs(i,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(u,{className:"font-normal",children:"Restaurante Ativo"}),e.jsx(l,{children:e.jsx(me,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx(A,{type:"submit",className:"w-full h-12 text-lg",disabled:D.isPending||!t,children:D.isPending?"Salvando...":"Salvar Configurações"})]})})]})]})})})};export{Ze as default};
