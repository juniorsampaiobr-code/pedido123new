import{j as e}from"./tanstack-C7aOFagJ.js";import{h as O,i as _,r as s,L as $}from"./vendor-DjsPZZVP.js";import{L as B}from"./Logo-DbJJIRSr.js";import{s as d,C as G,d as H,e as J,f as M,b as V,L as g,I as v,P as W,B as E,g as K,u as o}from"./index-abG_yP0q.js";import{S as Q}from"./separator-HnEYUQP_.js";import"./supabase-BAEEEeUB.js";const P=n=>n.replace(/\D/g,""),X=async()=>{const{data:n,error:c}=await d.from("restaurants").select("id").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1).single();return c&&c.code!=="PGRST116"?(console.error("Error fetching active restaurant ID:",c),null):(n==null?void 0:n.id)||null},ne=()=>{var I;const n=O(),c=_(),[w,m]=s.useState(!1),[i,U]=s.useState(!1),[h,k]=s.useState(""),[f,F]=s.useState(""),[x,R]=s.useState(""),[j,A]=s.useState(""),[Y,S]=s.useState(null),[Z,y]=s.useState(null),p=(I=c.state)==null?void 0:I.restaurantId,[u,q]=s.useState(p||null),[C,D]=s.useState(!p);s.useEffect(()=>{p||X().then(t=>{q(t),D(!1)})},[p]);const b=t=>{const a=window.location.origin,r=window.location.pathname;return`${a}${r}#/menu/${t}`};s.useEffect(()=>{const{data:{subscription:t}}=d.auth.onAuthStateChange((a,r)=>{var l;if(y(r),S((r==null?void 0:r.user)??null),r!=null&&r.user&&u)if(((l=c.state)==null?void 0:l.from)==="/checkout")console.log("Redirecting customer to checkout after login."),n("/checkout",{replace:!0});else{const L=b(u);console.log("Redirecting customer to menu:",L),window.location.href=L}});return d.auth.getSession().then(({data:{session:a}})=>{var r;if(y(a),S((a==null?void 0:a.user)??null),a!=null&&a.user&&u){const l=(r=c.state)==null?void 0:r.from;if(l==="/checkout")console.log("User already logged in, redirecting to checkout:",l),n("/checkout",{replace:!0});else{const N=b(u);console.log("User already logged in, redirecting to menu:",N),window.location.href=N}}}),()=>t.unsubscribe()},[n,u,c.state]);const z=()=>x.trim()?P(j).length!==11?(o.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1):h.trim()?f.length<6?(o.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(o.error("O Email é obrigatório."),!1):(o.error("O Nome Completo é obrigatório."),!1),T=async t=>{if(t.preventDefault(),m(!0),!u){o.error("Nenhum restaurante ativo encontrado para redirecionamento."),m(!1);return}try{if(i){if(!z()){m(!1);return}const a=P(j),{data:r,error:l}=await d.auth.signUp({email:h,password:f,options:{data:{full_name:x,phone:a}}});if(l)throw l;r.session?o.success("Conta criada e login efetuado com sucesso!"):o.success("Conta criada! Verifique seu email para confirmar.")}else{const{error:a}=await d.auth.signInWithPassword({email:h,password:f});if(a)throw a;o.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?o.error("Por favor, verifique seu e-mail para confirmar sua conta antes de fazer login."):o.error(a.message||"Erro ao processar autenticação")}finally{m(!1)}};return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(B,{className:"justify-center mb-4"})}),e.jsxs(G,{className:"shadow-xl border-2",children:[e.jsxs(H,{className:"space-y-1",children:[e.jsx(J,{className:"text-2xl font-bold text-center",children:i?"Crie sua conta":"Acesse sua conta"}),e.jsx(M,{className:"text-center",children:i?"Preencha os campos para começar":"Utilize seu email e senha para fazer login"})]}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(v,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:x,onChange:t=>R(t.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"phone",children:"Telefone *"}),e.jsx(W,{id:"phone",value:j,onChange:t=>A(t.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"email",children:"Email *"}),e.jsx(v,{id:"email",type:"email",placeholder:"seu@email.com",value:h,onChange:t=>k(t.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"password",children:"Senha *"}),e.jsx(v,{id:"password",type:"password",placeholder:"••••••••",value:f,onChange:t=>F(t.target.value),required:!0,className:"h-12"})]}),e.jsx(E,{type:"submit",className:"w-full",size:"lg",disabled:w||C,children:w||C?e.jsx(K,{className:"h-4 w-4 animate-spin mr-2"}):i?"Criar conta":"Entrar"})]}),e.jsx("div",{className:"text-center",children:e.jsx(E,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>U(!i),children:i?"Já tem uma conta? Faça login":"Não tem uma conta? Crie uma agora"})}),e.jsx(Q,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É o dono de uma loja? ",e.jsx($,{to:"/admin-auth",className:"text-primary hover:underline",children:"Acesse o painel de administração"})]})]})]})]})})};export{ne as default};
