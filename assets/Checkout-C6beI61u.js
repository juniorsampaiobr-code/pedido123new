import{u as le,j as e,a as Gr,b as Ee}from"./tanstack-C7aOFagJ.js";import{r as d,h as Vr,i as qr,k as Br,L as Re}from"./vendor-DjsPZZVP.js";import{c as zr,s as S,a9 as nr,aa as Me,ab as we,ac as Pe,ad as Kr,ae as Ur,aj as Zr,af as Qr,a as me,j as y,D as Ue,v as Ze,L as ue,w as Xr,x as Hr,a1 as ar,y as Jr,B as Z,C as Q,e as X,f as H,a0 as Ie,b as J,o as sr,n as V,aG as Yr,aH as Wr,u as et,r as Qe,W as te,X as Xe,Y as se,Z as oe,d as He,ag as rt,aI as tt,U as Je,aJ as nt,h as D,I as ie,aC as de,P as at,i as st,a4 as ye,a3 as ot,V as it,ah as ct,M as dt,T as lt,t as Ye}from"./index-BcN5eKCz.js";import{L as ut,g as We,c as er,Z as mt}from"./location-Dpak_A9e.js";import{c as or,R as ft,I as pt}from"./index-BwDGLjeq.js";import{u as ht}from"./index-C3WaO5Hu.js";import{S as rr}from"./separator-BqHkqPpc.js";import{A as xt}from"./arrow-left-BUIkyUuv.js";import{C as Se}from"./circle-alert-RSjmGjyO.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=zr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),yt=async()=>{const{data:r,error:a}=await S.from("restaurants").select("id").limit(1).single();if(a||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const n=r.id,{data:i,error:l}=await S.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",n).limit(1).single();if(l&&l.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${l.message}`);return(i==null?void 0:i.mercado_pago_public_key)||null},ir=()=>le({queryKey:["mercadoPagoPublicKey"],queryFn:yt,staleTime:1/0});var Le="Radio",[jt,cr]=nr(Le),[vt,wt]=jt(Le),dr=d.forwardRef((r,a)=>{const{__scopeRadio:n,name:i,checked:l=!1,required:h,disabled:v,value:o="on",onCheck:I,form:F,...N}=r,[E,L]=d.useState(null),_=Me(a,T=>L(T)),P=d.useRef(!1),R=E?F||!!E.closest("form"):!0;return e.jsxs(vt,{scope:n,checked:l,disabled:v,children:[e.jsx(we.button,{type:"button",role:"radio","aria-checked":l,"data-state":fr(l),"data-disabled":v?"":void 0,disabled:v,value:o,...N,ref:_,onClick:Pe(r.onClick,T=>{l||I==null||I(),R&&(P.current=T.isPropagationStopped(),P.current||T.stopPropagation())})}),R&&e.jsx(mr,{control:E,bubbles:!P.current,name:i,value:o,checked:l,required:h,disabled:v,form:F,style:{transform:"translateX(-100%)"}})]})});dr.displayName=Le;var lr="RadioIndicator",ur=d.forwardRef((r,a)=>{const{__scopeRadio:n,forceMount:i,...l}=r,h=wt(lr,n);return e.jsx(Kr,{present:i||h.checked,children:e.jsx(we.span,{"data-state":fr(h.checked),"data-disabled":h.disabled?"":void 0,...l,ref:a})})});ur.displayName=lr;var _t="RadioBubbleInput",mr=d.forwardRef(({__scopeRadio:r,control:a,checked:n,bubbles:i=!0,...l},h)=>{const v=d.useRef(null),o=Me(v,h),I=ht(n),F=Ur(a);return d.useEffect(()=>{const N=v.current;if(!N)return;const E=window.HTMLInputElement.prototype,_=Object.getOwnPropertyDescriptor(E,"checked").set;if(I!==n&&_){const P=new Event("click",{bubbles:i});_.call(N,n),N.dispatchEvent(P)}},[I,n,i]),e.jsx(we.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...l,tabIndex:-1,ref:o,style:{...l.style,...F,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});mr.displayName=_t;function fr(r){return r?"checked":"unchecked"}var bt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],_e="RadioGroup",[Nt,an]=nr(_e,[or,cr]),pr=or(),hr=cr(),[Ct,Et]=Nt(_e),xr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,name:i,defaultValue:l,value:h,required:v=!1,disabled:o=!1,orientation:I,dir:F,loop:N=!0,onValueChange:E,...L}=r,_=pr(n),P=Zr(F),[R,T]=Qr({prop:h,defaultProp:l??null,onChange:E,caller:_e});return e.jsx(Ct,{scope:n,name:i,required:v,disabled:o,value:R,onValueChange:T,children:e.jsx(ft,{asChild:!0,..._,orientation:I,dir:P,loop:N,children:e.jsx(we.div,{role:"radiogroup","aria-required":v,"aria-orientation":I,"data-disabled":o?"":void 0,dir:P,...L,ref:a})})})});xr.displayName=_e;var gr="RadioGroupItem",yr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,disabled:i,...l}=r,h=Et(gr,n),v=h.disabled||i,o=pr(n),I=hr(n),F=d.useRef(null),N=Me(a,F),E=h.value===l.value,L=d.useRef(!1);return d.useEffect(()=>{const _=R=>{bt.includes(R.key)&&(L.current=!0)},P=()=>L.current=!1;return document.addEventListener("keydown",_),document.addEventListener("keyup",P),()=>{document.removeEventListener("keydown",_),document.removeEventListener("keyup",P)}},[]),e.jsx(pt,{asChild:!0,...o,focusable:!v,active:E,children:e.jsx(dr,{disabled:v,required:h.required,checked:E,...I,...l,name:h.name,ref:N,onCheck:()=>h.onValueChange(l.value),onKeyDown:Pe(_=>{_.key==="Enter"&&_.preventDefault()}),onFocus:Pe(l.onFocus,()=>{var _;L.current&&((_=F.current)==null||_.click())})})})});yr.displayName=gr;var Rt="RadioGroupIndicator",jr=d.forwardRef((r,a)=>{const{__scopeRadioGroup:n,...i}=r,l=hr(n);return e.jsx(ur,{...l,...i,ref:a})});jr.displayName=Rt;var vr=xr,wr=yr,St=jr;const Fe=d.forwardRef(({className:r,...a},n)=>e.jsx(vr,{className:me("grid gap-2",r),...a,ref:n}));Fe.displayName=vr.displayName;const ve=d.forwardRef(({className:r,...a},n)=>e.jsx(wr,{ref:n,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(St,{className:"flex items-center justify-center",children:e.jsx(gt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ve.displayName=wr.displayName;var ke={};Object.defineProperty(ke,"__esModule",{value:!0});var _r=ke.loadMercadoPago=void 0;const br="https://sdk.mercadopago.com/js/v2",Pt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,tr="MercadoPago has already been initialized in your window, please remove the duplicate import",It="MercadoPago.js not available",Ft="Failed to load MercadoPago.js",Mt=()=>{for(var r=document.querySelectorAll(`script[src^="${br}"`),a=0;a<r.length;a++){var n=r[a];if(Pt.test(n.src))return n}return null},Lt=()=>{const r=document.createElement("script");r.src=br;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let je=null;const kt=()=>(je!==null||(je=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(tr),r(window.MercadoPago);return}try{let n=Mt();n?console.warn(tr):n||(n=Lt()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(It))}),n.addEventListener("error",()=>{a(new Error(Ft))})}catch(n){a(n);return}})),je);_r=ke.loadMercadoPago=kt;var Ot=function(r,a,n,i){function l(h){return h instanceof n?h:new n(function(v){v(h)})}return new(n||(n=Promise))(function(h,v){function o(N){try{F(i.next(N))}catch(E){v(E)}}function I(N){try{F(i.throw(N))}catch(E){v(E)}}function F(N){N.done?h(N.value):l(N.value).then(o,I)}F((i=i.apply(r,a||[])).next())})};class U{static getInstance(){return Ot(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield _r(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}U.publicKey=null;U.options={};U.instanceMercadoPago=void 0;U.loadedInstanceMercadoPago=!1;function At(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(i=>Object.prototype.hasOwnProperty.call(a,i)&&r[i]===a[i])}const Dt=(r,a)=>{const n=Object.assign(Object.assign({},a),{frontEndStack:"react"}),i=!At(U.options,n);(r!==U.publicKey||i)&&(U.publicKey=r,U.options=n,U.instanceMercadoPago=void 0)},Tt=({preferenceId:r,initPoint:a,onClose:n})=>{const{data:i,isLoading:l}=ir();return d.useEffect(()=>{if(i)try{Dt(i,{locale:"pt-BR"})}catch(h){console.error("Erro ao inicializar Mercado Pago:",h),y.error("Erro ao carregar o SDK do Mercado Pago."),n();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[i,n,a]),l||!i?e.jsx(Ue,{open:!0,onOpenChange:n,children:e.jsx(Ze,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(Ue,{open:!0,onOpenChange:n,children:e.jsxs(Ze,{className:"sm:max-w-[425px]",children:[e.jsxs(Xr,{children:[e.jsxs(Hr,{className:"flex items-center gap-2",children:[e.jsx(ar,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(Jr,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Z,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},$t=({latitude:r,longitude:a,address:n,className:i})=>{const l=d.useMemo(()=>[r,a],[r,a]),h=d.useMemo(()=>[r,a],[r,a]),v=d.useMemo(()=>`client-location-${r.toFixed(6)}-${a.toFixed(6)}`,[r,a]);return e.jsxs(Q,{className:me("w-full",i),children:[e.jsxs(X,{children:[e.jsxs(H,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(J,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(ut,{center:h,markerPosition:l,onMarkerDragEnd:()=>{},zoom:16},v)})})]})},Gt=sr({zip_code:V().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:V().min(1,"Rua é obrigatória."),number:V().min(1,"Número é obrigatório."),neighborhood:V().min(1,"Bairro é obrigatório."),city:V().min(1,"Cidade é obrigatória.")}),Vt=sr({name:V().min(1,"Nome é obrigatório."),phone:V().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:V().min(1,"CPF/CNPJ é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Yr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:V().optional(),payment_method_id:V().min(1,"Selecione um método de pagamento."),change_for:V().optional()}),qt=async r=>{const{data:a,error:n}=await S.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},Bt=async r=>{const{data:a,error:n}=await S.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return a},zt=async r=>{const{data:a,error:n}=await S.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return a},Kt=async r=>{const{data:a,error:n}=await S.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return a||null},sn=()=>{var Ve,qe,Be,ze,Ke;const r=Vr(),a=qr(),[n]=Br(),i=Gr(),{items:l,totalAmount:h,clearCart:v}=Wr(),{data:o,isLoading:I}=et(),{data:F}=ir(),[N,E]=d.useState(!1),[L,_]=d.useState(!1),[P,R]=d.useState(0),[T,G]=d.useState(null),[be,q]=d.useState(!0),[Y,fe]=d.useState(null),[Nr,Ne]=d.useState(!1),[Cr,Er]=d.useState(null),[Oe,Rr]=d.useState(null),[K,W]=d.useState(!1),Sr=(Ve=a.state)==null?void 0:Ve.restaurantId,Pr=n.get("restaurantId"),B=Sr||Pr;d.useEffect(()=>{console.log("LOG: Checkout - User Status:",o?`Logged in as ${o.email}`:"Anonymous")},[o]);const{data:x,isLoading:Ir,isError:Fr,error:Ae,refetch:Mr}=le({queryKey:["checkoutRestaurantData",B],queryFn:()=>qt(B),enabled:!!B,staleTime:1/0}),{data:ee,isLoading:Lr}=le({queryKey:["checkoutDeliveryZones",B],queryFn:()=>Bt(x.id),enabled:!!x,staleTime:1/0}),{data:ne,isLoading:kr}=le({queryKey:["checkoutPaymentMethods",B],queryFn:()=>zt(x.id),enabled:!!x,staleTime:1/0}),{data:g,isLoading:De,refetch:Ut}=le({queryKey:["checkoutCustomerData",o==null?void 0:o.id],queryFn:()=>Kt(o.id),enabled:!!o,staleTime:0}),pe=d.useMemo(()=>x!=null&&x.latitude&&(x!=null&&x.longitude)?[x.latitude,x.longitude]:null,[x]),Ce=d.useCallback(async(t,s,u,f,p,m,C)=>{const j=[30,45];if(x&&x.delivery_enabled===!1){const w=`${s}, ${u}, ${p}, ${f}, ${t}`;let A=null;if(m&&C)A={lat:m,lng:C};else{_(!0);const re=y.loading("Validando endereço para frete grátis...");A=await We(w),_(!1),y.dismiss(re)}if(!A)return R(0),G(null),q(!1),y.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(fe([A.lat,A.lng]),ee&&ee.length>0){const re=er([A.lat,A.lng],pe,ee);if(re)return R(0),G([re.minTime,re.maxTime]),q(!0),{coords:A,fee:0,time:[re.minTime,re.maxTime],isValid:!0}}return R(0),G(j),q(!0),{coords:A,fee:0,time:j,isValid:!0}}if(!x||!pe)return R(0),q(!0),G(j),{coords:null,fee:0,time:j,isValid:!0};const $=`${s}, ${u}, ${p}, ${f}, ${t}`;let O=null;if(m&&C)O={lat:m,lng:C};else{_(!0);const w=y.loading("Calculando taxa de entrega...");O=await We($),_(!1),y.dismiss(w)}if(!O)return R(0),G(null),q(!1),y.error("O endereço está errado ou incompleto, revise todos os campos e clique em salvar endereço."),{coords:null,fee:0,time:null,isValid:!1};if(fe([O.lat,O.lng]),ee&&ee.length>0){const w=er([O.lat,O.lng],pe,ee);return w?(R(w.fee),G([w.minTime,w.maxTime]),q(!0),{coords:O,fee:w.fee,time:[w.minTime,w.maxTime],isValid:!0}):(R(0),G(null),q(!1),y.error("Endereço fora da área de entrega."),{coords:O,fee:0,time:null,isValid:!1})}else return R(0),G(j),q(!0),{coords:O,fee:0,time:j,isValid:!0}},[x,pe,ee]),c=Qe({resolver:Ye(Vt),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),b=Qe({resolver:Ye(Gt),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),k=c.watch("delivery_option"),Or=c.watch("payment_method_id"),ae=ne==null?void 0:ne.find(t=>t.id===Or),he=(qe=ae==null?void 0:ae.name)==null?void 0:qe.includes("online"),ce=(Be=ae==null?void 0:ae.name)==null?void 0:Be.includes("Dinheiro"),z=h+P,M=b.watch(["zip_code","street","number","city","neighborhood"]);d.useEffect(()=>{const t=[15,30];k==="pickup"?(R(0),q(!0),W(!0),G(t)):(W(!1),G(null))},[k]),d.useEffect(()=>{if(g){let t="",s="",u="",f="",p="";if(g.address){const m=g.address.split(", ").map(C=>C.trim());m.length>=5?(t=m[0],s=m[1],u=m[2],f=m[3],p=m[4]):m.length>=4&&(t=m[0],u=m[1],f=m[2],p=m[3])}c.reset({...c.getValues(),name:g.name||"",phone:g.phone||"",cpf_cnpj:g.cpf_cnpj||"",change_for:""}),b.reset({zip_code:p,street:t,number:s,neighborhood:u,city:f}),g.address&&g.latitude&&g.longitude&&(fe([g.latitude,g.longitude]),W(!0),Ce(p,t,s,f,u,g.latitude,g.longitude))}else if(o&&!De){const t=o.user_metadata;c.reset({...c.getValues(),name:t.full_name||"",phone:t.phone||"",cpf_cnpj:t.cpf_cnpj||"",change_for:""})}},[g,c,o,De,b,Ce]);const xe=c.watch("change_for");d.useEffect(()=>{if(ce&&xe&&xe.trim()!==""){const t=xe.replace(",","."),s=parseFloat(t);isNaN(s)?c.setError("change_for",{message:"O troco deve ser um número válido."}):s<z?c.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)}).`}):c.clearErrors("change_for")}else c.clearErrors("change_for")},[ce,xe,z,c]);const ge=Ee({mutationFn:async t=>{var m;const u=(m=(await S.auth.getUser()).data.user)==null?void 0:m.id;if(!(g!=null&&g.id)&&!u)throw new Error("ID do cliente ou usuário não encontrado.");const f=`${t.street}, ${t.number}, ${t.neighborhood}, ${t.city}, ${t.zip_code}`,p={user_id:(o==null?void 0:o.id)||null,name:c.getValues("name"),phone:c.getValues("phone"),email:(o==null?void 0:o.email)||null,cpf_cnpj:c.getValues("cpf_cnpj")||null,address:f,latitude:t.lat,longitude:t.lng};if(g!=null&&g.id){const{data:C,error:j}=await S.from("customers").update(p).eq("id",g.id).select().single();if(j)throw j;return C}else if(u){const{data:C,error:j}=await S.from("customers").insert(p).select().single();if(j)throw j;return C}else return{id:"anonymous",user_id:null,name:p.name,phone:p.phone,email:p.email,address:f,created_at:"",updated_at:"",latitude:t.lat,longitude:t.lng,cpf_cnpj:p.cpf_cnpj}},onSuccess:(t,s)=>{t.id!=="anonymous"&&i.invalidateQueries({queryKey:["checkoutCustomerData"]}),R(s.fee),G(s.time),q(s.isValid),W(!0),fe([s.lat,s.lng]),y.success("Endereço salvo e taxa de entrega calculada!")},onError:t=>{y.error(`Erro ao salvar endereço: ${t.message}`),W(!1)}}),Ar=async()=>{if(k==="pickup")return;if(!await b.trigger()){y.error("Preencha todos os campos obrigatórios do endereço.");return}const s=b.getValues(),u=await Ce(s.zip_code,s.street,s.number,s.city,s.neighborhood);if(!u.isValid){W(!1);return}if(!u.coords){y.error("Não foi possível obter as coordenadas para salvar o endereço."),W(!1);return}ge.mutate({...s,lat:u.coords.lat,lng:u.coords.lng,fee:u.fee,time:u.time,isValid:u.isValid})},Te=Ee({mutationFn:async t=>{var m,C;(m=(await S.auth.getUser()).data.user)==null||m.id;const u=t.phone.replace(/\D/g,""),f=((C=t.cpf_cnpj)==null?void 0:C.replace(/\D/g,""))||null,p={user_id:(o==null?void 0:o.id)||null,name:t.name,phone:u,email:(o==null?void 0:o.email)||null,cpf_cnpj:f,address:k==="delivery"?`${M[1]}, ${M[2]}, ${M[4]}, ${M[3]}, ${M[0]}`:null,latitude:Y?Y[0]:null,longitude:Y?Y[1]:null};if(o)if(g){const{data:j,error:$}=await S.from("customers").update(p).eq("id",g.id).select().single();if($)throw $;return j}else{const{data:j,error:$}=await S.from("customers").insert(p).select().single();if($)throw $;return j}else{const{data:j,error:$}=await S.from("customers").insert(p).select().single();if($)throw $;return j}},onSuccess:()=>{i.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:t=>{y.error(`Erro ao salvar dados do cliente: ${t.message}`)}}),$e=Ee({mutationFn:async({customerId:t,data:s})=>{if(!x)throw new Error("Dados do restaurante não disponíveis.");let u=null;if(ce&&s.change_for&&s.change_for.trim()!==""){const w=s.change_for.replace(",","."),A=parseFloat(w);!isNaN(A)&&A>z&&(u=A)}let[f,p]=T||[null,null];if((k==="delivery"||k==="pickup")&&(!f||!p)){const w=k==="pickup"?[15,30]:[30,45];f=w[0],p=w[1]}console.log("LOG: Tempo de entrega salvo no pedido:",f,p);const m={restaurant_id:x.id,customer_id:t,status:he?"pending_payment":"pending",total_amount:z,delivery_fee:P,delivery_address:k==="delivery"?`${M[1]}, ${M[2]}, ${M[4]}, ${M[3]}, ${M[0]}`:null,notes:s.notes,payment_method_id:s.payment_method_id,change_for:u,min_delivery_time_minutes:f,max_delivery_time_minutes:p},{data:C,error:j}=await S.from("orders").insert(m).select("id").single();if(j)throw j;const $=l.map(w=>({order_id:C.id,product_id:w.product.id,quantity:parseFloat(w.quantity.toFixed(3)),unit_price:parseFloat(w.product.price.toFixed(2)),subtotal:parseFloat(w.subtotal.toFixed(2)),notes:w.notes})),{error:O}=await S.from("order_items").insert($);if(O)throw O;return C.id},onSuccess:t=>{i.invalidateQueries({queryKey:["orders"]})},onError:t=>{y.error(`Erro ao criar pedido: ${t.message}`)}}),Dr=async t=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",he),console.log("LOG: deliveryOption:",k),console.log("LOG: isAddressSaved: ",K),console.log("LOG: change_for data:",t.change_for),ce&&t.change_for&&t.change_for.trim()!==""){const f=t.change_for.replace(",","."),p=parseFloat(f);if(isNaN(p)){y.error("O troco deve ser um número válido.");return}if(p<z){c.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)}).`});return}}if(l.length===0){y.error("Seu carrinho está vazio."),r(`/menu/${B}`);return}if(k==="delivery"){if(!K){y.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!be){y.error("O endereço de entrega está fora da área de cobertura.");return}}let s;try{console.log("LOG: Criando/Atualizando cliente..."),s=(await Te.mutateAsync(t)).id,console.log("LOG: Cliente ID:",s)}catch(f){y.error(`Falha ao salvar cliente: ${f.message}`);return}let u;try{console.log("LOG: Criando pedido..."),u=await $e.mutateAsync({customerId:s,data:t}),console.log("LOG: Pedido ID:",u)}catch(f){y.error(`Falha ao criar pedido: ${f.message}`);return}he?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Tr(u,t)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),v(),r(`/order-success/${u}`,{replace:!0}))},Tr=async(t,s)=>{if(!x)return;const u=window.location.origin+window.location.pathname,f=l.map(m=>({name:m.product.name,price:m.product.price,quantity:m.quantity})),p=y.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:m,error:C}=await S.functions.invoke("create-payment-preference",{body:{orderId:t,items:f,totalAmount:z,restaurantName:x.name,clientUrl:u,customerEmail:(o==null?void 0:o.email)||"cliente@anonimo.com",customerCpfCnpj:s.cpf_cnpj}});if(C)throw C;const{init_point:j}=m;console.log("LOG: Preferência MP criada. init_point:",j),Er(t),Rr(j),Ne(!0),y.dismiss(p)}catch(m){console.error("Erro ao criar preferência MP:",m),y.dismiss(p),y.error(`Erro no pagamento online: ${m.message}`),Ne(!1)}},$r=async()=>{await S.auth.signOut(),y.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!B)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(se,{children:"Erro de Rastreamento"}),e.jsx(oe,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Re,{to:"/",children:e.jsx(Z,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(l.length===0)return d.useEffect(()=>{r(`/menu/${B}`)},[r,B]),e.jsx(He,{});if(Ir||Lr||kr||I)return e.jsx(He,{});if(Fr||!x)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(te,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx(se,{children:"Erro Crítico"}),e.jsx(oe,{children:Ae instanceof Error?Ae.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Z,{onClick:()=>Mr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(rt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ge=Te.isPending||$e.isPending||ge.isPending||L||k==="delivery"&&!K;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(tt,{isOpen:N,onClose:()=>E(!1),customer:g}),Nr&&Oe&&e.jsx(Tt,{preferenceId:Cr,initPoint:Oe,onClose:()=>Ne(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Re,{to:`/menu/${B}`,children:e.jsx(Z,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(xt,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:x.name})]})]}),o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Z,{variant:"outline",size:"sm",onClick:()=>E(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(Je,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:$r,children:[e.jsx(nt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(J,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:o?`Logado como ${o.email}. ${g?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:c.handleSubmit(Dr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(ie,{id:"name",...c.register("name")}),c.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"phone",children:"Telefone *"}),e.jsx(de,{name:"phone",control:c.control,render:({field:t})=>e.jsx(at,{id:"phone",...t})}),c.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(de,{name:"cpf_cnpj",control:c.control,render:({field:t})=>e.jsx(st,{id:"cpf_cnpj",...t})}),c.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(J,{children:e.jsx(de,{name:"delivery_option",control:c.control,render:({field:t})=>e.jsxs(Fe,{onValueChange:t.onChange,value:t.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(D,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(ye,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(D,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ie,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),k==="delivery"&&e.jsxs(Q,{className:me(!K&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(X,{children:[e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",K&&e.jsx(ot,{className:"h-5 w-5 text-green-500 ml-2"}),!K&&e.jsx(Se,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(J,{className:"space-y-4",children:[x.delivery_enabled===!1&&e.jsxs(te,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(se,{children:"Frete Grátis Ativo"}),e.jsx(oe,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),Ar()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(D,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(de,{name:"zip_code",control:b.control,render:({field:t})=>e.jsx(FormItem,{className:"flex-1 space-y-0",children:e.jsx(FormControl,{children:e.jsx(mt,{placeholder:"Digite o CEP",...t})})})}),b.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"street",children:"Rua *"}),e.jsx(ie,{id:"street",...b.register("street")}),b.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"number",children:"Número *"}),e.jsx(ie,{id:"number",...b.register("number")}),b.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(ie,{id:"neighborhood",...b.register("neighborhood")}),b.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"city",children:"Cidade *"}),e.jsx(ie,{id:"city",...b.register("city")}),b.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:b.formState.errors.city.message})]}),e.jsxs(Z,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ge.isPending||L,children:[ge.isPending||L?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(it,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),L&&e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(se,{children:"Calculando Taxa de Entrega..."})]}),K&&!L&&e.jsxs(e.Fragment,{children:[x.delivery_enabled!==!1&&!be&&e.jsxs(te,{variant:"destructive",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(se,{children:"Fora da Área de Entrega"}),e.jsx(oe,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(x.delivery_enabled===!1||be&&T)&&e.jsxs(te,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(se,{children:"Entrega Disponível"}),e.jsxs(oe,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P),". Tempo estimado: ",T?`${T[0]} - ${T[1]}`:"30 - 45"," minutos."]})]})]}),K&&Y&&e.jsx("div",{className:"mt-6",children:e.jsx($t,{latitude:Y[0],longitude:Y[1],address:`${M[1]}, ${M[2]} - ${M[4]}, ${M[3]}, ${M[0]}`})})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ar,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(J,{children:[e.jsx(de,{name:"payment_method_id",control:c.control,render:({field:t})=>e.jsx(Fe,{onValueChange:t.onChange,value:t.value,className:"space-y-3",children:ne==null?void 0:ne.map(s=>{var f;const u=((f=s.name)==null?void 0:f.includes("online"))&&!F;return e.jsx(D,{htmlFor:s.id,className:me("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",u&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{value:s.id,id:s.id,disabled:u}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description}),u&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},s.id)})})}),c.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:c.formState.errors.payment_method_id.message})]})]}),ce&&e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ct,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(ie,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z),...c.register("change_for")}),((ze=c.formState.errors.change_for)==null?void 0:ze.message)&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.change_for.message}),((Ke=c.formState.errors.change_for)==null?void 0:Ke.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:c.formState.errors.change_for.message})]})})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(dt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(lt,{id:"notes",...c.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(Q,{className:"shadow-lg",children:[e.jsx(X,{children:e.jsx(H,{className:"text-2xl",children:"Resumo"})}),e.jsxs(J,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:l.map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[t.quantity,"x ",t.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.subtotal)})]},t.product.id))}),e.jsx(rr,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(h)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(P)})]})]}),e.jsx(rr,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(z)})]}),e.jsx(Z,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ge,children:Ge?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):he?"Pagar e Finalizar":"Confirmar Pedido"}),k==="delivery"&&!K&&e.jsxs(te,{variant:"destructive",className:"mt-3",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx(oe,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Re,{to:`/menu/${x.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{sn as default};
