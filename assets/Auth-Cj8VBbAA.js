import{u as X,j as e}from"./tanstack-d4AvmB45.js";import{u as Y,h as Z,r as o}from"./vendor-CnEXr6gt.js";import{L as ee}from"./Logo-74uZbxE8.js";import{B as x}from"./button-CyBJbptL.js";import{L as d,I as j}from"./label-DR2AgQc4.js";import{C as ae,b as re,c as te,d as se,a as oe}from"./card-DTdQjeSz.js";import{b as ne,L as _,u as s}from"./index-BcD7V_bc.js";import{s as m}from"./client-D5i5GwB9.js";import{M as ie,P as ce}from"./PhoneInput-BtLSyFDP.js";import{u as le}from"./use-active-restaurant-id-BTmejl03.js";import{C as ue}from"./CpfCnpjInput-CQ7T85Dx.js";import{A as de}from"./arrow-left-TM3wgMl8.js";import"./shopping-cart-BIt0gL5y.js";import"./supabase-BZV_3FV3.js";const z=c=>c.replace(/\D/g,""),J=c=>c.replace(/\D/g,""),Fe=()=>{var D;const c=Y(),v=Z(),E=X(),[C,l]=o.useState(!1),[n,O]=o.useState(!1),[N,y]=o.useState(!1),[u,w]=o.useState(""),[h,T]=o.useState(""),[F,k]=o.useState(""),[b,Q]=o.useState(""),[P,V]=o.useState(""),[S,B]=o.useState(""),[me,I]=o.useState(null),[he,L]=o.useState(null),{data:q,isLoading:p}=le(),f=(D=v.state)==null?void 0:D.restaurantId,U=(a,t)=>{var g;const r=(g=v.state)==null?void 0:g.from,i=t||q;r==="/checkout"?(console.log("User logged in, redirecting to checkout."),c("/checkout",{replace:!0,state:{restaurantId:f}})):i?(console.log("User logged in, redirecting to specific menu:",i),c(`/menu/${i}`,{replace:!0})):(console.log("User logged in, no active restaurant found, redirecting to index."),c("/",{replace:!0}))};o.useEffect(()=>{if(p)return;const{data:{subscription:a}}=m.auth.onAuthStateChange((t,r)=>{L(r),I((r==null?void 0:r.user)??null),r!=null&&r.user&&U(r.user,f)});return m.auth.getSession().then(({data:{session:t}})=>{L(t),I((t==null?void 0:t.user)??null),t!=null&&t.user&&U(t.user,f)}),()=>a.unsubscribe()},[c,v.state,p,q,f]);const K=()=>{if(!b.trim())return s.error("O Nome Completo é obrigatório."),!1;if(z(P).length!==11)return s.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1;const t=J(S);return t.length!==11&&t.length!==14?(s.error("O CPF deve ter 11 dígitos ou CNPJ 14 dígitos."),!1):u.trim()?h.length<6?(s.error("A Senha deve ter pelo menos 6 caracteres."),!1):h!==F?(s.error("As senhas não coincidem. Por favor, digite novamente."),!1):!0:(s.error("O Email é obrigatório."),!1)},M=async a=>{var t;if(a.preventDefault(),l(!0),((t=v.state)==null?void 0:t.from)==="/checkout"&&!f){s.error("Erro: ID do restaurante de origem não encontrado."),l(!1);return}try{if(n){if(!K()){l(!1);return}const r=z(P),i=J(S),{data:g,error:A}=await m.rpc("check_registration_data",{phone_in:r,cpf_cnpj_in:i});if(A)console.error("Erro ao verificar dados:",A);else if(g){const{phone_exists:W,cpf_exists:G}=g;if(W){s.error("Este telefone já está cadastrado em outra conta."),l(!1);return}if(G){s.error("Este CPF/CNPJ já está cadastrado em outra conta."),l(!1);return}}const{data:H,error:R}=await m.auth.signUp({email:u,password:h,options:{data:{full_name:b,phone:r,cpf_cnpj:i}}});if(R)throw R;H.session?(s.success("Conta criada e login efetuado com sucesso!"),E.invalidateQueries({queryKey:["authStatus"]})):s.success("Conta criada! Verifique seu email para confirmar.")}else{const{error:r}=await m.auth.signInWithPassword({email:u,password:h});if(r)throw r;s.success("Login realizado com sucesso!"),E.invalidateQueries({queryKey:["authStatus"]})}}catch(r){r.message.includes("Email not confirmed")?s.error("Por favor, verifique seu e-mail para confirmar sua conta antes de fazer login."):s.error(r.message||"Erro ao processar autenticação")}finally{l(!1)}},$=async a=>{if(a.preventDefault(),!u.trim()){s.error("O Email é obrigatório para recuperação de senha.");return}l(!0);try{const r=`${window.location.origin+window.location.pathname}#/password-recovery`,{error:i}=await m.auth.resetPasswordForEmail(u,{redirectTo:r});if(i)throw i;s.success("Email de recuperação enviado!",{description:"Verifique sua caixa de entrada (e spam) para o link de redefinição de senha.",duration:8e3}),y(!1)}catch(t){s.error(t.message||"Erro ao enviar email de recuperação.")}finally{l(!1)}};return p?e.jsx(ne,{}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(ee,{className:"justify-center mb-4"})}),e.jsxs(ae,{className:"shadow-xl border-2",children:[e.jsxs(re,{className:"space-y-1",children:[e.jsx(te,{className:"text-2xl font-bold text-center",children:N?"Recuperar Senha":n?"Crie sua conta":"Acesse sua conta"}),e.jsx(se,{className:"text-center",children:N?"Digite seu email para receber o link de redefinição.":n?"Preencha os campos para começar":"Utilize seu email e senha para fazer login"})]}),e.jsx(oe,{className:"space-y-4",children:N?e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"email",children:"Email *"}),e.jsx(j,{id:"email",type:"email",placeholder:"seu@email.com",value:u,onChange:a=>w(a.target.value),required:!0,className:"h-12"})]}),e.jsxs(x,{type:"submit",className:"w-full",size:"lg",disabled:C,children:[C?e.jsx(_,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Enviar Link de Recuperação"]}),e.jsx("div",{className:"text-center",children:e.jsxs(x,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{y(!1),w("")},children:[e.jsx(de,{className:"h-4 w-4 mr-1"})," Voltar para o Login"]})})]}):e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(j,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:b,onChange:a=>Q(a.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"phone",children:"Telefone *"}),e.jsx(ce,{id:"phone",value:P,onChange:a=>V(a.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"cpfCnpj",children:"CPF/CNPJ *"}),e.jsx(ue,{id:"cpfCnpj",value:S,onChange:a=>B(a.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"CPF (11 dígitos) ou CNPJ (14 dígitos)."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"email",children:"Email *"}),e.jsx(j,{id:"email",type:"email",placeholder:"seu@email.com",value:u,onChange:a=>w(a.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"password",children:"Senha *"}),e.jsx(j,{id:"password",type:"password",placeholder:"••••••••",value:h,onChange:a=>T(a.target.value),required:!0,className:"h-12"})]}),n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"confirmPassword",children:"Confirmar Senha *"}),e.jsx(j,{id:"confirmPassword",type:"password",placeholder:"••••••••",value:F,onChange:a=>k(a.target.value),required:!0,className:"h-12"})]}),!n&&e.jsx("div",{className:"text-right",children:e.jsx(x,{variant:"link",type:"button",className:"p-0 h-auto text-sm text-muted-foreground hover:text-primary",onClick:()=>y(!0),children:"Esqueci minha senha"})}),e.jsx(x,{type:"submit",className:"w-full",size:"lg",disabled:C||p,children:C||p?e.jsx(_,{className:"h-4 w-4 animate-spin mr-2"}):n?"Criar conta":"Entrar"}),e.jsx("div",{className:"text-center",children:e.jsx(x,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>{O(!n),k("")},children:n?"Já tem uma conta? Faça login":"Não tem uma conta? Crie uma agora"})})]})})]})]})})};export{Fe as default};
