import{b as B,u as N,c as S,j as e}from"./tanstack-BMR5QDBT.js";import{o as T,p as q,c as A,s as $,u as C,t as E}from"./types-tCkPXq4V.js";import{c as P,A as U,o as k,p as K,q as Q,J as M,C as O,d as D,e as I,b as L,I as f,B as F,s as i,u as x}from"./index-CTrMiwSW.js";import{L as j}from"./label-qf3rzzRT.js";import{S as o}from"./skeleton-UuAz7LFR.js";import{j as V}from"./vendor-DjsPZZVP.js";import{C as H}from"./calendar-C6w5odf9.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=P("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),J=T({opening_balance:q(a=>String(a).replace(",","."),A.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo inicial não pode ser negativo."))}),z=T({closing_balance:q(a=>String(a).replace(",","."),A.number({invalid_type_error:"O saldo deve ser um número."}).min(0,"O saldo final não pode ser negativo.")),notes:$().optional()}),W=async a=>{const{data:{session:t}}=await i.auth.getSession();if(!t)throw new Error("Usuário não autenticado");const{data:s,error:c}=await i.from("cash_register").select("*").eq("restaurant_id",a).is("closed_at",null).order("opened_at",{ascending:!1}).limit(1).single();if(c&&c.code!=="PGRST116")throw new Error(`Erro ao buscar caixa: ${c.message}`);return s||null},X=async()=>0,y=({title:a,value:t,icon:s})=>e.jsxs(O,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:a}),e.jsx(s,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(L,{children:e.jsx("div",{className:"text-2xl font-bold",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)})})]}),oe=()=>{const{userRestaurantId:a}=V(),t=B(),{data:s,isLoading:c,isError:R,error:_}=N({queryKey:["currentCashier",a],queryFn:()=>W(a),enabled:!!a}),{data:w=0}=N({queryKey:["salesToday",s==null?void 0:s.opened_at],queryFn:X,enabled:!!s}),p=((s==null?void 0:s.opening_balance)||0)+w,u=!!s,l=C({resolver:E(J),defaultValues:{opening_balance:0}}),n=C({resolver:E(z),defaultValues:{closing_balance:p,notes:""},values:{closing_balance:p,notes:""}}),h=S({mutationFn:async r=>{const{data:{user:d}}=await i.auth.getUser();if(!a||!d)throw new Error("Dados de usuário ou restaurante indisponíveis.");const b={restaurant_id:a,opening_balance:r.opening_balance,opened_by:d.id},{error:m}=await i.from("cash_register").insert(b);if(m)throw new Error(m.message)},onSuccess:()=>{x.success("Caixa aberto com sucesso!"),t.invalidateQueries({queryKey:["currentCashier",a]}),l.reset({opening_balance:0})},onError:r=>{x.error(`Erro ao abrir caixa: ${r.message}`)}}),g=S({mutationFn:async r=>{const{data:{user:d}}=await i.auth.getUser();if(!(s!=null&&s.id)||!d)throw new Error("Nenhum caixa aberto para fechar.");const b={closed_at:new Date().toISOString(),closed_by:d.id,closing_balance:r.closing_balance,notes:r.notes},{error:m}=await i.from("cash_register").update(b).eq("id",s.id);if(m)throw new Error(m.message)},onSuccess:()=>{x.success("Caixa fechado com sucesso!"),t.invalidateQueries({queryKey:["currentCashier",a]}),n.reset()},onError:r=>{x.error(`Erro ao fechar caixa: ${r.message}`)}}),v=c||!a;return e.jsxs("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-6",children:[R&&e.jsxs(U,{variant:"destructive",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx(K,{children:"Erro ao carregar caixa"}),e.jsx(Q,{children:_ instanceof Error?_.message:"Ocorreu um erro desconhecido."})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:v?e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"h-28 w-full"}),e.jsx(o,{className:"h-28 w-full"}),e.jsx(o,{className:"h-28 w-full"})]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{title:"Saldo Inicial",value:(s==null?void 0:s.opening_balance)||0,icon:M}),e.jsx(y,{title:"Vendas Hoje",value:w,icon:G}),e.jsx(y,{title:"Saldo Atual",value:p,icon:H})]})}),e.jsxs(O,{className:"max-w-3xl mx-auto",children:[e.jsxs(D,{children:[e.jsx(I,{className:"text-2xl font-bold",children:"Controle de Caixa"}),e.jsxs("p",{className:`text-sm font-medium ${u?"text-green-600":"text-destructive"}`,children:["Caixa está ",u?"aberto":"fechado"]}),u&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Aberto em: ",new Date(s.opened_at).toLocaleString("pt-BR")]})]}),e.jsx(L,{children:v?e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{className:"h-10 w-1/3"}),e.jsx(o,{className:"h-12 w-full"}),e.jsx(o,{className:"h-12 w-full mt-4"})]}):u?e.jsxs("form",{onSubmit:n.handleSubmit(r=>g.mutate(r)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"closing_balance",children:"Saldo Final (R$)"}),e.jsx(f,{id:"closing_balance",type:"number",step:"0.01",...n.register("closing_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),n.formState.errors.closing_balance&&e.jsx("p",{className:"text-destructive text-sm",children:n.formState.errors.closing_balance.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"notes",children:"Observações (Opcional)"}),e.jsx(f,{id:"notes",...n.register("notes"),className:"h-12"})]}),e.jsx(F,{type:"submit",className:"w-full bg-destructive hover:bg-destructive/90 text-destructive-foreground h-12 text-lg",disabled:g.isPending||!a,children:g.isPending?"Fechando...":"Fechar Caixa"})]}):e.jsxs("form",{onSubmit:l.handleSubmit(r=>h.mutate(r)),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"opening_balance",children:"Saldo Inicial (R$)"}),e.jsx(f,{id:"opening_balance",type:"number",step:"0.01",...l.register("opening_balance",{valueAsNumber:!0}),className:"h-12 text-lg"}),l.formState.errors.opening_balance&&e.jsx("p",{className:"text-destructive text-sm",children:l.formState.errors.opening_balance.message})]}),e.jsx(F,{type:"submit",className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground h-12 text-lg",disabled:h.isPending||!a,children:h.isPending?"Abrindo...":"Abrir Caixa"})]})})]})]})};export{oe as default};
