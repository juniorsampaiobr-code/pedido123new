import{b as le,j as e,u as Zr,c as Re}from"./tanstack-d4AvmB45.js";import{r as l,u as Qr,h as Xr,j as Hr,L as Ie}from"./vendor-CnEXr6gt.js";import{s as R}from"./client-D5i5GwB9.js";import{c as Wr,d as dr,e as ke,P as we,f as Fe,g as Jr,h as Yr,i as et,a as me,u as b,L as ue,p as rt,b as We}from"./index-DMyph_DQ.js";import{L as tt,g as Je,c as Ye,Z as nt}from"./location-k0CFWBQ6.js";import{u as at}from"./use-auth-status-b07NBuTX.js";import{o as lr,s as V,e as st,u as er,C as de,t as rr}from"./types-DKlirIXB.js";import{B as K}from"./button-C8xpgqNg.js";import{C as U,b as Z,c as Q,a as X}from"./card-Dy94aFT3.js";import{L as D,I as ee}from"./label-DIpZSKju.js";import{T as ot}from"./textarea-CWZCZ5na.js";import{c as ur,R as it,I as ct}from"./index-CCaj-tUM.js";import{u as dt}from"./index-DrlxvCXN.js";import{u as lt}from"./index-KNP7Yozt.js";import{S as tr}from"./separator-BkBolso3.js";import{A as J,a as re,b as te}from"./alert-SntepiQa.js";import{P as ut,M as mt}from"./PhoneInput-CZf6c1d0.js";import{C as ft,L as pt}from"./CustomerProfileModal-dQ_dP-fm.js";import{D as nr,a as ar,b as ht,c as xt,d as gt}from"./dialog-CcQYStix.js";import{C as mr}from"./credit-card-BG2JKFc3.js";import{C as yt}from"./CpfCnpjInput-CchF6JZG.js";import{M as Me}from"./map-pin-BJxlEv3p.js";import{A as jt,a as vt,b as wt,c as bt,d as _t,e as Nt,g as Ct}from"./alert-dialog-DNpNQiDT.js";import{C as je}from"./circle-alert-BGEY6Ppy.js";import{F as sr,b as Et,d as St}from"./form-f5yWr_ef.js";import{T as or}from"./terminal-D0P8Toml.js";import{R as Pt}from"./pt-BR-DpIFcj9Z.js";import{A as Rt}from"./arrow-left-B-ym6e_w.js";import{U as ir}from"./user-BGoj-Eg2.js";import{T as ge}from"./truck-BVkCWj07.js";import{C as It}from"./circle-check-big-DTOWeAXh.js";import{S as Ft}from"./save-gjYmOM4J.js";import{D as Mt}from"./dollar-sign-BjeneyTx.js";import"./supabase-BZV_3FV3.js";import"./skeleton-CHQTfCME.js";import"./package-CZ6bUu-R.js";import"./check-DrGQUVkG.js";import"./circle-x-BvL403qa.js";import"./euro-CM8QNJfA.js";import"./format-BeKxgCCE.js";import"./index-4kqi8WOp.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=Wr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),kt=async r=>{const{data:a,error:n}=await R.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${n.message}`);return(a==null?void 0:a.mercado_pago_public_key)||null},fr=r=>le({queryKey:["mercadoPagoPublicKey",r],queryFn:()=>kt(r),enabled:!!r,staleTime:1/0});var De="Radio",[Dt,pr]=dr(De),[Ot,Tt]=Dt(De),hr=l.forwardRef((r,a)=>{const{__scopeRadio:n,name:u,checked:m=!1,required:h,disabled:w,value:c="on",onCheck:I,form:F,..._}=r,[g,k]=l.useState(null),N=ke(a,q=>k(q)),A=l.useRef(!1),O=g?F||!!g.closest("form"):!0;return e.jsxs(Ot,{scope:n,checked:m,disabled:w,children:[e.jsx(we.button,{type:"button",role:"radio","aria-checked":m,"data-state":jr(m),"data-disabled":w?"":void 0,disabled:w,value:c,..._,ref:N,onClick:Fe(r.onClick,q=>{m||I==null||I(),O&&(A.current=q.isPropagationStopped(),A.current||q.stopPropagation())})}),O&&e.jsx(yr,{control:g,bubbles:!A.current,name:u,value:c,checked:m,required:h,disabled:w,form:F,style:{transform:"translateX(-100%)"}})]})});hr.displayName=De;var xr="RadioIndicator",gr=l.forwardRef((r,a)=>{const{__scopeRadio:n,forceMount:u,...m}=r,h=Tt(xr,n);return e.jsx(Jr,{present:u||h.checked,children:e.jsx(we.span,{"data-state":jr(h.checked),"data-disabled":h.disabled?"":void 0,...m,ref:a})})});gr.displayName=xr;var Lt="RadioBubbleInput",yr=l.forwardRef(({__scopeRadio:r,control:a,checked:n,bubbles:u=!0,...m},h)=>{const w=l.useRef(null),c=ke(w,h),I=lt(n),F=Yr(a);return l.useEffect(()=>{const _=w.current;if(!_)return;const g=window.HTMLInputElement.prototype,N=Object.getOwnPropertyDescriptor(g,"checked").set;if(I!==n&&N){const A=new Event("click",{bubbles:u});N.call(_,n),_.dispatchEvent(A)}},[I,n,u]),e.jsx(we.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...m,tabIndex:-1,ref:c,style:{...m.style,...F,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});yr.displayName=Lt;function jr(r){return r?"checked":"unchecked"}var Vt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],be="RadioGroup",[$t,Yn]=dr(be,[ur,pr]),vr=ur(),wr=pr(),[qt,Gt]=$t(be),br=l.forwardRef((r,a)=>{const{__scopeRadioGroup:n,name:u,defaultValue:m,value:h,required:w=!1,disabled:c=!1,orientation:I,dir:F,loop:_=!0,onValueChange:g,...k}=r,N=vr(n),A=dt(F),[O,q]=et({prop:h,defaultProp:m??null,onChange:g,caller:be});return e.jsx(qt,{scope:n,name:u,required:w,disabled:c,value:O,onValueChange:q,children:e.jsx(it,{asChild:!0,...N,orientation:I,dir:A,loop:_,children:e.jsx(we.div,{role:"radiogroup","aria-required":w,"aria-orientation":I,"data-disabled":c?"":void 0,dir:A,...k,ref:a})})})});br.displayName=be;var _r="RadioGroupItem",Nr=l.forwardRef((r,a)=>{const{__scopeRadioGroup:n,disabled:u,...m}=r,h=Gt(_r,n),w=h.disabled||u,c=vr(n),I=wr(n),F=l.useRef(null),_=ke(a,F),g=h.value===m.value,k=l.useRef(!1);return l.useEffect(()=>{const N=O=>{Vt.includes(O.key)&&(k.current=!0)},A=()=>k.current=!1;return document.addEventListener("keydown",N),document.addEventListener("keyup",A),()=>{document.removeEventListener("keydown",N),document.removeEventListener("keyup",A)}},[]),e.jsx(ct,{asChild:!0,...c,focusable:!w,active:g,children:e.jsx(hr,{disabled:w,required:h.required,checked:g,...I,...m,name:h.name,ref:_,onCheck:()=>h.onValueChange(m.value),onKeyDown:Fe(N=>{N.key==="Enter"&&N.preventDefault()}),onFocus:Fe(m.onFocus,()=>{var N;k.current&&((N=F.current)==null||N.click())})})})});Nr.displayName=_r;var Bt="RadioGroupIndicator",Cr=l.forwardRef((r,a)=>{const{__scopeRadioGroup:n,...u}=r,m=wr(n);return e.jsx(gr,{...m,...u,ref:a})});Cr.displayName=Bt;var Er=br,Sr=Nr,zt=Cr;const Ae=l.forwardRef(({className:r,...a},n)=>e.jsx(Er,{className:me("grid gap-2",r),...a,ref:n}));Ae.displayName=Er.displayName;const ve=l.forwardRef(({className:r,...a},n)=>e.jsx(Sr,{ref:n,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(zt,{className:"flex items-center justify-center",children:e.jsx(At,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ve.displayName=Sr.displayName;var Oe={};Object.defineProperty(Oe,"__esModule",{value:!0});var Pr=Oe.loadMercadoPago=void 0;const Rr="https://sdk.mercadopago.com/js/v2",Kt=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,cr="MercadoPago has already been initialized in your window, please remove the duplicate import",Ut="MercadoPago.js not available",Zt="Failed to load MercadoPago.js",Qt=()=>{for(var r=document.querySelectorAll(`script[src^="${Rr}"`),a=0;a<r.length;a++){var n=r[a];if(Kt.test(n.src))return n}return null},Xt=()=>{const r=document.createElement("script");r.src=Rr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let ye=null;const Ht=()=>(ye!==null||(ye=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(cr),r(window.MercadoPago);return}try{let n=Qt();n?console.warn(cr):n||(n=Xt()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(Ut))}),n.addEventListener("error",()=>{a(new Error(Zt))})}catch(n){a(n);return}})),ye);Pr=Oe.loadMercadoPago=Ht;var Wt=function(r,a,n,u){function m(h){return h instanceof n?h:new n(function(w){w(h)})}return new(n||(n=Promise))(function(h,w){function c(_){try{F(u.next(_))}catch(g){w(g)}}function I(_){try{F(u.throw(_))}catch(g){w(g)}}function F(_){_.done?h(_.value):m(_.value).then(c,I)}F((u=u.apply(r,a||[])).next())})};class B{static getInstance(){return Wt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield Pr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}B.publicKey=null;B.options={};B.instanceMercadoPago=void 0;B.loadedInstanceMercadoPago=!1;function Jt(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(u=>Object.prototype.hasOwnProperty.call(a,u)&&r[u]===a[u])}const Yt=(r,a)=>{const n=Object.assign(Object.assign({},a),{frontEndStack:"react"}),u=!Jt(B.options,n);(r!==B.publicKey||u)&&(B.publicKey=r,B.options=n,B.instanceMercadoPago=void 0)},en=({preferenceId:r,initPoint:a,onClose:n})=>{const{data:u,isLoading:m}=fr();return l.useEffect(()=>{if(u)try{Yt(u,{locale:"pt-BR"})}catch(h){console.error("Erro ao inicializar Mercado Pago:",h),b.error("Erro ao carregar o SDK do Mercado Pago."),n();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[u,n,a]),m||!u?e.jsx(nr,{open:!0,onOpenChange:n,children:e.jsx(ar,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(nr,{open:!0,onOpenChange:n,children:e.jsxs(ar,{className:"sm:max-w-[425px]",children:[e.jsxs(ht,{children:[e.jsxs(xt,{className:"flex items-center gap-2",children:[e.jsx(mr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(gt,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(K,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},rn=({latitude:r,longitude:a,address:n,className:u})=>{const m=l.useMemo(()=>[r,a],[r,a]),h=l.useMemo(()=>[r,a],[r,a]);return e.jsxs(U,{className:me("w-full",u),children:[e.jsxs(Z,{children:[e.jsxs(Q,{className:"text-lg flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(X,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(tt,{center:h,markerPosition:m,onMarkerDragEnd:()=>{},zoom:16})})})]})},tn=({isOpen:r,onConfirm:a})=>e.jsx(jt,{open:r,children:e.jsxs(vt,{children:[e.jsxs(wt,{children:[e.jsxs(bt,{className:"flex items-center gap-2 text-primary",children:[e.jsx(je,{className:"h-6 w-6"}),"Atenção ao Pagamento Online!"]}),e.jsxs(_t,{children:["Você escolheu o pagamento online (Pix ou Cartão).",e.jsx("br",{}),e.jsx("br",{}),"Ao prosseguir, você será redirecionado para o checkout do Mercado Pago.",e.jsx("br",{}),e.jsx("br",{}),'**IMPORTANTE:** Se você escolher **PIX**, após o pagamento, você pode precisar clicar no botão **"Voltar ao site"** na tela do Mercado Pago para que seu pedido seja finalizado e rastreado corretamente.']})]}),e.jsx(Nt,{children:e.jsx(Ct,{onClick:a,className:"w-full",children:"Entendi e Continuar"})})]})}),nn=lr({zip_code:V().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:V().min(1,"Rua é obrigatória."),number:V().min(1,"Número é obrigatório."),neighborhood:V().min(1,"Bairro é obrigatório."),city:V().min(1,"Cidade é obrigatória.")}),an=lr({name:V().min(1,"Nome é obrigatório."),phone:V().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:V().min(1,"CPF/CNPJ é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:st(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:V().optional(),payment_method_id:V().min(1,"Selecione um método de pagamento."),change_for:V().optional()}),sn=async r=>{const{data:a,error:n}=await R.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},on=async r=>{const{data:a,error:n}=await R.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return a},cn=async r=>{const{data:a,error:n}=await R.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return a},dn=async r=>{const{data:a,error:n}=await R.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return a||null},ea=()=>{var Ue,Ze,Qe,Xe,He;const r=Qr(),a=Xr(),[n]=Hr(),u=Zr(),{items:m,totalAmount:h,clearCart:w}=rt(),{data:c,isLoading:I}=at(),[F]=l.useState((Ue=a.state)==null?void 0:Ue.restaurantId),_=n.get("restaurantId"),g=F||_,{data:k}=fr(g),[N,A]=l.useState(!1),[O,q]=l.useState(!1),[fe,pe]=l.useState(0),[ne,ae]=l.useState(null),[_e,se]=l.useState(!0),[H,Te]=l.useState(null),[Ir,Ne]=l.useState(!1),[Fr,Mr]=l.useState(null),[Le,Ar]=l.useState(null),[z,oe]=l.useState(!1),[kr,Ve]=l.useState(!1),[$e,Ce]=l.useState(null),{data:f,isLoading:Dr,isError:Or,error:qe,refetch:Tr}=le({queryKey:["checkoutRestaurantData",g],queryFn:()=>sn(g),enabled:!!g,staleTime:1/0}),{data:W,isLoading:Lr}=le({queryKey:["checkoutDeliveryZones",g],queryFn:()=>on(f.id),enabled:!!f,staleTime:1/0}),{data:G,isLoading:Vr}=le({queryKey:["checkoutPaymentMethods",g],queryFn:()=>cn(f.id),enabled:!!f,staleTime:1/0}),{data:y,isLoading:Ge,refetch:ln}=le({queryKey:["checkoutCustomerData",c==null?void 0:c.id],queryFn:()=>dn(c.id),enabled:!!c,staleTime:0}),ie=l.useMemo(()=>f!=null&&f.latitude&&(f!=null&&f.longitude)?[f.latitude,f.longitude]:null,[f]),Ee=l.useCallback(async(t,i,s,x,p,d,v)=>{const C=[30,45];if(f&&f.delivery_enabled===!1){const P=`${i}, ${s}, ${p}, ${x}, ${t}`;let L=null;if(d&&v?L={lat:d,lng:v}:L=await Je(P),!L)return{coords:null,fee:0,time:null,isValid:!1};if(W&&W.length>0&&ie){const Pe=Ye([L.lat,L.lng],ie,W);if(Pe)return{coords:L,fee:0,time:[Pe.minTime,Pe.maxTime],isValid:!0}}return{coords:L,fee:0,time:C,isValid:!0}}if(!f||!ie)return{coords:null,fee:0,time:C,isValid:!0};const E=`${i}, ${s}, ${p}, ${x}, ${t}`;let S=null;if(d&&v?S={lat:d,lng:v}:S=await Je(E),!S)return{coords:null,fee:0,time:null,isValid:!1};if(W&&W.length>0){const P=Ye([S.lat,S.lng],ie,W);return P?{coords:S,fee:P.fee,time:[P.minTime,P.maxTime],isValid:!0}:{coords:S,fee:0,time:null,isValid:!1}}else return{coords:S,fee:0,time:C,isValid:!0}},[f,ie,W]),o=er({resolver:rr(an),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),j=er({resolver:rr(nn),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),T=o.watch("delivery_option"),$r=o.watch("payment_method_id"),Y=G==null?void 0:G.find(t=>t.id===$r),Se=(Ze=Y==null?void 0:Y.name)==null?void 0:Ze.includes("online"),ce=(Qe=Y==null?void 0:Y.name)==null?void 0:Qe.includes("Dinheiro"),$=h+fe,M=j.watch(["zip_code","street","number","city","neighborhood"]);l.useEffect(()=>{if(y){let t="",i="",s="",x="",p="";if(y.address){const d=y.address.split(", ").map(v=>v.trim());d.length>=5?(t=d[0],i=d[1],s=d[2],x=d[3],p=d[4]):d.length>=4&&(t=d[0],s=d[1],x=d[2],p=d[3])}o.reset({...o.getValues(),name:y.name||"",phone:y.phone||"",cpf_cnpj:y.cpf_cnpj||"",change_for:""}),j.reset({zip_code:p,street:t,number:i,neighborhood:s,city:x}),y.address&&y.latitude&&y.longitude&&(Te([y.latitude,y.longitude]),oe(!0),Ee(p,t,i,x,s,y.latitude,y.longitude).then(d=>{d.isValid?(pe(d.fee),ae(d.time),se(!0)):(pe(0),ae(null),se(!1))}))}else if(c&&!Ge){const t=c.user_metadata;o.reset({...o.getValues(),name:t.full_name||"",phone:t.phone||"",cpf_cnpj:t.cpf_cnpj||"",change_for:""})}},[y,o,c,Ge,j,Ee]),l.useEffect(()=>{const t=[15,30];T==="pickup"?(pe(0),se(!0),oe(!0),ae(t)):(oe(!1),ae(null))},[T]);const he=o.watch("change_for");l.useEffect(()=>{if(ce&&he&&he.trim()!==""){const t=he.replace(",","."),i=parseFloat(t);isNaN(i)?o.setError("change_for",{message:"O troco deve ser um número válido."}):i<$?o.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($)}).`}):o.clearErrors("change_for")}else o.clearErrors("change_for")},[ce,he,$,o]);const xe=Re({mutationFn:async t=>{var C;q(!0);const i=`${t.street}, ${t.number}, ${t.neighborhood}, ${t.city}, ${t.zip_code}`,s=await Ee(t.zip_code,t.street,t.number,t.city,t.neighborhood);if(q(!1),!s.isValid)throw new Error((f==null?void 0:f.delivery_enabled)===!1?"O endereço está errado ou incompleto, revise todos os campos.":"Endereço fora da área de entrega.");if(!s.coords)throw new Error("Não foi possível obter as coordenadas para salvar o endereço.");const p=(C=(await R.auth.getUser()).data.user)==null?void 0:C.id;if(!(y!=null&&y.id)&&!p)return{customer:{id:"anonymous",user_id:null,name:o.getValues("name"),phone:o.getValues("phone"),email:(c==null?void 0:c.email)||null,address:i,created_at:"",updated_at:"",latitude:s.coords.lat,longitude:s.coords.lng,cpf_cnpj:o.getValues("cpf_cnpj")},feeResult:s};const d={user_id:(c==null?void 0:c.id)||null,name:o.getValues("name"),phone:o.getValues("phone"),email:(c==null?void 0:c.email)||null,cpf_cnpj:o.getValues("cpf_cnpj")||null,address:i,latitude:s.coords.lat,longitude:s.coords.lng};let v;if(y!=null&&y.id){const{data:E,error:S}=await R.from("customers").update(d).eq("id",y.id).select().single();if(S)throw S;v=E}else if(p){const{data:E,error:S}=await R.from("customers").insert(d).select().single();if(S)throw S;v=E}else throw new Error("Não foi possível identificar o cliente para salvar.");return{customer:v,feeResult:s}},onSuccess:t=>{const{customer:i,feeResult:s}=t;(i==null?void 0:i.id)!=="anonymous"&&u.invalidateQueries({queryKey:["checkoutCustomerData"]}),pe(s.fee),ae(s.time),se(s.isValid),oe(!0),Te([s.coords.lat,s.coords.lng]),b.success("Endereço salvo e taxa de entrega calculada!")},onError:t=>{b.error(`Erro ao salvar endereço: ${t.message}`),se(!1),oe(!1)}}),qr=async()=>{if(T==="pickup")return;if(!await j.trigger()){b.error("Preencha todos os campos obrigatórios do endereço.");return}const i=j.getValues(),s=b.loading("Salvando endereço e calculando taxa...");try{await xe.mutateAsync(i),b.dismiss(s)}catch{b.dismiss(s)}},Be=Re({mutationFn:async t=>{var d,v;(d=(await R.auth.getUser()).data.user)==null||d.id;const s=t.phone.replace(/\D/g,""),x=((v=t.cpf_cnpj)==null?void 0:v.replace(/\D/g,""))||null,p={user_id:(c==null?void 0:c.id)||null,name:t.name,phone:s,email:(c==null?void 0:c.email)||null,cpf_cnpj:x,address:T==="delivery"?`${M[1]}, ${M[2]}, ${M[4]}, ${M[3]}, ${M[0]}`:null,latitude:H?H[0]:null,longitude:H?H[1]:null};if(c)if(y){const{data:C,error:E}=await R.from("customers").update(p).eq("id",y.id).select().single();if(E)throw E;return C}else{const{data:C,error:E}=await R.from("customers").insert(p).select().single();if(E)throw E;return C}else{const{data:C,error:E}=await R.from("customers").insert(p).select().single();if(E)throw E;return C}},onSuccess:()=>{u.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:t=>{b.error(`Erro ao salvar dados do cliente: ${t.message}`)}}),ze=Re({mutationFn:async({customerId:t,data:i})=>{if(!f)throw new Error("Dados do restaurante não disponíveis.");let s=null;if(ce&&i.change_for&&i.change_for.trim()!==""){const P=i.change_for.replace(",","."),L=parseFloat(P);!isNaN(L)&&L>$&&(s=L)}let[x,p]=ne||[null,null];if((T==="delivery"||T==="pickup")&&(!x||!p)){const P=T==="pickup"?[15,30]:[30,45];x=P[0],p=P[1]}const d={restaurant_id:f.id,customer_id:t,status:Se?"pending_payment":"pending",total_amount:$,delivery_fee:fe,delivery_address:T==="delivery"?`${M[1]}, ${M[2]}, ${M[4]}, ${M[3]}, ${M[0]}`:null,notes:i.notes,payment_method_id:i.payment_method_id,change_for:s,min_delivery_time_minutes:x,max_delivery_time_minutes:p},{data:v,error:C}=await R.from("orders").insert(d).select("id").single();if(C)throw C;const E=m.map(P=>({order_id:v.id,product_id:P.product.id,quantity:parseFloat(P.quantity.toFixed(3)),unit_price:parseFloat(P.product.price.toFixed(2)),subtotal:parseFloat(P.subtotal.toFixed(2)),notes:P.notes})),{error:S}=await R.from("order_items").insert(E);if(S)throw S;return v.id},onSuccess:t=>{u.invalidateQueries({queryKey:["orders"]})},onError:t=>{b.error(`Erro ao criar pedido: ${t.message}`)}}),Gr=async t=>{if(ce&&t.change_for&&t.change_for.trim()!==""){const x=t.change_for.replace(",","."),p=parseFloat(x);if(isNaN(p)){b.error("O troco deve ser um número válido.");return}if(p<$){o.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($)}).`});return}}if(m.length===0){b.error("Seu carrinho está vazio."),r(`/menu/${g}`);return}if(T==="delivery"){if(!z){b.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!_e){b.error("O endereço de entrega está fora da área de cobertura.");return}}let i;try{i=(await Be.mutateAsync(t)).id}catch(x){b.error(`Falha ao salvar cliente: ${x.message}`);return}let s;try{s=await ze.mutateAsync({customerId:i,data:t})}catch(x){b.error(`Falha ao criar pedido: ${x.message}`);return}Se?await Br(s,t):(w(),r(`/order-success/${s}`,{replace:!0}))},Br=async(t,i)=>{if(!f)return;const s=window.location.origin+window.location.pathname,x=m.map(d=>({name:d.product.name,price:d.product.price,quantity:d.quantity})),p=b.loading("Preparando pagamento online...");try{const{data:d,error:v}=await R.functions.invoke("create-payment-preference",{body:{orderId:t,items:x,totalAmount:$,restaurantName:f.name,clientUrl:s,customerEmail:(c==null?void 0:c.email)||"cliente@anonimo.com",customerCpfCnpj:i.cpf_cnpj}});if(v)throw v;const{init_point:C}=d;Mr(t),Ar(C),Ne(!0),b.dismiss(p)}catch(d){b.dismiss(p),b.error(`Erro no pagamento online: ${d.message}`),Ne(!1)}},zr=async()=>{await R.auth.signOut(),b.success("Você saiu da sua conta."),r("/auth",{replace:!0})},Kr=(t,i,s)=>{i&&s?(Ce(t),Ve(!0)):(o.setValue("payment_method_id",t,{shouldValidate:!0}),Ce(null))},Ur=()=>{$e&&o.setValue("payment_method_id",$e,{shouldValidate:!0}),Ve(!1),Ce(null)};if(!g)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(J,{variant:"destructive",className:"max-w-lg",children:[e.jsx(or,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro de Rastreamento"}),e.jsx(te,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Ie,{to:"/",children:e.jsx(K,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(m.length===0)return l.useEffect(()=>{r(`/menu/${g}`)},[r,g]),e.jsx(We,{});if(Dr||Lr||Vr||I)return e.jsx(We,{});if(Or||!f)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(J,{variant:"destructive",className:"max-w-lg",children:[e.jsx(or,{className:"h-4 w-4"}),e.jsx(re,{children:"Erro Crítico"}),e.jsx(te,{children:qe instanceof Error?qe.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(K,{onClick:()=>Tr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ke=Be.isPending||ze.isPending||xe.isPending||O||T==="delivery"&&!z;return e.jsxs("div",{className:"min-h-screen bg-background py-4 sm:py-8 px-4 sm:px-8",children:[e.jsx(ft,{isOpen:N,onClose:()=>A(!1),customer:y}),e.jsx(tn,{isOpen:kr,onConfirm:Ur}),Ir&&Le&&e.jsx(en,{preferenceId:Fr,initPoint:Le,onClose:()=>Ne(!1)}),e.jsxs("div",{className:"w-full lg:max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ie,{to:`/menu/${g}`,children:e.jsx(K,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(Rt,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:f.name})]})]}),c&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(K,{variant:"outline",size:"sm",onClick:()=>A(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(ir,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(K,{variant:"outline",size:"sm",onClick:zr,children:[e.jsx(pt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(U,{children:[e.jsx(Z,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(ir,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(X,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:c?`Logado como ${c.email}. ${y?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx(sr,{...o,children:e.jsx("form",{onSubmit:o.handleSubmit(Gr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(ee,{id:"name",...o.register("name")}),o.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:o.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"phone",children:"Telefone *"}),e.jsx(de,{name:"phone",control:o.control,render:({field:t})=>e.jsx(ut,{id:"phone",...t})}),o.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:o.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(de,{name:"cpf_cnpj",control:o.control,render:({field:t})=>e.jsx(yt,{id:"cpf_cnpj",...t})}),o.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:o.formState.errors.cpf_cnpj.message})]})]})})})]})]}),e.jsxs(U,{children:[e.jsx(Z,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(X,{children:e.jsx(de,{name:"delivery_option",control:o.control,render:({field:t})=>e.jsxs(Ae,{onValueChange:t.onChange,value:t.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(D,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(ge,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(D,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ve,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Me,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),T==="delivery"&&e.jsxs(U,{className:me(!z&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(Z,{children:[e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",z&&e.jsx(It,{className:"h-5 w-5 text-green-500 ml-2"}),!z&&e.jsx(je,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(X,{className:"space-y-4",children:[f.delivery_enabled===!1&&e.jsxs(J,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx(re,{children:"Frete Grátis Ativo"}),e.jsx(te,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsx(sr,{...j,children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),qr()},id:"address-form-inner",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(D,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(de,{name:"zip_code",control:j.control,render:({field:t})=>e.jsx(Et,{className:"flex-1 space-y-0",children:e.jsx(St,{children:e.jsx(nt,{placeholder:"Digite o CEP",...t})})})}),j.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"street",children:"Rua *"}),e.jsx(ee,{id:"street",...j.register("street")}),j.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"number",children:"Número *"}),e.jsx(ee,{id:"number",...j.register("number")}),j.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(ee,{id:"neighborhood",...j.register("neighborhood")}),j.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"city",children:"Cidade *"}),e.jsx(ee,{id:"city",...j.register("city")}),j.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:j.formState.errors.city.message})]}),e.jsxs(K,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:xe.isPending||O,children:[xe.isPending||O?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ft,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]})}),O&&e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(re,{children:"Calculando Taxa de Entrega..."})]}),z&&!O&&e.jsxs(e.Fragment,{children:[f.delivery_enabled!==!1&&!_e&&e.jsxs(J,{variant:"destructive",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(re,{children:"Fora da Área de Entrega"}),e.jsx(te,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(f.delivery_enabled===!1||_e&&ne)&&e.jsxs(J,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx(re,{children:"Entrega Disponível"}),e.jsxs(te,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(fe),". Tempo estimado: ",ne?`${ne[0]} - ${ne[1]}`:"30 - 45"," minutos."]})]})]}),z&&H&&e.jsx("div",{className:"mt-6",children:e.jsx(rn,{latitude:H[0],longitude:H[1],address:`${M[1]}, ${M[2]} - ${M[4]}, ${M[3]}, ${M[0]}`})})]})]}),e.jsxs(U,{children:[e.jsx(Z,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(mr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(X,{children:[e.jsx(de,{name:"payment_method_id",control:o.control,render:({field:t})=>e.jsx(Ae,{onValueChange:i=>{var d;const s=G==null?void 0:G.find(v=>v.id===i),x=(d=s==null?void 0:s.name)==null?void 0:d.includes("online"),p=!!k&&k.trim()!=="";Kr(i,!!x,p)},value:t.value,className:"space-y-3",children:G==null?void 0:G.map(i=>{var d;const s=(d=i.name)==null?void 0:d.includes("online"),x=!!k&&k.trim()!=="",p=s&&!x;return e.jsx(D,{htmlFor:i.id,className:me("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",p&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{value:i.id,id:i.id,disabled:p}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.description}),p&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},i.id)})})}),o.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:o.formState.errors.payment_method_id.message})]})]}),ce&&e.jsxs(U,{children:[e.jsx(Z,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(Mt,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(X,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(ee,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($),...o.register("change_for")}),((Xe=o.formState.errors.change_for)==null?void 0:Xe.message)&&e.jsx("p",{className:"text-destructive text-sm",children:o.formState.errors.change_for.message}),((He=o.formState.errors.change_for)==null?void 0:He.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:o.formState.errors.change_for.message})]})})]}),e.jsxs(U,{children:[e.jsx(Z,{children:e.jsxs(Q,{className:"text-xl flex items-center gap-2",children:[e.jsx(mt,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(X,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(ot,{id:"notes",...o.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(U,{className:"shadow-lg",children:[e.jsx(Z,{children:e.jsx(Q,{className:"text-2xl",children:"Resumo"})}),e.jsxs(X,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[t.quantity,"x ",t.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.subtotal)})]},t.product.id))}),e.jsx(tr,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(h)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(fe)})]})]}),e.jsx(tr,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format($)})]}),e.jsx(K,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ke,children:Ke?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):Se?"Pagar e Finalizar":"Confirmar Pedido"}),T==="delivery"&&!z&&e.jsxs(J,{variant:"destructive",className:"mt-3",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(te,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Ie,{to:`/menu/${f.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{ea as default};
