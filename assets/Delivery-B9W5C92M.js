import{a as H,u as b,b as z,j as e}from"./tanstack-C7aOFagJ.js";import{o as A,j as U,G as x,k as p,ar as W,m as J,as as X,M as $,N as Y,O as Z,Q as T,B as v,C as ee,d as ae,e as re,b as se,F as ne,v as g,w as N,y as w,I as h,z as E,a as te,K as ie,t as oe,u as y,s as m}from"./index-BreDIA_g.js";import{S as le}from"./skeleton-D2mvQvNx.js";import{h as de,j as ce,r as _,L as me}from"./vendor-DjsPZZVP.js";import{S as ue}from"./switch-8ZucZr09.js";import{S as xe}from"./settings-G8DZOiLF.js";import{T as pe}from"./trash-2-FLSfVtbO.js";import"./supabase-BAEEEeUB.js";import"./index-C3WaO5Hu.js";const ve=A({id:U().optional(),max_distance_km:x(n=>String(n).replace(",","."),p.number({invalid_type_error:"Distância deve ser um número."}).positive("A distância máxima deve ser maior que zero.")),delivery_fee:x(n=>String(n).replace(",","."),p.number({invalid_type_error:"Taxa deve ser um número."}).min(0,"A taxa não pode ser negativa.")),min_delivery_time_minutes:x(n=>String(n).replace(",","."),p.number({invalid_type_error:"Tempo deve ser um número."}).min(0,"O tempo mínimo não pode ser negativo.")),center_latitude:x(n=>String(n).replace(",","."),p.number({invalid_type_error:"Latitude deve ser um número."}).optional().nullable()),center_longitude:x(n=>String(n).replace(",","."),p.number({invalid_type_error:"Longitude deve ser um número."}).optional().nullable())}),ge=A({zones:W(ve)}),he=async n=>{const{data:o,error:r}=await m.from("restaurants").select("*").eq("id",n).single();if(r)throw new Error(`Erro ao buscar dados do restaurante: ${r.message}`);if(!o)throw new Error("Nenhum restaurante encontrado.");return o},ye=async n=>{const{data:o,error:r}=await m.from("delivery_zones").select("*").eq("restaurant_id",n).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return o},_e=async n=>{const{data:o,error:r}=await m.from("restaurants").select("delivery_enabled").eq("id",n).single();return r?(console.warn("Erro ao buscar status de entrega:",r),!0):o.delivery_enabled??!0},fe=async(n,o)=>{const r={delivery_enabled:o},{error:s}=await m.from("restaurants").update(r).eq("id",n);if(s)throw new Error(`Erro ao atualizar status de entrega: ${s.message}`)},qe=()=>{const n=de(),o=H(),{userRestaurantId:r}=ce(),{data:s,isLoading:L}=b({queryKey:["restaurantDataForDelivery",r],queryFn:()=>he(r),enabled:!!r}),{data:f,isLoading:F,isError:R,error:C}=b({queryKey:["deliveryZones",r],queryFn:()=>ye(r),enabled:!!r}),{data:S,isLoading:I}=b({queryKey:["deliveryStatus",r],queryFn:()=>_e(r),enabled:!!r}),l=J({resolver:oe(ge),defaultValues:{zones:[]},mode:"onChange"}),{fields:K,append:k,remove:P,replace:D}=X({control:l.control,name:"zones"}),j=_.useMemo(()=>typeof(s==null?void 0:s.latitude)=="number"&&typeof(s==null?void 0:s.longitude)=="number"?[s.latitude,s.longitude]:[-23.55052,-46.633308],[s==null?void 0:s.latitude,s==null?void 0:s.longitude]),q=_.useCallback(t=>{const i=t.map(a=>({id:a.id,delivery_fee:a.delivery_fee,max_distance_km:a.max_distance_km&&typeof a.max_distance_km=="number"?a.max_distance_km:1,min_delivery_time_minutes:a.min_delivery_time_minutes??0,center_latitude:a.center_latitude,center_longitude:a.center_longitude}));D(i)},[D]);_.useEffect(()=>{f&&q(f)},[f,q]);const Q=z({mutationFn:({restaurantId:t,enabled:i})=>fe(t,i),onSuccess:(t,i)=>{o.invalidateQueries({queryKey:["deliveryStatus",i.restaurantId]}),o.invalidateQueries({queryKey:["checkoutRestaurantData"]}),y.success(`Taxas de entrega ${i.enabled?"ativadas":"desativadas"} com sucesso!`)},onError:t=>{y.error(`Erro ao atualizar status: ${t.message}`)}}),u=z({mutationFn:async t=>{if(!r)throw new Error("ID do restaurante não disponível.");const i=t.zones.map(c=>({restaurant_id:r,delivery_fee:c.delivery_fee,max_distance_km:c.max_distance_km,min_delivery_time_minutes:c.min_delivery_time_minutes,center_latitude:c.center_latitude,center_longitude:c.center_longitude,is_active:!0})),{error:a}=await m.from("delivery_zones").delete().eq("restaurant_id",r);if(a)throw new Error(`Erro ao limpar zonas antigas: ${a.message}`);const{error:d}=await m.from("delivery_zones").insert(i);if(d)throw new Error(`Erro ao inserir novas zonas: ${d.message}`)},onSuccess:()=>{y.success("Faixas de entrega salvas com sucesso!"),o.invalidateQueries({queryKey:["deliveryZones",r]}),o.invalidateQueries({queryKey:["checkoutDeliveryZones"]})},onError:t=>{y.error(`Erro ao salvar faixas de entrega: ${t.message}`)}}),M=t=>{u.mutate(t)},O=_.useCallback(()=>{k({delivery_fee:5,max_distance_km:10,min_delivery_time_minutes:30,center_latitude:j[0],center_longitude:j[1]})},[k,j]),V=(s==null?void 0:s.latitude)&&(s==null?void 0:s.longitude),B=t=>{r&&Q.mutate({restaurantId:r,enabled:t})};return F||L||I?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsx(le,{className:"h-96 w-full"})})}):R?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs($,{variant:"destructive",children:[e.jsx(Y,{className:"h-4 w-4"}),e.jsx(Z,{children:"Erro ao carregar zonas de entrega"}),e.jsx(T,{children:C instanceof Error?C.message:"Ocorreu um erro desconhecido."})]})})}):V?e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(ee,{children:[e.jsx(ae,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(re,{className:"text-2xl font-bold",children:"Taxa de Entrega Dinâmica"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina a taxa de entrega com base na distância máxima em quilômetros (km) a partir do centro do seu restaurante."})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-muted p-3 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Taxas de Entrega"}),e.jsx(ue,{checked:S??!0,onCheckedChange:B}),e.jsx("span",{className:"text-sm font-medium",children:S?"Ativadas":"Desativadas"})]})]})}),e.jsx(se,{children:e.jsx(ne,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(M),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-3 rounded-lg bg-muted/50 font-semibold text-sm text-muted-foreground",children:[e.jsx("div",{className:"col-span-1",children:"Distância (km)"}),e.jsx("div",{className:"col-span-1",children:"Valor da taxa (R$)"}),e.jsx("div",{className:"col-span-1",children:"Tempo mínimo (min)"}),e.jsx("div",{className:"col-span-1 text-center",children:"Ações"})]}),K.map((t,i)=>e.jsxs("div",{className:"grid grid-cols-4 gap-4 items-center p-4 border rounded-lg relative",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(g,{control:l.control,name:`zones.${i}.max_distance_km`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(h,{type:"number",step:"0.1",placeholder:"km",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>{const c=d.target.value,G=c===""?"":parseFloat(c.replace(",","."));a.onChange(G)}})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(g,{control:l.control,name:`zones.${i}.delivery_fee`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(h,{type:"number",step:"0.01",placeholder:"R$",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(g,{control:l.control,name:`zones.${i}.min_delivery_time_minutes`,render:({field:a})=>e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(h,{type:"number",placeholder:"min",className:"text-center",...a,value:a.value===void 0||a.value===null?"":String(a.value),onChange:d=>a.onChange(d.target.value)})}),e.jsx(E,{})]})})}),e.jsx("div",{className:"col-span-1 flex justify-center gap-2",children:e.jsx(v,{type:"button",variant:"destructive",size:"icon",onClick:()=>P(i),children:e.jsx(pe,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"hidden",children:[e.jsx(g,{control:l.control,name:`zones.${i}.center_latitude`,render:({field:a})=>e.jsx(h,{type:"hidden",...a})}),e.jsx(g,{control:l.control,name:`zones.${i}.center_longitude`,render:({field:a})=>e.jsx(h,{type:"hidden",...a})})]})]},t.id)),e.jsxs("div",{className:"mt-8 text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:"Atenção!"}),e.jsx("p",{className:"text-muted-foreground",children:"Com a taxa dinâmica habilitada, você pode adicionar cobrar a taxa de entrega de acordo com a distância do local de entrega. Exemplo: até 2km cobrar R$4,00."})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>n("/settings"),children:"Redefinir local da loja"}),e.jsxs(v,{type:"button",className:te("bg-pink-500 hover:bg-pink-600 text-white",u.isPending&&"opacity-70 cursor-not-allowed"),onClick:O,disabled:u.isPending||!r,children:[e.jsx(ie,{className:"mr-2 h-4 w-4"})," Adicionar taxa dinâmica"]}),e.jsx(v,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:u.isPending||!r,children:u.isPending?"Salvando...":"Salvar Configurações"})]})]})})})]})})}):e.jsx("main",{className:"flex-1 p-4 sm:p-6 md:p-8 space-y-8",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs($,{children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx(Z,{children:"Endereço Não Configurado"}),e.jsxs(T,{children:["Para configurar zonas de entrega baseadas em distância, primeiro configure o endereço e as coordenadas do seu restaurante na página de Configurações.",e.jsx(me,{to:"/settings",children:e.jsx(v,{variant:"link",className:"p-0 h-auto mt-2",children:"Ir para Configurações"})})]})]})})})};export{qe as default};
