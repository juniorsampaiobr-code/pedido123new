import{u as E,j as e,b as D,c as N}from"./tanstack-D8i8yNxB.js";import{i as q,h as k,r as v,L as j}from"./vendor-Dl0Wzy4_.js";import{c as T,L as A,A as O,o as L,d as F,e as I,b as K,a as M,B as h,u as i}from"./index-BvPQlImA.js";import{C as l,b as y,c as w,a as m}from"./card-DbRCQd53.js";import{s as g}from"./client-BmrnLCXS.js";import{S as C}from"./skeleton-DfIfCj5z.js";import{C as _}from"./clock-SfY_rsmR.js";import{C as S,a as Q}from"./circle-x-CS_CA59k.js";import{P as B}from"./package-B_Wl76XO.js";import{T as R}from"./truck-d4DObI1X.js";import{D as V}from"./dollar-sign-yelSN0mP.js";import{A as $,a as U,b as z,c as H,d as X,e as Z,f as G,g as J,h as W}from"./alert-dialog-ZkuSiQ4O.js";import{A as Y}from"./arrow-left-B3-13cLs.js";import"./supabase-A1WgB1xz.js";import"./index-kIXEvKcz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=T("Utensils",[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]]),re={pending:{label:"Pendente",icon:_,color:"bg-yellow-500",description:"Aguardando a confirmação do restaurante."},confirmed:{label:"Confirmado",icon:S,color:"bg-blue-500",description:"Seu pedido foi confirmado e será preparado em breve."},preparing:{label:"Em Preparação",icon:ee,color:"bg-orange-500",description:"O restaurante está preparando seus itens."},ready:{label:"Pronto",icon:B,color:"bg-green-500",description:"Seu pedido está pronto para retirada ou entrega."},delivering:{label:"Em Entrega",icon:R,color:"bg-indigo-500",description:"Seu pedido saiu para entrega e está a caminho."},delivered:{label:"Entregue",icon:S,color:"bg-primary",description:"Seu pedido foi entregue com sucesso!"},cancelled:{label:"Cancelado",icon:Q,color:"bg-destructive",description:"Seu pedido foi cancelado. Entre em contato com o restaurante se houver dúvidas."},pending_payment:{label:"Aguardando Pagamento",icon:V,color:"bg-gray-500",description:"Aguardando a confirmação do pagamento online."}},ae=async r=>{const{data:s,error:t}=await g.from("orders").select("*, customer:customers(name, phone)").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar detalhes do pedido: ${t.message}`);if(!s)throw new Error("Pedido não encontrado.");return s},se=({orderId:r})=>{var n;const{data:s,isLoading:t,isError:u,error:o}=E({queryKey:["orderStatus",r],queryFn:()=>ae(r),refetchInterval:1e4});if(t)return e.jsxs(l,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsxs(y,{className:"space-y-4",children:[e.jsx(A,{className:"h-16 w-16 text-primary mx-auto animate-spin"}),e.jsx(w,{className:"text-2xl font-bold",children:"Carregando Status..."})]}),e.jsxs(m,{children:[e.jsx(C,{className:"h-4 w-3/4 mx-auto mb-2"}),e.jsx(C,{className:"h-4 w-1/2 mx-auto"})]})]});if(u)return e.jsxs(O,{variant:"destructive",className:"w-full max-w-md mx-auto",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx(F,{children:"Erro ao rastrear pedido"}),e.jsx(I,{children:o instanceof Error?o.message:"Não foi possível carregar o status do pedido."})]});if(!s)return null;const c=s.status||"pending",d=re[c],p=s.created_at?new Date(s.created_at).getTime().toString().slice(-4):r.slice(-4),x=d.icon;return e.jsxs(l,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsxs(y,{className:"space-y-4",children:[e.jsx("div",{className:K("h-16 w-16 rounded-full mx-auto flex items-center justify-center text-white",d.color),children:e.jsx(x,{className:"h-8 w-8"})}),e.jsxs(w,{className:"text-3xl font-bold",children:["Pedido #",p]}),e.jsxs("p",{className:"text-lg font-semibold text-foreground",children:["Status: ",d.label]})]}),e.jsxs(m,{className:"space-y-6",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:d.description}),e.jsxs("div",{className:"text-left border-t pt-4 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Detalhes:"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Cliente: ",((n=s.customer)==null?void 0:n.name)||"N/A"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Total: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s.total_amount)]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Endereço: ",s.delivery_address||"Retirada no Local"]})]})]})]})},te=async r=>{const{data:s,error:t}=await g.from("orders").select("*").eq("id",r).limit(1).single();if(t)throw new Error(`Erro ao buscar detalhes do pedido: ${t.message}`);if(!s)throw new Error("Pedido não encontrado.");return s},we=()=>{const{orderId:r}=q(),[s]=k(),t=D(),{clearCart:u}=M(),o=s.get("status"),{data:c,isLoading:d}=E({queryKey:["customerOrderStatus",r],queryFn:()=>te(r),enabled:!!r,refetchInterval:1e4}),p=v.useMemo(()=>{if(!c)return!1;const a=c.status;return a==="pending"||a==="confirmed"||a==="preparing"||a==="ready"||a==="pending_payment"},[c]),x=N({mutationFn:async a=>{const{data:f,error:b}=await g.functions.invoke("confirm-payment",{body:{orderId:a}});if(b)throw new Error(b.message);return f},onSuccess:a=>{(a==null?void 0:a.status)==="approved"?i.success("Pagamento confirmado com sucesso!"):(a==null?void 0:a.status)==="pending"?i.info("Pagamento ainda pendente de confirmação.",{description:"Aguardando a compensação do Pix/Boleto."}):i.warning("Status de pagamento não aprovado.",{description:"Se você já pagou, aguarde alguns minutos ou entre em contato com o restaurante."}),t.invalidateQueries({queryKey:["orderStatus",r]}),t.invalidateQueries({queryKey:["customerOrderStatus",r]})},onError:a=>{i.error(`Falha na confirmação do pagamento: ${a.message}`)}}),n=N({mutationFn:async a=>{const{error:f}=await g.from("orders").update({status:"cancelled"}).eq("id",a);if(f)throw new Error(f.message)},onSuccess:()=>{i.success("Pedido cancelado com sucesso."),t.invalidateQueries({queryKey:["customerOrderStatus",r]}),t.invalidateQueries({queryKey:["orderStatus",r]}),t.invalidateQueries({queryKey:["orders"]})},onError:a=>{i.error(`Erro ao cancelar pedido: ${a.message}`)}}),P=()=>{r&&n.mutate(r)};return v.useEffect(()=>{r&&(u(),(o==="approved"||o==="pending")&&x.mutate(r))},[r,o,u]),r?e.jsxs("div",{className:"min-h-screen bg-background flex flex-col items-center justify-center p-4",children:[e.jsx("div",{className:"w-full max-w-md mb-6",children:e.jsx(j,{to:"/menu",children:e.jsxs(h,{variant:"ghost",className:"mb-4",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"})," Voltar ao Cardápio"]})})}),x.isPending&&(o==="approved"||o==="pending")&&e.jsx(l,{className:"w-full max-w-md text-center shadow-xl mb-6",children:e.jsxs(m,{className:"p-6 flex items-center justify-center",children:[e.jsx(A,{className:"h-5 w-5 mr-3 animate-spin"}),e.jsx("p",{className:"font-semibold",children:"Confirmando pagamento, por favor aguarde..."})]})}),e.jsx(se,{orderId:r}),e.jsx("div",{className:"w-full max-w-md mt-6",children:e.jsx(l,{className:"shadow-xl",children:e.jsxs(m,{className:"p-6 space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Você pode acompanhar o status do seu pedido nesta página."}),p&&e.jsxs($,{children:[e.jsx(U,{asChild:!0,children:e.jsx(h,{variant:"destructive",className:"w-full",disabled:n.isPending,children:n.isPending?"Cancelando...":"Cancelar Pedido"})}),e.jsxs(z,{children:[e.jsxs(H,{children:[e.jsx(X,{children:"Tem certeza que deseja cancelar o pedido?"}),e.jsx(Z,{children:"O cancelamento só é possível antes do pedido sair para entrega. Se o restaurante já estiver preparando, o cancelamento pode não ser aceito."})]}),e.jsxs(G,{children:[e.jsx(J,{children:"Não, manter pedido"}),e.jsx(W,{onClick:P,className:"bg-destructive hover:bg-destructive/90",disabled:n.isPending,children:"Sim, cancelar"})]})]})]}),e.jsx(j,{to:"/menu",children:e.jsx(h,{className:"w-full",variant:p?"outline":"default",children:"Fazer Novo Pedido"})})]})})})]}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs(l,{className:"w-full max-w-md text-center shadow-xl",children:[e.jsx(y,{children:e.jsx(w,{className:"text-2xl font-bold text-destructive",children:"Erro"})}),e.jsxs(m,{children:[e.jsx("p",{className:"text-muted-foreground",children:"ID do pedido não encontrado."}),e.jsx(j,{to:"/menu",children:e.jsx(h,{className:"mt-4",children:"Voltar ao Cardápio"})})]})]})})};export{we as default};
