import{u as ne,j as e,a as Or,b as we}from"./tanstack-C7aOFagJ.js";import{r as m,h as Lr,i as Fr,L as Ge}from"./vendor-DjsPZZVP.js";import{c as Ar,s as P,$ as He,a0 as Ee,a1 as pe,a2 as be,a3 as kr,a4 as Dr,a9 as Tr,a5 as Gr,a as fe,j as v,D as qe,q as Ve,L as ae,r as qr,v as Vr,w as $r,B as H,o as Ye,l as L,K as Br,av as zr,aw as Kr,u as Ur,p as $e,O as z,Q as Be,R as W,V as ee,d as ze,a6 as Zr,ax as Qr,U as Ke,ay as Xr,C as K,e as U,f as Z,b as Q,h as M,I as X,az as te,P as Hr,i as Yr,W as Ue,Y as Jr,aA as Wr,a7 as et,T as rt,t as Ze}from"./index-C4SUokmm.js";import{c as Je,R as tt,I as nt}from"./index-D1p3fHGr.js";import{u as at}from"./index-C3WaO5Hu.js";import{S as Qe}from"./separator-sPcbHFkS.js";import{Z as st}from"./ZipCodeInput-DHM6VsC2.js";import{C as We}from"./credit-card-CNMZ2vio.js";import{T as _e}from"./truck-DsMnGL5m.js";import{C as le}from"./circle-alert-DhjXZ8JA.js";import{M as ot}from"./mail-BtKmivA5.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=Ar("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),ct=async()=>{const{data:r,error:a}=await P.from("restaurants").select("id").limit(1).single();if(a||!r)return console.error("Failed to fetch restaurant ID for payment settings."),null;const t=r.id,{data:o,error:l}=await P.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",t).limit(1).single();if(l&&l.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${l.message}`);return(o==null?void 0:o.mercado_pago_public_key)||null},er=()=>ne({queryKey:["mercadoPagoPublicKey"],queryFn:ct,staleTime:1/0}),dt=(r,a,t,o)=>{const c=(t-r)*(Math.PI/180),s=(o-a)*(Math.PI/180),w=Math.sin(c/2)*Math.sin(c/2)+Math.cos(r*(Math.PI/180))*Math.cos(t*(Math.PI/180))*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w)))},lt=async r=>{const a=r.replace(/\s+/g," ").trim(),t=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,o=new AbortController,l=setTimeout(()=>o.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",t);const c=await fetch(t,{signal:o.signal});if(!c.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",c.status),null;const s=await c.json();if(s&&Array.isArray(s)&&s.length>0){const w=s[0],b=parseFloat(w.lat),R=parseFloat(w.lon);if(Number.isFinite(b)&&Number.isFinite(R))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[b,R]),{lat:b,lng:R}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(c){return c instanceof Error&&c.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",c),null}finally{clearTimeout(l)}},ut=(r,a,t)=>{const o=dt(a[0],a[1],r[0],r[1]),l=t.find(c=>o<=c.max_distance_km);if(l){const c=l.delivery_fee||0,s=l.min_delivery_time_minutes||0,w=s+15;return{fee:parseFloat(c.toFixed(2)),minTime:s,maxTime:w}}return null};var Ce="Radio",[mt,rr]=He(Ce),[ft,pt]=mt(Ce),tr=m.forwardRef((r,a)=>{const{__scopeRadio:t,name:o,checked:l=!1,required:c,disabled:s,value:w="on",onCheck:b,form:R,...N}=r,[_,F]=m.useState(null),E=Ee(a,O=>F(O)),S=m.useRef(!1),A=_?R||!!_.closest("form"):!0;return e.jsxs(ft,{scope:t,checked:l,disabled:s,children:[e.jsx(pe.button,{type:"button",role:"radio","aria-checked":l,"data-state":or(l),"data-disabled":s?"":void 0,disabled:s,value:w,...N,ref:E,onClick:be(r.onClick,O=>{l||b==null||b(),A&&(S.current=O.isPropagationStopped(),S.current||O.stopPropagation())})}),A&&e.jsx(sr,{control:_,bubbles:!S.current,name:o,value:w,checked:l,required:c,disabled:s,form:R,style:{transform:"translateX(-100%)"}})]})});tr.displayName=Ce;var nr="RadioIndicator",ar=m.forwardRef((r,a)=>{const{__scopeRadio:t,forceMount:o,...l}=r,c=pt(nr,t);return e.jsx(kr,{present:o||c.checked,children:e.jsx(pe.span,{"data-state":or(c.checked),"data-disabled":c.disabled?"":void 0,...l,ref:a})})});ar.displayName=nr;var ht="RadioBubbleInput",sr=m.forwardRef(({__scopeRadio:r,control:a,checked:t,bubbles:o=!0,...l},c)=>{const s=m.useRef(null),w=Ee(s,c),b=at(t),R=Dr(a);return m.useEffect(()=>{const N=s.current;if(!N)return;const _=window.HTMLInputElement.prototype,E=Object.getOwnPropertyDescriptor(_,"checked").set;if(b!==t&&E){const S=new Event("click",{bubbles:o});E.call(N,t),N.dispatchEvent(S)}},[b,t,o]),e.jsx(pe.input,{type:"radio","aria-hidden":!0,defaultChecked:t,...l,tabIndex:-1,ref:w,style:{...l.style,...R,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});sr.displayName=ht;function or(r){return r?"checked":"unchecked"}var xt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],he="RadioGroup",[gt,Jt]=He(he,[Je,rr]),ir=Je(),cr=rr(),[yt,jt]=gt(he),dr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,name:o,defaultValue:l,value:c,required:s=!1,disabled:w=!1,orientation:b,dir:R,loop:N=!0,onValueChange:_,...F}=r,E=ir(t),S=Tr(R),[A,O]=Gr({prop:c,defaultProp:l??null,onChange:_,caller:he});return e.jsx(yt,{scope:t,name:o,required:s,disabled:w,value:A,onValueChange:O,children:e.jsx(tt,{asChild:!0,...E,orientation:b,dir:S,loop:N,children:e.jsx(pe.div,{role:"radiogroup","aria-required":s,"aria-orientation":b,"data-disabled":w?"":void 0,dir:S,...F,ref:a})})})});dr.displayName=he;var lr="RadioGroupItem",ur=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,disabled:o,...l}=r,c=jt(lr,t),s=c.disabled||o,w=ir(t),b=cr(t),R=m.useRef(null),N=Ee(a,R),_=c.value===l.value,F=m.useRef(!1);return m.useEffect(()=>{const E=A=>{xt.includes(A.key)&&(F.current=!0)},S=()=>F.current=!1;return document.addEventListener("keydown",E),document.addEventListener("keyup",S),()=>{document.removeEventListener("keydown",E),document.removeEventListener("keyup",S)}},[]),e.jsx(nt,{asChild:!0,...w,focusable:!s,active:_,children:e.jsx(tr,{disabled:s,required:c.required,checked:_,...b,...l,name:c.name,ref:N,onCheck:()=>c.onValueChange(l.value),onKeyDown:be(E=>{E.key==="Enter"&&E.preventDefault()}),onFocus:be(l.onFocus,()=>{var E;F.current&&((E=R.current)==null||E.click())})})})});ur.displayName=lr;var vt="RadioGroupIndicator",mr=m.forwardRef((r,a)=>{const{__scopeRadioGroup:t,...o}=r,l=cr(t);return e.jsx(ar,{...l,...o,ref:a})});mr.displayName=vt;var fr=dr,pr=ur,wt=mr;const Ne=m.forwardRef(({className:r,...a},t)=>e.jsx(fr,{className:fe("grid gap-2",r),...a,ref:t}));Ne.displayName=fr.displayName;const me=m.forwardRef(({className:r,...a},t)=>e.jsx(pr,{ref:t,className:fe("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(wt,{className:"flex items-center justify-center",children:e.jsx(it,{className:"h-2.5 w-2.5 fill-current text-current"})})}));me.displayName=pr.displayName;var Re={};Object.defineProperty(Re,"__esModule",{value:!0});var hr=Re.loadMercadoPago=void 0;const xr="https://sdk.mercadopago.com/js/v2",_t=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,Xe="MercadoPago has already been initialized in your window, please remove the duplicate import",bt="MercadoPago.js not available",Nt="Failed to load MercadoPago.js",Et=()=>{for(var r=document.querySelectorAll(`script[src^="${xr}"`),a=0;a<r.length;a++){var t=r[a];if(_t.test(t.src))return t}return null},Ct=()=>{const r=document.createElement("script");r.src=xr;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(r),r};let ue=null;const Rt=()=>(ue!==null||(ue=new Promise((r,a)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(Xe),r(window.MercadoPago);return}try{let t=Et();t?console.warn(Xe):t||(t=Ct()),t.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):a(new Error(bt))}),t.addEventListener("error",()=>{a(new Error(Nt))})}catch(t){a(t);return}})),ue);hr=Re.loadMercadoPago=Rt;var St=function(r,a,t,o){function l(c){return c instanceof t?c:new t(function(s){s(c)})}return new(t||(t=Promise))(function(c,s){function w(N){try{R(o.next(N))}catch(_){s(_)}}function b(N){try{R(o.throw(N))}catch(_){s(_)}}function R(N){N.done?c(N.value):l(N.value).then(w,b)}R((o=o.apply(r,a||[])).next())})};class q{static getInstance(){return St(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield hr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}q.publicKey=null;q.options={};q.instanceMercadoPago=void 0;q.loadedInstanceMercadoPago=!1;function Pt(r,a){return Object.keys(r).length===Object.keys(a).length&&Object.keys(r).every(o=>Object.prototype.hasOwnProperty.call(a,o)&&r[o]===a[o])}const It=(r,a)=>{const t=Object.assign(Object.assign({},a),{frontEndStack:"react"}),o=!Pt(q.options,t);(r!==q.publicKey||o)&&(q.publicKey=r,q.options=t,q.instanceMercadoPago=void 0)},Mt=({preferenceId:r,initPoint:a,onClose:t})=>{const{data:o,isLoading:l}=er();return m.useEffect(()=>{if(o)try{It(o,{locale:"pt-BR"})}catch(c){console.error("Erro ao inicializar Mercado Pago:",c),v.error("Erro ao carregar o SDK do Mercado Pago."),t();return}a&&(console.log("Redirecionando para o Mercado Pago:",a),window.location.href=a)},[o,t,a]),l||!o?e.jsx(qe,{open:!0,onOpenChange:t,children:e.jsx(Ve,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ae,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(qe,{open:!0,onOpenChange:t,children:e.jsxs(Ve,{className:"sm:max-w-[425px]",children:[e.jsxs(qr,{children:[e.jsxs(Vr,{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx($r,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ae,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(H,{variant:"outline",onClick:t,children:"Cancelar e Voltar"})]})})},Ot=Ye({zip_code:L().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:L().min(1,"Rua é obrigatória."),number:L().min(1,"Número é obrigatório."),neighborhood:L().min(1,"Bairro é obrigatório."),city:L().min(1,"Cidade é obrigatória.")}),Lt=Ye({name:L().min(1,"Nome é obrigatório."),phone:L().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:L().email("Email inválido.").optional().or(Br("")),cpf_cnpj:L().optional().default("").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:zr(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:L().optional(),payment_method_id:L().min(1,"Selecione um método de pagamento."),change_for:L().optional()}),Ft=async r=>{const{data:a,error:t}=await P.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(t)throw new Error(`Erro ao buscar restaurante: ${t.message}`);if(!a)throw new Error("Restaurante não encontrado ou inativo.");return a},At=async r=>{const{data:a,error:t}=await P.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(t)throw new Error(`Erro ao buscar zonas de entrega: ${t.message}`);return a},kt=async r=>{const{data:a,error:t}=await P.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(t)throw new Error(`Erro ao buscar métodos de pagamento: ${t.message}`);return a},Dt=async r=>{const{data:a,error:t}=await P.from("customers").select("*").eq("user_id",r).limit(1).single();if(t&&t.code!=="PGRST116")throw new Error(t.message);return a||null},Wt=()=>{var Fe,Ae,ke,De,Te;const r=Lr(),a=Fr(),t=Or(),{items:o,totalAmount:l,clearCart:c}=Kr(),{data:s,isLoading:w}=Ur(),{data:b}=er(),[R,N]=m.useState(!1),[_,F]=m.useState(!1),[E,S]=m.useState(0),[A,O]=m.useState(null),[xe,$]=m.useState(!0),[se,gr]=m.useState(null),[yr,ge]=m.useState(!1),[jr,vr]=m.useState(null),[Se,wr]=m.useState(null),[G,B]=m.useState(!1),V=(Fe=a.state)==null?void 0:Fe.restaurantId;m.useEffect(()=>{console.log("LOG: Checkout - User Status:",s?`Logged in as ${s.email}`:"Anonymous")},[s]);const{data:g,isLoading:_r,isError:br,error:Pe,refetch:Nr}=ne({queryKey:["checkoutRestaurantData",V],queryFn:()=>Ft(V),enabled:!!V,staleTime:1/0}),{data:oe,isLoading:Er}=ne({queryKey:["checkoutDeliveryZones",V],queryFn:()=>At(g.id),enabled:!!g,staleTime:1/0}),{data:Y,isLoading:Cr}=ne({queryKey:["checkoutPaymentMethods",V],queryFn:()=>kt(g.id),enabled:!!g,staleTime:1/0}),{data:j,isLoading:Ie,refetch:Tt}=ne({queryKey:["checkoutCustomerData",s==null?void 0:s.id],queryFn:()=>Dt(s.id),enabled:!!s,staleTime:0}),ye=m.useMemo(()=>g!=null&&g.latitude&&(g!=null&&g.longitude)?[g.latitude,g.longitude]:null,[g]),je=m.useCallback(async(n,i,u,y,h,f)=>{if(!g||!ye||!g.delivery_enabled)return S(0),$(!0),O(null),{coords:null,fee:0,time:null,isValid:!0};const I=`${i}, ${u}, ${y}, ${n}`;let p=null;if(h&&f)p={lat:h,lng:f};else{F(!0);const x=v.loading("Calculando taxa de entrega...");p=await lt(I),F(!1),v.dismiss(x)}if(!p)return S(0),O(null),$(!1),v.error("Não foi possível encontrar o endereço. Verifique o CEP e o número."),{coords:null,fee:0,time:null,isValid:!1};if(gr([p.lat,p.lng]),oe&&oe.length>0){const x=ut([p.lat,p.lng],ye,oe);return x?(S(x.fee),O([x.minTime,x.maxTime]),$(!0),{coords:p,fee:x.fee,time:[x.minTime,x.maxTime],isValid:!0}):(S(0),O(null),$(!1),v.error("Endereço fora da área de entrega."),{coords:p,fee:0,time:null,isValid:!1})}else return S(0),O(null),$(!0),{coords:p,fee:0,time:null,isValid:!0}},[g,ye,oe]),d=$e({resolver:Ze(Lt),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),C=$e({resolver:Ze(Ot),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),k=d.watch("delivery_option"),Rr=d.watch("payment_method_id"),J=Y==null?void 0:Y.find(n=>n.id===Rr),ie=(Ae=J==null?void 0:J.name)==null?void 0:Ae.includes("online"),re=(ke=J==null?void 0:J.name)==null?void 0:ke.includes("Dinheiro"),D=l+E,T=C.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{k==="pickup"?(S(0),$(!0),B(!0)):B(!1)},[k]),m.useEffect(()=>{if(j){let n="",i="",u="",y="",h="";if(j.address){const f=j.address.split(", ").map(I=>I.trim());f.length>=5?(n=f[0],i=f[1],u=f[2],y=f[3],h=f[4]):f.length>=4&&(n=f[0],u=f[1],y=f[2],h=f[3])}d.reset({...d.getValues(),name:j.name||"",phone:j.phone||"",email:j.email||"",cpf_cnpj:j.cpf_cnpj||"",change_for:""}),C.reset({zip_code:h,street:n,number:i,neighborhood:u,city:y}),j.address&&j.latitude&&j.longitude&&(B(!0),je(h,n,i,y,j.latitude,j.longitude))}else if(s&&!Ie){const n=s.user_metadata;d.reset({...d.getValues(),name:n.full_name||"",phone:n.phone||"",email:s.email||"",cpf_cnpj:n.cpf_cnpj||"",change_for:""})}},[j,d,s,Ie,C,je]);const ce=d.watch("change_for");m.useEffect(()=>{if(re&&ce&&ce.trim()!==""){const n=ce.replace(",","."),i=parseFloat(n);isNaN(i)?d.setError("change_for",{message:"O troco deve ser um número válido."}):i<D?d.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)}).`}):d.clearErrors("change_for")}else d.clearErrors("change_for")},[re,ce,D,d]);const de=we({mutationFn:async n=>{var f;const u=(f=(await P.auth.getUser()).data.user)==null?void 0:f.id;if(!(j!=null&&j.id)&&!u)throw new Error("ID do cliente ou usuário não encontrado.");const y=`${n.street}, ${n.number}, ${n.neighborhood}, ${n.city}, ${n.zip_code}`,h={user_id:u||null,name:d.getValues("name"),phone:d.getValues("phone"),email:d.getValues("email")||null,cpf_cnpj:d.getValues("cpf_cnpj")||null,address:y,latitude:n.lat,longitude:n.lng};if(j!=null&&j.id){const{data:I,error:p}=await P.from("customers").update(h).eq("id",j.id).select().single();if(p)throw p;return I}else if(u){const{data:I,error:p}=await P.from("customers").insert(h).select().single();if(p)throw p;return I}else return{id:"anonymous",user_id:null,name:h.name,phone:h.phone,email:h.email,address:y,created_at:"",updated_at:"",latitude:n.lat,longitude:n.lng,cpf_cnpj:h.cpf_cnpj}},onSuccess:(n,i)=>{n.id!=="anonymous"&&t.invalidateQueries({queryKey:["checkoutCustomerData"]}),S(i.fee),O(i.time),$(i.isValid),B(!0),v.success("Endereço salvo e taxa de entrega calculada!")},onError:n=>{v.error(`Erro ao salvar endereço: ${n.message}`),B(!1)}}),Sr=async()=>{if(k==="pickup")return;if(!await C.trigger()){v.error("Preencha todos os campos obrigatórios do endereço.");return}const i=C.getValues(),u=await je(i.zip_code,i.street,i.number,i.city);if(!u.isValid){B(!1);return}if(!u.coords){v.error("Não foi possível obter as coordenadas para salvar o endereço."),B(!1);return}de.mutate({...i,lat:u.coords.lat,lng:u.coords.lng,fee:u.fee,time:u.time,isValid:u.isValid})},Me=we({mutationFn:async n=>{var f,I;(f=(await P.auth.getUser()).data.user)==null||f.id;const u=n.phone.replace(/\D/g,""),y=((I=n.cpf_cnpj)==null?void 0:I.replace(/\D/g,""))||null,h={user_id:(s==null?void 0:s.id)||null,name:n.name,phone:u,email:n.email||null,cpf_cnpj:y,address:k==="delivery"?`${T[1]}, ${T[2]}, ${T[3]}, ${T[4]}, ${T[0]}`:null,latitude:se?se[0]:null,longitude:se?se[1]:null};if(s)if(j){const{data:p,error:x}=await P.from("customers").update(h).eq("id",j.id).select().single();if(x)throw x;return p}else{const{data:p,error:x}=await P.from("customers").insert(h).select().single();if(x)throw x;return p}else{const{data:p,error:x}=await P.from("customers").insert(h).select().single();if(x)throw x;return p}},onSuccess:()=>{t.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:n=>{v.error(`Erro ao salvar dados do cliente: ${n.message}`)}}),Oe=we({mutationFn:async({customerId:n,data:i})=>{if(!g)throw new Error("Dados do restaurante não disponíveis.");let u=null;if(re&&i.change_for&&i.change_for.trim()!==""){const x=i.change_for.replace(",","."),ve=parseFloat(x);!isNaN(ve)&&ve>D&&(u=ve)}const y={restaurant_id:g.id,customer_id:n,status:ie?"pending_payment":"pending",total_amount:D,delivery_fee:E,delivery_address:k==="delivery"?`${T[1]}, ${T[2]}, ${T[3]}, ${T[4]}, ${T[0]}`:null,notes:i.notes,payment_method_id:i.payment_method_id,change_for:u},{data:h,error:f}=await P.from("orders").insert(y).select("id").single();if(f)throw f;const I=o.map(x=>({order_id:h.id,product_id:x.product.id,quantity:x.quantity,unit_price:x.product.price,subtotal:x.subtotal,notes:x.notes})),{error:p}=await P.from("order_items").insert(I);if(p)throw p;return h.id},onSuccess:n=>{t.invalidateQueries({queryKey:["orders"]})},onError:n=>{v.error(`Erro ao criar pedido: ${n.message}`)}}),Pr=async n=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",ie),console.log("LOG: deliveryOption:",k),console.log("LOG: isAddressSaved:",G),console.log("LOG: change_for data:",n.change_for),re&&n.change_for&&n.change_for.trim()!==""){const y=n.change_for.replace(",","."),h=parseFloat(y);if(isNaN(h)){v.error("O troco deve ser um número válido.");return}if(h<D){v.error(`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)}).`);return}}if(o.length===0){v.error("Seu carrinho está vazio."),r("/menu");return}if(k==="delivery"){if(!G){v.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!xe){v.error("O endereço de entrega está fora da área de cobertura.");return}}let i;try{console.log("LOG: Criando/Atualizando cliente..."),i=(await Me.mutateAsync(n)).id,console.log("LOG: Cliente ID:",i)}catch(y){v.error(`Falha ao salvar cliente: ${y.message}`);return}let u;try{console.log("LOG: Criando pedido..."),u=await Oe.mutateAsync({customerId:i,data:n}),console.log("LOG: Pedido ID:",u)}catch(y){v.error(`Falha ao criar pedido: ${y.message}`);return}ie?(console.log("LOG: Iniciando checkout Mercado Pago..."),await Ir(u,n)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),c(),r(`/order-success/${u}`,{replace:!0}))},Ir=async(n,i)=>{if(!g)return;const u=window.location.origin+window.location.pathname,y=o.map(f=>({name:f.product.name,price:f.product.price,quantity:f.quantity})),h=v.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:f,error:I}=await P.functions.invoke("create-payment-preference",{body:{orderId:n,items:y,totalAmount:D,restaurantName:g.name,clientUrl:u,customerEmail:i.email||(s==null?void 0:s.email)||"cliente@anonimo.com",customerCpfCnpj:i.cpf_cnpj}});if(I)throw I;const{init_point:p}=f;console.log("LOG: Preferência MP criada. init_point:",p),vr(n),wr(p),ge(!0),v.dismiss(h)}catch(f){console.error("Erro ao criar preferência MP:",f),v.dismiss(h),v.error(`Erro no pagamento online: ${f.message}`),ge(!1)}},Mr=async()=>{await P.auth.signOut(),v.success("Você saiu da sua conta."),r("/auth",{replace:!0})};if(!V)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro de Rastreamento"}),e.jsx(ee,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Ge,{to:"/",children:e.jsx(H,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(o.length===0)return m.useEffect(()=>{r(`/menu/${V}`)},[r,V]),e.jsx(ze,{});if(_r||Er||Cr||w)return e.jsx(ze,{});if(br||!g)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(z,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx(W,{children:"Erro Crítico"}),e.jsx(ee,{children:Pe instanceof Error?Pe.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(H,{onClick:()=>Nr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Zr,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Le=Me.isPending||Oe.isPending||de.isPending||_||k==="delivery"&&!G;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(Qr,{isOpen:R,onClose:()=>N(!1),customer:j}),yr&&Se&&e.jsx(Mt,{preferenceId:jr,initPoint:Se,onClose:()=>ge(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:g.name})]}),s&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{variant:"outline",size:"icon",onClick:()=>N(!0),"aria-label":"Meu Perfil",children:e.jsx(Ke,{className:"h-4 w-4"})}),e.jsxs(H,{variant:"outline",size:"sm",onClick:Mr,children:[e.jsx(Xr,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(Q,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:s?`Logado como ${s.email}. ${j?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:d.handleSubmit(Pr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(X,{id:"name",...d.register("name")}),d.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"phone",children:"Telefone *"}),e.jsx(te,{name:"phone",control:d.control,render:({field:n})=>e.jsx(Hr,{id:"phone",...n})}),d.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(X,{id:"email",type:"email",...d.register("email")}),d.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(te,{name:"cpf_cnpj",control:d.control,render:({field:n})=>e.jsx(Yr,{id:"cpf_cnpj",...n})}),d.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(_e,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(Q,{children:e.jsx(te,{name:"delivery_option",control:d.control,render:({field:n})=>e.jsxs(Ne,{onValueChange:n.onChange,value:n.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(M,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(me,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(_e,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(M,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(me,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ue,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),k==="delivery"&&e.jsxs(K,{className:fe(!G&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(U,{children:[e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ue,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",G&&e.jsx(Jr,{className:"h-5 w-5 text-green-500 ml-2"}),!G&&e.jsx(le,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(Q,{className:"space-y-4",children:[!g.delivery_enabled&&e.jsxs(z,{variant:"destructive",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(W,{children:"Entrega Desativada"}),e.jsx(ee,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),Sr()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(M,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(te,{name:"zip_code",control:C.control,render:({field:n})=>e.jsx(st,{id:"zip_code",...n})}),C.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"street",children:"Rua *"}),e.jsx(X,{id:"street",...C.register("street")}),C.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"number",children:"Número *"}),e.jsx(X,{id:"number",...C.register("number")}),C.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(X,{id:"neighborhood",...C.register("neighborhood")}),C.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"city",children:"Cidade *"}),e.jsx(X,{id:"city",...C.register("city")}),C.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.city.message})]}),e.jsxs(H,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:de.isPending||_||!g.delivery_enabled,children:[de.isPending||_?e.jsx(ae,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Wr,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),_&&e.jsxs(z,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 animate-spin"}),e.jsx(W,{children:"Calculando Taxa de Entrega..."})]}),!xe&&G&&!_&&e.jsxs(z,{variant:"destructive",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(W,{children:"Fora da Área de Entrega"}),e.jsx(ee,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),A&&xe&&G&&!_&&e.jsxs(z,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(W,{children:"Entrega Disponível"}),e.jsxs(ee,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(E),". Tempo estimado: ",A[0]," - ",A[1]," minutos."]})]})]})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(We,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(Q,{children:[e.jsx(te,{name:"payment_method_id",control:d.control,render:({field:n})=>e.jsx(Ne,{onValueChange:n.onChange,value:n.value,className:"space-y-3",children:Y==null?void 0:Y.map(i=>{var y;const u=((y=i.name)==null?void 0:y.includes("online"))&&!b;return e.jsx(M,{htmlFor:i.id,className:fe("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",u&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(me,{value:i.id,id:i.id,disabled:u}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.description}),u&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},i.id)})})}),d.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:d.formState.errors.payment_method_id.message})]})]}),re&&e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(et,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(X,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D),...d.register("change_for")}),((De=d.formState.errors.change_for)==null?void 0:De.message)&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message}),((Te=d.formState.errors.change_for)==null?void 0:Te.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:d.formState.errors.change_for.message})]})})]}),e.jsxs(K,{children:[e.jsx(U,{children:e.jsxs(Z,{className:"text-xl flex items-center gap-2",children:[e.jsx(ot,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(rt,{id:"notes",...d.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(K,{className:"shadow-lg",children:[e.jsx(U,{children:e.jsx(Z,{className:"text-2xl",children:"Resumo"})}),e.jsxs(Q,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:o.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[n.quantity,"x ",n.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.subtotal)})]},n.product.id))}),e.jsx(Qe,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(l)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(E)})]})]}),e.jsx(Qe,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(D)})]}),e.jsx(H,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Le,children:Le?e.jsx(ae,{className:"h-5 w-5 animate-spin mr-2"}):ie?"Pagar e Finalizar":"Confirmar Pedido"}),k==="delivery"&&!G&&e.jsxs(z,{variant:"destructive",className:"mt-3",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(ee,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Ge,{to:`/menu/${g.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{Wt as default};
