import{j as e,b as Ba,u as ce,c as Oa}from"./tanstack-D8i8yNxB.js";import{r as l,R as He,u as qa,h as Da,L as Ga}from"./vendor-Dl0Wzy4_.js";import{o as Ka,s as k,l as Ua,e as Za,c as Ue,p as Ja,n as Ha,Z as q,u as Qa,t as Wa}from"./types-BCrSgEF3.js";import{s as M}from"./client-BmrnLCXS.js";import{c as Se,f as Ie,g as ge,P as Z,i as fe,h as Qe,l as Xa,m as We,b as ne,n as Ya,k as es,a as Xe,u as b,v as as,L as Re}from"./index-C4Eg2tvQ.js";import{B as te}from"./button-BW99l6kQ.js";import{C as de,b as ue,c as me,a as pe}from"./card-BvlpLdVB.js";import{I as A}from"./label-BbwgUudI.js";import{c as Ye,R as ss,I as rs,a as ts,C as os}from"./index-BP7pj9GL.js";import{u as ns}from"./index-BB_oiUC3.js";import{u as is}from"./index-PuW-_iwo.js";import{S as oe}from"./separator-CTLJoo-S.js";import{T as ls}from"./textarea-AvO4Eu6x.js";import{A as X,a as Y,b as ee}from"./alert-CJGKnspM.js";import{F as cs,b as S,c as N,a as P,e as I,d as W}from"./form-B2ncfozs.js";import{Z as ds,L as us}from"./ZipCodeInput-wAluiY8b.js";import{S as ms}from"./shopping-cart-wovu2_Yn.js";import{T as Ze}from"./terminal-BWdWVibU.js";import{A as ps}from"./arrow-left-BNhU4iAW.js";import{T as Je}from"./truck-rxjszpgX.js";import{S as ea,a as hs}from"./store-T-olCGHZ.js";import{M as Ee}from"./map-pin-E_TTYJWP.js";import{C as aa}from"./credit-card-CO2VuYTc.js";import{P as fs}from"./package-BMQeK7pp.js";import{D as xs}from"./dollar-sign-Bl3Tl_5P.js";import"./supabase-A1WgB1xz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=Se("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ys=Se("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const js=Se("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var Fe="Radio",[vs,sa]=Ie(Fe),[bs,Ns]=vs(Fe),ra=l.forwardRef((r,a)=>{const{__scopeRadio:o,name:i,checked:n=!1,required:c,disabled:d,value:p="on",onCheck:g,form:x,...j}=r,[C,w]=l.useState(null),f=ge(a,$=>w($)),y=l.useRef(!1),v=C?x||!!C.closest("form"):!0;return e.jsxs(bs,{scope:o,checked:n,disabled:d,children:[e.jsx(Z.button,{type:"button",role:"radio","aria-checked":n,"data-state":ia(n),"data-disabled":d?"":void 0,disabled:d,value:p,...j,ref:f,onClick:fe(r.onClick,$=>{n||g==null||g(),v&&(y.current=$.isPropagationStopped(),y.current||$.stopPropagation())})}),v&&e.jsx(na,{control:C,bubbles:!y.current,name:i,value:p,checked:n,required:c,disabled:d,form:x,style:{transform:"translateX(-100%)"}})]})});ra.displayName=Fe;var ta="RadioIndicator",oa=l.forwardRef((r,a)=>{const{__scopeRadio:o,forceMount:i,...n}=r,c=Ns(ta,o);return e.jsx(Qe,{present:i||c.checked,children:e.jsx(Z.span,{"data-state":ia(c.checked),"data-disabled":c.disabled?"":void 0,...n,ref:a})})});oa.displayName=ta;var Cs="RadioBubbleInput",na=l.forwardRef(({__scopeRadio:r,control:a,checked:o,bubbles:i=!0,...n},c)=>{const d=l.useRef(null),p=ge(d,c),g=is(o),x=Xa(a);return l.useEffect(()=>{const j=d.current;if(!j)return;const C=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(C,"checked").set;if(g!==o&&f){const y=new Event("click",{bubbles:i});f.call(j,o),j.dispatchEvent(y)}},[g,o,i]),e.jsx(Z.input,{type:"radio","aria-hidden":!0,defaultChecked:o,...n,tabIndex:-1,ref:p,style:{...n.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});na.displayName=Cs;function ia(r){return r?"checked":"unchecked"}var ws=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ye="RadioGroup",[_s,wr]=Ie(ye,[Ye,sa]),la=Ye(),ca=sa(),[Rs,Es]=_s(ye),da=l.forwardRef((r,a)=>{const{__scopeRadioGroup:o,name:i,defaultValue:n,value:c,required:d=!1,disabled:p=!1,orientation:g,dir:x,loop:j=!0,onValueChange:C,...w}=r,f=la(o),y=ns(x),[v,$]=We({prop:c,defaultProp:n??null,onChange:C,caller:ye});return e.jsx(Rs,{scope:o,name:i,required:d,disabled:p,value:v,onValueChange:$,children:e.jsx(ss,{asChild:!0,...f,orientation:g,dir:y,loop:j,children:e.jsx(Z.div,{role:"radiogroup","aria-required":d,"aria-orientation":g,"data-disabled":p?"":void 0,dir:y,...w,ref:a})})})});da.displayName=ye;var ua="RadioGroupItem",ma=l.forwardRef((r,a)=>{const{__scopeRadioGroup:o,disabled:i,...n}=r,c=Es(ua,o),d=c.disabled||i,p=la(o),g=ca(o),x=l.useRef(null),j=ge(a,x),C=c.value===n.value,w=l.useRef(!1);return l.useEffect(()=>{const f=v=>{ws.includes(v.key)&&(w.current=!0)},y=()=>w.current=!1;return document.addEventListener("keydown",f),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",f),document.removeEventListener("keyup",y)}},[]),e.jsx(rs,{asChild:!0,...p,focusable:!d,active:C,children:e.jsx(ra,{disabled:d,required:c.required,checked:C,...g,...n,name:c.name,ref:j,onCheck:()=>c.onValueChange(n.value),onKeyDown:fe(f=>{f.key==="Enter"&&f.preventDefault()}),onFocus:fe(n.onFocus,()=>{var f;w.current&&((f=x.current)==null||f.click())})})})});ma.displayName=ua;var Ps="RadioGroupIndicator",pa=l.forwardRef((r,a)=>{const{__scopeRadioGroup:o,...i}=r,n=ca(o);return e.jsx(oa,{...n,...i,ref:a})});pa.displayName=Ps;var ha=da,fa=ma,Ss=pa;const Pe=l.forwardRef(({className:r,...a},o)=>e.jsx(ha,{className:ne("grid gap-2",r),...a,ref:o}));Pe.displayName=ha.displayName;const he=l.forwardRef(({className:r,...a},o)=>e.jsx(fa,{ref:o,className:ne("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...a,children:e.jsx(Ss,{className:"flex items-center justify-center",children:e.jsx(gs,{className:"h-2.5 w-2.5 fill-current text-current"})})}));he.displayName=fa.displayName;const Is=r=>{let a=r.replace(/\D/g,"");return a.length>11&&(a=a.slice(0,11)),a.length>0&&(a=`(${a}`),a.length>3&&(a=`${a.slice(0,3)}) ${a.slice(3)}`),a.length>10&&(a=`${a.slice(0,10)}-${a.slice(10)}`),a},xa=He.forwardRef(({className:r,value:a,onChange:o,...i},n)=>{const c=d=>{const p=d.target.value,g=Is(p),x={...d,target:{...d.target,value:g}};o(x)};return e.jsx(A,{ref:n,type:"tel",className:ne("w-full",r),placeholder:"(99) 99999-9999",value:a,onChange:c,...i})});xa.displayName="PhoneInput";const Fs=r=>{let a=r.replace(/\D/g,"");return a.length>14&&(a=a.slice(0,14)),a.length<=11?(a.length>9&&(a=`${a.slice(0,9)}-${a.slice(9)}`),a.length>6&&(a=`${a.slice(0,6)}.${a.slice(6)}`),a.length>3&&(a=`${a.slice(0,3)}.${a.slice(3)}`),a):(a.length>12&&(a=`${a.slice(0,12)}-${a.slice(12)}`),a.length>8&&(a=`${a.slice(0,8)}/${a.slice(8)}`),a.length>5&&(a=`${a.slice(0,5)}.${a.slice(5)}`),a.length>2&&(a=`${a.slice(0,2)}.${a.slice(2)}`),a)},ga=He.forwardRef(({className:r,value:a,onChange:o,...i},n)=>{const c=d=>{const p=d.target.value,g=Fs(p),x={...d,target:{...d.target,value:g}};o(x)};return e.jsx(A,{ref:n,type:"tel",className:ne("w-full",r),placeholder:"CPF ou CNPJ",value:a,onChange:c,maxLength:18,...i})});ga.displayName="CpfCnpjInput";const ks=(r,a,o,i)=>{const c=(o-r)*(Math.PI/180),d=(i-a)*(Math.PI/180),p=Math.sin(c/2)*Math.sin(c/2)+Math.cos(r*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))},Vs=async r=>{const a=r.replace(/\s+/g," ").trim(),o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`;try{const i=await fetch(o);if(!i.ok)return console.warn("Geocodificação falhou: Resposta da API não OK.",i.status),null;const n=await i.json();if(n&&n.length>0){const c=parseFloat(n[0].lat),d=parseFloat(n[0].lon);if(!isNaN(c)&&!isNaN(d))return[c,d]}return console.warn("Geocodificação falhou para o endereço:",a,"Nenhum resultado encontrado ou coordenadas inválidas."),null}catch(i){return console.error("Erro durante a geocodificação:",i),null}},Ls=(r,a,o)=>{const i=ks(a[0],a[1],r[0],r[1]),n=o.find(c=>i<=c.max_distance_km);if(n){const c=n.delivery_fee||0,d=n.min_delivery_time_minutes||0,p=d+15;return{fee:parseFloat(c.toFixed(2)),minTime:d,maxTime:p}}return null};var je="Collapsible",[$s,_r]=Ie(je),[Ts,ke]=$s(je),ya=l.forwardRef((r,a)=>{const{__scopeCollapsible:o,open:i,defaultOpen:n,disabled:c,onOpenChange:d,...p}=r,[g,x]=We({prop:i,defaultProp:n??!1,onChange:d,caller:je});return e.jsx(Ts,{scope:o,disabled:c,contentId:Ya(),open:g,onOpenToggle:l.useCallback(()=>x(j=>!j),[x]),children:e.jsx(Z.div,{"data-state":Le(g),"data-disabled":c?"":void 0,...p,ref:a})})});ya.displayName=je;var ja="CollapsibleTrigger",va=l.forwardRef((r,a)=>{const{__scopeCollapsible:o,...i}=r,n=ke(ja,o);return e.jsx(Z.button,{type:"button","aria-controls":n.contentId,"aria-expanded":n.open||!1,"data-state":Le(n.open),"data-disabled":n.disabled?"":void 0,disabled:n.disabled,...i,ref:a,onClick:fe(r.onClick,n.onOpenToggle)})});va.displayName=ja;var Ve="CollapsibleContent",ba=l.forwardRef((r,a)=>{const{forceMount:o,...i}=r,n=ke(Ve,r.__scopeCollapsible);return e.jsx(Qe,{present:o||n.open,children:({present:c})=>e.jsx(As,{...i,ref:a,present:c})})});ba.displayName=Ve;var As=l.forwardRef((r,a)=>{const{__scopeCollapsible:o,present:i,children:n,...c}=r,d=ke(Ve,o),[p,g]=l.useState(i),x=l.useRef(null),j=ge(a,x),C=l.useRef(0),w=C.current,f=l.useRef(0),y=f.current,v=d.open||p,$=l.useRef(v),F=l.useRef(void 0);return l.useEffect(()=>{const _=requestAnimationFrame(()=>$.current=!1);return()=>cancelAnimationFrame(_)},[]),es(()=>{const _=x.current;if(_){F.current=F.current||{transitionDuration:_.style.transitionDuration,animationName:_.style.animationName},_.style.transitionDuration="0s",_.style.animationName="none";const D=_.getBoundingClientRect();C.current=D.height,f.current=D.width,$.current||(_.style.transitionDuration=F.current.transitionDuration,_.style.animationName=F.current.animationName),g(i)}},[d.open,i]),e.jsx(Z.div,{"data-state":Le(d.open),"data-disabled":d.disabled?"":void 0,id:d.contentId,hidden:!v,...c,ref:j,style:{"--radix-collapsible-content-height":w?`${w}px`:void 0,"--radix-collapsible-content-width":y?`${y}px`:void 0,...r.style},children:v&&n})});function Le(r){return r?"open":"closed"}var Ms=ya;const zs=Ms,Bs=va,Os=ba,qs=()=>{const{items:r,subtotal:a,deliveryFee:o,total:i,totalItems:n}=Xe(),[c,d]=l.useState(!1);return n===0?null:e.jsxs(zs,{open:c,onOpenChange:d,className:"lg:hidden sticky top-0 z-40 bg-card border-b shadow-md",children:[e.jsx(Bs,{asChild:!0,children:e.jsxs("div",{className:"flex justify-between items-center p-4 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ms,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"font-semibold text-lg",children:["Seu Pedido (",n," ",n===1?"item":"itens",")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i)}),c?e.jsx(ts,{className:"h-5 w-5"}):e.jsx(os,{className:"h-5 w-5"})]})]})}),e.jsxs(Os,{className:"p-4 pt-0",children:[e.jsx(oe,{className:"mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:r.map(p=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[p.quantity,"x ",p.name,p.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",p.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(p.price*p.quantity)})]},p.id))}),e.jsx(oe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:o>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o):"Grátis"})]})]}),e.jsx(oe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(i)})]})]})]})]})},Na=r=>r.replace(/\D/g,""),Ca=r=>r.replace(/\D/g,""),xe=r=>r.replace(/\D/g,""),Ds=Ka({name:k().min(1,"Nome é obrigatório."),phone:k().min(1,"Telefone é obrigatório.").transform(Na).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos (incluindo DDD)."}),email:k().email("Email inválido.").optional().or(Ua("")),delivery_option:Za(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),street:k().optional().default(""),number:k().optional().default(""),complement:k().optional().default(""),neighborhood:k().optional().default(""),city:k().optional().default(""),zip_code:k().optional().default("").transform(Ca).refine(r=>r.length===8||r.length===0,{message:"CEP inválido. Deve conter 8 dígitos."}),latitude:Ue.number().optional().nullable(),longitude:Ue.number().optional().nullable(),payment_method_id:k().min(1,"Selecione uma forma de pagamento."),notes:k().optional(),cpf_cnpj:k().optional().default("").transform(xe).refine(r=>r.length===0||r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),change_for:Ja(r=>{if(r==null||r==="")return null;const a=String(r).replace(",","."),o=parseFloat(a);return isNaN(o)?a:o},Ha({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}).superRefine((r,a)=>{if(r.delivery_option==="delivery"&&(r.street.trim()===""&&a.addIssue({code:q.custom,message:"Rua é obrigatória.",path:["street"]}),r.number.trim()===""&&a.addIssue({code:q.custom,message:"Número é obrigatório.",path:["number"]}),r.neighborhood.trim()===""&&a.addIssue({code:q.custom,message:"Bairro é obrigatório.",path:["neighborhood"]}),r.city.trim()===""&&a.addIssue({code:q.custom,message:"Cidade é obrigatória.",path:["city"]}),r.zip_code.length!==8&&a.addIssue({code:q.custom,message:"CEP é obrigatório e deve ter 8 dígitos.",path:["zip_code"]}),(r.latitude===null||r.longitude===null)&&a.addIssue({code:q.custom,message:"A localização deve ser salva no mapa para calcular a taxa de entrega.",path:["latitude"]})),r.payment_method_id==="Dinheiro"&&r.change_for!==null&&r.change_for!==void 0&&r.change_for<=0&&a.addIssue({code:q.custom,message:"O valor do troco deve ser positivo.",path:["change_for"]}),r.payment_method_id==="Pagamento online: Pix/Cartão"){const n=xe(r.cpf_cnpj||"");n.length!==11&&n.length!==14&&a.addIssue({code:q.custom,message:"CPF/CNPJ é obrigatório para pagamento online.",path:["cpf_cnpj"]})}}),Gs=()=>{const r=window.location.origin,o=window.location.pathname.split("/")[1];return o?`${r}/${o}`:r},Ks=async()=>{const{data:r,error:a}=await M.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).limit(1).single();if(a)throw new Error(`Erro ao buscar restaurante: ${a.message}`);if(!r)throw new Error("Nenhum restaurante ativo encontrado.");return r},Us=async r=>{const{data:a,error:o}=await M.from("restaurants").select("delivery_enabled").eq("id",r).single();if(o)throw new Error(`Erro ao buscar status de entrega: ${o.message}`);return a.delivery_enabled??!0},Zs=async r=>{const{data:a,error:o}=await M.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(o)throw new Error(`Erro ao buscar métodos de pagamento: ${o.message}`);return a},Js=async r=>{const{data:a,error:o}=await M.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(o)throw new Error(`Erro ao buscar zonas de entrega: ${o.message}`);return a},Hs=r=>{switch(r){case"DollarSign":return xs;case"Smartphone":return hs;case"CreditCard":return aa;case"Package":return fs;default:return ea}},Qs=({subtotal:r,deliveryFee:a,total:o,items:i})=>e.jsxs(de,{className:"sticky top-4",children:[e.jsx(ue,{children:e.jsx(me,{className:"text-xl",children:"Seu Pedido"})}),e.jsxs(pe,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:i.map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[n.quantity,"x ",n.name,n.notes&&e.jsxs("span",{className:"block text-xs italic",children:["(",n.notes,")"]})]}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(n.price*n.quantity)})]},n.id))}),e.jsx(oe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Taxa de Entrega:"}),e.jsx("span",{className:"font-medium text-primary",children:a>0?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a):"Grátis"})]})]}),e.jsx(oe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o)})]})]})]}),Ws=({markerPosition:r,onLocationChange:a,updateAddressFields:o,restaurant:i})=>{const n=r[0],c=r[1];return e.jsxs("div",{className:"space-y-2 relative",children:[e.jsx("div",{className:"relative",children:e.jsx(us,{center:r,markerPosition:r,onLocationChange:a,isInteractive:!0})}),e.jsxs("div",{className:"text-xs text-muted-foreground flex justify-between",children:[e.jsxs("span",{children:["Latitude: ",n==null?void 0:n.toFixed(6)]}),e.jsxs("span",{children:["Longitude: ",c==null?void 0:c.toFixed(6)]})]}),e.jsxs(X,{variant:"default",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx(Y,{children:"Ajuste a Localização"}),e.jsx(ee,{children:"Arraste o pino azul para o local exato da entrega para garantir a precisão da taxa."})]})]})},Rr=()=>{const r=qa(),a=Ba(),o=Xe(),{items:i,subtotal:n,deliveryFee:c,total:d,setDeliveryFee:p,clearCart:g}=o,[x]=Da(),[j,C]=l.useState(!1),[w,f]=l.useState(!1),[y,v]=l.useState(null),[$,F]=l.useState(null),_=x.get("status"),D=x.get("external_reference"),$e=x.has("collection_id")||x.has("external_reference"),[ie,Te]=l.useState(!!D);l.useEffect(()=>{if(D)if(_==="approved"||_==="failure"||_==="pending"){r(`/order-success/${D}?status=${_}`,{replace:!0});return}else $e&&(b.info("Pagamento cancelado.",{description:"Você pode tentar novamente ou escolher outro método de pagamento."}),window.history.replaceState({},document.title,window.location.pathname+window.location.hash.split("?")[0]),Te(!1));else Te(!1)},[D,_,$e,r]);const{data:m,isLoading:wa,isError:_a,error:Ra}=ce({queryKey:["checkoutRestaurantData"],queryFn:Ks}),{data:O,isLoading:ve}=ce({queryKey:["deliveryStatus",m==null?void 0:m.id],queryFn:()=>Us(m.id),enabled:!!(m!=null&&m.id)}),{data:J=[],isLoading:Ea}=ce({queryKey:["checkoutPaymentMethods",m==null?void 0:m.id],queryFn:()=>Zs(m.id),enabled:!!(m!=null&&m.id)}),{data:Ae=[],isLoading:Pa}=ce({queryKey:["checkoutDeliveryZones",m==null?void 0:m.id],queryFn:()=>Js(m.id),enabled:!!(m!=null&&m.id)}),Sa=wa||ve||Ea||Pa,Ia=_a,Me=Ra,t=Qa({resolver:Wa(Ds),defaultValues:{name:"",phone:"",email:"",delivery_option:"delivery",street:"",number:"",complement:"",neighborhood:"",city:"",zip_code:"",payment_method_id:"",notes:"",cpf_cnpj:"",change_for:null,latitude:null,longitude:null},mode:"onBlur"}),H=t.watch("delivery_option"),be=t.watch("payment_method_id"),Q=J.find(s=>s.id===be),G=(Q==null?void 0:Q.name)==="Pagamento online: Pix/Cartão",ae=(Q==null?void 0:Q.name)==="Dinheiro",V=t.watch("latitude"),L=t.watch("longitude");t.watch(["street","number","neighborhood","city","zip_code"]);const K=H==="delivery",Fa=l.useMemo(()=>JSON.stringify({deliveryOption:H,deliveryEnabled:O,lat:V,lng:L}),[H,O,V,L]),ka=l.useMemo(()=>typeof V=="number"&&typeof L=="number"&&!isNaN(V)&&!isNaN(L)?[V,L]:m!=null&&m.latitude&&(m!=null&&m.longitude)?[m.latitude,m.longitude]:[-23.55052,-46.633308],[V,L,m]),Ne=l.useCallback(s=>{const u=s.road||s.logradouro||"",h=s.house_number||"",R=s.suburb||s.bairro||"",E=s.city||s.localidade||"",z=s.postcode||s.cep||"";t.setValue("street",u,{shouldValidate:!0}),t.setValue("number",h||"",{shouldValidate:!0}),t.setValue("complement",s.suburb||"",{shouldValidate:!0}),t.setValue("neighborhood",R,{shouldValidate:!0}),t.setValue("city",E,{shouldValidate:!0}),t.setValue("zip_code",z,{shouldValidate:!0})},[t]),Va=l.useCallback(async(s,u)=>{t.setValue("latitude",s,{shouldValidate:!0}),t.setValue("longitude",u,{shouldValidate:!0});const h=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${u}&addressdetails=1`,R=await fetch(h);if(R.ok){const E=await R.json();E.address&&(Ne(E.address),b.info("Endereço preenchido a partir do mapa."))}},[t,Ne]),La=l.useCallback(()=>{t.setValue("street","",{shouldValidate:!0}),t.setValue("number","",{shouldValidate:!0}),t.setValue("complement","",{shouldValidate:!0}),t.setValue("neighborhood","",{shouldValidate:!0}),t.setValue("city","",{shouldValidate:!0}),t.setValue("zip_code","",{shouldValidate:!0}),t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),p(0),v(null),F(null),b.info("Endereço limpo."),localStorage.removeItem("checkoutFormData")},[t,p]),Ce=l.useCallback(s=>{try{const u={name:s.name,phone:s.phone,email:s.email,delivery_option:s.delivery_option,street:s.street,number:s.number,complement:s.complement,neighborhood:s.neighborhood,city:s.city,zip_code:s.zip_code,latitude:s.latitude,longitude:s.longitude};localStorage.setItem("checkoutFormData",JSON.stringify(u))}catch(u){console.error("Failed to save form data to local storage",u)}},[]),ze=l.useCallback(()=>{try{const s=localStorage.getItem("checkoutFormData");if(s){const u=JSON.parse(s);t.reset({...t.getValues(),...u,delivery_option:u.delivery_option||"delivery"})}}catch(s){console.error("Failed to load form data from local storage",s)}},[t]);l.useEffect(()=>{ze()},[ze]),l.useEffect(()=>{const s=t.watch(u=>{Ce(u)});return()=>s.unsubscribe()},[t,Ce]);const $a=async()=>{const s=t.getValues(),[u,h,R,E,z]=[s.street,s.number,s.neighborhood,s.city,s.zip_code],le=Ca(z);if(!(u&&h&&R&&E&&le.length===8)){b.error("Preencha o endereço completo (Rua, Número, Bairro, Cidade, CEP) antes de salvar.");return}f(!0);const _e=b.loading("Buscando coordenadas e salvando endereço...");try{const se=`${u}, ${h}, ${R}, ${E}, ${z}`,U=await Vs(se);U?(t.setValue("latitude",U[0],{shouldValidate:!0}),t.setValue("longitude",U[1],{shouldValidate:!0}),Ce(t.getValues()),b.success("Endereço e localização salvos com sucesso!")):(t.setValue("latitude",null,{shouldValidate:!0}),t.setValue("longitude",null,{shouldValidate:!0}),b.error("Não foi possível encontrar as coordenadas exatas para este endereço. Por favor, ajuste o pino no mapa manualmente."))}catch{b.error("Erro ao buscar coordenadas.")}finally{f(!1),b.dismiss(_e)}};l.useEffect(()=>{ae||t.setValue("change_for",null,{shouldValidate:!0})},[ae,t]),l.useEffect(()=>{H==="pickup"&&(p(0),v(null),F(null),t.setValue("latitude",null),t.setValue("longitude",null))},[H,K,t,p,V,L]),l.useEffect(()=>{J.length>0&&!be&&t.setValue("payment_method_id",J[0].id)},[J,be,t]),l.useEffect(()=>{G?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},[G,t]),l.useEffect(()=>{const s=async()=>{if(H==="pickup"||!(m!=null&&m.latitude)||!(m!=null&&m.longitude)){p(0),v(null),F(null);return}if(ve)return;if(O===!1){p(0),v(null),F(null),f(!1);return}f(!0),v(null);let h=null;if(V&&L)h=[V,L];else{p(0),F(null),f(!1);return}if(h){const R=[m.latitude,m.longitude],E=Ls(h,R,Ae);E?(p(E.fee),v(null),F({minTime:E.minTime,maxTime:E.maxTime})):(p(0),v("Seu endereço está fora da nossa área de entrega."),F(null))}f(!1)},u=setTimeout(()=>{s()},500);return()=>clearTimeout(u)},[Fa,m,Ae,t,p,K,V,L,O,ve]),l.useEffect(()=>{if(i.length===0&&!j&&!ie){const s=setTimeout(()=>{b.info("Seu carrinho está vazio. Adicione itens para continuar."),r("/menu")},0);return()=>clearTimeout(s)}},[i.length,r,j,ie]);const Be=Oa({mutationFn:async s=>{if(!m)throw new Error("Dados do restaurante indisponíveis.");if(s.delivery_option==="delivery"&&y)throw new Error(y);const u=[s.street,s.number,s.complement?`(${s.complement})`:null,s.neighborhood,s.city,s.zip_code].filter(Boolean).join(", "),h=s.delivery_option==="delivery"?u:"Retirada no Local";let R;const E=Na(s.phone),z=xe(s.cpf_cnpj||""),{data:le}=await M.from("customers").select("id").eq("phone",E).limit(1).single();if(le)R=le.id,z&&await M.from("customers").update({cpf_cnpj:z}).eq("id",R);else{const{data:T,error:re}=await M.from("customers").insert({name:s.name,phone:E,email:s.email||null,address:h,latitude:s.latitude,longitude:s.longitude,cpf_cnpj:z||null}).select("id").single();if(re)throw new Error(`Erro ao criar cliente: ${re.message}`);R=T.id}const De=G?"pending_payment":"pending",{data:_e,error:se}=await M.from("orders").insert({restaurant_id:m.id,customer_id:R,status:De,total_amount:d,delivery_fee:c,notes:s.notes,delivery_address:h,payment_method_id:s.payment_method_id,change_for:ae?s.change_for:null}).select("id").single();if(se)throw new Error(`Erro ao criar pedido: ${se.message}`);const U=_e.id,za=i.map(T=>({order_id:U,product_id:T.product_id,quantity:T.quantity,unit_price:T.price,subtotal:T.price*T.quantity,notes:T.notes})),{error:Ge}=await M.from("order_items").insert(za);if(Ge)throw new Error(`Erro ao adicionar itens do pedido: ${Ge.message}`);if(G){g(),C(!0),b.info("Redirecionando para o pagamento online...");const T=Gs(),re={orderId:U,items:i,totalAmount:parseFloat(d.toFixed(2)),restaurantName:m.name,clientUrl:T,customerEmail:s.email||"cliente@pedido123.com",customerCpfCnpj:z};console.log("Payload enviado para create-payment-preference:",re);try{const{data:B,error:Ke}=await M.functions.invoke("create-payment-preference",{body:re});if(Ke)throw new Error(Ke.message);if(B&&B.error)throw new Error(`Mercado Pago Error: ${B.error}`);if(B&&B.init_point){window.location.href=B.init_point;return}else throw new Error("Resposta de pagamento inválida: init_point não encontrado.")}catch(B){throw console.error("Erro ao criar preferência de pagamento:",B),new Error(`Falha ao processar pagamento online: ${B.message}`)}}return U},onSuccess:s=>{G||(b.success(`Pedido #${s.slice(-4)} realizado com sucesso!`),a.invalidateQueries({queryKey:["orders"]}),localStorage.removeItem("checkoutFormData"),r(`/order-success/${s}`))},onError:s=>{let u="Ocorreu um erro ao finalizar seu pedido. Por favor, tente novamente.";const h=s.message||"";h.includes("Mercado Pago Error:")?(u=h.split("Mercado Pago Error:")[1].trim(),u.includes("access token")&&(u="O Access Token do Mercado Pago está incorreto ou ausente. Por favor, verifique as configurações do restaurante.")):h.toLowerCase().includes("access token")||h.toLowerCase().includes("credentials")?u="Ocorreu um problema com a configuração de pagamento do restaurante. Por favor, entre em contato com o estabelecimento.":h.toLowerCase().includes("fora da nossa área de entrega")?u="Seu endereço está fora da nossa área de entrega.":h.toLowerCase().includes("inconsistência no valor total")?u="Erro de cálculo no pedido. Por favor, tente limpar o carrinho e refazer o pedido.":h.toLowerCase().includes("falha ao processar pagamento online")&&(u=h.split("Falha ao processar pagamento online:")[1]||"Erro ao processar pagamento online. Por favor, tente novamente."),b.error("Falha ao processar o pagamento",{description:u,duration:1e4}),C(!1)}}),Ta=async s=>{if(s.delivery_option==="delivery"&&(s.latitude===null||s.longitude===null)){t.setError("latitude",{type:"manual",message:"A localização deve ser salva no mapa para calcular a taxa de entrega."}),b.error('Por favor, clique em "Salvar Endereço" para confirmar a localização no mapa.');return}if(G){const u=s.cpf_cnpj||"",h=xe(u);if(h.length!==11&&h.length!==14){t.setError("cpf_cnpj",{type:"manual",message:"CPF/CNPJ é obrigatório para pagamento online."}),b.error("Por favor, preencha o CPF/CNPJ corretamente.");return}}if(ae){const u=s.change_for;if(u!=null&&u<d){b.error(`O valor do troco (R$ ${u.toFixed(2).replace(".",",")}) deve ser maior ou igual ao total do pedido (R$ ${d.toFixed(2).replace(".",",")}).`);return}}Be.mutate(s)},Aa=s=>{Object.keys(s).length>0&&b.error("Por favor, preencha todos os campos obrigatórios e corrija os erros.")};if(i.length===0&&!j&&!ie)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Redirecionando..."});if(Sa||ie)return e.jsx(as,{});if(Ia)return e.jsx("div",{className:"container mx-auto p-4 max-w-6xl",children:e.jsxs(X,{variant:"destructive",children:[e.jsx(Ze,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Conexão"}),e.jsx(ee,{children:Me instanceof Error?Me.message:"Não foi possível carregar os dados."})]})});const we=Be.isPending||j||w,Ma=!K||!y&&c>=0,Oe=!K||V!==null&&L!==null,qe=!we&&Ma&&Oe;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card sticky top-0 z-50",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl flex items-center",children:[e.jsx(Ga,{to:"/menu",children:e.jsx(te,{variant:"ghost",size:"icon",className:"mr-4",children:e.jsx(ps,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Finalizar Pedido"})]})}),e.jsx(qs,{}),e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl pb-24 lg:pb-8",children:[" ",e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(cs,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(Ta,Aa),className:"space-y-6",children:[e.jsxs(de,{children:[e.jsx(ue,{children:e.jsx(me,{className:"text-xl",children:"1. Seus Dados"})}),e.jsxs(pe,{className:"space-y-4",children:[e.jsx(S,{control:t.control,name:"name",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Nome Completo *"}),e.jsx(A,{placeholder:"Seu nome",...s}),e.jsx(I,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(S,{control:t.control,name:"phone",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Telefone *"}),e.jsx(xa,{...s}),e.jsx(I,{})]})}),e.jsx(S,{control:t.control,name:"email",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Email (Opcional)"}),e.jsx(A,{placeholder:"seu@email.com",...s}),e.jsx(I,{})]})})]})]})]}),e.jsxs(de,{children:[e.jsx(ue,{children:e.jsx(me,{className:"text-xl",children:"2. Entrega"})}),e.jsxs(pe,{className:"space-y-4",children:[e.jsx(S,{control:t.control,name:"delivery_option",render:({field:s})=>e.jsxs(N,{className:"space-y-3",children:[e.jsx(W,{children:e.jsxs(Pe,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs(N,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(W,{children:e.jsx(he,{value:"delivery"})}),e.jsx(Je,{className:"h-5 w-5 text-primary"}),e.jsxs(P,{className:ne("font-normal flex-1 cursor-pointer"),children:["Delivery",O===!1&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:" (Taxa de entrega desativada, entrega gratuita)"})]})]}),e.jsxs(N,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(W,{children:e.jsx(he,{value:"pickup"})}),e.jsx(ea,{className:"h-5 w-5 text-primary"}),e.jsx(P,{className:"font-normal flex-1 cursor-pointer",children:"Retirada no Local"})]})]})}),e.jsx(I,{})]})}),K&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ee,{className:"h-4 w-4"})," Endereço de Entrega *"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(te,{type:"button",variant:"outline",size:"sm",onClick:$a,disabled:w,children:[e.jsx(js,{className:"h-4 w-4 mr-2"})," Salvar Endereço"]}),e.jsxs(te,{type:"button",variant:"outline",size:"sm",onClick:La,children:[e.jsx(ys,{className:"h-4 w-4 mr-2"})," Limpar"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(S,{control:t.control,name:"street",render:({field:s})=>e.jsxs(N,{className:"col-span-2",children:[e.jsx(P,{children:"Rua *"}),e.jsx(A,{...s}),e.jsx(I,{})]})}),e.jsx(S,{control:t.control,name:"number",render:({field:s})=>e.jsxs(N,{className:"col-span-1",children:[e.jsx(P,{children:"Número *"}),e.jsx(A,{...s}),e.jsx(I,{})]})})]}),e.jsx(S,{control:t.control,name:"complement",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Complemento (Opcional)"}),e.jsx(A,{placeholder:"Apto, Bloco, Casa, etc.",...s,disabled:!1}),e.jsx(I,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(S,{control:t.control,name:"neighborhood",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Bairro *"}),e.jsx(A,{...s}),e.jsx(I,{})]})}),e.jsx(S,{control:t.control,name:"city",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Cidade *"}),e.jsx(A,{...s}),e.jsx(I,{})]})})]}),e.jsx(S,{control:t.control,name:"zip_code",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"CEP *"}),e.jsx(ds,{...s}),e.jsx(I,{})]})}),K&&e.jsx(Ws,{markerPosition:ka,onLocationChange:Va,updateAddressFields:Ne,restaurant:m}),w&&O!==!1&&e.jsxs(X,{children:[e.jsx(Re,{className:"h-4 w-4 animate-spin"}),e.jsx(Y,{children:"Calculando Taxa..."}),e.jsx(ee,{children:"Aguarde enquanto calculamos a taxa de entrega para o seu endereço."})]}),y&&O!==!1&&e.jsxs(X,{variant:"destructive",children:[e.jsx(Ze,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro de Entrega"}),e.jsx(ee,{children:y})]}),c>0&&!w&&O!==!1&&e.jsxs(X,{className:"mt-4",children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx(Y,{children:"Taxa de Entrega Aplicada"}),e.jsxs(ee,{children:["Taxa: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c)]})]}),K&&!Oe&&e.jsxs(X,{variant:"destructive",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx(Y,{children:"Localização Obrigatória"}),e.jsx(ee,{children:'Clique em "Salvar Endereço" para confirmar a localização no mapa e calcular a taxa de entrega.'})]})]})]})]}),e.jsxs(de,{children:[e.jsx(ue,{children:e.jsx(me,{className:"text-xl",children:"3. Pagamento"})}),e.jsxs(pe,{className:"space-y-4",children:[e.jsx(S,{control:t.control,name:"payment_method_id",render:({field:s})=>e.jsxs(N,{className:"space-y-3",children:[e.jsx(W,{children:e.jsx(Pe,{onValueChange:u=>{s.onChange(u);const h=J.find(R=>R.id===u);(h==null?void 0:h.name)!=="Dinheiro"&&t.setValue("change_for",null,{shouldValidate:!0}),(h==null?void 0:h.name)==="Pagamento online: Pix/Cartão"?t.trigger("cpf_cnpj"):t.clearErrors("cpf_cnpj")},defaultValue:s.value,className:"flex flex-col space-y-2",children:J.map(u=>{const h=Hs(u.icon||"Store");return e.jsxs(N,{className:"flex items-center space-x-3 space-y-0 border p-4 rounded-lg cursor-pointer",children:[e.jsx(W,{children:e.jsx(he,{value:u.id})}),e.jsx(h,{className:"h-5 w-5 text-primary"}),e.jsxs(P,{className:"font-normal flex-1 cursor-pointer",children:[u.name,e.jsx("span",{className:"block text-xs text-muted-foreground",children:u.description})]})]},u.id)})})}),e.jsx(I,{})]})}),G&&e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(aa,{className:"h-4 w-4"})," Detalhes Adicionais"]}),e.jsx(S,{control:t.control,name:"cpf_cnpj",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"CPF/CNPJ * (obrigatório para pagamento online)"}),e.jsx(W,{children:e.jsx(ga,{...s})}),e.jsx(I,{})]})})]}),ae&&e.jsx(S,{control:t.control,name:"change_for",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Precisa de troco para quanto? (R$)"}),e.jsx(A,{type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2}).format(d),...s,value:s.value===null||s.value===void 0?"":String(s.value),onChange:u=>{const h=u.target.value;s.onChange(h===""?null:h)}}),e.jsx(I,{})]})}),e.jsx(S,{control:t.control,name:"notes",render:({field:s})=>e.jsxs(N,{children:[e.jsx(P,{children:"Observações do Pedido (Opcional)"}),e.jsx(ls,{placeholder:"Ex: Tocar a campainha duas vezes...",...s,rows:2}),e.jsx(I,{})]})})]})]}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-card p-4 border-t shadow-2xl lg:hidden z-50",children:e.jsx(te,{type:"submit",className:"w-full h-12 text-lg",disabled:!qe,children:we?e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}`})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(te,{type:"submit",className:"w-full h-12 text-lg",disabled:!qe,children:we?e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"mr-2 h-4 w-4 animate-spin"})," Processando..."]}):`Finalizar Pedido - ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(d)}`})})]})})}),e.jsx("div",{className:"lg:col-span-1 hidden lg:block",children:e.jsx(Qs,{...o})})]})]})]})};export{Rr as default};
