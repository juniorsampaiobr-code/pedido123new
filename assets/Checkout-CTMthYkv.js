import{b as le,j as e,u as Qr,c as Pe}from"./tanstack-d4AvmB45.js";import{r as d,u as Xr,h as Hr,j as Wr,L as Ie}from"./vendor-CnEXr6gt.js";import{s as R}from"./client-D5i5GwB9.js";import{c as Jr,d as dr,e as De,P as be,f as Me,g as Yr,h as et,i as rt,a as me,u as b,L as ue,p as tt,b as Je}from"./index-C85mq6fj.js";import{L as nt,g as Ye,c as Fe,Z as st}from"./location-BSltxO9u.js";import{u as at}from"./use-auth-status-b07NBuTX.js";import{o as lr,s as V,e as ot,u as er,C as de,t as rr}from"./types-DKlirIXB.js";import{B as Z}from"./button-D3FhC3ao.js";import{C as Q,b as X,c as H,a as W}from"./card-BfPeSjeC.js";import{L as D,I as ne}from"./label-CKsh8Txb.js";import{T as it}from"./textarea-CXSwrXL8.js";import{c as ur,R as ct,I as dt}from"./index-Dkz5LmZm.js";import{u as lt}from"./index-DrlxvCXN.js";import{u as ut}from"./index-KNP7Yozt.js";import{S as tr}from"./separator-CYw2bQU1.js";import{A as ee,a as se,b as ae}from"./alert-_4CLy7CB.js";import{P as mt,M as ft}from"./PhoneInput-Beqyb091.js";import{C as pt,L as ht}from"./CustomerProfileModal-BKm7OiAl.js";import{D as nr,a as sr,b as xt,c as gt,d as yt}from"./dialog-CBleHzte.js";import{C as mr}from"./credit-card-BNInpGSH.js";import{C as jt}from"./CpfCnpjInput-CWl1gTrI.js";import{M as Ae}from"./map-pin-DzmvWY-G.js";import{A as vt,a as wt,b as bt,c as _t,d as Nt,e as Ct,g as Et}from"./alert-dialog-Bnf-AUNX.js";import{C as ve}from"./circle-alert-CfosrXTn.js";import{F as ar,b as Rt,d as St}from"./form-B6QpXjHv.js";import{T as or}from"./terminal-B0nmZiGi.js";import{R as Pt}from"./pt-BR-C-Y0f82c.js";import{A as It}from"./arrow-left-C4n4TCuC.js";import{U as ir}from"./user-u3UtFrUM.js";import{T as ye}from"./truck-CEqgMXV7.js";import{C as Ft}from"./circle-check-big-C_0vR57j.js";import{S as Mt}from"./save-Ci6WaWmA.js";import{D as At}from"./dollar-sign-CocSDDcT.js";import"./supabase-BZV_3FV3.js";import"./skeleton-CS6vipTz.js";import"./package-Z5hRLbUo.js";import"./check-CL2rPjZx.js";import"./circle-x-BZ5R-S1B.js";import"./euro-Cpe4Q6gR.js";import"./format-BeKxgCCE.js";import"./index-BuWKwWME.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=Jr("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),Dt=async r=>{const{data:s,error:n}=await R.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${n.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},fr=r=>le({queryKey:["mercadoPagoPublicKey",r],queryFn:()=>Dt(r),enabled:!!r,staleTime:1/0});var Oe="Radio",[Ot,pr]=dr(Oe),[Tt,Lt]=Ot(Oe),hr=d.forwardRef((r,s)=>{const{__scopeRadio:n,name:l,checked:m=!1,required:h,disabled:w,value:c="on",onCheck:S,form:P,..._}=r,[x,A]=d.useState(null),C=De(s,z=>A(z)),M=d.useRef(!1),O=x?P||!!x.closest("form"):!0;return e.jsxs(Tt,{scope:n,checked:m,disabled:w,children:[e.jsx(be.button,{type:"button",role:"radio","aria-checked":m,"data-state":jr(m),"data-disabled":w?"":void 0,disabled:w,value:c,..._,ref:C,onClick:Me(r.onClick,z=>{m||S==null||S(),O&&(M.current=z.isPropagationStopped(),M.current||z.stopPropagation())})}),O&&e.jsx(yr,{control:x,bubbles:!M.current,name:l,value:c,checked:m,required:h,disabled:w,form:P,style:{transform:"translateX(-100%)"}})]})});hr.displayName=Oe;var xr="RadioIndicator",gr=d.forwardRef((r,s)=>{const{__scopeRadio:n,forceMount:l,...m}=r,h=Lt(xr,n);return e.jsx(Yr,{present:l||h.checked,children:e.jsx(be.span,{"data-state":jr(h.checked),"data-disabled":h.disabled?"":void 0,...m,ref:s})})});gr.displayName=xr;var Vt="RadioBubbleInput",yr=d.forwardRef(({__scopeRadio:r,control:s,checked:n,bubbles:l=!0,...m},h)=>{const w=d.useRef(null),c=De(w,h),S=ut(n),P=et(s);return d.useEffect(()=>{const _=w.current;if(!_)return;const x=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(x,"checked").set;if(S!==n&&C){const M=new Event("click",{bubbles:l});C.call(_,n),_.dispatchEvent(M)}},[S,n,l]),e.jsx(be.input,{type:"radio","aria-hidden":!0,defaultChecked:n,...m,tabIndex:-1,ref:c,style:{...m.style,...P,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});yr.displayName=Vt;function jr(r){return r?"checked":"unchecked"}var $t=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],_e="RadioGroup",[qt,es]=dr(_e,[ur,pr]),vr=ur(),wr=pr(),[zt,Gt]=qt(_e),br=d.forwardRef((r,s)=>{const{__scopeRadioGroup:n,name:l,defaultValue:m,value:h,required:w=!1,disabled:c=!1,orientation:S,dir:P,loop:_=!0,onValueChange:x,...A}=r,C=vr(n),M=lt(P),[O,z]=rt({prop:h,defaultProp:m??null,onChange:x,caller:_e});return e.jsx(zt,{scope:n,name:l,required:w,disabled:c,value:O,onValueChange:z,children:e.jsx(ct,{asChild:!0,...C,orientation:S,dir:M,loop:_,children:e.jsx(be.div,{role:"radiogroup","aria-required":w,"aria-orientation":S,"data-disabled":c?"":void 0,dir:M,...A,ref:s})})})});br.displayName=_e;var _r="RadioGroupItem",Nr=d.forwardRef((r,s)=>{const{__scopeRadioGroup:n,disabled:l,...m}=r,h=Gt(_r,n),w=h.disabled||l,c=vr(n),S=wr(n),P=d.useRef(null),_=De(s,P),x=h.value===m.value,A=d.useRef(!1);return d.useEffect(()=>{const C=O=>{$t.includes(O.key)&&(A.current=!0)},M=()=>A.current=!1;return document.addEventListener("keydown",C),document.addEventListener("keyup",M),()=>{document.removeEventListener("keydown",C),document.removeEventListener("keyup",M)}},[]),e.jsx(dt,{asChild:!0,...c,focusable:!w,active:x,children:e.jsx(hr,{disabled:w,required:h.required,checked:x,...S,...m,name:h.name,ref:_,onCheck:()=>h.onValueChange(m.value),onKeyDown:Me(C=>{C.key==="Enter"&&C.preventDefault()}),onFocus:Me(m.onFocus,()=>{var C;A.current&&((C=P.current)==null||C.click())})})})});Nr.displayName=_r;var Bt="RadioGroupIndicator",Cr=d.forwardRef((r,s)=>{const{__scopeRadioGroup:n,...l}=r,m=wr(n);return e.jsx(gr,{...m,...l,ref:s})});Cr.displayName=Bt;var Er=br,Rr=Nr,Kt=Cr;const ke=d.forwardRef(({className:r,...s},n)=>e.jsx(Er,{className:me("grid gap-2",r),...s,ref:n}));ke.displayName=Er.displayName;const we=d.forwardRef(({className:r,...s},n)=>e.jsx(Rr,{ref:n,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...s,children:e.jsx(Kt,{className:"flex items-center justify-center",children:e.jsx(kt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));we.displayName=Rr.displayName;var Te={};Object.defineProperty(Te,"__esModule",{value:!0});var Sr=Te.loadMercadoPago=void 0;const Pr="https://sdk.mercadopago.com/js/v2",Ut=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,cr="MercadoPago has already been initialized in your window, please remove the duplicate import",Zt="MercadoPago.js not available",Qt="Failed to load MercadoPago.js",Xt=()=>{for(var r=document.querySelectorAll(`script[src^="${Pr}"`),s=0;s<r.length;s++){var n=r[s];if(Ut.test(n.src))return n}return null},Ht=()=>{const r=document.createElement("script");r.src=Pr;const s=document.head||document.body;if(!s)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return s.appendChild(r),r};let je=null;const Wt=()=>(je!==null||(je=new Promise((r,s)=>{if(typeof window>"u"){r(null);return}if(window.MercadoPago){console.warn(cr),r(window.MercadoPago);return}try{let n=Xt();n?console.warn(cr):n||(n=Ht()),n.addEventListener("load",()=>{window.MercadoPago?r(window.MercadoPago):s(new Error(Zt))}),n.addEventListener("error",()=>{s(new Error(Qt))})}catch(n){s(n);return}})),je);Sr=Te.loadMercadoPago=Wt;var Jt=function(r,s,n,l){function m(h){return h instanceof n?h:new n(function(w){w(h)})}return new(n||(n=Promise))(function(h,w){function c(_){try{P(l.next(_))}catch(x){w(x)}}function S(_){try{P(l.throw(_))}catch(x){w(x)}}function P(_){_.done?h(_.value):m(_.value).then(c,S)}P((l=l.apply(r,s||[])).next())})};class B{static getInstance(){return Jt(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield Sr(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}B.publicKey=null;B.options={};B.instanceMercadoPago=void 0;B.loadedInstanceMercadoPago=!1;function Yt(r,s){return Object.keys(r).length===Object.keys(s).length&&Object.keys(r).every(l=>Object.prototype.hasOwnProperty.call(s,l)&&r[l]===s[l])}const en=(r,s)=>{const n=Object.assign(Object.assign({},s),{frontEndStack:"react"}),l=!Yt(B.options,n);(r!==B.publicKey||l)&&(B.publicKey=r,B.options=n,B.instanceMercadoPago=void 0)},rn=({preferenceId:r,initPoint:s,onClose:n})=>{const{data:l,isLoading:m}=fr();return d.useEffect(()=>{if(l)try{en(l,{locale:"pt-BR"})}catch(h){console.error("Erro ao inicializar Mercado Pago:",h),b.error("Erro ao carregar o SDK do Mercado Pago."),n();return}s&&(console.log("Redirecionando para o Mercado Pago:",s),window.location.href=s)},[l,n,s]),m||!l?e.jsx(nr,{open:!0,onOpenChange:n,children:e.jsx(sr,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(nr,{open:!0,onOpenChange:n,children:e.jsxs(sr,{className:"sm:max-w-[425px]",children:[e.jsxs(xt,{children:[e.jsxs(gt,{className:"flex items-center gap-2",children:[e.jsx(mr,{className:"h-5 w-5 text-primary"}),"Redirecionando para Pagamento"]}),e.jsx(yt,{children:"Você está sendo redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(ue,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde..."})]}),e.jsx(Z,{variant:"outline",onClick:n,children:"Cancelar e Voltar"})]})})},tn=({latitude:r,longitude:s,address:n,className:l})=>{const m=d.useMemo(()=>[r,s],[r,s]),h=d.useMemo(()=>[r,s],[r,s]);return e.jsxs(Q,{className:me("w-full",l),children:[e.jsxs(X,{children:[e.jsxs(H,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5 text-primary"}),"Sua Localização"]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:n})]}),e.jsx(W,{className:"p-0",children:e.jsx("div",{className:"h-64 w-full rounded-b-lg overflow-hidden",children:e.jsx(nt,{center:h,markerPosition:m,onMarkerDragEnd:()=>{},zoom:16})})})]})},nn=({isOpen:r,onConfirm:s})=>e.jsx(vt,{open:r,children:e.jsxs(wt,{children:[e.jsxs(bt,{children:[e.jsxs(_t,{className:"flex items-center gap-2 text-primary",children:[e.jsx(ve,{className:"h-6 w-6"}),"Atenção ao Pagamento Online!"]}),e.jsxs(Nt,{children:["Você escolheu o pagamento online (Pix ou Cartão).",e.jsx("br",{}),e.jsx("br",{}),"Ao prosseguir, você será redirecionado para o checkout do Mercado Pago.",e.jsx("br",{}),e.jsx("br",{}),'**IMPORTANTE:** Se você escolher **PIX**, após o pagamento, você pode precisar clicar no botão **"Voltar ao site"** na tela do Mercado Pago para que seu pedido seja finalizado e rastreado corretamente.']})]}),e.jsx(Ct,{children:e.jsx(Et,{onClick:s,className:"w-full",children:"Entendi e Continuar"})})]})}),sn=lr({zip_code:V().min(1,"CEP é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===8,{message:"CEP deve ter 8 dígitos."}),street:V().min(1,"Rua é obrigatória."),number:V().min(1,"Número é obrigatório."),neighborhood:V().min(1,"Bairro é obrigatório."),city:V().min(1,"Cidade é obrigatória.")}),an=lr({name:V().min(1,"Nome é obrigatório."),phone:V().min(1,"Telefone é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),cpf_cnpj:V().min(1,"CPF/CNPJ é obrigatório.").transform(r=>r.replace(/\D/g,"")).refine(r=>r.length===11||r.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:ot(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:V().optional(),payment_method_id:V().min(1,"Selecione um método de pagamento."),change_for:V().optional()}),on=async r=>{const{data:s,error:n}=await R.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("id",r).eq("is_active",!0).limit(1).single();if(n)throw new Error(`Erro ao buscar restaurante: ${n.message}`);if(!s)throw new Error("Restaurante não encontrado ou inativo.");return s},cn=async r=>{const{data:s,error:n}=await R.from("delivery_zones").select("*").eq("restaurant_id",r).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(n)throw new Error(`Erro ao buscar zonas de entrega: ${n.message}`);return s},dn=async r=>{const{data:s,error:n}=await R.from("payment_methods").select("*").eq("restaurant_id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw new Error(`Erro ao buscar métodos de pagamento: ${n.message}`);return s},ln=async r=>{const{data:s,error:n}=await R.from("customers").select("*").eq("user_id",r).limit(1).single();if(n&&n.code!=="PGRST116")throw new Error(n.message);return s||null},rs=()=>{var Ze,Qe,Xe,He,We;const r=Xr(),s=Hr(),[n]=Wr(),l=Qr(),{items:m,totalAmount:h,clearCart:w}=tt(),{data:c,isLoading:S}=at(),[P]=d.useState((Ze=s.state)==null?void 0:Ze.restaurantId),_=n.get("restaurantId"),x=P||_,{data:A}=fr(x),[C,M]=d.useState(!1),[O,z]=d.useState(!1),[fe,pe]=d.useState(0),[oe,he]=d.useState(null),[Ne,ie]=d.useState(!0),[J,Ce]=d.useState(null),[Ir,Ee]=d.useState(!1),[Fr,Mr]=d.useState(null),[Le,Ar]=d.useState(null),[K,re]=d.useState(!1),[kr,Ve]=d.useState(!1),[$e,Re]=d.useState(null),{data:p,isLoading:Dr,isError:Or,error:qe,refetch:Tr}=le({queryKey:["checkoutRestaurantData",x],queryFn:()=>on(x),enabled:!!x,staleTime:1/0}),{data:$,isLoading:Lr}=le({queryKey:["checkoutDeliveryZones",x],queryFn:()=>cn(p.id),enabled:!!p,staleTime:1/0}),{data:G,isLoading:Vr}=le({queryKey:["checkoutPaymentMethods",x],queryFn:()=>dn(p.id),enabled:!!p,staleTime:1/0}),{data:f,isLoading:ze,refetch:un}=le({queryKey:["checkoutCustomerData",c==null?void 0:c.id],queryFn:()=>ln(c.id),enabled:!!c,staleTime:0}),U=d.useMemo(()=>p!=null&&p.latitude&&(p!=null&&p.longitude)?[p.latitude,p.longitude]:null,[p]),$r=d.useCallback(async(t,o,a,u,y,j,E)=>{const I=[30,45];if(p&&p.delivery_enabled===!1){const F=`${o}, ${a}, ${y}, ${u}, ${t}`;let N=null;if(j&&E?N={lat:j,lng:E}:N=await Ye(F),!N)return{coords:null,fee:0,time:null,isValid:!1};if($&&$.length>0&&U){const Y=Fe([N.lat,N.lng],U,$);if(Y)return{coords:N,fee:0,time:[Y.minTime,Y.maxTime],isValid:!0}}return{coords:N,fee:0,time:I,isValid:!0}}if(!p||!U)return{coords:null,fee:0,time:I,isValid:!0};const k=`${o}, ${a}, ${y}, ${u}, ${t}`;let v=null;if(j&&E?v={lat:j,lng:E}:v=await Ye(k),!v)return{coords:null,fee:0,time:null,isValid:!1};if($&&$.length>0){const F=Fe([v.lat,v.lng],U,$);return F?{coords:v,fee:F.fee,time:[F.minTime,F.maxTime],isValid:!0}:{coords:v,fee:0,time:null,isValid:!1}}else return{coords:v,fee:0,time:I,isValid:!0}},[p,U,$]),i=er({resolver:rr(an),defaultValues:{name:"",phone:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:""},mode:"onBlur"}),g=er({resolver:rr(sn),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),T=i.watch("delivery_option"),qr=i.watch("payment_method_id"),te=G==null?void 0:G.find(t=>t.id===qr),Se=(Qe=te==null?void 0:te.name)==null?void 0:Qe.includes("online"),ce=(Xe=te==null?void 0:te.name)==null?void 0:Xe.includes("Dinheiro"),q=h+fe,L=g.watch(["zip_code","street","number","city","neighborhood"]);d.useEffect(()=>{var t,o;if(f){if(i.reset({...i.getValues(),name:f.name||"",phone:f.phone||"",cpf_cnpj:f.cpf_cnpj||"",change_for:""}),f.address&&f.latitude&&f.longitude){const a=f.address.split(",").map(u=>u.trim());if(g.reset({zip_code:((o=(t=f.address.match(/\d{5}-?\d{3}$/))==null?void 0:t[0])==null?void 0:o.replace(/\D/g,""))||"",street:f.street||a[0]||"",number:f.number||a[1]||"",neighborhood:f.neighborhood||a[2]||"",city:f.city||a[3]||""}),U&&$){const u=Fe([f.latitude,f.longitude],U,$);u?(pe(u.fee),he([u.minTime,u.maxTime]),ie(!0),re(!0),Ce([f.latitude,f.longitude])):(pe(0),ie(!1),re(!0),Ce([f.latitude,f.longitude]))}}}else if(c&&!ze){const a=c.user_metadata;i.reset({...i.getValues(),name:a.full_name||"",phone:a.phone||"",cpf_cnpj:a.cpf_cnpj||"",change_for:""})}},[f,i,c,ze,g,U,$]),d.useEffect(()=>{const t=[15,30];T==="pickup"?(pe(0),ie(!0),re(!0),he(t)):(re(!1),he(null))},[T]);const xe=i.watch("change_for");d.useEffect(()=>{if(ce&&xe&&xe.trim()!==""){const t=xe.replace(",","."),o=parseFloat(t);isNaN(o)?i.setError("change_for",{message:"O troco deve ser um número válido."}):o<q?i.setError("change_for",{message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q)}).`}):i.clearErrors("change_for")}else i.clearErrors("change_for")},[ce,xe,q,i]);const ge=Pe({mutationFn:async t=>{var k;z(!0);const o=`${t.street}, ${t.number}, ${t.neighborhood}, ${t.city}, ${t.zip_code}`,a=await $r(t.zip_code,t.street,t.number,t.city,t.neighborhood);if(z(!1),!a.isValid)throw new Error((p==null?void 0:p.delivery_enabled)===!1?"O endereço está errado ou incompleto, revise todos os campos.":"Endereço fora da área de entrega.");if(!a.coords)throw new Error("Não foi possível obter as coordenadas para salvar o endereço.");const y=(k=(await R.auth.getUser()).data.user)==null?void 0:k.id;if(!(f!=null&&f.id)&&!y)return{customer:{id:"anonymous",user_id:null,name:i.getValues("name"),phone:i.getValues("phone"),email:(c==null?void 0:c.email)||null,address:o,created_at:"",updated_at:"",latitude:a.coords.lat,longitude:a.coords.lng,cpf_cnpj:i.getValues("cpf_cnpj")},feeResult:a};const j={name:i.getValues("name"),phone:i.getValues("phone"),cpf_cnpj:i.getValues("cpf_cnpj")||null},E={user_id:(c==null?void 0:c.id)||null,...j,email:(c==null?void 0:c.email)||null,address:o,latitude:a.coords.lat,longitude:a.coords.lng,street:t.street,number:t.number,neighborhood:t.neighborhood,city:t.city,zip_code:t.zip_code};let I;if(f!=null&&f.id){const{data:v,error:F}=await R.from("customers").update(E).eq("id",f.id).select().single();if(F)throw F;I=v}else if(y){const{data:v,error:F}=await R.from("customers").insert(E).select().single();if(F)throw F;I=v}else throw new Error("Não foi possível identificar o cliente para salvar.");return{customer:I,feeResult:a}},onSuccess:t=>{const{customer:o,feeResult:a}=t;(o==null?void 0:o.id)!=="anonymous"&&l.invalidateQueries({queryKey:["checkoutCustomerData"]}),pe(a.fee),he(a.time),ie(a.isValid),re(!0),Ce([a.coords.lat,a.coords.lng]),b.success("Endereço salvo e taxa de entrega calculada!")},onError:t=>{b.error(`Erro ao salvar endereço: ${t.message}`),ie(!1),re(!1)}}),zr=async()=>{if(T==="pickup")return;if(!await g.trigger()){b.error("Preencha todos os campos obrigatórios do endereço.");return}const o=g.getValues(),a=b.loading("Salvando endereço e calculando taxa...");try{await ge.mutateAsync(o),b.dismiss(a)}catch{b.dismiss(a)}},Ge=Pe({mutationFn:async t=>{var E,I;(E=(await R.auth.getUser()).data.user)==null||E.id;const a=t.phone.replace(/\D/g,""),u=((I=t.cpf_cnpj)==null?void 0:I.replace(/\D/g,""))||null,y=T==="delivery"?`${L[1]}, ${L[2]}, ${L[4]}, ${L[3]}, ${L[0]}`:null,j={user_id:(c==null?void 0:c.id)||null,name:t.name,phone:a,email:(c==null?void 0:c.email)||null,cpf_cnpj:u,address:y,latitude:J?J[0]:null,longitude:J?J[1]:null,street:g.getValues("street")||null,number:g.getValues("number")||null,neighborhood:g.getValues("neighborhood")||null,city:g.getValues("city")||null,zip_code:g.getValues("zip_code")||null};if(c)if(f){const{data:k,error:v}=await R.from("customers").update(j).eq("id",f.id).select().single();if(v)throw v;return k}else{const{data:k,error:v}=await R.from("customers").insert(j).select().single();if(v)throw v;return k}else{const{data:k,error:v}=await R.from("customers").insert(j).select().single();if(v)throw v;return k}},onSuccess:()=>{l.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:t=>{b.error(`Erro ao salvar dados do cliente: ${t.message}`)}}),Be=Pe({mutationFn:async({customerId:t,data:o})=>{if(!p)throw new Error("Dados do restaurante não disponíveis.");let a=null;if(ce&&o.change_for&&o.change_for.trim()!==""){const N=o.change_for.replace(",","."),Y=parseFloat(N);!isNaN(Y)&&Y>q&&(a=Y)}let[u,y]=oe||[null,null];if((T==="delivery"||T==="pickup")&&(!u||!y)){const N=T==="pickup"?[15,30]:[30,45];u=N[0],y=N[1]}const j=T==="delivery"?`${L[1]}, ${L[2]}, ${L[4]}, ${L[3]}, ${L[0]}`:null,E={restaurant_id:p.id,customer_id:t,status:Se?"pending_payment":"pending",total_amount:q,delivery_fee:fe,delivery_address:j,notes:o.notes,payment_method_id:o.payment_method_id,change_for:a,min_delivery_time_minutes:u,max_delivery_time_minutes:y},{data:I,error:k}=await R.from("orders").insert(E).select("id").single();if(k)throw k;const v=m.map(N=>({order_id:I.id,product_id:N.product.id,quantity:parseFloat(N.quantity.toFixed(3)),unit_price:parseFloat(N.product.price.toFixed(2)),subtotal:parseFloat(N.subtotal.toFixed(2)),notes:N.notes})),{error:F}=await R.from("order_items").insert(v);if(F)throw F;return I.id},onSuccess:t=>{l.invalidateQueries({queryKey:["orders"]})},onError:t=>{b.error(`Erro ao criar pedido: ${t.message}`)}}),Gr=async t=>{if(ce&&t.change_for&&t.change_for.trim()!==""){const u=t.change_for.replace(",","."),y=parseFloat(u);if(isNaN(y)){b.error("O troco deve ser um número válido.");return}if(y<q){i.setError("change_for",{type:"manual",message:`O troco deve ser maior ou igual ao total do pedido (${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q)}).`});return}}if(m.length===0){b.error("Seu carrinho está vazio."),r(`/menu/${x}`);return}if(T==="delivery"){if(!K){b.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!Ne){b.error("O endereço de entrega está fora da área de cobertura.");return}}let o;try{o=(await Ge.mutateAsync(t)).id}catch(u){b.error(`Falha ao salvar cliente: ${u.message}`);return}let a;try{a=await Be.mutateAsync({customerId:o,data:t})}catch(u){b.error(`Falha ao criar pedido: ${u.message}`);return}Se?await Br(a,t):(w(),r(`/order-success/${a}`,{replace:!0}))},Br=async(t,o)=>{if(!p)return;const a=window.location.origin+window.location.pathname,u=m.map(j=>({name:j.product.name,price:j.product.price,quantity:j.quantity})),y=b.loading("Preparando pagamento online...");try{const{data:j,error:E}=await R.functions.invoke("create-payment-preference",{body:{orderId:t,items:u,totalAmount:q,restaurantName:p.name,clientUrl:a,customerEmail:(c==null?void 0:c.email)||"cliente@anonimo.com",customerCpfCnpj:o.cpf_cnpj}});if(E)throw E;const{init_point:I}=j;Mr(t),Ar(I),Ee(!0),b.dismiss(y)}catch(j){b.dismiss(y),b.error(`Erro no pagamento online: ${j.message}`),Ee(!1)}},Kr=async()=>{await R.auth.signOut(),b.success("Você saiu da sua conta."),r("/auth",{replace:!0})},Ur=(t,o,a)=>{o&&a?(Re(t),Ve(!0)):(i.setValue("payment_method_id",t,{shouldValidate:!0}),Re(null))},Zr=()=>{$e&&i.setValue("payment_method_id",$e,{shouldValidate:!0}),Ve(!1),Re(null)},Ke=d.useMemo(()=>{const[t,o,a,u,y]=L;return o&&a&&y&&u&&t?`${o}, ${a} - ${y}, ${u}, ${t}`:""},[L]);if(!x)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(ee,{variant:"destructive",className:"max-w-lg",children:[e.jsx(or,{className:"h-4 w-4"}),e.jsx(se,{children:"Erro de Rastreamento"}),e.jsx(ae,{children:"Não foi possível identificar o restaurante para o qual o pedido está sendo feito. Por favor, volte ao menu."}),e.jsx(Ie,{to:"/",children:e.jsx(Z,{className:"mt-3",variant:"secondary",size:"sm",children:"Voltar"})})]})});if(m.length===0)return d.useEffect(()=>{r(`/menu/${x}`)},[r,x]),e.jsx(Je,{});if(Dr||Lr||Vr||S)return e.jsx(Je,{});if(Or||!p)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(ee,{variant:"destructive",className:"max-w-lg",children:[e.jsx(or,{className:"h-4 w-4"}),e.jsx(se,{children:"Erro Crítico"}),e.jsx(ae,{children:qe instanceof Error?qe.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(Z,{onClick:()=>Tr(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ue=Ge.isPending||Be.isPending||ge.isPending||O||T==="delivery"&&!K;return e.jsxs("div",{className:"min-h-screen bg-background py-4 sm:py-8 px-4 sm:px-8",children:[e.jsx(pt,{isOpen:C,onClose:()=>M(!1),customer:f}),e.jsx(nn,{isOpen:kr,onConfirm:Zr}),Ir&&Le&&e.jsx(rn,{preferenceId:Fr,initPoint:Le,onClose:()=>Ee(!1)}),e.jsxs("div",{className:"w-full lg:max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ie,{to:`/menu/${x}`,children:e.jsx(Z,{variant:"ghost",size:"icon","aria-label":"Voltar ao Menu",children:e.jsx(It,{className:"h-6 w-6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),e.jsx("p",{className:"text-lg text-muted-foreground font-medium",children:p.name})]})]}),c&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Z,{variant:"outline",size:"sm",onClick:()=>M(!0),"aria-label":"Meu Perfil e Pedidos",children:[e.jsx(ir,{className:"h-4 w-4 mr-2"})," Perfil / Pedidos"]}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:Kr,children:[e.jsx(ht,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ir,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(W,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:c?`Logado como ${c.email}. ${f?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx(ar,{...i,children:e.jsx("form",{onSubmit:i.handleSubmit(Gr),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(ne,{id:"name",...i.register("name")}),i.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"phone",children:"Telefone *"}),e.jsx(de,{name:"phone",control:i.control,render:({field:t})=>e.jsx(mt,{id:"phone",...t})}),i.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ *"}),e.jsx(de,{name:"cpf_cnpj",control:i.control,render:({field:t})=>e.jsx(jt,{id:"cpf_cnpj",...t})}),i.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.cpf_cnpj.message})]})]})})})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(W,{children:e.jsx(de,{name:"delivery_option",control:i.control,render:({field:t})=>e.jsxs(ke,{onValueChange:t.onChange,value:t.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(D,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(we,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(ye,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Entrega"})]}),e.jsxs(D,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(we,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Ae,{className:"mb-3 h-6 w-6"}),e.jsx("span",{translate:"no",children:"Retirada no Local"})]})]})})})]}),T==="delivery"&&e.jsxs(Q,{className:me(!K&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(X,{children:[e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",K&&e.jsx(Ft,{className:"h-5 w-5 text-green-500 ml-2"}),!K&&e.jsx(ve,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(W,{className:"space-y-4",children:[p.delivery_enabled===!1&&e.jsxs(ee,{variant:"default",className:"bg-blue-50 dark:bg-blue-900/20 border-blue-200 text-blue-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(se,{children:"Frete Grátis Ativo"}),e.jsx(ae,{children:"As taxas de entrega dinâmica estão desativadas. O frete será R$ 0,00."})]}),e.jsx(ar,{...g,children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),zr()},id:"address-form-inner",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(D,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(de,{name:"zip_code",control:g.control,render:({field:t})=>e.jsx(Rt,{className:"flex-1 space-y-0",children:e.jsx(St,{children:e.jsx(st,{placeholder:"Digite o CEP",...t})})})}),g.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:g.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"street",children:"Rua *"}),e.jsx(ne,{id:"street",...g.register("street")}),g.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:g.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"number",children:"Número *"}),e.jsx(ne,{id:"number",...g.register("number")}),g.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:g.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(D,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(ne,{id:"neighborhood",...g.register("neighborhood")}),g.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:g.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"city",children:"Cidade *"}),e.jsx(ne,{id:"city",...g.register("city")}),g.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:g.formState.errors.city.message})]}),e.jsxs(Z,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ge.isPending||O,children:[ge.isPending||O?e.jsx(ue,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Mt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]})}),O&&e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),e.jsx(se,{children:"Calculando Taxa de Entrega..."})]}),K&&!O&&e.jsxs(e.Fragment,{children:[p.delivery_enabled!==!1&&!Ne&&e.jsxs(ee,{variant:"destructive",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(se,{children:"Fora da Área de Entrega"}),e.jsx(ae,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),(p.delivery_enabled===!1||Ne&&oe)&&e.jsxs(ee,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx(se,{children:"Entrega Disponível"}),e.jsxs(ae,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(fe),". Tempo estimado: ",oe?`${oe[0]} - ${oe[1]}`:"30 - 45"," minutos."]})]})]}),K&&J&&Ke&&e.jsx("div",{className:"mt-6",children:e.jsx(tn,{latitude:J[0],longitude:J[1],address:Ke})})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(mr,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(W,{children:[e.jsx(de,{name:"payment_method_id",control:i.control,render:({field:t})=>e.jsx(ke,{onValueChange:o=>{var j;const a=G==null?void 0:G.find(E=>E.id===o),u=(j=a==null?void 0:a.name)==null?void 0:j.includes("online"),y=!!A&&A.trim()!=="";Ur(o,!!u,y)},value:t.value,className:"space-y-3",children:G==null?void 0:G.map(o=>{var j;const a=(j=o.name)==null?void 0:j.includes("online"),u=!!A&&A.trim()!=="",y=a&&!u;return e.jsx(D,{htmlFor:o.id,className:me("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",y&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(we,{value:o.id,id:o.id,disabled:y}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",translate:"no",children:o.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o.description}),y&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},o.id)})})}),i.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:i.formState.errors.payment_method_id.message})]})]}),ce&&e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(At,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(W,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(ne,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q),...i.register("change_for")}),((He=i.formState.errors.change_for)==null?void 0:He.message)&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message}),((We=i.formState.errors.change_for)==null?void 0:We.type)==="manual"&&e.jsx("p",{className:"text-destructive text-sm",children:i.formState.errors.change_for.message})]})})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs(H,{className:"text-xl flex items-center gap-2",children:[e.jsx(ft,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(W,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(it,{id:"notes",...i.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(Q,{className:"shadow-lg",children:[e.jsx(X,{children:e.jsx(H,{className:"text-2xl",children:"Resumo"})}),e.jsxs(W,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:m.map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[t.quantity,"x ",t.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.subtotal)})]},t.product.id))}),e.jsx(tr,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(h)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(fe)})]})]}),e.jsx(tr,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q)})]}),e.jsx(Z,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ue,children:Ue?e.jsx(ue,{className:"h-5 w-5 animate-spin mr-2"}):Se?"Pagar e Finalizar":"Confirmar Pedido"}),T==="delivery"&&!K&&e.jsxs(ee,{variant:"destructive",className:"mt-3",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(ae,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Ie,{to:`/menu/${p.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{rs as default};
