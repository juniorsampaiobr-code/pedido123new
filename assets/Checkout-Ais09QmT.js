import{u as re,j as e,a as Nt,b as ye}from"./tanstack-C7aOFagJ.js";import{r as m,R as Et,h as Ct,L as Rt}from"./vendor-DjsPZZVP.js";import{c as St,s as S,$ as Ve,a0 as _e,a1 as fe,a2 as ve,a3 as Pt,a4 as It,a9 as Mt,a5 as Ot,a as me,j as E,D as ke,q as Ae,L as le,r as kt,v as At,w as Lt,B as W,o as Be,l as A,K as Dt,av as Ft,J as Tt,m as Gt,aw as qt,u as $t,p as Le,d as De,O as H,Q as Vt,R as Y,V as ee,a6 as Bt,ax as zt,U as Fe,ay as Kt,C as B,e as z,f as K,b as U,h as M,I as Z,az as te,P as Ut,i as Zt,W as Te,Y as Qt,aA as Xt,a7 as Ht,T as Wt,t as Ge}from"./index-CgqZ9Uhw.js";import{c as ze,R as Jt,I as Yt}from"./index-BIiICZmc.js";import{u as er}from"./index-C3WaO5Hu.js";import{S as qe}from"./separator-CKEAqEtR.js";import{Z as tr}from"./ZipCodeInput-BtV1j2l9.js";import{C as Ke}from"./credit-card-CxpMOCda.js";import{T as je}from"./truck-CoC75rtD.js";import{C as ce}from"./circle-alert-CRKvWfWP.js";import{M as rr}from"./mail-B2puLdPy.js";import"./supabase-BAEEEeUB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nr=St("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),ar=async()=>{const{data:t,error:a}=await S.from("restaurants").select("id").limit(1).single();if(a||!t)return console.error("Failed to fetch restaurant ID for payment settings."),null;const r=t.id,{data:s,error:i}=await S.from("payment_settings").select("mercado_pago_public_key").eq("restaurant_id",r).limit(1).single();if(i&&i.code!=="PGRST116")throw new Error(`Error fetching payment settings: ${i.message}`);return(s==null?void 0:s.mercado_pago_public_key)||null},Ue=()=>re({queryKey:["mercadoPagoPublicKey"],queryFn:ar,staleTime:1/0}),or=(t,a,r,s)=>{const n=(r-t)*(Math.PI/180),c=(s-a)*(Math.PI/180),g=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t*(Math.PI/180))*Math.cos(r*(Math.PI/180))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))},sr=async t=>{const a=t.replace(/\s+/g," ").trim(),r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,s=new AbortController,i=setTimeout(()=>s.abort(),1e4);try{console.log("LOG: geocodeAddress - URL da API:",r);const n=await fetch(r,{signal:s.signal});if(!n.ok)return console.error("LOG: geocodeAddress - Resposta da API não OK. Status:",n.status),null;const c=await n.json();if(c&&Array.isArray(c)&&c.length>0){const g=c[0],y=parseFloat(g.lat),f=parseFloat(g.lon);if(Number.isFinite(y)&&Number.isFinite(f))return console.log("LOG: geocodeAddress - Sucesso. Coordenadas:",[y,f]),{lat:y,lng:f}}return console.warn("LOG: geocodeAddress - Falha. Nenhum resultado encontrado ou coordenadas inválidas para:",a),null}catch(n){return n instanceof Error&&n.name==="AbortError"?console.error("LOG: geocodeAddress - Timeout na requisição (10s). Endereço:",a):console.error("LOG: geocodeAddress - Erro durante a requisição:",n),null}finally{clearTimeout(i)}},ir=(t,a,r)=>{const s=or(a[0],a[1],t[0],t[1]),i=r.find(n=>s<=n.max_distance_km);if(i){const n=i.delivery_fee||0,c=i.min_delivery_time_minutes||0,g=c+15;return{fee:parseFloat(n.toFixed(2)),minTime:c,maxTime:g}}return null};var be="Radio",[cr,Ze]=Ve(be),[dr,lr]=cr(be),Qe=m.forwardRef((t,a)=>{const{__scopeRadio:r,name:s,checked:i=!1,required:n,disabled:c,value:g="on",onCheck:y,form:f,...d}=t,[j,O]=m.useState(null),N=_e(a,L=>O(L)),I=m.useRef(!1),k=j?f||!!j.closest("form"):!0;return e.jsxs(dr,{scope:r,checked:i,disabled:c,children:[e.jsx(fe.button,{type:"button",role:"radio","aria-checked":i,"data-state":Je(i),"data-disabled":c?"":void 0,disabled:c,value:g,...d,ref:N,onClick:ve(t.onClick,L=>{i||y==null||y(),k&&(I.current=L.isPropagationStopped(),I.current||L.stopPropagation())})}),k&&e.jsx(We,{control:j,bubbles:!I.current,name:s,value:g,checked:i,required:n,disabled:c,form:f,style:{transform:"translateX(-100%)"}})]})});Qe.displayName=be;var Xe="RadioIndicator",He=m.forwardRef((t,a)=>{const{__scopeRadio:r,forceMount:s,...i}=t,n=lr(Xe,r);return e.jsx(Pt,{present:s||n.checked,children:e.jsx(fe.span,{"data-state":Je(n.checked),"data-disabled":n.disabled?"":void 0,...i,ref:a})})});He.displayName=Xe;var ur="RadioBubbleInput",We=m.forwardRef(({__scopeRadio:t,control:a,checked:r,bubbles:s=!0,...i},n)=>{const c=m.useRef(null),g=_e(c,n),y=er(r),f=It(a);return m.useEffect(()=>{const d=c.current;if(!d)return;const j=window.HTMLInputElement.prototype,N=Object.getOwnPropertyDescriptor(j,"checked").set;if(y!==r&&N){const I=new Event("click",{bubbles:s});N.call(d,r),d.dispatchEvent(I)}},[y,r,s]),e.jsx(fe.input,{type:"radio","aria-hidden":!0,defaultChecked:r,...i,tabIndex:-1,ref:g,style:{...i.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});We.displayName=ur;function Je(t){return t?"checked":"unchecked"}var mr=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],pe="RadioGroup",[fr,rn]=Ve(pe,[ze,Ze]),Ye=ze(),et=Ze(),[pr,hr]=fr(pe),tt=m.forwardRef((t,a)=>{const{__scopeRadioGroup:r,name:s,defaultValue:i,value:n,required:c=!1,disabled:g=!1,orientation:y,dir:f,loop:d=!0,onValueChange:j,...O}=t,N=Ye(r),I=Mt(f),[k,L]=Ot({prop:n,defaultProp:i??null,onChange:j,caller:pe});return e.jsx(pr,{scope:r,name:s,required:c,disabled:g,value:k,onValueChange:L,children:e.jsx(Jt,{asChild:!0,...N,orientation:y,dir:I,loop:d,children:e.jsx(fe.div,{role:"radiogroup","aria-required":c,"aria-orientation":y,"data-disabled":g?"":void 0,dir:I,...O,ref:a})})})});tt.displayName=pe;var rt="RadioGroupItem",nt=m.forwardRef((t,a)=>{const{__scopeRadioGroup:r,disabled:s,...i}=t,n=hr(rt,r),c=n.disabled||s,g=Ye(r),y=et(r),f=m.useRef(null),d=_e(a,f),j=n.value===i.value,O=m.useRef(!1);return m.useEffect(()=>{const N=k=>{mr.includes(k.key)&&(O.current=!0)},I=()=>O.current=!1;return document.addEventListener("keydown",N),document.addEventListener("keyup",I),()=>{document.removeEventListener("keydown",N),document.removeEventListener("keyup",I)}},[]),e.jsx(Yt,{asChild:!0,...g,focusable:!c,active:j,children:e.jsx(Qe,{disabled:c,required:n.required,checked:j,...y,...i,name:n.name,ref:d,onCheck:()=>n.onValueChange(i.value),onKeyDown:ve(N=>{N.key==="Enter"&&N.preventDefault()}),onFocus:ve(i.onFocus,()=>{var N;O.current&&((N=f.current)==null||N.click())})})})});nt.displayName=rt;var xr="RadioGroupIndicator",at=m.forwardRef((t,a)=>{const{__scopeRadioGroup:r,...s}=t,i=et(r);return e.jsx(He,{...i,...s,ref:a})});at.displayName=xr;var ot=tt,st=nt,gr=at;const we=m.forwardRef(({className:t,...a},r)=>e.jsx(ot,{className:me("grid gap-2",t),...a,ref:r}));we.displayName=ot.displayName;const ue=m.forwardRef(({className:t,...a},r)=>e.jsx(st,{ref:r,className:me("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...a,children:e.jsx(gr,{className:"flex items-center justify-center",children:e.jsx(nr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ue.displayName=st.displayName;var Ne={};Object.defineProperty(Ne,"__esModule",{value:!0});var it=Ne.loadMercadoPago=void 0;const ct="https://sdk.mercadopago.com/js/v2",yr=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,$e="MercadoPago has already been initialized in your window, please remove the duplicate import",jr="MercadoPago.js not available",vr="Failed to load MercadoPago.js",wr=()=>{for(var t=document.querySelectorAll(`script[src^="${ct}"`),a=0;a<t.length;a++){var r=t[a];if(yr.test(r.src))return r}return null},_r=()=>{const t=document.createElement("script");t.src=ct;const a=document.head||document.body;if(!a)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return a.appendChild(t),t};let de=null;const br=()=>(de!==null||(de=new Promise((t,a)=>{if(typeof window>"u"){t(null);return}if(window.MercadoPago){console.warn($e),t(window.MercadoPago);return}try{let r=wr();r?console.warn($e):r||(r=_r()),r.addEventListener("load",()=>{window.MercadoPago?t(window.MercadoPago):a(new Error(jr))}),r.addEventListener("error",()=>{a(new Error(vr))})}catch(r){a(r);return}})),de);it=Ne.loadMercadoPago=br;var Nr=function(t,a,r,s){function i(n){return n instanceof r?n:new r(function(c){c(n)})}return new(r||(r=Promise))(function(n,c){function g(d){try{f(s.next(d))}catch(j){c(j)}}function y(d){try{f(s.throw(d))}catch(j){c(j)}}function f(d){d.done?n(d.value):i(d.value).then(g,y)}f((s=s.apply(t,a||[])).next())})};class T{static getInstance(){return Nr(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield it(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}T.publicKey=null;T.options={};T.instanceMercadoPago=void 0;T.loadedInstanceMercadoPago=!1;function Er(t,a){return Object.keys(t).length===Object.keys(a).length&&Object.keys(t).every(s=>Object.prototype.hasOwnProperty.call(a,s)&&t[s]===a[s])}const Cr=(t,a)=>{const r=Object.assign(Object.assign({},a),{frontEndStack:"react"}),s=!Er(T.options,r);(t!==T.publicKey||s)&&(T.publicKey=t,T.options=r,T.instanceMercadoPago=void 0)};var Rr=function(t,a,r,s){function i(n){return n instanceof r?n:new r(function(c){c(n)})}return new(r||(r=Promise))(function(n,c){function g(d){try{f(s.next(d))}catch(j){c(j)}}function y(d){try{f(s.throw(d))}catch(j){c(j)}}function f(d){d.done?n(d.value):i(d.value).then(g,y)}f((s=s.apply(t,a||[])).next())})};const Sr=()=>Rr(void 0,void 0,void 0,function*(){}),Pr=()=>{},Ir=t=>{console.error(t)};var Mr=function(t,a,r,s){function i(n){return n instanceof r?n:new r(function(c){c(n)})}return new(r||(r=Promise))(function(n,c){function g(d){try{f(s.next(d))}catch(j){c(j)}}function y(d){try{f(s.throw(d))}catch(j){c(j)}}function f(d){d.done?n(d.value):i(d.value).then(g,y)}f((s=s.apply(t,a||[])).next())})};const Or=({settings:t,name:a,containerId:r,controller:s})=>Mr(void 0,void 0,void 0,function*(){const i=yield T.getInstance(),n=i==null?void 0:i.bricks();window[s]=yield n==null?void 0:n.create(a,r,t)}),kr=200,Ar=({onReady:t=Pr,onError:a=Ir,onSubmit:r=Sr,customization:s,initialization:i,locale:n,id:c="walletBrick_container"})=>(m.useEffect(()=>{const g={settings:{initialization:i,customization:s,locale:n,callbacks:{onReady:t,onSubmit:r,onError:a}},name:"wallet",containerId:c,controller:"walletBrickController"},y=setTimeout(()=>{Or(g)},kr);return()=>{var f;clearTimeout(y),(f=window.walletBrickController)===null||f===void 0||f.unmount()}},[s,i,t,a,r]),Et.createElement("div",{id:c})),Lr=({preferenceId:t,initPoint:a,onClose:r})=>{const{data:s,isLoading:i}=Ue();return m.useEffect(()=>{if(s)try{Cr(s,{locale:"pt-BR"})}catch(n){console.error("Erro ao inicializar Mercado Pago:",n),E.error("Erro ao carregar o SDK do Mercado Pago."),r()}},[s,r]),i||!s?e.jsx(ke,{open:!0,onOpenChange:r,children:e.jsx(Ae,{className:"sm:max-w-[425px]",children:e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx(le,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{children:"Carregando configurações de pagamento..."})]})})}):e.jsx(ke,{open:!0,onOpenChange:r,children:e.jsxs(Ae,{className:"sm:max-w-[425px]",children:[e.jsxs(kt,{children:[e.jsxs(At,{className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-primary"}),"Pagamento Online"]}),e.jsx(Lt,{children:"Você será redirecionado para o checkout seguro do Mercado Pago."})]}),e.jsx("div",{className:"py-4",children:e.jsx(Ar,{initialization:{preferenceId:t},customization:{texts:{valueProp:"smart_option"}}})}),e.jsx(W,{variant:"outline",onClick:r,children:"Cancelar Pagamento"})]})})},Dr=Be({zip_code:A().min(1,"CEP é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===8,{message:"CEP deve ter 8 dígitos."}),street:A().min(1,"Rua é obrigatória."),number:A().min(1,"Número é obrigatório."),neighborhood:A().min(1,"Bairro é obrigatório."),city:A().min(1,"Cidade é obrigatória.")}),Fr=Be({name:A().min(1,"Nome é obrigatório."),phone:A().min(1,"Telefone é obrigatório.").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length>=10,{message:"O telefone deve ter pelo menos 10 dígitos."}),email:A().email("Email inválido.").optional().or(Dt("")),cpf_cnpj:A().optional().default("").transform(t=>t.replace(/\D/g,"")).refine(t=>t.length===0||t.length===11||t.length===14,{message:"CPF deve ter 11 dígitos ou CNPJ 14 dígitos."}),delivery_option:Ft(["delivery","pickup"],{required_error:"Selecione uma opção de entrega."}),notes:A().optional(),payment_method_id:A().min(1,"Selecione um método de pagamento."),change_for:Tt(t=>{const a=String(t).replace(",",".").trim();return a===""?void 0:a},Gt.number({invalid_type_error:"O troco deve ser um número."}).optional().nullable())}),Tr=async()=>{const{data:t,error:a}=await S.from("restaurants").select("id, name, address, phone, email, street, number, neighborhood, city, zip_code, latitude, longitude, delivery_enabled").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1).single();if(a)throw new Error(`Erro ao buscar restaurante: ${a.message}`);if(!t)throw new Error("Nenhum restaurante ativo encontrado.");return t},Gr=async t=>{const{data:a,error:r}=await S.from("delivery_zones").select("*").eq("restaurant_id",t).eq("is_active",!0).order("max_distance_km",{ascending:!0});if(r)throw new Error(`Erro ao buscar zonas de entrega: ${r.message}`);return a},qr=async t=>{const{data:a,error:r}=await S.from("payment_methods").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});if(r)throw new Error(`Erro ao buscar métodos de pagamento: ${r.message}`);return a},$r=async t=>{const{data:a,error:r}=await S.from("customers").select("*").eq("user_id",t).limit(1).single();if(r&&r.code!=="PGRST116")throw new Error(r.message);return a||null},nn=()=>{var Me,Oe;const t=Ct(),a=Nt(),{items:r,totalAmount:s,clearCart:i}=qt(),{data:n,isLoading:c}=$t(),{data:g}=Ue(),[y,f]=m.useState(!1),[d,j]=m.useState(!1),[O,N]=m.useState(0),[I,k]=m.useState(null),[L,q]=m.useState(!0),[ne,dt]=m.useState(null),[lt,he]=m.useState(!1),[ut,mt]=m.useState(null),[Ee,ft]=m.useState(null),[G,$]=m.useState(!1);m.useEffect(()=>{console.log("LOG: Checkout - User Status:",n?`Logged in as ${n.email}`:"Anonymous")},[n]);const{data:v,isLoading:pt,isError:ht,error:Ce,refetch:xt}=re({queryKey:["checkoutRestaurantData"],queryFn:Tr,staleTime:1/0}),{data:ae,isLoading:gt}=re({queryKey:["checkoutDeliveryZones"],queryFn:()=>Gr(v.id),enabled:!!v,staleTime:1/0}),{data:Q,isLoading:yt}=re({queryKey:["checkoutPaymentMethods"],queryFn:()=>qr(v.id),enabled:!!v,staleTime:1/0}),{data:w,isLoading:Re,refetch:Vr}=re({queryKey:["checkoutCustomerData",n==null?void 0:n.id],queryFn:()=>$r(n.id),enabled:!!n,staleTime:0}),u=Le({resolver:Ge(Fr),defaultValues:{name:"",phone:"",email:"",cpf_cnpj:"",delivery_option:"delivery",notes:"",payment_method_id:"",change_for:void 0},mode:"onBlur"}),C=Le({resolver:Ge(Dr),defaultValues:{zip_code:"",street:"",number:"",neighborhood:"",city:""},mode:"onBlur"}),D=u.watch("delivery_option"),jt=u.watch("payment_method_id"),X=Q==null?void 0:Q.find(o=>o.id===jt),oe=(Me=X==null?void 0:X.name)==null?void 0:Me.includes("online"),se=(Oe=X==null?void 0:X.name)==null?void 0:Oe.includes("Dinheiro"),V=s+O,F=C.watch(["zip_code","street","number","city","neighborhood"]);m.useEffect(()=>{D==="pickup"?(N(0),q(!0),$(!0)):$(!1)},[D]),m.useEffect(()=>{if(w){let o="",l="",p="",_="",b="";if(w.address){const h=w.address.split(", ").map(P=>P.trim());h.length>=5?(o=h[0],l=h[1],p=h[2],_=h[3],b=h[4]):h.length>=4&&(o=h[0],p=h[1],_=h[2],b=h[3])}u.reset({...u.getValues(),name:w.name||"",phone:w.phone||"",email:w.email||"",cpf_cnpj:w.cpf_cnpj||""}),C.reset({zip_code:b,street:o,number:l,neighborhood:p,city:_}),w.address&&w.latitude&&w.longitude&&($(!0),ge(b,o,l,_,w.latitude,w.longitude))}else if(n&&!Re){const o=n.user_metadata;u.reset({...u.getValues(),name:o.full_name||"",phone:o.phone||"",email:n.email||"",cpf_cnpj:o.cpf_cnpj||""})}},[w,u,n,Re,C,ge]);const xe=m.useMemo(()=>v!=null&&v.latitude&&(v!=null&&v.longitude)?[v.latitude,v.longitude]:null,[v]),ge=m.useCallback(async(o,l,p,_,b,h)=>{if(!v||!xe||!v.delivery_enabled)return N(0),q(!0),k(null),{coords:null,fee:0,time:null,isValid:!0};const P=`${l}, ${p}, ${_}, ${o}`;let x=null;if(b&&h)x={lat:b,lng:h};else{j(!0);const R=E.loading("Calculando taxa de entrega...");x=await sr(P),j(!1),E.dismiss(R)}if(!x)return N(0),k(null),q(!1),E.error("Não foi possível encontrar o endereço. Verifique o CEP e o número."),{coords:null,fee:0,time:null,isValid:!1};if(dt([x.lat,x.lng]),ae&&ae.length>0){const R=ir([x.lat,x.lng],xe,ae);return R?(N(R.fee),k([R.minTime,R.maxTime]),q(!0),{coords:x,fee:R.fee,time:[R.minTime,R.maxTime],isValid:!0}):(N(0),k(null),q(!1),E.error("Endereço fora da área de entrega."),{coords:x,fee:0,time:null,isValid:!1})}else return N(0),k(null),q(!0),{coords:x,fee:0,time:null,isValid:!0}},[v,xe,ae]),J=u.watch("change_for");m.useEffect(()=>{se&&J!==null&&J!==void 0&&J>0&&J<V?u.setError("change_for",{message:"O valor do troco deve ser maior ou igual ao total do pedido."}):u.clearErrors("change_for")},[se,J,V,u]);const ie=ye({mutationFn:async o=>{var h;const p=(h=(await S.auth.getUser()).data.user)==null?void 0:h.id;if(!(w!=null&&w.id)&&!p)throw new Error("ID do cliente ou usuário não encontrado.");const _=`${o.street}, ${o.number}, ${o.neighborhood}, ${o.city}, ${o.zip_code}`,b={user_id:p||null,name:u.getValues("name"),phone:u.getValues("phone"),email:u.getValues("email")||null,cpf_cnpj:u.getValues("cpf_cnpj")||null,address:_,latitude:o.lat,longitude:o.lng};if(w!=null&&w.id){const{data:P,error:x}=await S.from("customers").update(b).eq("id",w.id).select().single();if(x)throw x;return P}else if(p){const{data:P,error:x}=await S.from("customers").insert(b).select().single();if(x)throw x;return P}else return{id:"anonymous",user_id:null,name:b.name,phone:b.phone,email:b.email,address:_,created_at:"",updated_at:"",latitude:o.lat,longitude:o.lng,cpf_cnpj:b.cpf_cnpj}},onSuccess:(o,l)=>{o.id!=="anonymous"&&a.invalidateQueries({queryKey:["checkoutCustomerData"]}),N(l.fee),k(l.time),q(l.isValid),$(!0),E.success("Endereço salvo e taxa de entrega calculada!")},onError:o=>{E.error(`Erro ao salvar endereço: ${o.message}`),$(!1)}}),vt=async()=>{if(D==="pickup")return;if(!await C.trigger()){E.error("Preencha todos os campos obrigatórios do endereço.");return}const l=C.getValues(),p=await ge(l.zip_code,l.street,l.number,l.city);if(!p.isValid){$(!1);return}if(!p.coords){E.error("Não foi possível obter as coordenadas para salvar o endereço."),$(!1);return}ie.mutate({...l,lat:p.coords.lat,lng:p.coords.lng,fee:p.fee,time:p.time,isValid:p.isValid})},Se=ye({mutationFn:async o=>{var h,P;(h=(await S.auth.getUser()).data.user)==null||h.id;const p=o.phone.replace(/\D/g,""),_=((P=o.cpf_cnpj)==null?void 0:P.replace(/\D/g,""))||null,b={user_id:(n==null?void 0:n.id)||null,name:o.name,phone:p,email:o.email||null,cpf_cnpj:_,address:D==="delivery"?`${F[1]}, ${F[2]}, ${F[3]}, ${F[4]}, ${F[0]}`:null,latitude:ne?ne[0]:null,longitude:ne?ne[1]:null};if(n)if(w){const{data:x,error:R}=await S.from("customers").update(b).eq("id",w.id).select().single();if(R)throw R;return x}else{const{data:x,error:R}=await S.from("customers").insert(b).select().single();if(R)throw R;return x}else{const{data:x,error:R}=await S.from("customers").insert(b).select().single();if(R)throw R;return x}},onSuccess:()=>{a.invalidateQueries({queryKey:["checkoutCustomerData"]})},onError:o=>{E.error(`Erro ao salvar dados do cliente: ${o.message}`)}}),Pe=ye({mutationFn:async({customerId:o,data:l})=>{if(!v)throw new Error("Dados do restaurante não disponíveis.");const p={restaurant_id:v.id,customer_id:o,status:oe?"pending_payment":"pending",total_amount:V,delivery_fee:O,delivery_address:D==="delivery"?`${F[1]}, ${F[2]}, ${F[3]}, ${F[4]}, ${F[0]}`:null,notes:l.notes,payment_method_id:l.payment_method_id,change_for:se&&l.change_for&&l.change_for>V?l.change_for:null},{data:_,error:b}=await S.from("orders").insert(p).select("id").single();if(b)throw b;const h=r.map(x=>({order_id:_.id,product_id:x.product.id,quantity:x.quantity,unit_price:x.product.price,subtotal:x.subtotal,notes:x.notes})),{error:P}=await S.from("order_items").insert(h);if(P)throw P;return _.id},onSuccess:o=>{a.invalidateQueries({queryKey:["orders"]})},onError:o=>{E.error(`Erro ao criar pedido: ${o.message}`)}}),wt=async o=>{if(console.log("LOG: onSubmit iniciado."),console.log("LOG: isOnlinePayment:",oe),console.log("LOG: deliveryOption:",D),console.log("LOG: isAddressSaved:",G),r.length===0){E.error("Seu carrinho está vazio."),t("/menu");return}if(D==="delivery"){if(!G){E.error("Você deve salvar e validar o endereço de entrega antes de finalizar o pedido.");return}if(!L){E.error("O endereço de entrega está fora da área de cobertura.");return}}let l;try{console.log("LOG: Criando/Atualizando cliente..."),l=(await Se.mutateAsync(o)).id,console.log("LOG: Cliente ID:",l)}catch(_){E.error(`Falha ao salvar cliente: ${_.message}`);return}let p;try{console.log("LOG: Criando pedido..."),p=await Pe.mutateAsync({customerId:l,data:o}),console.log("LOG: Pedido ID:",p)}catch(_){E.error(`Falha ao criar pedido: ${_.message}`);return}oe?(console.log("LOG: Iniciando checkout Mercado Pago..."),await _t(p,o)):(console.log("LOG: Pagamento na entrega/retirada. Redirecionando para sucesso."),i(),t(`/order-success/${p}`,{replace:!0}))},_t=async(o,l)=>{if(!v)return;const p=window.location.origin+window.location.pathname,_=r.map(h=>({name:h.product.name,price:h.product.price,quantity:h.quantity})),b=E.loading("Preparando pagamento online...");try{console.log("LOG: Chamando Edge Function create-payment-preference...");const{data:h,error:P}=await S.functions.invoke("create-payment-preference",{body:{orderId:o,items:_,totalAmount:V,restaurantName:v.name,clientUrl:p,customerEmail:l.email||(n==null?void 0:n.email)||"cliente@anonimo.com",customerCpfCnpj:l.cpf_cnpj}});if(P)throw P;const{init_point:x}=h;console.log("LOG: Preferência MP criada. init_point:",x),mt(o),ft(x),he(!0),E.dismiss(b)}catch(h){console.error("Erro ao criar preferência MP:",h),E.dismiss(b),E.error(`Erro no pagamento online: ${h.message}`),he(!1)}},bt=async()=>{await S.auth.signOut(),E.success("Você saiu da sua conta."),t("/auth",{replace:!0})};if(r.length===0)return m.useEffect(()=>{t("/menu")},[t]),e.jsx(De,{});if(pt||gt||yt||c)return e.jsx(De,{});if(ht||!v)return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(H,{variant:"destructive",className:"max-w-lg",children:[e.jsx(Vt,{className:"h-4 w-4"}),e.jsx(Y,{children:"Erro Crítico"}),e.jsx(ee,{children:Ce instanceof Error?Ce.message:"Não foi possível carregar os dados do restaurante."}),e.jsxs(W,{onClick:()=>xt(),className:"mt-3",variant:"secondary",size:"sm",children:[e.jsx(Bt,{className:"h-4 w-4 mr-2"})," Tentar Novamente"]})]})});const Ie=Se.isPending||Pe.isPending||ie.isPending||d||D==="delivery"&&!G;return e.jsxs("div",{className:"min-h-screen bg-background p-4 sm:p-8",children:[e.jsx(zt,{isOpen:y,onClose:()=>f(!1),customer:w}),lt&&Ee&&e.jsx(Lr,{preferenceId:ut,initPoint:Ee,onClose:()=>he(!1)}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Finalizar Pedido"}),n&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{variant:"outline",size:"icon",onClick:()=>f(!0),"aria-label":"Meu Perfil",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsxs(W,{variant:"outline",size:"sm",onClick:bt,children:[e.jsx(Kt,{className:"h-4 w-4 mr-1"})," Sair"]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(B,{children:[e.jsx(z,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Fe,{className:"h-5 w-5 text-primary"}),"Seus Dados"]})}),e.jsxs(U,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:n?`Logado como ${n.email}. ${w?"Perfil de cliente encontrado.":"Preencha os dados para criar seu perfil de cliente."}`:"Você está fazendo um pedido anônimo."})}),e.jsx("form",{onSubmit:u.handleSubmit(wt),id:"checkout-form",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"name",children:"Nome Completo *"}),e.jsx(Z,{id:"name",...u.register("name")}),u.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"phone",children:"Telefone *"}),e.jsx(te,{name:"phone",control:u.control,render:({field:o})=>e.jsx(Ut,{id:"phone",...o})}),u.formState.errors.phone&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.phone.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"email",children:"Email (Opcional)"}),e.jsx(Z,{id:"email",type:"email",...u.register("email")}),u.formState.errors.email&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"cpf_cnpj",children:"CPF/CNPJ (Opcional)"}),e.jsx(te,{name:"cpf_cnpj",control:u.control,render:({field:o})=>e.jsx(Zt,{id:"cpf_cnpj",...o})}),u.formState.errors.cpf_cnpj&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.cpf_cnpj.message})]})]})})]})]}),e.jsxs(B,{children:[e.jsx(z,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5 text-primary"}),"Opção de Entrega"]})}),e.jsx(U,{children:e.jsx(te,{name:"delivery_option",control:u.control,render:({field:o})=>e.jsxs(we,{onValueChange:o.onChange,value:o.value,className:"grid grid-cols-2 gap-4",children:[e.jsxs(M,{htmlFor:"delivery",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ue,{value:"delivery",id:"delivery",className:"sr-only"}),e.jsx(je,{className:"mb-3 h-6 w-6"}),"Entrega"]}),e.jsxs(M,{htmlFor:"pickup",className:"flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",children:[e.jsx(ue,{value:"pickup",id:"pickup",className:"sr-only"}),e.jsx(Te,{className:"mb-3 h-6 w-6"}),"Retirada no Local"]})]})})})]}),D==="delivery"&&e.jsxs(B,{className:me(!G&&"border-destructive ring-2 ring-destructive/50"),children:[e.jsxs(z,{children:[e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5 text-primary"}),"Endereço de Entrega",G&&e.jsx(Qt,{className:"h-5 w-5 text-green-500 ml-2"}),!G&&e.jsx(ce,{className:"h-5 w-5 text-destructive ml-2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preencha e salve o endereço para calcular a taxa de entrega."})]}),e.jsxs(U,{className:"space-y-4",children:[!v.delivery_enabled&&e.jsxs(H,{variant:"destructive",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx(Y,{children:"Entrega Desativada"}),e.jsx(ee,{children:"O restaurante não está aceitando pedidos para entrega no momento."})]}),e.jsxs("form",{onSubmit:o=>{o.preventDefault(),vt()},id:"address-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(M,{htmlFor:"zip_code",children:"CEP *"}),e.jsx(te,{name:"zip_code",control:C.control,render:({field:o})=>e.jsx(tr,{id:"zip_code",...o})}),C.formState.errors.zip_code&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.zip_code.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"street",children:"Rua *"}),e.jsx(Z,{id:"street",...C.register("street")}),C.formState.errors.street&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.street.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"number",children:"Número *"}),e.jsx(Z,{id:"number",...C.register("number")}),C.formState.errors.number&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.number.message})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(M,{htmlFor:"neighborhood",children:"Bairro *"}),e.jsx(Z,{id:"neighborhood",...C.register("neighborhood")}),C.formState.errors.neighborhood&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.neighborhood.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"city",children:"Cidade *"}),e.jsx(Z,{id:"city",...C.register("city")}),C.formState.errors.city&&e.jsx("p",{className:"text-destructive text-sm",children:C.formState.errors.city.message})]}),e.jsxs(W,{type:"submit",className:"w-full h-10 text-base mt-4",disabled:ie.isPending||d||!v.delivery_enabled,children:[ie.isPending||d?e.jsx(le,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Xt,{className:"h-4 w-4 mr-2"}),"Salvar Endereço e Calcular Taxa"]})]}),d&&e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 animate-spin"}),e.jsx(Y,{children:"Calculando Taxa de Entrega..."})]}),!L&&G&&!d&&e.jsxs(H,{variant:"destructive",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx(Y,{children:"Fora da Área de Entrega"}),e.jsx(ee,{children:"Seu endereço está fora da área de cobertura do restaurante."})]}),I&&L&&G&&!d&&e.jsxs(H,{variant:"default",className:"bg-green-50 dark:bg-green-900/20 border-green-200 text-green-700",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(Y,{children:"Entrega Disponível"}),e.jsxs(ee,{children:["Taxa de entrega: ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(O),". Tempo estimado: ",I[0]," - ",I[1]," minutos."]})]})]})]}),e.jsxs(B,{children:[e.jsx(z,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-primary"}),"Método de Pagamento *"]})}),e.jsxs(U,{children:[e.jsx(te,{name:"payment_method_id",control:u.control,render:({field:o})=>e.jsx(we,{onValueChange:o.onChange,value:o.value,className:"space-y-3",children:Q==null?void 0:Q.map(l=>{var _;const p=((_=l.name)==null?void 0:_.includes("online"))&&!g;return e.jsx(M,{htmlFor:l.id,className:me("flex items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground [&:has([data-state=checked])]:border-primary cursor-pointer",p&&"opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ue,{value:l.id,id:l.id,disabled:p}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:l.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l.description}),p&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Pagamento online indisponível (Chave Pública não configurada)."})]})]})},l.id)})})}),u.formState.errors.payment_method_id&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:u.formState.errors.payment_method_id.message})]})]}),se&&e.jsxs(B,{children:[e.jsx(z,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(Ht,{className:"h-5 w-5 text-primary"}),"Troco"]})}),e.jsx(U,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"change_for",children:"Precisa de troco para quanto? (Opcional)"}),e.jsx(Z,{id:"change_for",type:"number",step:"0.01",placeholder:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(V),...u.register("change_for",{valueAsNumber:!0})}),u.formState.errors.change_for&&e.jsx("p",{className:"text-destructive text-sm",children:u.formState.errors.change_for.message})]})})]}),e.jsxs(B,{children:[e.jsx(z,{children:e.jsxs(K,{className:"text-xl flex items-center gap-2",children:[e.jsx(rr,{className:"h-5 w-5 text-primary"}),"Observações"]})}),e.jsx(U,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"notes",children:"Notas para o restaurante (Opcional)"}),e.jsx(Wt,{id:"notes",...u.register("notes"),rows:3,placeholder:"Ex: Entregar na portaria, sem pimenta, etc."})]})})]})]}),e.jsx("div",{className:"lg:col-span-1 space-y-6 sticky top-4 self-start",children:e.jsxs(B,{className:"shadow-lg",children:[e.jsx(z,{children:e.jsx(K,{className:"text-2xl",children:"Resumo"})}),e.jsxs(U,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:r.map(o=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"truncate max-w-[70%]",children:[o.quantity,"x ",o.product.name]}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.subtotal)})]},o.product.id))}),e.jsx(qe,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Taxa de Entrega"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(O)})]})]}),e.jsx(qe,{}),e.jsxs("div",{className:"flex justify-between font-bold text-xl",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(V)})]}),e.jsx(W,{type:"submit",form:"checkout-form",className:"w-full h-12 text-lg",disabled:Ie,children:Ie?e.jsx(le,{className:"h-5 w-5 animate-spin mr-2"}):oe?"Pagar e Finalizar":"Confirmar Pedido"}),D==="delivery"&&!G&&e.jsxs(H,{variant:"destructive",className:"mt-3",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx(ee,{className:"text-xs",children:"Salve o endereço acima para continuar."})]}),e.jsx(Rt,{to:`/menu/${v.id}`,className:"block text-center text-sm text-muted-foreground hover:underline mt-2",children:"Voltar ao Cardápio"})]})]})})]})]})]})};export{nn as default};
