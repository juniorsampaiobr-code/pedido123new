import{j as e}from"./tanstack-QxCZ3Wpf.js";import{u as R,r as c,L as I}from"./vendor-CIxFcw7z.js";import{L as U}from"./Logo-BEXTx_xm.js";import{B as v}from"./button-CTcbDZK9.js";import{L as h,I as g}from"./label-pixlkeFD.js";import{C as D,b as _,c as z,d as O,a as T}from"./card-CyZ0TSMu.js";import{c as S,L as w,u as n}from"./index-C6DUPuFc.js";import{s as m}from"./client-BskZ_u5h.js";import{P as V}from"./PhoneInput-DHU90iof.js";import{S as B}from"./separator-CLCtSLz6.js";import"./package-B2vY7aAy.js";import"./supabase-DGFirUEE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=S("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=S("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),b=t=>t.replace(/\D/g,""),C=async t=>{const{data:o,error:l}=await m.from("user_roles").select("role").eq("user_id",t).in("role",["admin","moderator"]).limit(1).single();return l&&l.code!=="PGRST116"?(console.error("Error checking role:",l),null):(o==null?void 0:o.role)||null},$=async t=>{let o=await C(t.id);if(o!=="admin"&&o!=="moderator"){const l=t.user_metadata.full_name||"Novo Restaurante",{error:s}=await m.functions.invoke("setup-initial-admin-store",{body:{userId:t.id,fullName:l}});if(s)return console.error("Error setting up initial store:",s),null;o=await C(t.id)}return o},te=()=>{const t=R(),[o,l]=c.useState(!1),[s,k]=c.useState(!1),[d,L]=c.useState(""),[u,E]=c.useState(""),[p,P]=c.useState(""),[f,A]=c.useState(""),[x,j]=c.useState(null),N=async r=>{const a=await $(r);if(a==="admin"||a==="moderator")n.success("Login de administrador efetuado com sucesso!"),t("/dashboard",{replace:!0});else{n.error("Acesso negado.",{description:"Esta conta não possui permissão de administrador/moderador. Redirecionando para o menu.",duration:5e3}),await m.auth.signOut();const i=`${window.location.origin}${window.location.pathname}#/menu`;console.log("Redirecting non-admin to menu:",i),window.location.href=i}};c.useEffect(()=>{m.auth.getSession().then(({data:{session:a}})=>{j(a),a!=null&&a.user&&N(a.user)});const{data:{subscription:r}}=m.auth.onAuthStateChange((a,i)=>{j(i),i!=null&&i.user&&N(i.user)});return()=>r.unsubscribe()},[t]);const q=()=>{if(s){if(!p.trim())return n.error("O Nome Completo é obrigatório."),!1;if(b(f).length!==11)return n.error("O Telefone deve conter 11 dígitos (DDD + 9 dígitos)."),!1}return d.trim()?u.length<6?(n.error("A Senha deve ter pelo menos 6 caracteres."),!1):!0:(n.error("O Email é obrigatório."),!1)},F=async r=>{if(r.preventDefault(),!!q()){l(!0);try{if(s){const a=b(f),{data:i,error:y}=await m.auth.signUp({email:d,password:u,options:{data:{full_name:p,phone:a}}});if(y)throw y;i.session?n.success("Conta de administrador criada e login efetuado!"):n.success("Conta criada! Verifique seu email para confirmar.")}else{const{error:a}=await m.auth.signInWithPassword({email:d,password:u});if(a)throw a;n.success("Login realizado com sucesso!")}}catch(a){a.message.includes("Email not confirmed")?n.error("Por favor, verifique seu e-mail para confirmar sua conta."):n.error(a.message||"Erro ao processar autenticação")}finally{l(!1)}}};return x!=null&&x.user?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(w,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-primary"}),e.jsx("p",{className:"text-lg font-semibold",children:"Verificando permissões..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aguarde enquanto redirecionamos você."})]})}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx(U,{className:"justify-center mb-4"})}),e.jsxs(D,{className:"shadow-xl border-2",children:[e.jsxs(_,{className:"space-y-1",children:[e.jsxs(z,{className:"text-2xl font-bold text-center flex items-center justify-center gap-2",children:[s?e.jsx(M,{className:"h-6 w-6 text-primary"}):e.jsx(H,{className:"h-6 w-6 text-destructive"}),s?"Cadastre sua Loja":"Acesso do Restaurante"]}),e.jsx(O,{className:"text-center",children:s?"Crie sua conta de administrador para gerenciar sua loja.":"Utilize seu email e senha de administrador para acessar o painel."})]}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(g,{id:"fullName",type:"text",placeholder:"Seu nome completo",value:p,onChange:r=>P(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"phone",children:"Telefone *"}),e.jsx(V,{id:"phone",value:f,onChange:r=>A(r.target.value),required:!0,className:"h-12"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: (99) 99999-9999"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"email",children:"Email *"}),e.jsx(g,{id:"email",type:"email",placeholder:"seu@email.com",value:d,onChange:r=>L(r.target.value),required:!0,className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"password",children:"Senha *"}),e.jsx(g,{id:"password",type:"password",placeholder:"••••••••",value:u,onChange:r=>E(r.target.value),required:!0,className:"h-12"})]}),e.jsx(v,{type:"submit",className:"w-full",size:"lg",disabled:o,children:o?e.jsx(w,{className:"h-4 w-4 animate-spin mr-2"}):s?"Criar Conta Admin":"Entrar no Painel"})]}),e.jsx("div",{className:"text-center",children:e.jsx(v,{variant:"link",type:"button",className:"p-0 h-auto",onClick:()=>k(!s),children:s?"Já tem uma conta? Faça login":"Não tem uma conta? Cadastre-se agora"})}),e.jsx(B,{className:"my-4"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["É um cliente? ",e.jsx(I,{to:"/auth",className:"text-primary hover:underline",children:"Acesse como Cliente"})]})]})]})]})})};export{te as default};
